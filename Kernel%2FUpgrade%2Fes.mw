<languages />

{{Metadata|abstract=Este artículo describe los pasos para actualizar a un nuevo núcleo.}}

Este artículo describe los pasos para actualizar a un nuevo [[Kernel/es|núcleo]].

== Instalación y utilización de un nuevo núcleo ==

La actualización del núcleo puede ser una buena idea cuando se instalan los fuentes. A veces se instalan los fuentes cuando se actualiza el sistema lanzando <tt>emerge -a --update --deep --with-bdeps=y --newuse @world</tt> o, por supuesto, cuando se instalan directamente.

Al instalar unos nuevos fuentes del núcleo, no se le ofrece al usuario un nuevo núcleo. Es necesario construir e instalar un nuevo núcleo a partir de los nuevos fuentes y reiniciar el sistema para correr el nuevo núcleo.

Construir un nuevo núcleo a partir de los nuevos fuentes es básicamente el mismo proceso que el construir un nuevo núcleo cuando se instala el sistema. La diferencia es que se puede partir de la configuración del anterior núcleo para crear la configuración del nuevo. El utilizar la antigua configuración evita que el usuario tenga que recorrer de nuevo todas las opciones del núcleo d (como con <tt>make menuconfig</tt>).

The configuration of the kernel is saved in a file named {{Path|.config}} in the directory that holds the kernel sources. A new kernel may have options or features the old kernel does not have, or it might not have a feature or option anymore which the old kernel still has.  The kernel configuration specifies whether the features and options of a kernel are to be enabled or not, perhaps built into the kernel, or perhaps built as modules which can be loaded into the running kernel on demand. Hence the configuration file of the new kernel may have new entries the configuration file of the old kernel doesn't have, and it might not have entries anymore which are present in the configuration file of the old kernel.

To deal with such changes of the configuration file, the configuration file of the old kernel needs to be converted to a configuration that can be used with the new kernel. This article shows how to make a new kernel from new kernel sources with converting the configuration file of the old kernel.

== Haga una copia de respaldo de la configuración del núcleo actual ==

It is wise to make a backup of the kernel configuration so that the previous configurations are not lost. After all, many users devote considerable time to figure out the best configuration for the system, and losing that information is definitely not wanted.

Es fácil hacer una copia de respaldo de la configuración actual del núcleo:

{{RootCmd|cd /usr/src/linux
|cp .config ~/kernel-config-`uname -r`|}}

Provided that the symlink to the kernel sources has been set correctly, this copies the configuration of the currently used kernel to the home directory of root, renaming the configuration to {{Path|kernel-config-}} followed by the version of the current running Linux kernel.

== Ajuste el enlace simbólico a los nuevos fuentes del núcleo ==

El enlace simbólico {{Path|/usr/src/linux}} debe siempre apuntar al directorio que contiene los fuentes del nucleo en el que está corriendo. Esto se puede hacer de tres formas distintas:

# Instalar los nuevos fuentes del núcleo con  <code>USE="symlink"</code>
# Ajustar el enlace con eselect
# Actualizar el enlace simbólico de forma manual

=== Instalar los fuentes del núcleo con el ajustes USE para gestionar el enlace simbólico ===

Esto hará que {{Path|/usr/src/linux}} apunte a los nuevos fuentes del núcleo instalados.

En caso de ser necesario, se puede modificar más tarde utilizando uno de los otros dos métodos.

=== Definir el enlace on eselect ===

Para definir el enlace simbólico con <tt>eselect</tt>:

{{RootCmd|eselect kernel list|output=<pre>
Available kernel symlink targets:
 [1] linux-3.14.14-gentoo *
 [2] linux-3.16.3-gentoo
</pre>}}

Esto muestra los fuentes del núcleo disponibles. El asterisco indica los fuentes elegidos.

Para cambiar los fuentes del núcleo, por ejemplo a la segunda entrada, se debe hacer los siguiente:

{{RootCmd|eselect kernel set 2}}

=== Actuar manualmente el enlace simbólico ===

Para definir el enlace simbólico manualmente:

{{RootCmd|ln -sf /usr/src/linux-3.16.3 /usr/src/linux
|ls -l /usr/src/linux|output=<pre>
lrwxrwxrwx 1 root root 19 Oct  4 10:21 /usr/src/linux -> linux-3.16.3-gentoo
</pre>}}

== Copiar la configuración del núcleo anterior ==

Se necesita copiar la configuración del núcleo antiguo al nuevo. Se puede encontrar en varios sitios:

* En el sistema de ficheros [[procfs]] si la opción del núcleo ''Enable access to .config through /proc/config.gz'' se activó en el núcleo actual:
: {{RootCmd|zcat /proc/config.gz > /usr/src/linux/.config}}

* En el directorio {{Path|/boot}} si la configuración se instaló allí:
: {{RootCmd|cp /boot/config-3.14.14-gentoo /usr/src/linux/.config}}

* En el directorio del núcleo que está corriendo actualmente:
: {{RootCmd|cp /usr/src/linux-3.14.14-gentoo/.config /usr/src/linux/}}

== Configure el nuevo núcleo ==

Para utilizar la configuración del núcleo antiguo en el nuevo nucleo, se necesita convertir. La conversión se puede realizar bien usando <tt>make silentoldconfig</tt> o <tt>make olddefconfig</tt>.

<tt>make silentoldconfig</tt> ofrece la posibilidad de nuevas opciones, en cambio <tt>make olddefconfig<tt> no. Utilice uno de ellos pero no ambos.

=== make silentoldconfig ===

The following configuration is like the text based configuration with <tt>make config</tt>.  For new configuration options, it gives a choice. For example:

{{RootCmd|make silentoldconfig|output=<pre>
Anticipatory I/O scheduler (IOSCHED_AS) [Y/n/m/?] (NEW)
</pre>}}

The string ''(NEW)'' at the end of the line marks this option as new. Left to the string in square brackets are the possible answers: ''Y''es, ''n''o, ''m''odule or ''?'' to show the help. The recommend answer is capitalized (here ''Y''). The help explains the option or driver.

Unfortunately <tt>make silentoldconfig</tt> doesn't show - next to the help - a lot more information for each option, like the context, so that it is sometimes difficult to give the right answer. In this case the best way to go is to remember the option name and revise it afterwards through one of the [[Kernel/Configuration#Configuration tools|graphical kernel configuration tools]].

=== make olddefconfig ===

Si no se desea interactividad (no se deberían realizar preguntas), entonces utilice <tt>make olddefconfig</tt>:

{{RootCmd|cd /usr/src/linux
|make olddefconfig}}

== Construcción ==

{{Important|When external kernel modules are installed (like nvidia or zfs), it may be necessary to run <tt>make modules_prepare</tt> as described [[Kernel/Upgrade#Reinstall external kernel modules|below]] before building the kernel. Some modules cannot be installed or prepared before the kernel has been built.}}

{{Important|Do not forget to reconfigure the [[Bootloader|bootloader]] to account for the new kernel filenames, and rebuild the initramfs if one is used as well.}}

Para realizar este paso, siga lo indicado en el artículo de [[Kernel/Configuration/es#Construcción|configuración manual]].

== Reinstalar módulos externos del núcleo ==

Cualquier módulo externo del núcleo como los [[:Category:Binary kernel modules|módulos binarios del núcleo]], necesitan reconstruirse cada vez que se actualiza el núcleo. Si todavía no ha construido su núcleo deberá prepararse en primer lugar para la construcción de los módulos externos del núcleo:

{{RootCmd|make modules_prepare}}

Puede reconstruir los paquetes usando el conjunto ''@module-rebuild'':

{{Emerge|@module-rebuild}}

== Resolver problemas en la construcción ==

Cuando tenga problemas mientras está reconstruyendo el núcleo actual, podría ser de utilidad sanear los ficheros fuente del núcleo. Asegúrese de hacer una copia de respaldo del fichero {{Path|.config}} ya que esta operación lo eliminará. Asegúrese de no utilizar los sufijos {{Path|.bak}} o {{Path|~}} como indicadores de copia de respaldo ya que <tt>make distclean</tt> también los eliminará.

{{RootCmd|cp .config /usr/src/kernel_config_bk
|make distclean
|mv /usr/src/kernel_config_bk .config}}

== Eliminar núcleos antiguos ==

Lea el artículo sobre la [[Kernel/Removal/es|eliminación del núcleo]]. 

== Recursos externos ==

* [http://kernelnewbies.org/LinuxChanges Registro de cambios del núcleo con algunas explicaciones de nuevas características]

[[Category:Kernel]]
