{{WIP|author=Dmitri}}
==Preparation==
We need to have functional [[ACPI]], and installed {{Package|app-laptop/tp_smapi}}.
{{RootCmd|modprobe tp_smapi}}

On boot you might need to append kernel commandline "acpi_backlight=vendor"

To check what names ACPI uses on a specific button, start acpi_listen and press Fn+buttons and see output
 
{{RootCmd|acpi_listen||output=<pre>
button/fnf1 FNF1 00000080 00000000 K
button/screenlock SCRNLCK 00000080 00000000 K
^[[36~button/battery BAT 00000080 00000000 K
^[[37~button/sleep SBTN 00000080 00000000 K
</pre>}}

{| {{prettytable}}
|+ Lenovo ThinkPad T410 selected ACPI key events
! Keys !! Event name !! Short name !! Numerical part !! Note
|-
| {{key|Fn}}{{key|F1}} || button/fnf1 || FNF1 || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|F2}} || button/screenlock || SCRNLCK || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|F3}} || button/battery || BAT || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|F4}} || button/sleep || SBTN || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|F5}} || button/wlan || WLAN || 00000080 00000000 K ||
|- 
| {{key|Fn}}{{key|F6}} || (not reported to handler) ||  ||  ||
|-
| {{key|Fn}}{{key|F7}} || video/switchmode || VMOD || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|F8}} || (not reported to handler) ||  ||  ||
|- 
| {{key|Fn}}{{key|F9}} || button/f24 || F24 || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|F10}} || (not reported to handler) ||  ||  ||
|-
| {{key|Fn}}{{key|F11}} || button/fnf11 || FF11 || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|F12}} || button/suspend || SUSP || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|Space}} || button/zoom || ZOOM || 00000080 00000000 K ||
|-
| {{key|Mute}} || button/mute || MUTE || 00000080 00000000 K ||
|-
| {{key|VolumeDown}} || button/volumedown || VOLDN || 00000080 00000000 K ||
|-
| {{key|VolumeUp}} || botton/volumeup || VOLUP || 00000080 00000000 K ||
|-
| {{key|MuteMic}} || button/f20 || F20 || 00000080 00000000 K ||
|-
| {{key|ThinkVantage}} || button/prog1 || PROG1 || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|Home}} || video/brightnessup || BRTUP || 00000086 00000000 ||
|-
| {{key|Fn}}{{key|End}} || video/brightnessdown || BRTDN || 00000087 00000000 ||
|-
| {{key|Fn}}{{key|PgUp}} || (not reported to handler) ||  ||  ||hardware light switch
|-
| {{key|Fn}}{{key|PrtSc}} || (not reported to handler) ||  ||  ||
|-
| {{key|Fn}}{{key|ScrLk}} || (not reported to handler) ||  ||  ||
|-
| {{key|Fn}}{{key|Pause}} || (not reported to handler) ||  ||  ||
|-
| {{key|Fn}}{{key|ArrowUp}} || cd/stop || CDSTOP || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|ArrowLeft}} || cd/prev || CDPREV || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|ArrowRight}} || cd/next || CDNEXT || 00000080 00000000 K ||
|-
| {{key|Fn}}{{key|ArrowDown}} || cd/play || CDPLAY || 00000080 00000000 K||
|}

Collect those names.
Now create an event for each button in {{Path|/etc/acpi/events/}}, I named them by the location-function, but it's up to you.
than create corresponding action for the event in {{Path|/etc/acpi/actions/}}. See examples below.

==Recepies==
===Screen Lock button ===
{{File|/etc/acpi/events/FnF2-screenlock||<pre>
#Fn+F2 button/screenlock SCRNLCK 00000080 00000000 K
event=button/screenlock
action=/etc/acpi/actions/FnF2-screenlock.sh
</pre>}}

{{File|/etc/acpi/actions/FnF2-screenlock.sh||<pre>
#!/bin/sh
logger "[ACPI] Fn+F2 pressed, start Slimlock for logged-in user"
XUSER=$(ps aux | grep xinit | awk '{print $1}' | head -n1)
sudo -u $XUSER /usr/bin/slimlock&
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnF2-screenlock.sh}}

===Battery button===
{{File|/etc/acpi/events/FnF3-battery||<pre>
#Fn+F3 button/battery BAT 00000080 00000000 K
event=button/battery
action=/etc/acpi/actions/FnF3-battery.sh
</pre>}}

{{File|/etc/acpi/actions/FnF3-battery.sh||<pre>
#!/bin/sh
# Tried on Gentoo
# cpu throttling is in here it is the cpufreq-set lines
# turning swap off is only for those that feel comfortable
# doing something this nasty.
# comment out the laptop_mode line if you don't have it installed
# pcfe, 2008-10-28

# spindown time for HD (man hdparm for valid values)
# I prefer 2 hours for acad and 2 min for batt
ACAD_HD=244
BATT_HD=24
                                                                                                                                   
# Power management level
# 255 (off) on AC
# 128 (medium) on batt
# lowered to 32, pcfe, 2004-06-23
# upped to 64, pcfe, 2004-07-14
# upped to 96, pcfe, 2004-10-20
ACAD_PM=255
BATT_PM=96

logger "[ACPI] Fn+F3 pressed to toggle battery state"
# ac/battery event handler 
status=`awk '/^state: / { print $2 }' /proc/acpi/ac_adapter/AC/state` 
if [ "$status" = "off-line" ]
then
	logger "Running /sbin/laptop_mode start"
	/sbin/laptop_mode start
	logger "Setting HD spindown for BATT mode with hdparm -S $BATT_HD /dev/hda."
	/sbin/hdparm -S $BATT_HD /dev/hda > /dev/null 2>&1
	logger "Setting HD powersaving for BATT mode with hdparm -B $BATT_PM /dev/hda."
	/sbin/hdparm -B $BATT_PM /dev/hda > /dev/null 2>&1
	logger "Turning off swap."
	/sbin/swapoff -a
	/usr/bin/cpufreq-set -g conservative         
else   
	logger "Turning on swap."
	/sbin/swapon -a
	logger "Running /sbin/laptop_mode start"
	/sbin/laptop_mode stop
	logger "Setting HD spindown for AC mode with hdparm -S $ACAD_HD /dev/hda."
	/sbin/hdparm -S $ACAD_HD /dev/hda > /dev/null 2>&1
	logger "Setting HD powersaving for AC mode with hdparm -B $ACAD_PM /dev/hda."
	/sbin/hdparm -B $ACAD_PM /dev/hda > /dev/null 2>&1
	/usr/bin/cpufreq-set -g ondemand
fi
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnF3-battery.sh}}
Source: [http://www.thinkwiki.org/wiki/ACPI_action_script_for_battery_events| ThinkWiki.org]


===Sleep button===
{{File|/etc/acpi/events/FnF4-sleep||<pre>
#Fn+F4 button/sleep SBTN 00000080 00000000 K
event=button/sleep
action=/etc/acpi/actions/FnF4-sleep.sh
</pre>}}

{{File|/etc/acpi/actions/FnF4-sleep.sh||<pre>
#!/bin/sh
logger "[ACPI] Fn+F4 pressed, start Slimlock for current user and suspend to ram"
XUSER=$(ps aux | grep xinit | awk '{print $1}' | head -n1)
sudo -u $XUSER /usr/bin/slimlock&
echo -n mem >/sys/power/state
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnF4-sleep.sh}}


===WiFi button===
{{File|/etc/acpi/events/FnF5-wifi||<pre>
#Fn+F5 button/wlan WLAN 00000080 00000000 K
event=button/wlan
action=/etc/acpi/actions/FnF5-wlan.sh
</pre>}}

{{File|/etc/acpi/actions/FnF5-wifi.sh||<pre>
#!/bin/sh
logger "[ACPI] Fn+F5 pressed, WiFi rfkill state toggled"
rf=/sys/class/rfkill/rfkill0
case $(< $rf/state) in
    0) echo 1 >$rf/state;;
    1) echo 0 >$rf/state;;
esac
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnF5-wifi.sh}}


===Backlight control===

=====Brightness Up=====
{{File|/etc/acpi/events/FnHome-brightnessup||<pre>
#FnHome video/brightnessup BRTUP 00000086 00000000
event=video/brightnessup
action=/etc/acpi/actions/FnHome-brightnessup.sh
</pre>}}

{{File|/etc/acpi/actions/FnHome-brightnessup||<pre>
#!/bin/bash 

# Set the static increment value.  Keep in mind that this will 
# be done twice. 
IncVal=20 

# Get the Maximum value for use. 
#MaxVal=$(cat /sys/class/backlight/intel_backlight/max_brightness); 
read -r MaxVal < "/sys/class/backlight/intel_backlight/max_brightness"

# Get the current brightness value. 
#CurrVal=$(cat /sys/class/backlight/intel_backlight/brightness); 
read -r CurrVal < "/sys/class/backlight/intel_backlight/brightness"

# Set the new value minus the decrement value. 
NewVal=$(($CurrVal + $IncVal)); 
echo $NewVal 

# Set it to the threshold of the max value. 
ThresholdVal=$(($NewVal<$MaxVal?$NewVal:$MaxVal)) 
echo $ThresholdVal 

# Set the new value directly. 
echo -n $ThresholdVal > /sys/class/backlight/intel_backlight/brightness 

logger "[ACPI] brightnessup |$CurrVal| |$NewVal| |$ThresholdVal|"
</pre>}}

{{RootCmd|chmod +x /etc/acpi/actions/FnHome-brightnessup.sh}}


=====Brightness Down=====
{{File|/etc/acpi/events/FnEnd-brightnessdown||<pre>
#FnEnd video/brightnessdown BRTDN 00000087 00000000
event=video/brightnessdown
action=/etc/acpi/actions/FnEnd-brightnessdown.sh
</pre>}}

{{File|/etc/acpi/actions/FnEnd-brightnessdown||<pre>
#!/bin/bash 

# Set the static decrement value.  Keep in mind that this will 
# be done twice. 
DecVal=20 

# Set the Minimum we will accept. 
MinVal=0 

# Get the current brightness value. 
#CurrVal=$(cat /sys/class/backlight/intel_backlight/brightness); 
read -r CurrVal < "/sys/class/backlight/intel_backlight/brightness"

# Set the new value minus the decrement value. 
NewVal=$(($CurrVal - $DecVal)); 
echo $NewVal 

# Set it to the threshold of the min value. 
ThresholdVal=$(($NewVal>$MinVal?$NewVal:$MinVal)) 
echo $ThresholdVal 

# Set the new value directly. 
echo -n $ThresholdVal > /sys/class/backlight/intel_backlight/brightness 

logger "[ACPI] brightnessdown |$CurrVal| |$NewVal| |$ThresholdVal|"
</pre>}}

{{RootCmd|chmod +x /etc/acpi/actions/FnEnd-brightnessdown.sh}}

Source: [http://forums.gentoo.org/viewtopic-p-7578948.html forums.gentoo.org]

===CD control===
Instead of CD I would like to control {{Package|media-sound/moc}}. 

Initially I start mocp manually to populate playlist, quit qui and than use special keys to control mocp.

=====Stop=====
{{File|/etc/acpi/events/FnArrowUp-stop||<pre>
#Fn+ArrowUp cd/stop CDSTOP 00000080 00000000 K
event=cd/stop
action=/etc/acpi/actions/FnArrowUp-stop.sh
</pre>}}

{{File|/etc/acpi/actions/FnArrowUp-stop.sh||<pre>
#!/bin/sh
XUSER=$(ps -eo uname,args --sort start_time | grep mocp | awk '{print $1}' | head -n1)
sudo -u $XUSER /usr/bin/mocp -s
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnArrowUp-stop.sh}}

=====Prev track=====
{{File|/etc/acpi/events/FnArrowLeft-prev||<pre>
#Fn+ArrowUp cd/prev CDPREV 00000080 00000000 K
event=cd/prev
action=/etc/acpi/actions/FnArrowLeft-prev.sh
</pre>}}

{{File|/etc/acpi/actions/FnArrowLeft-prev.sh||<pre>
#!/bin/sh
XUSER=$(ps -eo uname,args --sort start_time | grep mocp | awk '{print $1}' | head -n1)
sudo -u $XUSER /usr/bin/mocp -r
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnArrowLeft-prev.sh}}

=====Next track=====
{{File|/etc/acpi/events/FnArrowRight-next||<pre>
#Fn+ArrowUp cd/next CDNEXT 00000080 00000000 K
event=cd/next
action=/etc/acpi/actions/FnArrowRight-next.sh
</pre>}}

{{File|/etc/acpi/actions/FnArrowRight-next.sh||<pre>
#!/bin/sh
XUSER=$(ps -eo uname,args --sort start_time | grep mocp | awk '{print $1}' | head -n1)
sudo -u $XUSER /usr/bin/mocp -f
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnArrowRight-next.sh}}

=====Play/Pause toggle=====
{{File|/etc/acpi/events/FnArrowDown-play||<pre>
#Fn+ArrowUp cd/play CDPLAY 00000080 00000000 K
event=cd/play
action=/etc/acpi/actions/FnArrowDown-play.sh
</pre>}}

{{File|/etc/acpi/actions/FnArrowDown-play.sh||<pre>
#!/bin/sh
XUSER=$(ps -eo uname,args --sort start_time | grep mocp | awk '{print $1}' | head -n1)
sudo -u $XUSER /usr/bin/mocp -G
</pre>}}
{{RootCmd|chmod +x /etc/acpi/actions/FnArrowDown-play.sh}}

==Troubleshooting==
To see output when you press a key
{{RootCmd|<pre>acpid -c /etc/acpi/events/ -s /var/run/acpid.socket -f -d -l | tee tmp</pre>}}

==Questions==
* Do I need to place all events in the same file, something like {{Path|/etc/acpi/events/default.thinkpad-t410}} and make it downloadable?

* How to choose vlock vs slimlock screenlock action depending on console vs Xorg or for both altogether?
Another option is to use ScrLk key to lock console with {{Package|app-misc/vlock}}, or it can be done through the same acpi action? dunno

[[Category:ACPI]]
