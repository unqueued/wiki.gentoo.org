{{stub}}

{{InfoBox stack
|{{InfoBox homepage|https://www.torproject.org/|header=true}}
|{{InfoBox wikipedia|Tor_(anonymity_network)|header=true}}
}}


'''Tor''' is an internet anonymity system.

==Install==

===Use Flags===

{{USEflag|package=net-misc/tor
|bufferevents
|nat-pmp
|selinux
|threads
|tor-hardening
|transparent-proxy
|upnp
|web
}}

=== Emerge ===

Install {{Package|net-misc/tor}}
{{emerge|net-misc/tor}}

To start immediately
{{RootCmd|rc-service tor start}}

To start at boot
{{RootCmd|rc-update add tor default}}

== Emerge Messages ==

 * Messages for package net-misc/tor-0.2.3.25:

 * We created a configuration file for tor, /etc/tor/torrc, but you can
 * change it according to your needs.  Use the torrc.sample that is in
 * that directory as a guide.  Also, to have privoxy work with tor
 * just add the following line
 * 
 * forward-socks4a / localhost:9050 .
 * 
 * to /etc/privoxy/config.  Notice the . at the end!

== Browser Configuration ==

=== Firefox ===

Edit > Preferences

Advanced > Network > Settings
<pre>
manual proxy configuration:
http proxy           port: 0
ssl proxy            port: 0
ftp proxy            port: 0
socks host 127.0.0.1 port: 9050
</pre>

Go to about:config and set the following:

<pre>
network.proxy.socks_remote_dns    true
network.dns.disablePrefetch       true
network.dns.disableIPv6           true
</pre>

This way Firefox will resolve host names via tor, thus preventing DNS leaks.

=== xombrero ===

{{Note|Use libsoup 2.42.2 or newer and xombrero 1.6.0 or newer in order to use a socks proxy directly.}}

Edit .xombrero.conf and add there the following lines:

<pre>
# Browser mode, MUST be the first entry in this file
browser_mode			=	whitelist
# Proxy settings
http_proxy			=	socks5://127.0.0.1:9050
http_proxy_starts_enabled	=	1
# Homepage
home				=	https://check.torproject.org
# Disable F2 so as not to toggle proxy settings by accident
keybinding			=	tabnew,F2
# Work directory (mount /tmp as tmpfs)
work_dir			=	/tmp/.xombrero
# Download directory
download_dir			=	/tmp/downloads
</pre>

{{Note|Disable the geoloc and jit USE flags in webkit-gtk, which xombrero depends on. The geoloc USE flag enables geolocation support through app-misc/geoclue. The jit USE flag prevents use of some PaX memory protection features in Gentoo Hardened. It is also possible to compile webkit-gtk with all USE flags disabled.}}

Optionally, it is possible to set different user_agent and http_accept strings. There are two files with user_agent string and http_accept headers in xombrero source code folder: user-agent-headers and http-accept-headers. These strings can be easily selected and added to the .xombrero.conf file with the following commands:

{{Cmd
|cat user-agent-headers {{!}} grep Linux {{!}} shuf -n 1 >> .xombrero.conf
|cat http-accept-headers {{!}} shuf -n 1 >> .xombrero.conf
}}

{{Warning|Your browser fingerprint may be unique! Choose a more common user_agent/http_accept combination if this is a problem for you.}}

== Dns ==
Some applications may leak DNS requests. The easiest way to check if this really happens is to look at system logs.

{{Cmd|sudo tail -f /var/log/messages}}

If an application is configured correctly, nothing shows in the logs. Below is an example of a message for a misconfigured application (or for a webpage that stores links in form of IP addresses):

<pre>
Oct 14 14:44:44 localhost Tor[666]: Your application (using socks5 to port 80) is giving Tor only an IP address. 
Applications that do DNS resolves themselves may leak information. Consider using Socks4A (e.g. via privoxy or socat) instead. 
For more information, please see https://wiki.torproject.org/TheOnionRouter/TorFAQ#SOCKSAndDNS.
</pre>

In order to check how this works, one needs to give an application an IP address instead of a domain name, retrieved by running the tor-resolve command for example.

== Disabling non-Tor traffic ==

The following iptables rules will prevent non-Tor traffic leaving the host and disable all new connections from outside in case if the host must be configured as a Tor client:

{{RootCmd
|iptables -F
|iptables -P OUTPUT DROP
|iptables -A OUTPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT
|iptables -A OUTPUT -m owner --uid-owner tor -j ACCEPT
|iptables -P INPUT DROP
|iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT
|iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
}}

== Torify ==
{{warning|torify will fail if you do not have torsocks installed!}}
<pre>emerge -av net-proxy/torsocks</pre>
For applications which do not support the use of proxies or Tor, you can use the "torify" command to force their traffic through the Tor network. (e.g. - ''torify irssi -c irc.afraidirc.net'' '''or''' ''torify irssi -c mqctemuqfc3tp5ji.onion'').

== Tor Minimal Configuration ==
The following is a minimal configuration of Tor which will get your Tor service up and running.<br />
Just create your /etc/tor/torrc file with the following information.<br />
<pre>User tor
PIDFile /var/run/tor/tor.pid
Log notice syslog
DataDirectory /var/lib/tor/data</pre>

== Stream Isolation ==
Accessing a site of a small town where you are the only one user of Tor would greatly increase attacker's chances to find you. Other examples include mixing gpg traffic with the traffic of a web browser or mixing irssi circuits with the circuits of a bitcoin wallet. In all cases an exit node can make correlation between separate activities. So, sometimes it's necessary to have a few different anonymity modes. Stream isolation provides an easy way to separate different Tor circuits and make different applications use isolated streams. In order to use stream isolation, add as many socks ports as necessary in torrc.

{{File|/etc/tor/torrc|torrc configuration|<pre>
# web browser
SocksPort 127.0.0.1:9050
# gpg client
SocksPort 127.0.0.1:9100
# instant messenger
SocksPort 127.0.0.1:9150
# etc...
</pre>}}

Configure the applications to point to different socks ports. All requests made to different socks ports will then pass through different Tor circuits and get different exit nodes. Sometimes Tor will only use a different entry guard or middle relay, though. This behavior is considered normal.

== Setting up a Hidden Service ==
{{Note|Hidden services are not nearly as anonymous as clients. Use it at your own risk.}}
Setting up a tor hidden service is easy.<br />
All you need to do is add 2 lines to your /etc/tor/torrc configuration file, and make sure your permissions are correct for the data directory.<br />
<pre>HiddenServiceDir /tor/hiddenservice
HiddenServicePort 80 127.0.0.1:80</pre>

The first line tells Tor to insert the public&private keys into the directory specified.<br />
The next line tells Tor to direct traffic on hidden service port 80 to the IP & port specified.<br />
You will need to make sure that the directory is owned and only readable/writable by tor, for example:<br />
<pre>chown tor /tor/hiddenservice -R && chmod u+rw,g-rw,o-rw /tor/hiddenservice -R</pre>

== Simple command line file downloading ==

You can download almost any resource located at a given URL and save it in a FILE using the following:

<pre>
curl --socks5-hostname 127.0.0.1:9050 -o FILE URL
</pre>

The --socks5-hostname means that hostnames are resolved via tor instead of your system's DNS resolution, thus preventing DNS leaks.

== Portage ==
You can configure Portage to sync its tree and fetch packages via tor. Add the following to /etc/portage/make.conf:

<pre>
FETCHCOMMAND="curl --socks5-hostname 127.0.0.1:9050 -o \"\${DISTDIR}/\${FILE}\" \"\${URI}\""
RESUMECOMMAND="curl --socks5-hostname 127.0.0.1:9050 -o \"\${DISTDIR}/\${FILE}\" \"\${URI}\""
</pre>

All the extra quoting is necessary. Have a look at "man curl" for more customization options.

We cannot use emerge --sync to update the portage tree via tor, because rsync cannot use socks proxy. In order to sync the portage tree via tor, use the command:

<pre>
emerge-webrsync
</pre>

This fetches the portage tree snapshot over http. The added advantage is that you can configure emerge-webrsync to additionaly verify the cryptographic signature of the portage tree, which cannot be achieved over emerge --sync. Such verification is explained in the Gentoo Handbook.

Installing or updating is done as usual, e.g.:
<pre>
emerge -av some-package
</pre>

== Check If Using Tor ==

https://check.torproject.org/

[[Category:Server]]
[[Category:Daemons]]
