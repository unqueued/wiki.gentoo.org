<languages />

{{Metadata|abstract=Данная статья объясняет, как новые выпуски Gentoo влияют на уже установленную систему.}}

Данная статья объясняет, как новые выпуски Gentoo влияют на уже существующие системы.

== Обновление ==

=== Философия ===

Здесь, на земле Gentoo, концепция обновление понимается совсем не так, как во всем остальном мире Linux. Это широко известный факт, что Gentoo никогда не следовала «классическому» способу обновления программ: дождаться нового релиза, скачать его, прожечь, засунуть диск в дисковод и, наконец, следовать установочным инструкциям. 

Gentoo пользователи знают, что такой процесс раздражает опытного пользователя, стремящегося всегда быть на переднем крае. Учитывая популярность и распространенность инструментов типа apt или apt-rpm, облегчающих быстрые и частые обновления, мы полагаем, что и опытные пользователи других дистрибутивов испытывают те же чувства. Однако ни один дистрибутив не приспособлен для удовлетворения нужд требовательных пользователей лучше Gentoo, поскольку Gentoo с самого начала строился на идее быстрых последовательных обновлений. 

В идеале, пользователи устанавливают систему однажды, и более никогда не беспокоятся о выпусках: просто следуйте инструкциям из [[Handbook:X86/Working/Portage/ru|введение в Portage]] в [[Handbook:X86/ru|настольной книге Gentoo]], где описывается, как поддерживать актуальность системы. Хотя обычно такого подхода достаточно, иногда в ядро системы вносятся изменения, требующее установки вручную.

=== Выпуски и профили ===

О процессе выпуска версий Gentoo постоянно задают вопрос: «Зачем нужно часто делать новые выпуски, если они не предназначены для обновления программ у пользователей?". Тому есть ряд причин: 

* Новый выпуск — это новые CD с исправлениями и дополненными возможностями.
* Новый выпуск несет обновленный набор пакетов GRP, так что пользователи, избирающие «быстрый способ» установки (stage3 + заранее скомпилированные пакеты), получают не устаревшую систему.
* Наконец, в новых выпусках время от времени реализуются функции, несовместимые с предыдущими выпусками.

Когда релиз включает в себя новые функции, несовместимые, или изменяет набор основных пакетов и установок, сильно меняющих поведение системы, мы говорим, что он предоставляет новый ''profile'' (профиль). 

''Профиль'' представляет собой набор конфигурационных файлов, хранимый в подкаталоге {{Path|/usr/portage/profiles}}, которые описывают вещи, такие как ebuild для ''system'' (системных) пакетов, USE-флаги по умолчанию, отображение по умолчанию для виртуальных пакетов, и архитектуру, на которой работает система. 

Используемый профиль определяется символьной ссылкой {{Path|/etc/portage/make.profile}}, указывающей на один из подкаталогов каталога {{Path|/usr/portage/profiles}}, содержащего файлы профиля. Например, профиль 13.0, являющийся профилем по умолчанию для {{Keyword|x86}}, находится в каталоге {{Path|/usr/portage/profiles/default/linux/x86/13.0}}. Файлы, находящиеся в родительском каталоге, также являются частью профиля (и, следовательно, используются различными субпрофилями) — поэтому эти профили называются ''каскадными'' (''cascaded profiles''). 

Устаревшие профили хранятся в каталоге {{Path|/usr/portage/profiles}} вместе с текущими, но они помечены как не рекомендованные к использованию (deprecated). В этом случае файл под названием {{Path|deprecated}} помещается в каталог профиля. Этот файл содержит название профиля, до которого следует "обновить" текущий профиль; Portage использует эту информацию для автоматического предупреждения администраторов о необходимости обновления профиля. 

Существует несколько причин почему новый профиль должен быть создан: выпуск новой версии основных пакетов (таких как {{Package|sys-apps/baselayout}}, {{Package|sys-devel/gcc}} или {{Package|sys-libs/glibc}}), которые не совместимы с предыдущими версиями, изменения в USE-флагах по умолчанию, отображения в виртуальных пакетах или, возможно, изменения в системных настройках.

== Обновление до нового релиза ==

=== Релизы без изменения профиля ===

Если новый релиз Gentoo не содержит новый профиль, то сделайте вид что ничего не произошло. &#128512; 

Когда установленные пакеты будут обновлены, как это [[Handbook:X86/Working/Portage/ru|объяснено]] в настольной книге Gentoo, система будет точно такой же, как и установленная с помощью нового релиза.

=== Релизы с изменением профиля ===

Если релиз (такой как 13.0 в {{Keyword|x86}}) вводит новый профиль, в этом случае есть выбор для миграции на новый профиль. 

Как правило, такие миграции не являются обязательными, и система может продолжать использовать старый профиль - просто обновите пакеты, как [[Handbook:X86/Working/Portage/ru|объяснено]] в настольной книге Gentoo. 

Тем не менее, Gentoo настоятельно рекомендует обновить профиль, если он становится устаревшим. Когда это происходит, то это означает, что разработчики Gentoo больше не планируют поддерживать его. 

Когда миграция профиля очевидна, обновление необходимо выполнить вручную. Способ обновления может существенно отличаться от релиза к релизу; он зависит от степени изменений, привносимых новым профилем. 

В простейшем случае пользователь должен только изменить ссылку {{Path|/etc/portage/make.profile}}, в худшем случае, возможно, придется перекомпилировать всю систему с нуля, при этом сплясав танец вуду. Миграция, как правило, рассматриваются в примечаниях к выпуску. Необходимые [[#Инструкции по обновлению профиля|инструкции]] есть далее в этом руководстве.

=== Поддерживаемые профили ===

Чтобы увидеть список поддерживаемых профилей, вызовите {{c|eselect}} (который можно установить с помощью команды {{c|emerge eselect}}) так: 

{{RootCmd|eselect profile list}}

=== Обновление старых систем ===

Некоторые системы являются слишком старыми для простого переключения профиля. Новым профилям могут требоваться более новые версии Portage, также может отсутствовать возможность установки других программ, так как определения пакетов (файлы ebuild) для более старых версий программ более недоступны.

В этом случае, в системе нужно сначала установить более старые снимки дерева Portage и обновить по крайней мере Portage (но, желательно, все пакеты в наборе system), постепенно увеличивая дату снимка дерева Portage, пока она не станет достаточно недавней для того, чтобы снова следовать инструкциям переключения профиля:

{{RootCmd
|mv /usr/portage /usr/portage.latest
|tar xjpf /path/to/portage-20090720.tar.bz2 -C /usr
|emerge -u portage
}}

Старые снимки зачастую все еще доступны на некоторых зеркал или в [https://dev.gentoo.org/~swift/snapshots/ определенных местах], выделенных для этой цели. Рекомендуется проверить целостность этих файлов, чтобы убедиться, что они не подделаны:

{{RootCmd|gpg --verify portage-20090720.tar.bz2.gpgsig portage-20090720.tar.bz2}}

Даже если [[Project:RelEng#Keys|ключи подписи релиза]] истекли, подпись все еще должна работать для старых релизов.

=== Обновление (очень) старых систем ===

Некоторые системы слишком стары для простого обновления. В процессе обновления могут потребоваться промежуточные версии программ (таких, как portage), которых больше нет в Portage. В этом случае потребуется обновлять дерево portage поэтапно (например, инкрементально обновлять дерево Portage с интервалами в 3-4 месяца). 

Для обновления таких систем может использоваться текущий stage3. Дальнейшие инструкции смотрите в разделе [[#Обновление старых систем|Обновление старых систем]].

== Инструкции по обновлению профиля ==

=== Основные инструкции ===

{{Important|Убедитесь, что синхронизировали основной репозиторий Gentoo (дерево Portage) перед любыми изменениями профиля.}}

Сначала запустите {{c|emerge eselect}}. Утилита {{c|eselect}} облегчает просмотр и выбор профилей, без необходимости вручную создавать или удалять символьные ссылки. 

{{RootCmd|eselect profile list
|eselect profile set <число>}}

Изменение профиля вручную все еще возможно с помощью команд: 

{{RootCmd
|rm /etc/portage/make.profile
|cd /etc/portage
|ln -s ../../usr/portage/profiles/<нужный profile> make.profile
}}

{{Note|Для большинства архитектур существуют субпрофили '''desktop''' и '''server'''. Тщательно изучите эти субпрофили, так как они могут лучше удовлетворять вашим требованиям, чем минимальные профили по умолчанию.}}

{{Note|Профиль developer предназначен для задач разработки Gentoo. Он ''не'' предназначен для настройки сред разработки в целом.}}

=== Обновление до 2008.0, 2007.0 или 2006.1 ===

Для обновления с этих профилей в системе необходимо установить локаль Unicode по умолчанию; конкретнее, необходимо установить <code>UNICODE="yes"</code> в файле {{Path|/etc/rc.conf}}. Для того, чтобы это сработало, в системе необходимо создать локаль Unicode. Чтобы узнать, как создать нужную локаль, читайте [[UTF-8/ru|статью UTF-8]]. 

В качестве альтернативного варианта, если устанавливать локаль нежелательно, то нужно указать <code>UNICODE="no"</code> в файле {{Path|/etc/rc.conf}} и переустановить {{Package|sys-apps/baselayout}} (или подождать следующего обновления baselayout) с USE-флагом <code>-unicode</code>. Это можно сделать следующим образом:


* установить <code>-unicode</code> только для {{Package|sys-apps/baselayout}}:
: {{RootCmd|echo "sys-apps/baselayout -unicode" >> /etc/portage/package.use}}
: {{Emerge|sys-apps/baselayout}}

* либо установить его глобально для всех пакетов, добавив в переменную USE в файле {{Path|/etc/portage/make.conf}}:
: {{FileBox|filename=/etc/portage/make.conf|title=Глобальное выключение поддержки unicode|lang=bash|1=USE="-unicode"}}
: {{Emerge|sys-apps/baselayout}}

{{Note|Пользователям, обновляющим систему до профиля 2007.0 на архитектуре Sparc, нужно следовать инструкциям [[Upgrading_GCC/ru|руководства по обновлению GCC]], поскольку <code>gcc-4</code> является компилятором по умолчанию.}}

Наконец, следуйте общим инструкциям по обновлению для того, чтобы обновить профиль.

=== Обновление до 2006.0 ===

Для переключения на профиль 2006.0 измените местоположение, на которое указывает символьная ссылка {{Path|/etc/portage/make.profile}}. Перед изменением профиля убедитесь, что Portage обновлена. 

{{RootCmd
|rm /etc/portage/make.profile
|ln -s ../usr/portage/profiles/<selected profile> /etc/portage/make.profile
}}

{{Keyword|alpha}} — Пользователям, которые используют ядро 2.4 или не хотят использовать NPTL, следует использовать профиль default-linux/alpha/no-nptl. Более подробную информацию можно найти в [http://www.gentoo.org//proj/en/releng/release/2006.0/alpha-release-notes.xml the alpha release notes]. 

{{Keyword|ppc}} — Процесс слияния профилей ppc32 и ppc64 шагнул вперед. Профиль ppc32 теперь предоставляет профиль общего назначения. Он находится в default-linux/ppc/ppc32. Профиль, зависящий от релиза, оптимизирован для использования на настольных системах. Он находится в default-linux/ppc/ppc32/2006.0. Доступен ряд субпрофилей для процессоров G3 и G4, а также G3/Pegasos и G4/Pegasos для Pegasos Open Desktop Workstation. Не забудьте выбрать правильный субпрофиль при миграции на профиль 2006.0. 

{{Keyword|sparc}} — Обновление до профиля 2006.0/2.4 на базе ядра '''2.4''' требует ручного вмешательства (удаления пакетов, связанных с java), а также {{c|emerge -e @world}} по причине [[Upgrading_GCC/ru|обновления gcc]]. Для обновления до профиля 2006.0 на базе ядра '''2.6''', который считается нестабильным, также необходимо отредактировать файл {{Path|/etc/portage/package.unmask}} и размаскировать исходный код ядра {{Package|sys-kernel/gentoo-sources}} версии 2.6. Также необходимо полностью пересобрать систему. 

'''Прочие архитектуры''' — Этот профиль не содержит существенных изменений. Дополнительные действия не требуются.

=== Обновление до 2005.1 ===

Чтобы переключиться на профиль 2005.1, измените местоположение, на которое указывает символьная ссылка {{Path|/etc/portage/make.profile}}. Перед изменением профиля убедитесь, что Portage обновлена. 

{{RootCmd|rm /etc/portage/make.profile
|ln -s ../usr/portage/profiles/<selected profile> /etc/portage/make.profile}}

'''Все архитектуры''' — Этот профиль не содержит существенных изменений. Дополнительные действия не требуются. 

{{Keyword|ppc}} — В релизе 2005.1 профили ppc и ppc64 были соединены и был создан ряд субпрофилей для конкретных субархитектур.  Не забудьте выбрать правильный субпрофиль при миграции на профиль 2005.1. 

=== Обновление до 2005.0 ===

С появлением 2005.0, в некоторых архитектурах были определены дополнительные профили. Перед тем, как принять решение о миграции на эти профили, прочитайте их описание. Также, большинство архитектур, ранее по умолчанию использовавших дерево ядра 2.4, теперь используют 2.6. 

Некоторые архитектуры требуют дополнительных действий для перехода с одного профиля на другой. В таких случаях таблица содержит ссылки на руководства с пошаговыми инструкциями. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! Профиль
! Описание
! Руководство по обновлению
|- 
| default-linux/alpha/2005.0
| Профиль по умолчанию Alpha 2005.0 для ядер 2.6
| 
|- 
| default-linux/alpha/2005.0/2.4
| Профиль Alpha 2005.0 для ядер 2.4
| 
|- 
| default-linux/amd64/2005.0
| Профиль по умолчанию AMD64 2005.0 для ядер 2.6
| 
|- 
| default-linux/amd64/2005.0/no-multilib
| Профиль AMD64 2005.0 для систем с выключенным multilib
| 
|- 
| default-linux/arm/2005.0
| Профиль по умолчанию ARM 2005.0 для ядер 2.6
| 
|- 
| default-linux/hppa/2005.0
| Профиль по умолчанию HPPA 2005.0 для ядер 2.6
| 
|- 
| default-linux/hppa/2005.0/2.4
| Профиль HPPA 2005.0 для ядер 2.4
| 
|- 
| default-linux/mips/2005.0
| Профиль по умолчанию MIPS 2005.0
| 
|- 
| default-linux/mips/cobalt/2005.0
| Cobalt специфический профиль MIPS 2005.0
| 
|- 
| default-linux/mips/mips64/n32/2005.0
| Профиль 2005.0 платформ MIPS, поддерживающих n32
| 
|- 
| default-linux/mips/mips64/ip28/2005.0
| Indigo2 Impact специфический 64-битный профиль 2005.0
| 
|- 
| default-linux/mips/mips64/2005.0
| 64-битный профиль MIPS 2005.0
| 
|- 
| default-linux/ppc/2005.0
| Профиль по умолчанию PPC 2005.0 для ядер 2.6
| 
|- 
| default-linux/ppc64/2005.0
| Профиль по умолчанию PPC64 2005.0 для ядер 2.6
| 
|- 
| default-linux/s390/2005.0
| Профиль по умолчанию S390 2005.0
| 
|- 
| default-linux/sparc/sparc32/2005.0
| Профиль по умолчанию Sparc 32-bit 2005.0
| 
|- 
| default-linux/sparc/sparc64/2005.0
| Профиль по умолчанию Sparc 64-bit 2005.0
| 
|- 
| default-linux/x86/2005.0
| Профиль по умолчанию x86 2005.0 для ядер 2.6
| 
|- 
| default-linux/x86/2005.0/2.4
| Профиль x86 2005.0 для ядер 2.4
| 
|-
|}

Чтобы переключиться на выбранный профиль, измените местоположение, на которое указывает символьная ссылка {{Path|/etc/portage/make.profile}}. Перед изменением профиля убедитесь, что Portage обновлена! 

{{RootCmd|rm /etc/portage/make.profile
|ln -s ../usr/portage/profiles/<selected profile> /etc/portage/make.profile}}

Если планируется обновление Linux-системы, основанной на ядре 2.4, на ядро 2.6, обязательно прочитайте [[Kernel/Migrate_2.4_to_2.6|Gentoo Linux 2.6 Migration Guide]].

=== Обновление до 2004.3 ===

Профили 2004.3 не привносят в систему существенных изменений (подробнее смотрите ниже). Тем не менее, разработчики Gentoo решили вытеснить этот профиль и пометить множество старых профилей, как не рекомендованные, для ускорения перехода на профили ''stacked'' (''stacked profiles''), которые используют новый формат каталога {{Path|/usr/portage/profiles}}, например, {{Path|/usr/portage/profiles/default-linux/x86/2004.3}} (поддерживающийся в Portage 2.0.51 и более поздних). 

Чтобы переключиться на профиль 2004.3, измените местоположение, на которое указывает символьная ссылка {{Path|/etc/portage/make.profile}}. 

{{Warning|Не забудьте обновить Portage ''до'' изменения профиля!!!}}

{{RootCmd|rm /etc/portage/make.profile
|ln -s ../usr/portage/profiles/default-linux/<arch>/2004.3 /etc/portage/make.profile}}

'''Все архитектуры''' — Как сказано выше, этот профиль не несет в себе существенных изменений. Однако, стоит отметить, что пакеты {{Package|sys-apps/slocate}} и {{Package|net-misc/dhcpcd}} больше не считаются системными пакетами. Это означает, что при запуске {{c|emerge --depclean}} Portage попытается удалить их из системы. Если требуется сохранить какой-либо из этих пакетов, их нужно либо добавить в {{Path|/var/lib/portage/world}} после переключения профиля, либо установить вручную. 

{{Keyword|ppc}} — На новых системах по умолчанию устанавливается {{Package|sys-fs/udev}} вместо {{Package|sys-fs/devfs}}. Это не влияет на уже установленные системы.

=== Обновление Portage для поддержки каскадных профилей ===

Хотя этот раздел не совсем вписывается в данное руководство по обновлению, он довольно важен. Все перечисленные выше профили требуют наличия версии Portage, поддерживающей каскадные профили. Однако, некоторые устаревшие профили не позволяют обновить Portage, либо используемый профиль более недоступен — тогда обновить Portage не удастся. 

Решить эту проблему можно, создав временную символьную ссылку, указывающую на ''устаревший'' профиль. Это позволит обновить Portage, после чего можно продолжить процедуру обновления, описанную в этом руководстве. Замените <code><nowiki><arch></nowiki></code> соответствующей системной архитектурой: 

{{RootCmd
|rm /etc/portage/make.profile
|cd /etc/portage
|ln -sf ../usr/portage/profiles/obsolete/<arch> make.profile
|emerge -n '>{{=}}sys-apps/portage-2.0.51'
}}

=== Обновление до 2004.2 ===

Чтобы переключиться на профиль 2004.2, измените местоположение, на которое указывает символьная ссылка {{Path|/etc/portage/make.profile}}: 

{{Warning|Не забудьте обновить Portage ''до'' изменения профиля!!!}}

{{RootCmd|rm /etc/portage/make.profile
|ln -s ../usr/portage/profiles/default-linux/<arch>/2004.2 /etc/portage/make.profile}}

{{Keyword|x86}} — Этот профиль заменяет использующуюся по умолчанию реализацию X11 <s>{{Package|x11-base/xfree}}</s> (не рекомендована) на {{Package|x11-base/xorg-x11}}. Это изменяет только значение ''по умолчанию'', и актуально только для тех, кто еще не установил X-сервер. Если X-сервер уже установлен, это никак не повлияет на систему; пользователи могут свободно переключаться между X-серверами, как и раньше. 

{{Keyword|amd64}} — Этот профиль не содержит существенных изменений по сравнению с предыдущими профилями, дополнительные действия не требуются.

=== Обновление до 2004.0 ===

Чтобы переключиться на профиль 2004.0, измените местоположение, на которое указывает символьная ссылка {{Path|/etc/portage/make.profile}}: 

{{RootCmd
|rm /etc/portage/make.profile
|ln -s ../usr/portage/profiles/default-<arch>-2004.0 /etc/portage/make.profile
}}

'''Все архитектуры''' — Этот профиль не содержит существенных изменений по сравнению с предыдущими профилями, дополнительные действия не требуются. 

=== Обновление профилей старше 1.4 до 1.4 ===

Инструкции для этого обновления довольно сложны, их можно найти [https://gentoo-handbook.lugons.org/doc/en/new-upgrade-to-gentoo-1.4.xml здесь]. 

== Обновление старых систем ==

=== Идея обновления ===

Идея этого обновления заключается в создании промежуточного сборочного chroot, в который распаковывается новый stage3. Затем, при помощи утилит, доступных в stage3 chroot, обновляются пакеты на live системе. 

{{Warning|Нижеследующие команды могут быть неполными и являются скорее подсказкой, чем рабочими инструкциями. Если подход не вполне ясен, возможно, проще сделать резервную копию важных файлов и переустановить Gentoo.}}

=== Подготовка промежуточного сборочного chroot ===

Сначала создадим каталог для промежуточного сборочного chroot, например, {{Path|/mnt/build}}, и распакуем в него новый архив stage3. 

{{RootCmd
|mkdir -p /mnt/build
|tar -xf /path/to/stage3-somearch-somedate.tar.bz2 -C /mnt/build
|mount --rbind /dev /mnt/build/dev
|mount --rbind /proc /mnt/build/proc
|mount --rbind /sys /mnt/build/sys
}}

Затем создадим точку монтирования внутри этого окружения chroot, и смонтируем live (старое) окружение. 

{{RootCmd
|mkdir -p /mnt/build/mnt/host
|mount --rbind / /mnt/build/mnt/host
}}

Теперь live (старая) система также доступна в {{Path|/mnt/build/mnt/host}}. Это позволяет нам получить доступ к live (старой) системе и обновить пакеты, даже находясь в промежуточном сборочном chroot.

=== Network, chroot, and update ===

The new install needs to access the network, so copy over the network related information:

{{RootCmd|cp -L /etc/resolv.conf /mnt/build/etc/}}

Now chroot into the intermediate build location, and start updating vital packages on the live system, until the live system can be updated from within the live system (rather than through the intermediate build chroot):

{{RootCmd
|chroot /mnt/build
|source /etc/profile
|export PS1{{=}}"(chroot) ${PS1}"}}

{{GenericCmd|prompt=(chroot) root #|color=red|emerge --sync}}

<!-- The following section is being tested... do not uncomment (author: Maffblaster -->
<!--Make sure the profile in the chroot matches the one inside the (old) live system. Run the following command in both environments to make sure profiles match:

{{RootCmd|eselect profile list}}
{{GenericCmd|prompt=(chroot) root #|color=red|eselect profile list}}

Verify Portage's configuration files in the new chroot are the same as the ones set in the old system. The following command will recursively copy the profile from the (old) live system into the chroot 

{{GenericCmd|prompt=(chroot) root #|color=red
|cp -rv /mnt/host/etc/portage /etc
|cp -rv /mnt/host/var/lib/portage /var/lib
}}

{{Note|Look at the output of the above commands to verify everything has copied correctly. There may be errors if some path names in the (old) live system were directories. For example, if {{Path|/etc/portage/package.use}} is a directory in the host, then it will probably not get copied correctly to the chroot system.}}
-->

Now start building packages into the (old) live system. If Portage is old or missing, it is a good idea to start with that:

{{GenericCmd|prompt=(chroot) root #|color=red|emerge --root{{=}}/mnt/host --config-root{{=}}/mnt/host --verbose --oneshot sys-apps/portage}}

Keep this chrooted session open and try to update the (old) live system. When failures occur, use this chrooted session to update packages using the build tools available in the intermediate build chroot (which includes recent {{Package|sys-libs/glibc}}, {{Package|sys-devel/gcc}}, etc.). Tools can be added as needed to the build chroot.

{{Important|Do not forget to add <code>--root{{=}}/mnt/host --config-root{{=}}/mnt/host</code> to all {{c|emerge}} commands executed within the chroot! Otherwise the chroot itself is updated rather than the (old) live system.}}

For some installations it may be necessary to update configuration files in order to install new software. Make the changes in the chroot environment.

To get the system fully up-to-date before exiting the root, build the <code>@world</code> set (all packages) into the (old) live system:

{{GenericCmd|prompt=(chroot) root #|color=red|emerge --root{{=}}/mnt/host --config-root{{=}}/mnt/host --update --newuse --deep --ask @world}}

Once finished the system should now be up to date!

[[Category:Server and Security]] {{Migrated|originalauthors=Gregorio Guidi, Chris Gianelloni, Joshua Saddler}}
