Do you have a UPS? Do you want to have you system gracefully shutdown in case of a power outage? This guide will show how you can make the most out of your UPS by using NUT from the [http://www.networkupstools.org/ Network UPS Tools] project

== Installation ==

=== USE flag ===

If you are connecting your UPS via USB, make sure to set the <code>usb</code> USE flag:

{{USEflag|package=sys-power/nut}}

=== Emerge ===

{{Emerge|sys-power/nut}}

== Configuration ==

Search a UPS with nut-scanner:

{{RootCmd|/usr/bin/nut-scanner|output=<pre>
Scanning USB bus.
Scanning XML/HTTP bus.
No start IP, skipping NUT bus (old connect method)
[nutdev1]
        driver = "usbhid-ups"
        port = "auto"
        vendorid = "051D"
        productid = "0002"
        product = "Back-UPS SMC 1500 FW:879.L4 .I USB FW:L4"
        serial = "***"
        vendor = "American Power Conversion"
        bus = "003"
</pre>}}

Take note of driver name and port type for configuration file.

If UPS is connected via USB port, add user nut to group usb.

{{RootCmd|usermod -a -G usb nut}}


=== Files ===

==== /etc/nut/nut.conf ====

Set mode to standalone if your machine is connected to the UPS directly and you want to run NUT on this machine.

{{RootCmd|nano -w /etc/nut/nut.conf}}

{{FileBox|filename=/etc/nut/nut.conf|title=Desired settings|1=
MODE=standalone
}}

==== /etc/nut/ups.conf ====

This is where you set up your UPS configuration. Make sure that your UPS name (the text in the brackets) doesn't have any spaces. For configuration specific to your UPS you need to look it up here: [http://www.networkupstools.org/stable-hcl.html NUT Hardware Compatibility Lookup]

{{RootCmd|nano -w /etc/nut/ups.conf}}

{{FileBox|filename=/etc/nut/ups.conf|title=Example ups.conf configuration|lang=ini|1=
[APCSMC1500]
    driver = usbhid-ups
    port = auto
    desc = "APC SMC1500 UPS"
}}

==== /etc/nut/upsd.users ====

You need to configure at least one user so that upsmon can be launched later. {{c|upsd}} will create a TCP connection that upsmon will use to check on the status of your UPS. 

{{RootCmd|nano -w /etc/nut/upsd.users}}

{{FileBox|filename=/etc/nut/upsd.users|title=Example upsd.users configuration|lang=ini|1=
[ups]
    password = mypassword
    upsmon master
}}

==== /etc/nut/upsmon.conf ====

Create a MONITOR configuration in {{Path|/etc/nut/upsmon.conf}}:

{{RootCmd|nano -w /etc/nut/upsmon.conf}}

{{FileBox|filename=/etc/nut/upsmon.conf|title=Example upsmon configuration|1=
MONITOR APCSMC1500@127.0.0.1 1 ups mypassword master
}}

=== Services ===

==== OpenRC ====

To add the services to start on system boot:

{{RootCmd
|rc-update add upsdrv default
|rc-update add upsd default
|rc-update add upsmon default
}}

To start {{c|upsd}} now run:

{{RootCmd
|rc-service upsdrv start
|rc-service upsd start
|rc-service upsmon start
}}

Check the status of your ups manually. Note that you might have to adjust your UPS name for this work.
 
{{RootCmd|upsc APCSMC1500@127.0.0.1 ups.status|output=<pre>
OL
</pre>}}

OL means that your UPS is "online" and not drawing from the battery. It also means that you configured the above files correctly.

If you want nut to power off your UPS when it shuts down your system in a power failure, you must add nut.powerfail to your shutdown runlevel:
{{RootCmd|rc-update add nut.powerfail shutdown}}

== External resources ==
* [https://networkupstools.org/docs/user-manual.chunked/index.html Official user manual]
