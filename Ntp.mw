{{Lowercase title}}
{{InfoBox stack
|{{InfoBox wikipedia|Network Time Protocol|header=true}}
}}
'''NTP''' ('''N'''etwork '''T'''ime '''P'''rotocol) is used to synchronize the [[system time]] with other devices over the network. This usually happens in a client-server model.

== Installation ==
Install {{Package|net-misc/ntp}}:
{{USEflag
|package=net-misc/ntp
|caps
|debug++no
|ipv6+yes
|openntpd
|parse-clocks
|samba
|selinux
|snmp
|ssl+yes
|vim-syntax
|zeroconf
}}

{{Emerge|ntp}}

Or alternatively, you can use {{Package|net-misc/openntpd}} instead.

== Configuration ==
=== Ntp-Client ===

to adjust ntp-client's command & upstream servers.

{{File|/etc/conf.d/ntp-client||<pre>
NTPCLIENT_CMD="ntpdate"
NTPCLIENT_OPTS="-s -b -u \
	0.gentoo.pool.ntp.org 1.gentoo.pool.ntp.org \
	2.gentoo.pool.ntp.org 3.gentoo.pool.ntp.org"
</pre>
}}

=== Server ===

Here you can specify with which servers you want to synchronize your local time for ntpd.  

The default configuration is populated with
{{File|/etc/ntp.conf||<pre>
server 0.gentoo.pool.ntp.org
server 1.gentoo.pool.ntp.org
server 2.gentoo.pool.ntp.org
server 3.gentoo.pool.ntp.org
</pre>}}

{{Note|Time zones and location of the server do not matter, it synchronizes the [[Wikipedia:Coordinated Universal Time|UTC time]].}}

Per default the Gentoo servers are listed and enabled. A list of available servers can be found here: [http://www.pool.ntp.org/en/#top ntp.org] You can also define a home or company server here, given that ntpd is running and the machine is allowed to.

On systems, where network connection is not always available at boot (laptops etc.) it might be helpful to add the following lines to server configuration:
{{File|/etc/ntp.conf||<pre>
server 127.127.1.0
fudge  127.127.1.0 stratum 10
</pre>}}
This sets localhost as a server with low priority, so that the daemon starts properly even without network connection and switches to using network servers when connection is established.

=== Permissions ===
To control who is allowed to synchronize with this machine and change the configuration, you can change these options.

* access to NTP service allowed only from localhost.
{{File|/etc/ntp.conf||<pre>
# To deny other machines from changing the
# configuration but allow localhost:
restrict default nomodify nopeer
restrict 127.0.0.1
</pre>}}

* access to NTP service allowed only from the 192.168.0.0/24 network.
{{File|/etc/ntp.conf||<pre>
# To allow machines within your network to synchronize
# their clocks with your server, but ensure they are
# not allowed to configure the server or used as peers
# to synchronize against, uncomment this line.
#
restrict 192.168.0.0 mask 255.255.255.0 nomodify nopeer notrap
</pre>}}

== Usage ==
Basic tools and common usage

=== Client ===
==== Ntp-Client ====
{{RootCmd|rc-service ntp-client start}}

To monitor status of the client.

{{RootCmd|rc-service ntp-client status}}

To start at boot.

{{RootCmd|rc-update add ntp-client default}}

==== Ntpdate ====
This used to be the client, but its functionality is now moved into ntpd & ntp-client itself. It is purely to set the local time when started and then exits (not a service):

{{RootCmd|ntpdate pool.ntp.org}}

=== Server ===
==== Ntpd Service ====

If ntpd is run as a service, the time will automatically synchronize as long as the difference between the local time and the time on the server is less than 1000s (~17min). So it is pretty common to adjust the time initially to whatever the server time is as a trusted source:

{{RootCmd|ntpd -g -c /etc/ntp.conf}}
{{Note|If ntpd is already running, it won't start a second time.}}

Add ntpd to the default runlevel to have the time synchronized automatically.  There is no need to run a client when the service is running.  Make sure you are not running ntp-client or ntpdate.

{{RootCmd
|rc-service ntpd start
|rc-update add ntpd default}}

To monitor status of the server.

{{RootCmd|rc-service ntpd status}}


=== Hardware Clock ===
To write your NTP sync time to the hardware at shutdown, and read hw clock at start.

{{RootCmd|<pre>
echo 'clock_hctosys="YES"' >> /etc/conf.d/hwclock
echo 'clock_systohc="YES"' >> /etc/conf.d/hwclock
rc-service hwclock restart
rc-update add hwclock boot
</pre>}}

Or on a sufficiently modern kernel (3.9 or newer), you can configure Linux to handle it automatically:

{{Kernel||<pre>
Device Drivers  --->
  [*] Real Time Clock  --->
    [*]   Set system time from RTC on startup and resume
    [*]   Set the RTC time based on NTP synchronization
</pre>}}

The hwclock init script is not needed at all with this method, which speeds up the boot/shutdown process slightly.

== See also ==
* [http://www.gentoo.org/doc/en/home-router-howto.xml#doc_chap6 Home Router Guide]

== External resources ==
* [http://www.pool.ntp.org/ ntp.org]

[[Category:Daemons]]
[[Category:Server]]
