[[File:GNOME_without_systemd.png|thumb|right|400px|GNOME 3.14 session, under OpenRC (not systemd!) init]]

Brief instructions for using '''GNOME''' (3.14, 3.16, 3.18, 3.20 or 3.22) under '''OpenRC''' (rather than systemd!) in Gentoo, via Dantrell B.'s [https://github.com/dantrell/gentoo-project-gnome-without-systemd patchset].

== Introduction ==

Users of GNOME 3 on Gentoo have, until recently, been required either to use [[systemd]] as their init system, or else to use a [https://github.com/sakaki-/funtoo-2-gentoo 'shim' overlay] to pull in Funtoo's patched version of GNOME (which supports OpenRC).

Now, however, Dantrell B., the primary author of the Funtoo GNOME patchset, has [https://github.com/dantrell/gentoo-project-gnome-without-systemd made his work available] for Gentoo users directly.

To be clear, this means that you can now enjoy the full GNOME experience (including session tracking and power management), even on a PC running 'stable branch' ({{c|amd64}}) Gentoo, without systemd.

This brief guide leads you through the steps you need to take to get GNOME up and running under this patchset.

{{Important|As with any third-party overlay, please be aware that:
* you may find it more difficult to get support via the normal Gentoo channels (the forums etc.). when using an 'unofficial' patchset such as this one;
* security fixes etc. may take longer to be released, and the overlays may themselves contain security holes;
* the patchset's author (Dantrell B.) may cease support for this patchset in the future.

Having said that:
* the vast majority of the GNOME code is unaffected by the patches;
* the patchset code itself is largely shared with Funtoo, who use it in their mainline distribution, so you will not be alone;
* Dantrell B. [https://github.com/dantrell/gentoo-project-gnome-without-systemd/blob/master/GOVERNANCE.md#long-term-support has stated] his intention to support this patchset for Gentoo (at least until either a proper answer for the GNOME/systemd issue is arrived at, he ceases to use GNOME, or the complexity gets out of control).}}
{{Note|The [https://forums.gentoo.org/viewtopic-t-1022050.html "GNOME without Systemd" thread] on the Gentoo wiki has been stickied and now doubles as an "official" support forum; accordingly, if you experience problems with this patchset, please post your issue there.}}

== Prerequisites ==

It is assumed that:
* having followed the normal [[Handbook:AMD64#Installing_Gentoo|"Installing Gentoo" process from the official Handbook]], you are currently running a stock {{c|amd64}} Gentoo system which has working internet access etc. (it is also fine to be on {{c|~amd64}})
* you have at least one 'regular' (non-root) user set up;
* you have prepared your kernel and {{Path|/etc/portage/make.conf}} file for X-server installation ({{c|VIDEO_CARDS}} and {{c|INPUT_DEVICES}} variables set), as described [[Xorg/Guide#Installation|here]]. You do not have to have actually installed the X-server, however (although since X-related problems are some of the most commonly encountered when installing GNOME, it is recommended that you do);{{Note|A minimal setup for test purposes, which should run on most systems, can be created by [[Handbook:AMD64/Installation/Kernel#Alternative:_Using_genkernel|building the kernel]] using <kbd>genkernel all</kbd>, and setting <code>VIDEO_CARDS{{=}}"vesa"</code> and <code>INPUT_DEVICES{{=}}"evdev synaptics"</code> in {{Path|/etc/portage/make.conf}}; for full functionality and higher screen resolution, you should of course specify the correct video driver and kernel options, per the [[Xorg/Guide#Installation|guide just cited]].<br>NB, the {{c|vesa}} driver will not work if running as a guest in [[VirtualBox]] with [[:Wikipedia:Unified_Extensible_Firmware_Interface{{!}}EFI]] emulation turned on; in this case, you should instead use the {{Package|x11-drivers/xf86-video-virtualbox}} driver, as selected by <code>VIDEO_CARDS{{=}}"virtualbox"</code> in {{Path|/etc/portage/make.conf}}.}}
* you have a UTF-8 locale selected (as described [[Handbook:AMD64/Installation/Base#Configure_locales|here]]).

== Installation ==

=== Setting Global USE Flags ===

First, if you have the {{c|bindist}} USE flag set in your {{Path|/etc/portage/make.conf}} file, it is recommended to '''unset''' it now, to avoid issues with {{Package|dev-libs/openssl}}, {{Package|net-misc/openssh}} and dependencies later.

Next, ensure everything is up-to-date on your current setup, before proceeding further:

{{RootCmd
|emerge --sync
|emerge --deep --with-bdeps=y --newuse --update --ask --verbose @world
}}

=== Installing the Overlays ===

You now have two options: either install Dantrell B.'s overlays under [[layman]], or add them directly (assuming you are using version >= 2.2.16 of {{Package|sys-apps/portage}}).


==== Option 1: Installation under layman ====

To install the overlays, first emerge and configure {{c|layman}}, as detailed [[layman|here]], with the {{c|git}} USE flag enabled (it is by default).

Then, edit the {{c|overlays}} stanza of {{Path|/etc/layman/layman.cfg}} so it reads:
{{FileBox|filename=/etc/layman/layman.cfg|title=Make dantrell overlays visible to layman|1=
overlays  : http://www.gentoo.org/proj/en/overlays/repositories.xml
            https://raw.githubusercontent.com/dantrell/gentoo-overlay-dantrell-gnome/master/repositories.xml
}}

Sync the overlay metadata, and add the 'generic' GNOME overlay:
{{RootCmd
|layman --sync-all
|layman -a dantrell-gnome
}}

Next, add the desired GNOME 'version' overlay(s); if using the 'stable' ({{c|amd64}}) branch, you should use at least the one which matches the current stable {{Package|gnome-base/gnome}} in Gentoo (version 3.20, at the time of writing).

{{Note|It's OK to select more than one (e.g., to select ''all five of'' {{c|dantrell-gnome-3-14}}, {{c|dantrell-gnome-3-16}},  {{c|dantrell-gnome-3-18}}, {{c|dantrell-gnome-3-20}} and {{c|dantrell-gnome-3-22}}) - your profile (which we will set [[#Setting_the_Profile.2C_and_Updating|below]]) will determine which takes precedence.}}

For GNOME 3.14, issue:

{{RootCmd
|layman -a dantrell-gnome-3-14
}}

For GNOME 3.16, issue:

{{RootCmd
|layman -a dantrell-gnome-3-16
}}

For GNOME 3.18, issue:

{{RootCmd
|layman -a dantrell-gnome-3-18
}}

For GNOME 3.20, issue:

{{RootCmd
|layman -a dantrell-gnome-3-20
}}

For GNOME 3.22, issue:

{{RootCmd
|layman -a dantrell-gnome-3-22
}}

==== Option 2: Direct Installation ====

Under modern (>= 2.2.16) versions of {{c|portage}}, it isn't necessary to use [[layman]] - you can add the overlays directly if you like.

{{Note| The following will assume you are using the 'subdirectory' approach for {{Path|/etc/portage/<...>}} settings files, as this is more convenient, and furthermore is what is now used on the Gentoo "minimal install" images).}}

Begin by ensuring the that you have a {{Path|/etc/portage/repos.conf}} directory in place:

{{RootCmd
|mkdir -pv /etc/portage/repos.conf
}}

Check you have a {{Path|/etc/portage/repos.conf/gentoo.conf}} file; if not, create it following the pattern below (adapt the {{c|sync-uri}} appropriately for your location):

{{FileBox|filename=/etc/portage/repos.conf/gentoo.conf|title=Configuration for the Gentoo repo|1=
[DEFAULT]
main-repo = gentoo

[gentoo]
location = /usr/portage
sync-type = rsync
auto-sync = yes

sync-uri = rsync://rsync.uk.gentoo.org/gentoo-portage
}}

Next, we need to create configuration files for Dantrell B.'s external overlays. At the time of writing there are six overlays: a 'common' one, and one for each of GNOME 3.14, 3.16, 3.18, 3.20 and 3.22. Create the following file for the 'common' overlay:

{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome.conf|title=Configuration for dantrell-gnome repo|1=
[dantrell-gnome]

# Dantrell B.'s Gentoo Overlay for GNOME (generic)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd

location = /usr/local/portage/dantrell-gnome
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome.git
priority = 150
auto-sync = yes
}}

Next, create the desired GNOME 'version' overlay configuration file(s), as shown below; if using the 'stable' ({{c|amd64}}) branch, you should create at least the one which matches the current stable {{Package|gnome-base/gnome}} in Gentoo (version 3.20, at the time of writing).

{{Note|It's OK to set up more than one of these if you want (e.g., to create ''all five of'' {{Path|/etc/portage/repos.conf/dantrell-gnome-3-14.conf}}, {{Path|/etc/portage/repos.conf/dantrell-gnome-3-16.conf}}, {{Path|/etc/portage/repos.conf/dantrell-gnome-3-18.conf}}, {{Path|/etc/portage/repos.conf/dantrell-gnome-3-20.conf}} and {{Path|/etc/portage/repos.conf/dantrell-gnome-3-22.conf}}) - your profile (which we will set [[#Setting_the_Profile.2C_and_Updating|below]]) will determine which takes precedence.}}

For GNOME 3.14, create the following file:

{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-14.conf|title=Configuration for dantrell-gnome-3-14 repo|1=
[dantrell-gnome-3-14]

# Dantrell B.'s Gentoo Overlay for GNOME (3.14)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd

location = /usr/local/portage/dantrell-gnome-3-14
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-14.git
priority = 100
auto-sync = yes
}}

For GNOME 3.16, create the following file:

{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-16.conf|title=Configuration for dantrell-gnome-3-16 repo|1=
[dantrell-gnome-3-16]

# Dantrell B.'s Gentoo Overlay for GNOME (3.16)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd

location = /usr/local/portage/dantrell-gnome-3-16
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-16.git
priority = 100
auto-sync = yes
}}

For GNOME 3.18, create the following file:

{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-18.conf|title=Configuration for dantrell-gnome-3-18 repo|1=
[dantrell-gnome-3-18]

# Dantrell B.'s Gentoo Overlay for GNOME (3.18)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd

location = /usr/local/portage/dantrell-gnome-3-18
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-18.git
priority = 100
auto-sync = yes
}}

For GNOME 3.20, create the following file:

{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-20.conf|title=Configuration for dantrell-gnome-3-20 repo|1=
[dantrell-gnome-3-20]

# Dantrell B.'s Gentoo Overlay for GNOME (3.20)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd

location = /usr/local/portage/dantrell-gnome-3-20
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-20.git
priority = 100
auto-sync = yes
}}


For GNOME 3.22, create the following file:

{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-22.conf|title=Configuration for dantrell-gnome-3-22 repo|1=
[dantrell-gnome-3-22]

# Dantrell B.'s Gentoo Overlay for GNOME (3.22)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd

location = /usr/local/portage/dantrell-gnome-3-22
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-22.git
priority = 100
auto-sync = yes
}}

Next, if you haven't already got it on your system, install [[git]]:
{{RootCmd
|emerge --ask --verbose --noreplace dev-vcs/git
}}

Then sync everything:
{{RootCmd
|emaint sync -a
}}

=== Setting the Profile, and Updating ===

Dantrell's overlays provide a bundled set of [[Profile|profiles]]. By [https://github.com/dantrell/gentoo-project-gnome-without-systemd#profile-selection using one of these], you can conveniently set appropriate USE flags, masks etc., to ensure that installation proceeds smoothly. For any of the GNOME releases (3.14, 3.16, 3.18, 3.20 and 3.22) you can choose a 'standard' or 'extended' profile. The latter have more USE flags enabled by default, to yield a [https://github.com/dantrell/gentoo-project-gnome-without-systemd/blob/master/HACKING.md#profiles similar experience] to the familiar {{c|desktop/gnome}} profiles in Gentoo.

{{Note|Not all of the default USE flags from the Gentoo GNOME profiles are mirrored, even in the 'extended' variants, and indeed some USE flags notable by their absence in Gentoo are enforced. For example:
* {{c|qt3support}} and {{c|qt4}} are enabled by default in Gentoo, but not in any of Dantrell's profiles. Per Dantrell: "The former isn't something that should be enabled upstream, especially since things have moved to qt4 and qt5. Users should decide for themsleves if they want qt3 support. As for the latter, it shouldn't be enabled globally at all in a GNOME environment, especially if {{c|gtkstyle}} is not enforced (and {{c|gtkstyle}} should be enforced regardless)."
* Following neatly on from that, {{c|gtkstyle}} ''is'' enforced by the Dantrell profiles (but not in Gentoo's).
* {{c|gtk}} is also enabled by default in Gentoo, but not in Dantrell's profiles. Per Dantrell: "this is handled by default and on packages where it's not enabled it likely refers to optional GTK+-related support that does not enable a GUI".
}}

Select an appropriate profile now (at the time of writing, users on the "stable" ({{c|amd64}}) branch are probably safest sticking to one of the 3.14, 3.16, 3.18 or 3.20 profiles (although, for reference, 3.22 ''will'' build under {{c|amd64}}); {{c|~amd64}} users may use whichever they choose):
{{RootCmd
|eselect profile list
|output=
<pre>
  [1]   default/linux/amd64/13.0 *
  [2]   default/linux/amd64/13.0/selinux
  ... additional output suppressed ..
  [23]  dantrell-gnome:default/amd64/3.14
  [24]  dantrell-gnome:default/amd64/3.14/extended
  [25]  dantrell-gnome:default/amd64/3.16
  [26]  dantrell-gnome:default/amd64/3.16/extended
  [27]  dantrell-gnome:default/amd64/3.18
  [28]  dantrell-gnome:default/amd64/3.18/extended
  [29]  dantrell-gnome:default/amd64/3.20
  [30]  dantrell-gnome:default/amd64/3.20/extended
  [31]  dantrell-gnome:default/amd64/3.22
  [32]  dantrell-gnome:default/amd64/3.22/extended
</pre>
}}
(The numbering etc. on the list you see may well differ from the above.)
{{RootCmd
|eselect profile set "dantrell-gnome:default/amd64/3.14/extended"
|eselect profile show
|output=
<pre>
Current /etc/portage/make.profile symlink:
  dantrell-gnome:default/amd64/3.14/extended
</pre>
}}

With your desired profile set, re-emerge {{c|@world}}, to pick up the new USE flags, default packages etc.

{{RootCmd
|emerge --deep --with-bdeps{{=}}y --changed-use --update --ask --verbose @world
}}
{{Important|Please do not skip this step - the subsequent GNOME {{c|emerge}} will probably fail if you do.}}

The various [https://github.com/dantrell/gentoo-project-gnome-without-systemd#dependencies dependencies] for GNOME without {{c|systemd}} are now installed automatically, either as part of the above @world update under the custom profile (e.g., {{Package|sys-apps/dbus}} and {{Package|sys-auth/consolekit}}) or during the {{Package|gnome-base/gnome}} emerge to follow shortly (e.g., {{Package|sys-power/pm-utils}} and {{Package|sys-power/acpid}}); nothing further needs to be emerged at this stage. However, we do need to make sure the various services will come up on boot, and start them:
{{RootCmd
|rc-update add dbus default
|rc-update add consolekit default
|rc
}}

=== Preparing USE Flags Prior to GNOME Emerge ===

If there are any additional applications you would like installed as part of the GNOME emerge, set their USE flags now, [https://github.com/dantrell/gentoo-project-gnome-without-systemd#configuration-optional as follows]:

{| class="table table-striped"
|<code>bijiben</code> || Install the app-misc/bijiben note editor
|-
|<code>boxes</code> || Install the gnome-extra/gnome-boxes remote and virtual system manager
|-
|<code>builder</code> || Install the gnome-extra/gnome-builder IDE (only in GNOME 3.16 or greater)
|-
|<code>california</code> || Install the gnome-extra/california calendar
|-
|<code>epiphany</code> || Install the www-client/epiphany web browser
|-
|<code>evolution</code> || Install the mail-client/evolution mail client
|-
|<code>flashback</code> || Install the gnome-base/gnome-flashback (aka fallback mode)
|-
|<code>fonts</code> || Install media-fonts/{noto,symbola,unifont}
|-
|<code>games</code> || Install Gnome Games
|-
|<code>geary</code> || Install the mail-client/geary mail client
|-
|<code>share</code> || Install the gnome-extra/gnome-user-share personal file sharing tool
|-
|<code>shotwell</code> || Install the media-gfx/shotwell photo manager
|-
|<code>todo</code> || Install the gnome-extra/gnome-builder task manager (only in GNOME 3.18 or greater)
|-
|<code>tracker</code> || Install the app-misc/tracker indexer and the GNOME packages that require it
|}

For example, to add the [[epiphany]] browser to the set of installed applications, do:
{{RootCmd
|mkdir -pv /etc/portage/package.use
|echo "gnome-base/gnome-extra-apps epiphany" >> /etc/portage/package.use/gnome-extra-apps
}}
{{Note|The above assumes that {{Path|/etc/portage/package.use}} is a directory, which is now the default on the Gentoo minimal install image. If using a single file instead, simply append to {{Path|/etc/portage/package.use}} instead of {{Path|/etc/portage/package.use/gnome-extra-apps}} in the above.}}

There are some additional GNOME 'quality of life' improvements in Dantrell's patchset (background resolution etc.), which are controlled by USE flags on certain packages. The defaults will probably be suitable for most users, but for more details please see [https://github.com/dantrell/gentoo-project-gnome-without-systemd#configuration-optional here].

=== Emerging GNOME ===

Right, we are now ready to {{c|emerge}} GNOME! To do so, issue:

{{RootCmd
|emerge --ask --verbose --keep-going gnome-base/gnome
}}

{{Important|If you are using any {{c|MAKEOPTS}} and/or {{c|EMERGE_DEFAULT_OPTS}} build parallelism, it is quite possible that one or more elements of this large {{c|emerge}} will fail. If that occurs, in the first instance, simply issue the {{RootCmd|emerge --ask --verbose --keep-going gnome-base/gnome}} again. You may need to repeat this step multiple times to get GNOME emerged successfully (I have found three or four iterations may be necessary). As long as the 'packages to be installed' count keeps falling, keep trying ^-^}}

{{Note|If desired, you can {{c|emerge}} {{Package|gnome-base/gnome-light}} instead, and then add applications later.}}

Assuming that completes successfully, '''you should still check that the necessary X11 drivers have been properly emerged''': often, they will not have been, particularly if you had to run the {{c|emerge}} step more than once (due to build parallelism errors). To make sure, issue:
{{RootCmd
|emerge --ask --verbose --oneshot x11-base/xorg-drivers
}}

{{Note|If you are using [[VirtualBox]], please note that [https://forums.gentoo.org/viewtopic-p-7719728.html#7719728 you may need to upgrade] your version of {{Package|sys-devel/gcc}} (to a 'non-stable' variant, possibly) in order to compile {{Package|x11-drivers/xf86-video-virtualbox}}. If the above {{c|emerge}} of {{Package|x11-base/xorg-drivers}} failed, give this a shot.<br>As suggested earlier, you can also try using <code>VIDEO_CARDS{{=}}"vesa"</code> just to get things going initially.}}

== Configuring and Running GNOME ==

Once GNOME is emerged, you need to change the {{c|DISPLAYMANGER}} value in the {{c|xdm}} configuration file ({{Path|/etc/conf.d/xdm}}), so that the [[GNOME/gdm|gdm]] display manager is used:

{{FileBox|filename=/etc/conf.d/xdm|title=Specify the GNOME display manager, as follows|1=
# What display manager do you use ?  [ xdm {{!}} gdm {{!}} kdm {{!}} gpe {{!}} entrance ]
# NOTE: If this is set in /etc/rc.conf, that setting will override this one.
DISPLAYMANAGER{{=}}"gdm"
}}

Then set {{c|acpid}}, {{c|xdm}} and {{c|[[NetworkManager]]}} to come up on boot, and disable {{c|[[dhcpcd]]}} if you are using it:
{{RootCmd
|rc-update add acpid default
|rc-update add xdm default
|rc-update add NetworkManager default
|rc-update del dhcpcd default
}}

Check if your machine has a plugdev group, and, if it does, add any regular users to it:
{{RootCmd
|getent group plugdev && gpasswd -a <yourusername> plugdev
}}

Start up GNOME!
{{RootCmd
|rc
}}

You should now have a GNOME login screen visible (and this will also come up automatically on boot). On some machines, you may need to move the mouse or press a key, for the login screen to appear. 

Have fun!

== Using GNOME ==

For more information about the GNOME interface (which is generally self-explanatory), see https://gnome.org.
Some additional useful setup tips about GNOME may also be found [[Sakaki's_EFI_Install_Guide/Using_Your_New_Gentoo_System#Miscellaneous_GNOME_Points|here]].

== See also ==

* [[Project:GNOME|Gentoo GNOME Project]]
* [[GNOME/gdm|GNOME Display Manager]]
* [[Sakaki's_EFI_Install_Guide|Sakaki's EFI Install Guide]]

== External resources ==

* [https://github.com/dantrell/gentoo-project-gnome-without-systemd Dantrell B.'s project homepage on GitHub]

[[category:GNOME]]
