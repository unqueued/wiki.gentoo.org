<languages />

{{Lowercase title}}
{{InfoBox stack
|{{InfoBox project|Genkernel|header=true}}
|{{InfoBox package|sys-kernel/genkernel}}
|{{InfoBox wikipedia}}
|{{InfoBox gitweb|genkernel.git}}
|{{InfoBox github|gentoo/genkernel}}
}}

{{c|genkernel}} es una herramienta creada por Gentoo que se utiliza para automatizar el proceso de construcción del [[kernel/es|núcleo]] e [[initramfs]]. Algunas de las características generales incluyen:

* Configurar los ficheros fuente del núcleo.
* Construir el núcleo comprimido {{Path|bzImage}} y copiarlo a {{Path|/boot}}.
* Crear un initramfs y copiarlo a {{Path|/boot}}.
* Crear enlaces simbólicos en {{Path|/boot}}.
* Añadir código del usuario al initramfs tal como ficheros de cifrado, imágenes de inicio (spla.github.io/sh), módulos añadidos y demás.
* Comprimir el initramfs.
* Configurar el [[bootloader|Gestor de arranque]] para arrancar el núcleo e initramfs recientemente creados.

{{Note|Un malentendido común es creer que {{c|genkernel}} generará 'automaticamente' una configuración personalizada del núcleo. {{c|genkernel}} automatiza el proceso de construcción del núcleo y construye el initramfs, sin embargo ''no'' genera un fichero personalizado de configuración del núcleo. Utiliza un fichero genérico de configuración del núcleo que ofrece soporte para subsistemas utilizados comúnmente basándose en una arquitectura específica. Los detalles se pueden consultar en el [https://gitweb.gentoo.org/proj/genkernel.git/tree/arch repositorio del proyecto]. Seleccionar la arquitectura y a continuación el fichero de configuración del núcleo.}}

== Instalación ==

=== Ajustes USE ===

{{USEflag|package=sys-kernel/genkernel}}

=== Emerge ===

Lance la instalación de genkernel:

{{Emerge|sys-kernel/genkernel}}

== Utilización == 

La forma general de invocar a genkernel se muestra a continuación:

{{RootCmd|genkernel [opciones ...] acción}}

=== Opciones === 

El comportamiento actual de genkernel depende de un gran número de opciones, la mayoría de las cuales se pueden activar o desactivar en el fichero {{Path|/etc/genkernel.conf}} o pasarse a través de la orden {{c|genkernel}} en cada invocación. La opciones que se pasan como parámetros a la orden son preferentes a las definidas en {{Path|/etc/genkernel.conf}}. El fichero de configuración está muy bien documentado, sin embargo, algunas de las opciones más usadas se explorarán en este artículo. El objetivo es que el lector se familiarice con las invocaciones comunes de genkernel. Para obtener explicaciones más completas, lea los comentarios en el propio fichero {{Path|/etc/genkernel.conf}} o la salida de la orden {{c|man genkernel}}.

{{Note|Algunas de las opciones tienen una variante que desencadena un comportamiento contrario. Se define como <code>--[no-]nombre_de_opción</code>, y este comportamiento se muestra entre corchetes tal y como se ve en el siguiente ejemplo:
{{CodeBox|title=Habilita o deshabilita cierta opción|1=
--[no-]menuconfig : Activa [Desactiva] ...
}}
Allí donde las opciones tengan únicamente un efecto negativo, el <code>no-</code> y su efecto, que no son opcionales en este caso, se muestran sin corchetes.
}}

==== Opciones que actúan en la interactividad del usuario ====

Las opciones de configuración listadas abajo ayudan al usuario a decidir cómo interaccionar con el proceso de configuración. Los usuarios pueden incluso escoger si el archivo de configuración creado en el proceso se debería guardar o no. La siguientes opciones de configuración se consideran principales:

; <code>--config=/ruta/a/genkernel.conf</code>
: Apunta al fichero de configuración de Genkernel que se utilizará (por defecto es {{Path|/etc/genkernel.conf}}).
; <code>--[no-]menuconfig</code>
: Activa (o desactiva) la orden {{c|make menuconfig}} (la cual invoca un menú para la configuración interactiva) antes de construir el núcleo.
; <code>--gconfig</code>
: Ofrece una utilidad de configuración que depende de las librerias GTK+. La ventaja de esta opción es que a la mayoría de los usuarios les parece más fácil y limpio usar esta herramienta ya que se apoya en el sistema de ventanas X. La desventaja de utilizar esta opción es que se necesita el sistema de ventanas X para usarla por lo que no funcionará desde la línea de órdenes.
; <code>--xconfig</code>
: Ofrece una utilidad de configuración del núcleo que depende de las librerías QT. La ventaja de esta opción es que la mayoría de los usuarios encontrarán más fácil y claro configurar el núcleo utilizando esta herramienta ya que se apoya en el sistema de ventanas X. La desventaja de esta opción es que se necesita el sistema X para utilizarla de modo que no funcionará en la línea de órdenes.
; <code>--[no-]save-config</code>
: Guarda [o no] la configuración del núcleo en un fichero dentro del directorio {{Path|/etc/kernels}} para su posterior utilización.
; <code>--kernname=NombreCorto</code>
: Permite la modificación del nombre del núcleo e imágenes initrd en el directorio {{Path|/boot}} de modo que las imágenes producidas se llaman {{Path|kernel-NombreCorto-versión}} e {{Path|initramfs-NombreCorto-versión}}.

==== Opciones que afectan al sistema resultante ====

Las opciones de configuración mostradas aquí, definen qué características podrán ser o no se activadas en el núcleo e initrd resultantes.

; <code>--[no-]splash</code>
: Activa (o desactiva) el soporte del framebuffer splash [[Fbsplash]] en la imagen initrd construida para el núcleo. Para utilizar un tema distinto del que se ofrece por defecto por fbsplash, utilice <code>--splash=TemaPreferido</code> (donde <code>TemaPreferido</code> es el título de uno de los directorios dentro del directorio {{Path|/etc/splash}}).
; <code>--splash-res=ResoluciónPreferida</code>
: Esta opción permite seleccionar qué resoluciones de pantallas para splash se ofrecerán durante el arranque del sistema. Esto es útil por dos razones. En primer lugar se puede seleccionar únicamente la resolución o resoluciones de pantalla relevantes para el sistema. En segundo lugar se puede evitar el incremento innecesario del espacio en disco que se initrd necesita (ya que la imagen initrd no ofrece soporte para las resoluciones que no son relevantes para la configuración del sistema). Sin embargo, esta opción se omite en mejores situaciones, por ejemplo cuando se construye un núcleo para un CD de instalación, esto permite soporte de splash para todas las resoluciones posibles.
; <code>--do-keymap-auto</code>
: Forzar las selección del mapa del teclado durante el arranque.
; <code>--lvm</code>
: Incluye soporte para almacenamiento mediante [http://sources.redhat.com/lvm2/ gestión de volúmenes lógicos] (LVM2) desde binarios estáticos si están disponibles en el sistema. Los binarios (estáticos) relevantes LVM2 se compilan si no están disponibles. Asegúrese de instalar el paquete {{Package|sys-fs/lvm2}} en el sistema ({{c|emerge sys-fs/lvm2}}) antes de habilitar esta opción, luego eche un vistazo al  [[LVM/es | artículo sobre LVM]] en el wiki de Gentoo.
; <code>--dmraid</code>
: Incluye soporte para DMRAID, la utilidad que crea mapeos RAID utilizando el subsistema de mapeo de dispositivos del núcleo. [http://people.redhat.com/~heinzm/sw/dmraid/readme DMRAID] descubre, activa, desactiva y muestra las propiedades de conjuntos de software RAID (por ejemplo ATARAID) y particiones DOS contenidas.
; <code>--luks</code>
: Incluye soporte para la configuración de clave unificada Linux o [https://gitlab.com/cryptsetup/cryptsetup LUKS]. Esto permite utilizar un dispositivo cifrado por LUKS que contiene el sistema de ficheros. En el cargador de arranque, se configura un dispositivo cifrado en el valor de <code>crypt_root</code> (y <code>root</code> debería ser el dispositivo no cifrado que crea LUKS).
; <code>--disklabel</code>
: Añade soporte para etiquetas de discos y UUID support en la imagen initrd.
; <code>--iscsi</code>
: Añade soporte para iSCSI en la imagen initrd.
; <code>--multipath</code>
: Añade soporte para [[Multipath]] a la imagen initrd.
; <code>--linuxrc=/ruta/al/fichero/linuxrc</code>
: Especifica un archivo linuxrc creado por el usuario, un guión que se inicializa durante la fase de inicialización del núcleo antes de la propia fase de arranque. Se puede encontar un guión linuxrc por defecto en el directorio {{Path|/usr/share/genkernel/}}. Este guión permite iniciar en un pequeño núcleo modular que intentará cargar la menor cantidad de controladores (como módulos) necesitados por el sistema.
; <code>--cachedir=/ruta/al/directorio/alternativo</code>
: Cambia la localización por defecto de la caché que se utiliza cuando se construye el núcleo.
; <code>--tempdir=/ruta/al/nuevo/directoriotemporal</code>
: Especifica la localización del directorio temporal utilizado por genkernel durante la construcción del núcleo.
; <code>--unionfs</code>
: Incluye soporte para el  [http://www.fsl.cs.sunysb.edu/project-unionfs.html sistema de ficheros de unificación] en la imagen initrd.
; <code>--mountboot</code>
: Detecta si se necesita montar o no el directorio {{Path|/boot}} en una partición separada. Buscará instrucciones acerca de cómo montar la partición de inicio en un sistema de ficheros en el guión {{Path|/etc/fstab}} (si es necesario).

==== Opciones que actúan en la elección de las herramientas utilizadas para la construcción ====

Las siguientes opciones están soportadas por genkernel y se pasan a las aplicaciones relevantes mientras se ensambla el núcleo. Estas opciones afectan a las herramientas de compilación utilizadas en el proceso de compilación del núcleo aunque a un nivel mucho más bajo.

; <code>--kernel-cc=algúnCompilador</code>
: Especifica el compilador que se utilizará en el proceso de construcción del núcleo.
; <code>--kernel-ld=algúnEnlazador</code>
: Especifica el enlazador que se utilizará en el proceso de construcción del núcleo.
; <code>--kernel-as=algúnEnsamblador</code>
: Especifica el ensamblador que se utilizará en el proceso de construcción del núcleo.
; <code>--kernel-make=algúnMake</code>
: Especifica la utilidad alternativa a make de GNU que se utilizará en el proceso de construcción del núcleo.
; <code>--utils-cc=algúnCompilador</code>
: Especifica el compilador que se utilizará en el proceso de construcción de las utilidades de soporte.
; <code>--utils-ld=algúnEnlazador</code>
: Especifica el enlazador que se utilizará en el proceso de construcción de las utilidades de soporte.
; <code>--utils-as=algúnEnsamblador</code>
: Especifica el ensamblador que se utilizará en el proceso de construcción de las utilidades de soporte.
; <code>--utils-make=algúnMake</code>
: Especifica una herramienta alternativa a make de GNU que se utilizará en el proceso de construcción de las utilidades de soporte.
; <code>--makeopts=-jX</code>
: Especifica el número de hilos de ejecución concurrentes que la utilidad make puede implementar cuando se construya el núcleo (y las utilidades). La variable <code>X</code> es un número que se elige libremente aunque los valores más comunes se obtienen añadiendo uno (1) al número de núcleos (cores) utilizados por el sistema o simplemente el número de núcleos del sistema. Por ejemplo, para un sistema con un único núcleo los valores más comunes para esta opción son <code>-j2</code> o <code>-j1</code>. Un sistema con dos núcleos seguramente utilizará las opciones <code>-j3</code> o <code>-j2</code> y así sucesivamente. (Puede asumirse que un sistema con un procesador que ofrezca soporte para la tecnología Hyper-Threading™ (HT) tiene dos núcleos asumiendo que se se ha activado la tecnología Symmetric Multi-Processing (SMP) en el núcleo).

==== Opciones que actúan en el proceso de compilación ====

Las siguientes opciones normalmente actúan durante el proceso de compilación:

; <code>--kerneldir=/camino/a/los/fuentes/</code>
: Especifica una localización alternativa a los fuentes del núcleo en lugar de la localización por defecto {{Path|/usr/src/linux/}}.
; <code>--kernel-config=/camino/al/fichero-de-configuración</code>
: Especifica qué configuración alternativa del núcleo se utilizará en lugar del fichero por defecto {{Path|/camino/a/los/fuentes/.config}}.
; <code>--module-prefix=/camino/al/directorio-prefijo/</code>
: Especifica un prefijo para el directorio en el que se instalarán los módulos del núcleo (el camino por defecto es el directorio {{Path|/lib/modules}}).
; <code>--[no-]clean</code>
: Activa (o desactiva) la ejecución de la orden {{c|make clean}} antes de construir el núcleo. La orden {{c|make clean}} elimina todos los ficheros objeto y sus dependencias del árbol de fuentes del núcleo.
; <code>--[no-]mrproper</code>
: Activa (o desactiva) la ejecución de la orden {{c|make mrproper}} antes de la construcción del núcleo. Al igual que la orden {{c|make clean}} indicada arriba, {{c|make mrproper}} elimina todos los ficheros objeto y sus dependencias del árbol de fuentes del núcleo. También se eliminará cualquier fichero de configuración (en {{Path|/camino/a/los/fuentes/.config}} o {{Path|/camino/a/los/fuentes/.config.old}}) del árbol de fuentes del núcleo. Si no se desea que el fichero {{Path|.config}} de configuración del núcleo desaparezca. ¡Asegúrese de deshabilitar esta opción!
<code>--oldconfig</code>
: Lanza la orden {{c|make oldconfig}} que intenta recolectar información de configuración para la arquitectura del sistema desde un guión genérico en {{Path|/usr/share/genkernel}}. Este es un proceso no interactivo process, no se precisa intervención por parte del usuario. Si se utiliza <code>--oldconfig</code> junto con <code>--clean</code>, la segunda opción se niega resultando en la activación de la opción <code>--no-clean</code>.
; <code>--callback="echo hola"</code>
: Invoca a los argumentos especificados (en este caso, {{c|echo hola}}) una vez se han construido el núcleo y los módulos relevantes pero antes de construir la imagen initrd. Esto puede ser de utilidad cuando se instalan módulos externos en la imagen initrd haciendo emerge del elemento o elementos relevantes con la característica callback y redefiniendo un grupo de módulos genkernel a continuación.
; <code>--[no-]install</code>
: Activa (o desactiva) la orden {{c|make install}} la cual instala la nueva imagen del núcleo, el fichero de configuración, la imagen initrd y el mapa del sistema en la partición de incio. Se instalarán también cualesquiera módulos se hayan construido. Por defecto, genkernel intentará montar {{Path|/boot}} si está en una partición separada antes de lanzar la orden de instalación.
; <code>--no-ramdisk-modules</code>
: Evita copiar cualquier módulo a la imagen initrd creada por genkernel. Esta opción es una excepción a la regla acerca del prefijo <code>no-</code>. La omisión de este prefijo genera una opción inválida de genkernel.
; <code>--all-ramdisk-modules</code>
: Copia todos los módulos disponibles a la imagen initrd creada por genkernel.
; <code>--genzimage</code>
: Crea la imagen initrd, previa a la imagen del núcleo (actulamente este truco se aplica únicamente a sistemas PPC Pegasos).

==== Opciones de depuración ====

El uso de opciones de depuración durante el proceso de construcción del núcleo controla la cantidad de información que se muestra, así como la presentación de esta información.

; <code>--loglevel=<nowiki><0|1|2|3|4|5></nowiki></code>
: Controla el nivel de detalle que se ofrece en la información facilitada por genkernel. La variable <code>&lt;niveldedetalle&gt;</code> es un entero entre cero y cinco. El nivel '0' representa una salida mínima, mientras que el nivel '5' ofrece la mayor cantidad de información posible sobre las actividades que realiza genkernel durante el proceso de construcción del núcleo.
; <code>--logfile=/camino/al/fichero-de-salida</code>
: Ignora el valor definido con la opción arriba descrita: <code>--loglevel</code> y envía toda la información de depuración producida por genkernel al fichero de salida especificado. La salida se envía por defecto al archivo {{Path|/var/log/genkernel.log }}.
; <code>--[no-]color</code>
: Activa (o desactiva) la coloración de la salida de la información de depuración  (informada por genkernel) utilizando secuencias escape.
; <code>--[no-]debug-cleanup</code>
: Activa (o desactiva) la limpieza completa después de una ejecución para usarla en tareas de depuración.

=== Acciones ===

Una acción enviada a genkernel en la línea de comandos mediante {{¢|genkernel [opciones …] ''acción''}}, le indica a genkernel qué acción debe realizar. Se ofrecen las siguientes acciones:

{| class="table table-condensed"
|-
! scope="col" width="25%" | Acción !! Descripción
|-
| {{c|all}} || Construye todas las fases, el initrd, la imagen del núcleo y los módulos.
|-
| {{c|bzImage}} || Únicamente construye la imagen del núcleo.
|-
| {{c|kernel}} || Únicamente construye la imagen del núcleo y los módulos.
|-
| {{c|initramfs}} || Únicamente construye la imagen initramfs/ramdisk.
|-
| {{c|ramdisk}} || Únicamente construye la imagen initramfs/ramdisk.
|}

== Configuración ==

=== Comenzar ===

Aunque hay varias formas de lanzar genkernel, el enfoque menos intrusivo y recomendado para la mayoría de los usuarios es mediante {{c|genkernel all}}. En este caso se utiliza una configuración genérica que funciona bien en la mayoría de los sistemas. Tal como se mencionaba arriba, este enfoque presenta ciertas desventajas pues la mayor parte de los módulos creados no son útiles para el usuario promedio y puede incrementar el tiempo de compilación. Abajo se muestra un ejemplo de un enfoque más eficiente el cual se logra al pasar ciertos parámetros a genkernel cuando se lanza con el usuario root:

{{RootCmd|genkernel --splash --no-install --no-clean --menuconfig all}}

La operación descrita arriba provoca que genkernel cree un núcleo con pantalla una pantalla de bienvenida (<code>--splash</code>) que se deberá instalar de forma manual (<code>--no-install</code>). Mientras se prepara el árbol de fuentes del núcleo, genkernel evitará eliminar cualquiera de los archivos objeto preexistentes en el árbol de los fuentes (<code>--no-clean</code>). Se ofrecerá al usuario una herramienta de configuración basada en menús para seleccionar qué módulos se construirán en el sistema (<code>--menuconfig</code>).

Si se reemplaza la opción <code>--no-install</code> por <code>--install</code> se le indicará a genkernel que instale el nuevo núcleo en el directorio {{Path|/boot}} de forma automática y se crearán los enlaces simbólicos se se especifica <code>--symlink</code>. El uso de la opción <code>--mountboot</code> le indica a genkernel que monte la partición {{Path|/boot}} de forma automática si es necesario.

{{Note/es|No olvide que '''genkernel''' lanza el fichero de órdenes {{Path|/etc/genkernel.conf}} al comienzo de la construcción, y que cualquier opción definida en él se aplicará excepto cuando se define una opción de línea de órdenes que toma preferencia respecto a la misma opción definida en el fichero anterior.}}

=== Cambiar el núcleo ===

Lo primero que se debe hacer es permitir que se lance {{c|make menuconfig}} en el fichero {{Path|/etc/genkernel.conf}}:

{{FileBox|filename=/etc/genkernel.conf|title=Forzar el uso del menú de configuración en /etc/genkernel.conf|lang=bash|1=
# ¿Se lanza 'make menuconfig' antes de compilar este núcleo?
MENUCONFIG="yes"
}}

==== Gestión de ficheros ====

Mientras utiliza genkernel, debe tener en cuenta varios aspectos relacionados con su configuración y los ficheros de imagen del núcleo así como la forma en la que el sistema gestiona los fichero fuente del núcleo.

===== Ficheros fuente =====

Después de lanzar la orden {{c|emerge -u gentoo-sources}}, siempre que los nuevos fuentes estén disponibles, se creará un nuevo directorio de ficheros fuente del núcleo en {{Path|/usr/src/}} para almacenarlos. Normalmente los fuentes activos del núcleo se definen con el enlace simbólico {{Path|/usr/src/linux}}.

El directorio {{Path|/usr/src}} debería un aspecto similar a este:

{{Cmd|ls -l /usr/src|output=<pre>
total 16
lrwxrwxrwx  1 root root   19 21 mar  2013  linux -> linux-3.7.10-gentoo
drwxr-xr-x 24 root root 4096 25 ago  10:39 linux-3.10.7-gentoo
drwxr-xr-x 20 root root 4096 21 abr  19:42 linux-3.7.10-gentoo
drwxr-xr-x 21 root root 4096 14 mar  2013  linux-3.7.9-gentoo
 </pre>}}

El enlace simbólico {{Path|/usr/src/linux}} se puede cambiar de diferentes formas: 

* Si el ajuste USE <code>symlink</code> está definido, el enlace simbólico {{Path|/usr/src/linux}} se actualiza automáticamente para que apunte al los nuevos ficheros fuente instalados. 

* Si el ajuste USE <code>symlink</code> ''no'' está definido, el usuario puede cambiar el destino del enlaces simbólico utilizando {{c|eselect kernel list}} seguido de la orden {{c|eselect kernel set}}.

Genkernel utilizará ''siempre'' (exclusivamente) los fuentes a lo que apunta el enlace simbólico {{Path|/usr/src/linux}}.

===== Fichero de configuración del núcleo =====

Si ya se ha realizado una construcción del núcleo con los fuentes activos, debería aparecer un fichero dentro del directorio {{Path|/etc/kernels}} que contiene al configuración del núcleo que se ha aplicado mientras se creó la última bzimage del núcleo. Este fichero se llama, por ejemplo, {{Path|kernel-config-x86_64-3.7.9-gentoo-r1}} donde <code>x86_64</code> sería el nombre de la arquitectura del sistema, <code>3.7.9</code> sería la versión de los ficheros fuente utilizados, y <code>r1</code> la revisión de los fuentes.

Es este fichero {{Path|kernel-config-x86_64-3.7.9-gentoo-r1}} el que se utiliza como configuración cuando se lanza {{c|genkernel --menuconfig all}}.

Si es la primera vez que se lanza genkernel con los nuevos fuentes del núcleo o si no se ha guardado el resultado previo este fichero se sustituye por un fichero de configuración por defecto que se encuentra en {{Path|usr/share/genkernel/arch/x86_64/kernel-config}} donde hay que sustituir x86_64 por la arquitectura en la que se está trabajando.

{{Note/es|La ruta a este fichero de configuración por defecto se puede alterar definiendo la variable <var>DEFAULT_KERNEL_CONFIG</var> en el fichero {{Path|/etc/genkernel.conf}}.}}

===== Guardar la configuración compilada =====

Si se activa la opción <code>save-config</code> de genkernel, bien desde la línea de órdenes, bien dentro de {{Path|/etc/genkernel.conf}}, la configuración del núcleo que se ha compilado se guardará (con el nombre indicado arriba) en el directorio {{Path|/etc/kernels}}. Al mismo tiempo, la configuración se guarda en el fichero {{Path|.config}} dentro del directorio {{Path|/usr/src/linux}}, sin embargo, este fichero no se reutilizará en la siguiente ejecución de {{c|genkernel all}}.

{{Warning/es|Se debe tener cuidado: Cada vez que se lanza genkernel con la opción <code>save-config</code> activada, el fichero de configuración en {{Path|/etc/kernels}} se sobrescribe. Así, se recomienda guardar este fichero con un nuevo nombre ''antes'' de lanzar genkernel para conservarlo.}}

===== Instalar el núcleo y el initramfs en el directorio {{Path|/boot}} =====

Si se especifica la opción <code>--install</code> cuando se lanza genkernel, se le pedirá a <kbd>genkernel</kbd> que instale la imagen del núcleo y el initramfs en el directorio {{Path|/boot}}. Para lanzar <code>--install</code> de una forma correcta, defina lo siguiente en el fichero {{Path|/etc/genkernel.conf}}:

{{FileBox|filename=/etc/genkernel.conf|title=Configurar el guardado automico del núcleo y el initramfs|lang=bash|1=
# ¿Montar BOOTDIR de forma automática si no está montado?
MOUNTBOOT="yes"

# Guardar la nueva configuración en /etc/kernels
# después de una compilación exitosa
SAVE_CONFIG="yes"

# ¿Crear enlaces simbólicos en  BOOTDIR de forma automática?
SYMLINK="yes"

# ¿Añadir el nuevo núcleo a grub2?
#BOOTLOADER="grub2"
}}

* El primer parámetro no requiere explicación.

* El segundo parámetro le indica a  genkernel que guarde la configuración del núcleo que se ha compilado en {{Path|/etc/kernels}}.

* Las dos últimas opciones le indican a genkernel que actualice automáticamente la configuración de grub. En la práctica sucede lo siguiente:
** Si existe una imagen previa del núcleo con el mismo nombre, se modifica su nombre añadiendo {{Path|.old}}. Un enlace simbólico {{Path|kernel.old}} se crea automáticamente apuntando a ella.
** El nuevo núcleo toma el lugar de cualquier núcleo con el mismo nombre dentro de {{Path|/boot}}. Si es la primera vez que se compila un núcleo, se crea automáticamente un enlaces simbólico que apunta al nuevo núcleo.

Después de lanzar {{c|genkernel --menuconfig all}}, el directorio {{Path|/boot}} tendrá un aspecto similar al siguiente:

{{Cmd|ls -al /boot|output=<pre>
total 41336
drwxr-xr-x  3 root root    4096 20 abril 17:23 .
drwxr-xr-x 24 root root    4096 15 sept. 12:31 ..
lrwxrwxrwx  1 root root       1 24 febr. 2013  boot -> .
drwxr-xr-x  2 root root    4096 24 febr. 2013  grub
lrwxrwxrwx  1 root root      40 20 abril 17:23 initramfs -> initramfs-genkernel-x86_64-3.7.10-gentoo
-rw-r--r--  1 root root 1314412 20 abril 17:23 initramfs-genkernel-x86_64-3.7.10-gentoo
-rw-r--r--  1 root root 1313548 21 marzo 2013  initramfs-genkernel-x86_64-3.7.10-gentoo.old
-rw-r--r--  1 root root 1295344 25 febr. 2013  initramfs-genkernel-x86_64-3.7.9-gentoo
-rw-r--r--  1 root root 3310324 25 febr. 2013  initramfs-genkernel-x86_64-3.7.9-gentoo.old
lrwxrwxrwx  1 root root      44 20 abril 17:23 initramfs.old -> initramfs-genkernel-x86_64-3.7.10-gentoo.old
lrwxrwxrwx  1 root root      37 20 abril 17:23 kernel -> kernel-genkernel-x86_64-3.7.10-gentoo
-rw-r--r--  1 root root 4866656 20 abril 17:23 kernel-genkernel-x86_64-3.7.10-gentoo
-rw-r--r--  1 root root 4866560 21 marzo 2013  kernel-genkernel-x86_64-3.7.10-gentoo.old
-rw-r--r--  1 root root 4552288 25 febr. 2013  kernel-genkernel-x86_64-3.7.9-gentoo
-rw-r--r--  1 root root 3400736 25 febr. 2013  kernel-genkernel-x86_64-3.7.9-gentoo.old
lrwxrwxrwx  1 root root      41 20 abril 17:23 kernel.old -> kernel-genkernel-x86_64-3.7.10-gentoo.old
</pre>}}

==== Configurar el gestor de arranque ====

Los enlaces simbólicos que se muestran arriba en la configuración del gestor de arranque se pueden utilizar tal cual, incluso cuando el núcleo no se puede arrancar, el usuario siempre podrá arrancar el antiguo. 

Para permitir que el núcleo y el initrd ofrecido por genkernel funcione correctamente, deberá ofrecer a su gestor de arranque una información mínima en el fichero de configuración:

* Añadir <code>real_root=/dev/sdaN</code>, a los parámetros del núcleo que se pasan a la imagen, donde {{Path|/dev/sdaN}} apunta a la partición raíz (<code>N</code> es el número de partición si ésta existe).
* Si está utilizando la pantalla de presentación de arranque (splash), se debe añadir una línea moda adecuada, como por ejemplo pasar <code>vga=0x317</code> a los parámetros del núcleo y también <code>splash=verbose</code> o <code>splash=silent</code> dependiendo del nivel de detalle que desee a lo largo del proceso de arranque.
* Añadir la información sobre initrd que requiera la configuración del gestor de arranque. Consulte el [[Handbook:X86/Installation/Bootloader/es|capítulo de configuración del cargador de arranque]] del manual de Gentoo para obtener detallas sobre la configuración del gestor de arranque con initrd.

A continuación se muestra un ejemplo del aspecto que debería tener el fichero {{Path|grub.conf}}.

{{FileBox|filename=/boot/grub/grub.conf|title=Un fichero ejemplo grub.conf|lang=bash|1=
# Esto es un fichero ejemplo de grub.conf para usar con Genkernel según el manual de Gentoo
# http://www.gentoo.org/doc/es/handbook/handbook-x86.xml?part=1&chap=10#doc_chap2
# Si no está usando Genkernel y necesita ayuda para crear este fichero
# debería consultar el manual. De forma alternativa, consulte el fichero grub.conf.sample
# que se incluye en la documentación de Grub.

default 0
timeout 5
splashimage=(hd1,0)/boot/grub/splash.xpm.gz

title Gentoo Linux
root (hd0,6)
kernel /boot/kernel initrd=/dev/ram0 root=/dev/sda7 rootfstype=ext4
initrd /boot/initramfs

title Gentoo Linux old kernel
root (hd0,6)
kernel /boot/kernel.old initrd=/dev/ram0 root=/dev/sda7 rootfstype=ext4
initrd /boot/initramfs.old
}}

==== Conservar los ficheros de trabajo ====

La aplicación genkernel guarda automáticamente los cambios realizados en los ficheros. Si se necesita conservar cambios realizados anteriormente se deberán realizar las siguientes acciones.

* El primer fichero a conservar es la configuración del núcleo en {{Path|/etc/kernels/}}. Si los ficheros fuente no han cambiado antes de la reconstrucción del núcleo, se usará el nombre utilizado anteriormente para este fichero. Por lo que si se copia la configuración anterior a un nuevo nombre, se podrá conservar la información para utilizar este fichero como punto de partida para una nueva configuración.

* El segundo aspecto importante es conservar las imágenes del núcleo e initramfs que arrancan correctamente. La forma de realizar esto depende del contexto:
:# Si el último núcleo que se construyó arranca correctamente, al lanzar {{c|genkernel}} se cambiará el nombre a la imagen este núcleo (y de igual forma al initramfs) a {{Path|kernel-genkernel-ARCH-X.Y.Z-gentoo-rx.old}} y se creará un nuevo {{Path|kernel-genkernel-ARCH-X.Y.Z-gentoo-rx}}. Esto implica que, en caso de que el nuevo núcleo no arranque, los usuarios siempre podrán arrancar con el antiguo.
:# Si el último núcleo que se construyó no arranca y los ficheros fuente no han cambiado desde que el usuario construyó un nuevo núcleo, antes de lanzar {{c|genkernel}}, se deberá eliminar la nueva imagen del núcleo y quitar el sufijo {{Path|.old}} del último núcleo que arrancara. Si no se hace esto y el nuevo núcleo construido no arranca en la segunda ocasión, el núcleo arrancable {{Path|kernel-genkernel-ARCH-X.Y.Z-gentoo-rx.old}} será sustituido por el núcleo {{Path|kernel-genkernel-ARCH-X.Y.Z-gentoo-rx}} que no arranca, por lo que usuario no podrá arrancar su sistema. Para initramfs se emplea el mismo razonamiento.

==== Utilizar el núcleo anterior mientras se cambian los ficheros fuente ====

Se puede utilizar la configuración anterior mediante la variable <var>MENUCONFIG</var> en {{Path|/etc/genkernel.conf}} tal y como se indica a continuación:

{{FileBox|filename=/etc/genkernel.conf|title=Configurar make menuconfig|lang=bash|1=
# ¿Lanzar 'make menuconfig' antes de compilar este núcleo?
MENUCONFIG="yes"
}}

{{Note/es|No es necesario lanzar {{c|make oldconfig}} cuando se utiliza {{c|genkernel}} incluso si se han cambiado los ficheros fuente de {{Path|kernel-genkernel-ARCH-version-gentoo-rx}} a {{Path|kernel-genkernel-ARCH-version-gentoo-r(x+1)}} o de {{Path|kernel-genkernel-ARCH-version-gentoo}} a {{Path|kernel-genkernel-ARCH-(version+1)-gentoo}}. Esto es debido a que {{c|make menuconfig}} intentará cargar la configuración anterior en el menú tanto como le sea posible. Se recomienda sin embargo revisar cada nueva sección y sus opciones.}}

=== Arranque desde la red ===

==== Desde un CD de instalación ====

La utilidad {{c|genkernel}} puede construir el núcleo y las imágenes initrd que ofrecen soporte para arranque por red netbooting. Con un poco de suerte, los usuarios deberían poder arrancar desde la red con cualquier ordenador reciente dentro del entorno que ofrece el CD de instalación.

La magia está en el guión linuxrc de genkernel: Este intentará montar el CD de instalación en la red (netmount) usando NFS. A partir de aquí los guiones de inicio del CD de instalación pueden tomar el control como si el CD estuviera presente localmente.

==== Construir el núcleo e initramfs con soporte para arranque desde la red ====

Para habilitar el soporte de arranque por red, incluya las siguientes opciones mientras configura su núcleo:

{{Warning/es|El soporte para arranque por red con genkernel es experimental y puede presentar problemas.}}

En primer lugar, la imagen del núcleo debe incluir los controladores para las tarjetas de interfaz de red (NIC) del sistema. Normalmente, los controladores para estos
dispositivos se compilarán como módulos. Sin embargo, es esencial (para el arranque por red) tener dichos controladores compilados directamente en la imagen del núcleo y no como módulos.

{{KernelBox|title=Configurar un núcleo de la serie 3.x.x para ofrecer soporte a distintos controldores de NIC|<pre>
Device Drivers --->
   Networking Support --->
      Ethernet (10 or 100Mbit)  --->
         [*] Ethernet (10 or 100Mbit)
         <*>   El controlador o controladores para cada tarjeta de red</pre>
}}

{{Note|Asegúrese de seleccionar {{c|&lt;*&gt;}} y no {{c|&lt;M&gt;}}.}}

En segundo lugar, se sugiere que se habilite la opción ''IP: kernel level autoconfiguration'' así como ''IP: DHCP support options''. Esto evita una capa innecesaria de complejidad ya que la dirección IP y la ruta NFS al CD de instalación se pueden configurar en un servidor DHCP. Por supuesto, esto significa que la línea de órdenes del núcleo
permanecerá constante para todas las máquinas, lo cual es muy importante para realizar etherbooting (arranque vía ethernet).

{{KernelBox|title=Configurar un núcleo de la serie 3.x.x para ofrecer soporte a DHCP|<pre>
Device Drivers --->
  Networking Support --->
    Networking options [*]
      TCP/IP networking--->
       [*] IP: kernel level autoconfiguration
       [*] IP: DHCP support
</pre>}}

Estas opciones le indican al núcleo que envíe una petición DHCP en el momento del arranque.

Adicionalmente, debería activar [[SquashFS]] ya que la mayoría de los CD de instalación actuales de Gentoo así lo requieren. El soporte para SquashFS no se incluye en el árbol genérico de fuentes del núcleo. Para activar SquashFS, debe aplicar los parches necesarios para las fuentes genéricas del núcleo o instalar el paquete gentoo-sources.

{{KernelBox|title=Configurar el núcleo para dar soporte a SquashFS|<pre>
File systems--->
  Miscellaneous filesystems --->
   [*] SquashFS 2.X - Squashed file system support
</pre>}}

Una vez completado el proceso de compilación, cree un tarball (tar.gz) que contenga los módulos del núcleo. Este paso es solo es necesario si su versión del núcleo no concuerda con la versión de la imagen del núcleo del CD de Instalación.

Para crear un archivo que contenga todos los módulos:

{{RootCmd|cd / |tar -cf /tmp/modules-X.Y.Z.tar.gz /lib/modules/X.Y.Z/}}

Dependiendo de su mecanismo de arranque por red necesitará seguir alguno de los siguientes pasos:

Para crear una imagen etherboot:

{{Emerge|net-misc/mknbi}}

{{RootCmd
|cd /boot
|mkelf-linux -params{{=}}"root{{=}}/dev/ram0 init{{=}}/linuxrc ip{{=}}dhcp" kernel... initrd... > etherboot.img}}

Para crear una imagen TFTP OpenBoot/SPARC64:

{{Emerge|sys-apps/sparc-utils}}

{{RootCmd
|cd /boot
|elftoaout kernel... -o kernel.aout
|piggyback64 kernel.aout System.map-... initrd-...
|mv kernel.aout openboot.img}}

El fichero {{Path|openboot.img}} es la imagen de inicio.

Para terminar, copie este núcleo al servidor TFTP. Los detalles de este paso dependen de la arquitectura y están fuera de la intención de esta guía. Por favor, consulte la documentación de la plataforma específica de su interés.

==== Configurar NFS ====

Para configurar un recurso compartido de NFS que contenga el CD de instalación, use el dispositivo loop para montar la imagen ISO y a continuación copie los contenidos del CD en el recurso NFS. Como característica extra, los guiones initrd de genkernel extraerán todos los archivos tar.gz ubicados en el directorio {{Path|/nfs/livecd/add/}}.
Todo lo que debe hacer aquí es copiar el fichero {{Path|modules-X.Y.Z.tar.gz}} al directorio {{Path|/nfs/livecd/add/}}.

Lo que sigue asume que {{Path|/nfs/livecd}} es un recurso NFS compartido:

{{RootCmd|mount /tmp/gentoo-livecd.iso /mnt/cdrom -o loop |cp -p /mnt/cdrom /nfs/livecd |umount /mnt/cdrom}}

Ahora copie el fichero {{Path|modules.tar.gz}} a {{Path|/add}}:

{{RootCmd|mkdir /nfs/livecd/add |cp /tmp/modules-X.Y.Z.tar.gz /nfs/livecd/add}}

==== Configurar DHCP ====

Las imágenes del arranque por red (netboot) solicitarán a su servidor DHCP una dirección IP así como la opción <code>root-path</code>. Ambos se especificar en cada máquina usando un dirección MAC para identificarlas:

{{FileBox|filename=/etc/dhcpd.conf|title=Ejemplo de configuración cliente dhcpd.conf|1=
# Aquí 192.168.1.2 es el servidor NFS y 192.168.1.10 será la dirección IP de la máquina que arranca por red
host netbootableMachine {
     hardware ethernet 11:22:33:44:55:66;
     fixed-address 192.168.1.10;
     option root-path "192.168.1.2:/nfs/livecd";
}
}}

==== Instrucciones de arranque desde red ====

De nuevo indicaremos que el arranque por red depende en gran medida de la plataforma. La parte importante es especificar los parámetros <code>ip=dhcp</code> y
<code>init=/linuxrc</code> en la línea de órdenes del núcleo pues esto activará la interfaz de red y le indicará a los guiones initrd que monten el CD de instalación a través de NFS. Se muestran a continuación algunos consejos que dependen de la plataforma:

Para etherboot, inserte el disco de etherboot en la unidad y reinicie. La línea de órdenes del núcleo se especificó cuando se construyó la imagen.

En Sparc64, pulse {{Key|Stop}}+{{Key|A}} en la línea de órdenes de arranque y a continuación teclee:

{{RootCmd|boot net ip{{=}}dhcp init{{=}}/linuxrc|prompt=ok }}

Para PXE, configure pxelinux (que es parte de syslinux) y a continuación cree un fichero {{Path|pxelinux.cfg/default}} con las siguientes líneas:

{{FileBox|filename=pxelinux.cfg/default|title=Entrada por defecto|1=
DEFAULT gentoo
TIMEOUT 40
PROMPT 1

LABEL gentoo
  KERNEL kernel-X.Y.Z
  APPEND initrd=initrd-X.Y.Z root=/dev/ram0 init=/linuxrc ip=dhcp
}}

==== Iniciar un initramfs de genkernel ====

===== Introducción =====

Si instaló un initramfs con genkernel, eche
un vistazo a las diversas opciones de inicio que puede (o debería) definir en la configuración de su gestor de arranque. Las más comunes se han incluido en esta guía.

===== Cargar LVM o software RAID =====

Si el sistema utiliza LVM o software RAID, tendrá que construir el initramfs utilizando las opciones
<code>--lvm</code> y <code>--mdadm</code>. No olvide habilitar este soporte durante el inicio. Esto se puede hacer mediante las opciones dolvm y domdadm.

{{FileBox|filename=/boot/grub/grub.conf|title=Habilitar el soporte para LVM o MDADM|1=
# Ejemplo para for GRUB 1.x
title Gentoo Linux
root (hd0,0)
kernel /vmlinuz root=/dev/md3 dolvm domdadm
initrd /initramfs-genkernel-x86_64-3.4.3
}}

===== Iniciar en modo de único usuario (single-user) =====

Si, por alguna razón, el inicio falla, debería poder rescatar su sistema iniciando en modo único usuario (single-user). Esto carga únicamente los servicios necesarios y a continuación ofrece un intérprete de órdenes de rescate (root).

{{FileBox|filename=/boot/grub/grub.conf|title=Iniciar en modo de único usuario (single-user)|1=
# Ejemplo para GRUB 1.x
title Gentoo Linux
root (hd0,0)
kernel /vmlinuz root=/dev/md3 init_opts=S
initrd /initramfs-genkernel-x86_64-3.4.3
}}

== Resolución de problemas ==

=== compile failed: Kernel not found ===

Se puede experimentar este fallo cuando se intenta compilar un núcleo para una arquitectura con un fichero {{Path|.config}} de configuración de un núcleo para una arquitectura diferente de la actual. Este caso podría ser tan simple como el de una máquina que correo un núcleo {{Keyword|amd64}} y se intenta construir un núcleo para una máquina {{Keyword|x86}}.

Esto puede suceder cuando se inicia desde un LiveCD en un sistema que puede operar a 64 bits pero el destino a instalar o reparar es de 32 bits. Una vez comienza el proceso de compilación {{c|genkernel}} intentará detectar de forma automática la arquitectura del sistema destino basándose en el núcleo que está corriendo actualmente. Si el núcleo actual es de 64 bit, entonces, a menos que se indique lo contrario, {{c|genkernel}} asumirá que se desea un núcleo de 64 bits.

Se puede suponer entonces que en el fichero {{Path|.config}} del núcleo se ha deshabilitado x64. La orden {{c|make}} se lanzará y el binario del núcleo correspondiente se localizará en el directorio asociado {{Path|x86}}. Cuando {{c|genkernel}} vaya a instalar (mover y renombrar) el núcleo, no lo podrá encontar ya que espera un núcleo de 64 bits.

La solución a este problema es definir la opción <code>--arch-override</code> de {{c|genkernel}} a, en este caso, la arquitectura {{Keyword|x86}}. La orden a lanzar podría tener el siguiente aspecto:

{{RootCmd|genkernel --kernel-config{{=}}/usr/src/linux/.config --btrfs --install --arch-override{{=}}x86 all}}

Para marcar permanentemente la opción de la arquitectura deseada, se debe modificar la variable <var>ARCH_OVERRIDE</var> en el fichero {{Path|/etc/genkernel.conf}}.

=== external modules (such as xtables_addons) must be rebuilt manually with a new kernel ===

Genkernel can rebuild external modules after the kernel is built; edit {{Path|genkernel.conf}} to include this line:

{{FileBox|filename=/etc/genkernel.conf|title=Run a command after building a new kernel|lang=bash|1=
# Run the specified command in the current environment after the kernel and
# modules have been compiled, useful to rebuild external kernel module
# (use "emerge --quiet @module-rebuild" for >=portage-2.2) or installing additional
# files (use 'copy_image_with_preserve dtb path/to/dtb dtb ${KNAME}-${ARCH}-${KV}')
#CMD_CALLBACK=""
CMD_CALLBACK="emerge --quiet @module-rebuild"
}}

== Véase también ==

* [[Kernel/Configuration/es|Configuración manual del núcleo]] - Para cuando sea necesario hacer las cosas de forma manual.
* [[Dracut]] - Otro constructor de initramfs disponible en Gentoo.


[[Category:Kernel]]
[[Category:Initramfs]] {{Migrated|originalauthors=Tim Yamin, Jimi Ayodele, Thomas Seiler, {{Dev|nightmorph}}, {{Dev|sping}}, {{Dev|jaaf}}}}
