<languages />

{{Metadata|abstract=Dnsmasq — это легковесный DHCP/DNS сервер для небольших и средних по размеру сетей.}}

{{InfoBox stack
|{{InfoBox homepage|http://www.thekelleys.org.uk/dnsmasq/doc.html|header=true}}
|{{InfoBox wikipedia|Dnsmasq}}
}}

{{c|dnsmasq}} — это [[Article description::простой DHCP/DNS сервер, который можно использовать в локальной сети до 1000 клиентов]]. Его основные особенности — простота настройки и небольшой расход системных ресурсов. Он также поддерживает IPv6.

== Установка ==

=== USE-флаги ===

Выберите нужные USE-флаги:

{{USEflag|package=net-dns/dnsmasq}}

=== Emerge ===

Затем установите пакет {{Package|net-dns/dnsmasq}}:

{{Emerge|net-dns/dnsmasq}}

== Конфигурация ==

Поведением dnsmasq можно управлять с помощью следующих ресурсов:
* параметры командной строки, устанавливаемые в файле {{Path|/etc/conf.d/dnsmasq}}
* основной файл конфигурации ({{Path|/etc/dnsmasq.conf}})

=== Сервис ===

==== OpenRC ====

Add dnsmasq to the default runlevel if it needs to be started automatically:

{{RootCmd|rc-update add dnsmasq default}}

To start the service now:

{{RootCmd|service dnsmasq start}}

=== Настройка сервиса ===

В {{Path|/etc/conf.d/dnsmasq}} можно настроить параметры командной строки, подаваемые демону dnsmasq при его запуске.

{{FileBox|filename=/etc/conf.d/dnsmasq|title=Пример настройки сервиса dnsmasq|lang=bash|1=
DNSMASQ_OPTS="--user=dnsmasq --group=dnsmasq -H /srv/virt/gentoo/hosts --max-cache-ttl=10"
}}

=== Основной файл конфигурации ===

Основная настройка dnsmasq осуществляется с помощью его файла конфигурации {{Path|/etc/dnsmasq.conf}}. Этот файл использует синтаксис вида <code>key[=value]</code>. Пример файла конфигурации включен в пакет; он хорошо документирован и его рекомендуется прочитать. В этом файле, либо с помощью параметров командной строки, можно обращаться к дополнительным ресурсам (например, файл DHCP hosts).

Пример файла конфигурации:

{{FileBox|filename=/etc/dnsmasq.conf|1=
# Принимать соединения только на этом интерфейсе
interface=eth1
  
# Присваивать имена по mac-адресу
dhcp-host=00:1e:68:c2:ff:ee,endor,192.168.0.54,24h
  
# Любой другой запрос DHCP получает ip из этого диапазона
dhcp-range=eth1,192.168.0.100,192.168.0.120,12h
  
# Включить TFTP-сервер и установить корневой каталог для файлов, доступных посредством TFTP.
enable-tftp
tftp-root=/var/lib/tftpboot
dhcp-boot=/pxelinux.0
}}

После редактирования файла конфигурации нужно перезапустить (restart) сервис — перезагрузка (reload) поддерживается, но для других ресурсов.

{{RootCmd|/etc/init.d/dnsmasq restart}}

=== Файл hosts ===

Приложение dnsmasq использует файл {{Path|/etc/hosts}} в качестве одного из источников, предоставляющих сервисы DNS, если не указан параметр командной строки <code>-h</code> (<code>--no-hosts</code>).

После обновления {{Path|/etc/hosts}} dnsmasq должен получить сигнал SIGHUP, чтобы перезагрузить настройки. Это также можно сделать с помощью команды ''reload'' из init-скрипта:

{{RootCmd|/etc/init.d/dnsmasq reload}}

Это поведение можно отключить в файле конфигурации с помощью параметра <code>no-hosts</code>.

=== Дополнительный файл hosts ===

Существует возможность обращения к (дополнительному) файлу hosts в качестве источника запросов DNS. Для этого нужно добавить параметр командной строки <code>-H /path/to/hostsfile</code> (<code>--addn-hosts=/path/to/hostsfile</code>). Также можно указать каталог; в этом случае, все файлы в этом каталоге будут рассматриваться, как дополнительные файлы hosts.

Так же как и со стандартным файлом hosts, сигнал SIGHUP перезагружает файл.

Это поведение также можно установить в файле конфигурации с помощью параметра <code>addn-hosts</code>.

=== Upstream сервера имен ===

По умолчанию, dnsmasq использует сервера имен, указанные в {{Path|/etc/resolv.conf}}, в качестве upstream серверов имен.

С помощью параметра командной строки <code>-r</code> (<code>--resolv-file</code>) можно задать другой файл.

Это поведение также можно установить в файле конфигурации с помощью параметра <code>resolv-file</code>.

== Возможности ==

Dnsmasq поддерживает DNS, TFTP, PXE, router advertisements и сервисы DHCP. Он является гибкой утилитой управления сетью для небольших и средних по размеру сетей.

=== Сервисы DNS ===

Для того, чтобы предоставить (только) сервисы DNS, сначала определите ''upstream nameserver''. Если это тот же сервер, который указан в файле {{Path|/etc/resolv.conf}}, то не требуется предпринимать никаких дополнительных шагов. В противном случае, укажите dnsmasq нужный файл {{Path|resolv.conf}} с помощью параметра командной строки <code>-r</code> (<code>--resolv-file</code>). Синтаксис тот же, что и в файле {{Path|/etc/resolv.conf}}, однако dnsmasq читает только определения ''nameserver''.

Например:

{{RootCmd|echo "nameserver 8.8.8.8" >> /etc/dnsmasq.conf.resolv}}

Затем укажите этот файл dnsmasq с помощью файла конфигурации:

{{FileBox|filename=/etc/dnsmasq.conf|title=Настройка пользовательского файла resolv|1=
resolv-file=/etc/dnsmasq.conf.resolv
}}

Чтобы удостовериться, что сервис работает (после перезапуска, поскольку файл конфигурации был изменен), воспользуйтесь командой <code>dig</code> (она входит в пакет {{Package|net-dns/bind-tools}}) для того, чтобы попросить сервер DNS (запущенный на localhost в следующем примере) разрешить локальный или удаленный адрес:

{{Cmd|dig @localhost +short www.gentoo.org|output=<pre>
www-bytemark-v4v6.gentoo.org.
89.16.167.134
</pre>}}

=== DNSSEC ===

Dnsmasq может проверять достоверность данных DNSSEC во время передачи данных. Это можно реализовать, добавив следующие строки в файл конфигурации:

{{FileBox|filename=/etc/dnsmasq.conf|title=Включение DNSSEC|1=
# Настройка DNSSEC
dnssec
trust-anchor=.,19036,8,2,49AAC11D7B6F6446702E54A1607371607A1A41855200FD2CE1CDDE32F24E8FB5
dnssec-check-unsigned
}}

Trusted anchor можно найти на сайте [https://data.iana.org/root-anchors/root-anchors.xml iana.org]. После этих изменений, если проверка достоверности не удастся, dnsmasq вернет SERVFAIL и не вернет никаких данных DNS. Если проверка достоверности завершается успехом, dnsmasq устанавливает флаг ''ad''. В случае, если домен не поддерживает DNSSEC, dnsmasq ведет себя, как и раньше.

=== Сервисы DHCP ===

Для того, чтобы включить сервисы DHCP dnsmasq, используйте параметр настройки <code>dhcp-range</code>.

Например, для того, чтобы включить настройку адреса IPv6 посредством router advertisement (RA) с бесконечной арендой, и настройку адреса IPv4 также с бесконечной арендой:

{{FileBox|filename=/etc/dnsmasq.conf|title=Включение аренды IPv6 и IPv4|1=
dhcp-range=2001:db8:81:e2::,ra-only,infinite
dhcp-range=192.168.100.100,192.168.100.149,infinite
}}

Существует возможность использования статических определений для известных хостов. Это можно реализовать либо посредством основного файла конфигурации (параметр <code>dhcp-host=</code>), либо посредством отдельного файла. Если используется отдельный файл, укажите его dnsmasq с помощью параметра командной строки <code>--dhcp-hostsfile</code>. Преимущество последнего варианта в том, что для повторного считывания записей достаточно послать сигнал SIGHUP (или перезагрузить сервис), тогда как при использовании определений в файле конфигурации необходимо полностью перезапустить сервис.

Для получения более подробной информации о синтаксисе параметра <code>dhcp-host</code>, обратитесь к странице руководства или к файлу конфигурации, поскольку синтаксис этого параметра весьма пространен.

== Использование ==

Этот раздел содержит описание различных вариантов использования (обслуживания и практических задач) сервиса dnsmasq.

=== Сброс аренды ===

Клиенты, у которых был обновлен сетевой интерфейс, что привело к изменению MAC-адреса, могут не сразу получить нужный IP-адрес. Это происходит оттого, что сервис dnsmasq предоставил этот IP-адрес старому MAC-адресу и ожидает истечения аренды этого адреса, прежде чем присвоить новый.

Сервис dnsmasq хранит свои аренды в файле {{Path|/var/lib/misc/dnsmasq.leases}}. Если требуется быстрее удалить аренду, остановите сервис dnsmasq, удалите аренду из файла {{Path|dnsmasq.leases}} и снова запустите сервис.

{{RootCmd|/etc/init.d/dnsmasq stop
|nano -w /var/lib/misc/dnsmasq.leases
|/etc/init.d/dnsmasq start}}

=== Перезагрузка неосновных настроек конфигурации ===

В дополнение к файлу {{Path|dnsmasq.conf}}, сервис dnsmasq может использовать внешние определения для следующих сервисов:
* настройки конфигурации хостов DHCP (посредством параметра командной строки <code>--dhcp-hostsfile</code>)
* параметры DHCP (посредством параметра командной строки <code>--dhcp-optsfile</code>)

После изменения этих файлов сигнал SIGHUP заставит dnsmasq перезагрузить эти настройки.

{{Note|Файлы {{Path|resolv.conf}} по умолчанию опрашиваются dnsmasq; изменения в этих файлах вступают в силу автоматически, если не указан параметр командной строки <code>-n</code> (<code>--no-poll</code>) или параметр настройки <code>no-poll</code>.}}


[[Category:Software]]
