<languages />

{{Metadata|abstract=Dnsmasq — это легковесный DHCP/DNS сервер для небольших и средних по размеру сетей.}}

{{InfoBox stack
|{{InfoBox homepage|http://www.thekelleys.org.uk/dnsmasq/doc.html|header=true}}
|{{InfoBox wikipedia|Dnsmasq}}
}}

[http://thekelleys.org.uk/dnsmasq/doc.html Dnsmasq] — это простой DHCP/DNS сервер, который можно использовать в локальной сети до 1000 клиентов. Его основные особенности — простота настройки и небольшой расход системных ресурсов. Он также поддерживает IPv6.

== Установка ==

Установка dnsmasq полностью поддерживается пакетным менеджером и деревом portage. Сначала выберите нужные USE-флаги.

{{USEflag|package=net-dns/dnsmasq}}

Затем установите {{Package|net-dns/dnsmasq}} и добавьте его в уровень запуска default, если требуется запускать его автоматически.

{{Emerge|net-dns/dnsmasq}}

{{RootCmd|/etc/init.d/dnsmasq start
|rc-update add dnsmasq default}}

== Конфигурация ==

Поведением dnsmasq можно управлять с помощью следующих ресурсов:
* параметры командной строки, устанавливаемые в файле {{Path|/etc/conf.d/dnsmasq}}
* основной файл конфигурации ({{Path|/etc/dnsmasq.conf}})

=== Настройка сервиса ===

В {{Path|/etc/conf.d/dnsmasq}} можно настроить параметры командной строки, подаваемые демону dnsmasq при его запуске.

{{FileBox|filename=/etc/conf.d/dnsmasq|title=Пример настройки сервиса dnsmasq|1=
DNSMASQ_OPTS="--user=dnsmasq --group=dnsmasq -H /srv/virt/gentoo/hosts --max-cache-ttl=10"
}}

=== Основной файл конфигурации ===

Основная настройка dnsmasq осуществляется с помощью его файла конфигурации, {{Path|/etc/dnsmasq.conf}}. Этот файл использует синтаксис вида <code>key[=value]</code>. Пример файла конфигурации включен в пакет; он хорошо документирован и его рекомендуется прочитать. В этом файле, либо с помощью параметров командной строки, можно обращаться к дополнительным ресурсам (например, файл DHCP hosts).

Пример файла конфигурации:

{{FileBox|filename=/etc/dnsmasq.conf|1=
# Принимать соединения только на этом интерфейсе
interface=eth1
  
# Присваивать имена по mac-адресу
dhcp-host=00:1e:68:c2:ff:ee,endor,192.168.0.54,24h
  
# Любой другой запрос DHCP получает ip из этого диапазона
dhcp-range=eth1,192.168.0.100,192.168.0.120,12h
  
# Включить TFTP-сервер и установить корневой каталог для файлов, доступных посредством TFTP.
enable-tftp
tftp-root=/var/lib/tftpboot
dhcp-boot=/pxelinux.0
}}

После редактирования файла конфигурации нужно перезапустить (restart) сервис — перезагрузка (reload) поддерживается, но для других ресурсов.

{{RootCmd|/etc/init.d/dnsmasq restart}}

=== Файл hosts ===

Приложение dnsmasq использует файл {{Path|/etc/hosts}} в качестве одного из источников, предоставляющих сервисы DNS, если не указан параметр командной строки <code>-h</code> (<code>--no-hosts</code>).

После обновления {{Path|/etc/hosts}} dnsmasq должен получить сигнал SIGHUP, чтобы перезагрузить настройки. Это также можно сделать с помощью команды ''reload'' сценария инициализации:

{{RootCmd|/etc/init.d/dnsmasq reload}}

Это поведение можно отключить в файле конфигурации с помощью параметра <code>no-hosts</code>.

=== Дополнительный файл hosts ===

Существует возможность обращения к (дополнительному) файлу hosts в качестве источника запросов DNS. Для этого нужно добавить параметр командной строки <code>-H /path/to/hostsfile</code> (<code>--addn-hosts=/path/to/hostsfile</code>). Также можно указать каталог; в этом случае, все файлы в этом каталоге будут рассматриваться, как дополнительные файлы hosts.

Так же как и со стандартным файлом hosts, сигнал SIGHUP перезагружает файл.

Это поведение также можно установить в файле конфигурации с помощью параметра <code>addn-hosts</code>.

=== Upstream сервера имен ===

По умолчанию, dnsmasq использует сервера имен, указанные в {{Path|/etc/resolv.conf}}, в качестве upstream серверов имен.

С помощью параметра командной строки <code>-r</code> (<code>--resolv-file</code>) можно задать другой файл.

Это поведение также можно установить в файле конфигурации с помощью параметра <code>resolv-file</code>.

== Возможности ==

Dnsmasq поддерживает DNS, TFTP, PXE, router advertisements и сервисы DHCP. Он является гибкой утилитой управления сетью для небольших и средних по размеру сетей.

=== Сервисы DNS ===

Для того, чтобы предоставить (только) сервисы DNS, сначала определите ''upstream nameserver''. Если это тот же сервер, который указан в файле {{Path|/etc/resolv.conf}}, то не требуется предпринимать никаких дополнительных шагов. В противном случае, укажите dnsmasq нужный файл {{Path|resolv.conf}} с помощью параметра командной строки <code>-r</code> (<code>--resolv-file</code>). Синтаксис тот же, что и в файле {{Path|/etc/resolv.conf}}, однако dnsmasq читает только определения ''nameserver''.

Например:

{{RootCmd|echo "nameserver 8.8.8.8" >> /etc/dnsmasq.conf.resolv}}

Затем укажите этот файл dnsmasq с помощью файла конфигурации:

{{FileBox|filename=/etc/dnsmasq.conf|title=Настройка пользовательского файла resolv|1=
resolv-file=/etc/dnsmasq.conf.resolv
}}

Чтобы удостовериться, что сервис работает (после перезапуска, поскольку файл конфигурации был изменен), воспользуйтесь командой <code>dig</code> (она входит в пакет {{Package|net-dns/bind-tools}}) для того, чтобы попросить сервер DNS (запущенный на localhost в следующем примере) разрешить локальный или удаленный адрес:

{{Cmd|dig @localhost +short www.gentoo.org|output=<pre>
www-bytemark-v4v6.gentoo.org.
89.16.167.134
</pre>}}

=== DNSSEC ===

Dnsmasq может проверять достоверность данных DNSSEC во время передачи данных. Это можно реализовать, добавив следующие строки в файл конфигурации:

{{FileBox|filename=/etc/dnsmasq.conf|title=Enabling DNSSEC|1=
# DNSSEC setup
dnssec
trust-anchor=.,19036,8,2,49AAC11D7B6F6446702E54A1607371607A1A41855200FD2CE1CDDE32F24E8FB5
dnssec-check-unsigned
}}

The trusted anchor can be found [https://data.iana.org/root-anchors/root-anchors.xml on the iana.org site]. After this change dnsmasq will return SERVFAIL and no DNS data if the validation fails. If the validation succeeds it sets the ''ad'' flag. In case the domain does not support DNSSEC dnsmasq behaves as before.

=== DHCP services ===

In order to enable the DHCP services of dnsmasq, use the <code>dhcp-range</code> configuration setting.

For instance, to enable IPv6 address configuration through RA with infinite lease time, and IPv4 address configuration also with infinite lease time:

{{FileBox|filename=/etc/dnsmasq.conf|title=Enabling IPv6 and IPv4 leases|1=
dhcp-range=2001:db8:81:e2::,ra-only,infinite
dhcp-range=192.168.100.100,192.168.100.149,infinite
}}

It is possible to use static definitions for known hosts, either through the main configuration file (<code>dhcp-host=</code> settings) or through a separate file. If a separate file is used, point dnsmasq to it through the <code>--dhcp-hostsfile</code> command line option. The advantage of the latter approach is that it is sufficient to send a SIGHUP signal (or reload the service) in order to reread the entries, whereas definitions in the configuration file require a full service restart.

For more information about the syntax of the <code>dhcp-host</code> parameter please refer to the manual page or configuration file as its syntax is very extensive.

== Использование ==

This section covers various usage scenarios (maintenance and operational tasks) for the dnsmasq service.

=== Resetting leases ===

Clients that had a network interface update which results in a different MAC address might not get the intended IP address immediately. This is because the dnsmasq service has provided this IP address to the old MAC address, and will wait until the lease of this address has expired before re-assigning it.

The dnsmasq service stores its leases in {{Path|/var/lib/misc/dnsmasq.leases}}. If the lease needs to be removed faster, shut down the dnsmasq service, remove the lease from the {{Path|dnsmasq.leases}} file and start the service again.

{{RootCmd|/etc/init.d/dnsmasq stop
|nano -w /var/lib/misc/dnsmasq.leases
|/etc/init.d/dnsmasq start}}

=== Reloading non-main configuration settings ===

Next to the {{Path|dnsmasq.conf}} file, the dnsmasq service can use external definitions for the following services:
* DHCP host configuration entries (through <code>--dhcp-hostsfile</code> command line option)
* DHCP options (through <code>--dhcp-optsfile</code> command line option)

When these files are modified, a SIGHUP signal has dnsmasq reload these configuration files.

{{Note|The {{Path|resolv.conf}} files are by default polled by dnsmasq; changes on these files are automatically picked up unless the <code>-n</code> (<code>--no-poll</code>) command line option is set or the <code>no-poll</code> configuration parameter is used.}}


[[Category:Software]]
