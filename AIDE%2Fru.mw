<languages />


{{Metadata|abstract=AIDE означает Advanced Intrusion Detection Environment (расширенная система обнаружения вторжений) и является приложением, которое сканирует файлы и другие источники и сохраняет информацию об этих файлах в базе данных. Хранящаяся информация включает в себя такие ключевые атрибуты файла, как хэш, размер файла, принадлежность, время изменения, время создания и еще. После того, как создана начальная база данных, AIDE сканирует систему еще раз, и сравнивает новые результаты с уже хранящимися. Если результаты отличаются, значит файл был изменен, и об этом изменении будет сообщено. Идея, стоящая за использованием AIDE, это создание снапшота системы, а не сравнение одного снапшота с другим для выявления скомпрометированных файлов.}}

AIDE ('''''A'''dvanced '''I'''ntrusion '''D'''etection '''E'''nvironment'') is a host-based intrusion detection system. AIDE scans files and other resources and stores information about these files in a database. Stored information includes key file attributes such as file hash output, file size, ownership, modification time, creation time, and more. After the initial database has been created, AIDE then rescans the system and compares new scan results with previously stored values. If values differ then the file has been changed and the change will be reported. The idea behind using AIDE is to create a snapshot of a system then compare the snapshot to another created snapshot to find compromised files.

__TOC__

== Установка ==

=== USE-флаги ===

It is easy to install {{Package|app-forensics/aide}} after setting the USE flags accordingly.
{{USEflag|package=app-forensics/aide}}

USE flag changes specific to a certain package should be defined in the {{Path|/etc/portage/package.use}} file, or a text file inside a directory called {{Path|/etc/portage/package.use}}. For example, when using a {{Path|/etc/portage/package.use}} ''file'':

{{FileBox|filename=/etc/portage/package.use|title=Включение поддержки zlib в пакете AIDE|1=<pre>
app-forensics/aide zlib
</pre>}}

=== Emerge ===

После настройки USE-флагов установите приложение:

{{Emerge|app-forensics/aide}}

== Конфигурация ==

=== Общий обзор ===

Файл настроек {{Package|app-forensics/aide}} не настолько устрашающий, как это может показаться с первого взгляда. Файл по умолчанию хранится в {{Path|/etc/aide/aide.conf}}, но если это необходимо, администраторы легко могут создать множественные отдельные файлы настроек. Кроме нескольких переменных, файл настроек содержит несколько кратких обозначений для того, какие аспекты файлов нужно сканировать (только хэш-суммы, или также информацию об индексных дескрипторах (inodes), и т.д.) и затем, какие файлы нужно сканировать.

Давайте сначала рассмотрим переменные.

{{FileBox|filename=aide.conf|title=Переменные конфигурации базы данных AIDE|1=
database=file:/var/lib/aide/aide.db
database_out=file:/var/lib/aide/aide.db.new
}}

The first line in the example above (<code>database</code>) defines where the location of database that contains the known values. The second line (<code>database_out</code>) defines where to store new databases when another is generated. It is generally recommended against having these variables point to the same database (having the same paths for each variable). If one database is to overwrite another, the best method is to ''manually copy'' over the generated database from one location to the other. For example, to overwrite the first database with the second, this command could be used:

{{RootCmd|cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db}}

For now, leave the database variables as they are; they will be covered in more detail later in the article.

Next, consider the variables which are short-hand notations for what information to record in the database.

{{FileBox|filename=aide.conf|title=Cокращенные обозначения используемые в настройке AIDE|lang=ini|1=
Binlib = p+i+n+u+g+s+b+m+c+md5+sha1
Logs = p+i+n+u+g+S
...
}}

{{Note|It should be obvious that <code>md5</code> and <code>sha1</code> mean that MD5 and SHA-1 checksums are taken (respectively).}}

The letters are described in the default {{Path|aide.conf}} file, but for convenience the following table provides an overview of the most common options:

{| class="table"
! Short
! Description
|-
| <code>p</code>
| Permissions
|-
| <code>i</code>
| inode number
|-
| <code>n</code>
| Number of (hard)links
|-
| <code>u</code>
| User information
|-
| <code>g</code>
| Group information
|-
| <code>s</code>
| Size
|-
| <code>S</code>
| Size (only report when the size is suddenly smaller - growing is allowed)
|-
| <code>b</code>
| Block count
|-
| <code>m</code>
| Modification time
|}

Next is an overview of which directories to scan, and what to scan for. In three line example to follow, AIDE is instructed to scan the {{Path|/bin}} and {{Path|/sbin}} directories via the measures identified in the <var>Binlib</var> short-hand notation variable. The {{Path|/var/log}} file will display the scan measures defined in the <var>Logs</var> variable defined above.

{{FileBox|filename=aide.conf|title=Параметры задачи сканирования|1=
/bin Binlib
/sbin Binlib
/var/log Logs
...
}}

AIDE supports regular expressions and users are allowed to "remove" matches. For instance, to scan {{Path|/var/log}} but not {{Path|/var/log/portage}} then make an exclusion set by using the <code>!</code> (exclamation point) before the excluded path(s):

{{FileBox|filename=aide.conf|title=Другие задачи сканирования|1=
/var/log Logs
!/var/log/portage
}}

=== Detailed options ===

The configuration file is based on regular expressions, macros and rules for files and directories. Users experienced with the [https://www.tripwire.org/ tripwire solution] will have no difficulties dealing with AIDE's configuration file. The following macros are available:

{| class="table table-striped table-condensed" style="width: auto;"
|-
! Macro !! Description !! Syntax
|-
| <code>ifdef</code> || If defined || <code>@@ifdef "name"</code>
|-
| <code>ifndef</code> || If not defined || <code>@@ifndef "name"</code>
|-
| <code>define</code> || Define a variable || <code>@@define "name" "value"</code>
|-
| <code>undef</code> || Undefine a variable || <code>@@undef "name"</code>
|-
| <code>ifhost</code> || if "hostname" || <code>@@ifhost "hostname"</code>
|-
| <code>ifnhost</code> || if not "hostname" || <code>@@ifnhost "hostname"</code>
|-
| <code>endif</code> || Endif must be used after any of the above macros except define and undef || <code>@@endif</code>
|}

These macros become very handy when dealing with multiple Gentoo boxes, while using the same configuration on all. Not all machines run the same services or even have the same users.

Next we have a set of flags which identify the permissions, file properties, checksums, cryptographic hashes, ... to validate on files and directories.

{| class="table table-striped table-condensed" 
|-
! Flag !! Description
|-
| <code>p</code> || permissions
|-
| <code>i</code> || inode
|-
| <code>n</code> || number of links
|-
| <code>u</code> || user
|-
| <code>g</code> || group
|-
| <code>s</code> || size
|-
| <code>b</code> || block count
|-
| <code>m</code> || mtime
|-
| <code>a</code> || atime
|-
| <code>c</code> || ctime
|-
| <code>S</code> || check for growing size
|-
| <code>md5</code> || md5 checksum
|-
| <code>sha1</code> || sha1 checksum
|-
| <code>rmd160</code> || rmd160 checksum
|-
| <code>tiger</code> || tiger checksum
|-
| <code>R</code> || <code>p+i+n+u+g+s+m+c+md5</code>
|-
| <code>L</code> || <code>p+i+n+u+g</code>
|-
| <code>E</code> || Empty group
|-
| <code><nowiki>></nowiki></code> || Growing logfile <code>p+u+g+i+n+S</code>
|}

If AIDE is compiled with mhash support, then the following flags can be used as well:

{| class="table table-striped table-condensed"
|-
! Flag !! Description
|-
| <code>haval</code> || haval checksum
|-
| <code>gost</code> || gost checksum
|-
| <code>crc32</code> || crc32 checksum
|}

=== Инициализация и частое сканирование ===

For a basic AIDE setup, a database must be initialized. This is performed using the <code>--init</code> option. To make sure AIDE uses the configuration settings defined in the sections before, be sure to pass the <code>--config</code> option pointed to the correct configuration file:

{{RootCmd|aide --init --config{{=}}/etc/aide/aide.conf|output=<pre>
AIDE, version 0.14.2
  
### AIDE database at /var/lib/aide/aide.db.new initialized.
</pre>}}

Once initialized, any pre-existing database files can be copied over:

{{RootCmd|cd /var/lib/aide; cp aide.db.new aide.db}}

With a new database available, the entries can be scanned again (now or at a later date) using the <code>--check</code> option. This will create another database containing any modifications that have made to the file system since the first database has been created. Be sure to use the <code>--config</code> option pointed to the same configuration file that the first database was created with:

{{RootCmd|aide --check --config{{=}}/etc/aide/aide.conf|output=<pre>
AIDE, version 0.14.2
  
### All files match AIDE database. Looks okay!
</pre>}}

Если произошло изменение файла(ов), будет послано уведомление:

{{RootCmd|aide --check --config{{=}}/etc/aide/aide.conf|output=<pre>
AIDE found differences between database and filesystem!!
Start timestamp: 2013-04-11 15:31:02
  
Summary:
  Total number of files:        318
  Added files:                  0
  Removed files:                0
  Changed files:                2
  
  
---------------------------------------------------
Changed files:
---------------------------------------------------
  
changed: /etc/pam.d
changed: /etc/pam.d/run_init
  
---------------------------------------------------
Detailed information about changes:
---------------------------------------------------
  
  
Directory: /etc/pam.d
  Mtime    : 2013-04-09 22:11:18              , 2013-04-11 15:31:01
  Ctime    : 2013-04-09 22:11:18              , 2013-04-11 15:31:01
  
File: /etc/pam.d/run_init
  Size     : 205                              , 208
  Mtime    : 2013-04-09 22:11:18              , 2013-04-11 15:31:00
  Ctime    : 2013-04-09 22:11:18              , 2013-04-11 15:31:01
  Inode    : 394203                           , 394053
  MD5      : Mm0KPzpPt63eqGClTJ/KaQ==         , eLUrP2BsIq25f3AZX+dlBA==
  SHA1     : NrQtsUeOsXS4RHUq+ejYBne5V6E=     , 5A6ef6VJCcMiqEjKQ7e9xkBNZB8=
</pre>}}

== Лучшие Практики ==

=== Ясно определите что нужно сканировать ===

Файл конфигурации AIDE по умолчанию полезен, но требуется его тонкая настройка для соответствия требованиям пользователей. Важно знать какие файлы нужно сканировать и почему.

Например, для сканирования всех файлов, связанных с аутентификацией, и никаких других файлов, используйте следующие настройки:

{{FileBox|filename=aide.conf|title=Задачи сканирования, связанные с аутентификацией|1=
# Политики SELinux и настройки
/etc/selinux ConfFiles
# Базы данных аутентификации
/etc/passwd ConfFiles
/etc/shadow ConfFiles
/etc/nsswitch.conf ConfFiles
# Конфигурация аутентификации
/etc/pam.d ConfFiles
/etc/securetty ConfFiles
/etc/security ConfFiles
# Библиотеки PAM
/lib(64)?/security Binlib
}}

=== Храните базу данных на внешнем носителе и в режиме только для чтения ===

A second important aspect is that the result database should be stored offline when ''not'' needed and should be used in read-only mode when the database ''is'' needed. This gives some protection against a malicious user that might have compromised the machine to modify the results database. For instance, provide the result database on a read-only NFS mount (for servers) or read-only medium (when physical access to the machine is possible) such as a CD/DVD or a read-only USB drive.

После размещения базы данных в месторасположении только для чтения, обновите файл {{Path|aide.conf}}, чтобы <code>database=</code> указывал на это новое место.

=== Делайте автономное сканирование ===

Если необходимо, попытайтесь использовать автономные методы сканирования системы. В случае с виртуальными платформами, возможно сделать снимок системы, смонтировать этот снимок (с доступом только на чтение) и затем запустить aide сканирование на примонтированной файловой системе.

{{RootCmd|losetup /dev/loop0 /srv/virt/gentoo.img
|vgscan
|vgchange -ay
|mount -o ro /dev/volgrpX/volumeY /mnt/image
|chroot /mnt/image
|aide --check --config{{=}}/path/to/aide.conf
|exit
|umount /mnt/image
|vgchange -an /dev/volgrpX
|losetup -d /dev/loop0}}

Подход, представленный выше, использует {{c|chroot}}. Это требуется только тогда, когда исходная файловая система сканируется с работающей системы, и администратор хочет выполнить автономную проверку. Если первоначальное сканирование проводилось в автономном режиме, то файл {{Path|aide.conf}} уже будет указывать на точку монтирования и база данных сразу же будет пользоваться этими путями, поэтому в данном случае не требуется использование chroot.

== Смотрите также ==

* [[Integrity/Concepts]] повествует об идеях связанных с целостностью системы

== Ссылки ==

* [http://archive09.linux.com/articles/113919 Tutorial on how to use AIDE (Linux.com)]
* [http://www.symantec.com/connect/articles/securing-linux-aide Securing Linux with AIDE article (Symantec.com)]


[[Category:Server and Security]]
