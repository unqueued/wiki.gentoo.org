<languages />

{{Metadata|abstract=SSH (Secure Shell) 是一个加密的终端程序，用于替代类Unix操作系统上传统的telnet工具。}}

{{InfoBox stack
|{{InfoBox homepage|https://www.openssh.com|header=true}}
|{{InfoBox wikipedia|Secure Shell}}
|{{InfoBox ohloh|openssh}}
}}
'''SSH''' ('''S'''ecure '''SH'''ell) 是 [[Article description::一个加密的终端程序，用于替代类Unix操作系统上传统的 [[Wikipedia:telnet|telnet]] 工具。]]

SSH已经发展成为一组软件系列，除了提供用于远程终端访问的 {{c|ssh}} 这个主要的程序，还包括其他的工具如 {{c|scp}}('''S'''ecure '''C'''opy '''P'''rogram) 和 {{c|sftp}} ('''S'''ecure '''F'''ile '''T'''ransfer '''P'''rotocol)。

最初，SSH并不是免费的。然而，当今最流行并成为实际标准的SSH实现是 [httsp://www.openbsd.org/ OpenBSD] 的OpenSSH，它在Gentoo中已预安装。

== 安装 ==

=== 检查安装 ===

绝大多数的 Gentoo Linux 系统都已经预装了 OpenSSH。可以通过运行 {{c|ssh}}  命令进行检查。如果已经安装，会输出使用说明：

{{Invocation|ssh|output=<pre>
usage: ssh [-1246AaCfgKkMNnqsTtVvXxYy] [-b bind_address] [-c cipher_spec]
           [-D [bind_address:]port] [-E log_file] [-e escape_char]
           [-F configfile] [-I pkcs11] [-i identity_file]
           [-L [bind_address:]port:host:hostport] [-l login_name] [-m mac_spec]
           [-O ctl_cmd] [-o option] [-p port]
           [-Q cipher | cipher-auth | mac | kex | key]
           [-R [bind_address:]port:host:hostport] [-S ctl_path] [-W host:port]
           [-w local_tun[:remote_tun]] [user@]hostname [command]
</pre>}}

如果没有输出使用说明，那么 {{c|ssh}}  要么损坏了要么没有安装。也有可能是用户添加了新的 USE 配置之后正在重新编译 OpenSSH。无论何种情况，请继续查看可能的 USE 设定。

=== USE flags ===

{{USEflag|package=net-misc/openssh}}

=== Emerge ===

在修改了必要的 USE 标志之后，不要忘记安装（或重装） OpenSSH：

{{emerge|net-misc/openssh|params+=--changed-use}}

== 配置 ==

=== 创建密钥 ===

为了提供一个安全的 shell，加密的密钥用于管理 SSH 提供的加密、解密和哈希功能。

在第一次启动 SSH 服务的时候，会生成系统密钥。密钥可以使用 {{c|ssh-keygen}}（重新）生成。

生成SSH协议2的密钥（DSA和RSA算法）：

{{RootCmd|/usr/bin/ssh-keygen -t dsa -f /etc/ssh/ssh_host_dsa_key -N ""
|/usr/bin/ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N ""}}

The article [https://stribika.github.io/2015/01/04/secure-secure-shell.html Secure Secure Shell] suggests using '''Ed25519''' and '''RSA''' public key algorithms with:

{{RootCmd
|/usr/bin/ssh-keygen -t ed25519 -a 100 -f /etc/ssh/ssh_host_dsa_key -N ""
|/usr/bin/ssh-keygen -t rsa -b 4096 -o -a 100 -f /etc/ssh/ssh_host_rsa_key -N ""
}}

=== 服务器端配置 ===

SSH服务器配置文件通常是 {{Path|/etc/ssh/sshd_config}}，虽然也有可能通过OpenRC的{{Path|/etc/conf.d/sshd}}文件进行进一步的配置，包括修改配置文件的位置。关于如何配置服务器的详细信息请参考''sshd_config'' [[man page]]。

您也应该学习 {{Dev|SwifT}} 的这篇偏重于安全配置的[https://dev.gentoo.org/~swift/docs/security_benchmarks/openssh.html OpenSSH 指南]。

=== 客户端配置 ===

{{c|ssh}}  客户端与相关的程序({{c|scp}}，{{c|sftp}} 等)可以通过下面的文件进行配置：

* {{Path|~/.ssh/config}}
* {{Path|/etc/ssh/ssh_config}}

更多的信息请阅读 {{Path|ssh_config}} 手册：

{{Cmd|man ssh_config}}

=== 无密码验证 ===

对于管理 [[git]] 服务器非常便利。

==== 客户端 ====

On the client, if not already done, create a key pair. This can be done by running the following command (of course, '''not entering''' a passphrase):

{{Cmd|ssh-keygen -t rsa|collapse-output=true|output=<pre>
Generating public/private rsa key pair.
Enter file in which to save the key (/home/larry/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/larry/.ssh/id_rsa.
Your public key has been saved in /home/larry/.ssh/id_rsa.pub.
The key fingerprint is:
de:ad:be:ef:15:g0:0d:13:37:15:ad:cc:dd:ee:ff:61 larry@client
The key's randomart image is:
+--[ RSA 2048]----+
|                 |
|     .           |
| . .. n   .      |
|   . (: . .      |
|  o   . . : .    |
| . ..: >.> .     |
|  * ?. .         |
| o.. .. ..       |
| :. .  ! .       |
+-----------------+
</pre>}}

==== 服务器 ====

Make sure an account for the user exists on the server, and then place the clients' {{Path|id_rsa.pub}} file into the server's {{Path|~/.ssh/authorized_keys}} file in the user's home directory. This can be done by running the following command '''on the client computer''' (here, the user's passphrase on the server needs to be entered):

{{Cmd|ssh-copy-id <server>|collapse-output=true|output=<pre>/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/larry/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
larry@<server>'s password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh '<server>'"
and check to make sure that only the key(s) you wanted were added.
</pre>}}

Afterwards a passwordless login should be possible doing

{{cmd|ssh <server>|output=<pre>larry@<server></pre>}}

Then on the server, the file {{path|/etc/ssh/sshd_config}} should be set to <code>PasswordAuthentication no</code>.

==== 单机测试 ====

上面的步骤可以在本地测试：

{{Cmd|ssh-keygen -t rsa|collapse-output=true|output=<pre>
Generating public/private rsa key pair.
Enter file in which to save the key (/home/larry/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
...
</pre>}}

{{Cmd|mv ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys}}

{{Cmd|ssh localhost}}

== 防御入侵 ==

SSH 是一个易受攻击的服务。像 [[sshguard]] 和 [[fail2ban]] 这样的工具会监控日志并将多次尝试登录失败的远程用户加入黑名单。根据需要来使用这些工具以确保这个易受攻击系统的安全。

== 使用 ==

=== 服务 ===

==== OpenRC ====

将OpenSSH服务加入缺省的运行级别：

{{RootCmd|rc-update add sshd default}}

启动sshd服务：

{{RootCmd|rc-service sshd start}}

OpenSSH服务可以像其它被[[OpenRC]]管理的服务一样被控制：

{{RootCmd
|rc-service sshd start
|rc-service sshd stop
|rc-service sshd restart
}}

{{Note|Active SSH connections to the server remain unaffected when issuing {{c|rc-service sshd restart}}.}}

==== systemd ====

当系统启动时同时启动OpenSSH:

{{RootCmd|systemctl enable sshd.service|output=<pre>
Created symlink from /etc/systemd/system/multi-user.target.wants/sshd.service to /usr/lib64/systemd/system/sshd.service.
</pre>}}

现在启动OpenSSH服务：

{{RootCmd|systemctl start sshd.service}}

检查服务是否已经启动：

{{RootCmd|systemctl status sshd.service}}

=== Escape sequences ===

During an active SSH session, pressing the tilde ({{Key|~}}) key starts an escape sequence. Enter the following for a list of options:

{{GenericCmd|prompt=ssh>|color=white|~?}}

== 故障排除 ==

有三种不同级别的调试模式可以帮助排除故障。配合 <code>-v</code> 参数 SSH 会输出关于其进度的调试信息。这有助于调试连接、验证和配置的问题。多个 <code>-v</code> 参数会增加调试信息的详细程度。最大的详细程度是三级。

{{Cmd
|ssh example.org -v
|ssh example.org -vv
|ssh example.org -vvv
}}

=== 长连接被关闭 ===

许多互联网接入设备进行网络地址转换 ([[NAT]])，使在专用网络（典型的例子像家里或者某个营业场所）内的设备可以访问外部网络如互联网，尽管该设备只拥有专用网络上的一个IP地址。不幸的是，不是所有的NAT设备都是一样的，其中一些会错误的关闭那些长时间连接，不经常使用的TCP连接，比如SSH使用的连接。这一问题通常的表现是突然无法和远程的服务器交互，尽管 {{c|ssh}}  客户端程序并未退出。

OpenSSH的客户端和服务器可以被配置为发送一个'keep alive'，或不可见的消息，旨在保持并确认连接的实时状态：

* 为了给连接到您的本地服务器的所有客户端使能keep alive，请在{{Path|/etc/ssh/sshd_config}}文件中设置 <code>ClientAliveInterval 30</code> （或者其它值，以秒为单位）。
* 为了给连接到您的本地客户端的所有服务器使能keep alive，请在{{Path|/etc/ssh/ssh_config}}文件中设置<code>ServerAliveInterval 30</code> （或者其它值，以秒为单位）。

=== X11转发/隧道不工作 ===

'''问题''': 在对配置文件做了必要的修改以允许 X11 转发, 却发现 X 应用程序在服务器端执行却没有转发到客户端。

'''解决办法''': 可能是在SSH登录到远程服务器或者主机的过程中，<var>DISPLAY</var>变量被取消了或者在 SSH session 设置这一变量''之后''又被重设了。

远程登录后按如下步骤测试这一现象：

{{Cmd|echo $DISPLAY|output=<pre>
localhost:10.0
</pre>}}

The output should be something similar to <code>localhost:10.0</code> or <code>localhost2.local:10.0</code> using server side <code>X11UseLocalhost no</code> setting. If the usual <code>:0.0</code> is not displayed, check to make sure the <var>DISPLAY</var> variable within {{Path|~/.bash_profile}} is not being unset or re-initializing. If it is, remove or comment out any custom initialization of the <var>DISPLAY</var> variable to prevent the code in {{Path|~/.bash_profile}} from executing during a SSH login:

{{Cmd|ssh -t larry@localhost2 bash --noprofile}}

请将上面命令中的<code>larry</code>替换为适当的用户名。

一个小技巧是在用户的 {{Path|~/.bashrc}} 中将此命令定义为一个 alias。

== 参考 ==

* [[Security_Handbook/Securing_services#SSH|Securing the SSH service]] (Security Handbook)
* {{See also|Keychain}}
* {{See also|autossh}}
* {{See also|SCP}}
* {{See also|SFTP}}
* {{See also|SSHFS}}
* [[Handbook:AMD64/Installation/Media#Optional:_Starting_the_SSH_daemon|Gentoo Handbook — Installation — Starting the SSH daemon]]
* [[Sakaki%27s_EFI_Install_Guide/Setting_Up_Networking_and_Connecting_via_ssh#Connecting_via_ssh_and_Using_screen]]

== 外部资源 ==

* [https://dev.gentoo.org/~swift/docs/security_benchmarks/openssh.html Securing OpenSSH] - Gentoo developer documentation.
* {{package|net-misc/connect}} — [https://bitbucket.org/gotoh/connect/wiki/Home SSH Proxy Command -- connect.c]
* https://lonesysadmin.net/2011/11/08/ssh-escape-sequences-aka-kill-dead-ssh-sessions/amp/ - A blog entry on escape sequences.
* https://hackaday.com/2017/10/18/practical-public-key-cryptography/ - Practical public key cryptography (Hackaday).
* [https://wiki.archlinux.org/index.php/SSH SSH on wiki.archlinux.org]


[[Category:SSH]]
[[Category:Server]]
[[Category:Daemons]]
[[Category:Authentication]]
