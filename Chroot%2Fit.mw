<languages />

{{InfoBox stack
|{{InfoBox wikipedia|header=true}}
}}

Chroot ('''Ch'''ange '''root''') è un'utilità dei sistemi Unix utilizzata per cambiare la root directory apparente, in modo da creare un nuovo ambiente logicamente separato dalla root del sistema principale. Questo nuovo ambiente è detto "gabbia chroot" (o "chroot jail"). Un utente che opera all'interno di una gabbia non può vedere o accedere a file al di fuori dell'ambiente in cui è stato rinchiuso.

Uno dei principali usi di chroot è quello di creare un sistema Linux separato sopra quello corrente a scopo di test o compatibilità software. Chroot è spesso visto come una leggera alternativa alla virtualizzazione, perchè è in grado di funzionare senza il sovraccarico di un hypervisor.

== Prerequisiti ==

=== Impostare l'ambiente ===

Quando si crea una nuova impostazione di chroot, la prima cosa necessaria è una directory in cui far risiedere il chroot. Ad esempio, un chroot potrebbe essere creato in {{Path|/mnt/mychroot}}:

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

Per montare una installazione esistente da una partizione può essere eseguito il seguente comando. Assicurarsi di sostituire la stringa <code><DEVICE></code> nell'esempio sotto con 
l'unità e la partizione dell'installazione esistente:

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/<DEVICE> /mnt/mychroot
}}

Se un'installazione è stata in precedenza creata in una sotto directory del filesystem di root attuale, i passaggi di cui sopra possono essere saltati.

=== Decomprimere i file di sistema e dell'albero Portage (nuove installazioni) ===

Quando si costruisce una nuova installazione, il passo successivo è quello di scaricare lo stage3 e Portage tarballs e metterli nella posizione in cui è locato chroot. Per ulteriori informazioni su questo processo si veda  [[Handbook:AMD64/Installation/Stage#Downloading_the_stage_tarball|Downloading the stage tarball]] e [[Handbook:AMD64/Installation/Stage#Unpacking_the_stage_tarball|Unpacking the stage tarball]] nell'[[Handbook:Main_Page|Handbook]] di Gentoo.

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/autobuilds/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

== Configurazione ==

Prima di accedere nella chroot deve essere montato un numero di directories:

{{RootCmd
|mount --rbind /dev /mnt/mychroot/dev
|mount --make-rslave /mnt/mychroot/dev
|mount -t proc /proc /mnt/mychroot/proc
|mount --rbind /sys /mnt/mychroot/sys
|mount --make-rslave /mnt/mychroot/sys
|mount --rbind /tmp /mnt/mychroot/tmp
}}

Qualche files di configurazione di base dovrà essere copiato dall'host, non copiare {{Path|make.conf}} quando si utilizza un'installazione esistente:

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # When using an existing installation, skip this command.
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

== Utilizzo ==

Una volta fatto entrare nell'ambiente chroot eseguendo i seguenti comandi:

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

Durante la creazione di una nuova installazione, Portage andrebbe sincronizzato per assicurarsi che tutto sia aggiornato.

{{RootCmd|emerge --sync}}

Il sistema è ora pronto; sentitevi liberi di installare il software, modificare le impostazioni, testare pacchetti sperimentali e configurare senza avere alcun effetto sul sistema principale. Per lasciare il chroot è sufficiente digitare {{c|exit}} o premere {{Key|Ctrl}}+{{Key|d}}. In questo modo si tornerà nella console dell'ambiente normale. Non dimenticate di smontare ({{c|umount}}) le directories che sono state montate.

=== Script di init ===

Se impostare chroot è un lavoro che è necessario eseguire spesso, è possibile accelerare il montaggio delle directory utilizzando uno script init. Lo script dovrebbe essere aggiunto al runlevel di default e comunque impostato per l'esecuzione automatica all'avvio del sistema:

{{FileBox|filename=/etc/init.d/mychroot|lang=bash|1=
#!/sbin/openrc-run
 
depend() {
   need localmount
   need bootmisc
}
 
start() {
     ebegin "Mounting chroot directories"
     mount -o rbind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}
 
stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
}
}}

Quando si utilizza una directory o una partizione diversa, aggiungere i comandi di montaggio necessari nella funzione <code>start()</code> e variare {{Path|/mnt/chroot}} nel nome appropriato.

== Vedi anche ==

* [[Project:X86/Chroot Guide|Chroot Guide]]
* [[Chrooting_proxy_services|Chrooting proxy services]]


[[Category:Core system]]
