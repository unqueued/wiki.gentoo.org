This document describes how to install Gentoo without the hand holding automation features that users have come to take for granted over the last 10 years.
== Overview ==


=== Synopsis ===

Its possible to start with the offical stage3 files. This has only been tested on an amd64/no-multilib install.


{{Warning|Still reading ... don't say you were never warned. The usual caveat applies, if it breaks, you can keep the pieces. You might even try a post in Unsupported Software on the Gentoo Forums.}}
As this document is aimed at users with at least one Gentoo install to their credit, it is not a keystroke by keystroke guide, unlike the Handbook. The handbook steps are not repeated here, there is just some general references to it f$



=== Overview ===

The steps are:-
* partition the target drive following the handbook
* install the stage3 tarball
* install the portage snapshot
* set up package.mask to keep out unwanted junk
* set up global USE flags to be consistant with package.mask
* replace udev with sys-fs/static-dev
* follow the handbook to install cron, a logger and a bootloader of your choice
* Install a kernel
* configure grub
* review and edit configuaition settings
* reboot to test


=== Introduction ===

This document describes how to install Gentoo with a static /dev using the packages from a stage3 tarball


'''What You Get'''

A modern gentoo base system but without all the bells and whistles added in recent years. Olde Fashioned Gentooee is more about what you don't get. You dont get

* udev - you get a static dev
* systemd - why would you want it anyway
* pulseaudio - I've not known this to actually add anything
* hotplug support
* auto mounting of any sort - use mount by label
* auto module loading
* device detection in Xorg

Separate /usr should just work as there is no udev to require that /usr is mounted before udev starts. If udev starts on your box you have done someting wrong. Separate /usr is not tested as I'm using lvm on top of raid5, so while my /$

Access to the
[http://www.gentoo.org//doc/en/handbook/handbook-x86.xml Gentoo Handbook]
is required as this guide makes frequent references to it, there is no point in repeating the handbook here.
== Getting Started ==


=== Partitioning and Making Filesystems ===

'''Making Your Filesystem Tree'''

Follow the
[http://www.gentoo.org//doc/en/handbook/handbook-x86.xml Gentoo Handbook]
up to and including making your filesystems and mounting all the bits at /mnt/gentoo.

I will be using Logical Volumes on top of raid5 because its easier to recyle the volumes than it is with real partitions and if the logical volumes are the wrong size, they can be resized. I happen to have lvm on raid5 space free. This means that I will also describe the initramfs to get the raid assembled and Logical Volumes active. Users installing to real partitions should not need the initramfs.

== Chrooting ==


=== Making the chroot ===

Mount /proc and but not /dev inside the chroot. We will be using a static /dev, so we have to emerge dev-static With /dev bind mounted in the normal way, our static dev would go into the parents devtmpfs which is in RAM.

The stage3 tarball is provided with a static /dev that includes sda ... sdd inclusive. If you need more that that, use mknod to make the extra /dev entries. Likewise, there ale no md entries for raid or dm enteries for LVM.



{{CodeBox|title=Mounting Special Filesystems|<pre>
mount -t proc proc /mnt/gentoo/proc
</pre>
}}

=== Entering the chroot ===



{{CodeBox|title=Entering the chroot|<pre>
chroot /mnt/gentoo /bin/bash
</pre>
}}



{{CodeBox|title=Setting the chroot environment|<pre>
env-update
source /etc/profile
export PS1="(chroot) $PS1"
</pre>
}}



=== Setting up package.mask ===

This is important. Enter the package atoms that you do not want to be installed ever.

{{CodeBox|title=Content of package.mask|<pre>
# go back to a static /dev
sys-fs/eudev
sys-fs/udev
sys-auth/polkit
sys-auth/consolekit
media-sound/pulseaudio
sys-apps/systemd
</pre>
}}

Add in anything else you can think of they you really don't want. Always use -av with emerge and add more things as they come to mind. mdev might need to be there too.



=== Setting up package.use ===

This section is only required if you use raid, or lvm. You will need some packages built with the static USE flag.



{{CodeBox|title=Content of package.use|<pre>
# static bits and pieces for an initrd
sys-fs/lvm2 static
sys-fs/mdadm static
sys-apps/busybox static

</pre>
}}

Removing udev and Friends
There is a bug in the static-dev ebuild (Bug 469620) that prevents it installing if /proc/mounts reports that a dynamic /dev manager is in use.
Either patch static-dev in the overlay or unmount /proc from /mnt/gentoo/proc while static-dev is emerged.



{{CodeBox|title=Replacind udev with static-dev|<pre>
emerge -C sys-fs/udev
emerge sys-fs/static-dev ...see Bug 469620
emerge -p --depclean
</pre>
}}

emerge sys-fs/static-dev will report some file colisions. That is expected as some elements of a static /dev are provided by the stage3.

The last command should offer to remove

* sys-apps/hwids
* sys-fs/udev-init-scripts
* sys-libs/libcap
* dev-util/gperf
* virtual/udev

Let it run, they all depend on udev, which is no longer installed.

=== Setting USE= in make.conf ===

Some of my USE flags are AMD specific. The flags that are set off here are for avoidance of optional support for packages we have already masked.
Optional support being on would attempt to pull those packages in and emerge would complain about masked packages.

{{CodeBox|title=Use Flags|<pre>
USE="3dnow 3dnowext X alsa device-mapper apng mmx mmxext mp3 python sse sse2
     jpeg lock session startup-notification thunar
     curl ffmpeg odf pdf raw gtk cairo
     -consolekit -dso -firmware-loader -gbm -kmod  -ldap -networkmanager -nss -oss -qt 4-systemd -tools
     -udev -zeroconf"
</pre>
}}

-zeroconfig is a special case. Zeroconfig wasn't around 10 years ago so really should be excluded here.



=== Adding to /dev ===

static-dev is a good start but its not moved on in a very long time. Add some of the newer entries required. See /usr/src/linux/Documentation/devices.txt for a list

* mknod all of the /dev/sd* entries you need
* mknod any /dev/md* kernel multipe device entries required
* mknod any /dev/dm-X device mapper entries required
* mknod any /dev/srX devices for your optical drive(s)
* mknod any other /dev nodes you might want. They can be added at any time

Don't forget nodes for removable storage devices.
