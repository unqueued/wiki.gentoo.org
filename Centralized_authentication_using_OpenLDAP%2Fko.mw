<languages />


{{Metadata|abstract=이 안내서는 LDAP 기초를 소개하고 그룹과 젠투 머신 사이에 인증 목적으로 OpenLDAP 를 어떻게 설치하는지 보여드립니다.}}

이 안내서는 LDAP 기초를 소개하고 그룹과 젠투 머신 사이에 인증 목적으로 OpenLDAP 를 어떻게 설치하는지 보여드립니다.

== OpenLDAP 시작하기 ==

=== LDAP는 무엇인까요? ===

LDAP는 "경량 디렉터리 접근 프로토콜을 의미합니다. X.500을 기반하며 주된 기능의 대부분을 아우르고 있지만 X.500이 가진 일부 기능은 부족합니다. 자, 그러면 X.500은 무엇이고 왜 LDAP가 있는걸까요? 

X.500은 OSI 개념속의 디렉터리 서비스 모델입니다. 여기엔 이름 공간의 정의와 디렉터리 요청 및 업데이트를 위한 프로토콜이 들어가 있습니다. 그러나, X.500은 대부분의 시뮬레이션을 박살내놓고도 남았습니다. LDAP로 들어오십시오. X.500과 같이 디렉터리에 대한 데이터/이름 공간 모델과 프로토콜도 제공합니다. 그러나 LDAP는 TCP/IP 스택을 통해 동작하도록 설계했습니다. LDAP를 X.500에서 군더더기를 뺀 모습으로 보십시오. 

=== 잘 모르겠는데요. 디렉터리가 뭔가요? ===

A directory is a specialized database designed for frequent queries but infrequent updates. Unlike general databases they don't contain transaction support or roll-back functionality. Directories are easily replicated to increase availability and reliability. When directories are replicated, temporary inconsistencies are allowed as long as they get synchronised eventually. 

=== 정보가 어떻게 구성되어 있죠? ===

All information inside a directory is structured hierarchically. Even more, if you want to enter data inside a directory, the directory must know how to store this data inside a tree. Lets take a look at a fictional company and an Internet-like tree: 

{{Code|GenFic 조직 구조도, 비현실 속 젠투 회사|<pre>
dc:         com
             |
dc:        genfic         ## (Organisation)
          /      \
ou:   People   servers    ## (Organisational Units)
      /    \     ..
uid: ..   John            ## (OU-specific data)
</pre>
}}

Since you don't feed data to the database in this ascii-art like manner, every node of such a tree must be defined. To name such nodes, LDAP uses a naming scheme. Most LDAP distributions (including OpenLDAP) already contain quite a number of predefined (and general approved) schemes, such as the inetorgperson, a frequently used scheme to define users. 

Interested users are encouraged to read the [http://www.openldap.org/doc/admin24/ OpenLDAP Admin Guide] . 

=== 그래서 사용하는게 뭐죠? ===

LDAP can be used for various things. This document focuses on centralised user management, keeping all user accounts in a single LDAP location (which doesn't mean that it's housed on a single server, LDAP supports high availability and redundancy), yet other goals can be achieved using LDAP as well. 

* 공개 키 인프라스트럭처

* 공유 달력

* 공유 주소록

* DHCP, DNS등의 저장소

* 시스템 수준 설정 지시문(몇가지 서버 설정 유지)

* ...


== OpenLDAP 설정 ==


=== 초기 설정 ===

{{Note|In this document we use the genfic.com address as an example. You will ofcourse have to change this. However, make sure that the top node is an official top level domain (net, com, cc, be, ...).}}

먼저 OpenLDAP를 이머지 하기로 하겠습니다: 

{{Emerge|openldap}}

이제 다음에 사용할 암호화 처리한 암호를 만드십시오: 



{{RootCmd|slappasswd|output=<pre>
New password: my-password
Re-enter new password: my-password
{SSHA}EzP6I82DZRnW+ou6lyiXHGxSpSOw2XO4
</pre>
}}

{{Path|/etc/openldap/slapd.conf}}에 있는 LDAP 서버 설정을 편집하십시오. 아래 제공할 예제 설정 파일로 시작하십시오. 설정 파일의 자세한 분석은 OpenLDAP 관리자 안내서를 통해 진행해보십시오. 

{{Code|/etc/openldap/slapd.conf|<pre>
include	/etc/openldap/schema/core.schema
include /etc/openldap/schema/cosine.schema
include /etc/openldap/schema/inetorgperson.schema
include /etc/openldap/schema/nis.schema
include	/etc/openldap/schema/misc.schema
 
pidfile /var/run/openldap/slapd.pid
argsfile /var/run/openldap/slapd.args
 
serverID 0 ## Used in case of replication
loglevel 0
 
## ## Access Controls
access to dn.base="" by * read
access to dn.base="cn=Subschema" by * read
access to *
  by self write
  by users read
  by anonymous read
 
## ## Database definition
database hdb
suffix "dc=genfic,dc=com"
checkpoint 32 30
rootdn "cn=Manager,dc=genfic,dc=com"
rootpw "{SSHA}EzP6I82DZRnW+ou6lyiXHGxSpSOw2XO4" ## # See earlier slappasswd command
directory "/var/lib/openldap-ldbm"
index objectClass eq
 
## ## Synchronisation (pull from other LDAP server)
syncrepl rid=000
  provider=ldap://ldap2.genfic.com
  type=refreshAndPersist
  retry="5 5 300 +"
  searchbase="dc=genfic,dc=com"
  attrs="*,+"
  bindmethod="simple"
  binddn="cn=ldapreader,dc=genfic,dc=com"
  credentials="ldapsyncpass"
 
index entryCSN eq
index entryUUID eq
 
mirrormode TRUE
 
overlay syncprov
syncprov-checkpoint 100 10
</pre>
}}

다음 LDAP 클라이언트 설정 파일을 편집하십시오: 

{{RootCmd|nano -w /etc/openldap/ldap.conf|output=<pre>
## (Add the following...)
BASE         dc=genfic, dc=com
URI          ldap://ldap.genfic.com:389/ ldap://ldap1.genfic.com:389/ ldap://ldap2.genfic.com:389/
TLS_REQCERT  allow
TIMELIMIT    2
</pre>
}}

이제 {{Path|/etc/conf.d/slapd}}를 편집하고 다음 OPTS 줄을 설정하십시오: 

{{Code|/etc/conf.d/slapd|<pre>
OPTS="-h 'ldaps:// ldap:// ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock'"
</pre>
}}

마지막으로, {{Path|/var/lib/openldap-ldbm}} 구조를 만드십시오: 

{{RootCmd|mkdir -p /var/lib/openldap-ldbm
|chown ldap:ldap /var/lib/openldap-ldbm
|chmod 700 /var/lib/openldap-ldbm}}

slapd를 시작하십시오: 

{{RootCmd|/etc/init.d/slapd start}}

다음 명령으로 시험해볼 수 있습니다: 

{{Cmd|ldapsearch -x -D "cn{{=}}Manager,dc{{=}}genfic,dc{{=}}com" -W}}

오류를 보았다면 오류 메시지의 내용을 좀 더 보고 발생하는 문제를 해결하기 위해 <code>-d 255</code> 옵션을 추가하십시오. 

== 복제 ==

=== 고가용성이 필요한 경우 ===

고가용성을 필요로 하는 환경일 경우, 다중 LDAP 시스템에 걸친 변경 복제를 설정해야 합니다. OpenLDAP 내의 복제는 이 안내서에서 특정 복제 계정을 사용하여 설정하며(<code>ldapreader</code>), 첫번째 LDAP 서버에 대한 읽기 권한을 부여하고, 두번째 LDAP 서버에 첫번째 LDAP서버의 바뀐점을 보냅니다. 

두번째 LDAP 서버가 첫번째 서버의 동작과 유사한 동작을 허용한 상태에서 이 설정을 복제합니다. OpenLDAP의 내부 구조에 감사해야 할 일은 LDAP 구조상 바뀐 내용이 또 있다 할지라도 중복 적용하지 않습니다. 

=== 복제 설정 ===

복제를 설정하려면, 먼저 위에서 진행한 바와 같이 두번째 OpenLDAP 서버를 설정해야 합니다. 그러나, 설정 파일에 대해서는 다음을 신경쓰십시오. 

* ''동기화 복제 제공자''는 ''다른'' 시스템을 가리킵니다

* 각각의 OpenLDAP의 ''서버ID''는 다릅니다

Next, create the synchronisation account. We will create an LDIF file (the format used as data input for LDAP servers) and add it to each LDAP server: 

{{Cmd|slappasswd -s myreaderpassword|output=<pre>
 {SSHA}XvbdAv6rdskp9HgFaFL9YhGkJH3HSkiM
</pre>}}

{{Cmd|cat ldapreader.ldif|output=<pre>
dn: cn=ldapreader,dc=genfic,dc=com
userPassword: {SSHA}XvbdAv6rdskp9HgFaFL9YhGkJH3HSkiM
objectClass: organizationalRole
objectClass: simpleSecurityObject
cn: ldapreader
description: LDAP reader used for synchronization
</pre>}}

{{Cmd|ldapadd -x -W -D "cn{{=}}Manager,dc{{=}}genfic,dc{{=}}com" -f ldapreader.ldif|output=<pre>
Password: ## enter the administrative password
</pre>}}

== 클라이언트 설정 ==

=== 기존 데이터를 LDAP로 이전 ===

Configuring OpenLDAP for centralized administration and management of common Linux/Unix items isn't easy, but thanks to some tools and scripts available on the Internet, migrating a system from a single-system administrative point-of-view towards an OpenLDAP-based, centralized managed system isn't hard either. 

Go to [http://www.padl.com/OSS/MigrationTools.html http://www.padl.com/OSS/MigrationTools.html] and fetch the scripts there. You'll need the migration tools and the <code>make_master.sh</code> script. 

Next, extract the tools and copy the <code>make_master.sh</code> script inside the extracted location: 

{{RootCmd|mktemp -d|output=<pre>
/tmp/tmp.zchomocO3Q
</pre>}}

{{RootCmd|cd /tmp/tmp.zchomocO3Q
|tar xvzf /path/to/MigrationTools.tgz
|mv /path/to/make_master.sh MigrationTools-47
|cd MigrationTools-47</pre>}}

다음 단계는 시스템 정보를 OpenLDAP로 옮기는 것입니다. LDAP 구조와 환경에 대한 정보를 제공한 후 <code>make_master.sh</code> 스크립트로 이 과정을 진행하십시오. 

작성하는 도중에, 도구에서 다음 입력사항을 요구합니다: 

{| class="wikitable" style="text-align: left;" 
|- 
! 입력
! 설명
! 예제
|- 
| LDAP BaseDN
| 트리 기반 위치 (루트)
| dc=genfic,dc=com
|- 
| Mail domain
| 이메일 주소에 사용하는 도메인
| genfic.com
|- 
| Mail host
| 메일 서버 인프라스트럭처의 FQDN
| smtp.genfic.com
|- 
| LDAP Root DN
| LDAP 구조상 관리 계정 정보
| cn=Manager,dc=genfic,dc=com
|- 
| LDAP Root Password
| 이전 <code>slappasswd</code> 명령 결과와 비교한 관리 계정 암호
| 
|-
|}

또한 도구에서 옮길 계정과 설정이 어떤건지 물어봅니다. 

{{Warning/ko|pam.d/system-auth를 바꿀 필요는 없습니다}}

=== PAM 설정 ===

First, we will configure PAM to allow LDAP authorization. Install <code>sys-auth/pam_ldap</code> so that PAM supports LDAP authorization, and <code>sys-auth/nss_ldap</code> so that your system can cope with LDAP servers for additional information (used by {{Path|nsswitch.conf}}). 

{{Emerge|pam_ldap nss_ldap}}

이제 {{Path|/etc/pam.d/system-auth}}의 오른편에 다음 줄을 추가하십시오: 

{{Code|/etc/pam.d/system-auth|<pre>
## # Note: only add them. Don't kill stuff already in there or your box won't let you login again!
auth       sufficient   pam_ldap.so use_first_pass
account    sufficient   pam_ldap.so
password   sufficient   pam_ldap.so use_authtok use_first_pass
session    optional     pam_ldap.so
 
## # Example file:
#%PAM-1.0
 
auth       required     pam_env.so
auth       sufficient   pam_unix.so try_first_pass likeauth nullok
auth       sufficient   pam_ldap.so use_first_pass
auth       required     pam_deny.so
 
account    sufficient   pam_ldap.so
account    required     pam_unix.so
 
password   required     pam_cracklib.so difok=2 minlen=8 dcredit=2 ocredit=2 try_first_pass retry=3
password   sufficient   pam_unix.so try_first_pass use_authtok nullok md5 shadow
password   sufficient   pam_ldap.so use_authtok use_first_pass
password   required     pam_deny.so
 
session    required     pam_limits.so
session    required     pam_unix.so
session    optional     pam_ldap.so
</pre>
}}

이제 읽어들이도록 {{Path|/etc/ldap.conf}}를 바꾸십시오: 

{{Code|/etc/ldap.conf|<pre>
## #host 127.0.0.1
## #base dc=padl,dc=com
 
suffix          "dc=genfic,dc=com"
## #rootbinddn uid=root,ou=People,dc=genfic,dc=com
bind_policy soft
bind_timelimit 2
ldap_version 3
nss_base_group ou=Group,dc=genfic,dc=com
nss_base_hosts ou=Hosts,dc=genfic,dc=com
nss_base_passwd ou=People,dc=genfic,dc=com
nss_base_shadow ou=People,dc=genfic,dc=com
pam_filter objectclass=posixAccount
pam_login_attribute uid
pam_member_attribute memberuid
pam_password exop
scope one
timelimit 2
uri ldap://ldap.genfic.com/ ldap://ldap1.genfic.com ldap://ldap2.genfic.com
</pre>
}}

Next, copy over the (OpenLDAP) {{Path|ldap.conf}} file from the server to the client so the clients are aware of the LDAP environment: 

{{RootCmd|scp ldap-server:/etc/openldap/ldap.conf /etc/openldap}}

마지막으로 클라이언트를 설정하여 시스템 계정에 대해 LDAP를 검사하도록 하십시오: 

{{Code|/etc/nsswitch.conf|<pre>
passwd:         files ldap
group:          files ldap
shadow:         files ldap
</pre>
}}

If you noticed one of the lines you pasted into your {{Path|/etc/ldap.conf}} was commented out (the <code>rootbinddn</code> line): you don't need it unless you want to change a user's password as superuser. In this case you need to echo the root password to {{Path|/etc/ldap.secret}} in plaintext. This is '''DANGEROUS''' and should be chmoded to 600. What you might want to do is keep that file blank and when you need to change someone's password that's both in the ldap and {{Path|/etc/passwd}}, put the pass in there for 10 seconds while changing the users password and remove it when done.

== LDAP 서버 보안 설정 ==

=== OpenLDAP 권한 ===

If we take a look at {{Path|/etc/openldap/slapd.conf}} you'll see that you can specify the ACLs (permissions if you like) of what data users can read and/or write: 

{{Code|/etc/openldap/slapd.conf|<pre>
access to attrs=userPassword,gecos,description,loginShell
  by self write
  
access to *
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by users read
  by anonymous auth
</pre>
}}

This gives you access to everything a user should be able to change. If it's your information, then you got write access to it; if it's another user their information then you can read it; anonymous people can send a login/pass to get logged in. There are four levels, ranking them from lowest to greatest: <code>auth search read write</code> . 

The next ACL is a bit more secure as it blocks normal users to read other people their shadowed password: 

{{Code|/etc/openldap/slapd.conf|<pre>
access to attrs="userPassword"
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by dn="uid=John,ou=People,dc=genfic,dc=com" write
  by anonymous auth
  by self write
  by * none
 
access to *
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by dn="uid=John,ou=People,dc=genfic,dc=com" write
  by * search
</pre>
}}

This example gives root and John access to read/write/search for everything in the the tree below {{Path|dc{{=}}genfic,dc{{=}}com}} . This also lets users change their own <code>userPassword</code>'s. As for the ending statement everyone else just has a search ability meaning they can fill in a search filter, but can't read the search results. Now you can have multiple acls but the rule of the thumb is it processes from bottom up, so your toplevel should be the most restrictive ones.

== OpenLDAP로 작업하기 ==

=== 디렉터리 관리 ===

You can start using the directory to authenticate users in apache/proftpd/qmail/samba. You can manage it with phpldapadmin, diradm, jxplorer, or lat, which provide easy management interfaces. 

== 감사문 ==

이 안내서의 목적을 달성하기 위해 머신을 빌려준 Matt Heler에게 감사를 표합니다. 또한 #ldap @ irc.freenode.net의 대단한 분들께도 감사를 드립니다. 

== 감사문 ==

이 안내서에 제공한 노고에 대해 다음 작성자와 편집자분들께 감사의 말을 전하고자 합니다:

* Benjamin Coles

* swift

* Brandon Hale

* Benny Chuang

* jokey

* nightmorph


[[Category:Server and Security]]
