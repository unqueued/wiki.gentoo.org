<languages />

{{Dated|date=April 30, 2015}}

オーバーレイは、 Portage がソフトウェアを取扱う際に考慮する追加のリポジトリです。

Gentoo Linuxでは、ユーザには既に''Portage ツリー''と呼ばれる''メインの''リポジトリがあります。このメインのリポジトリは、Gentoo 開発者たちによって維持管理されている全てのソフトウェアパッケージ ([[Ebuild|ebuild]] と呼ばれているもの)で構成されています。しかしユーザは、この Portage ツリーに対して更に追加のリポジトリを付け加えることもできます。メインのツリーに対して覆い被せる("lay over")ことから、からこれを''overlay''と呼んでいます。

Since package repositories are nothing more (or less) than a set of files (ebuilds, metadata files, ChangeLog entries ...) these repositories can be pulled in from public repositories (git, cvs, svn ...) or downloaded as tarballs and extracted manually onto the system. It is advised to use managed repositories by ''trusted'' third parties; any installed overlay will cause Portage to look through the overlayed files when deciding which software to install. If compromised code is in the overlay, then compromised packages could be installed on the system.

== オーバーレイの取扱い ==

Portage は、変数 <code>PORTDIR_OVERLAY</code> を読み出して、システム内にインストールされたオーバーレイを組み込みます。この変数は、システム内のディレクトリパスの、空白文字で区切られたリストです。Portage は、指定されたこれらのディレクトリパスから、追加されているリポジトリのルートディレクトリを検出します。

=== 手作業でオーバーレイの場所を設定する ===

To make a personal overlay, create a location ({{Path|/usr/local/myportage}} for example) in which the packages Portage is to look for are located. Then add the <code>PORTDIR_OVERLAY</code> variable to the {{Path|/etc/portage/make.conf}} file containing the path to the location of the custom overlay.

{{FileBox|filename=/etc/portage/make.conf|title=Example 1 - Adding a custom overlay|lang=bash|1=
PORTDIR_OVERLAY="/usr/local/myportage" 
}}

ユーザのホームディレクトリに配置されているオーバーレイの例:

{{FileBox|filename=/etc/portage/make.conf|title=r例 2 - Adding a custom overlay|lang=bash|1=
PORTDIR_OVERLAY="/home/user/overlay" # /home が Portage から読み取れる必要があります。
}}

=== Add user to Portage group ===

To add a user to the <tt>portage</tt> group, use the <tt>gpasswd</tt> command like so:

{{RootCmd|gpasswd -a larry portage}}

[[Knowledge_Base:Adding_a_user_to_a_group|ユーザーをグループに追加する]] も参照してください。

=== crossdevを使う ===

[[crossdev]] will automatically place the ebuilds/categories it generates into the first overlay found in <code>PORTDIR_OVERLAY</code>. Most users will want to prevent [[crossdev]] from disturbing [[layman]]'s overlays or the user's personal per-machine overlay (normally created at {{Path|/usr/local/portage}}). Create an overlay specifically for [[crossdev]]'s use:

{{RootCmd|mkdir -p /usr/local/portage-crossdev/profiles
|echo local-crossdev > /usr/local/portage-crossdev/profiles/repo_name}}

そして、Portage と crossdev に対して、このオーバーレイを知らせます。

{{FileBox|filename=/etc/portage/make.conf|title=crossdev に ebuild を  local-crossdev に保存させ、他のオーバーレイより優先するようにする|lang=bash|1=
source /var/lib/layman/make.conf
PORTDIR_OVERLAY="/usr/local/portage-crossdev ${PORTDIR_OVERLAY} /usr/local/portage"
}}

{{FileBox|filename=/etc/portage/make.conf|title=layman を利用していない場合の、crossdev にローカルオーバーレイを破壊させない方法|lang=bash|1=
PORTDIR_OVERLAY="/usr/local/portage-crossdev /usr/local/portage"
}}

=== laymanを使う ===

複数のオーバーレイを簡単に管理するためには、[[Layman|layman]] というツールがつくられています。このツールは、著名なユーザが管理するオーバーレイやデベロッパのオーバーレイを認識し、それらを<code>PORTDIR_OVERLAY</code> で指定されている場所に追加したり、インストールや同期をしたりすることができます。

=== ローカルオーバーレイ ===

ローカルのオーバーレイの設定方法は、 [[Overlay/Local_overlay]] を参照してください。

=== オーバーレイの優先順位について ===

それぞれのオーバーレイは、固有の優先度を保持します。特定のバージョンが複数のオーバーレイ内に見つかって処理方法が不明確になった場合に備えるための仕様です。優先度のより高いオーバーレイ内の ebuild が、優先度の低いオーバーレイ内の ebuild に先んじて処理されます。

{{Note/ja|以下の''素直な''優先順位処理は、2011年1月に導入されたものです。それ以前には、正反対の順位付けがされていました。すなわち、数字の小さなものほど優先される仕様でした。}}

優先度を含んだオーバーレイのリストは、以下のコマンドの出力で得られます。

{{Cmd|emerge --info --verbose}}

<code>PORTDIR_OVERLAY</code> 変数が [[#Setting overlay priorities|下記]] のような方法で変更されていなければ、Gentoo Portage ツリーには -1000 という優先度が設定されます。すなわち、他のすべてのオーバーレイのほうが先んじて処理されます。この挙動は既定の仕様です。なぜなら、オーバーレイとは、portage ツリーの上に覆い被せる (''lay over/on top'') ように設計されたものなのですから。

==== オーバーレイの優先度を設定 ====

オーバーレイの優先度は、<code>PORTDIR_OVERLAY</code> 変数内での項目記載順で算出されます。portage は、変数内を左から右へ''歩き''、優先度を増やしていきます。最も左の項目が優先度 1 で始まり、その次の項目が 2 、以下同様です。

{{Note/ja|以前には {{Path|/etc/portage/repos.conf}} 内でオーバーレイの優先度を設定していたことがありました。これはもはや機能しません。}}

<code>PORTDIR_OVERLAY</code> 変数に portage ツリーの項目がないかぎりは、portage ツリーは常に優先度 -1000 に設定されます。
この優先度は、 <code>PORTDIR_OVERLAY</code> 変数内に <code>PORTDIR</code> を記載することで容易に変更することができます :

{{FileBox|filename=/etc/portage/make.conf|portage ツリーの優先度を明示的に設定|lang=bash|1=
PORTDIR_OVERLAY="/home/user/overlay ${PORTDIR}"
}}

上記の例では、ユーザのオーバーレイの優先度には 1 が割り当てられ、portage ツリーの優先度には 2 が割り当てられます。 

{{Note|If [[Layman|layman]] is used to manage overlays, then please refer to the article about [[Layman#Setting overlay priorities with layman|setting overlay priorities with layman]].}}

=== 安全性が確認されていないオーバーレイの使用 ===

巨大なオーバーレイや、よく知らない・低品質なオーバーレイを利用するなら、そのオーバレイ全体に対してハードマスクをかけるのが最善でしょう。

{{FileBox|filename=/etc/portage/package.mask|オーバーレイ内の全てのパッケージをマスクする|lang=bash|1=
*/*::overlay-name
}}

After that unmask the packages that will be installed.

{{FileBox|filename=/etc/portage/package.unmask|オーバーレイ内の特定パッケージのマスクを外す|lang=bash|1=
foo/bar::overlay-name
}}

この方法ならば、更新の際に何の不具合も起こらないでしょうし、優先順位をつける方法に比べて安全です。

== メタデータのキャッシュ ==

=== キャッシュの生成について ===

portage は、オーバーレイが多量にインストールされている場合には、パッケージの前提関係を解決するような処理に長い時間を要するかもしれません。これは、オーバーレイには一般的に、メタデータキャッシュが含まれていないためです。

Generate a local metadata cache by running <tt>emerge --regen</tt> after syncing the overlays:

{{RootCmd|layman -S
|emerge --regen}}

Be careful, because <tt>emerge --regen</tt> takes a lot of time and it's not recommended for rsync users as rsync updates the cache using server-side caches (most of users of portage are rsync users). Rsync users should simply run <tt>emerge --sync</tt> (or <tt>eix-sync</tt>) to regenerate the cache. It's probably only users of very large overlays should try <tt>emerge --regen</tt>.

=== eix との連動 ===

==== eix-sync ====

<tt>eix-sync</tt> は、オーバレイとportage ツリーを同期させた後に <tt>emerge --regen</tt> を実行することができます。

{{FileBox|filename=/etc/eix-sync.conf||lang=bash|1=
# すべてのオーバーレイの同期
*
  
# オーバーレイのメタデータを再生成
@emerge --regen {{!}}{{!}} true
}}

==== eix-update ====

<tt>eix-update</tt> は、 <tt>emerge --regen</tt> によって生成されたメタデータキャッシュを利用することで、高速化と精度向上を図ることができます。この機能を有効にするには、{{Path|/etc/eixrc/01-cache}} ファイルで <code>OVERLAY_CACHE_METHOD</code> 変数を "<code>assign</code>" に設定しましょう。

{{FileBox|filename=/etc/eixrc/01-cache|title=OVERLAY_CACHE_METHOD の設定|lang=bash|1=
OVERLAY_CACHE_METHOD="assign"
}}

== 参考 ==

* [[Project:Overlays]] - The official Gentoo project for overlays support.
* [[Project:Overlays/User_Guide]] - A user guide written by the Overlay project.


[[Category:Portage]]
