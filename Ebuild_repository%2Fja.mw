<languages />
'''オーバーレイは、 Portage がソフトウェアを取扱う際に考慮する追加のリポジトリです。'''

Gentoo Linuxでは、ユーザには既に「Portage ツリー」と呼ばれるメインのリポジトリがあります。このメインのリポジトリは、Gentoo 開発者たちによって維持管理されている全てのソフトウェアパッケージ ([[Ebuild|ebuild]] と呼ばれているもの)で構成されています。しかしユーザは、この Portage ツリーに対して更に追加のリポジトリを付け加えることもできます。メインのツリーに対して覆い被せる("lay over")ことから、からこれを"overlay"と呼んでいます。

パッケージのリポジトリは、 (ebuild や metadata ファイル、ChangeLog エントリなどの) ファイル群以外のなにものでもありません。したがって、こうしたリポジトリは、 (git や cvs、svn などでの)公開リポジトリから pull してくることもできますし、tar アーカイブでダウンロードしてきてシステムに手作業で展開することもできます。ただし、利用するならば、''信頼のおける''サードパーティにより管理されているリポジトリを推奨します。Portage は、インストールするソフトウェアを決定するにあたり、インストール済みオーバーレイのファイルをも読み出すからです。

== オーバーレイの取扱い ==

Portage は、変数 <code>PORTDIR_OVERLAY</code> を読み出して、システム内にインストールされたオーバーレイを組み込みます。この変数は、システム内のディレクトリパスの、空白文字で区切られたリストです。Portage は、指定されたこれらのディレクトリパスから、追加されているリポジトリのルートディレクトリを検出します。

=== 手作業でオーバーレイの場所を設定する ===

自分でオーバーレイを作成したいときはまず、 Portage に検出させたいパッケージを置く場所を作成します。そして、例えば <code>/home/user/overlay</code> を作成したならば、 {{Path|/etc/portage/make.conf}} 内に <code>PORTDIR_OVERLAY="/home/user/overlay"</code> と書き加えます。

{{File|/etc/portage/make.conf|手作業でオーバーレイを追加|<pre>
PORTDIR_OVERLAY="/home/user/overlay"
</pre>}}

=== crossdevを使う ===

[[crossdev]] は自動的に、<code>PORTDIR_OVERLAY</code> で設定されている最初のオーバーレイの中に ebuild と categories を生成します。[[crossdev]]が、 [[layman]] のオーバーレイや自分のマシン固有のオーバーレイ (通常は <code>/usr/local/portage</code> に作成される) を妨害するのを防ぎたいかもしれません。そのためには、 [[crossdev]] 専用のオーバーレイを作成するとよいでしょう:

{{RootCmd|mkdir -p /usr/local/portage-crossdev/profiles
|echo local-crossdev > /usr/local/portage-crossdev/profiles/repo_name}}

そして、portage と crossdev に対して、このオーバーレイを知らせます。

{{File|/etc/portage/make.conf|crossdev に ebuild を  local-crossdev に保存させ、他のオーバーレイより優先するようにする|<pre>
source /var/lib/layman/make.conf
PORTDIR_OVERLAY="/usr/local/portage-crossdev ${PORTDIR_OVERLAY} /usr/local/portage"
</pre>}}

{{File|/etc/portage/make.conf|Prevent crossdev from messing with your local overlay when not using layman|<pre>
PORTDIR_OVERLAY="/usr/local/portage-crossdev /usr/local/portage"
</pre>}}

=== laymanを使う ===

To make management of multiple overlays simple, a tool called [[Layman|layman]] is developed. This tool knows about popular user- and developer managed overlays and is able to install & synchronize them as well as add them to the <code>PORTDIR_OVERLAY</code> location.

=== ローカルオーバーレイ ===

ローカルのオーバーレイの設定方法は、 [[Overlay/Local_overlay]] を参照してください。

=== オーバーレイの優先度について ===

Each overlay has its unique priority. This makes sure that in the case of a specific version being found in several overlays, the resolution is unambiguous. Ebuilds from overlays with higher priorities take precedence over ebuilds from overlays with lower priorities.

{{Note|This "natural" way of priority handling was introduced in January 2011, before that the priority resolution order was reversed, so negative numbers used to stand for high priorities}}

The list of overlays with their priorities can be obtained through the output of the following command

{{Cmd|emerge --info --verbose}}

Unless the <code>PORTDIR_OVERLAY</code> variable has been modified as described [[#Setting overlay priorities|below]], the default gentoo portage tree will have a priority of -1000. That means that all other overlays take precedence. That is the default behavior, because overlays are designed to "lay over/on top" of the portage tree.

==== オーバーレイの優先順位を設定 ====

The overlay priority is calculated from the order of overlay entries in the <code>PORTDIR_OVERLAY</code> variable. Portage "walks" through the variable from left to right and increments the priority on the way. The leftmost entry starts with a priority of 1, the next entry has a priority of 2 and so on.

{{Note|Some time ago the overlay priority could be set in <code>/etc/portage/repos.conf</code>. This does not work anymore}}

Unless the <code>PORTDIR_OVERLAY</code> contains the portage tree entry, the portage tree will always be assigned a priority of -1000.
This can be easily changed by putting <code>PORTDIR</code> in the <code>PORTDIR_OVERLAY</code> variable:

{{File|/etc/portage/make.conf|Manual portage tree priority setting|<pre>
PORTDIR_OVERLAY="/home/user/overlay ${PORTDIR}"
</pre>}}

In the example above the user overlay will be assigned a priority of 1 and the portage tree will be assigned a priority of 2. 

{{Note|オーバーレイを管理する際に [[Layman|layman]] も利用しているなら、 [[Layman#Setting overlay priorities with layman|layman におけるオーバーレイの優先順位設定]] の記事も役に立つかもしれません。}}

=== 安全性が確認されていないオーバーレイの使用 ===

巨大なオーバーレイや、よく知らない・低品質なオーバーレイを利用するなら、そのオーバレイ全体に対してハードマスクをかけるのが最善でしょう。

{{File|/etc/portage/package.mask|オーバーレイ内の全てのパッケージをマスクする|<pre>
*/*::overlay-name
</pre>}}

その後に、emerge したい特定のパッケージだけのマスクを外します。

{{File|/etc/portage/package.unmask|オーバーレイ内の特定パッケージのマスクを外す|<pre>
foo/bar::overlay-name
</pre>}}

この方法ならば、更新の際に何の不具合も起こらないでしょうし、優先順位をつける方法に比べて安全です。

== メタデータのキャッシュ ==

=== キャッシュの生成について ===

portage は、オーバーレイが多量にインストールされている場合には、パッケージの前提関係を解決するような処理に長い時間を要するかもしれません。これは、オーバーレイには一般的に、メタデータキャッシュが含まれていないためです。

ローカルのメタデータキャッシュを生成するには、オーバーレイとの同期後に emerge --regen を実行してください。

{{RootCmd|layman -S
|emerge --regen}}

=== eix との連動 ===

==== eix-sync ====

eix-sync は、オーバレイとportage ツリーを同期させた後に <code>emerge --regen</code> を実行することができます。

{{File|/etc/eix-sync.conf||<pre>
# すべてのオーバーレイの同期
*
  
# オーバーレイのメタデータを再生成
@emerge --regen || true
</pre>}}

==== eix-update ====

eix-update は、 <code>emerge --regen</code> によって生成されたメタデータキャッシュを利用することで、高速化と精度向上を図ることができます。この機能を有効にするには、{{Path|/etc/eixrc/01-cache}} ファイルで <code>OVERLAY_CACHE_METHOD</code> 変数を "<code>assign</code>" に設定しましょう。

{{File|/etc/eixrc/01-cache|OVERLAY_CACHE_METHOD の設定|<pre>
OVERLAY_CACHE_METHOD="assign"
</pre>}}


[[Category:Portage]]
