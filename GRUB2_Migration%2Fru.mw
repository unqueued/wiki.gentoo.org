<languages />


{{Metadata|abstract=Цель данной статьи - предоставить читающему возможность простой миграции с GRUB Legacy на GRUB2.}}

Цель данной статьи - предоставить читающему возможность простой миграции с [[GRUB Legacy]] на [[GRUB2/ru|GRUB2]].

== Основы ==

=== Что такое GRUB? ===

GRUB это один из самых частоиспользуемых загрузчиков, который используется на всех компьютерах с Linux, кроме встраиваемых. Роль GRUB состоит в загрузке ядра Linux с диска в память, а также передаче ему управления. 

=== Зачем переходить? ===

Прежде всего, GRUB Legacy больше не поддерживается, и, поэтому, больше не обновляется. GRUB Legacy был создан в то время, когда разработчики могли сделать несколько предположений при разработке, которые сегодня являются ложными. Например, GRUB Legacy не может загружаться с дисков, размером больше, чем 2 Тб, и предполагает, что никакие новые файловые системы не заменят {{Path|/boot}}. 

GRUB2 стремится быть более ясным, более портируемым, более мощным, и имеет более чистую кодовую базу. GRUB2 поддерживает большее число конфигураций оборудования, большее число файловых систем, и большее число разметок диска, чем его предшественник. 

== Переход на GRUB2 ==

Переход на GRUB2 достаточно прост: он будет установлен в процессе обычного обновления системы пакетным менеджером. Если он не будет загружен автоматически, его всегда можно установить командой <code>sys-boot/grub:2</code>:

{{Emerge|sys-boot/grub:2}}

=== Устройство загрузки ===

Первая важная часть состоит в том, чтобы понять, какой диск загрузочный. Для тех, кто делал установку по Gentoo Handbook, это будет {{Path|/dev/sda}}. Если не уверены, то простой способ это проверить это посмотреть настройки установленного GRUB Legacy. Проверка файла {{Path|/boot/grub/grub.conf}} это основное место для проверки. 

{{Note|Убедитесь, что раздел {{Path|/boot}} смонтирован, чтобы эти файлы были доступны. Просто выполните команду
{{RootCmd|mount /boot}}
}}

Файл {{Path|grub.conf}} должен выглядеть примерно так:

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

На основании данного файла, можно узнать, что <code>(hd0)</code> это устройство загрузки, но нам нужно преобразовать его в настоящее устройство. Чтобы узнать это, просмотрите файл {{Path|/boot/grub/device.map}}. Пример такого файла приведен ниже. 

{{FileBox|filename=/boot/grub/device.map|1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note|Если подозреваете, что файл {{Path|/boot/grub/device.map}} неправилен, запустите следующую команду, чтобы пересоздать его:
{{RootCmd|grub-install --recheck /dev/sda}}
}}

На основании вышеприведенного файла, мы знаем, что {{Path|/dev/sda}} это устройство загрузки.

=== Установка и конфигурация GRUB2 ===

Следующим шагом будет установка и конфигурация GRUB2 в раздел {{Path|/boot}} без удаления GRUB Legacy из Master Boot Record (MBR). Пример ниже использует {{Path|/dev/sda}} — замените его на корректный путь к загрузочному диску.

Сперва установите необходимые файлы GRUB2 в каталог {{Path|/boot/grub}}.

{{RootCmd|grub-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{Warning|Параметр <code>--grub-setup{{=}}/bin/true</code> сообщает {{c|grub-install}}, чтобы он ''не'' устанавливал GRUB2 в MBR. Если этот параметр опущен, GRUB Legacy будет перезаписан и [[#Запуск GRUB2 из GRUB Legacy для тестирования настроек|запуск GRUB2 из GRUB Legacy]] в дальнейшем будет невозможен.}}

{{Note|Если GRUB2 был установлен с USE-флагом <code>multislot</code>, команда {{c|grub-install}} будет все еще ссылаться на GRUB Legacy. В этом случае используйте команду {{c|grub2-install}}, и используйте команду {{c|grub2-mkconfig}} вместо команды {{c|grub-mkconfig}} на следующем шаге.}}

Теперь мы можем просканировать доступные ядра и сгенерировать соответствующий конфигурационный файл {{Path|/boot/grub/grub.cfg}}. Пропустите этот шаг, если делали [[GRUB2_Quick_Start/ru#Ручная настройка|ручную настройку]].

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Warning|GRUB2 использует файл конфигурации {{Path|/boot/grub/grub.'''cfg'''}}, в то время как GRUB Legacy использует {{Path|/boot/grub/grub.'''conf'''}}, поэтому, пожалуйста, удостоверьтесь, что по ошибке не используется старый файл, например, при использовании автодополнения по tab, если, конечно, старые файлы уже не стерты.}}

{{Note|{{c|grub-mkconfig}} имеет строгие требования к названиям образов ядра и initramfs. Ядро должно называться <code>kernel-${version}</code> или <code>vmlinuz-${version}</code>, а initramfs должен называться <code>initramfs-${version}.img</code>, <code>initramfs-genkernel-${version}</code>, <code>initramfs-genkernel-${arch}-${version}</code>, <code>initrd-${version}.img</code>, <code>initrd.img-${version}</code>, <code>initrd-${version}.gz</code>, либо <code>initrd-${version}</code>. Эти файлы должны находиться в {{Path|/boot}}.}}

{{Note|Файл {{Path|/etc/default/grub}} контролирует работу {{c|grub-mkconfig}}. Если необходимо передать ядру параметр (например при использовании genkernel и загрузке с LVM или RAID-массива), необходимо отредактировать данный файл перед генерацией {{Path|/boot/grub/grub.cfg}}. Например, это можно сделать так:
{{RootCmd|nano /etc/default/grub}}
Посмотрите статью о [[GRUB2/ru#Конфигурация|настройке GRUB2]] на Gentoo Wiki, либо [http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html официальное руководство по GRUB2], чтобы решить, как правильно модифицировать файл. Большинству пользователей понадобится изменить <code>GRUB_CMDLINE_LINUX</code>, чтобы указать параметры, передаваемые в командной строке ядра.}}

=== Запуск GRUB2 из GRUB Legacy для тестирования настроек ===

Так как из-за неправильной конфигурации GRUB вы можете получить незагружающуюся систему, давайте проверим конфигурацию GRUB2, прежде чем сделаем ее постоянной. Чтобы это сделать, мы запустим GRUB2 из GRUB Legacy. Это можно сделать, добавив новый раздел к файлу {{Path|/boot/grub/grub.conf}}. Пример показан ниже. 

{{Note|Заметьте, что корневая система может быть и не на <code>(hd0,0)</code>, который мы использовали в примере. Удостоверьтесь, что она совпадает со значением из конфигурационного файла {{Path|/boot/grub/grub.conf}}.}}

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

Теперь необходимо перезагрузить компьютер, и выбрать <code>GRUB2 Chainload</code> из меню GRUB, когда машина начнет загрузку. Отобразится другое меню GRUB, которое должно назваться как GRUB 2.0.0, или выше, в верхней части экрана, и показать существующие ядра для загрузки. Если это не заработает, просто перезагрузите систему, и выберите нормальную опцию загрузки, вместо <code>GRUB2 Chainload</code>. 

=== Замена и удаление GRUB Legacy ===

Если все хорошо работает, можно заменить GRUB Legacy, и удалить его из системы. 

{{Warning|Так как система была только что перезагружена, необходимо снова смонтировать {{Path|/boot}}. Проверьте, что используете именно правильное загрузочное устройство, и не {{Path|/dev/sda}}, хотя это всего лишь пример. Если {{Path|/boot}} не смонтирован до запуска {{c|grub-install}}, то система может стать не загружаемой.}}

{{Note|Как ранее упоминалось, если GRUB2 был установлен с USE-флагом <code>multislot</code>, то будет использоваться  {{c|grub2-install}} заместо {{c|grub-install}}. В этом случае после удаления GRUB Legacy в следующем шаге, GRUB2 должен быть переустановлен без USE-флага <code>multislot</code>, так чтобы {{c|grub-install}} и {{c|grub-mkconfig}} стали командами GRUB2.}}

{{RootCmd|grub-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

Сейчас можно воспользоваться пакетным менеджером, чтобы удалить <code>sys-boot/grub:0</code>. 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

Миграция теперь завершена.

== Поддержка GRUB2 ==

После установки нового ядра, нужно выполнить следующий шаг, чтобы удостовериться, что конфигурация GRUB2 определяет новое ядро (если только не используете [[GRUB2_Quick_Start/ru#Ручная_настройка|ручную настройку]]). 

{{Note|Убедитесь, что раздел {{Path|/boot}} смонтирован до выполнения следующей команды.}}

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
