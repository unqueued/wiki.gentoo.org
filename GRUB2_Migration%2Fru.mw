<languages />


{{Metadata|abstract=Цель данной статьи - предоставить читающему возможность простой миграции с GRUB Legacy на GRUB2.}}

Цель данной статьи - предоставить читающему возможность простой миграции с GRUB Legacy на GRUB2.

== Основы ==

=== Что такое GRUB? ===

GRUB это один из самых частоиспользуемых загрузчиков, который используется на всех компьютерах с Linux, кроме встраиваемых. Роль GRUB состоит в загрузке ядра Linux с диска в память, а также передаче ему управления. 

=== Зачем переходить? ===

Прежде всего, GRUB Legacy больше не поддерживается, и, поэтому, больше не обновляется. GRUB Legacy был создан в то время, когда разработчики могли сделать несколько предположений при разработке, которые сегодня являются ложными. Например, GRUB Legacy не может загружаться с дисков, размером больше, чем 2 Тб, и предполагает, что никакие новые файловые системы не заменят {{Path|/boot}}. 

GRUB2 стремится быть более ясным, более портируемым, более мощным, и имеет более чистую кодовую базу. GRUB2 поддерживает большее число конфигураций оборудования, большее число файловых систем, и большее число разметок диска, чем его предшественник. 

== Переход на GRUB2 ==

Переход на GRUB2 достаточно прост: он будет установлен в процессе обычного обновления системы пакетным менеджером. Если он не будет загружен автоматически, его всегда можно установить командой <code>sys-boot/grub:2</code>:

{{Emerge|sys-boot/grub:2}}

=== Устройство загрузки ===

The first important part is to understand which drive is bootable. For those who followed the Gentoo Handbook it should be {{Path|/dev/sda}}. For those who are uncertain, the easiest way to find out is to look at the existing GRUB Legacy configuration. Viewing the {{Path|/boot/grub/grub.conf}} file is the main place to check. 

{{Note|Убедитесь, что раздел {{Path|/boot}}, чтобы эти файлы были доступны. Это достаточно просто - как выполнить команду
{{RootCmd|mount /boot}}
}}

The {{Path|grub.conf}} will look something like this:

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

Based on the above file it is possible to know that <code>(hd0)</code> is the boot drive but we must map this to a real device. To know this, look at the {{Path|/boot/grub/device.map}} file. An example one is provided below. 

{{FileBox|filename=/boot/grub/device.map|1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note|When suspecting that {{Path|/boot/grub/device.map}} is not accurate, run {{c|grub-install --recheck /dev/sda}} to recreate the file.}}

На основании вышеприведенного файла, мы знаем, что {{Path|/dev/sda}} это устройство загрузки.

=== Установка и конфигурация GRUB2 ===

The next step is to install and configure GRUB2 for the {{Path|/boot}} partition without removing GRUB Legacy from the drive's MBR. The example below uses {{Path|/dev/sda}} - replace it with the correct boot drive path. The first step installs the necessary GRUB2 files to {{Path|/boot/grub}}, while the second step scans the available kernels and generates a suitable config file to {{Path|/boot/grub/grub.cfg}}. Skip the second step when using a [[GRUB2_Quick_Start#Manual_configuration|Manual Configuration]].

{{Warning|GRUB 2 uses the configuration file {{Path|/boot/grub/grub.'''cfg'''}} whereas GRUB Legacy used {{Path|/boot/grub/grub.'''conf'''}} so please make sure not to use the old file by mistake, e.g. by using tab-completion if the old file is still there.}}

{{RootCmd|grub2-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Note|<code>grub2-mkconfig</code> имеет строгие требования к названиям образов ядра и initramfs. Ядро должно называться <code>kernel-${version}</code> или <code>vmlinuz-${version}</code>, а initramfs должен называться <code>initramfs-${version}.img</code>, <code>initramfs-genkernel-${version}</code>, <code>initramfs-genkernel-${arch}-${version}</code>, <code>initrd-${version}.img</code>, <code>initrd.img-${version}</code>, <code>initrd-${version}.gz</code>, либо <code>initrd-${version}</code>. Вместе с ${version}, имя файла должно соответствовать нужному ядру, которое находится в {{Path|/boot}}.}}

{{Note|The file {{Path|/etc/default/grub}} controls the operation of <code>grub2-mkconfig</code>. If parameters need to be passed on to the kernel (for instance when using genkernel and booting from LVM or software RAID), edit that file before generating {{Path|/boot/grub/grub.cfg}} like so:
{{RootCmd|nano /etc/default/grub}}
Have a look at [[GRUB2#Configuration|the GRUB2 configuration]] on the Gentoo Wiki or at the [http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html grub2 manual] to decide how to modify the file. Most users will need to change the <code>GRUB_CMDLINE_LINUX</code> parameter.}}

=== Запуск GRUB2 из GRUB Legacy для тестирования настроек ===

Так как из-за неправильной конфигурации GRUB вы можете получить незагружающуюся систему, давайте проверим конфигурацию GRUB2, прежде чем сделаем ее постоянной. Чтобы это сделать, мы запустим GRUB2 из GRUB Legacy. Это можно сделать, добавив новый раздел к файлу {{Path|/boot/grub/grub.conf}}. Пример показан ниже. 

{{Note|Be aware that the root partition may be different from <code>(hd0,0)</code> used in the example, and make sure to reuse the same root value from the {{Path|/boot/grub/grub.conf}} configuration file.}}

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

At this point the machine should be rebooted, and <code>GRUB2 Chainload</code> selected from the GRUB menu when the machine begins to boot. Another GRUB menu will be presented which should advertise itself as GRUB 2.0.0 or higher at the top and show the available kernel(s) to boot. Should this not work, simply reboot the system and pick the normal boot option instead of <code>GRUB2 Chainload</code>. 

=== Замена и удаление GRUB Legacy ===

At this point, if everything worked successfully, replace GRUB Legacy and remove it from the system. 

{{Warning|Since the system has been rebooted, it might be necessary to mount {{Path|/boot}} again. Make sure to use the right boot drive path instead of {{Path|/dev/sda}} as this is merely an example. If {{Path|/boot}} is not mounted before running {{c|grub2-install}}, the system will become unbootable}}

{{RootCmd|grub2-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

At this point use the package manager to remove <code>sys-boot/grub:0</code>. 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

Миграция теперь завершена.

== Поддержка GRUB2 ==

Whenever a new kernel is installed, perform the next step so that the GRUB2 configuration recognizes the new kernel (except when using a [[GRUB2_Quick_Start#Manual_configuration|manual configuration]]). 

{{Note|Для данного шага раздел {{Path|/boot}} должен быть смонтирован.}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
