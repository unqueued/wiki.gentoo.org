<languages />

{{Metadata|abstract=Puppet это система управления конфигурациями, написанная на языке программирования Ruby. Она может использоваться для автоматизации развертывания системы на новых машинах.}}

{{InfoBox stack
|{{InfoBox homepage|https://puppetlabs.com/puppet/puppet-open-source|header=true}}
|{{InfoBox wikipedia|Puppet (software)}}
|{{InfoBox ohloh}}
}}

'''Puppet''' - это система управления конфигурациями, написанная на языке программирования [[Ruby]]. Она может использоваться для автоматизации развертывания системы на новых машинах.

== Установка ==

Puppet предоставляется пакетом Gentoo {{Package|app-admin/puppet}}.

На данный момент, не существует разницы между клиентом и сервером, поэтому основная процедура установки для них одна и та же.

=== Emerge ===

Для начала, установите Puppet с помощью {{c|emerge}}:

{{Emerge|app-admin/puppet}}

== Конфигурация и настройка ==

В основном, Puppet конфигурируется через файл {{Path|/etc/puppet/puppet.conf}}, написанный в стиле формата ini. Комментарии отмечены знаком решетки (<code>#</code>).

Файл конфигурации разбит на несколько разделов, или блоков:

* <code>[main]</code> содержит настройки, которые действуют по умолчанию для всех частей Puppet, до тех пор, пока они не переписываются настройками в каком-либо из следующих разделов:
** <code>[master]</code> используется для настроек, касающихся Puppetmaster ({{c|puppet master}}), или утилиты CA ({{c|puppet cert}})
** <code>[agent]</code> используется для настроек, касающихся Puppet agent ({{c|puppet agent}}).

Более глубокое объяснение, вместе со списком дальнейших блоков, доступно в [http://docs.puppetlabs.com/guides/configuring.html официальной документации Puppet]. Также, существует [http://docs.puppetlabs.com/references/stable/configuration.html список всех параметров конфигурации], некоторые из которых, конечно же, имеют смысл только тогда, когда применяются или к серверу, или к клиенту.

=== Настройка (Puppetmaster) сервера ===

Настройки по умолчанию, помещенные ebuild-файлом в {{Path|puppet.conf}} могут использоваться как есть. Для Puppet 2.7.3, части, относящиеся к серверу выглядят следующим образом:

{{FileBox|filename=/etc/puppet/puppet.conf|title=Конфигурация по умолчанию, относящаяся к серверу|lang=ini|1=
[main]
    # Каталог логов Puppet.
    # Значение по умолчанию '$vardir/log'.
    logdir = /var/log/puppet

    # Место, где хранятся pid-файлы Puppet.
    # Значение по умолчанию '$vardir/run'.
    rundir = /var/run/puppet

    # Место, где хранятся  SSL-сертификаты.
    # Значение по умолчанию '$confdir/ssl'.
    ssldir = $vardir/ssl
}}

==== Настройка файлового сервера ====

Для того, чтобы отправить клиентам файлы, файловый сервер должен быть сконфигурирован в {{Path|/etc/puppet/fileserver.conf}}. По умолчанию, туда не включено ни одного файла.

{{FileBox|filename=/etc/puppet/fileserver.conf|title=Настройка общего <tt>файлового</tt> ресурса|lang=ini|1=
[files]
    path /var/lib/puppet/files
    allow 192.168.0.0/24
}}

Фрагмент выше настраивает общий ресурс с названием <tt>files</tt> (запомните этот идентификатор, так как на него будет необходимо сослаться в дальнейшем), осуществляющий поиск файлов в {{Path|/var/lib/puppet/files}} и доступный только для хостов сети 192.168.0.0/24. Здесь можно использовать любые ip-адреса, бесклассовую адресацию, и имена хостов (включая шаблонные знаки, наподобие <code>*.domain.invalid</code>). Команда <tt>deny</tt> может использоваться для явного запрета доступа к определенным компьютерам или диапазонам IP-адресов.

==== Запуск демона puppetmaster ====

{{Note|Рекомендуется, чтобы Puppetmaster был доступен с клиентов, использующих имя хоста <code>puppet</code>. Однако, имя может быть переопределено, что, конечно же, требует переконфигурацию.}}

{{Important|На этот момент, имя хоста, в том виде, в каком оно доступно клиентам, должно быть таким же, как и вывод команды {{c|hostname -f}}. Чтобы достичь этого необходимо поправить {{Path|/etc/hosts}} или вручную создать новый сертификат [[#.D0.93.D0.B5.D0.BD.D0.B5.D1.80.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D1.81.D0.B5.D1.80.D1.82.D0.B8.D1.84.D0.B8.D0.BA.D0.B0.D1.82.D0.BE.D0.B2_.D0.B2.D1.80.D1.83.D1.87.D0.BD.D1.83.D1.8E|как описано ниже]].}}

С этой базовой конфигурацией, вместе с первоначальными настройками файлового сервера, мы можем запустить демон Puppetmaster с помощью его OpenRC init-скрипта:

{{RootCmd|/etc/init.d/puppetmaster start}}

Во время первого запуска, Puppet генерирует SSL сертификат для хоста Puppetmaster и размещает его в каталоге, который указан в переменной <var>ssldir</var>, как было показано в конфигурации выше.

Он слушает порт <code>8140/TCP</code>; убедитесь, что настройки межсетевого экрана не запрещают доступ клиентам.

==== Простой манифест ====

В терминах Puppet, манифестом называются файлы, в которых указана конфигурация клиента.
Документация содержит [http://docs.puppetlabs.com/guides/language_guide.html исчерпывающее руководство] по языку разметки манифеста.

В качестве простого примера, давайте создадим файл с сообщением дня (message of the day, сокращенно motd) на клиенте. На puppetmaster, создайте файл внутри общего файлового ресурса <tt>files</tt>, созданного ранее:

{{FileBox|filename=/var/lib/puppet/files/motd|title=MOTD-файл на сервере|1=
Добро пожаловать на эту машину под управлением Puppet!
}}

Затем, нам необходимо создать основной файл манифеста в каталоге {{Path|manifests}}. Он называется <tt>site.pp</tt>:

{{FileBox|filename=/etc/puppet/manifests/site.pp|title=Основной файл манифеста на сервере|lang=ruby|1=
node default {
  file { '/etc/motd':
    source => 'puppet:///puppet/files/motd'
  }
}
}}

Определение узла по умолчанию - <tt>default</tt> ''node'' (или, имя клиента), используется в случае, когда специальное объявление узла (<tt>node</tt>) отсутствует. 
Мы используем общий файловый ресурс и хотим, чтобы файл {{Path|/etc/motd}} содержал то же самое, что и файл на общем ресурсе <tt>files</tt> на хосте <code>puppet</code>. Если сервер с puppetmaster доступен под другим именем хоста, то необходимо исправить <tt>source</tt> URI соответственно.

=== Конфигурация клиента ===

{{Important|Клиент '''должен''' иметь '''те же самые главное и второстепенное число релиза''' как и Puppetmaster. Использование Puppetmaster 2.7.1 с клиентами 2.7.2 не запрещается, но использование 2.6 для сервера и 2.7 для клиентов может вызвать неожиданные проблемы в любой момент.}}

{{Note|Если puppetmaster не доступен под <code>puppet</code> именем, то установите <code>server{{=}}&lt;имя хоста&gt;</code> на действительное имя хоста в {{Path|/etc/puppet/puppet.conf}} в разделе <code>[main]</code>.}}

Во время первого запуска Puppet agent, нужно подождать, пока сертификат будет подписан puppetmaster. Для того, чтобы запросить сертификат и выполнить первый проход конфигурации, запустите:

{{RootCmd|puppet agent --test --waitforcert 60|prompt=root@client #
|output=<pre>
info: Creating a new certificate request for client
info: Creating a new SSL key at /var/lib/puppet/ssl/private_keys/client.pem
notice: Did not receive certificate
</pre>}}

Перед тем, как клиент сможет соединиться, необходимо авторизировать запрос сертификата на сервере. Клиент должен появиться в списке узлов, запрашивающих сертификат:

{{RootCmd|puppet cert --list
|prompt=root@server #
|output=client}}

Теперь, мы разрешаем запрос:

{{RootCmd|puppet cert --sign client
|prompt=root@server #}}

Клиент будет проверять каждые 60 секунд, выпущен ли уже его сертификат. После этого, он продолжит первый проход конфигурации:

{{GenericCmd|<pre>
info: Caching catalog for client
info: Applying configuration version '1317317379'
notice: /Stage[main]//Node[default]/File[/etc/motd]/ensure: defined content as '{md5}30ed97991ad6f591b9995ad749b20b00'
notice: Finished catalog run in 0.05 seconds
</pre>}}

Если это сообщение появляется, то все прошло хорошо. Теперь проверьте содержимое файла {{Path|/etc/motd}} на клиенте:

{{Cmd|cat /etc/motd
|prompt=user@client $
|output=Добро пожаловать на эту машину под управлением Puppet!}}

==== OpenRC ====

Теперь, можно запустить puppet agent в качестве демона, и запускать его каждый раз при загрузке:

{{RootCmd|/etc/init.d/puppet start
|rc-update add puppet default
|prompt=root@client #}}

==== Systemd ====

С другой стороны, при запущенном systemd:

{{RootCmd|systemctl start puppet
|systemctl enable puppet
|prompt=root@client #}}

== Другие темы ==

=== Генерирование сертификатов вручную ===

Для того, чтобы создать сертификат вручную можно использовать утилиту {{c|puppet cert}}. Она разместит все сгенерированные сертификаты в каталоге, который указан в переменной <var>ssldir</var>, так, как установлено в конфигурации puppet, и подпишет их ключом локального центра сертификации (CA).

Легким случаем является генерация сертификата с '''только одним именем сертификата - Common Name:'''

{{RootCmd|puppet cert --generate host1}}

Если требуются '''множественные имена хоста''', для которых этот сертификат действителен, используйте параметр <code>--certdnsnames</code> и отделите дополнительные имена хоста двоеточием:

{{RootCmd|puppet cert --generate --certdnsnames puppet:puppet.domain.invalid host1.domain.invalid}}

Этот пример сгенерирует сертификат, действительный для трех перечисленных имен хоста.

=== Обновление сертификата у агента ===

Это процесс обновления сертификата у агента.

# (on master) {{RootCmd|puppet cert clean ${AGENT_HOSTNAME} }}
# (on agent) {{RootCmd|rm /etc/puppet/ssl/{certs,certificate_requests}/${AGENT_HOSTNAME}.pem}}
#* This will cause the Puppet agent to regenerate the CSR with the existing SSL key.
#* The old certificate is no longer valid, as it was nuked on the master.
#* When one of the above steps is forgotten, an error will pop up about the certificate mis-matching between agent and master.
#* To replace the SSL keys (optional): {{RootCmd|rm /etc/puppet/ssl/{public,private}_keys/${AGENT_HOSTNAME}.pem}}
# (on agent) {{RootCmd|puppet agent --onetime --no-daemonize --verbose --test --waitforcert 30}}
#* When using auto-signing, no further steps are needed.
# (on master) {{RootCmd|puppet cert list ${AGENT_HOSTNAME} }}
# Verify that the fingerprint listed in the previous two outputs matches
# (on master) {{RootCmd|puppet cert sign ${AGENT_HOSTNAME} }}
# (on agent) {{RootCmd|puppet agent --onetime --no-daemonize --verbose --test}}

=== Управление слотами с puppet ===

По умолчанию portage предоставляемый в puppet не поддерживает слоты, но существуют модули puppet, у которых есть данная функциональность.

For instance, with {{Package|app-admin/puppet}} version 4.6.0 and higher, and/or {{Package|app-admin/puppet-agent}}, the slot functionality is supported like to:

{{CodeBox|title=Defining an absent slotted package|1=
    package { 'dev-lang/python:3.3': ensure => absent }
}}

Дополнительные модули:
* [https://github.com/gentoo/puppet-portage puppet-portage]
* [https://github.com/whatbox/PortageGT PortageGT]

== Смотрите также ==

* [[Puppet module for Gentoo|Модуль puppet для Gentoo]]

== Внешние ресурсы ==

* [http://puppetlabs.com/ Upstream website]
* [http://projects.puppetlabs.com/projects/puppet/wiki Puppet Wiki]


[[Category:Server]]
[[Category:Security]]
