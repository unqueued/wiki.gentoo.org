<languages />


{{Metadata|abstract=Le but de ce guide est d'aider les lecteurs à migrer en douceur de GRUB Legacy vers GRUB2.}}

The goal of this guide is to provide readers with a smooth migration from [[GRUB Legacy]] to [[GRUB2]].

== Contexte ==

=== Qu'est-ce que GRUB? ===

GRUB est l'un des chargeurs de démarrage les plus courants sur les systèmes non-embarqués. Le rôle de GRUB est de faciliter le chargement et le choix du noyau Linux depuis le disque dur vers la mémoire et de commencer à exécuter le noyau Linux. 

=== Pourquoi migrer? ===

En premier lieu, parce que GRUB Legacy n'est plus maintenu et n'est donc plus actualiser. GRUB Legacy a été créé à une époque où les développeurs pouvaient faire certaines suppositions qui ne sont plus valables de nos jours. Par exemple, GRUB Legacy ne sait pas démarrer depuis des disques d'une taille supérieure à 2 TO et présuppose que de nouveaux systèmes de fichiers ne viendront pas remplacer {{Path|/boot}}. 

GRUB2 cherche à être plus robuste, plus portable et plus puissant. De plus il est maintenu sur une base de code plus saine. GRUB2 prend en charge un plus grand nombre de configurations matérielles, plus de types de systèmes de fichiers et plus d'agencements de disques que son prédécesseur. 

== Migration vers GRUB2 ==

La migration vers GRUB2 est assez directe : il sera installé comme partie du processus de mise à jour habituelle par le gestionnaire de paquets. S'il n'est pas installé automatiquement, il est toujours possible de le faire à la main en utilisant <code>sys-boot/grub:2</code>.

{{Emerge|sys-boot/grub:2}}

=== Disque de Démarrage ===

Il est avant tout primordial de savoir quel est le disque amorçable (bootable). Pour ceux qui ont suivit le manuel de Gentoo, il s'agit de  {{Path|/dev/sda}}. En cas d'incertitudes, le moyen le plus aisé de le savoir, est de regarder la configuration de GRUB Legacy. Vérifier le fichier {{Path|/boot/grub/grub.conf}}. 

{{Note|Assurez-vous que la partition {{Path|/boot}}  est monté pour être en mesure de voir ces fichiers.
Pour Monter la partition ː
{{RootCmd|mount /boot}}
}}

{{Path|grub.conf}} ressemblera plus ou moins a ceci:

{{FileBox|filename=/boot/grub/grub.conf||1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

En vous appuyant sur le fichier ci-dessus, il est possible de savoir que <code>(hd0)</code> est le disque de démarrage mais il faut l'associer à un périphérique réel. Pour connaître cette information, il faut regarder  {{Path|/boot/grub/device.map}}. En voici un exemple : 

{{FileBox|filename=/boot/grub/device.map||1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note|Si vous pensez que {{Path|/boot/grub/device.map}} est incorrect, exécuter la commande suivante pour recréer ce fichier ː
{{RootCmd|grub-install --recheck /dev/sda}} }}

En vous appuyant sur le fichier ci-dessus, vous savez que votre disque de démarrages est  {{Path|/dev/sda}}.

=== Installer et configurer GRUB2 ===

The next step is to install and configure GRUB2 for the {{Path|/boot}} partition without removing GRUB Legacy from the drive's Master Boot Record (MBR). The example below uses {{Path|/dev/sda}} — replace it with the correct boot drive path.

First install the necessary GRUB2 files to {{Path|/boot/grub}}.

{{RootCmd|grub-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{Warning|The option <code>--grub-setup{{=}}/bin/true</code> tells {{c|grub-install}} to ''not'' install GRUB2 in the MBR. If this option is omitted, GRUB Legacy will be overwritten and [[#Chainloading GRUB2 from GRUB Legacy to test the setup|chainloading GRUB2 from GRUB Legacy later on]] will not be possible.}}

{{Note|If GRUB2 was emerged with the <code>multislot</code> USE flag, the {{c|grub-install}} command will still refer to GRUB Legacy. In this case, use {{c|grub2-install}} instead — and use {{c|grub2-mkconfig}} in place of {{c|grub-mkconfig}} in the next step.}}

Now we can scan the available kernels and generate a suitable config file to {{Path|/boot/grub/grub.cfg}}. Skip this step when using a [[GRUB2_Quick_Start#Manual_configuration|Manual Configuration]].

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Warning|GRUB2 uses the configuration file {{Path|/boot/grub/grub.'''cfg'''}} whereas GRUB Legacy used {{Path|/boot/grub/grub.'''conf'''}} so please make sure not to use the old file by mistake, e.g. by using tab-completion if the old file is still there.}}

{{Note|{{c|grub-mkconfig}} has strict naming requirements for kernels and initramfs images. A kernel must be named <code>kernel-${version}</code> or <code>vmlinuz-${version}</code> while an initramfs must be named <code>initramfs-${version}.img</code>, <code>initramfs-genkernel-${version}</code>, <code>initramfs-genkernel-${arch}-${version}</code>, <code>initrd-${version}.img</code>, <code>initrd.img-${version}</code>, <code>initrd-${version}.gz</code>, or <code>initrd-${version}</code>. These files must be available in {{Path|/boot}}.}}

{{Note|The file {{Path|/etc/default/grub}} controls the operation of {{c|grub-mkconfig}}. If parameters need to be passed on to the kernel (for instance when using genkernel and booting from LVM or software RAID), edit that file before generating {{Path|/boot/grub/grub.cfg}} like so:
{{RootCmd|nano /etc/default/grub}}
Have a look at [[GRUB2#Configuration|GRUB2 configuration]] on the Gentoo Wiki or the [http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html official GRUB2 manual] to decide how to modify the file. Most users will need to change <code>GRUB_CMDLINE_LINUX</code> to specify parameters to be passed on the kernel command line.}}

=== Charger en chaîne GRUB2 depuis GRUB Legacy pour vérifier la configuration ===

Étant donné qu'une configuration défaillante de GRUB peut conduire à un système incapable de démarrer, vous devez tester votre configuration de GRUB2 avant de la rendre permanente. Pour faire cela, vous allez chaîner GRUB2 à GRUB Legacy. Vous pouvez le faire en ajoutant une nouvelle section dans {{Path|/boot/grub/grub.conf}}. En voici un exemple : 

{{Note|Soyez conscient du fait que la racine peut être différente de <code>(hd0,0)</code> utiliser ici en exemple, et assurez-vous que vous d'utilisez la même valeur de racine que celle tirée du fichier de configuration  {{Path|/boot/grub/grub.conf}} .}}

{{FileBox|filename=/boot/grub/grub.conf||1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

À ce stade la machine doit être redémarré et <code>GRUB2 Chainload</code> choisi depuis le menu de GRUB lorsque la machine commence à démarrer. un autre menu GRUB ce présente alors qui s'annoncera lui-même comme étant un menu GRUB 2.0.0 ou postérieur sur la première ligne présentant les noyaux valides disponible au démarrage . Si cela ne marche pas, redémarrez simplement le système et choisissez l'option de démarrage habituelle au lieu de  <code>GRUB2 Chainload</code>. 

=== Remplacer et retirer GRUB Legacy ===

À ce stade, si tout s'est bien passé, "GRUB Legacy" peut être remplacer et retirer du système. 

{{Warning|Comme le système a été redémarrer, il peut être nécessaire de monter {{Path|/boot}} à nouveau. Faites attention à monter le disque correct au démarrage au lieu de  {{Path|/dev/sda}} qui est,rappelons-le, un simple exemple.
Si {{Path|/boot}} n'est pas monter avant de lancer {{c|grub-install}}, le système deviendra indémarrable (unbootable) }}

{{Note|As previously mentioned, if GRUB2 was emerged with the <code>multislot</code> USE flag then {{c|grub2-install}} must be used instead of {{c|grub-install}}. In this case, after GRUB Legacy is removed from the system in the next step, GRUB2 should be re-emerged without the <code>multislot</code> USE flag so that {{c|grub-install}} and {{c|grub-mkconfig}} can become GRUB2 commands.}}

{{RootCmd|grub-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

À ce stade utiliser le gestionnaire de paquets pour retirer <code>sys-boot/grub:0</code> 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

La migration est maintenant terminée.

== Maintenance de  GRUB2 ==

À chaque fois qu'un nouveau noyau est installer, il faut accomplir l'étape suivante de manière à ce que la configuration GRUB2 reconnaisse le nouveau noyau (sauf si vous avez utilisé une [[GRUB2_Quick_Start#Manual_Configuration| configuration manuelle]]). 

{{Note|Être sure que la partition {{Path|/boot}} est montée pour cette étape ǃ}}

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
