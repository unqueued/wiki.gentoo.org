<languages />


{{Metadata|abstract=Le but de ce guide est de vous aider à migrer en douceur de GRUB Legacy vers GRUB2.}}

Le but de ce guide est de vous aider à migrer en douceur de GRUB Legacy vers GRUB2.

== Contexte ==

Qu'est-ce que GRUB

GRUB est l'un des chargeurs de démarrage les plus courants sur les systèmes non-embarqués. Le rôle de GRUB est de faciliter le choix du noyau Linux à charger du disque dur vers la mémoire et de commencer à l'exécuter. 

=== Mais pourquoi migrer ? ===

En premier lieu, parce que GRUB Legacy n'est plus maintenu. GRUB Legacy a été créé à une époque où les développeurs pouvaient faire certaines suppositions qui ne sont plus valables de nos jours. Par exemple, GRUB Legacy ne sait pas démarrer depuis des disques d'une taille supérieure à 2 TO et présuppose que les nouveaux systèmes de fichiers n'en viendront pas à remplacer  {{Path|/boot}}. 

GRUB2 cherche à être plus robuste, plus portable et plus puissant. De plus il est maintenu sur une base de code plus saine. GRUB2 prend en charge un plus grand nombre de configurations matérielles, plus de types de systèmes de fichiers et plus d'agencements de disques que son prédécesseur. 

== Migration vers GRUB2 ==

La migration vers GRUB2 est assez directe : il sera installé comme partie de votre processus de mise à jour par le gestionnaire de paquets. S'il n'est pas installé automatiquement, vous pouvez le faire à la main en installant le paquet <code>sys-boot/grub:2</code>.

{{Emerge|sys-boot/grub:2}}

=== Disque de démarrage ===

Le première chose importante à comprendre, c'est quel est votre disque amorçable. Pour beaucoup de gens, il s'agit de  {{Path|/dev/sda}}. Le moyen le plus aisé de le savoir, est de regarder comment votre GRUB Legacy est configuré en regardant  {{Path|/boot/grub/grub.conf}}. Un exemple est fourni ci-dessous. 

{{Note|Be sure the {{Path|/boot}} partition is mounted to be able to view these files. It should be as simple as
{{RootCmd|mount /boot}}
}}

The {{Path|grub.conf}} will look something like this:

{{FileBox|filename=/boot/grub/grub.conf||1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

Based on the above file it is possible to know that <code>(hd0)</code> is the boot drive but we must map this to a real device. To know this, look at the {{Path|/boot/grub/device.map}} file. An example one is provided below. 

{{FileBox|filename=/boot/grub/device.map||1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note|Si vous pensez que  {{Path|/boot/grub/device.map}} n'est pas assez précis, vous pouvez exécuter <code>grub-install --recheck /dev/sda</code> pour recréer ce fichier.}}

En vous appuyant sur le fichier ci-dessus, vous savez que votre disque de démarrages est  {{Path|/dev/sda}}.

=== Installer et configurer GRUB2 ===

The next step is to install and configure GRUB2 for the {{Path|/boot}} partition without removing GRUB Legacy from the drive's MBR. The example below uses {{Path|/dev/sda}} - replace it with the correct boot drive path. The first step installs the necessary GRUB2 files to {{Path|/boot/grub}}, while the second step scans the available kernels and generates a suitable config file to {{Path|/boot/grub/grub.cfg}}. Skip the second step when using a [[GRUB2_Quick_Start#Manual_configuration|Manual Configuration]].

{{Warning/fr|GRUB 2 utilise le fichier de configuration {{Path|/boot/grub/grub.'''cfg'''}} tandis que GRUB Legacy utilise le fichier {{Path|/boot/grub/grub.'''conf'''}}. Soyez donc vigilant pour ne pas confondre les deux noms et utiliser l'ancien fichier par erreur, lorsque, par exemple, vous utilisez l'auto-completion par la touche tab et que l'ancien fichier est encore présent.}}

{{RootCmd|grub2-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Note|<code>grub2-mkconfig</code> exige un nommage strict des images des noyaux et des systèmes de fichiers virtuels initiaux (initramfs). Une image de noyau doit être nommée <code>kernel-${version}</code> ou <code>vmlinuz-${version}</code> alors qu'une image d'initramfs doit être nommée <code>initramfs-${version}.img</code> ,<code>initramfs-genkernel-${version}</code> ,<code>initramfs-genkernel-${arch}-${version}</code> ,<code>initrd-${version}.img</code> ,<code>initrd.img-${version}</code> ,<code>initrd-${version}.gz</code> , ou <code>initrd-${version}</code> . Associé à  ${version}, le nom de fichier doit correspondre à un noyau qui est dans {{Path|/boot}}.}}

{{Note|Le fichier {{Path|/etc/default/grub}} contrôle les opérations de <code>grub2-mkconfig</code>. Si vous avez besoin de passer des paramètres à votre noyau (par exemple quand vous utilisez genkernel et le démarrage depuis LVM ou un RAID), vous devez éditer ce fichier avant de lancer la génération {{Path|/boot/grub/grub.cfg}} comme cela:
{{RootCmd|nano /etc/default/grub}}
Jetez un œil sur le Wiki Gentoo [[GRUB2#Configuration|the GRUB2 configuration]] ou sur le [http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html manuel grub2] pour décider comment modifier le fichier. La plupart des utilisateur devront changer le  paramètre <code>GRUB_CMDLINE_LINUX</code>.}}

=== Charger en chaîne GRUB2 depuis GRUB Legacy pour vérifier la configuration ===

Étant donné qu'une configuration défaillante de GRUB peut conduire à un système incapable de démarrer, vous devez tester votre configuration de GRUB2 avant de la rendre permanente. Pour faire cela, vous allez chaîner GRUB2 à GRUB Legacy. Vous pouvez le faire en ajoutant une nouvelle section dans {{Path|/boot/grub/grub.conf}}. En voici un exemple : 

{{Note|Soyez conscient du fait que votre racine peut être différente de <code>(hd0,0)</code> que nous prenons ici en exemple, et assurez-vous que vous utilisez la même valeur de racine tirée de  {{Path|/boot/grub/grub.conf}} .}}

{{FileBox|filename=/boot/grub/grub.conf||1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

À ce stade vous devez redémarrer votre machine et choisir   <code>GRUB2 Chainload</code> depuis le menu de GRUB lorsque votre machine commence à démarrer. Cela vous présentera un autre menu GRUB qui s'annoncera lui-même comme étant un menu GRUB 2.0.0 ou postérieur sur la première ligne et vous présentera les noyaux valides que vous pouvez démarrer. Si cela ne marche pas, redémarrez simplement votre système et choisissez l'option de démarrage habituelle au lieu de  <code>GRUB2 Chainload</code>. 

=== Remplacer et retirer GRUB Legacy ===

À ce stade, si tout s'est bien passé, vous pouvez remplacer GRUB Legacy et le retirer du système. 

{{Note|Comme vous avez redémarré votre système, il peut être nécessaire de monter {{Path|/boot}} à nouveau. Faites attention à bien monter votre propre disque de démarrage au lieu de  {{Path|/dev/sda}}.}}

{{RootCmd|grub2-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

À ce stade vous pouvez utiliser votre gestionnaire de paquets pour retirer <code>sys-boot/grub:0</code> .{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"|}} La migration est terminée. 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

The migration is now complete.

== Maintenance de  GRUB2 ==

Whenever a new kernel is installed, perform the next step so that the GRUB2 configuration recognizes the new kernel (except when using a [[GRUB2_Quick_Start#Manual_configuration|manual configuration]]). 

{{Note|Votre partition {{Path|/boot}} doit être montée pour cette étape.}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
