<languages />


{{Metadata|abstract=The goal of this guide is to provide readers with a smooth migration from GRUB Legacy to GRUB2.}}

The goal of this guide is to provide readers with a smooth migration from GRUB Legacy to GRUB2.

== Contexte ==

=== Qu'est-ce que GRUB? ===

GRUB est l'un des chargeurs de démarrage les plus courants sur les systèmes non-embarqués. Le rôle de GRUB est de faciliter le choix du noyau Linux qui est charger du disque dur vers la mémoire et de commencer à l'exécuter. 

=== Pourquoi migrer ? ===

En premier lieu, parce que GRUB Legacy n'est plus maintenu. GRUB Legacy a été créé à une époque où les développeurs pouvaient faire certaines suppositions qui ne sont plus valables de nos jours. Par exemple, GRUB Legacy ne sait pas démarrer depuis des disques d'une taille supérieure à 2 TO et présuppose que les nouveaux systèmes de fichiers n'en viendront pas à remplacer  {{Path|/boot}}. 

GRUB2 cherche à être plus robuste, plus portable et plus puissant. De plus il est maintenu sur une base de code plus saine. GRUB2 prend en charge un plus grand nombre de configurations matérielles, plus de types de systèmes de fichiers et plus d'agencements de disques que son prédécesseur. 

== Migration vers GRUB2 ==

La migration vers GRUB2 est assez directe : il sera installé comme partie du processus de mise à jour par le gestionnaire de paquets. S'il n'est pas installé automatiquement, il est possible de le faire à la main en utilisant <code>sys-boot/grub:2</code>.

{{Emerge|sys-boot/grub:2}}

=== Disque de Démarrage ===

The first important part is to understand which drive is bootable. For those who followed the Gentoo Handbook it should be {{Path|/dev/sda}}. For those who are uncertain, the easiest way to find out is to look at the existing GRUB Legacy configuration. Viewing the {{Path|/boot/grub/grub.conf}} file is the main place to check. 

{{Note|Be sure the {{Path|/boot}} partition is mounted to be able to view these files. It should be as simple as
{{RootCmd|mount /boot}}
}}

The {{Path|grub.conf}} will look something like this:

{{FileBox|filename=/boot/grub/grub.conf||1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

Based on the above file it is possible to know that <code>(hd0)</code> is the boot drive but we must map this to a real device. To know this, look at the {{Path|/boot/grub/device.map}} file. An example one is provided below. 

{{FileBox|filename=/boot/grub/device.map||1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note|When suspecting that {{Path|/boot/grub/device.map}} is not accurate, run {{c|grub-install --recheck /dev/sda}} to recreate the file.}}

En vous appuyant sur le fichier ci-dessus, vous savez que votre disque de démarrages est  {{Path|/dev/sda}}.

=== Installing and configuring GRUB2 ===

The next step is to install and configure GRUB2 for the {{Path|/boot}} partition without removing GRUB Legacy from the drive's MBR. The example below uses {{Path|/dev/sda}} - replace it with the correct boot drive path. The first step installs the necessary GRUB2 files to {{Path|/boot/grub}}, while the second step scans the available kernels and generates a suitable config file to {{Path|/boot/grub/grub.cfg}}. Skip the second step when using a [[GRUB2_Quick_Start#Manual_configuration|Manual Configuration]].

{{Warning|GRUB 2 uses the configuration file {{Path|/boot/grub/grub.'''cfg'''}} whereas GRUB Legacy used {{Path|/boot/grub/grub.'''conf'''}} so please make sure not to use the old file by mistake, e.g. by using tab-completion if the old file is still there.}}

{{RootCmd|grub-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Note|<code>grub-mkconfig</code> has strict naming requirements for kernels and initramfs images. A kernel must be named <code>kernel-${version}</code> or <code>vmlinuz-${version}</code> while an initramfs must be named <code>initramfs-${version}.img</code>, <code>initramfs-genkernel-${version}</code>, <code>initramfs-genkernel-${arch}-${version}</code>, <code>initrd-${version}.img</code>, <code>initrd.img-${version}</code>, <code>initrd-${version}.gz</code>, or <code>initrd-${version}</code>. Together with ${version}, the filename must match a corresponding kernel that is available in {{Path|/boot}}.}}

{{Note|The file {{Path|/etc/default/grub}} controls the operation of <code>grub-mkconfig</code>. If parameters need to be passed on to the kernel (for instance when using genkernel and booting from LVM or software RAID), edit that file before generating {{Path|/boot/grub/grub.cfg}} like so:
{{RootCmd|nano /etc/default/grub}}
Have a look at [[GRUB2#Configuration|the GRUB2 configuration]] on the Gentoo Wiki or at the [http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html grub2 manual] to decide how to modify the file. Most users will need to change the <code>GRUB_CMDLINE_LINUX</code> parameter.}}

=== Charger en chaîne GRUB2 depuis GRUB Legacy pour vérifier la configuration ===

Étant donné qu'une configuration défaillante de GRUB peut conduire à un système incapable de démarrer, vous devez tester votre configuration de GRUB2 avant de la rendre permanente. Pour faire cela, vous allez chaîner GRUB2 à GRUB Legacy. Vous pouvez le faire en ajoutant une nouvelle section dans {{Path|/boot/grub/grub.conf}}. En voici un exemple : 

{{Note|Be aware that the root partition may be different from <code>(hd0,0)</code> used in the example, and make sure to reuse the same root value from the {{Path|/boot/grub/grub.conf}} configuration file.}}

{{FileBox|filename=/boot/grub/grub.conf||1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

At this point the machine should be rebooted, and <code>GRUB2 Chainload</code> selected from the GRUB menu when the machine begins to boot. Another GRUB menu will be presented which should advertise itself as GRUB 2.0.0 or higher at the top and show the available kernel(s) to boot. Should this not work, simply reboot the system and pick the normal boot option instead of <code>GRUB2 Chainload</code>. 

=== Remplacer et retirer GRUB Legacy ===

At this point, if everything worked successfully, replace GRUB Legacy and remove it from the system. 

{{Warning|Since the system has been rebooted, it might be necessary to mount {{Path|/boot}} again. Make sure to use the right boot drive path instead of {{Path|/dev/sda}} as this is merely an example. If {{Path|/boot}} is not mounted before running {{c|grub-install}}, the system will become unbootable}}

{{RootCmd|grub-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

At this point use the package manager to remove <code>sys-boot/grub:0</code>. 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

The migration is now complete.

== Maintenance de  GRUB2 ==

Whenever a new kernel is installed, perform the next step so that the GRUB2 configuration recognizes the new kernel (except when using a [[GRUB2_Quick_Start#Manual_configuration|manual configuration]]). 

{{Note|Make sure the {{Path|/boot}} partition is mounted for this step.}}

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
