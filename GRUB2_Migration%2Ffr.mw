<languages />


{{Metadata|abstract=Le but de ce guide est de vous aider à migrer en douceur de GRUB Legacy vers GRUB2.}}

Le but de ce guide est de vous aider à migrer en douceur de GRUB Legacy vers GRUB2.

== Contexte ==

Qu'est-ce que GRUB

GRUB est l'un des chargeurs de démarrage les plus courants sur les systèmes non-embarqués. Le rôle de GRUB est de faciliter le choix du noyau Linux à charger du disque dur vers la mémoire et de commencer à l'exécuter. 

=== Mais pourquoi migrer ? ===

En premier lieu, parce que GRUB Legacy n'est plus maintenu. GRUB Legacy a été créé à une époque où les développeurs pouvaient faire certaines suppositions qui ne sont plus valables de nos jours. Par exemple, GRUB Legacy ne sait pas démarrer depuis des disques d'une taille supérieure à 2TB et présuppose que les nouveaux systèmes de fichiers n'en viendront pas à remplacer  {{Path|/boot}}. 

GRUB2 cherche à être plus robuste, plus portable et plus puissant. De plus il est maintenu sur une base de code plus saine. GRUB2 prend en charge un plus grand nombre de configurations matérielles, plus de types de systèmes de fichiers et plus d'agencement de disques que son prédécesseur. 

== Migration vers GRUB2 ==

La migration vers GRUB2 est assez directe : il sera installé comme partie de votre processus de mise à jour par le gestionnaire de paquets. S'il n'est pas installé automatiquement, vous pouvez le faire à la main en installant le paquet <code>sys-boot/grub:2</code>. 

=== Disque de démarrage ===

Le première chose importante à comprendre, c'est quel est votre disque amorçable. Pour beaucoup de gens, il s'agit de  {{Path|/dev/sda}}. Le moyen le plus aisé de le savoir, est de regarder comment votre GRUB Legacy est configuré en regardant  {{Path|/boot/grub/grub.conf}}. Un exemple est fourni ci-dessous. 

{{Note|Vous devez avoir votre {{Path|/boot}} monté pour être en mesure de voir ces fichiers. Il suffit de faire  <code>mount /boot</code> pour monter {{Path|/boot}}.}}

{{File|/boot/grub/grub.conf||<pre>
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
</pre>
}}

En vous appuyant sur le fichier ci-dessus, vous savez que <code>(hd0)</code> est le disque de démarrage mais il faut l'associer à un périphérique réel. Pour connaître cette information, il faut regarder  {{Path|/boot/grub/device.map}}. En voici un exemple : 

{{File|/boot/grub/device.map||<pre>
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
</pre>
}}

En vous appuyant sur le fichier ci-dessus, vous savez que votre disque de démarrages est  {{Path|/dev/sda}}. 

=== Installing and Configuring GRUB2 ===

The next step is to install and configure GRUB2 on your {{Path|/boot}} partition without removing GRUB Legacy from your MBR. The example below uses {{Path|/dev/sda}} but you must replace it with your boot drive path. The first step installs the necessary GRUB2 files to {{Path|/boot/grub}} , while the second step scans your available kernels and generates a suitable config file to {{Path|/boot/grub/grub.cfg}} . Skip the second step when using a [[GRUB2_Quick_Start#Manual_Configuration|Manual Configuration]].

{{RootCmd|grub2-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Note|<code>grub2-mkconfig</code> has strict naming requirements for kernels and initramfs images. A kernel must be named<code>kernel-${version}</code> or<code>vmlinuz-${version}</code> while an initramfs must be named<code>initramfs-${version}.img</code> ,<code>initramfs-genkernel-${version}</code> ,<code>initramfs-genkernel-${arch}-${version}</code> ,<code>initrd-${version}.img</code> ,<code>initrd.img-${version}</code> ,<code>initrd-${version}.gz</code> , or<code>initrd-${version}</code> . Together with ${version}, the filename must match a corresponding kernel that is available in {{Path|/boot}} .}}

=== Chainloading GRUB2 from GRUB Legacy to test the setup ===

Because a broken GRUB configuration could mean an unbootable system, we want to test our GRUB2 configuration before making it permanent. To do this we will chainload GRUB2 from GRUB Legacy. This is done by adding a new section into {{Path|/boot/grub/grub.conf}} . An example is shown below. 

{{Note|Be aware that your root may be different from <code>(hd0,0)</code> used in the example, and make sure you reuse the same root value from your {{Path|/boot/grub/grub.conf}} .}}

{{File|/boot/grub/grub.conf||<pre>
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
</pre>
}}

At this point you should reboot your machine and select <code>GRUB2 Chainload</code> from the GRUB menu when your machine begins to boot. You will be presented with another GRUB menu which should advertise itself as GRUB 2.0.0 or higher at the top and show your available kernel(s) to boot. Should this not work, simply reboot your system and pick your normal boot option instead of <code>GRUB2 Chainload</code> . 

=== Replacing and removing GRUB Legacy ===

At this point, if everything worked successfully, you can replace GRUB Legacy and remove it from your system. 

{{Note|Since you've rebooted your system, you may need to mount {{Path|/boot}} again. Make sure to use your own boot drive path instead of {{Path|/dev/sda}} .}}

{{RootCmd|grub2-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

At this point you can use your package manager to remove <code>sys-boot/grub:0</code> . The migration is complete. 

== Maintaining GRUB2 ==

Whenever you install a new kernel, you must perform the next step so that your GRUB2 configuration recognizes the new kernel (unless you are using a [[GRUB2_Quick_Start#Manual_Configuration|manual configuration]]). 

{{Note|You must have your {{Path|/boot}} partition mounted for this step.}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

== Acknowledgements ==

We would like to thank the following authors and editors for their contributions to this guide:


* cardoe
