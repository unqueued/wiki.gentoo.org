<languages />
Chroot (Change Root) 是一个Unix系统应用，用来改变根目录来创建一个与主系统隔离的新环境。这个新环境就是著名的“Chroot监狱(chroot jail)”。用户在这个“监狱”中进行的操作，不能访问和读写此环境之外的数据文件。

任何Chroot之后的操作都是为了在当前环境中创建一个虚拟Linux系统，来测试系统及软件的兼容性。它一般被视为一个轻量级的虚拟环境，因为它可以不依赖虚拟化环境来运行。

==设置环境==
当你创建一个新的环境时，首先要做的就是创建一个你将chroot进入的目录，比如 {{Path|/mnt/mychroot}}:

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

如果你想挂载一个已经装好系统的分区，你可以这样做：

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/DEVICE /mnt/mychroot
}}

将 DEVICE 替换成你已经安装好系统的分区。

如果你有一个已经安装在根目录下某个子目录中的系统，就不需要再做上述操作。

==Unpacking system files & portage tree for a new installation==
If you're building a new install, the next step is to download the stage3 and portage tarballs and set them up in the chroot location. For more information on this process please see sections 5a and 5b in the [http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&chap=5 Gentoo Handbook].

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/current-stage3/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

==Configuration==
Before entering the chroot we need to mount a number of directories.

{{RootCmd
|mount -o bind /dev /mnt/mychroot/dev
|mount -t proc none /mnt/mychroot/proc
|mount -o bind /sys /mnt/mychroot/sys
|mount -o bind /tmp /mnt/mychroot/tmp
}}

And will also need to copy over some basic configuration file from the host, do not copy over {{Path|make.conf}} if you're using an existing installation.

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # If you use an existing installation, skip this command.
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

Once done we can then enter the chroot environment.

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

When creating a new installation, you can sync portage to make sure everything is up to date.

{{RootCmd
|emerge --sync
}}

The system is now ready. You can install software, mess with settings, test experimental packages and configurations without having any effect on your main system. To leave the chroot simply type "exit" or press {{Key|Ctrl}} + {{Key|D}}, this will return you back to your normal environment. Don't forget to umount directories you've mounted.

==Init scripts==
If you need to do this often, you can speed up the mounting of the directories needed for a chroot by using an init script:

{{File|/etc/init.d/mychroot||
 #!/sbin/runscript

 depend() {
   need localmount
   need bootmisc
 }

 start() {
     ebegin "Mounting chroot directories"
     mount -o bind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}

 stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
 }
}}

If you use a different directory or partition, add the necessary mounting commands in start() and change {{Path|/mnt/chroot}} if you use a different name.

==See also==
* [http://www.gentoo.org/proj/en/base/x86/chroot.xml Gentoo x86 Chroot Setup Guide]


[[Category:Core system]]
