<languages />

Chroot ('''Ch'''ange '''Root''') 是一个Unix系统应用，用来改变根目录来创建一个与主系统隔离的新环境。这个新环境就是著名的“Chroot监狱(chroot jail)”。用户在这个“监狱”中进行的操作，不能访问和读写此环境之外的数据文件。

任何Chroot之后的操作都是为了在当前环境中创建一个虚拟Linux系统，来测试系统及软件的兼容性。Chroot一般被视为一个轻量级的虚拟环境，因为它可以不依赖虚拟化环境来运行。

== 设置环境 ==

当你创建一个新的环境时，首先要做的就是创建一个你将chroot进入的目录，比如 {{Path|/mnt/mychroot}}:

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

如果你想挂载一个已经装好系统的分区，你可以使用以下命令。一定要更换 <code><DEVICE></code>字符串，在下面的驱动器和现有安装的分区中，例如：

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/DEVICE /mnt/mychroot
}}

如果你有一个已经安装在根目录下某个子目录中的系统，就不需要再做上述操作。

==为新建环境解压系统文件和portage树（新安装）==

当你已经开始安装，下一步就是下载stage3和portage包，并将它们放到要chroot的位置。获取此操作更多信息，请看手册中的sections 5a和5b[http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&chap=5 Gentoo Handbook]。

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/current-stage3/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

== Configuration ==

Before entering the chroot a number of directories need to be mounted:

{{RootCmd
|mount -o bind /dev /mnt/mychroot/dev
|mount -t proc none /mnt/mychroot/proc
|mount -o bind /sys /mnt/mychroot/sys
|mount -o bind /tmp /mnt/mychroot/tmp
}}

Some basic configuration files will need to be copied from the host, do not copy over {{Path|make.conf}} when using an existing installation:

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # 如果你使用一个已装好的系统，请忽略这条命令。
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

Once done enter the chroot environment by executing the following commands:

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

When creating a new installation Portage should be synced to make sure everything is up to date.

{{RootCmd
|emerge --sync
}}

The system is now ready; feel free to install software, mess with settings, test experimental packages and configurations without having any effect on the main system. To leave the chroot simply type <kbd>exit</kbd> or press {{Key|Ctrl}}+{{Key|D}}. Doing so will return the console back to the normal environment. Do not forget to umount the directories that have been mounted.

== Init scripts ==

If setting up chroots is a task that is needed to be performed often, it is possible to speed up the mounting of the directories by using an init script:

{{FileBox|filename=/etc/init.d/mychroot|lang=bash|1=
#!/sbin/runscript
 
depend() {
   need localmount
   need bootmisc
}
 
start() {
     ebegin "Mounting chroot directories"
     mount -o rbind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}
 
stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
}
}}

When using a different directory or partition, add the necessary mounting commands in the <code>start()</code> function and change {{Path|/mnt/chroot}} to the appropriate name.

=== 另请参阅 ===

* [[Project:X86/Chroot Guide|Chroot Guide]]


[[Category:Core system]]
