<languages />
Chroot (Change Root) 是一个Unix系统应用，用来改变根目录来创建一个与主系统隔离的新环境。这个新环境就是著名的“Chroot监狱(chroot jail)”。用户在这个“监狱”中进行的操作，不能访问和读写此环境之外的数据文件。

任何Chroot之后的操作都是为了在当前环境中创建一个虚拟Linux系统，来测试系统及软件的兼容性。它一般被视为一个轻量级的虚拟环境，因为它可以不依赖虚拟化环境来运行。

==设置环境==
当你创建一个新的环境时，首先要做的就是创建一个你将chroot进入的目录，比如 {{Path|/mnt/mychroot}}:

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

如果你想挂载一个已经装好系统的分区，你可以这样做：

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/DEVICE /mnt/mychroot
}}

将 DEVICE 替换成你已经安装好系统的分区。

如果你有一个已经安装在根目录下某个子目录中的系统，就不需要再做上述操作。

==为新建环境解压系统文件和portage树==
如果你已经开始安装，下一步就是下载stage3和portage包，并将它们放到要chroot的位置。获取此操作更多信息，请看手册中的sections 5a和5b[http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&chap=5 Gentoo Handbook]。

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/current-stage3/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

==配置==
在进入chroot之前，我们挂载一些目录。

{{RootCmd
|mount -o bind /dev /mnt/mychroot/dev
|mount -t proc none /mnt/mychroot/proc
|mount -o bind /sys /mnt/mychroot/sys
|mount -o bind /tmp /mnt/mychroot/tmp
}}

然后你还要从主系统复制一些基本配置文件，如果你使用一个已装好的系统，就不要复制{{Path|make.conf}}。

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # 如果你使用一个已装好的系统，请忽略这条命令。
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

做完这几步，你就可以chroot进入新环境了。

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

创建好环境后，你就可以同步portage，更新到最新状态。

{{RootCmd
|emerge --sync
}}

The system is now ready. You can install software, mess with settings, test experimental packages and configurations without having any effect on your main system. To leave the chroot simply type "exit" or press {{Key|Ctrl}} + {{Key|D}}, this will return you back to your normal environment. Don't forget to umount directories you've mounted.

==Init scripts==
If you need to do this often, you can speed up the mounting of the directories needed for a chroot by using an init script:

{{File|/etc/init.d/mychroot||
 #!/sbin/runscript

 depend() {
   need localmount
   need bootmisc
 }

 start() {
     ebegin "Mounting chroot directories"
     mount -o bind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}

 stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
 }
}}

If you use a different directory or partition, add the necessary mounting commands in start() and change {{Path|/mnt/chroot}} if you use a different name.

==See also==
* [http://www.gentoo.org/proj/en/base/x86/chroot.xml Gentoo x86 Chroot Setup Guide]


[[Category:Core system]]
