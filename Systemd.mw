{{Lowercase title}}

[http://freedesktop.org/wiki/Software/systemd systemd] is a modern sysvinit & RC replacement for Linux systems. It is supported in Gentoo as an alternate init system.

= Installation =

== Prerequisites: kernel ==

systemd makes use of many modern Linux kernel features. Right now, the lower bound on kernel version is set in the ebuild to 2.6.38. In addition to that, the following kernel configuration options should be enabled:

{{Kernel|Kernel features required or suggested by systemd|<pre>
General setup  --->
    [*] Control Group support
Device Drivers --->
    Generic Driver Options  --->
        [*] Maintain a devtmpfs filesystem to mount at /dev
File systems --->
    [*] Filesystem wide access notification
    <M> Kernel automounter version 4 support (also supports v3)
Networking support --->
    Networking options --->
        TCP/IP networking --->
            <M> The IPv6 protocol
</pre>}}

== Prerequisites: udev ==

Newer versions of systemd (> 29) require udev version at least 172. The current version in the tree (175) is hard masked since both udev and systemd [http://www.freedesktop.org/wiki/Software/systemd/separate-usr-is-broken do not support a separated /usr partition]. In order to use the newer versions of systemd, you have unmask the udev ebuild:

{{RootCmd|echo sys-fs/udev >> /etc/portage/package.unmask}}

and keyword both udev and systemd:

{{RootCmd|flaggie sys-fs/udev sys-apps/systemd +~amd64}}

You can still use systemd-29 without unmasking udev nor keywording those packages.

== Prerequisites: filesystem ==

=== /run directory ===

The ''/run'' directory is used by systemd (and some applications) as a non-persistent storage for runtime data like pidfiles, sockets and state files.

The systemd ebuild will create ''/run'' directory itself. However, please note that this change will trigger automatic mounting of it in OpenRC as well, and may trigger using it by different software packages.

=== /etc/mtab symlink ===

Upstream suggests that ''/etc/mtab'' file should be a symlink to ''/proc/self/mounts''. Note that this is not obligatory, and can create problems with ''mount -o user'' and NFS mounts.

To create the symlink, please use the following command:

{{RootCmd|ln -sf /proc/self/mounts /etc/mtab}}

=== /etc/machine-id ===

Often systemd guides mention creating ''/etc/machine-id'' file as a global replacement for D-Bus specific ''/var/lib/dbus/machine-id''. In Gentoo, this is already done in {{Package|sys-apps/dbus}} ebuild.

== Installing ==

Installing systemd is as simple as emerging {{Package|sys-apps/systemd}}.

{{RootCmd|emerge sys-apps/systemd}}

== Enabling ==

Before doing this, please [[#Configuration|configure]] systemd first.

In order to run systemd, you have to switch the ''init'' executable kernel (or your initramfs) uses.

With simple kernels, the ''init=/bin/systemd'' argument should be added to the kernel command-line. An example excerpt from ''grub.conf'' would look like:

{{File|/boot/grub/grub.conf|Example GRUB config for systemd with simple kernel|<pre>
title=Gentoo with systemd
root (hd0,0)
kernel /vmlinuz root=/dev/sda2 init=/bin/systemd
</pre>}}

When using initramfs, other command-line argument will be needed. For example, genkernel uses ''real_init='' there:

{{File|/boot/grub/grub.conf|Example GRUB config for systemd with genkernel|<pre>
title=Gentoo with systemd
root (hd0,0)
kernel /my-genkernel... root=/dev/hda2 real_init=/bin/systemd
initrd /initramfs-genkernel...
</pre>}}

= Configuration =

== System configuration ==

systemd comes with some degree of OpenRC compatibility, so it will gracefully read most of the base system options from its files. This includes the following files:
* ''/etc/conf.d/hostname'' for hostname,
* ''/etc/profile.env'' for locale (created by ''env-update'' from ''/etc/env.d''),
* ''/etc/rc.conf'' for the ''unicode'' console setting,
* ''/etc/conf.d/consolefont'' for the console font settings,
* ''/etc/conf.d/keymaps'' for the keymap setting (but only the actual ''keymap'').

Additionally, the following configuration directories are both used by OpenRC and systemd:
* ''/etc/modules-load.d'',
* ''/etc/sysctl.d'',
* ''/etc/binfmt.d'' (since OpenRC-0.9.4).

Alternatively, you can migrate your system to use [[#Native systemd configuration files]]. Bear in mind that upstream has made it clear that at some point in the future it will stop supporting configuration files for specific distributions, and it will only support the native systemd configuration files. If you plan to use systemd exclusively, please use its native configuration files.

== Listing available services ==

All global service files are installed in ''/lib/systemd/system'' directory. Thus, the simplest way of looking up available service units is listing that directory:

{{RootCmd|ls /lib/systemd/system
|output=<pre>acpid.service                            runlevel2.target
alsa-restore.service                     runlevel2.target.wants
alsa-store.service                       runlevel3.target
autovt@.service                          runlevel3.target.wants
avahi-daemon.service                     runlevel4.target
avahi-daemon.socket                      runlevel4.target.wants
avahi-dnsconfd.service                   runlevel5.target
basic.target                             runlevel5.target.wants
...
</pre>}}

The following file suffixes are of interest:
* ''.service'' - plain service files (e.g. ones just running a daemon directly),
* ''.socket'' - socket listeners (much like ''inetd''),
* ''.path'' - filesystem triggers for services (running services when files change etc.).

Alternatively, ''systemctl'' tool can be used to list all services (including implicit ones):

{{RootCmd|systemctl --all --full}}

And finally, if {{Package|sys-apps/systemd}} was built with ''USE=gtk'', the ''systemadm'' graphical tool can be used.

== Installing custom service files ==

Any custom service files should be copied to ''/etc/systemd/system'' directory. The ''/lib/systemd/system'' directory is reserved for service files installed by ebuilds.

== Enabling and disabling services ==

The usual way of enabling a service is using:

{{RootCmd|systemctl enable foo.service}}

Services can be disabled likewise:

{{RootCmd|systemctl disable foo.service}}

These commands enable services using their default name in default target (both specified in ''Install'' section of the service file). However, sometimes services either don't provide that information or you want to use another name/target.

== Enabling a service under a custom name ==

This is especially a case for template services -- services in which part of the name following ''@'' (at sign) is used as a parameter to the service. This is often used to specify the terminal on which getty will run.

To enable a service under custom name, you have to create a symlink to the service file in correct ''/etc/systemd/system/*.wants'' directory. The name of that directory can either specify a target or another service which will depend on the new one.

For example, to enable stand-alone {{Package|net-wireless/wpa_supplicant}} on ''wlan0'', type:

{{RootCmd|ln -s /lib/systemd/system/wpa_supplicant@.service /etc/systemd/system/multi-user.target.wants/wpa_supplicant@wlan0.service}}

To disable the service, just remove the symlink:

{{RootCmd|rm /etc/systemd/system/multi-user.target.wants/wpa_supplicant@wlan0.service}}

== Native systemd configuration files ==

systemd supports a few system configuration files to set the most basic system details.

=== /etc/hostname ===

A trivial file containing the system hostname. Replaces ''/etc/conf.d/hostname''.

{{File|/etc/hostname|Setting an example hostname of ''frobnicator''|<pre>frobnicator</pre>}}

=== /etc/vconsole.conf ===

Simple configuration file specifying console font and keymap. Replaces ''/etc/conf.d/consolefont'' and ''/etc/conf.d/keymaps'', yet it doesn't support all features of those init.d scripts.

{{File|/etc/vconsole.conf|An example, simple console configuration|<pre>
KEYMAP=pl2
FONT=LatArCyrHeb-16
</pre>}}

=== /etc/locale.conf ===

In systemd, locale settings are stored in ''/etc/locale.conf''. The file supports same syntax as shell locale variables, so you can basically rename ''/etc/env.d/02locale'' or a similar file.

{{File|/etc/locale.conf|An example locale.conf for utf8|<pre>
LANG="pl_PL.UTF-8"
LC_ALL="pl_PL.UTF-8"
</pre>}}

= Services =

== Native services ==

Some of Gentoo packages already install systemd unit files. For these services, it is enough to enable them. A quick summary of packages installing unit files can be seen on [http://qa-reports.gentoo.org/output/eclass-usage/systemd.txt systemd eclass users list].

The following table lists systemd services matching OpenRC ones:

{| class="wikitable" style="text-align: center;"
|+ Migration chart
|-
! scope="col" | Gentoo package
! scope="col" | OpenRC service
! scope="col" | systemd unit 
! scope="col" | Notes
|-
! scope="row" rowspan="29" | {{Package|sys-apps/openrc}} ({{Package|sys-apps/systemd}})
| bootmisc ||  || 
|-
| consolefont ||  || 
|-
| devfs ||  || 
|-
| dmesg ||  || 
|-
| fsck || fsck*.service || pulled in implicitly by mounts
|-
| functions.sh || See note || {{Bug|373219}}
|-
| hostname ||  || 
|-
| hwclock ||  || 
|-
| keymaps ||  || 
|-
| killprocs ||  || 
|-
| local ||  || 
|-
| localmount || local-fs.target || always enabled
|-
| modules || systemd-modules-load.service || always enabled, uses <tt>/etc/modules-load.d/*.conf</tt>
|-
| mount-ro ||  || 
|-
| mtab ||  || 
|-
| net.lo ||  || 
|-
| netmount ||  || 
|-
| network ||  || 
|-
| numlock ||  || 
|-
| procfs ||  || 
|-
| root ||  || 
|-
| savecache ||  || 
|-
| staticroute ||  || 
|-
| swap ||  || 
|-
| swclock ||  || 
|-
| sysctl ||  || 
|-
| sysfs ||  || 
|-
| termencoding ||  || 
|-
| urandom ||  || 
|-
! scope="row" rowspan="2" | {{Package|net-misc/openssh}}
! scope="row" rowspan="2" | sshd
| sshd.service || runs sshd as a daemon
|-
| sshd.socket || runs sshd on a inetd-like basis (for each incoming connection)
|-
|}

= Links =
* [http://www.freedesktop.org/wiki/Software/systemd systemd homepage]
* [http://www.freedesktop.org/wiki/Software/systemd/TipsAndTricks Tips and tricks]
* [http://www.freedesktop.org/wiki/Software/systemd/FrequentlyAskedQuestions FAQ]

[[Category:Core system]]
