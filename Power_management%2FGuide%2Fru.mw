<languages />


{{Metadata|abstract=В последнее время управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, различные функции сохранения заряда батареи также должны поддерживаться операционной системой. В этом руководстве будет описана установка системы Gentoo таким образом, чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.}}

В последнее время управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, различные функции сохранения заряда батареи также должны поддерживаться операционной системой. В этом руководстве будет описана установка системы Gentoo таким образом, чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.

== Введение ==

=== О данном документе ===

В этом документе описана настройка функций управления питанием на ноутбуке. Хотя некоторую информацию из этого руководства можно применить к управлению питанием на сервере, это не является целью данного документа. Будьте осторожны при применении инструкций на системах, отличных от ноутбуков. 

В этом документе мы прежде всего сосредоточимся на пакете laptop-mode-tools, так как в нем предлагается полный набор функций. Все же, мы также обратимся и к другим инструментам, предлагающим более детальный подход к индивидуальным настройкам. В этом случае необходимо отключить некоторые функции пакета laptop-mode-tools, так чтобы два инструмента не сражались за доступ к одному и тому же ресурсу. 

=== Описание laptop_mode ===

Настройке <code>laptop_mode</code> — эта настройка конфигурации ядра, которая оптимизирует запросы ввода-вывода, позволяя дискам вращаться должным образом (а не просыпаться сразу же после поставленных в очередь операций). 

=== О пакете laptop-mode-tools ===

Пакет ''Laptop Mode Tools'' - это пакет программ ({{Package|app-laptop/laptop-mode-tools}}), позволяющий оптимизировать функции сохранения заряда батареи. Он управляет настройкой ядра Linux laptop_mode, но при этом имеет дополнительные функции, разрешающие настроить другие параметры системы, связанные с питанием. 

== Конфигурация ядра Linux ==

=== Минимальные настройки ядра ===

В дереве Portage имеются различные исходные коды ядра. Рекомендуется использование {{Package|sys-kernel/gentoo-sources}}, но если необходима расширенная поддержка гибернации, то может подойти {{Package|sys-kernel/tuxonice-sources}}. Для включения подходящих функций управления питанием, включите по крайней мере следующие настройки ядра Linux: 

{{KernelBox|title=Minimum kernel setup for Power Management|1=<pre>
Power management and ACPI options --->
  [*] Run-time PM core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
    [*] Power Management Timer Support
  
  [*] CPU Frequency scaling --->
    [*] CPU Frequency scaling
    <*>   'performance' governor
    <*>   'powersave' governor
    <*>   'userspace' governor
    <*>   'ondemand' governor
    <*>   'conservative' governor
    <*> ACPI Processor P-States driver
</pre>}}

Не забудьте включить драйвер масштабирования частоты центрального процессора (CPU frequency scaling driver) для процессора, расположенный сразу после ''ACPI Processor P-States driver'', упомянутого выше. 

Для более подробного описания смотрите статью [[Power management/Processor/ru#.D0.AF.D0.B4.D1.80.D0.BE|Управление питанием/Процессор]].

[[Kernel/Rebuild|Build and install]] the new kernel (if necessary) and reboot.

== Использование пакета Laptop Mode Tools ==

=== Установка ===

То, что установка пакета ''Laptop Mode Tools'' легко выполняется командой <code>emerge laptop-mode-tools</code>, не вызывает никаких вопросов. Однако, в этом пакете имеются дополнительные, необязательные настройки, включаемые через USE-флаги. Поэтому давайте сначала рассмотрим поддерживаемые USE-флаги, и что они означают для пакета. 

{| class="wikitable" style="text-align: left;" 
|- 
! USE-флаг
! Описание
! Применяется когда...
|- 
| acpi
| Зависит от <code>sys-power/acpid</code> , так, чтобы изменения системы фиксировались и функции сохранения заряда автоматически включались/отключались.
| ноутбук не является слишком старым (~ 2003 года и позже)
|- 
| apm
| Зависит от <code>sys-apps/apmd</code> , так, чтобы изменения системы фиксировались и функции сохранения заряда автоматически включались/отключались.
| ноутбук очень старый
|- 
| bluetooth
| Зависит от <code>net-wireless/bluez</code>, что позволяет <code>laptop-mode-tools</code> управлять настройками bluetooth (включая и отключая данный сервис, основываясь на состоянии батареи.)
| ноутбук (и ядро) поддерживают bluetooth
|- 
| scsi
| Зависит от <code>sys-apps/sdparm</code>, что позволяет <code>laptop-mode-tools</code> управлять параметрами диска SCSI (''а не'' SATA).
| ноутбук использует SCSI-диски
|-
|}

Как видите, существуют два противоречащих друг другу USE-флага: <code>acpi</code> и <code>apm</code> . Итак, в чем же здесь дело? 

* USE-флаг <code>apm</code> включает поддержку ''Advanced Power Management'' , более старого (до 2000-го года) стандарта системных функций управления питанием.
* USE-флаг <code>acpi</code> включает поддержку ''Advanced Configuration and Power Interface'' , преемника APM. Все современные ноутбуки поддерживают ACPI.

В зависимости от системы, необходимо установить или <code>acpi</code> , или <code>apm</code> . В остальной части этого руководства предполагается, что ваш ноутбук достаточно современен для использования ACPI. 

Итак, давайте установим пакет <code>laptop-mode-tools</code> с этим набором USE-флагов.

{{Emerge|laptop-mode-tools}}

=== Конфигурация ===

Установка на систему пакета <code>laptop-mode-tools</code> не включает необходимые функции управления питанием автоматически. Чтобы настроить пакет, сначала взгляните на файл {{Path|/etc/laptop-mode/laptop-mode.conf}} . Это основной файл конфигурации пакета, и он довольно хорошо прокомментирован. 

Но это не единственный файл конфигурации. Пакет Laptop Mode Tools поддерживает расширения (или модули), имеющие их собственные файлы конфигурации. Эти файлы расположены в каталоге {{Path|/etc/laptop-mode/conf.d}} и названы так же, как и модули, которые они представляют (например, {{Path|intel-sata-powermgmt.conf}}). 

Далее, одной из важных настроек в каждом файле конфигурации является то, должен ли пакет Laptop Mode Tools управлять отдельными параметрами или нет. Это важно при совмещении <code>laptop-mode-tools</code> с другими службами, такими как <code>cpufreqd</code> . В этом примере требуется установить <code>CONTROL_CPU_FREQUENCY=0</code> : 

{{File|/etc/laptop-mode/conf.d/cpufreq.conf||<pre>
CONTROL_CPU_FREQUENCY=0
</pre>
}}

Следующие несколько разделов помогут в настройке пакета <code>laptop-mode-tools</code> в соответствии с вашими нуждами. По завершении запустите службу <code>laptop_mode</code> и убедитесь, что она запускается при загрузке системы. 

{{RootCmd|rc-service laptop_mode start
|rc-update add laptop_mode default}}

=== Как работает laptop-mode-tools ===

После запуска служба <code>laptop_mode</code> проверяет в каком состоянии находится система. Состояния определены следующим образом: 

*  ''Battery'' , активное когда система работает от батареи; файлами конфигурации используется префикс <code>BATT_</code> для настроек, связанных с этим состоянием
*  ''AC'' , активное когда система работает от сети переменного тока; файлами конфигурации используется префикс <code>AC_</code> для настроек, связанных с этим состоянием
*  ''Laptop Mode'' , активное когда включен ''laptop mode''; файлы конфигурации используют префикс <code>LM_</code> для настроек, связанных с этим состоянием
*  ''No Laptop Mode'' , активное когда ''laptop mode'' отключен; файлы конфигурации используют префикс <code>NOLM_</code> для настроек, связанных с этим состоянием

Префиксы <code>AC/BATT_</code> и <code>LM/NOLM_</code> могут быть совмещены (так что возможно использование префикса <code>AC_LM_</code>). 

После запуска службы <code>laptop_mode</code>, режимы переключаются в зависимости от возникающих событий (и, конечно же, в зависимости от настроек конфигурации). Например, параметр <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code> заставит laptop mode tools переключаться в режим ''laptop mode'' при истечении заряда батареи. В этом случае используются настройки, начинающиеся с <code>LM_</code> , <code>LM_BATT_</code> , <code>BATT_LM_</code> и <code>BATT_</code> . 

Чтобы настройки не конфликтовали друг с другом, не разрешается иметь частично совпадающие настройки. В следующем примере первая группа настроек (для <code>CPU_MAXFREQ</code> ) является верной, но вторая (для <code>CPU_GOVERNOR</code> ) — нет. 

{{Code|Частично совпадающие настройки|<pre>
## Правильный набор настроек
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Неправильный набор
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# Следующее включает AC и BATT, но параметр BATT уже определен
NOLM_CPU_MINFREQ=fastest
</pre>
}}

=== Настройка управления частотой CPU ===

Поддержка управления частотой центрального процессора в пакете laptop mode tools позволяет переключение частот. Поддерживается настройка регулятора частоты процессора (CPU frequency governor), минимальная и максимальная частоты. Используемым файлом конфигурации является {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}} .

''Регулятор частоты процессора'' (CPU frequency governor) — это политика уровня ядра, которая определяет как ядро выбирает частоту центрального процессора. Ранее мы уже выбрали регуляторы, которые хотим использовать, в конфигурации ядра. Давайте это просуммируем: 

*  <code>performance</code> всегда подбирает наибольшую частоту
*  <code>powersave</code> всегда подбирает наименьшую частоту
*  <code>userspace</code> не выбирает ничего, но позволяет пользователю решить (или любому пользовательскому процессу, который решит за пользователя)
*  <code>ondemand</code> повышает частоту центрального процессора до наивысшей, при доступной нагрузке
*  <code>conservative</code> постепенно повышает частоту центрального процессора, при доступной нагрузке

При переключении между питанием от сети (AC) или батареей, или laptop mode, выбирается подходящий регулятор (наряду с минимальной и максимальной частотами) 

=== Настройка яркости дисплея ===

С помощью файла {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}} можно заставить пакет laptop mode tools управлять яркостью ЖК-дисплея. 

В данный момент для установки значений яркости используется файл {{Path|/proc/acpi/video/VID/LCD/brightness}} ([https://bugs.gentoo.org/show_bug.cgi?id=499544 bug 499544]) . Недавние версии ядер больше это не предусматривают - вместо этого необходимо настроить {{Path|/sys/class/backlight/acpi_video0/brightness}} . 

Значения, которые можно использовать, лежат в пределах от 0 до 15, с нулем в качестве наименьшего значения яркости.

=== Настройка других служб ===

Интересной особенностью пакета <code>laptop-mode-tools</code> является поддержка перезагрузки отдельных служб (таких как системный логгер) после переключения файла конфигурации. Это настраивается через {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}} . 

Если это включено, приложение <code>laptop_mode</code> переключает файлы конфигурации упомянутых сервисов на такой же файл, но с суффиксом {{Path|-nolm-ac}} , {{Path|-lm-ac}} или {{Path|-batt}} . Затем оно подает сигнал или перезагружает соответствующие службы, чтобы они могли использовать новый файл конфигурации. 

== Использование cpufreqd ==

{{Warning/ru|Пакет sys-power/cpufreqd был объявлен устаревшим и был удален из дерева Portage.}}

=== Установка ===

The {{c|cpufreqd}} application allows the user to manage CPU frequencies in a more granular approach than what laptop-mode-tools supports. But before we dive into the installation of {{c|cpufreqd}}, let us first look at the USE flags it supports. 

{| class="wikitable" style="text-align: left;" 
|- 
! USE flag
! Description
! Suggested when...
|- 
| <code>acpi</code>
| Enable support for ACPI, allowing {{c|cpufreqd}} to be notified about specific events as well as govern power through the ACPI interface
| the laptop is not very old (around year 2003 and later)
|- 
| <code>apm</code>
| Enable support for APM, allowing {{c|cpufreqd}} to be notified about specific events as well as govern power through the APM interface
| the laptop is very old
|- 
| <code>lm_sensors</code>
| Enable support for the Linux hardware sensors (through {{Package|sys-apps/lm_sensors}}), allowing to switch profiles based on hardware sensor results
| using advanced events through lm_sensors
|- 
| <code>nforce2</code>
| Enable support for NForce, allowing {{c|cpufreqd}} to change the NForce FSB clock and video card frequency
| an NVidia graphics card based on the NForce chipset is present
|- 
| <code>nvidia</code>
| Enable support for NVidia graphical card configuration (through the NVidia ''nvclock'' interface), allowing {{c|cpufreqd}} to change the video card frequency of NVidia graphical cards
| an NVidia graphics card is present
|- 
| <code>pmu</code>
| Enable the Power Management Unit plug-in of {{c|cpufreqd}}. This allows the software to poll the Linux kernel Power Supply interface, getting more detailed information on battery charge
| the laptop does not support ACPI or APM
|-
|}

USE-флаги <code>acpi</code> , <code>apm</code> и <code>pmu</code> накладываются друг на друга, поэтому необходимо включить только один из них. Если ноутбук довольно современный, <code>acpi</code> является лучшим выбором. Если это не так, <code>apm</code> предлагает все, что необходимо. Когда даже APM не поддерживается, можете попробовать <code>pmu</code> . 

With the USE flags configured, it is time to install {{c|cpufreqd}}. 

{{Emerge|cpufreqd}}

=== Конфигурация ===

The {{c|cpufreqd}} application monitors the status of the system through several plugins. Based on the feedback it receives from those plugins, it will adjust the policy used to govern the CPU frequency. 

{{c|cpufreqd}} can be configured by editing {{Path|/etc/cpufreqd.conf}}. It contains three different sections: 

# В разделе <code>[General]...[/General]</code> хранятся основные настройки
# Разделом <code>[Profile]...[/Profile]</code> определяются политики, на которые может переключаться <code>cpufreqd</code> . Этот раздел очень схож с информацией, использованной ранее при настройке частоты процессора вручную с использованием <code>cpufreq-set</code> .
# Раздел <code>[Rule]...[/Rule]</code> - это рабочая лошадка демона <code>cpufreqd</code> , определяющая когда демон решает переключиться на другой профиль.

Давайте взглянем на пример правила. 

{{File|/etc/cpufreqd.conf|Пример правила cpufreqd|<pre>
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
</pre>
}}

In the above example, {{c|cpufreqd}} will switch the system to the ''On Demand High'' profile (also shown in the above excerpt). This profile by itself uses the ondemand governor with a minimum frequency of 40% (iow, a CPU of 2 GHz will have by this policy a minimum frequency of 800 MHz). 

As you can see, the {{c|cpufreqd}} application can offer a more granular approach on CPU frequency scaling. But not only that, you can tweak the CPU frequency scaling based on various other metrics available. The default configuration offers a sample rule for when you watch a movie, where you want maximum performance, unless the CPU temperature is getting too high. 

When you have configured {{c|cpufreqd}}, it is time to start it (and make sure the service is loaded automatically). Make sure that CPU frequency handling by other tools (like laptop-mode-tools) is disabled! 

{{RootCmd|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start}}

== Внешние ссылки ==

=== Инструменты ===

*  [http://samwel.tk/laptop_mode/ Домашняя страница Laptop Mode Tools] , включая [http://samwel.tk/laptop_mode/laptop_mode Описание laptop mode] .
*  [https://01.org/powertop PowerTOP] , интерактивное приложение, помогающее пользователям узнать какие процессы вызывают пробуждение CPU наиболее часто.

=== Статьи и Руководства ===

Статья ThinkWiki о том [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption Как уменьшить потребление питания] (на Linux). Эта статья предлагает исчерпывающий список измерений для проведения. Однако, следует заметить что laptop mode tools реализует большинство из них (если настроен правильным образом).

== See also ==

* [[USB Power Saving]]

[[Category:Power management]]
