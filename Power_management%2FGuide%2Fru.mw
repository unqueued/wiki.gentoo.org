<languages />


{{Metadata|abstract=В последнее время управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, различные функции сохранения заряда батареи также должны поддерживаться операционной системой. В этом руководстве будет описана установка Gentoo таким образом, чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.}}

В последнее время управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, различные функции сохранения заряда батареи также должны поддерживаться операционной системой. В этом руководстве будет описана настройка Gentoo таким образом, чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.

== Введение ==

=== О данном документе ===

В этом документе описана настройка функций управления питанием на ноутбуке. Хотя некоторую информацию из этого руководства можно применить к управлению питанием на сервере, это не является целью данного документа. Будьте осторожны при применении инструкций на системах, отличных от ноутбуков. 

В этом документе прежде всего сосредоточимся на пакете laptop-mode-tools, так как в нем предлагается полный набор функций. Все же, мы также обратимся и к другим инструментам, предлагающим более детальный подход к индивидуальным настройкам. В этом случае необходимо отключить некоторые функции пакета laptop-mode-tools, так чтобы два инструмента не сражались за доступ к одному и тому же ресурсу. 

=== Описание laptop_mode ===

Настройке laptop_mode — эта настройка конфигурации ядра, которая оптимизирует запросы ввода-вывода, позволяя дискам вращаться должным образом (а не просыпаться сразу же после поставленных в очередь операций). 

=== О пакете laptop-mode-tools ===

Пакет ''Laptop Mode Tools'' - это пакет программ ({{Package|app-laptop/laptop-mode-tools}}), позволяющий оптимизировать функции сохранения заряда батареи. Он позволяет управляет настройкой laptop_mode в ядре Linux, но при этом имеет дополнительные функции, которые позволяют настроить другие параметры системы, связанные с питанием.

== Конфигурация ядра Linux ==

=== Минимальные настройки ядра ===

В дереве Portage имеются разные пакеты с исходным кодом ядра. Мы рекомендуем использовать {{Package|sys-kernel/gentoo-sources}}, но если необходима расширенная поддержка гибернации, то может подойти {{Package|sys-kernel/tuxonice-sources}}. Для включения подходящих функций управления питанием в ядре Linux, включите следующие настройки: 

{{KernelBox|title=Минимальные настройки ядра для управления питанием|1=<pre>
Power management and ACPI options --->
  [*] Run-time PM core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
    [*] Power Management Timer Support
  
  [*] CPU Frequency scaling --->
    [*] CPU Frequency scaling
    <*>   'performance' governor
    <*>   'powersave' governor
    <*>   'userspace' governor
    <*>   'ondemand' governor
    <*>   'conservative' governor
    <*> ACPI Processor P-States driver
</pre>}}

Не забудьте включить драйвер масштабирования частоты центрального процессора (CPU frequency scaling driver) для процессора, расположенный сразу после ''ACPI Processor P-States driver'', упомянутого выше. 

Для более подробного описания смотрите статью [[Power management/Processor/ru#.D0.AF.D0.B4.D1.80.D0.BE|Управление питанием/Процессор#Ядро]].

[[Kernel/Rebuild|Соберите и установите]] новое ядро (если это необходимо) и перезагрузитесь.

== Использование пакета Laptop Mode Tools ==

=== Установка ===

Установка пакета ''Laptop Mode Tools'' не должна вызывать никаких вопросов и легко выполняется с помощью команды:

{{Emerge|app-laptop/laptop-mode-tools}}.

Однако, в этом пакете имеются дополнительные, необязательные настройки, включаемые через USE-флаги. Поэтому давайте сначала рассмотрим поддерживаемые USE-флаги, и что они означают для пакета. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! USE-флаг
! Описание
! Применяется когда...
|- 
| <code>acpi</code>
| Зависит от {{Package|sys-power/acpid}}, так, чтобы изменения системы фиксировались и функции сохранения энергии автоматически включались/отключались.
| ноутбук не является слишком старым (примерно 2003 года и позже)
|- 
| <code>apm</code>
| Зависит от {{Package|sys-apps/apmd}}, так, чтобы изменения системы фиксировались и функции сохранения заряда автоматически включались/отключались.
| ноутбук очень старый
|- 
| <code>bluetooth</code>
| Зависит от {{Package|net-wireless/bluez}}, что позволяет laptop-mode-tools управлять настройками bluetooth (включая и отключая данный сервис, основываясь на состоянии батареи.)
| ноутбук (и ядро) поддерживают bluetooth
|- 
| <code>scsi</code>
| Зависит от {{Package|sys-apps/sdparm}}, что позволяет <code>laptop-mode-tools</code> управлять параметрами диска SCSI (''а не'' SATA).
| ноутбук использует SCSI-диски
|-
|}

Заметим, что существуют два противоречащих друг другу USE-флага: <code>acpi</code> и <code>apm</code>. Итак, в чем же дело? 

* USE-флаг <code>apm</code> включает поддержку ''Advanced Power Management'', более старого (до 2000-го года) стандарта системных функций управления питанием.
* USE-флаг <code>acpi</code> включает поддержку ''Advanced Configuration and Power Interface'', преемника APM. Все современные ноутбуки поддерживают ACPI.

В зависимости от системы, необходимо установить или <code>acpi</code>, или <code>apm</code>. В остальной части этого руководства предполагается, что ноутбук достаточно современен для использования ACPI. 

Итак, после настройки USE-флагов, установите пакет laptop-mode-tools:

{{Emerge|laptop-mode-tools}}

=== Конфигурация ===

Установка на систему пакета laptop-mode-tools не включает необходимые функции управления питанием автоматически. Чтобы настроить пакет, сначала взгляните на файл {{Path|/etc/laptop-mode/laptop-mode.conf}}. Это основной файл конфигурации пакета, и он довольно хорошо прокомментирован. 

Но это не единственный файл конфигурации. Пакет Laptop Mode Tools поддерживает расширения (или модули), имеющие их собственные файлы конфигурации. Эти файлы расположены в каталоге {{Path|/etc/laptop-mode/conf.d}} и названы так же, как и модули, которые они представляют (например, {{Path|intel-sata-powermgmt.conf}}). 

Далее, одной из важных настроек в каждом файле конфигурации является то, должен ли пакет laptop-mode-tools управлять отдельными параметрами или нет. Это важно при совмещении laptop-mode-tools с другими сервисами сохранения энергии, такими как {{c|cpufreqd}}. В этом примере требуется установить <code>CONTROL_CPU_FREQUENCY=0</code>: 

{{FileBox|filename=/etc/laptop-mode/conf.d/cpufreq.conf|1=
CONTROL_CPU_FREQUENCY=0
}}

Следующие несколько разделов помогут пользователю с настройкой пакета laptop-mode-tools в соответствии с нуждами. По завершении запустите сервис laptop_mode и убедитесь, что он запускается во время загрузке системы. 

{{RootCmd
|rc-service laptop_mode start
|rc-update add laptop_mode default
}}

=== Как работает laptop-mode-tools ===

После запуска сервиса laptop_mode, программа проверяет в каком состоянии находится система. Состояния определены следующим образом: 

*  ''Battery'', активно когда система работает от батареи; файлами конфигурации используется префикс <code>BATT_</code> для настроек, связанных с этим состоянием;
*  ''AC'', активно когда система работает от сети переменного тока; файлами конфигурации используется префикс <code>AC_</code> для настроек, связанных с этим состоянием;
*  ''Laptop Mode'', активно когда включен ''laptop mode''; файлы конфигурации используют префикс <code>LM_</code> для настроек, связанных с этим состоянием;
*  ''No Laptop Mode'', активно когда ''laptop mode'' отключен; файлы конфигурации используют префикс <code>NOLM_</code> для настроек, связанных с этим состоянием.

Префиксы <var>AC/BATT_</var> и <var>LM/NOLM_</var> могут быть совмещены так, чтобы получился префикс <var>AC_LM_</var>. 

После запуска сервиса laptop_mode, режимы переключаются в зависимости от возникающих событий (и, конечно же, в зависимости от настроек конфигурации). Например, параметр <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code> заставит laptop mode tools переключаться в режим ''laptop mode'' при истечении заряда батареи. В этом случае используются настройки, начинающиеся с <code>LM_</code>, <code>LM_BATT_</code>, <code>BATT_LM_</code> и <code>BATT_</code>. 

Чтобы настройки не конфликтовали друг с другом, не разрешается иметь частично совпадающие настройки. В следующем примере первая группа настроек (для <code>CPU_MAXFREQ</code>) является верной, но вторая (для <code>CPU_GOVERNOR</code>) — нет. 

{{CodeBox|title=Частично совпадающие настройки|1=
## Правильный набор настроек
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Неправильный набор
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# Следующее включает AC и BATT, но параметр BATT уже определен
NOLM_CPU_MINFREQ=fastest
}}

=== Настройка управления частотой CPU ===

Поддержка управления частотой центрального процессора в пакете laptop mode tools позволяет переключение частот. Поддерживается настройка регулятора частоты процессора (CPU frequency governor), минимальная и максимальная частоты. Используемым файлом конфигурации является {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}} .

''Регулятор частоты процессора'' (CPU frequency governor) — это политика уровня ядра, которая определяет как ядро выбирает частоту центрального процессора. Ранее мы уже выбрали регуляторы, которые хотим использовать, в конфигурации ядра. Давайте это просуммируем: 

*  <code>performance</code> всегда подбирает наибольшую частоту
*  <code>powersave</code> всегда подбирает наименьшую частоту
*  <code>userspace</code> не выбирает ничего, но позволяет пользователю решить (или любому пользовательскому процессу, который решит за пользователя)
*  <code>ondemand</code> повышает частоту центрального процессора до наивысшей, при доступной нагрузке
*  <code>conservative</code> постепенно повышает частоту центрального процессора, при доступной нагрузке

При переключении между питанием от сети (AC) или батареей, или laptop mode, выбирается подходящий регулятор (наряду с минимальной и максимальной частотами) 

=== Настройка яркости дисплея ===

С помощью файла {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}} можно заставить пакет laptop mode tools управлять яркостью ЖК-дисплея. 

В данный момент для установки значений яркости используется файл {{Path|/proc/acpi/video/VID/LCD/brightness}} ([https://bugs.gentoo.org/show_bug.cgi?id=499544 bug 499544]). Недавние версии ядер больше это не предусматривают - вместо этого необходимо настроить {{Path|/sys/class/backlight/acpi_video0/brightness}}. 

Значения, которые можно использовать, лежат в пределах от 0 до значения в {{Path|/sys/class/backlight/acpi_video0/max_brightness}}, с нулем в качестве наименьшего значения яркости.

=== Настройка других сервисов ===

Интересной особенностью пакета laptop-mode-tools является поддержка перезагрузки отдельных сервисов (таких как системный журнал) после переключения файла конфигурации. Это настраивается через {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}}. 

Если это включено, приложение laptop_mode переключает файлы конфигурации упомянутых сервисов на такой же файл, но с суффиксом {{Path|-nolm-ac}}, {{Path|-lm-ac}} или {{Path|-batt}}. Затем оно подает сигнал или перезагружает соответствующие сервисы, чтобы они могли использовать новый файл конфигурации. 

== Использование cpufreqd ==

{{Warning|Пакет {{Package|sys-power/cpufreqd}} был объявлен устаревшим и был удален из дерева Portage.}} Пакет {{Package|sys-power/ncpufreqd}} все еще можно использовать для [https://bitbucket.org/nelchael/ncpufreqd 2.6.x kernels].

=== Установка ===

Приложение {{c|cpufreqd}} позволяет пользователю управлять частотой процессора с помощью более модульного подхода, чем тот, который поддерживает laptop-mode-tools. Но перед тем как мы погрузимся в установку {{c|cpufreqd}}, давайте сперва рассмотрим поддерживаемые им USE-флаги. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! USE-флаг
! Описание
! Применяется когда...
|- 
| <code>acpi</code>
| Включает поддержку ACPI, позволяя {{c|cpufreqd}} получать уведомления об отдельных событиях, а также управлять питанием через интерфейс ACPI
| ноутбук не очень стар (~ 2003-го года и позже)
|- 
| <code>apm</code>
| Включает поддержку APM, позволяя {{c|cpufreqd}} получать уведомления об отдельных событиях, а также управлять питанием через интерфейс APM
| ноутбук очень старый
|- 
| <code>lm_sensors</code>
| Включает поддержку аппаратных датчиков Linux (через {{Package|sys-apps/lm_sensors}}), позволяя переключать профили в зависимости от результатов аппаратных датчиков
| используются расширенные события через lm_sensors
|- 
| <code>nforce2</code>
| Включает поддержку Nforce, позволяя {{c|cpufreqd}} изменять тактовую частоту NForce FSB (Front Side Bus) и частоту графической платы
| используется графическая плата NVidia, основанная на чипсете NForce
|- 
| <code>nvidia</code>
| Включает поддержку настройки графической платы NVidia (через интерфейс NVidia ''nvclock''), позволяя {{c|cpufreqd}} изменять частоту графической платы видеокарт NVidia
| используется графическая плата NVidia
|- 
| <code>pmu</code>
| Включает плагин модуля управления питанием (Power Management Unit plugin) {{c|cpufreqd}}. Это позволяет программному обеспечению опрашивать интерфейс снабжения питанием ядра Linux (Linux kernel Power Supply), получая более подробную информацию о заряде батареи.
| ноутбук не поддерживает ACPI или APM
|-
|}

USE-флаги <code>acpi</code>, <code>apm</code> и <code>pmu</code> накладываются друг на друга, поэтому необходимо включить только один из них. Если ноутбук довольно современный, <code>acpi</code> является лучшим выбором. Если это не так, <code>apm</code> предлагает все, что необходимо. Когда даже APM не поддерживается, можете попробовать <code>pmu</code>. 

После того как USE-флаги настроены, настало время установить {{c|cpufreqd}}. 

{{Emerge|cpufreqd}}

=== Конфигурация ===

Состояние системы контролируется приложением {{c|cpufreqd}} с помощью нескольких плагинов. Основываясь на отклике, получаемом от этих плагинов, настраивается политика, используемая для регулирования частоты CPU. 

{{c|cpufreqd}} может быть настроен редактированием {{Path|/etc/cpufreqd.conf}}. Этот файл содержит три разных раздела: 

# В разделе <code>[General]...[/General]</code> хранятся основные настройки.
# Разделом <code>[Profile]...[/Profile]</code> определяются политики, на которые может переключаться cpufreqd. Этот раздел очень схож с информацией, использованной ранее при настройке частоты процессора вручную с использованием cpufreq-set.
# Раздел <code>[Rule]...[/Rule]</code> - это рабочая лошадка демона cpufreqd, определяющая когда демон решает переключиться на другой профиль.

Взглянем на пример правила. 

{{FileBox|filename=/etc/cpufreqd.conf|title=Пример правила cpufreqd|1=
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
}}

В примере выше, {{c|cpufreqd}} переключает систему на профиль ''On Demand High'' (также показанный в предыдущем отрывке). Этот профиль использует регулятор ondemand с минимальной частотой в 40 % (другими словами, процессор с частотой 2 ГГц будет иметь в соответствии с этой политикой минимальную частоту 800 МГц). 

Приложение {{c|cpufreqd}} предлагает более модульный подход к масштабированию частоты CPU. Но частоту CPU можно настроить в соответствии с различными другими доступными показателями. Конфигурация по умолчанию предлагает образец правила: для просмотра кино требуется максимальная производительность (пока температура CPU не станет очень высокой). 

После настройки {{c|cpufreqd}} нужно его запустить (и убедиться, что сервис загружается автоматически). Убедитесь, что регулирование частоты CPU другими инструментами (такими как laptop-mode-tools) отключена! 

{{RootCmd
|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start
}}

== Смотрите также ==

* [[USB Power Saving]]

== Ссылки ==

*  [http://samwel.tk/laptop_mode/ Laptop Mode Tools Homepage] и [http://samwel.tk/laptop_mode/laptop_mode About laptop mode].
*  [https://01.org/powertop PowerTOP], интерактивное приложение поможет пользователям узнать, какие процессы заставляют пробуждатся CPU чаще всего.
* ThinkWiki статья на [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption как уменьшить потребление энергии] (на Linux). Эта статья содержит исчерпывающий список мер, которые можно предпринять. Тем не менее, следует отметить, что в laptop mode tools реализовано большинство из них (если правильно настроить).

[[Category:Power management]]
