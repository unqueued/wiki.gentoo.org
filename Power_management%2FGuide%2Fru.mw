<languages />


{{Metadata|abstract=В последнее время управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, различные функции сохранения заряда батареи также должны поддерживаться операционной системой. В этом руководстве будет описана установка системы Gentoo таким образом, чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.}}

В последнее время управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, различные функции сохранения заряда батареи также должны поддерживаться операционной системой. В этом руководстве будет описана установка системы Gentoo таким образом, чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.

== Введение ==

=== О данном документе ===

В этом документе описана настройка функций управления питанием на ноутбуке. Хотя некоторую информацию из этого руководства можно применить к управлению питанием на сервере, это не является целью данного документа. Будьте осторожны при применении инструкций на системах, отличных от ноутбуков. 

В этом документе мы прежде всего сосредоточимся на пакете laptop-mode-tools, так как в нем предлагается полный набор функций. Все же, мы также обратимся и к другим инструментам, предлагающим более детальный подход к индивидуальным настройкам. В этом случае необходимо отключить некоторые функции пакета laptop-mode-tools, так чтобы два инструмента не сражались за доступ к одному и тому же ресурсу. 

=== Описание laptop_mode ===

Настройке <code>laptop_mode</code> - эта настройка конфигурации ядра, которая оптимизирует запросы ввода-вывода, позволяя дискам вращаться должным образом (а не просыпаться сразу же после поставленных в очередь операций). 

=== О пакете laptop-mode-tools ===

Пакет ''Laptop Mode Tools'' - это пакет программ ( <code>app-laptop/laptop-mode-tools</code> ), позволяющий оптимизировать функции сохранения заряда батареи. Он управляет настройкой ядра Linux <code>laptop_mode</code> , но при этом имеет дополнительные функции, разрешающие настроить другие параметры системы, связанные с питанием. 

== Конфигурация ядра Linux ==

=== Минимальные настройки ядра ===

В дереве портежей имеются различные исходные коды ядра. Рекомендуется использование <code>gentoo-sources</code> , но если необходима расширенная поддержка гибернации, то могут потребоваться <code>tuxonice-sources</code> . Для включения подходящих функций управления питанием, включите по крайней мере следующие настройки ядра Linux: 

{{Kernel|Минимальные настройки ядра для управления питанием|<pre>
General setup --->
  [*] Configure standard kernel features (expert users) --->
  
Power management and ACPI options --->
  [*] Run-time PM core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
    [*] Power Management Timer Support
  
  [*] CPU Frequency scaling --->
    [*] CPU Frequency scaling
    <*>   'performance' governor
    <*>   'powersave' governor
    <*>   'userspace' governor
    <*>   'ondemand' governor
    <*>   'conservative' governor
    <*> ACPI Processor P-States driver
</pre>
}}

Не забудьте включить драйвер масштабирования частоты центрального процессора (CPU frequency scaling driver) для вашего типа процессора, расположенный сразу после ''ACPI Processor P-States driver'', упомянутого выше. 

Соберите и установите новое ядро (если это необходимо) и перезагрузитесь. 

== Использование пакета Laptop Mode Tools ==

=== Установка ===

То, что установка пакета ''Laptop Mode Tools'' легко выполняется командой <code>emerge laptop-mode-tools</code> , не вызывает никаких вопросов. Однако, в этом пакете имеются дополнительные, необязательные настройки, включаемые через конфигурацию USE-флагов. Поэтому давайте сначала рассмотрим поддерживаемые USE-флаги и что они означают для пакета. 

{| class="wikitable" style="text-align: left;" 
|- 
! USE-флаг
! Описание
! Применяется когда...
|- 
| acpi
| Зависит от <code>sys-power/acpid</code> , так, чтобы изменения системы фиксировались и функции сохранения заряда автоматически включались/отключались.
| ноутбук не является слишком старым (~ 2003 года и позже)
|- 
| apm
| Зависит от <code>sys-apps/apmd</code> , так, чтобы изменения системы фиксировались и функции сохранения заряда автоматически включались/отключались.
| ноутбук очень старый
|- 
| bluetooth
| Зависит от <code>net-wireless/bluez</code>, что позволяет <code>laptop-mode-tools</code> управлять настройками bluetooth (включая и отключая данный сервис, основываясь на состоянии батареи.)
| ноутбук (и ядро) поддерживают bluetooth
|- 
| scsi
| Зависит от <code>sys-apps/sdparm</code>, что позволяет <code>laptop-mode-tools</code> управлять параметрами диска SCSI (''а не'' SATA).
| ноутбук использует SCSI-диски
|-
|}

Как видите, существуют два противоречащих друг другу USE-флага: <code>acpi</code> и <code>apm</code> . Итак, в чем же здесь дело? 

* USE-флаг <code>apm</code> включает поддержку ''Advanced Power Management'' , более старого (до 2000-го года) стандарта системных функций управления питанием.
* USE-флаг <code>acpi</code> включает поддержку ''Advanced Configuration and Power Interface'' , преемника APM. Все современные ноутбуки поддерживают ACPI.

В зависимости от системы, необходимо установить или <code>acpi</code> , или <code>apm</code> . В остальной части этого руководства предполагается, что ваш ноутбук достаточно современен для использования ACPI. 

Итак, давайте установим пакет <code>laptop-mode-tools</code> с этим набором USE-флагов. 

{{Emerge|laptop-mode-tools}}

=== Конфигурация ===

Установка на систему пакета <code>laptop-mode-tools</code> не включает необходимые функции управления питанием автоматически. Чтобы настроить пакет, сначала взгляните на файл {{Path|/etc/laptop-mode/laptop-mode.conf}} . Это основной файл конфигурации пакета и он довольно хорошо описан (с помощью комментариев). 

Но это не единственный файл конфигурации для работы с ним. Пакет Laptop Mode Tools поддерживает расширения (или модули), которые имеют их собственные файлы конфигурации. Эти файлы расположены в {{Path|/etc/laptop-mode/conf.d}} и названы так же, как и модули, которые они представляют (такие как {{Path|intel-sata-powermgmt.conf}}). 

Далее, одной из важных настроек в каждом файле конфигурации является то, должен ли пакет Laptop Mode Tools управлять отдельными настройками или нет. Это важно при совмещении <code>laptop-mode-tools</code> с другими службами, такими как <code>cpufreqd</code> . В этом примере нам нужно установить <code>CONTROL_CPU_FREQUENCY=0</code> : 

{{File|/etc/laptop-mode/conf.d/cpufreq.conf||<pre>
CONTROL_CPU_FREQUENCY=0
</pre>
}}

Следующие несколько разделов помогут в настройке <code>laptop-mode-tools</code>, так, чтобы он удовлетворял вашим нуждам. По завершении запустите службу <code>laptop_mode</code> и убедитесь, что она запускается при загрузке системы. 

{{RootCmd|/etc/init.d/laptop_mode start
|rc-update add laptop_mode default}}

=== Как работает laptop-mode-tools ===

При запуске службы <code>laptop_mode</code> данная программа проверит в каком состоянии находится система. Состояния определены следующим образом: 

*  ''Battery'' , которое активно когда система работает от батареи; файлы конфигурации используют префикс <code>BATT_</code> для настроек, связанных с этим состоянием
*  ''AC'' , которое активно когда система работает от сети; файлы конфигурации используют префикс <code>AC_</code> для настроек, связанных с этим состоянием
*  ''Laptop Mode'' , которое активно когда включен ''laptop mode''; файлы конфигурации используют префикс <code>LM_</code> для настроек, связанных с этим состоянием
*  ''No Laptop Mode'' , которое активно когда ''laptop mode'' отключен; файлы конфигурации используют префикс <code>NOLM_</code> для настроек, связанных с этим состоянием

Префиксы <code>AC/BATT_</code> и <code>LM/NOLM_</code> могут быть совмещены (так что возможно использование префикса <code>AC_LM_</code>). 

Когда служба <code>laptop_mode</code> запускается, она переключает режимы в зависимости от возникающих событий (и, конечно же, в зависимости от настроек конфигурации). Например, настройка <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code> заставит laptop mode tools переключаться в режим ''laptop mode'' когда заряд батареи истек. В этом случае будут использованы настройки, начинающиеся с <code>LM_</code> , <code>LM_BATT_</code> , <code>BATT_LM_</code> и <code>BATT_</code> . 

Чтобы убедиться, что настройки не конфликтуют друг с другом, не разрешается иметь накладывающиеся друг на друга настройки. В следующем примере первая группа настроек (для <code>CPU_MAXFREQ</code> ) является верной, но вторая (для <code>CPU_GOVERNOR</code> ) - нет. 

{{Code|Частично совпадающие настройки|<pre>
## Правильный набор настроек
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Неправильный набор
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# Следующее включает AC и BATT, но BATT уже определена
NOLM_CPU_MINFREQ=fastest
</pre>
}}

=== Настройка управления частотой CPU ===

Поддержка управления частотой центрального процессора в laptop mode tools позволяет переключение частот. Она поддерживает настройку регулятора частоты процессора (CPU frequency governor), минимальную и максимальную частоту. Используемым здесь файлом конфигурации является {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}} . 

''Регулятор частоты процессора'' (CPU frequency governor) - это политика уровня ядра, которая определяет как ядро выбирает частоту CPU. Мы уже выбрали регуляторы, которые хотим использовать, в конфигурации ядра ранее. Давайте это просуммируем: 

*  <code>performance</code> всегда подбирает наибольшую частоту
*  <code>powersave</code> всегда подбирает наименьшую частоту
*  <code>userspace</code> не выбирает ничего, но позволяет пользователю решить (или любому пользовательскому процессу, который решит за пользователя)
*  <code>ondemand</code> повышает частоту CPU до наивысшей частоты при доступной загрузке
*  <code>conservative</code> повышает частоту CPU постепенно при доступной загрузке

При переключении между питанием от сети (AC) или батарей, или laptop mode, выбирается подходящий регулятор (наряду с минимальной и максимальной частотами) 

=== Настройка яркости дисплея ===

С помощью файла {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}} можно заставить пакет laptop mode tools управлять яркостью ЖК-дисплея. 

В данный момент для установки значений яркости используется файл {{Path|/proc/acpi/video/VID/LCD/brightness}} ([https://bugs.gentoo.org/show_bug.cgi?id=499544 bug 499544]) . Недавние версии ядер больше это не предусматривают - вместо этого необходимо настроить {{Path|/sys/class/backlight/acpi_video0/brightness}} . 

Значения, которые можно использовать, лежат в пределах от 0 до 15, с нулем в качестве наименьшего значения яркости.

=== Настройка других служб ===

Интересной особенностью <code>laptop-mode-tools</code> является поддержка перезагрузки отдельных служб (таких как системный логгер), после переключения файла конфигурации. Это настраивается через {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}} . 

Если это включено, приложение <code>laptop_mode</code> переключит файлы конфигурации упомянутых сервисов на такой же файл, но с суффиксом {{Path|-nolm-ac}} , {{Path|-lm-ac}} или {{Path|-batt}} . Затем он подаст сигнал или перезагрузит соответствующие службы, чтобы они могли использовать новый файл конфигурации. 

== Использование cpufreqd ==

=== Установка ===

Приложение <code>cpufreqd</code> позволяет управлять частотой процессора с помощью более модульного подхода, чем тот, который поддерживает <code>laptop-mode-tools</code> . Но перед тем как мы погрузимся в установку <code>cpufreqd</code> , давайте сперва рассмотрим поддерживаемые им USE-флаги. 

{| class="wikitable" style="text-align: left;" 
|- 
! USE-флаг
! Описание
! Применяется когда...
|- 
| acpi
| Включает поддержку ACPI, позволяя <code>cpufreqd</code> получать уведомления об отдельных событиях, а также управлять питанием через интерфейс ACPI
| ноутбук не является слишком старым (~ 2003-го года и позже)
|- 
| apm
| Включает поддержку APM, позволяя <code>cpufreqd</code> получать уведомления об отдельных событиях, а также управлять питанием через интерфейс APM
| ноутбук очень старый
|- 
| lm_sensors
| Включает поддержку аппаратных датчиков Linux (через <code>sys-apps/lm_sensors</code> ) , позволяя переключать профили в зависимости от результатов аппаратных датчиков
| используются расширенные события через lm_sensors
|- 
| nforce2
| Включает поддержку Nforce, позволяя <code>cpufreqd</code> изменять часы NForce FSB и частоту графической платы
| использование графической платы NVidia, основанной на чипсете NForce
|- 
| nvidia
| Включает поддержку настройки графической платы NVidia (через интерфейс NVidia ''nvclock''), позволяя <code>cpufreqd</code> изменять частоту графической платы видеокарт NVidia
| использование графической платы NVidia
|- 
| pmu
| Включает плагин модуля управления питанием (Power Management Unit plugin) <code>cpufreqd</code> . Это позволяет программному обеспечению опрашивать интерфейс снабжения питанием ядра Linux (Linux kernel Power Supply) , получая более подробную информацию о заряде батареи.
| ноутбук не поддерживает ACPI или APM
|-
|}

USE-флаги <code>acpi</code> , <code>apm</code> и <code>pmu</code> накладываются друг на друга, поэтому необходимо включить только один из них. Если ноутбук довольно современный, <code>acpi</code> является лучшим выбором. Если это не так, <code>apm</code> предлагает все, что необходимо. Когда даже APM не поддерживается, вы можете попробовать <code>pmu</code> . 

После того как USE-флаги настроены, пришло время установить <code>cpufreqd</code> . 

{{Emerge|cpufreqd}}

=== Конфигурация ===

Приложение <code>cpufreqd</code> контролирует состояние системы с помощью нескольких плагинов. Основываясь на отклике, получаемом от этих плагинов, оно настраивает политику, используемую для регулирования частоты CPU. 

<code>cpufreqd</code> может быть настроено редактированием {{Path|/etc/cpufreqd.conf}} . Оно содержит три разных раздела: 

# Раздел <code>[General]...[/General]</code> содержит основные настройки
# Раздел <code>[Profile]...[/Profile]</code> определяет политики, на которые может переключаться <code>cpufreqd</code> . Этот раздел очень схож с информацией, использованной ранее при настройке частоты процессора вручную с использованием <code>cpufreq-set</code> .
# Раздел <code>[Rule]...[/Rule]</code> - это рабочая лошадка демона <code>cpufreqd</code> , определяющая когда демон решает переключиться на другой профиль.

Давайте взглянем на пример правила. 

{{File|/etc/cpufreqd.conf|Пример правила cpufreqd|<pre>
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
</pre>
}}

В примере выше, <code>cpufreqd</code> переключит систему на профиль ''On Demand High'' (также показанный в предыдущем отрывке). Этот профиль использует регулятор <code>ondemand</code> с минимальной частотой в 40% (другими словами, процессор с частотой 2ГГц будет иметь в соответствии с этой политикой минимальную частоту в 800МГц). 

Как видите, приложение <code>cpufreqd</code> может предложить более модульный подход к масштабированию частоты CPU. Но кроме этого, можно также настроить частоту CPU в соответствии с различными другими доступными показателями. Конфигурация по умолчанию предлагает образец правила для просмотра кино, когда требуется максимальная производительность, пока температура CPU не становится очень высокой. 

После настройки <code>cpufreqd</code> нужно его запустить (и убедиться, что служба загружается автоматически). Убедитесь, что регулирование частоты CPU другими инструментами (такими как <code>laptop-mode-tools</code> ) отключено! 

{{RootCmd|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start}}

== Внешние ссылки ==

=== Инструменты ===

*  [http://samwel.tk/laptop_mode/ Домашняя страница Laptop Mode Tools] , включая [http://samwel.tk/laptop_mode/laptop_mode Описание laptop mode] .
*  [http://www.lesswatts.org/projects/powertop/ PowerTOP] , интерактивное приложение, помогающее пользователям узнать какие процессы вызывают пробуждение CPU наиболее часто.

=== Статьи и Руководства ===

Статья ThinkWiki о том [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption Как уменьшить потребление питания] (на Linux). Эта статья предлагает исчерпывающий список измерений для проведения. Однако, следует заметить что laptop mode tools реализует большинство из них (если правильным образом настроен).

== Благодарности ==

Мы хотели бы поблагодарить следующих авторов и редакторов за их вклад в это руководство:


* swift
