<languages />


{{Metadata|abstract=За последние годы управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, операционная система также должна поддерживать различные функции сохранения заряда батареи. В этом руководстве мы опишем как настроить установку Gentoo, так чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.}}

За последние годы управление питанием стало одной из отличительных черт при поиске совершенного ноутбука. Все же, операционная система также должна поддерживать различные функции сохранения заряда батареи. В этом руководстве мы опишем как настроить установку Gentoo, так чтобы она управляла энергозависимыми ресурсами гибким, но все же автоматизированным способом.

== Введение ==

=== О данном документе... ===

Этот документ описывает настройку функций управления питанием на ноутбуке. Хотя некоторая информация в этом руководстве может применяться к управлению питанием на сервере, это не является целью данного документа. Пожалуйста, будьте осторожны при применении инструкций на системах, отличных от ноутбуков. 

В этом документе мы прежде всего сосредоточимся на пакете laptop-mode-tools, так как он предлагает полный набор функций. Все же, мы также обратимся и к другим инструментам, которые могут предложить более детальный подход к индивидуальным настройкам. В этом случае необходимо отключить некоторые функции пакета laptop-mode-tools, так чтобы два инструмента не сражались за доступ к одному и тому же ресурсу. 

=== Описание laptop_mode ===

Настройке <code>laptop_mode</code> - эта настройка конфигурации ядра, которая оптимизирует запросы ввода-вывода, позволяя дискам вращаться должным образом (а не просыпаться сразу же после поставленных в очередь операций). 

=== О пакете laptop-mode-tools ===

Пакет ''Laptop Mode Tools'' - это пакет программ ( <code>app-laptop/laptop-mode-tools</code> ), который позволяет оптимизировать функции сохранения заряда батареи. Он позволяет управлять настройкой ядра Linux <code>laptop_mode</code> , но при этом имеет дополнительные функции, позволяя настроить другие параметры системы, связанные с питанием. 

== Конфигурация ядра Linux ==

=== Минимальные настройки ядра ===

В дереве портежей имеются различные исходные коды ядра. Мы рекомендуем использование <code>gentoo-sources</code> , но если необходима расширенная поддержка гибернации, вам могут потребоваться <code>tuxonice-sources</code> . Чтобы включить правильные функции управления питанием в ядре Linux, включите по крайней мере следующие настройки: 

{{Kernel|Минимальные настройки ядра для управления питанием|<pre>
General setup --->
  [*] Configure standard kernel features (expert users) --->
  
Power management and ACPI options --->
  [*] Run-time PM core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
    [*] Power Management Timer Support
  
  [*] CPU Frequency scaling --->
    [*] CPU Frequency scaling
    <*>   'performance' governor
    <*>   'powersave' governor
    <*>   'userspace' governor
    <*>   'ondemand' governor
    <*>   'conservative' governor
    <*> ACPI Processor P-States driver
</pre>
}}

Не забудьте включить драйвер масштабирования частоты центрального процессора (CPU frequency scaling driver) для вашего типа процессора, расположенный сразу после ''ACPI Processor P-States driver'', упомянутого выше. 

Соберите и установите новое ядро (если это необходимо) и перезагрузитесь. 

== Использование пакета Laptop Mode Tools ==

=== Установка ===

То, что установка пакета ''Laptop Mode Tools'' легко выполняется командой <code>emerge laptop-mode-tools</code> не вызывает никаких вопросов. Однако, этот пакет имеет дополнительные, необязательные настройки, включаемые через конфигурацию USE-флагов. Поэтому давайте сначала рассмотрим поддерживаемые USE-флаги и то, что они означают для пакета. 

{| class="wikitable" style="text-align: left;" 
|- 
! USE-флаг
! Описание
! Применяется когда...
|- 
| acpi
| Зависит от <code>sys-power/acpid</code> , так, чтобы изменения системы фиксировались и функции сохранения заряда автоматически включались/отключались.
| ноутбук не является слишком старым (~ 2003 года и позже)
|- 
| apm
| Зависит от <code>sys-apps/apmd</code> , так, чтобы изменения системы фиксировались и функции сохранения заряда автоматически включались/отключались.
| ноутбук очень старый
|- 
| bluetooth
| Зависит от <code>net-wireless/bluez</code>, что позволяет <code>laptop-mode-tools</code> управлять настройками bluetooth (включая и отключая данный сервис, основываясь на состоянии батареи.)
| ноутбук (и ядро) поддерживают bluetooth
|- 
| scsi
| Зависит от <code>sys-apps/sdparm</code>, что позволяет <code>laptop-mode-tools</code> управлять параметрами диска SCSI (''а не'' SATA).
| ноутбук использует SCSI-диски
|-
|}

Как видите, существуют два противоречащих друг другу USE-флага: <code>acpi</code> и <code>apm</code> . Итак, в чем же здесь дело? 

* USE-флаг <code>apm</code> включает поддержку 'Advanced Power Management'' , более старого (до 2000-го года) стандарта системных функций управления питанием.
* USE-флаг <code>acpi</code> включает поддержку ''Advanced Configuration and Power Interface'' , преемника APM. Все современные ноутбуки поддерживают ACPI.

В зависимости от системы, вам потребуется установить или <code>acpi</code> или <code>apm</code> . В остальной части этого руководства мы предполагаем, что ваш ноутбук достаточно современен, чтобы поддерживать ACPI. 

Итак, давайте установим <code>laptop-mode-tools</code> с этим набором USE-флагов. 

{{Emerge|laptop-mode-tools}}

=== Конфигурация ===

Установка на систему <code>laptop-mode-tools</code> не включает необходимые функции управления питанием автоматически. Чтобы настроить пакет, сначала взгляните на {{Path|/etc/laptop-mode/laptop-mode.conf}} . Это основной файл конфигурации пакета и он довольно хорошо описан (с помощью комментариев). 

Но это не единственный файл конфигурации для работы с ним. Пакет Laptop Mode Tools поддерживает расширения (или модули), которые имеют их собственные файлы конфигурации. Эти файлы расположены в {{Path|/etc/laptop-mode/conf.d}} и названы так же, как и модули, которые они представляют (такие как {{Path|intel-sata-powermgmt.conf}}). 

Далее, одной из важных настроек в каждом файле конфигурации является то, должен ли пакет Laptop Mode Tools управлять отдельными настройками или нет. Это важно при совмещении <code>laptop-mode-tools</code> с другими службами, такими как <code>cpufreqd</code> . В этом примере нам нужно установить <code>CONTROL_CPU_FREQUENCY=0</code> : 

{{File|/etc/laptop-mode/conf.d/cpufreq.conf||<pre>
CONTROL_CPU_FREQUENCY=0
</pre>
}}

Следующие несколько разделов помогут в настройке <code>laptop-mode-tools</code>, так, чтобы он удовлетворял вашим нуждам. По завершении запустите службу <code>laptop_mode</code> и убедитесь, что она запускается при загрузке системы. 

{{RootCmd|/etc/init.d/laptop_mode start
|rc-update add laptop_mode default}}

=== Как работает laptop-mode-tools ===

При запуске службы <code>laptop_mode</code> данная программа проверит в каком состоянии находится система. Состояния определены следующим образом: 

*  ''Battery'' , которое активно когда система работает от батареи; файлы конфигурации используют префикс <code>BATT_</code> для настроек, связанных с этим состоянием
*  ''AC'' , которое активно когда система работает от сети; файлы конфигурации используют префикс <code>AC_</code> для настроек, связанных с этим состоянием
*  ''Laptop Mode'' , которое активно когда включен ''laptop mode''; файлы конфигурации используют префикс <code>LM_</code> для настроек, связанных с этим состоянием
*  ''No Laptop Mode'' , которое активно когда ''laptop mode'' отключен; файлы конфигурации используют префикс <code>NOLM_</code> для настроек, связанных с этим состоянием

Префиксы <code>AC/BATT_</code> и <code>LM/NOLM_</code> могут быть совмещены (так что возможно использование префикса <code>AC_LM_</code>). 

Когда служба <code>laptop_mode</code> запускается, она переключает режимы в зависимости от возникающих событий (и, конечно же, в зависимости от настроек конфигурации). Например, настройка <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code> заставит laptop mode tools переключаться в режим ''laptop mode'' когда заряд батареи истек. В этом случае будут использованы настройки, начинающиеся с <code>LM_</code> , <code>LM_BATT_</code> , <code>BATT_LM_</code> и <code>BATT_</code> . 

Чтобы убедиться, что настройки не конфликтуют друг с другом, не разрешается иметь накладывающиеся друг на друга настройки. В следующем примере первая группа настроек (для <code>CPU_MAXFREQ</code> ) является верной, но вторая (для <code>CPU_GOVERNOR</code> ) - нет. 

{{Code|Частично совпадающие настройки|<pre>
## Правильный набор настроек
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Неправильный набор
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# Следующее включает AC и BATT, но BATT уже определена
NOLM_CPU_MINFREQ=fastest
</pre>
}}

=== Настройка управления частотой CPU ===

The support for CPU frequency management in the laptop mode tools allows switching frequencies. It supports setting the CPU frequency governor, minimum frequency and maximum frequency. The configuration file used here is {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}} . 

The ''CPU frequency governor'' is a kernel-level policy that defines how the kernel will select the CPU frequency. We already selected the governors we want to use in the kernel configuration earlier. Let's recap: 

*  <code>performance</code> always picks the highest frequency
*  <code>powersave</code> always picks the lowest frequency
*  <code>userspace</code> does not pick anything, but let the user decide (or any process that the user is running that will decide for the user)
*  <code>ondemand</code> will scale the CPU frequency up to the highest frequency when load is available
*  <code>conservative</code> will scale the CPU frequency up gradually when load is available

When switching between AC or battery, or (no) laptop mode, the appropriate governor (as well as its minimum and maximum frequency) is selected. 

=== Configuring display brightness ===

With {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}} , you can have the laptop mode tools govern the brightness of your LCD screen. 

The file currently  uses the {{Path|/proc/acpi/video/VID/LCD/brightness}} file ([https://bugs.gentoo.org/show_bug.cgi?id=499544 bug 499544]) to set brightness values. Recent kernels do not provide this anymore - you will need to adjust this to {{Path|/sys/class/backlight/acpi_video0/brightness}} instead. 

The values you can use are between 0 and 15, with 0 being the lowest brightness value.

=== Configuring other services ===

An interesting feature of <code>laptop-mode-tools</code> is to support reloading particular services (like the system logger) after switching its configuration file. This is handled through {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}} . 

If enabled, the <code>laptop_mode</code> application will switch the configuration file(s) of the mentioned services with the same file, but suffixed with {{Path|-nolm-ac}} , {{Path|-lm-ac}} or {{Path|-batt}} . It willl then signal or reload the appropriate services so they can use the new configuration file. 

== Using cpufreqd ==

=== Installation ===

The <code>cpufreqd</code> application allows you to manage CPU frequencies in a more granular approach then what <code>laptop-mode-tools</code> supports. But before we dive into the installation of <code>cpufreqd</code> , let's first look at the USE flags it supports. 

{| class="wikitable" style="text-align: left;" 
|- 
! USE flag
! Description
! Suggested when...
|- 
| acpi
| Enable support for ACPI, allowing <code>cpufreqd</code> to be notified about specific events as well as govern power through the ACPI interface
| your laptop is not too old (~ year 2003 and later)
|- 
| apm
| Enable support for APM, allowing <code>cpufreqd</code> to be notified about specific events as well as govern power through the APM interface
| your laptop is very old
|- 
| lm_sensors
| Enable support for the Linux hardware sensors (through <code>sys-apps/lm_sensors</code> ), allowing to switch profiles based on hardware sensor results
| you want to use advanced events through lm_sensors
|- 
| nforce2
| Enable support for NForce, allowing <code>cpufreqd</code> to change the NForce FSB clock and video card frequency
| you have an NVidia graphical card based on the NForce chipset
|- 
| nvidia
| Enable support for NVidia graphical card configuration (through the NVidia ''nvclock'' interface), allowing <code>cpufreqd</code> to change the video card frequency of NVidia graphical cards
| you have an NVidia graphical card
|- 
| pmu
| Enable the Power Management Unit plug-in of <code>cpufreqd</code> . This allows the software to poll the Linux kernel Power Supply interface, getting more detailed information on battery charge.
| your laptop does not support ACPI or APM
|-
|}

The USE flags <code>acpi</code> , <code>apm</code> and <code>pmu</code> overlap, so you should only have one active. If your laptop is sufficiently recent, <code>acpi</code> is your best bet. If not, <code>apm</code> offers all that is needed. When even APM isn't supported, you can try <code>pmu</code> . 

With the USE flags configured, it is time to install <code>cpufreqd</code> . 

{{Emerge|cpufreqd}}

=== Configuration ===

The <code>cpufreqd</code> application monitors the status of the system through several plugins. Based on the feedback it receives from those plugins, it will adjust the policy used to govern the CPU frequency. 

<code>cpufreqd</code> can be configured by editing {{Path|/etc/cpufreqd.conf}} . It contains three different sections: 

# The <code>[General]...[/General]</code> section contains general configuration information
# The <code>[Profile]...[/Profile]</code> section defines the policies that the <code>cpufreqd</code> daemon can switch to. The section is very similar to the information you use when manually setting the CPU frequency policy using <code>cpufreq-set</code> .
# The <code>[Rule]...[/Rule]</code> section is the work-horse of the <code>cpufreqd</code> daemon, defining when the daemon decides to switch to a different profile.

Let's take a quick look at an example rule. 

{{File|/etc/cpufreqd.conf|Sample cpufreqd rule|<pre>
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
</pre>
}}

In the above example, <code>cpufreqd</code> will switch the system to the ''On Demand High'' profile (also shown in the above excerpt). This profile by itself uses the <code>ondemand</code> governor with a minimum frequency of 40% (iow, a CPU of 2Ghz will have by this policy a minimum frequency of 800Mhz). 

As you can see, the <code>cpufreqd</code> application can offer a more granular approach on CPU frequency scaling. But not only that, you can tweak the CPU frequency scaling based on various other metrics available. The default configuration offers a sample rule for when you watch a movie, where you want maximum performance, unless the CPU temperature is getting too high. 

When you have configured <code>cpufreqd</code> , it is time to start it (and make sure the service is loaded automatically). Make sure that CPU frequency handling by other tools (like <code>laptop-mode-tools</code> ) is disabled! 

{{RootCmd|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start}}

== Resources ==

=== Tools ===

*  [http://samwel.tk/laptop_mode/ Laptop Mode Tools Homepage] , includes [http://samwel.tk/laptop_mode/laptop_mode About laptop mode] .
*  [http://www.lesswatts.org/projects/powertop/ PowerTOP] , an interactive application helping users to find out which processes are forcing wakeups on the CPU most often.

=== Articles and Guides ===

* A ThinkWiki article on [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption How to reduce power consumption] (on Linux). This article offers an exhaustive list of measures one can take. However, it should be noted that the laptop mode tools implements the majority of these (if properly configured).

== Acknowledgements ==

We would like to thank the following authors and editors for their contributions to this guide:


* swift
