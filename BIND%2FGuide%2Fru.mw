<languages />

{{Metadata|abstract=This guide will teach you how install and configure BIND for your domain and your local network.}}

Данная статья научит вас, как устанавливать и конфигурировать BIND для вашего домена и вашей локальной сети.

== Введение ==

Данный учебник покажет вам, как устанавливать и конфигурировать BIND, самый частоиспользуемый DNS-сервер в Интернет. Мы сконфигурируем <code>bind</code> для вашего домена, используя различные конфигурации, одну для вашей локальной сети, и одну для остального мира. Для этого мы будем использовать виды (views). Один вид для вашей внутренней зоны (вашей локальной сети) и другой вид для внешней зоны (остального мира). 

== Данные, которые будут использоваться в примерах ==

{| class="wikitable" style="text-align: left;" 
|- 
! Ключевое слово
! Объяснение
! Пример
|- 
| ВАШ_ДОМЕН
| Имя вашего домена
| gentoo.org
|- 
| ВАШ_ПУБЛИЧНЫЙ_IP
| Публичный IP, который вам дал ваш провайдер
| 204.74.99.100
|- 
| ВАШ_ЛОКАЛЬНЫЙ_IP
| Локальный IP адрес
| 192.168.1.5
|- 
| ВАША_ЛОКАЛЬНАЯ_СЕТЬ
| Локальная сеть
| 192.168.1.0/24
|- 
| ПОДЧИНЕННЫЙ_DNS_СЕРВЕР
| IP адрес подчиненного DNS сервера для вашего домена.
| 209.177.148.228
|- 
| АДМИНИСТРАТОР
| Имя администратора DNS сервера.
| root
|- 
| ИЗМЕНЕНИЕ
| Время изменения файла зоны с добавленным числом
| 2009062901
|-
|}

== Конфигурация BIND ==

=== Установка ===

Сначала, установите <code>net-dns/bind</code> . 

{{Emerge|net-dns/bind}}

=== Настройка /etc/bind/named.conf ===

The first thing to configure is {{Path|/etc/bind/named.conf}} . The first part of this step is specifying bind's root directory, the listening port with the IPs, the pid file, and a line for ipv6 protocol.

{{Code|options section|<pre>
options {
        directory "/var/bind";
  
        listen-on-v6 { none; };
        listen-on port 53 { 127.0.0.1; YOUR_LOCAL_IP; };
  
        pid-file "/var/run/named/named.pid";
};
</pre>
}}

The second part of {{Path|named.conf}} is the internal view used for our local network. 

{{Code|Internal view|<pre>
view "internal" {
        match-clients { YOUR_LOCAL_NETWORK; localhost; };
        recursion yes;
  
        zone "YOUR_DOMAIN" {
                type master;
                file "pri/YOUR_DOMAIN.internal";
                allow-transfer { any; };
        };
};
</pre>
}}

The third part of {{Path|named.conf}} is the external view used to resolve our domain name for the rest of the world and to resolve all other domain names for us (and anyone who wants to use our DNS server). 

{{Code|External view|<pre>
view "external" {
        match-clients { any; };
        recursion no;
  
        zone "." IN {
                type hint;
                file "named.ca";
        };
  
        zone "127.in-addr.arpa" IN {
                type master;
                file "pri/127.zone";
                allow-update { none; };
                notify no;
        };
  
        zone "YOUR_DOMAIN" {
                type master;
                file "pri/YOUR_DOMAIN.external";
                allow-query { any; };
                allow-transfer { SLAVE_DNS_SERVER; };
        };
};
</pre>
}}

The final part of {{Path|named.conf}} is the logging policy. 

{{Code|External view|<pre>
logging {
        channel default_syslog {
                file "/var/log/named/named.log" versions 3 size 5m;
                severity debug;
                print-time yes;
                print-severity yes;
                print-category yes;
        };
       category default { default_syslog; };
};
</pre>
}}

The {{Path|/var/log/named/}} directory must be exist and belong to <code>named</code> : 

{{RootCmd|mkdir -p /var/log/named/
|chmod 770 /var/log/named/
|touch /var/log/named/named.log
|chmod 660 /var/log/named/named.log
|chown -R named /var/log/named/
|chgrp -R named /var/log/named/}}

=== Creating the internal zone file ===

We use the hostnames and IP adresses of the picture network example. Note that almost all (not all) domain names finish with "." (dot). 

{{Code|/var/bind/pri/YOUR_DOMAIN.internal|<pre>
$TTL 2d
@	IN SOA	ns.YOUR_DOMAIN.	ADMIN.YOUR_DOMAIN. (
	MODIFICATION	; serial
	3h	; refresh
	1h	; retry
	1w	; expiry
	1d )	; minimum
  
YOUR_DOMAIN.		IN MX	0 mail.YOUR_DOMAIN.
YOUR_DOMAIN.		IN TXT	"v=spf1 ip4:YOUR_PUBLIC_IP/32 mx ptr mx:mail.YOUR_DOMAIN ~all"
YOUR_DOMAIN.		IN NS	ns.YOUR_DOMAIN.
YOUR_DOMAIN.		IN NS	SLAVE_DNS_SERVER
www.YOUR_DOMAIN.	IN A	192.168.1.3
ns.YOUR_DOMAIN.		IN A	192.168.1.5
mail.YOUR_DOMAIN.	IN A	192.168.1.3
router.YOUR_DOMAIN.	IN A	192.168.1.1
hell.YOUR_DOMAIN.	IN A	192.168.1.3
heaven.YOUR_DOMAIN.	IN A	192.168.1.5
desktop.YOUR_DOMAIN.	IN A	192.168.1.4
</pre>
}}

=== Creating the external zone file ===

Here we only have the subdomains we want for external clients (www, mail and ns). 

{{Code|/var/bind/pri/YOUR_DOMAIN.external|<pre>
$TTL 2d
@	IN SOA	ns.YOUR_DOMAIN.	ADMIN.YOUR_DOMAIN. (
	MODIFICATION	;serial
	3h	;refresh
	1h	;retry
	1w	;expiry
	1d )	;minimum
  
YOUR_DOMAIN.		IN MX	0 mail.YOUR_DOMAIN.
YOUR_DOMAIN.		IN TXT	"v=spf1 ip4:YOUR_PUBLIC_IP/32 mx ptr mx:mail.YOUR_DOMAIN ~all"
YOUR_DOMAIN.		IN NS	ns.YOUR_DOMAIN.
YOUR_DOMAIN.		IN NS	SLAVE_DNS_SERVER
www.YOUR_DOMAIN.	IN A	YOUR_PUBLIC_IP
ns.YOUR_DOMAIN.		IN A	YOUR_PUBLIC_IP
mail.YOUR_DOMAIN.	IN A	YOUR_PUBLIC_IP
</pre>
}}

=== Оканчиваем конфигурацию ===

Вам нужно добавить <code>named</code> к уровню доступ по умолчанию: 

{{RootCmd|rc-update add named default}}

== Конфигурация клиентов ==

Now you can use your own DNS server in all machines of your local network to resolve domain names. Modify the {{Path|/etc/resolv.conf}} file of all machines of your local network. 

{{Code|Редактируем /etc/resolv.conf|<pre>
search ВАШ_ДОМЕН
nameserver IP_ВАШЕГО_СЕРВЕРА_DNS
</pre>
}}

Note that YOUR_DNS_SERVER_IP is the same as YOUR_LOCAL_IP we used in this document. In the picture the example is 192.168.1.5. 

== Тестирование ==

Мы можем протестировать наш новый сервер DNS. Сначала нам нужно запустить сервис. 

{{RootCmd|/etc/init.d/named start}}

Now, we are going to make some <code>host</code> commands to some domains. We can use any computer of our local network to do this test. If you don't have <code>net-dns/host</code> installed you can use <code>ping</code> instead. Otherwise, first run <code>emerge host</code> . 

{{Cmd|host www.gentoo.org|output=<pre>
www.gentoo.org has address 209.177.148.228
www.gentoo.org has address 209.177.148.229
</pre>}}

{{Cmd|host hell|output=<pre>
hell.YOUR_DOMAIN has address 192.168.1.3
</pre>}}

{{Cmd|host router|output=<pre>
router.YOUR_DOMAIN has address 192.168.1.1
</pre>}}


== Защищаем сервер программой iptables ==

If you use iptables to protect your server, you can add these rules for DNS service. 

{{Code|Iptables rules|<pre>
iptables -A INPUT -p udp --sport 53 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p tcp --sport 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 53 -j ACCEPT
</pre>
}}

== Благодарности ==

Мы хотели бы поблагодарить следующих авторов и редакторов за их вклад в это руководство:

* Vicente Olivert Riera
* nightmorph


[[Category:Server]]
[[Category:Daemons]]
