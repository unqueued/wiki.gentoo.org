<languages />

{{Metadata|abstract=Данная статья научит читателя, как установить и настроить BIND для домена и локальной сети.}}

This guide teaches the reader how install and configure BIND for a domain and a local network.

== Введение ==

This tutorial will show you how to install and configure BIND, the most used DNS server on Internet. We will configure BIND for a domain using different configurations, one for a local network and one for the rest of the world. Two views will be used to do so:

# View of the internal zone (your local network).
# View for the external zone (rest of the world). 

== Данные, которые будут использоваться в примерах ==

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! Keyword
! Explanation
! Example
|- 
| YOUR_DOMAIN
| Your domain name
| gentoo.org
|- 
| YOUR_PUBLIC_IP
| The public ip that ISP gives to you
| 204.74.99.100
|- 
| YOUR_LOCAL_IP
| The local ip address
| 192.168.1.5
|- 
| YOUR_LOCAL_NETWORK
| The local network
| 192.168.1.0/24
|- 
| SLAVE_DNS_SERVER
| The ip address of the slave DNS server for your domain.
| 209.177.148.228
|- 
| ADMIN
| The DNS server administrator's name.
| root
|- 
| MODIFICATION
| The modification date of the file zone, with a number added
| 2009062901
|-
|}

== Конфигурация BIND ==

=== Установка ===

Сначала, установите {{Package|net-dns/bind}}. 

{{Emerge|net-dns/bind}}

=== Настройка /etc/bind/named.conf ===

Сначала нужно сконфигурировать {{Path|/etc/bind/named.conf}}. Первым шагом будет указание корневого каталога bind, порт, который будет прослушиваться, PID-файл и строка для протокола IPv6.

{{FileBox|title=options section|filename=/etc/bind/named.conf|1=
options {
        directory "/var/bind";
  
        listen-on-v6 { none; };
        listen-on port 53 { 127.0.0.1; YOUR_LOCAL_IP; };
  
        pid-file "/var/run/named/named.pid";
};
}}

Вторая часть {{Path|named.conf}} - внутренний вид, используемый для нашей локальной сети. 

{{FileBox|title=Internal view|filename=/etc/bind/named.conf|1=
view "internal" {
        match-clients { YOUR_LOCAL_NETWORK; localhost; };
        recursion yes;
  
        zone "YOUR_DOMAIN" {
                type master;
                file "pri/YOUR_DOMAIN.internal";
                allow-transfer { any; };
        };
};
}}

Третья часть {{Path|named.conf}} - внешний вид, используемый для разрешения наших доменных имен для остального мира, и разрешения всех остальных доменных имен для нас (и всех, кто захочет использовать наш DNS сервер). 

{{FileBox|title=External view|filename=/etc/bind/named.conf|1=
view "external" {
        match-clients { any; };
        recursion no;
  
        zone "." IN {
                type hint;
                file "named.ca";
        };
  
        zone "127.in-addr.arpa" IN {
                type master;
                file "pri/127.zone";
                allow-update { none; };
                notify no;
        };
  
        zone "YOUR_DOMAIN" {
                type master;
                file "pri/YOUR_DOMAIN.external";
                allow-query { any; };
                allow-transfer { SLAVE_DNS_SERVER; };
        };
};
}}

Последняя часть {{Path|named.conf}} это политика логов. 

{{FileBox|title=External view|filename=/etc/bind/named.conf|1=
logging {
        channel default_syslog {
                file "/var/log/named/named.log" versions 3 size 5m;
                severity debug;
                print-time yes;
                print-severity yes;
                print-category yes;
        };
       category default { default_syslog; };
};
}}

Каталог {{Path|/var/log/named/}} должен существовать и принадлежать <code>named</code>: 

{{RootCmd
|mkdir -p /var/log/named/
|chmod 770 /var/log/named/
|touch /var/log/named/named.log
|chmod 660 /var/log/named/named.log
|chown -R named /var/log/named/
|chgrp -R named /var/log/named/
}}

=== Создание файла внутренней зоны ===

Мы используем имена хостов и IP-адреса из примера сети, показанного ниже. Заметьте, что почти все (но не все) доменные имена оканчиваются на "." (точку). 

{{FileBox|filename=/var/bind/pri/ВАШ_ДОМЕН.internal|1=
$TTL 2d
@	IN SOA	ns.ВАШ_ДОМЕН.	АДМИНИСТРАТОР.ВАШ_ДОМЕН. (
	ИЗМЕНЕНИЕ	; serial
	3h	; refresh
	1h	; retry
	1w	; expiry
	1d )	; minimum
  
ВАШ_ДОМЕН.		IN MX	0 mail.ВАШ_ДОМЕН.
ВАШ_ДОМЕН.		IN TXT	"v=spf1 ip4:ВАШ_ПУБЛИЧНЫЙ_IP/32 mx ptr mx:mail.ВАШ_ДОМЕН ~all"
ВАШ_ДОМЕН.		IN NS	ns.ВАШ_ДОМЕН.
ВАШ_ДОМЕН.		IN NS	ПОДЧИНЕННЫЙ_DNS_СЕРВЕР
www.ВАШ_ДОМЕН.	        IN A	192.168.1.3
ns.ВАШ_ДОМЕН.		IN A	192.168.1.5
mail.ВАШ_ДОМЕН.	        IN A	192.168.1.3
router.ВАШ_ДОМЕН.	IN A	192.168.1.1
hell.ВАШ_ДОМЕН.	        IN A	192.168.1.3
heaven.ВАШ_ДОМЕН.	IN A	192.168.1.5
desktop.ВАШ_ДОМЕН.	IN A	192.168.1.4
}}

=== Создание файла внешней зоны ===

Здесь у нас только поддомены, информацию о которых мы хотим отдавать для внешних клиентов (www, mail и ns). 

{{FileBox|filename=/var/bind/pri/ВАШ_ДОМЕН.external|1=
$TTL 2d
@	IN SOA	ns.ВАШ_ДОМЕН.	АДМИНИСТРАТОР.ВАШ_ДОМЕН. (
	ИЗМЕНЕНИЕ	;serial
	3h	;refresh
	1h	;retry
	1w	;expiry
	1d )	;minimum
  
ВАШ_ДОМЕН.		IN MX	0 mail.ВАШ_ДОМЕН.
ВАШ_ДОМЕН.		IN TXT	"v=spf1 ip4:ВАШ_ПУБЛИЧНЫЙ_IP/32 mx ptr mx:mail.ВАШ_ДОМЕН ~all"
ВАШ_ДОМЕН.		IN NS	ns.ВАШ_ДОМЕН.
ВАШ_ДОМЕН.		IN NS   ПОДЧИНЕННЫЙ_DNS_СЕРВЕР
www.ВАШ_ДОМЕН.    	IN A	ВАШ_ПУБЛИЧНЫЙ_IP
ns.ВАШ_ДОМЕН.		IN A	ВАШ_ПУБЛИЧНЫЙ_IP
mail.ВАШ_ДОМЕН.	        IN A    ВАШ_ПУБЛИЧНЫЙ_IP
}}

=== Окончательная конфигурация ===

Вам нужно добавить <code>named</code> к уровню доступ по умолчанию: 

{{RootCmd|rc-update add named default}}

== Конфигурация клиентов ==

Теперь вы можете использовать свой DNS сервер для всех машин в вашей локальной сети для разрешения доменных имен. Измените файл {{Path|/etc/resolv.conf}} на всех машинах вашей локальной сети. 

{{FileBox|filename=/etc/resolv.conf|1=
search ВАШ_ДОМЕН
nameserver IP_ВАШЕГО_СЕРВЕРА_DNS
}}

Заметьте, что IP_ВАШЕГО_СЕРВЕРА_DNS тот же, что и ВАШ_ЛОКАЛЬНЫЙ_IP, который мы использовали в данном документе. В примере он был 192.168.1.5. 

== Тестирование ==

Мы можем протестировать наш новый сервер DNS. Сначала нам нужно запустить сервис. 

{{RootCmd|/etc/init.d/named start}}

Теперь мы собираемся выполнить некоторые <code>host</code>-команды к некоторым доменам. Для этого теста мы можем использовать любой компьютер в нашей локальной сети. Если у вас нет пакета <code>net-dns/host</code>, вы можете вместо него использовать <code>ping</code>. В противном случае сначала запустите <code>emerge host</code>. 

{{Cmd|host www.gentoo.org|output=<pre>
www.gentoo.org has address 209.177.148.228
www.gentoo.org has address 209.177.148.229
</pre>}}

{{Cmd|host hell|output=<pre>
hell.ВАШ_ДОМЕН has address 192.168.1.3
</pre>}}

{{Cmd|host router|output=<pre>
router.ВАШ ДОМЕН has address 192.168.1.1
</pre>}}

== Защищаем сервер программой iptables ==

When running the DNS service, iptables can be configured with these rules for added protection:

{{CodeBox|title=Правила iptables|1=
iptables -A INPUT -p udp --sport 53 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 53 -j ACCEPT
}}

[[Category:Server]]
[[Category:Daemons]] {{Migrated|originalauthors=Vicente Olivert Riera, nightmorph}}
