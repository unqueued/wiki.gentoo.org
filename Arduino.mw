{{InfoBox stack
|{{InfoBox homepage|https://www.arduino.cc/|header=true}}
|{{InfoBox wikipedia}}
}}

Arduino is [[Article description::an open source development platform]]. This document describes how to use the platform on Gentoo.

Note that in addition to official and clone Arduino products based on [[wikipedia:Atmel|Atmel]] [[wikipedia:Atmel AVR|AVR]] microprocessors, the environment can also support other Atmel AVR microprocessors (such as [https://github.com/MCUdude/MicroCore ATtiny13]), [https://www.nordicsemi.com/Products/nRF52-Series-SoC nRF52], [http://www.stm32duino.com/viewtopic.php?f=42&t=97&sid=1f8f263f8c8283920499c949f059bad4 STM32 microprocessors], etc.

== Prepare the kernel for USB connection ==

The Arduino boards are connected to a computer via [[USB]]. With this connection it is possible to write binaries for the Arduino's microprocessor and get debug messages from the board during run mode. Different boards feature different USB interface chips. In case you prefer to use [[wikipedia:In-system programming|ICSP]] programming with an external adapter you don't need this for programming anymore, but you may still need it for debugging.

The following [[kernel]] support is required: 

=== Arduino NG (FTDI) ===

{{KernelBox|title=for FTDI chip (can also be a module)|1=
Device Drivers  --->
    [*] USB support ---> 
      <*> USB Serial Converter support --->
        <*> USB FTDI Single Port Serial Driver
}}

=== Arduino MEGA, 8U2, 16U2, 32U4 ([http://wiki.openmoko.org/wiki/USB_CDC_ACM CDC ACM]) ===

{{KernelBox|title=for CDC ACM (can also be a module)|1=
Device Drivers  --->
    [*] USB support ---> 
      <*> USB Modem (CDC ACM) support
}} 

=== Arduino NANO (CH340) ===

These boards have used a range of serial converter chips, but mostly they use [http://www.wch.cn/product/CH340.html CH340].

{{KernelBox|title=for CH340 serial converter chip (can also be a module)|1=
Device Drivers  --->
    [*] USB support ---> 
      <*> USB Serial Converter support --->
        <*> USB Winchiphead CH341 Single Port Serial Driver
}}

== Validate connectivity ==

After booting with the new kernel it is possible to test the board connectivity. First connect the board to one of USB ports and then check messages in kernel ring buffer:

For an Arduino NG:

{{RootCmd|dmesg|output=<pre>usb 5-4: FTDI USB Serial Device converter now attached to ttyUSB0</pre>}}

For an Arduino MEGA:

{{RootCmd|dmesg|output=<pre>cdc_acm 5-4:1.0: ttyACM0: USB ACM device</pre>}}

== Grant access ==

Every user privileged to connect to the board should be added to the <code>uucp</code> group.

{{RootCmd|usermod -a -G uucp user}}

== Prepare the toolchain ==

Because we need to compile code into binaries for a target platform (Atmel AVR microprocessors) different from the development platform (most often [[AMD64|x86-64]]) we have to install a cross development [[wikipedia:GNU toolchain|toolchain]].

=== Recommended: Install the toolchain using crossdev ===

If you haven't already, check out the section on Creating a cross-compiler from the [[Embedded_Handbook/General/Creating_a_cross-compiler|Embedded Handbook]]. This will give you a good introduction to [[crossdev]] and how it works.

==== Installing crossdev ====

Install {{Package|sys-devel/crossdev}}:

{{Emerge|sys-devel/crossdev}}

{{Important|Should you have any issues running crossdev, try upgrading to a more recent masked or unstable version.}}

==== Creating local overlay ====

Before building the toolchain, you need to create a local overlay called <code>crossdev</code>.

{{Note|The <code>crossdev</code> overlay will be auto-selected by the ''crossdev'' tool to build packages for all crossdev-targeted platforms &mdash; so creating only this one overlay is enough to ensure that all of the ''crossdev'' built packages remain completely separate from the native packages for your system.}}

{{Note|These commands are a quick installation method. For more details please refer to the [[Custom_repository#Crossdev|custom repository]] page, ''Crossdev'' section.}} 

{{RootCmd
|mkdir -p /usr/local/portage-crossdev/{profiles,metadata}
|echo 'crossdev' > /usr/local/portage-crossdev/profiles/repo_name
|echo 'masters {{=}} gentoo' > /usr/local/portage-crossdev/metadata/layout.conf
|chown -R portage:portage /usr/local/portage-crossdev
}}

Then instruct [[Portage]] and ''crossdev'' to use this overlay:

{{FileBox|filename=/etc/portage/repos.conf/crossdev.conf|lang=ini|1=
[crossdev]
location = /usr/local/portage-crossdev
priority = 10
masters = gentoo
auto-sync = no
}}

==== Build and install the toolchain ====

Now you are all set. The toolchain to build is specific to the architecture you are targeting with your development. Most Arduino users want the AVR toolchain only.

===== AVR (Arduino/Genuino/ATmicro/ATmega/etc.) =====

Build and install the AVR toolchain with this command:

{{RootCmd|crossdev -s4 --stable --portage --verbose --target avr}}

This works as of January 2018.

An older alternative recommendation from the arduino overlay is this command:

{{RootCmd|USE{{=}}"-nls -openmp -pch -sanitize -vtv" crossdev -t avr -s4 --without-headers}}

===== ARM (STM32/GD32/etc.) =====

{{RootCmd|crossdev -s4 --stable --portage --verbose --target arm}}

===== Troubleshooting =====

{{Note|Should you have any issues running ''crossdev'', try upgrading to a more recent masked or unstable version.}}

In the event you have problems with the [[gcc]] stages, try:

{{RootCmd|USE{{=}}"-openmp -hardened -sanitize -vtv" crossdev -s4 --stable --portage --verbose --target avr}}

You may also need a workaround so that the linking works as expected (see {{Bug|147155}}).

For [[AMD64|amd64]]:

{{RootCmd|ln -s /usr/x86_64-pc-linux-gnu/avr/lib/ldscripts /usr/avr/lib/ldscripts}}

Or x86:

{{RootCmd|ln -s /usr/i686-pc-linux-gnu/avr/lib/ldscripts /usr/avr/lib/ldscripts}}

=== Discouraged: Install non-Gentoo toolchain ===

Using the original [http://www.atmel.com/tools/ATMELAVRTOOLCHAINFORLINUX.aspx Atmel AVR toolchain] seems to be possible but not tested.

Using the Debian precompiled toolchain is described [http://blog.coldtobi.de/index.php?op=ViewArticle&articleId=21&blogId=1 over here].

== Installing Arduino IDE ==

=== Official sources ===

There is currently up to date of [[wikipedia:Arduino IDE|Arduino IDE]] in the official Gentoo repoisitory:

{{Emerge|dev-embedded/arduino}}

Many thanks to Virgil Dupras (hsoft).

=== Arduino overlay ===

* '''Benefit''': Currently up to date. Packaged. Updates through portage possible. Pure command line (no IDE) possible.
* '''Drawback''': Unofficial distribution with unofficial packages.

In order to make use of the [https://github.com/mapmot/arduino-overlay arduino-overlay]:

{{FileBox|filename=/etc/portage/repos.conf/arduino-overlay.conf|title=Add the arduino overlay|1=[arduino-overlay]
priority = 50
location = /var/lib/arduino-overlay
sync-type = git
sync-uri = https://github.com/mapmot/arduino-overlay.git
auto-sync = Yes
}}

Then you can check out the overlay:

{{RootCmd|emerge --sync}}

Then install the command line sketch build tool.

{{RootCmd|emerge -av {{=}}dev-embedded/arduino-builder-1.3.25}}

Then install the IDE.

{{RootCmd|emerge -av {{=}}dev-embedded/arduino-1.8.5}}

=== Official download ===

* '''Benefit''': Always up to date.
* '''Drawback''': Not packaged for Gentoo. All or nothing. Not built from source. Requires manual updates.

[https://www.arduino.cc/en/Main/Software Official tarball downloads] (including beta and hourly versions).

== Configuring the Arduino IDE ==

After first start of Arduino IDE (a link should be found in the ''application/development'' section of your application menu) it will create default sketch directory {{Path|~/Arduino}}. This location can be changed in preferences (''File/Preferences/Sketchbook location:'').

If you are targeting any platforms that aren't included in the default distribution (such as ATtiny processors or ARM processors such as the STM32 or GD32) then you will need to install new Arduino platform implementations, which are known as ''cores''. Cores can then be associated with board definitions.

Some example ''cores'':
* '''ARM'''
** '''STM32/GD32''': [http://www.stm32duino.com/ stm32duino]
** '''[[wikipedia:Nordic_Semiconductor|Nordic Semiconductor]]'''
***'''[[wikipedia:NRF51_Series|NRF51]]/52''': [https://github.com/sandeepmistry/arduino-nRF5 sandeepmistry/arduino-nRF5]
* '''Atmel AVR'''
** '''ATtiny Series'''
*** '''ATtiny13''': [https://github.com/MCUdude/MicroCore MCUdude/MicroCore]
*** '''ATtiny24/25/44/45/85''': [https://github.com/damellis/attiny damellis/attiny]
** '''ATmega Series'''
*** '''ATmega64/128/640/1280/1281/2560/2561''': [https://github.com/MCUdude/MegaCore MCUdude/MegaCore]
*** '''ATmega16/32/164/324/644/1284/8535''': [https://github.com/MCUdude/MightyCore MCUdude/MightyCore]
* '''XTensa''' (see also [https://github.com/pfalcon/esp-open-sdk esp-open-sdk])
** '''Espressif'''
***'''ESP8266''': [https://github.com/esp8266/Arduino esp8266/Arduino] (see also [http://www.esp8266.com/ esp8266.com])
***'''ESP31B/32''': [https://github.com/espressif/arduino-esp32 espressif/arduino-esp32] (older [https://github.com/me-no-dev/ESP31B ESP31B support])

== Using Eclipse IDE ==

After installing [[Eclipse|Eclipse IDE]] you can choose between two Eclipse plugins. Plugins can be installed via provided update sites.
Simply add the given site via ''Menu/Help/Software-updates/Add-site''.

{{Note| Installation of the Eclipse IDE is out of the scope of this article. Please read [[Eclipse]] for that topic.}}

{{Warning|There are major changes since Arduino installation version 1 (formerly versions were "022" etc.). Also major changes since Arduino installation version 1.5.x where done.
Last but not least the plugin ''Arduino Eclipse Extension'' has reworked between version 1.2.4 and version 2.x to support the new Arduino way [http://blog.baeyens.it/#home (more details there)] so the version 2.x is only compatible with Eclipse Juno (not Helios and not Indigo). Please choose the right version of Eclipse for your needs!}}

=== Arduino Eclipse Extension ===

'''Arduino Eclipse Extension''' is a free Eclipse IDE plugin for Arduino projects developed by Jantje. It depends on the installation of Arduino IDE.

Use the update site "http://www.baeyens.it/eclipse/update" for the installation of a plugin version which is compatible with Arduino 1.0.4 and Eclipse Helios and Indigo.

Use the update site "http://www.baeyens.it/eclipse/V2" for installation of a plugin version which is compatible with Arduino 1.5.x and Eclipse Juno.

=== AVR Eclipse Plugin ===

'''AVR Eclipse Plugin''' is a free Eclipse IDE plugin for developing boards with AVR Atmel microprocessors. It is not especially make for the Arduino boards, but it can used for that. It is not necessary to install Arduino IDE for using this plugin. More information can be found on the [http://avr-eclipse.sourceforge.net/wiki/index.php/The_AVR_Eclipse_Plugin wiki site].

Use the update site "http://avr-eclipse.sourceforge.net/updatesite/" for installation of the plugin which is known to work with Eclipse Helios.

{{Warning|V1 of the ''Arduino Eclipse Extension'' contains the ''AVR Eclipse Plugin'' as such you can not have both on your Eclipse IDE without confusion.}}

{{Note|V2 no longer includes the ''AVR Eclipse Plugin'' so you can easily install ''AVR Eclipse Plugin'' next to the ''Arduino Eclipse Extension''.}}

== Tips and Tricks ==

=== udev rule for Arduino NG ===

This rule can be used to make an symlink {{Path|/dev/arduino}}. This is especially useful in case of more than one Arduino boards.

For example create an file {{Path|12-mikrocontroller.rules}} and add the line below:

{{FileBox|filename=/etc/udev/rules.d/12-mikrocontroller.rules|lang=bash|1=
SUBSYSTEMS=="usb", ATTRS{product}=="FT232R USB UART", ATTRS{manufacturer}=="FTDI", NAME="ttyUSB%n", SYMLINK+="arduino"
}}

=== udev rule for Arduino MEGA ===

This rule can be used to make an symlink {{Path|/dev/arduino}}, especially useful in case of more than one Arduino boards.

For example create an file {{Path|12-mikrocontroller.rules}} and add the line below:

{{FileBox|filename=/etc/udev/rules.d/12-mikrocontroller.rules|lang=bash|1=
SUBSYSTEMS=="usb", ATTRS{product}=="Arduino Mega 2560", ATTRS{manufacturer}=="Arduino (www.arduino.cc)", NAME="ttyACM%n", SYMLINK+="arduino"
}}

== Troubleshooting ==

=== Problem with deprecated items in avr-libc v1.8.0 and above (and Mega 2560)===

If you can see the messages below you have found this compatibility issue ([http://arduino.cc/forum/index.php/topic,92364.0.html Arduino forum]).

{{CodeBox|title=Errors while compilation|1=
/usr/share/arduino/hardware/arduino/cores/arduino/HardwareSerial.cpp:107:41: error: attempt to use poisoned "SIG_USART0_RECV"
/usr/share/arduino/hardware/arduino/cores/arduino/HardwareSerial.cpp:117:15: error: attempt to use poisoned "SIG_USART0_RECV"
/usr/share/arduino/hardware/arduino/cores/arduino/HardwareSerial.cpp:161:15: error: attempt to use poisoned "SIG_USART0_RECV"
/usr/share/arduino/hardware/arduino/cores/arduino/HardwareSerial.cpp:178:15: error: attempt to use poisoned "SIG_USART0_RECV"
/usr/share/arduino/hardware/arduino/cores/arduino/HardwareSerial.cpp:195:15: error: attempt to use poisoned "SIG_USART0_RECV"
}}

To fix this manipulate your {{Path|Arduino.h}} at the third line:

{{FileBox|filename=/usr/share/arduino/hardware/arduino/cores/arduino/Arduino.h|lang=cpp|1=
#ifndef Arduino_h
#define Arduino_h
//start: fix the compatibility issue
#define __AVR_LIBC_DEPRECATED_ENABLE__ 1
//end: fix the compatibility issue
#include <stdlib.h>
...
}}

== See also ==

For MSP430 support, take a look at [http://energia.nu/ Energia].

== External resources ==

* [[Embedded Handbook]] - More information about embedded systems, cross compiling, and other related topics.
* [http://playground.arduino.cc/linux/gentoo Outdated guide for arduino on Gentoo] (arduino official hosted site).
* [http://www.baeyens.it/eclipse/ Arduino eclipse extension] main site.
* [http://gentoo-en.vfose.ru/wiki/Crossdev#AVR_Architecture AVR section on old crossdev wiki page]

[[Category:Embedded systems]]
