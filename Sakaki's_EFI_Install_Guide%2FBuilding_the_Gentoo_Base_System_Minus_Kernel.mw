<!-- Page: Building_the_Gentoo_Base_System_Minus_Kernel -->

<span id="build_base_system">In this section</span>, we'll be following along with [[Handbook:AMD64/Installation/Base|Chapter 6]] of the Gentoo handbook, and installing the base system. However, we'll also be diverging considerably, as we will provide the option of using [[:Wikipedia:Systemd|systemd]] (not Gentoo's more usual [[OpenRC]]) as the init system (since GNOME 3.8+ requires it to work properly<ref name="gnome_systemd_runtime_dep">Gentoo Wiki: [http://wiki.gentoo.org/wiki/GNOME/3.8-upgrade-guide#Systemd "GNOME/3.8-upgrade-guide"], ''Systemd'' section</ref> unless patched), and ''bootstrapping'' the core system files (apart from the kernel, which will be addressed in the next section).

The process we'll be following in this section is:
# Performing final preparations for a chroot (setting mirrors, copying DNS, and mounting required system directories);
# Entering the [[:Wikipedia:Chroot|chroot]] environment (after which, the {{Path|/mnt/gentoo/}} location will appear to be the true root directory of the filesystem);
# Installing an up-to-date Portage tree;
# Ensuring that the base profile is set;
# Setting your timezone and locale;
# Setting your (post-boot) keymap;
# (Optionally) informing Portage about your CPU's specific features;
# Installing a tool to show parallel builds in progress, from the {{c|sakaki-tools}} overlay;
# Bootstrapping the toolchain (optional);
# Rebuilding everything in the {{c|@world}} set using the new toolchain (optional);
# Verifying that all executables and libraries have been rebuilt (optional);
# Choosing whether to use {{c|systemd}} or {{c|OpenRC}} (some brief guidance is given to help you decide); then:
#* ''Either'', setting the final target profile (for GNOME/{{c|systemd}});
#* ''Or'', installing the necessary patchset overlays, and then setting the appropriate target profile (for GNOME/{{c|OpenRC}});
# Updating the {{c|@world}} set to reflect the new profile (whether {{c|systemd}} or {{c|OpenRC}}).

Instructions will also be provided for those who don't want to spend the time necessary to perform a full bootstrap. Let's get started!

== <span id="prep_for_chroot">Final Preparations for the {{c|chroot}}</span> ==

We begin by setting up appropriate the server URIs, which portage will search when looking for source tarballs.<ref>Gentoo Development Guide: [http://devmanual.gentoo.org/general-concepts/mirrors/index.html "Mirrors"]</ref> To do this, we <span id="use_mirrorselect">use the {{c|mirrorselect}} tool</span> (shipped as part of the minimal install system), which allows you to choose the appropriate mirror from a list, and then save the result to the {{Path|make.conf}} file (as an assignment to the {{c|GENTOO_MIRRORS}} variable):

{{RootCmd
|mirrorselect -i -o >> /mnt/gentoo/etc/portage/make.conf
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
<navigate through the list, and select all mirrors in your region>
</pre>
}}
{{Note|Use the cursor keys and {{Key|Page Up}} and {{Key|Page Down}} to navigate, and {{Key|Space}} to toggle a mirror on and off; then {{Key|Enter}} to save and exit when done.}}

Next, <span id="setup_gentoo_dot_conf">setup</span> a {{Path|/mnt/gentoo/etc/portage/repos.conf/gentoo.conf}} file (this specifies information about repositories in the system to Portage; see [[../Installing_the_Gentoo_Stage_3_Files#gentoo_overview{{!}}the earlier overview]] for a brief primer on the concepts involved). Issue:
{{RootCmd
|mkdir -p -v /mnt/gentoo/etc/portage/repos.conf
|cp -v /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
|nano -w /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}
and edit the file (removing any {{c|sync-uri}} line, if present) so it reads:
{{FileBox|filename=/mnt/gentoo/etc/portage/repos.conf/gentoo.conf|title=Setting up repository information for Portage|1=
[DEFAULT]
main-repo = gentoo

[gentoo]
location = /usr/portage
sync-type = rsync
auto-sync = yes
}}
Save and exit {{c|nano}}.

The above simply says that:
* The main repository is set to be {{c|gentoo}}, for all other repositories (such as overlays) that do not specify masters;
* The repository location is set to be {{Path|/usr/portage}} (within the {{c|chroot}}, that is);
* The repository ''will'' be synced during {{c|emerge --sync}} and {{c|emaint sync --auto}} runs;
* The repository is set to synchronize using the {{c|rsync}} protocol.

Next, we must specify the {{c|sync-uri}} variable, which tells Portage where to look for the {{c|rsync}} server, when bringing your Portage tree of ebuilds up to date. 
{{Note|This replaces the setting of the {{c|SYNC}} variable in {{c|make.conf}}, which is now deprecated (although still present in some versions of the handbook).}}
Issue:
{{RootCmd
|mirrorselect -i -r -o {{!}} sed 's/^SYNC{{=}}/sync-uri {{=}} /;s/"//g' >> /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
<navigate through the list, and select the most appropriate mirror from your region>
</pre>
}}
{{Note|Unlike the previous invocation, you can only select a single mirror here. Unless you have strong reasons not to, choose the 'Any available mirror' variant in a location close to you.}}

Check that something appropriate was written to {{Path|/mnt/gentoo/etc/portage/make.conf}} and {{Path|/mnt/gentoo/etc/portage/repos.conf}}:
{{RootCmd
|tail /mnt/gentoo/etc/portage/make.conf
|tail /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}

Next up, we need to <span id="copy_dns_info">make sure</span> our [[:Wikipedia:Domain_Name_System|DNS]] information, which exists on our target machine's current host system at {{Path|/etc/resolv.conf}}, is still available after we {{c|chroot}}; otherwise networking will stop working. Issue:

{{RootCmd
|cp -v -L /etc/resolv.conf /mnt/gentoo/etc/
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}
The {{c|-L}} option ensures we don't copy a symbolic link by mistake, since the host filesystem will become inaccessible once we {{c|chroot}}.

Next, <span id="copy_wpa_conf">if you are performing this install over a WiFi network</span>, copy the {{Path|/etc/wpa.conf}} configuration file for {{c|wpa_supplicant}} (which we setup [[../Setting_Up_Networking_and_Connecting_via_ssh#create_wpa_config|earlier]]) into the {{c|chroot}} filesystem. Issue:
{{RootCmd
|cp -v /etc/wpa.conf /mnt/gentoo/etc/
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|If you are installing over wired Ethernet, you should skip this particular command. It isn't relevant to your ability to use WiFi in the final system, only during the install itself.}}

Then, we need to <span id="setup_bind_mounts">ensure</span> that the kernel information in {{Path|/proc}}, and the special files in {{Path|/sys}} and {{Path|/dev}} are still available from inside the {{c|chroot}}. We therefore mount {{Path|/proc}} on {{Path|/mnt/gentoo/proc}}, and then bind-mount {{Path|/sys}} and {{Path|/dev}}:<ref>SuperUser Forum: [http://superuser.com/questions/165116/mount-dev-proc-sys-in-a-chroot-environment "mount dev, proc, sys in a chroot environment"]</ref>

{{RootCmd
|mount -v -t proc none /mnt/gentoo/proc
|mount -v --rbind /sys /mnt/gentoo/sys
|mount -v --rbind /dev /mnt/gentoo/dev
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}

Finally, we ensure that the {{c|chroot}}'s {{Path|/sys}} and {{Path|/dev}} are (recursive) {{Highlight|slave}} mounts (meaning that mounts and unmounts in the 'outer' system's corresponding subtrees will propagate to them, but not vice-versa); issue:
{{RootCmd
|mount -v --make-rslave /mnt/gentoo/sys 
|mount -v --make-rslave /mnt/gentoo/dev
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}

== <span id="enter_chroot">Entering the {{c|chroot}}</span> ==

We're now ready to change root ({{c|chroot}}), thereby entering our new system. After this is done, although we will still be running the minimal install kernel pro tem, commands issued from within the {{c|chroot}}-ed shell will only be able to 'see' and use files (including, but not limited to, executables, libraries, and configuration files) that lie within the stage 3 file structure we just unpacked (except for the special {{Path|/proc}}, {{Path|/sys}} and {{Path|/dev}} directories, of course). 

Per the handbook, we'll perform the {{c|chroot}} in three steps:
# Enter the {{c|chroot}}, using [[:Wikipedia:Bash_(Unix_shell)|bash]] as the shell;
# Reload some settings, using {{c|source}}; and
# Redefine the console prompt (to remind us we are in a {{c|chroot}}).

Issue:
{{RootCmd
|chroot /mnt/gentoo /bin/bash
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}
<span id="chroot_prompt">then</span>:
{{RootCmd
|source /etc/profile
|export PS1{{=}}"(chroot) $PS1"
|prompt=livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

{{Important|Remember that if you subsequently use the target machine directly at its keyboard (rather than through the {{c|ssh}}/{{c|screen}} combination as here), you'll be working '''outside''' of the {{c|chroot}}, and all your paths will be incorrect (e.g. the new system will still appear at {{Path|/mnt/gentoo/}}). It's an easy mistake to make, hence the renaming of the prompts. Once the kernel is built and the machine rebooted, we'll be 'natively' inside the new system, at which point this path issue will disappear.}}

== <span id="update_portage_tree">Installing an Up-to-Date Portage Tree</span> ==

The next step is to install a Portage (repository tree) ''snapshot'', a set of files that tells Portage what software is available to install, what profiles are available, and so on. These updates are produced on a daily basis. Issue:
{{RootCmd
|emerge-webrsync
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

{{Note|This command may complain about non-existent directories; however, now that {{Bug|484950}} has been fixed, it will still complete successfully. There is no need to manually create {{Path|/usr/portage}}, {{Path|/usr/portage/profiles}} or set {{Path|/usr/portage/profiles/repo_name}} before running {{c|emerge-webrsync}}.}}

The fetching may take some time to complete. Once done, the {{c|emerge-webrsync}} command may recommend some software be updated, and tell you there is news to read: if so, you can safely ignore these for now (we're about to do a ground-up rebuild anyway, and we'll get to the news items shortly).

Next, we'll bring the Portage tree bang up to date (this may also take a little time to complete):

{{RootCmd
|emerge --sync --quiet
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

{{Note|This command uses {{c|rsync}}, and so requires that your firewall permit TCP outbound on port 873, together with the usual state-tracking inbound rule. Its not a big problem if you can't get access at this stage however, since the snapshot from {{c|emerge-webrsync}} will be reasonably current. Nevertheless, the {{c|rsync}} firewall access should be enabled if Portage is to work properly long-term.}}

Next, make sure that Portage itself is up-to-date:

{{RootCmd
|emerge --ask --verbose --oneshot portage
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}

The {{c|emerge}} command, without special options, asks Portage to pull down (if necessary), build, and install the latest version of the package specified, in this case the Portage system itself. The {{c|--oneshot}} option informs Portage not to add itself to the set of 'explicitly-user-requested' packages in the [[World set (Portage)|'world']] file ({{Path|/var/lib/portage/world}}) (Portage is already part of the [[System set (Portage)|@system]] set, via the {{Package|virtual/package-manager}} package, so it would be redundant to add it here). The {{c|--ask --verbose}} flag set makes {{c|emerge}} '''a'''sk you before making any changes to your system, and produce '''v'''erbose output (generally useful, and may be abbreviated to {{c|-av}}). 

Now, if that {{c|emerge}} worked OK, (you eventually see "Jobs: 1 of 1 complete" in the output after you pressed {{Key|y}} and {{Key|Enter}}), congratulations: your Portage system is functional, and you should be able to proceed.

Finally, <span id="reading_news">if you were prompted about news items</span> being available, please take the time to read them now: these are important, short announcements from developers to users, pushed out via the Portage tree. To view the current news items issue:
{{RootCmd
|eselect news list
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

You'll notice the items are numbered. To read a news item N, enter:

{{RootCmd
|eselect news read N
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|Replace N in the above with the number of the news item you wish to read, such as 1, 2 etc.}}

You can purge all read news items with:
{{RootCmd
|eselect news purge
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

If you like, you can read more about the Gentoo news system on its manual page (using {{c|man news.eselect}}).

== <span id="check_base_profile">Ensuring that the Base Profile is Set</span> ==

As was mentioned [[../Installing_the_Gentoo_Stage_3_Files#variable_check_order|earlier]], Gentoo uses profiles to set important variables (such as {{c|USE}}, {{c|CFLAGS}}, etc.) relevant to your particular architecture and usage scenario (e.g., a machine running the GNOME desktop). Profiles also constrain the versions of packages that can be installed. This is all maintained on your behalf by the Gentoo developers.

At this point, we just need to check that we are running the baseline {{c|amd64}} profile (we should be). We'll change this to the 'real' profile post-bootstrap. Issue:

{{RootCmd
|eselect profile list
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
  [1]   default/linux/amd64/13.0 *
  [2]   default/linux/amd64/13.0/selinux
... additional output suppressed ...
  [5]   default/linux/amd64/13.0/desktop/gnome/systemd
... additional output suppressed ...
  [19]  default/linux/uclibc/amd64
  [20]  hardened/linux/uclibc/amd64
</pre>
}}

{{Note|The profile list shown on your machine may differ slightly from the above.}}

And double-check that the first entry is marked with an asterisk, indicating that it is active. If not, issue:

{{RootCmd
|eselect profile set 1
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
to correct this.

You can see the various (cumulative) variables assignments (to {{c|USE}} etc.) associated with a profile by looking at its {{Path|make.defaults}} file, and those of its parents. Specifically, the {{c|eselect profile set N}} command creates a [[:Wikipedia:Symbolic_link|symbolic link]] in {{Path|/etc/portage/make.profile}}. If you follow this link, and then look at the {{Path|make.defaults}} files in that directory (and in any of the directories listed by the {{Path|parent}} text file therein (transitively)), you will see how it works. Note that {{c|USE}} flags accumulate, but a flag with a minus sign in front of it gets removed from the list.

{{Important|Don't be tempted to change anything inside the {{Path|/etc/portage/make.profile}} directory; it'll be overwritten on the next Portage update.}}

You can also see the net effect of the profile, your {{Path|make.conf}}, environment etc. by issuing (this is a useful sanity check):
{{RootCmd
|emerge --info
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Lastly, if you are unsure of the meaning of any use flag, you can look it up as follows:
{{RootCmd
|grep -i useflag /usr/portage/profiles/use.desc
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|Replace {{c|useflag}} in the above command with the flag you want to query, for example {{c|multilib}}.}}

== <span id="set_timezone">Setting Up Timezone and Locale</span> ==

We don't have a timezone or locale set yet. So let's fix that now.

{{Note|If you elect to use {{c|systemd}} as your target init system (the choice comes [[#choose_systemd_or_openrc|later on this chapter]]), then note that some of these configuration options will need to be redone, in an {{c|systemd}} context, [[../Configuring_systemd_and_Installing_Necessary_Tools#set_systemd_config_opts{{!}}later in the tutorial]]. Nevertheless, we need to specify these basic elements now ahead of the bootstrap (as this will be performed in an [[OpenRC]] context).}}

First up is timezone. You can find the available timezone in {{Path|/usr/share/zoneinfo}} (generally, you'll have to check the subdirectory too):
{{RootCmd
|ls /usr/share/zoneinfo
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Choose an appropriate location, and place its relative path into {{Path|/etc/timezone}}. For example, to set <span id="set_europe_london">London</span>, in the UK, you would use:
{{RootCmd
|echo "Europe/London" > /etc/timezone
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|Please substitute the appropriate timezone for your own location in the above command.}}
{{Warning|Per the handbook's advice, please avoid using the {{Path|/usr/share/zoneinfo/Etc/GMT*}} timezones, as their names do not indicate the expected offsets.}}

Now, we need to reconfigure the {{Package|sys-libs/timezone-data}} package; this will pick up the value from {{Path|/etc/timezone}} and reflect the correct value in {{Path|/etc/localtime}}. The latter is necessary for the system C library.
{{RootCmd
|emerge -v --config sys-libs/timezone-data
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Secondly, we must <span id="modify_locale_gen">set an appropriate [[:Wikipedia:Locale|locale]]</span>. You must specify the locales you want to use in {{Path|/etc/locale.gen}}. Edit this file (using your favourite editor, such as {{c|nano}}), and uncomment those that you want. If necessary, add additional locales to the end of the list. For example, as there are no UK locales on the list (UK = United Kingdom, [[:Wikipedia:United_Kingdom_of_Great_Britain_and_Ireland|approximately the same]] ^-^ as Great Britain = GB) use we would need to add those as follows:

{{RootCmd
|nano -w /etc/locale.gen
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
Then ''append'' (for this example):
{{FileBox|filename=/etc/locale.gen|title=Append the following locales to the file (example only, adjust as needed)|1=
en_GB ISO-8859-1
en_GB.UTF-8 UTF-8
}}
Save and exit the {{c|nano}} editor.
{{Warning|Per the handbook, it is '''strongly''' recommended that you include at least one [[:Wikipedia:UTF-8|UTF-8]] locale in the list, since some applications may require it.}}
{{Note|The above is just an example. If your desired locales are already in the list (for example, {{c|en_US ISO-8859-1}} and {{c|en_US.UTF-8 UTF-8}} if in the USA, simply uncomment them.}}
{{Note|More information about locale strings and the like can be found in the [[Localization/Guide|Localization Guide]], please refer to that if you have any questions.}}

Next, we must run {{c|locale-gen}} to create the locales, based on the information in the {{Path|/etc/locale.gen}} file:
{{RootCmd
|locale-gen
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Assuming that completes successfully, you then must then specify the default locale to use. Find the system list with:
{{RootCmd
|eselect locale list
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
  [1]   C
  [2]   en_GB
  [3]   en_GB.iso88591
  [4]   en_GB.utf8
  [5]   POSIX
  [ ]   (free form)
</pre>
}}
{{Note|Your output will probably differ from the above, depending on what entries you uncommented or added to {{Path|/etc/locale.gen}}.}}

Choose the appropriate value from the list. At this stage, I recommend you stick with the 'C' (default) locale (other setups can cause issues with the indirect {{c|ssh}}/{{c|screen}} remote connection); we'll switch to your actual locale later on. Issue:
{{RootCmd
|eselect locale set N
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

{{Note|Replace N in the above command with the appropriate number from the {{c|eselect locale list}} output. For example, to choose the C locale (recommended), you would use {{c|eselect locale set 1}} here.}}

Now, reload your environment:
{{RootCmd
|env-update && source /etc/profile && export PS1{{=}}"(chroot) $PS1"
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

== <span id="set_post_boot_keymap">Setting Up (Post-Boot) Keymap</span> ==

We also need to setup a ''keymap'', both for use post-boot, so that you will be able to type commands correctly when typing directly at your machine's keyboard.

{{Note|The virtual console keymap here does ''not'' replace that which we will subsequently set up for early-boot use in the [[initramfs]] (which is necessary to allow correct entry of the LUKS password); see this [[../Configuring_and_Building_the_Kernel#keymap_issue{{!}}later comment]].}}

We begin by displaying a list of keymaps, and filtering out those of interest. The Panasonic CF-AX3 has a Japanese layout, but obviously your machine may differ. Issue:
{{RootCmd
|ls /usr/share/keymaps/i386/qwerty
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|If you use a non-{{c|qwerty}} layout, search inside the relevant directory instead; for example, {{Path|/usr/share/keymaps/i386/azerty}}.}}
Review the list, and choose a keymap file relevant to your location. In my case for example, there is one appropriate result, {{Path|jp106.map.gz}}. Strip off the {{c|.map.gz}} suffix to get the appropriate name: in my case {{c|jp106}} (yours will obviously vary, depending on your actual keyboard). Now we can setup the (virtual console) keymap. Issue:
{{RootCmd
|nano -w /etc/conf.d/keymaps
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and edit the <code>keymap=...</code> line, to cite the string you just found. For example, in my case:

{{FileBox|filename=/etc/conf.d/keymaps|title=Set the keymap as required|lang=bash|1=
keymap="jp106"
}}
Leave the rest of the file as-is (unless you know there are other changes you need to make here), and save and exit {{c|nano}}.
{{Note|Substitute for {{c|jp106}} in the above with a value appropriate for your own keyboard! For example, a standard US layout would use <code>keymap{{=}}"us"</code> here; a standard UK layout, <code>keymap{{=}}"uk"</code>.}}

== <span id="set_cpu_features">Informing Portage of Processor-Specific Features (Optional)</span> ==

In the [[../Installing_the_Gentoo_Stage_3_Files#set_cpu_flags_x86|last chapter]], we left the {{c|CPU_FLAGS_X86}} as the default ({{c|"mmx sse sse2"}}) in {{Path|/etc/portage/make.conf}} (you will recall that this variable is used to inform Portage about any processor-specific features (such as [[:Wikipedia:MMX_(instruction_set)|MMX]], for example) available on your machine). Now, if you like, we will fill it out, using the {{Package|app-portage/cpuinfo2cpuflags}} tool to help us.

{{Note|This is strictly optional: setting {{c|CPU_FLAGS_X86}} can result in more efficient code in many cases, but, if you wish to build code for redistribution to others in ''binary'' form, you should skip this step, and leave it as-is (since, unless those users also have a machine with exactly the same processor feature set as you, your distributed binaries may crash on execution).}}

If you do want to set {{c|CPU_FLAGS_X86}}, first emerge the {{Path|/proc/cpuinfo}} query tool (we'll use {{c|--oneshot}} here, to avoid adding it to your [[World set (Portage)|@world]] set):
{{RootCmd
|emerge --verbose --oneshot app-portage/cpuid2cpuflags
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Now, run the tool and note its output (yours may well differ from the below, which is taken from the Panasonic CF-AX3):
{{RootCmd
|cpuinfo2cpuflags-x86
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
CPU_FLAGS_X86: aes avx avx2 fma3 mmx mmxext popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3
</pre>
}}

Issue:
{{RootCmd
|nano -w /etc/portage/make.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
then copy the flags output by {{c|cpuinfo2cpuflags-x86}} into the existing {{c|CPU_FLAGS_X86{{=}}"mmx sse sse2"}} definition (replacing {{c|mmx sse sse2}}).  Save and exit {{c|nano}}.

== <span id="prep_for_parallel_emerge">Preparing to Run Parallel {{c|emerge}}s</span> ==

We have ([[../Installing_the_Gentoo_Stage_3_Files#parallel_emerge|intentionally]]) set our Portage system up to maximize parallelism when emerging. However, a side-effect of this is that, because multi-job support is active, {{c|emerge}} does not show any console build output, just a summary progress display.

This is easily fixed, using a simple script, which will show us the latest lines from both the Portage background tarball download log ({{Path|/var/log/emerge-fetch.log}}) ''and'' from the most recently updated build log (Portage builds its projects in {{Path|/var/tmp/portage}} by default). I have provided this and some other necessary utilities for this tutorial in a GitHub ''overlay'', which makes them straightforward to install and keep up to date within Portage (for details of overlays, see the background reading section [[../Installing_the_Gentoo_Stage_3_Files#overlays|earlier]]).

{{Note|As of version 2.2.16 of {{Package|sys-apps/portage}}, a new [[Project:Portage/Sync{{!}}plug-in sync system]] is available, which simplifies the use of overlays, and obviates the need for tools like [[Layman|{{c|layman}}]] (which was recommended in previous versions of this tutorial).}}

To begin with, we'll first install the [[:Wikipedia:Git_(software)|{{c|git}}]] source code management software, as we'll need this to be able to synchronize the overlay from [https://github.com/sakaki-/sakaki-tools GitHub]. Issue:
{{RootCmd
|mkdir -p -v /etc/portage/package.use
|touch /etc/portage/package.use/zzz_via_autounmask
|echo -e "# required by asciidoc (pulled in by git)\napp-text/texlive-core xetex" >> /etc/portage/package.use/texlive-core
|emerge --ask --verbose dev-vcs/git
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then Enter>
... additional output suppressed ...
</pre>
}}
{{Note|This may take some time to complete, as it'll bring in other packages transitively required by {{Package|dev-vcs/git}} itself.}}
{{Note|The {{c|xetex}} [[../Installing_the_Gentoo_Stage_3_Files#about_package_use{{!}}package-specific USE flag]] adds support for [[:Wikipedia:XeTeX|{{c|XeTeX}}]], a [[:Wikipedia:TeX|{{c|TeX}}]] system with [[:Wikipedia:Unicode|Unicode]] support. It is required to ensure the successful {{c|emerge}} of {{Package|app-text/asciidoc}}, which itself is an {{c|emerge}} dependency of {{Package|dev-vcs/git}}.}}
{{Note|We <span id{{=}}"create_zzz_autounmask">create</span> the {{Path|/etc/portage/package.use/zzz_via_autounmask}} file as a convenient receptacle for changes that you may, in future, request be automatically made to your {{c|package.use}} configuration to allow an {{c|emerge}} operation to complete successfully. Per the {{c|emerge}} [http://dev.gentoo.org/~zmedico/portage/doc/man/emerge.1.html manpage] (see particularly the {{c|--autounmask}} and {{c|--autounmask-write}} options), such changes are written to the "lexicographically last file" when {{Path|/etc/portage/package.use}} is a directory (as here).}}
Next, we need to tell Portage about our overlay, by adding an entry into the {{Path|/etc/portage/repos.conf}} directory. Issue:
{{RootCmd
|nano -w /etc/portage/repos.conf/sakaki-tools.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and add the following content to that file:
{{FileBox|filename=/etc/portage/repos.conf/sakaki-tools.conf|title=Add the following text to specify the sakaki-tools overlay|1=
[sakaki-tools]

# Various utility ebuilds for Gentoo on EFI
# Maintainer: sakaki (sakaki@deciban.com)

location = /usr/local/portage/sakaki-tools
sync-type = git
sync-uri = https://github.com/sakaki-/sakaki-tools.git
priority = 50
auto-sync = yes}}
Save, and exit {{c|nano}}.

The above simply specifies that:
* The repository is called {{c|sakaki-tools}};
* It should be cloned to the {{Path|/usr/local/portage/sakaki-tools}} directory;
* It is a git archive, which may be synchronized via the URI https://github.com/sakaki-/sakaki-tools.git;
* It has 'priority' 50 (ebuilds with higher priority override those of lower priority, in the event of a name clash; the default {{c|gentoo}} tree has priority -1000); and
* It will be automatically synced during during {{c|emerge --sync}} or {{c|emaint sync --auto}} runs. 

Next, we'll pull in the overlay itself. Issue:
{{RootCmd
|emaint sync --repo sakaki-tools
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

{{Note|After adding an overlay, you may find (as in this case) you are prompted that new news items (supplied by that overlay) are available. It's generally a good idea to take a look at these before proceeding; for brief instructions, please see [[#reading_news|these earlier notes]].}}

<span id="overlay_hygiene">Whenever using a third-party overlay</span> such as this one, remember that it will (in general, due to the 'priority' setting) take precedence over your 'real' Portage tree (the one it 'overlays'), in case of conflicting ebuilds. For this reason, it is prudent in such cases to:
# '''mask''' (blacklist) ''all'' packages from the overlay, then
# '''unmask''' (whitelist) ''only'' those packages from the overlay you explicitly know you want, then
# '''read''' the contents of those remaining, unmasked overlay ebuilds before installing (emerging) them.

{{Note|For more background details about ebuilds and other Portage internals, see [[../Installing_the_Gentoo_Stage_3_Files#gentoo_overview{{!}}this earlier primer]].}}

We'll begin by wildcard-masking everything from {{c|sakaki-tools}}. As described [[../Installing_the_Gentoo_Stage_3_Files#about_package_mask|earlier]], we'll use a file in the {{Path|/etc/portage/package.mask}} directory for this. Issue:
{{RootCmd
|mkdir -p -v /etc/portage/package.mask
|echo '*/*::sakaki-tools' >> /etc/portage/package.mask/sakaki-tools-repo
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|This qualified atom specifies all versions of all packages in all categories, that are supplied from the {{c|sakaki-tools}} overlay. For more details, refer to the background reading [[../Installing_the_Gentoo_Stage_3_Files#qualified_version_atom|in the previous chapter]].}}

Now we can unmask what we explicitly need (using, as described [[../Installing_the_Gentoo_Stage_3_Files#about_package_unmask|earlier]], files in the {{Path|/etc/portage/package.unmask}} directory). Issue:
{{RootCmd
|mkdir -p -v /etc/portage/package.unmask
|touch /etc/portage/package.unmask/zzz_via_autounmask
|echo "app-portage/showem::sakaki-tools" >> /etc/portage/package.unmask/showem
|echo "sys-kernel/buildkernel::sakaki-tools" >> /etc/portage/package.unmask/buildkernel
|echo "app-portage/genup::sakaki-tools" >> /etc/portage/package.unmask/genup
|echo "app-crypt/staticgpg::sakaki-tools" >> /etc/portage/package.unmask/staticgpg
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

As a short-term workaround to {{Bug|621470}}, you should also issue at this point:
{{RootCmd
|echo "sys-boot/plymouth" > /etc/portage/package.unmask/plymouth
|mkdir -p -v /etc/portage/profile/package.use.mask
|echo "gnome-base/gdm -plymouth" > /etc/portage/profile/package.use.mask/plymouth
|echo "sys-kernel/genkernel-next -plymouth" >> /etc/portage/profile/package.use.mask/plymouth
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

{{Note|When {{Path|/etc/portage/<...>}} elements are used as subdirectories in this way, the contents are simply processed in alphabetical order - there is no 'magic' to the underlying file names used.}}
{{Note|Also, as [[#create_zzz_autounmask{{!}}above]], we create a {{Path|zzz_via_autounmask}} file as a convenient receptacle for changes that you may, in future, request be automatically made to your {{c|package.unmask}} configuration to allow an {{c|emerge}} operation to complete successfully.}}

Here is a brief summary of what the above (whitelisted) ebuilds are, and what they do:
{| class="wikitable"
|-
! Package !! {{c|ebuild}} Location !! Description
|-
| {{Package|app-portage/showem}} || {{Path|/usr/local/portage/sakaki-tools/app-portage/showem/showem-1.0.2.ebuild}} || Provides a simple utility script ({{c|showem}}), which enables you to monitor the progress of a parallel {{c|emerge}}. A manpage is provided. The underlying source is available on [https://github.com/sakaki-/showem GitHub].
|-
| {{Package|sys-kernel/buildkernel}} || {{Path|/usr/local/portage/sakaki-tools/sys-kernel/buildkernel/buildkernel-1.0.25.ebuild}} || <span id="buildkernel_script">Provides a script</span> ({{c|buildkernel}}) to build a kernel suitable for booting from a USB key in UEFI mode, together with an integral initramfs. Automatically sets the necessary kernel configuration parameters, including the command line, and signs the resulting kernel if possible. Has a interactive and non-interactive (batch) mode. (Will be used [[../Configuring_and_Building_the_Kernel#first_buildkernel|later in the tutorial]].) On installation, attempts to automatically configure the {{Path|/etc/buildkernel.conf}} settings file (to set the two variables {{c|EFIPARTUUID}} and {{c|CRYPTPARTUUID}}, which ''must'' be assigned before {{c|buildkernel}} is run). Manpages for the script and the configuration file are provided. The underlying source is available on [https://github.com/sakaki-/buildkernel GitHub].
|-
| {{Package|app-portage/genup}} || {{Path|/usr/local/portage/sakaki-tools/app-portage/genup/genup-1.0.14.ebuild}}|| Provides the {{c|genup}} script, to simplify the process of keeping your Gentoo system up-to-date. {{c|genup}} can automatically update the Portage tree, all installed packages, and kernel. Has interactive and non-interactive (batch) modes. (Will be used later in the tutorial ([[../Configuring_systemd_and_Installing_Necessary_Tools#ensure_system_up_to_date|{{c|systemd}}]], [[../Completing_OpenRC_Configuration_and_Installing_Necessary_Tools#ensure_system_up_to_date|{{c|OpenRC}}]]).) A manpage is provided. The underlying source is available on [https://github.com/sakaki-/genup GitHub].
|-
| {{Package|app-crypt/staticgpg}} || {{Path|/usr/local/portage/sakaki-tools/app-crypt/staticgpg/staticgpg-1.4.16.ebuild}}|| <span id="staticgpg_first_intro">The {{c|buildkernel}} tool (above)</span> needs to be able to be able to place a copy of the {{c|gpg}} tool into the initramfs, so that the keyfile (which we created [[../Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#create_gpg_luks_keyfile|earlier]]) can be decrypted.

Unfortunately, the version of {{c|gpg}} that is emerged by Portage by default is the 2.x variant. This <span id="pinentry_problem">requires</span> a (rather convoluted) service known as {{c|pinentry}} to ask you for your password (even when compiled statically), and currently {{c|genkernel}}'s initramfs builder (and init script) does not work correctly with it. Instead, {{c|genkernel}} expects to be using a version 1.x {{c|gpg}} which can query for passphrases itself, without invoking an outside agent.

However, as the current {{Package|app-crypt/gnupg}} is not [http://devmanual.gentoo.org/general-concepts/slotting/ SLOTted], we unfortunately can't install both a 1.x and 2.x version of {{c|gpg}} simultaneously into different SLOTs (as we can for say, {{Package|dev-lang/python}}). The nuclear option is to roll our currently installed version of {{c|gpg}} back to 1.x of course (by placing the appropriate atom into [[../Installing_the_Gentoo_Stage_3_Files#about_package_mask|{{Path|/etc/portage/package.mask}}]] and re-emerging), but as {{c|gpg}} v2.x and {{c|pinentry}} are tightly integrated with GNOME, that's not a great idea.  

To work around this, I have provided the {{Package|app-crypt/staticgpg}} {{c|ebuild}} in {{c|sakaki-tools}}. This is derived from the version 1.4.16 {{c|ebuild}} of {{Package|app-crypt/gnupg}} (which does not rely on {{c|pinentry}}). However, this {{c|ebuild}} will always compile statically, has none of the standard 1.4.16 {{c|gpg}}'s USE-flag driven options, and only installs one program, {{c|staticgpg}} (plus a placeholder manpage) when emerged. It can safely be installed beside a standard 2.x version of {{Package|app-crypt/gnupg}}.
|}

{{Note|If for some reason you ''don't'' wish to use these packages directly, then by all means review and adapt their underlying source independently. However, you won't be able to follow along directly with the text in that case: in what follows, I'll be assuming that you ''have'' chosen to install the overlay.}}

Next, note that all user overlay ebuilds (by [http://devmanual.gentoo.org/keywording/index.html stipulation]) ''must'' specify that they are on the 'unstable' branch (since not yet fully tested). However, we are allowing (by default) only ''stable'' ({{c|amd64}}) packages (see [[../Installing_the_Gentoo_Stage_3_Files#set_keywords|above]]), we have to specify that for the above packages, the unstable/testing ('tilde') branch is acceptable. We use a file in the {{Path|/etc/portage/package.accept_keywords}} directory for this, as [[../Installing_the_Gentoo_Stage_3_Files#about_package_accept_keywords|described earlier]]. Issue:
{{RootCmd
|mkdir -p -v /etc/portage/package.accept_keywords
|touch /etc/portage/package.accept_keywords/zzz_via_autounmask
|echo "*/*::sakaki-tools ~amd64" >> /etc/portage/package.accept_keywords/sakaki-tools-repo
|echo -e "# all versions of efitools currently marked as ~ in Gentoo tree\napp-crypt/efitools ~amd64" >> /etc/portage/package.accept_keywords/efitools
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|For explanation of the qualified atoms used here, refer to [[../Installing_the_Gentoo_Stage_3_Files#qualified_version_atom{{!}}the previous chapter]].}}
{{Note|The only other keyworded package here is {{Package|app-crypt/efitools}}, which will be required to manipulate the secure boot keystores on the target machine later in the tutorial. We're not going to be installing (emerging) {{c|efitools}} yet, but we add the entry here so we don't have to come back to it further on.}}
{{Note|Again, as [[#create_zzz_autounmask{{!}}above]], we create a {{Path|zzz_via_autounmask}} file as a convenient receptacle for changes that you may, in future, request be automatically made to your {{c|package.accept_keywords}} configuration to allow an {{c|emerge}} operation to complete successfully.}}

Next, if you like, take a look through the {{c|ebuild}} files in the overlay (and any patches), read the underlying sources, and satisfy yourself that everything is benign. It is good hygiene to do this, particularly prior to using a third-party overlay for the first time.

Now, with that setup done, <span id="install_showem">we can now install</span> the {{c|showem}} tool using the standard {{c|emerge}} command. Issue:

{{RootCmd
|emerge --ask --verbose app-portage/showem
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then Enter>
... additional output suppressed ...
</pre>
}}

And that's {{c|showem}} installed!
 
We're about to do quite a lot of building, so it'll be useful to <span id="second_virtual_console">set up a second virtual console</span>, from which we can view the progress of {{c|emerge}} using our new script. Assuming you are running {{c|screen}} (as discussed [[../Setting_Up_Networking_and_Connecting_via_ssh#start_screen|earlier]]), press {{Key|Ctrl}}{{Key|a}} then {{Key|c}} to start a new console. Then in that new console (which is back outside the {{c|chroot}}, to begin with) enter:
{{RootCmd
|chroot /mnt/gentoo /bin/bash
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}
followed by
{{RootCmd
|source /etc/profile
|export PS1{{=}}"(chroot:2) $PS1"
|prompt=livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Now hit {{Key|Ctrl}}{{Key|a}} then {{Key|p}} to get back to the original console, and continue.

== <span id="bootstrapping_base_system">Bootstrapping the Base System (Optional but Recommended)</span> ==

We are about to perform the bootstrap proper! In the below, we will follow the Gentoo [[FAQ#How_do_I_Install_Gentoo_Using_a_Stage1_or_Stage2_Tarball?|FAQ's]] advice on how to recreate a 'stage 1' bootstrap in the modern age ^-^. (However, if you are content to rely on the shipped binaries, [[#choose_systemd_or_openrc|click here]] to skip this step.)

Note that here, bootstrapping refers to the process of:
# building (from source) the standard ''toolchain'' (GCC compiler, linker, assembler, C library and a number of other items), i.e., the components necessary to build the other software and libraries that make up Gentoo's [[World set (Portage)|{{c|@world}}]] package set; and then 
# using that newly constructed toolchain to rebuild everything in the [[World set (Portage)|{{c|@world}}]] package set, from source.

And the point of this whole exercise? Simply put, it is to ensure the integrity of the end binaries, as far as we can. To reiterate: we will first build the core tools from source, using (by necessity) the existing toolchain binaries that are shipped as part of the minimal 'stage 3' filesystem (which we're currently {{c|chroot}}-ed inside of). We then use this newly built toolchain to rebuild (from source) ''all'' the shipped software in the stage 3 tarball (plus that which we've explicitly emerged, such as {{Package|app-portage/layman}}). Once this has been done, we verify that all libraries and binaries (apart from the kernel, which we haven't built yet) have indeed been regenerated, and that no old binaries or libraries are still lying around.

{{Note|The GCC compiler suite itself contains a 'bootstrap', which is triggered during this process, but it is of a slightly different nature.<ref>GNU: [http://gcc.gnu.org/install/build.html "Installing GCC: Building"]</ref> In the GCC bootstrap, a pre-existing (shipped system binary) compiler (S) (which in this case actually is also GCC, but need not be) is used, to build a simplified GCC compiler from source (A), which is then used to build the full GCC compiler (for C or C++) (B), and then the full compiler is built ''again'' (C) using the compiler just produced (i.e., S builds A, then A builds B, then B builds C). The binaries for the last two compilers (B and C) are then compared to ensure they are identical (modulo build timestamps and the like). Confusingly, this process is also called a '3 stage' bootstrap!}}

{{Note|There's only so much comfort you can get with recompilation, of course. Per Ken Thompson's 1983 Turing Award lecture, "Reflections on Trusting Trust", the use of ''any'' 'original' binary can potentially expose all 'downstream' code to a [[:Wikipedia:Backdoor_(computing)|backdoor]] attack.<ref>Thompson, Ken. [http://dl.acm.org/citation.cfm?doid=358198.358210 "Reflections on Trusting Trust"]. 1983 Turing Award lecture</ref> For example, a compromised C compiler could 'infect' all subsequent compiled code - so even if the system were bootstrapped (as here), the malware would remain. Remember too, that you are still running under a kernel you didn't compile (that shipped with the minimal install image), although we'll get to building a new kernel from source shortly! Finally, even an open-source system relies on a ''lot'' of opaque [[:Wikipedia:Firmware|firmware]] and [[:Wikipedia:Microcode|microcode]], not to mention the hardware itself.
Nevertheless, although such attack vectors exist, they are relatively complex to exploit compared to the simplicity of producing and distributing a tainted high-level system binary (signatures notwithstanding). As such, there is still value to doing a ground-up rebuild, in my view. Should you ''not'' wish to do so, but would rather rely on the shipped stage 3 binaries, you can simply skip down to the section [[#choose_systemd_or_openrc{{!}}"Choosing between systemd or OpenRC Init"]]. (Note though, that with Gentoo, you'll probably end up rebuilding most everything over time anyway!).}}

In Gentoo parlance, people speak of three [[:Wikipedia:Gentoo_Linux#Stages|'stages']] of bootstrapping (and their corresponding file system tarballs):
# '''Stage 1''': When starting from a stage 1 tarball, the base toolchain (GCC, standard C libary etc.) must be built using the existing (binary) host system toolchain, under direction of the {{Path|/usr/portage/scripts/bootstrap.sh}} script. This yields a:
# '''Stage 2''' system. Here, we still need to {{c|emerge}} (build) the core [[World set (Portage)|{{c|@world}}]] package set, using our new toolchain. This yields a: 
#'''Stage 3''' system, in which the toolchain has been bootstrapped, and the important system binaries and libraries have been compiled using it. A tarball of such a stage 3 system's directories is now provided as a default part of the Gentoo distribution (stage 1 and stage 2 tarballs are not available to end-users anymore).

Although we have [[../Installing_the_Gentoo_Stage_3_Files#download_stage_3_tarball|already]] downloaded a stage 3 tarball, we're going to pretend we haven't, and instead build up from stage 1.

=== <span id="bootstrap_from_1_to_2">Gentoo Bootstrap Remix: Progressing from Stage 1 to Stage 2</span> ===

Right, let's get going. First, we'll need to build ourselves a toolchain! We'll switch to the correct directory, and then do a dummy run to see what the supplied {{c|bootstrap.sh}} script wants to do:

{{RootCmd
|cd /usr/portage/scripts
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
then
{{RootCmd
|./bootstrap.sh --pretend
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
}}

{{Note|The most direct way to make sense of the reported set of packages (and build order) output by the {{c|./bootstrap.sh --pretend}} command, is to look at a minimal, ground-up Linux installation like ''Linux from Scratch'' - this has an excellent handbook, which runs though the process you'd be going through by hand, if Portage didn't exist!<ref>Beekmans, Gerard. [http://www.linuxfromscratch.org/lfs/view/stable/ ''Linux from Scratch'']. Burgess, Matthew et. al. eds. 2013</ref>}}

{{Note|The Gentoo [[FAQ#How_do_I_Install_Gentoo_Using_a_Stage1_or_Stage2_Tarball?|FAQ]] suggests you may wish to edit the {{Path|/usr/portage/scripts/bootstrap.sh}} script; however for a vanilla bootstrap like this, there is no need to. By all means look through the code to get an idea of what it does though.}}

Start the build for real this time:
{{RootCmd
|./bootstrap.sh
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
}}

This will take a while! You can <span id=use_showem>now switch to the second {{c|screen}} console we prepared</span> [[#second_virtual_console|earlier]], and see what is going on (as the files download, build etc.). Hit {{Key|Ctrl}}{{Key|a}} then {{Key|n}} to switch to the second console (you can do this while the bootstrap is running), and issue:
{{RootCmd
|showem
|prompt=<span style{{=}}"color:gray;">(chroot:2)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

You can now switch back and forward between the two windows as you like (using {{Key|Ctrl}}{{Key|a}} then {{Key|n}} to cycle forwards, and {{Key|Ctrl}}{{Key|a}} then {{Key|p}} to cycle backwards - identical in function here where we only have two windows active), which should give you a good overview of the bootstrap process as it progresses.

{|style="background:transparent; color:black" 
|[[File:Bootstrap_emerge_1.png|thumb|none|400px|Running a Stage 1 Bootstrap in One Console...]]
|[[File:Bootstrap_emerge_2.png|thumb|none|400px|...And Watching the Logs with {{c|showem}} in Another]]
|}
{{Note|The output you see will most likely be slightly different from the screenshots above, as new versions of software get released etc.}}

Assuming the {{c|bootstrap.sh}} script completes successfully, you next need to check your GCC configuration (since we just rebuilt the compiler, and possibly upgraded it too). Switch back to the first console (hit {{Key|Ctrl}}{{Key|a}} then {{Key|0}}), and issue:

{{RootCmd
|gcc-config -l
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
}}

(That's an 'ell' by the way, not a one!)

If (and ''only'' if) the output tells you your current config is invalid, per [[Upgrading GCC|these notes]], issue the following to fix it:
{{RootCmd
|gcc-config 1
|env-update && source /etc/profile && export PS1{{=}}"(chroot) $PS1"
|emerge --ask --verbose --oneshot sys-devel/libtool
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then Enter>
... additional output suppressed ...
</pre>
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
}}
(That's a one as an argument to {{c|gcc-config}} this time by the way, not an 'ell'!)

{{Warning|It is '''very important''' that you ensure your GCC profile is correct. Failure to do so can break subsequent builds in a mildly spectacular fashion.}}
{{Note|If you did find it necessary to update {{c|gcc-config}}, you may then also, at this point, wish to switch to your second virtual console with {{Key|Ctrl}}{{Key|a}} then {{Key|n}}, stop any running {{c|showem}} with {{Key|Ctrl}}{{Key|c}}, then issue:
{{RootCmd
|source /etc/profile && export PS1{{=}}"(chroot:2) $PS1"
|prompt=<span style{{=}}"color:gray;">(chroot:2)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
}}
finally restarting {{c|showem}} if desired, then switching back to the first virtual console again with {{Key|Ctrl}}{{Key|a}} then {{Key|p}}.<br>However, provided you are only going to run {{c|emerge}} operations from the ''first'' virtual console, using the second to run {{c|showem}}, sourcing {{Path|/etc/profile}} in the second virtual console may safely be omitted, as I have done in the main body of the text.}}

Now, we must {{c|emerge}} the [[:Wikipedia:C_standard_library|C standard library]]. You may have noticed that the bootstrap ''already'' emerged the [https://devmanual.gentoo.org/general-concepts/virtuals/ virtual] package {{Package|virtual/libc}}; however, in Portage, emerging a virtual package does ''not'', by default, cause any already-installed package that satisfies that virtual (in our case, {{Package|sys-libs/glibc}}) to be rebuilt - which we want. Therefore, we must build it explicitly. Issue:
{{RootCmd
|emerge --ask --verbose --oneshot sys-libs/glibc
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then Enter>
... additional output suppressed ...
</pre>
}}
{{Note|When this command completes, you may see the following output:
{{GenericCmd|<pre>
... additional output suppressed ...
 * IMPORTANT: config file '/etc/locale.gen' needs updating.
 * See the CONFIGURATION FILES and CONFIGURATION FILES UPDATE TOOLS
 * sections of the emerge man page to learn how to update config files.
... additional output suppressed ...
</pre>
}}
The warning may safely be ignored at this point: we will discuss what it means (and resolve it) [[#update_config{{!}}shortly]].}}

Next, we'll run the {{c|bootstrap.sh}} script ''again'', to ensure that everything in the toolchain (including early dependencies, such as {{Package|sys-devel/gettext}} and {{Package|sys-libs/zlib}}) have been rebuilt using the new compiler, and are then themselves used in a rebuild of that compiler:

{{RootCmd
|./bootstrap.sh
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
|output=<pre>
 * System has been bootstrapped already!
 * If you re-bootstrap the system, you must complete the entire bootstrap process
 * otherwise you will have a broken system.
 * Press enter to continue or CTRL+C to abort ..
<press Enter>
... additional output suppressed ...
</pre>
}}

Now, just as above, you can switch back and forth between the two {{c|screen}} consoles, to review the progress.

Once the toolchain bootstrap has completed (for the second time), we're ready to rebuild all the other binaries using it. You shouldn't need to reset the GCC profile this time around, but just to be on the safe side, double-check it is valid:

{{RootCmd
|gcc-config -l
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
}}

And finally, revert back to the root directory:
{{RootCmd
|cd /
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">scripts #</span>
}}

=== <span id="bootstrap_from_2_to_3">Gentoo Bootstrap Remix: Progressing from Stage 2 to Stage 3</span> ===

We now need to build everything in the [[World set (Portage)|{{c|@world}}]] package set, using our shiny new toolchain.

Before we start, we need to <span id="create_build_timestamp">write a null 'timestamp' file</span>, which we'll use as a marker when checking later that all our executables and libraries have indeed been rebuilt. Issue:

{{RootCmd
|touch /tmp/prebuild_checkpoint
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Right, with that done, we are ready to build ''everything'' in the [[World set (Portage)|{{c|@world}}]] package set, including all the libraries upon which they depend, as follows:
{{RootCmd
|emerge --ask --verbose --emptytree --with-bdeps{{=}}y @world
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then Enter>
... additional output suppressed ...
</pre>
}}
{{Note|The above process may complain about some kernel flags not being set correctly. That's because they aren't - yet! Ignore this for now, as we will build a kernel with the correct flags shortly.}}
{{Note|For avoidance of doubt, the [[World set (Portage)|@world]] set ''includes'' the [[System set (Portage)|@system]] set.}}

Here's what those {{c|emerge}} parameters mean (see also the emerge [http://dev.gentoo.org/~zmedico/portage/doc/man/emerge.1.html manpage]):

{| class="wikitable"
|-
! Parameter !! Short Form !! Meaning
|-
| {{c|--ask}} || {{c|-a}} || Before performing the operation, show what would take place, and then ask whether to confirm or abort. It's usually a good idea to leave this set.
|-
| {{c|--verbose}} || {{c|-v}} || Provide more information about the emerge operation (e.g. USE flags that will be applied for each package, in the information provide by {{c|--ask}}).
|-
| {{c|--emptytree}} || {{c|-e}} || Build and install all the targets (in this case, everything in the [[World set (Portage)|world]] set), and their entire ''deep'' dependency tree, as though nothing were currently installed.
|-
| {{c|--with-bdeps{{=}}y}} || ''N/A'' || Include build-time dependencies that are not strictly required when calculating the deep dependency graph.
|-
| {{c|@world}} || ''N/A'' || Specifies what should be {{c|emerge}}d, in this case the [[World set (Portage)|world]] set of packages (the '@' prefix indicates that a set of packages is being referred to, rather than a single package). This includes the transitive closure of everything ''you'' asked be installed (listed in {{Path|/var/lib/portage/world}}) together with the {{c|@system}} set.
|}

{{Note|The {{c|emerge}} will take quite some time; as before (when we undertook the stage 1 -> stage 2 bootstrap), you can use {{Key|Ctrl}}{{Key|a}} then {{Key|n}} to switch to {{c|screen}}'s second virtual console, and review the ongoing build using {{c|showem}}; switch back to the original console with {{Key|Ctrl}}{{Key|a}} then {{Key|p}}. If you like (since the build will take several hours), you can even disconnect {{c|screen}} pro tem. To do this, hit {{Key|Ctrl}}{{Key|a}} then {{Key|d}}. You are then back in your original {{c|ssh}} session, and you can log out of that too if you like, using {{Key|Ctrl}}{{Key|d}}. The target machine will continue doing its thing in the background. Then, at some later point, you can {{c|ssh}} back in again, and execute
{{RootCmd
|screen -D -R
|prompt=livecd <span style{{=}}"color:royalblue;">~ #</span>
}}
to reconnect to {{c|screen}} - your two virtual consoles will still be there. Quite neat! Of course, if you like, there is no need to do any of this, you can simply stay connected all the way through the build.}}
{{Note|By default, Gentoo will also write a high-level summary log file to {{Path|/var/log/emerge.log}}.}}
{{Note|This command will not just rebuild existing binaries; it'll upgrade them too (if a newer version ebuild is available, since the stage 3 image was created).}}

After some time, the build will hopefully complete successfully (if it does not, please see the [[#troubleshooting_failed_build|troubleshooting]] section, below).

<span id="update_config">Assuming</span> you modified your {{Path|/etc/locale.gen}} file and/or {{Path|/etc/conf.d/keymaps}} file earlier (see [[#modify_locale_gen|here]] and [[#set_post_boot_keymap|here]]), then Portage will probably prompt you with:
{{GenericCmd|<pre>
... additional output suppressed ...
 * IMPORTANT: 2 config files in '/etc' need updating.
 * See the CONFIGURATION FILES section of the emerge
 * man page to learn how to update config files.
... additional output suppressed ...
</pre>
}}
in the output from the full {{c|emerge}} run. This is <span id="using_dispatch_conf">easily dealt with</span>, using the [[Handbook:AMD64/Portage/Tools#dispatch-conf|{{c|dispatch-conf}}]] tool (and it's good hygiene to run this anyway, after a large build session). This utility exploits the fact that Portage does not install packages directly to the filesystem, but rather uses a sandbox approach. As a result, it will not directly overwrite files in directories protected by the {{c|CONFIG_PROTECT}} variable (includes most files under {{Path|/etc/}} in a standard setup, you can use {{c|emerge --info | grep CONFIG_PROTECT}} to see the full details). Instead, it writes the new configs to .cfg0000_<name> files. {{c|dispatch-conf}} lets you step through each of these conflicting files in turn, shows you a [[:Wikipedia:Diff|{{c|diff}}]] between your current version and what the install wanted to write, and asks you what you want to do.

Enter:
{{RootCmd
|dispatch-conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Then follow the prompts to review each proposed change. Assuming only the {{Path|/etc/locale.gen}} and/or {{Path|/etc/conf.d/keymaps}} need modifying (should be the case at this stage), then you simply need to press {{Key|z}} for each file when prompted. This means (rather non-obviously) 'zap-new' - or in other words keep the version of the file that was there before the {{c|emerge}} was initiated. Once this has been done, {{c|dispatch-conf}} should exit automatically.
{{Note|If no configuration files are affected, then {{c|dispatch-conf}} will simply exit immediately. However, there's no harm in running it.}}
{{Note|Once you have got the full {{c|@world}} {{c|emerge}} to work successfully, you can easily redo it again (should you wish, or your paranoia dictate) by issuing
{{RootCmd
|emerge --depclean && emerge --ask --verbose --emptytree --with-bdeps{{=}}y @world
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} once more.
}}
If everything worked fine, then you can skip ahead to the [[#verifying_bootstrap|next section]]; otherwise, here are a few tips on how to rectify any problems that may have occurred.

=== <span id="troubleshooting_failed_build">Troubleshooting a Failed Build</span> ===

Generally, {{c|emerge}}s, even of the full [[World set (Portage)|{{c|@world}}]] set, go without a hitch. However, if you elected [[../Installing_the_Gentoo_Stage_3_Files#choose_testing_branch|earlier]] to use the '~amd64' (aka 'testing') phase ebuilds, issues will sometimes pop up. For example, here's a problem that happened during the writing of this guide, when attempting the stage 2 -> stage 3 {{c|emerge}} (I was using the testing branch then, since GNOME 3 had not been stabilized at the time - nevertheless, it's an instructive example):

[[File:Emerge_failure_1.png|thumb|none|400px|{{Package|media-libs/mesa}} Build Error during {{c|emerge}}]]

In this case, a build failure occurred while emerging the {{Package|media-libs/mesa-9.2.5}} package. Here are some steps you can take if this kind of thing happens to you (this is not an in-depth guide - for that see [[Handbook:AMD64/Working/Portage#When_portage_is_complaining|this section]] from the Gentoo handbook):

* '''If you are building on a system with little RAM''' (e.g. an old computer or a virtual machine), you might be running out of memory. On a VM, consider shutting it down, giving it more RAM, starting it again, and chrooting back into your installation if you still don't have a bootable system; you will be able to resume your build with ''emerge --resume''. Alternatively, you might be running way too much build jobs and too much concurrent compilations; in this case, go to ''/etc/portage/make.conf'' and crank down the ''-jX'' parameter on ''MAKEOPTS'', then go to ''/root/.bashrc'' and crank down the ''--load=Y'' and ''--jobs=Z'' parameters on your ''EMERGE_DEFAULT_OPTS''. If your build still fails, try creating a paging file on your hard drive and enabling it to have at least some extra virtual memory as follows: {{RootCmd|dd if{{=}}/dev/zero of{{=}}/pagefile bs{{=}}1M count{{=}}1024|mkswap /pagefile|swapon /pagefile|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>}}
* Sometimes, ''intermittent issues occur due to the very parallel build architecture'' we have [[../Installing_the_Gentoo_Stage_3_Files#parallel_emerge|specified]]. These issues will often resolve themselves if the build is recommenced. Fortunately, there's a flag for that. Issue {{RootCmd|emerge --resume|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} and {{c|emerge}} will try to pick up where it left off, with all the same settings. Alternatively, you can try to resume the {{c|emerge}} with parallel {{c|make}} temporarily switched off; to do so, issue {{RootCmd|MAKEOPTS{{=}}"-j1" EMERGE_DEFAULT_OPTS{{=}}"--jobs{{=}}1"  emerge --resume|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>}} If that works OK, great, you're done. If not, proceed to the next step. 
* Since you are (at the moment) running on a fairly 'vanilla' system, it's likely that ''others will have seen the build problem you're experiencing, and have already reported it''. Gentoo has a pretty quick turnaround for fixes, which are posted to the Portage (ebuild) tree when signed off. Therefore, the next-lowest-overhead way to fix a build problem is simply to wait a little while (if it's a major issue, you shouldn't have to wait long), then resync Portage, and try the {{c|emerge}} again (NB, but not using {{c|--resume}} here, since we've sync'd in between): {{RootCmd
|emerge --sync --quiet && emerge --ask --verbose --emptytree --with-bdeps{{=}}y @world|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} Hopefully, that fixed your problem. If not (or you don't want to wait), keep going...
* '''Look at the full build log'''. As the build has failed, this will still be in {{Path|/var/tmp/portage}} somewhere - indeed, in this example, the actual file is at {{Path|/var/tmp/portage/media-libs/mesa-9.2.5/temp/build.log}}. Have a read. Having done so, try searching for any appropriate-sounding errors using [http://www.google.com Google] (or, if you want to use an [https://www.startpage.com/eng/top-ten-ways-startpage.html anyonymized wrapper] around the Google search engine, [https://www.startpage.com Startpage]). For example, here the text {{GenericCmd|<pre>Makefile:603: recipe for target 'all-recursive' failed</pre>}}is quite specific and suggestive. A Google [http://www.google.com/search?q=Gentoo+~amd64+emerge+media-libs/mesa-9.2.5+Makefile:603:+recipe+for+target+%27all-recursive%27+failed search] for "{{c|Gentoo ~amd64 emerge media-libs/mesa-9.2.5 Makefile:603: recipe for target 'all-recursive' failed}}" yields a relevant hit: a post on the Gentoo discussion forums: [http://forums.gentoo.org/viewtopic-p-7494804.html "mesa-9.2.5 fails, egl_gallium/llvm related"]. A quick perusal shows us we have found the correct problem, and that it is related to {{Bug|488216}}, a problem with the package {{Package|sys-devel/llvm}}. In short, it appears that there is a problem with the default-use-flag build of {{Package|sys-devel/llvm-3.4}}, it's just that it shows itself in the build of {{Package|media-libs/mesa-9.2.5}}. You can now try to:
# Work around the problem, per the information you have found. For example, in this case, you could try appending {{c|~sys-devel/llvm-3.4 -ncurses}} to the {{Path|/etc/portage/package.use}} file (see this earlier discussion of [[../Installing_the_Gentoo_Stage_3_Files#atoms_etc|atoms]] and [[../Installing_the_Gentoo_Stage_3_Files#about_package_use|{{Path|/etc/portage/package.use}}]] if you're unclear as to what this means) and issuing the full {{c|@world}} {{c|emerge}} again. Just don't forget that you have that you have made this change - and do try to come back and see if you can revert the fix later! (were a new ebuild for LLVM to be released, for example).
# Try using an earlier version of the affected package (this is, in fact, the approach I adopted at the time, although it was rendered moot by the stabilization of GNOME 3). You can do this using the {{Path|/etc/portage/package.mask}} file (discussed [[../Installing_the_Gentoo_Stage_3_Files#about_package_mask|earlier]]), which tells Portage the versions of software '''not''' to allow. Here, we could try preventing Portage from using the 3.4 version of {{Package|sys-devel/llvm}}, by adding {{c|{{=}}sys-devel/llvm-3.4}} to {{Path|/etc/portage/package.mask}} (forcing Portage to reject it), then re-emerging. In this case, from the [https://packages.gentoo.org/package/sys-devel/llvm online package information grid] for LLVM, we can see this will drop us back to version 3.3-r3 (remember, I was on the testing branch). This approach generally works, but be warned - you may end up rolling back quite a lot of other packages when you mask in this way. Furthermore, if you adopt this approach, always be sure only to mask the ''specific'' version that has the problem (use '=' at the start of the {{Path|/etc/portage/package.mask}} line, per our earlier discussion of [[../Installing_the_Gentoo_Stage_3_Files#atoms_etc|atoms]]), as this means when a new (hopefully, fixed) ebuild is released (with a higher version number), Portage will automatically attempt to try to use that instead.

{{Note|Whatever you do, '''do not downgrade {{c|glibc}}.''' Forcing a downgrade will literally break your system the very second you put the older version in service. The official ebuild has actually been specially crafted to never let you downgrade {{c|glibc}} and exit with error status if a downgrade attempt is detected. If you can't build {{c|glibc}}, fix your system instead. For further info, read [http://www.gentoo-wiki.info/Downgrade_Glibc Downgrade Glibc] from the Gentoo Wiki archive.}}

* '''If you have switched your Portage profile''' and some toolchain-related packages like {{c|glibc}} refuse to build, try building {{c|gcc}} first, as some profiles like ''hardened'' require rebuilding the toolchain with different USE variables. Depending on your attention to detail, you can just issue a simple {{c|emerge -DNau --with-bdeps{{=}}y gcc}} and then {{c|emerge -DNau --with-bdeps{{=}}y @world}}, or you can outright boostrap your system again. Refer to [[Hardened/FAQ#How_do_I_switch_to_the_hardened_profile.3F|Hardened FAQ: How do I switch to the hardened profile]] for further info.


Finally, here are some miscellaneous hints that you may find useful:
# Check that your {{c|gcc}} configuration is set correctly, '''especially if you have recently upgraded your GCC installation''' - if it is invalid, builds will often fail in hard-to-debug ways. To do so, issue: {{RootCmd
|gcc-config -l|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} (That's an 'ell', not a 'one'!) If it returns '{{c|Active gcc profile is invalid}}' (or '{{c|No gcc profile is active!}}'), then specify an appropriate one from the list presented; for example, to select the first configuration in the list, issue: {{RootCmd
|gcc-config 1|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} (That's a 'one' this time!) If you do change your {{c|gcc}} profile in this way, be sure to issue: {{RootCmd
|env-update && source /etc/profile && export PS1{{=}}"(chroot) $PS1"|emerge --verbose --oneshot sys-devel/libtool|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>}} to update {{Package|sys-devel/libtool}}'s library locations, and to modify the settings in your current shell, before retrying any emerge.
# Check that your {{c|perl}} libraries are up-to-date. This will not always be handled properly by Portage, but you can use [http://www.techrepublic.com/blog/australian-technology/go-nuclear-on-gentoos-perl/ {{c|perl-cleaner}}] to bring things back in line. Issue: {{RootCmd
|perl-cleaner --reallyall|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} If your system detects stale Perl libraries and they all fail to build, try rebuilding Perl itself: {{RootCmd
|emerge -a dev-lang/perl|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
# Ditto for [http://www.npcglib.org/~stathis/blog/2012/12/05/linux-task-maintaining-a-gentoo-system/ {{c|python}}]. Issue: {{RootCmd
|python-updater|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} and then re-attempt the failed {{c|emerge}}.
# Ensure that {{c|ruby}} is set to the latest version, if it is present in your system (if the following {{c|eselect ruby list}} command returns an error, you do not). Certain things like {{Package|net-libs/webkit-gtk}} require an up-to-date version. Issue: {{RootCmd
|eselect ruby list|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} to see a list of available versions, and then: {{RootCmd
|eselect ruby set 3|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}} to choose one.{{Note|Replace the {{c|3}} in the above command with the index of the most recent {{c|ruby}} version, as reported in the output of {{c|eselect ruby list}}, above.}}

Then re-attempt the failed {{c|emerge}}.

== <span id="verifying_bootstrap">Verifying the Bootstrap (Optional but Recommended)</span> ==

Congratulations - by this point you have performed a 'stage 1' bootstrap, and so all the (binary) applications and libraries within the current {{c|chroot}} should have been recompiled. Just to make sure that nothing has sneaked through (i.e., an app or library somehow included in the stage 3 tarfile we [[../Installing_the_Gentoo_Stage_3_Files#download_stage_3_tarball|downloaded earlier]], but ''not'' present in the deep transitive closure of the [[World set (Portage)|{{c|@world}}]] package set), we'll check the datestamps of all relevant components against the {{Path|/tmp/prebuild_checkpoint}} we wrote [[#create_build_timestamp|before commencing the {{c|emerge}}]]. We aren't worried about any text executables (such as scripts) since, in principle, these can be audited to ensure they are not malicious.

First, remove any installed packages that are ''not'' part of the dependency tree, so that the following test is not confused. Issue:
{{RootCmd
|emerge --depclean
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Let this process run through to completion (it may take a little while). Then issue:

{{RootCmd
|find / -type d -path /boot/efi -prune -o -type f -executable -not -newer /tmp/prebuild_checkpoint -print0 2>/dev/null {{!}} xargs -0 file --no-pad --separator{{=}}"@@@" {{!}} grep -iv '@@@.* text'
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

This command [http://man7.org/linux/man-pages/man1/find.1.html finds] all ''executable'' files (except beneath the EFI mountpoint at {{Path|/boot/efi}}; which will host a FAT filesystem - in which ''all'' files appear executable - when mounted (it currently ''shouldn't'' be mounted though, assuming you've been following the tutorial flow, but the {{c|prune}} is there for robustness)), which ''aren't'' newer than the checkpoint file, then tests their file type using [http://man7.org/linux/man-pages/man1/file.1.html {{c|file}}], and prints them if they are not recognized as some form of text file (script, source code etc.). '''It should produce no output''' (as all files of this type should have been recreated, if our bootstrap was complete).

So much for executable binaries - what about libraries (shared or static)?<ref>Ippolito, Greg. [http://www.yolinux.com/TUTORIALS/LibraryArchives-StaticAndDynamic.html "Static, Shared Dynamic and Loadable Linux Libraries"]</ref> On Gentoo, we'll have already checked most shared ('.so') libraries, since they have their execute bits set. However, this is not true for all flavours of Linux, and furthermore, static ('.a') libraries (and '.o' object files) do not have the execute bits set.<ref>Unix & Linux Stack Exchange Forum: [http://unix.stackexchange.com/questions/61646/why-are-so-files-executable "Why are .so files executable?"]</ref> Therefore, to be double-sure, we'll run another test (this may take some time to complete):
{{RootCmd
|find / -type d -path /boot/efi -prune -o -type f -not -executable -not -newer /tmp/prebuild_checkpoint -print0 2>/dev/null {{!}} xargs -0 file --no-pad --separator{{=}}"@@@" {{!}} grep  '@@@.*\( ELF\{{!}} ar archive\)'
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
This looks for any files which ''aren't'' newer than our checkpoint file, and which are recognized by {{c|file}} as [[:Wikipedia:Executable_and_Linkable_Format|ELF]] or [[:Wikipedia:Ar_(Unix)|ar archives]]; it may take some time to complete (as there are a lot of files to check). Again, it should produce no output. If so, and the previous check also worked, then congratulations, you have fully rebuilt all executable binaries and libraries on your machine!

== <span id="choose_systemd_or_openrc">Choosing between systemd or OpenRC Init</span> ==

At this point, you need to choose which [[:Wikipedia:Init|init system]] you want to use on your target machine: [[systemd]] or [[OpenRC]].

{{c|systemd}} is the default choice, since a 'vanilla' (unpatched) GNOME 3.8+ system requires it to run properly.<ref name="gnome_systemd_runtime_dep"/> It is currently the most widely adopted<ref>Wikipedia: [https://en.wikipedia.org/wiki/Systemd#Adoption_and_reception "systemd: Adoption and reception"]</ref> init system amongst Linux distributions.

However, please be aware that there ''is'' now an alternative, for those who would rather not use {{c|systemd}}. This involves installing a patchset provided by Dantrell B., which enables Gentoo users to enjoy the full GNOME experience (including session tracking and power management) under Gentoo's own init system ([[OpenRC]]).

{{Important|Don't stress out about making this choice! If:
* you want to use Gentoo's standard repositories and profiles for GNOME; or
* you have no strong preference; or
* you're not really sure what all this init system stuff is about anyway ^-^,
then you should select {{c|systemd}}, as doing so will leave you on the 'mainstream' track, where you will find it more straightforward to receive timely security updates, obtain support via the forums etc.}}

If you choose to go the {{c|OpenRC}} route, and so use Dantrell's patchset for GNOME (full instructions for which are provided in this guide), please be aware that, as with any third-party overlay:
* you may find it more difficult to get support via the normal Gentoo channels (the forums etc.) when using an 'unofficial' patchset such as this one;
* security fixes etc. may take longer to be released, and the overlays may themselves contain security holes;
* the patchset's author (Dantrell B.) may cease support for this patchset in the future.

Having said that:
* the vast majority of the GNOME code is unaffected by the patches;
* the patchset code itself is largely shared with [http://www.funtoo.org Funtoo], who use it in their mainline distribution,<ref>Funtoo Linux FAQ: [http://www.funtoo.org/Funtoo_Linux_FAQ#Do_you_support_systemd.3F "Do you support systemd?"]</ref> so you will not be alone;
* Dantrell B. [https://github.com/dantrell/gentoo-project-gnome-without-systemd/blob/master/GOVERNANCE.md#long-term-support has stated] his intention to support this patchset for Gentoo (at least until either a proper answer for the GNOME/systemd issue is arrived at, he ceases to use GNOME, or the complexity gets out of control).

Ultimately, as with all things Gentoo, the choice is yours ^-^

When you have decided, continue as below:
* For {{c|systemd}}, follow the [[#choose_systemd_profile|"Option 1"]] text below, and then read the rest of this guide following the 'default' flow. Do not follow "Option 2" or read any of the 'alternative track' chapters (they are clearly marked). Be sure also to follow any specific instructions in chapters 8 and 9 that are marked for the attention of {{c|systemd}} users; or
* For {{c|OpenRC}}, follow the [[#choose_openrc_profile|"Option 2"]] text below, and then read the rest of this guide, following the 'alternative track' for Chapters 10 onwards (you will see the branch point clearly marked at the end of Chapter 9). Be sure also to follow any specific instructions in chapters 8 and 9 that are marked for the attention of {{c|OpenRC}} users.

=== <span id="choose_systemd_profile">Option 1: Setting a systemd Profile</span> ===

{{Note|Remember: if you want to use OpenRC as your init system, please do ''not'' carry out the instructions in this section, but read [[#choose_openrc_profile{{!}}"Option 2"]] instead.}}

OK, so let's <span id="set_systemd_profile">set our [[Profile|Portage profile]]</span> to the version we actually want to use going forward (we avoided doing so earlier, to minimize the scope of the bootstrap).

Issue:

{{RootCmd
|eselect profile list
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
  [1]   default/linux/amd64/13.0 *
  [2]   default/linux/amd64/13.0/selinux
... additional output suppressed ...
  [5]   default/linux/amd64/13.0/desktop/gnome/systemd
... additional output suppressed ...
  [19]  default/linux/uclibc/amd64
  [20]  hardened/linux/uclibc/amd64
</pre>
}}
The current (default) profile is shown marked with an asterisk. However, the most correct profile for our purposes is the 'desktop' variant that cites GNOME and {{c|systemd}}. In the above list, this is number 5 (but your output may differ, so be sure to check).
{{Note|The output shown is just an example and will change over time. Note also that the 'developer' profiles are for Gentoo internal development; if you just want to develop regular software on your system, you don't need to select one of these.}}

To switch, issue:

{{RootCmd
|eselect profile set N
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|Replace N in the above command with the desired profile number: 5 in the case of this example.}}

Now, continue reading at [[#update_world|"Updating @world to Reflect the New Profile"]], below (i.e., please skip the "Option 2" text below, as it does not apply).

=== <span id="choose_openrc_profile">Option 2: Adding Overlays and Setting an OpenRC Profile</span> ===

{{Note|Remember: if you want to use {{c|systemd}} as your init system, please do ''not'' carry out the instructions in this section, but read [[#choose_systemd_profile{{!}}"Option 1"]] instead.}}

To use GNOME with OpenRC, you will first need to install a few custom overlays, to apply Dantrell B.'s [https://github.com/dantrell/gentoo-project-gnome-without-systemd patchset for GNOME] (see the background reading section [[../Installing_the_Gentoo_Stage_3_Files#overlays|earlier]] for a brief overview of overlays).

At the time of writing there are six overlays to install: a 'common' one, and one for each of GNOME 3.14, 3.16, 3.18, 3.20 and 3.22. We'll create configuration files in {{Path|/etc/portage/repos.conf}} for each of these.

{{Note|It is also possible to install and use [[layman]] to manage the overlays, rather than specifying them in {{Path|/etc/portage/repos.conf}}. For details of this alternative approach, please see the Gentoo Wiki page [[GNOME/GNOME_Without_systemd{{!}}GNOME Without systemd]]; however, in this tutorial, I'm going to assume you want to install the overlays directly.}} 

Begin with the 'common' overlay; issue:

{{RootCmd
|nano -w /etc/portage/repos.conf/dantrell-gnome.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and enter the following text:
{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome.conf|title=Configuration for dantrell-gnome repo|1=
[dantrell-gnome]

# Dantrell B.'s Gentoo Overlay for GNOME (generic)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd

location = /usr/local/portage/dantrell-gnome
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome.git
priority = 150
auto-sync = yes
}}
Save, and exit {{c|nano}}.

The above simply specifies that:
* The (common GNOME) repository is called {{c|dantrell-gnome}};
* It should be cloned to the {{Path|/usr/local/portage/dantrell-gnome}} directory;
* It is a [[:Wikipedia:Git_(software)|{{c|git}}]] archive, which may be synchronized via the URI https://github.com/dantrell/gentoo-overlay-dantrell-gnome.git;
* It has 'priority' 150 (ebuilds with higher priority override those of lower priority, in the event of a name clash; the default {{c|gentoo}} tree has priority -1000); and
* It will be automatically synced during during {{c|emerge --sync}} or {{c|emaint sync --auto}} runs.

Next, the 3.14 overlay. Issue:

{{RootCmd
|nano -w /etc/portage/repos.conf/dantrell-gnome-3-14.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and enter the following text:
{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-14.conf|title=Configuration for dantrell-gnome-3-14 repo|1=
[dantrell-gnome-3-14]
 
# Dantrell B.'s Gentoo Overlay for GNOME (3.14)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd
 
location = /usr/local/portage/dantrell-gnome-3-14
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-14.git
priority = 100
auto-sync = yes
}}
Save, and exit {{c|nano}}. (The contents should be self-explanatory).

Then, the 3.16 overlay (it is fine to have multiple versions installed, the profile, which we will select shortly, will decide which takes precedence). Issue:

{{RootCmd
|nano -w /etc/portage/repos.conf/dantrell-gnome-3-16.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and enter the following text:
{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-16.conf|title=Configuration for dantrell-gnome-3-16 repo|1=
[dantrell-gnome-3-16]
 
# Dantrell B.'s Gentoo Overlay for GNOME (3.16)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd
 
location = /usr/local/portage/dantrell-gnome-3-16
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-16.git
priority = 100
auto-sync = yes
}}
Save, and exit {{c|nano}}. (Again, the contents should be self-explanatory).

Then, the 3.18 overlay. Issue:

{{RootCmd
|nano -w /etc/portage/repos.conf/dantrell-gnome-3-18.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and enter the following text:
{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-18.conf|title=Configuration for dantrell-gnome-3-18 repo|1=
[dantrell-gnome-3-18]
 
# Dantrell B.'s Gentoo Overlay for GNOME (3.18)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd
 
location = /usr/local/portage/dantrell-gnome-3-18
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-18.git
priority = 100
auto-sync = yes
}}
Save, and exit {{c|nano}}.

Then, the 3.20 overlay. Issue:

{{RootCmd
|nano -w /etc/portage/repos.conf/dantrell-gnome-3-20.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and enter the following text:
{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-20.conf|title=Configuration for dantrell-gnome-3-20 repo|1=
[dantrell-gnome-3-20]
 
# Dantrell B.'s Gentoo Overlay for GNOME (3.20)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd
 
location = /usr/local/portage/dantrell-gnome-3-20
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-20.git
priority = 100
auto-sync = yes
}}
Save, and exit {{c|nano}}.

Then, the 3.22 overlay. Issue:

{{RootCmd
|nano -w /etc/portage/repos.conf/dantrell-gnome-3-22.conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
and enter the following text:
{{FileBox|filename=/etc/portage/repos.conf/dantrell-gnome-3-22.conf|title=Configuration for dantrell-gnome-3-22 repo|1=
[dantrell-gnome-3-22]
 
# Dantrell B.'s Gentoo Overlay for GNOME (3.22)
# Maintainer: Dantrell B. (email: see CONTRIBUTING.md in main GitHub project)
# Homepage: https://github.com/dantrell/gentoo-project-gnome-without-systemd
 
location = /usr/local/portage/dantrell-gnome-3-22
sync-type = git
sync-uri = https://github.com/dantrell/gentoo-overlay-dantrell-gnome-3-22.git
priority = 100
auto-sync = yes
}}
Save, and exit {{c|nano}}.

{{Note|If you are ''sure'' you only want to use one version of GNOME, for example 3.16, then it suffices to create the overlay file specific to it (in this example, that would be {{Path|/etc/portage/repos.conf/dantrell-gnome-3-16.conf}}, in addition of course to the common overlay ({{Path|/etc/portage/repos.conf/dantrell-gnome.conf}}). However, to allow later flexibility, I recommend setting up all five variants (3.14, 3.16, 3.18, 3.20 and 3.22) now, per the main body of the text (the profile, which we will set shortly, will determine which version takes precedence on your system).}}

Now, pull in the overlays:

{{RootCmd
|emaint sync --repo{{=}}dantrell-gnome
|emaint sync --repo{{=}}dantrell-gnome-3-14
|emaint sync --repo{{=}}dantrell-gnome-3-16
|emaint sync --repo{{=}}dantrell-gnome-3-18
|emaint sync --repo{{=}}dantrell-gnome-3-20
|emaint sync --repo{{=}}dantrell-gnome-3-22
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

{{Note|You may recall [[#overlay_hygiene{{!}}the advice given earlier]] to apply a global mask / selective unmask strategy to third-party overlays, as a hygiene measure. Due to the size of the Dantrell overlays, we won't do that here, but feel free to cast an eye over the provided ebuilds if you like, before proceeding further.}}

The Dantrell overlays we just installed provide (''inter alia'') a bundled set of [[Profile|Portage profiles]]; these allow you to conveniently set {{c|USE}} flags, masks etc. and thereby ensure that subsequent installation of GNOME proceeds smoothly.

{{Note|For each version of GNOME (3.14, 3.16, 3.18, 3.20 and 3.22) a 'standard' (no-suffix) and 'extended' profile are provided. The 'extended' profiles attempt to match many of the standard USE flags that a desktop install of GNOME in Gentoo would have (whereas the 'standard' profiles are more minimal in scope). As such, I recommend that you use an 'extended' profile in what follows.<br>Incidentally, the use of the {{c|dantrell-gnome-reparent}} profiles (mentioned in earlier versions of this guide) is no longer recommended. Please choose a corresponding Dantrell 'extended' profile instead (as now recommended in the main body of this text), as these perform essentially the same function.}}

Accordingly, we next <span id="set_openrc_profile">set our profile</span> to the version we actually want to use going forward (we avoided doing so earlier, to minimize the scope of the bootstrap).

Issue:

{{RootCmd
|eselect profile list
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
  [1]   default/linux/amd64/13.0 *
  [2]   default/linux/amd64/13.0/selinux
... additional output suppressed ...
  [23]  dantrell-gnome:default/amd64/3.14
  [24]  dantrell-gnome:default/amd64/3.14/extended
  [25]  dantrell-gnome:default/amd64/3.16
  [26]  dantrell-gnome:default/amd64/3.16/extended
  [27]  dantrell-gnome:default/amd64/3.18
  [28]  dantrell-gnome:default/amd64/3.18/extended
  [29]  dantrell-gnome:default/amd64/3.20
  [30]  dantrell-gnome:default/amd64/3.20/extended
  [31]  dantrell-gnome:default/amd64/3.22
  [32]  dantrell-gnome:default/amd64/3.22/extended
</pre>
}}
(Your output may vary.)
{{Note|Although you will see 'developer' profiles in this list, don't be concerned - these are for Gentoo internal development only, you can still develop regular software on your system under any of the profiles, including the one we will choose.}}

The current (default) profile is shown marked with an asterisk. However, the most correct profile for our purposes is the 'extended' variant whose version matches the current 'stable' version of GNOME in mainline Gentoo. To find out what version this is (version 3.20, at the time of writing), consult the table in {{Package|gnome-base/gnome}}, and look for the green box with a plus sign in it, under the {{c|amd64}} heading.

{{Note|Users who have elected to use the 'testing' branch ({{c|~amd64}} rather than {{c|amd64}}) [[../Installing_the_Gentoo_Stage_3_Files#set_keywords{{!}}earlier]] may use any available 'dantrell-gnome' profile.}}
{{Note|If you wish to do so, GNOME will also build fine with the appropriate Dantrell 'unextended' profile selected. However, you may find your experience is impaired due to missing codecs etc., when compared to a 'standard' Gentoo GNOME desktop. In what follows, I'm going to assume you have chosen a 'extended' profile.}}

Having found the stable version of GNOME, select the appropriate profile; for example, to use GNOME 3.14 (one of the 'stable' versions at the time of writing), issue:
{{RootCmd
|eselect profile set "dantrell-gnome:default/amd64/3.14/extended"
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}
{{Note|Obviously, substitute for the <code>dantrell-gnome:default/amd64/3.14/extended</code> profile name in the above command if necessary, for example, if targeting GNOME 3.18 instead.}}
{{Important|Please '''do not''' choose any profile other than an extended (or, should you wish, a standard) {{c|dantrell-gnome}} variant, if you intend to use GNOME with {{c|OpenRC}}: doing so will almost certainly fail later in the install, unless you are very sure of what you are doing.}}
Check that the new profile is now active:
{{RootCmd
|eselect profile show
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
Current /etc/portage/make.profile symlink:
  dantrell-gnome:default/amd64/3.14/extended
</pre>
}}
The output you see may differ from the above, but should reflect the profile choice you just made.

{{Note|To remove these overlays (should you wish to do so at some future time), simply switch your profile back (for example, to {{c|default/linux/amd64/13.0}}), move the four {{Path|dantrell-gnome*.conf}} files out of {{Path|/etc/portage/repos.conf/}}, and update {{c|@world}}. That isn't something you should do at this point in time, obviously!}}

Having now successfully set up the appropriate custom profile, continue reading below.

== <span id="update_world">Updating @world to Reflect the New Profile</span> ==

Having chosen a target init system ({{c|systemd}} or {{c|OpenRC}}), and selected the appropriate profile, we must update {{c|@world}} set, to pull in (and build from source) any new packages required, and to reflect any USE flag changes to existing packages (by rebuilding them as necessary).
{{Note|({{c|systemd}} users only) It is no longer necessary to do a two-stage {{Package|sys-apps/dbus}}/{{Package|sys-apps/systemd}} {{c|emerge}} (as you will sometimes see reported); the circular dependency on {{Package|sys-fs/udev-init-scripts-25}} was broken by moving it to [http://devmanual.gentoo.org/general-concepts/dependencies/#post-merge-dependencies PDEPEND], as of revision 1.9 of the {{c|systemd-208-r2.ebuild}}.<ref>Portage Attic: [http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/sys-apps/systemd/systemd-208-r2.ebuild?hideattic{{=}}0&r1{{=}}1.8&r2{{=}}1.9 Diff between v1.9 and v1.8 of {{Path|/sys-apps/systemd/systemd-208-r2.ebuild}}]</ref>}}

Issue:
{{RootCmd
|emerge --ask --verbose --deep --with-bdeps{{=}}y --newuse --update @world
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then Enter>
... additional output suppressed ...
</pre>
}}

Here's <span id="world_update_params">what those {{c|emerge}} parameters mean</span> (see also the emerge [http://dev.gentoo.org/~zmedico/portage/doc/man/emerge.1.html manpage]):

{| class="wikitable"
|-
! Parameter !! Short Form !! Meaning
|-
| {{c|--ask}} || {{c|-a}} || Before performing the operation, show what would take place, and then ask whether to confirm or abort. It's usually a good idea to leave this set.
|-
| {{c|--verbose}} || {{c|-v}} || Provide more information about the emerge operation (e.g. USE flags that will be applied for each package, in the information provide by {{c|--ask}}).
|-
| {{c|--deep}} || {{c|-D}} || Consider the full [[:Wikipedia:Transitive_closure#In_graph_theory|transitive closure]] of the build dependency graph, not just the immediate dependencies.
|-
| {{c|--with-bdeps{{=}}y}} || ''N/A'' || Include build-time dependencies that are not strictly required when calculating the deep dependency graph.
|-
| {{c|--newuse}} || {{c|-N}} || Include packages whose use flags have changed since they were last built.
|-
| {{c|--update}} || {{c|-u}} || Update packages to the best version available in the Portage ebuild tree (as of the last time you sync'd), subject to masking etc.
|-
| {{c|@world}} || ''N/A'' || Specifies what should be {{c|emerge}}d, in this case the [[World set (Portage)|world]] set of packages (the '@' prefix indicates that a set of packages is being referred to, rather than a single package). This includes the (newly expanded, due to your changed profile) {{c|@system}} set, plus any packages you requested be installed.
|}

{{Note|Do not worry if you are warned about kernel configuration options not being set correctly, we will create an appropriate kernel in the next chapter.}}
{{Note|This {{c|emerge}} will take some time. While it is running, as we discussed [[#use_showem{{!}}earlier in the bootstrapping section]], you can switch to the second {{c|screen}} virtual console and review progress with {{c|showem}}, if you like.}}
{{Note|If your {{c|emerge}} exits with an error, see the section [[#troubleshooting_failed_build{{!}}"Troubleshooting a Failed Build"]] above, for some hints.}}
{{Note|({{c|OpenRC}} users only) If you are having trouble with the {{c|emerge}}, try switching from the 'extended' to the 'standard' {{c|dantrell-gnome}} profile for your chosen version of GNOME (as the 'standard' variants specify fewer USE flags than their 'extended' siblings). For example, if you are having trouble emerging under the {{c|dantrell-gnome:default/amd64/3.14/extended}} profile, try switching to the {{c|dantrell-gnome:default/amd64/3.14}} profile, and then attempting the {{c|emerge}} again.}}
{{Note|Because of the profile change, the {{c|emerge}} command may tell you there are news items to read. Feel free to read any fresh news items now, if you like, following the [[#reading_news{{!}}earlier instructions]].}}

Whether or not {{c|emerge}} warns you that you have configuration files that need updating as a result of the above update, it is good hygiene to run:
{{RootCmd
|dispatch-conf
|prompt=<span style{{=}}"color:gray;">(chroot)</span> livecd <span style{{=}}"color:royalblue;">/ #</span>
}}

Then follow the prompts to review each proposed change, if any.
{{Note|Assuming no modified configuration files have been modified (in a manner that cannot be mechanically reconciled) by the update (the most likely scenario), then {{c|dispatch-conf}} will simply exit immediately, printing nothing. However, there's no harm in running it. The [[Handbook:AMD64/Portage/Tools#dispatch-conf|{{c|dispatch-conf}}]] tool is discussed in more detail in the bootstrapping section [[#using_dispatch_conf{{!}}above]].}}

== <span id="next_steps">Next Steps</span> ==

Having successfully built the {{c|@world}} set for our new profile, we can now turn our attention to the heart of the system: the Linux kernel itself. [[../Configuring_and_Building_the_Kernel|Click here]] to go to the next chapter, "Configuring and Building the Kernel".

== <span id="notes">Notes</span> ==
{{reflist}}

{| class="wikitable" style="margin: 1em auto 1em auto;"
|-
| [[../Installing_the_Gentoo_Stage_3_Files|< Previous]]
| [[../|Home]]
| [[../Configuring_and_Building_the_Kernel|Next >]]
|}

[[Category:Core system]]
[[Category:Localization]]
[[Category:Portage]]
[[Category:Security]]
