{{InfoBox stack
|{{InfoBox homepage|https://gerbera.io/|header=true}}
|{{InfoBox github|gerbera/gerbera}}
|{{InfoBox odoc|http://docs.gerbera.io/en/latest/}}
}}

Gerbera is [[Article description::an open source [[Wikipedia:Universal_Plug_and_Play|UPnP]] media server that streams digital media through a home network to UPnP compatible devices.]] Gerbera is [https://github.com/gerbera/gerbera#differences-to-mediatomb-so-far based] on [https://sourceforge.net/projects/mediatomb/ MediaTomb] 0.12.1, which is no longer maintained.

== Installation ==

=== Kernel ===

Gerbera requires IP multicast support for automatic discovery by UPnP devices.

{{KernelBox|title=Enabling IP multicast support|1=<nowiki />
[*] Networking support --->
            Networking options --->
              [*] TCP/IP networking
              [*]   IP: multicasting
}}

Gerbera supports [[Wikipedia:Inotify|inotify]], which is a file-monitoring mechanism that allows Gerbera to be notified about changes to files immediately. For more information, please consult the Gerbera [http://docs.gerbera.io/en/latest/ui.html#trail-operations trail operations] documentation.

{{KernelBox|title=Enabling inotify support|1=<nowiki />
    File systems --->
      [*] Inotify support for userspace
}}

=== USE flags ===

{{USEflag|package=net-misc/gerbera}}

=== Emerge ===

After setting any USE configuration, proceed to install Gerbera:

{{Emerge|net-misc/gerbera}}

== Configuration ==

=== Network ===

* To set the network interface that Gerbera binds to, add the following to the <var>GERBERA_OPTIONS</var> variable, and substitute <code>network_interface</code> with the appropriate value e.g. <code>GERBERA_OPTIONS="-e eth0"</code>

{{FileBox|filename=/etc/conf.d/gerbera|lang=bash|1=
GERBERA_OPTIONS="-e network_interface"
}}

* To set the IP address that Gerbera binds to, add the following to the <var>GERBERA_OPTIONS</var> variable, and substitute <code>ip_address</code> with the appropriate value e.g. <code>GERBERA_OPTIONS="-i 192.168.0.1"</code>

{{FileBox|filename=/etc/conf.d/gerbera|lang=bash|1=
GERBERA_OPTIONS="-i ip_address"
}}

=== MySQL ===

{{Important|[[MySQL]] support requires the <var>USE</var> flag <code>mysql</code> to be enabled for the {{Package|net-misc/gerbera}} package.}}

* To enable MySQL support, set the <code>enabled</code> attribute to <code>yes</code> for the <code><mysql></code> element:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
      <mysql enabled="yes">
}}

* Set the <code>enabled</code> attribute to <code>no</code> for the <code><sqlite3></code> element:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
      <sqlite3 enabled="no">
}}

* Set the <code><host></code>, <code><database></code>, <code><username></code> and <code><password></code> elements:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|
        <host>host</host>
        <database>database</database>
        <username>username</username>
        <password>password</password>
}}

* Login to MySQL and create the Gerbera database and user, using the <code>host</code>, <code>database</code>, <code>username</code> and <code>password</code> values set in the Gerbera configuration file:

{{Cmd
|CREATE DATABASE database;
|GRANT ALL ON database.* TO 'username'@'host' IDENTIFIED BY 'password';
|prompt=mysql>
|color=white
}}

=== Transcoding ===

Gerbera supports transcoding media files to formats that are supported by the UPnP device being used. The default Gentoo configuration file uses FFmpeg to transcode FLAC, Flash, Theora and Vorbis files. For more information, please consult the Gerbera [http://docs.gerbera.io/en/latest/config-transcode.html transcoding configuration] documentation.

* To enable transcoding support, set the <code>enabled</code> attribute to <code>yes</code> for the <code><transcoding></code> element:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
  <transcoding enabled="yes">
}}

* For every additional mimetype that requires transcoding, add the following section in between the <code><mimetype-profile-mappings></code> and <code></mimetype-profile-mappings></code> elements and substitute <code>mimetype</code> and <code>profile</code> with the appropriate values e.g. <code><transcode mimetype="video/quicktime" using="video2mpeg"/></code>

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
      <transcode mimetype="mimetype" using="profile"/>
}}

* Install FFmpeg:

{{Important|Transcoding support requires the <var>USE</var> flag <code>encode</code> to be enabled for the {{Package|media-video/ffmpeg}} package.}}

{{Emerge
|media-video/ffmpeg
|params+=--noreplace
}}

==== Alternative transcoders ====

Gerbera's transcoding support is very flexible and any application capable of transcoding can be used. For more information, please consult the Gerbera [http://docs.gerbera.io/en/latest/transcoding.html transcoding] documentation.

===== VLC =====

'''Audio'''

* To enable VLC audio transcoding, replace the <code><agent></code> element for the <code>audio2pcm</code> profile with the following:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
        <agent command="vlc" arguments="%in -I dummy --sout=#transcode{acodec=s16b,ab=192,samplerate=44100,channels=2}:standard{access=file,mux=raw,dst=%out} vlc://quit"/>
}}

* Set the <code><accept-url></code> element to <code>yes</code> for the <code>audio2pcm</code> profile:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|
        <accept-url>yes</accept-url>
}}

'''Video'''

* To enable VLC video transcoding, replace the <code><agent></code> element for the <code>video2mpeg</code> profile with the following:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
        <agent command="vlc" arguments="%in -I dummy --sout=#transcode{vcodec=mp2v,vb=4096,fps=25,acodec=mpga,ab=192,samplerate=48000,channels=2,audio-sync}:standard{access=file,mux=ps,dst=%out} vlc://quit"/>
}}

* Set the <code><accept-url></code> element to <code>yes</code> for the <code>video2mpeg</code> profile:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|
        <accept-url>yes</accept-url>
}}

* Install VLC:

{{Important|Transcoding support requires the <var>USE</var> flags <code>ffmpeg</code> and <code>encode</code> to be enabled for the {{Package|media-video/vlc}} package. It also requires the <var>USE</var> flag <code>encode</code> to be enabled for the {{Package|media-video/ffmpeg}} package.}}

{{Emerge
|media-video/vlc
|params+=--noreplace
}}

===== MPlayer =====

'''Video'''

* To enable MPlayer video transcoding, replace the <code><agent></code> element for the <code>video2mpeg</code> profile with the following:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
        <agent command="mencoder" arguments="%in -o %out -ovc lavc -oac lavc -lavcopts vcodec=mpeg2video:vbitrate=4096:vrc_minrate=0:vrc_maxrate=9800:vrc_buf_size=1835:keyint=15:vstrict=0:acodec=mp2:abitrate=192 -vf harddup -af lavcresample=48000:channels=2 -srate 48000 -ofps 25 -of mpeg -mpegopts format=mpeg2:tsaf"/>
}}

* Set the <code><accept-url></code> element to <code>yes</code> for the <code>video2mpeg</code> profile:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|
        <accept-url>yes</accept-url>
}}

* Install MPlayer:

{{Important|Transcoding support requires the <var>USE</var> flag <code>encode</code> to be enabled for the {{Package|media-video/mplayer}} package.}}

{{Emerge
|media-video/mplayer
|params+=--noreplace
}}

=== DLNA ===

{{Note|Gerbera is not a [[Wikipedia:Digital_Living_Network_Alliance|DLNA]] media server. Gerbera does have partial DLNA support for some DLNA devices e.g. PlayStation 3.}}

{{Important|DLNA support requires the <var>USE</var> flag <code>protocol-extensions</code> to be enabled for the {{Package|net-misc/gerbera}} package.}}

* To enable DLNA support, set the <code>extend</code> attribute to <code>yes</code> for the <code><protocolInfo></code> element:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
    <protocolInfo extend="yes">
}}

* For DLNA enabled TVs (e.g. Samsung), add the following section in between the <code><server></code> and <code></server></code> elements:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
    <custom-http-headers>
      <add header="transferMode.dlna.org: Streaming"/>
      <add header="contentFeatures.dlna.org: DLNA.ORG_OP=01;DLNA.ORG_CI=0;DLNA.ORG_FLAGS=01500000000000000000000000000000"/>
    </custom-http-headers>
}}

{{Note|Support for custom headers was added to {{Package|net-libs/libupnp}} 1.8.5 (not yet released). This makes Gerbera currently unsuitable for DLNA devices that require custom header support<ref>seppbiersack. [https://github.com/gerbera/gerbera/issues/352 Samsung TV Support], [https://github.com/gerbera/gerbera Gerbera GitHub], September 26th, 2018. Retrieved on March 7th, 2019.</ref>.}}

=== Video thumbnails ===

{{Important|Video thumbnail support requires the USE flags <code>ffmpeg</code> and <code>ffmpegthumbnailer</code> to be enabled for the {{Package|net-misc/gerbera}} package.}}

* To enable video thumbnail support, set the <code>enabled</code> attribute to <code>yes</code> for the <code><ffmpegthumbnailer></code> element:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
      <ffmpegthumbnailer enabled="yes">
}}

* To overlay a filmstrip border on the generated thumbnail, set the <code><filmstrip-overlay></code> element to <code>yes</code>:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|
        <filmstrip-overlay>yes</filmstrip-overlay>
}}

* For [[#DLNA|DLNA]] enabled devices that support video thumbnails (e.g. PlayStation 3), set the <code>extend</code> attribute to <code>yes</code> for the <code><protocolInfo></code> element:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
    <protocolInfo extend="yes">
}}

=== Raw images ===

* To enable (Canon CR2 and Nikon NEF) [[Wikipedia:Raw_image_format|raw image]] support, enable [[#Transcoding|transcoding]] and add the following section in between the <code><profile></code> and <code></profile></code> elements:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
      <profile name="raw2jpeg" enabled="yes" type="external">
        <mimetype>image/jpeg</mimetype>
        <accept-url>no</accept-url>
        <first-resource>yes</first-resource>
        <hide-original-resource>yes</hide-original-resource>
        <use-chunked-encoding>no</use-chunked-encoding>
        <agent command="/usr/local/bin/gerbera-raw2jpeg" arguments="%in %out"/>
        <buffer size="524288" chunk-size="512" fill-size="1024"/>
      </profile>
}}

* Add the following section in between the <code><mimetype-profile-mappings></code> and <code></mimetype-profile-mappings></code> elements:

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
      <transcode mimetype="image/raw" using="raw2jpeg"/>
}}

* For every additional raw image format (supported by [http://www.cybercom.net/~dcoffin/dcraw/ dcraw]), add the following section in between the <code><extension-mimetype ignore-unknown="no"></code> and <code></extension-mimetype></code> elements, and substitute <code>extension</code> with the appropriate value e.g. <code><map from="kdc" to="image/raw"/></code>

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
        <map from="extension" to="image/raw"/>
}}

* Since dcraw only outputs to stdout, the output will need to be redirected with the following script:

{{FileBox|filename=/usr/local/bin/gerbera-raw2jpeg|lang=bash|1=
#!/bin/sh

DCRAW_PATH="/usr/bin/dcraw"
INPUT="$1"
OUTPUT="$2"

exec "${DCRAW_PATH}" -e -c "${INPUT}" > "${OUTPUT}"
}}

* Install dcraw:

{{Emerge
|media-gfx/dcraw
|params+=--noreplace
}}

== Service ==

'''OpenRC'''

* To start Gerbera:

{{RootCmd|rc-service gerbera start}}

* To start Gerbera at boot:

{{RootCmd|rc-update add gerbera default}}

== Troubleshooting ==

=== Mimetype mapping ===

{{Important|After adding or changing a mimetype mapping, media needs to be imported again since mimetype mappings are only set during import.}}

Gerbera (via libmagic) may identify the mimetype of some files incorrectly. A common case is where ''videos'' with the <code>mp4</code> extension are identified as the mimetype <code>audio/mp4</code>. To override the mimetype returned by libmagic, add the following section in between the <code><extension-mimetype ignore-unknown="no"></code> and <code></extension-mimetype></code> elements, and substitute <code>extension</code> and <code>mimetype</code> with the appropriate values e.g. <code><map from="mp4" to="video/mp4"/></code>

{{FileBox|filename=/etc/gerbera/config.xml|lang=xml|1=<nowiki />
        <map from="extension" to="mimetype"/>
}}

== References ==

{{reflist}}

[[Category:Multimedia]]
