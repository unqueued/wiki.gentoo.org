{{InfoBox stack
|{{InfoBox wikipedia}}
}}

This article describes the configuration and usage of Bluetooth controllers and devices.

== Prerequisites ==

This article assumes that [[udev]], [[USB]] and/or [[PC-Card]] have been previously configured.

== Installation ==

=== Kernel ===

Use the table below to determine which Bluetooth options you need to enable. In most cases enabling RFCOMM, HIDP, HCI USB and/or HCI UART should be sufficient.
{{KernelBox|1=
[*] Networking support --->
      <*>   Bluetooth subsystem support --->
              <*>   RFCOMM protocol support
              [ ]     RFCOMM TTY support
              < >   BNEP protocol support
              [ ]     Multicast filter support
              [ ]     Protocol filter support
              <*>   HIDP protocol support
                    Bluetooth device drivers --->
                      <*> HCI USB driver
                      <*> HCI UART driver
                      [ ]   UART (H4) protocol support
                      [ ]   BCSP protocol support
                      [ ]   Atheros AR300x serial support
                      [ ]   HCILL protocol support
                      [ ]   Three-wire UART (H5) protocol support
      <*>   RF switch subsystem support --->
}}
{| class="table"
|+ Bluetooth Options
|-
! Option
! Driver
! Description
|-
| RFCOMM protocol support || rfcomm || Enables [[Wikipedia:RFCOMM|RFCOMM]] support which is required for [[Wikipedia:OBEX|OBEX]] file transfers, dial-up networking and other Bluetooth applications.
|-
| RFCOMM TTY support || - || Enables [[terminal emulator]] connections over RFCOMM.
|-
| BNEP protocol support || bnep || Enables network support, e.g. the [[Wikipedia:Personal Area Network|PAN]] profile.
|-
| Multicast filter support || - || Enables multicast filter support.
|-
| Protocol filter support || - || Enables protocol filter support.
|-
| HIDP protocol support || hidp || Enables [[Bluetooth Input devices|input device]] support.
|-
| HCI USB driver || btusb || Enables USB device support.
|-
| HCI UART driver || hci_uart || Enables UART based PCMCIA and CF device support.
|}

=== Software ===

Bluetooth user space support is provided by {{Package|net-wireless/bluez}}. Portage has ebuilds for BlueZ 4 (deprecated) and BlueZ 5.

You can enable Bluetooth support system-wide by adding <code>bluetooth</code> to the USE variable.
{{FileBox|filename=/etc/portage/make.conf|lang=bash|1=
USE="bluetooth"
}}

If you require BlueZ 4 you can [[:/etc/portage/package.mask|mask]] BlueZ 5 to prevent it from being installed.
{{FileBox|filename=/etc/portage/package.mask|1=
>=net-wireless/bluez-5
}}

If you enabled the <code>bluetooth</code> USE flag system-wide you will need to update your system.
{{Emerge
|@world
|params+=--changed-use --deep}}

Install BlueZ.
{{Emerge
|net-wireless/bluez
|params+=--noreplace}}

== Configuration ==

=== Permissions ===

If you have the <code>acl</code> USE flag enabled system-wide and are using [[ConsoleKit]] or [[systemd]], permissions for Bluetooth devices will be handled automatically.

An alternative is to add the user you want to be able to access Bluetooth devices to the ''plugdev'' group.
{{RootCmd|gpasswd -a ''user'' plugdev}}

== Starting ==

'''OpenRC'''
* Start Bluetooth.
{{RootCmd|rc-service bluetooth start}}
* Start Bluetooth at boot.
{{RootCmd|rc-update add bluetooth default}}

'''systemd'''
* Start Bluetooth.
{{RootCmd|systemctl start bluetooth}}
* Start Bluetooth at boot.
{{RootCmd|systemctl enable bluetooth}}

== Usage ==

=== Controller setup ===

* Display Bluetooth controller information.
{{RootCmd|hciconfig -a|output=<pre>
hci0:   Type: BR/EDR  Bus: USB
        BD Address: 00:02:72:2F:A9:33  ACL MTU: 1021:8  SCO MTU: 64:1
        UP RUNNING PSCAN 
        RX bytes:1166 acl:0 sco:0 events:43 errors:0
        TX bytes:960 acl:0 sco:0 commands:43 errors:0
        Features: 0xbf 0xfe 0xcf 0xfe 0xdb 0xff 0x7b 0x87
        Packet type: DM1 DM3 DM5 DH1 DH3 DH5 HV1 HV2 HV3 
        Link policy: RSWITCH SNIFF 
        Link mode: SLAVE ACCEPT 
        Name: 'BlueZ 5.21'
        Class: 0x000104
        Service Classes: Unspecified
        Device Class: Computer, Desktop workstation
        HCI Version: 4.0 (0x6)  Revision: 0x1000
        LMP Version: 4.0 (0x6)  Subversion: 0x220e
        Manufacturer: Broadcom Corporation (15)
</pre>}}
Where ''hci0'' is the name of the first controller and ''UP'' indicates that the controller is enabled.

* If <tt>hciconfig</tt> indicates that the controller is disabled  with ''DOWN'', you will need to enable the controller.
{{RootCmd|hciconfig hci0 up}}

* You may receive the following message when attempting to enable the controller.
{{RootCmd|hciconfig hci0 up|output=<pre>
Can't init device hci0: Operation not possible due to RF-kill
</pre>}}
In this case you will need to query the controllers [http://wireless.kernel.org/en/users/Documentation/rfkill rfkill] state with {{Package|net-wireless/rfkill}}.
{{RootCmd|rfkill list bluetooth|output=<pre>
0: hci0: Bluetooth
        Soft blocked: no
        Hard blocked: no
</pre>}}

* If <tt>rfkill</tt> indicates that the controller is blocked with ''Soft blocked: yes'', you will need to unblock the controller.
{{RootCmd|rfkill unblock bluetooth}}

* If <tt>rfkill</tt> indicates that the controller is blocked with ''Hard blocked: yes'', you will need to unblock the controller by physical switch or keyboard function key.

* If you need to use trusted Bluetooth devices before a graphical environment is up and running, you can use the following udev rule.
{{FileBox|filename=/etc/udev/rules.d/90-bluetooth.rules|lang=bash|1=
# Enable the Bluetooth controller

# BlueZ 4
ACTION=="add", KERNEL=="hci0", TEST=="/usr/sbin/hciconfig", RUN+="/usr/sbin/hciconfig hci0 up"
# BlueZ 5
ACTION=="add", KERNEL=="hci0", TEST=="/usr/bin/hciconfig", RUN+="/usr/bin/hciconfig hci0 up"
}}

=== Device pairing ===

Bluetooth devices need to be paired with a Bluetooth controller before they can be used. This is done by entering a PIN (or other code) on both devices via an interaction agent. Certain devices such as [[Bluetooth_Headset|headsets]] do not allow entering an arbitrary PIN. These devices use a static PIN, which is usually 0000, 1111, 1234 or 9999. There are devices (e.g. [https://en.wikipedia.org/wiki/PlayStation_3_accessories#Blu-ray_Disc_Remote_Control Sony BD Remote Control]) that do not require PIN entry and attempting to enter a PIN when prompted will result in failure. You can skip the pairing step with these devices.

This article only covers device pairing with a command-line interaction agent. If you have a graphical desktop environment you can perform device paring with a graphical interaction agent. You can use {{Package|net-wireless/bluedevil}} for [[KDE]], {{Package|net-wireless/gnome-bluetooth}} for [[GNOME]] and {{Package|net-wireless/blueman}} for GTK+.

==== BlueZ 4 ====

Device paring which is done with <tt>simple-agent</tt>, requires that you enable the <code>test-programs</code> USE flag for {{Package|net-wireless/bluez}}.

* Put the device into pairing mode. This generally involves pressing a button or a combinations of buttons, usually for several seconds.

* Discover the device MAC address.
{{Cmd|hcitool scan|output=<pre>
Scanning ...
        00:1F:20:1D:1B:4B       Bluetooth Device
</pre>}}
Where ''00:1F:20:1D:1B:4B'' is the MAC address of the device.

* Pair with the device.
{{Cmd|simple-agent hci0 00:1F:20:1D:1B:4B|output=<pre>
RequestPinCode (/org/bluez/1664/hci0/dev_00_1F_20_1D_1B_4B)
Enter PIN Code: 0000
Release
New device (/org/bluez/1664/hci0/dev_00_1F_20_1D_1B_4B)
</pre>}}
Enter a PIN and press {{Key|Enter}}. Now enter the same PIN on the device.

* If you have a graphical interaction agent installed (BlueDevil, GNOME Bluetooth etc.), you may receive the following message when attempting to pair with the device.
{{Cmd|simple-agent hci0 00:1F:20:1D:1B:4B|output=<pre>
dbus.exceptions.DBusException: org.bluez.Error.AlreadyExists: Already Exists
</pre>}}
In this case you will need to stop or disable the graphical interaction agent and attempt to pair with the device again.

* Query the trust status of the device.
{{Cmd|bluez-test-device trusted 00:1F:20:1D:1B:4B|output=<pre>
0
</pre>}}
Where ''0'' is not trusted and ''1'' is trusted.

* Trust the device so it can connect automatically.
{{Cmd|bluez-test-device trusted 00:1F:20:1D:1B:4B yes}}

* Connect to the device. If the device is trusted you only need to do this once.
{{Cmd|bluez-test-input connect 00:1F:20:1D:1B:4B}}

* The device is now paired.

==== BlueZ 5 ====

{{Note|If you have upgraded from BlueZ 4 you will need to pair any previously paired devices again.}}
Device paring which is done with <tt>bluetoothctl</tt>, is provided by {{Package|net-wireless/bluez}}.

* Start <tt>bluetoothctl</tt>.
{{Cmd|bluetoothctl}}

* List the available controllers.
{{Cmd|list|prompt=[bluetooth]#|color=blue}}

* Display information about a controller.
{{Cmd|show ''controller_mac_address''|prompt=[bluetooth]#|color=blue}}

* Set the default controller.
{{Cmd|select ''controller_mac_address''|prompt=[bluetooth]#|color=blue}}

* Power on the controller.
{{Cmd|power on|prompt=[bluetooth]#|color=blue}}

* Enable the agent and set it as default.
{{Cmd
|agent on
|default-agent
|prompt=[bluetooth]#|color=blue}}

* Set the controller as discoverable (temporarily for 3 minutes) and pairable.
{{Cmd
|discoverable on
|pairable on
|prompt=[bluetooth]#|color=blue}}

* Scan for devices.
{{Cmd|scan on|prompt=[bluetooth]#|color=blue}}

* Put the device into pairing mode.

* Discover the device MAC address.
{{Cmd|devices|prompt=[bluetooth]#|color=blue}}

* Pair with the device.
{{Cmd|pair ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* If prompted enter the PIN code.
{{Cmd|PIN code: ####|prompt=[agent]|color=red}}

* If prompted allow the service authorization request.
{{Cmd|Authorize service ''service_uuid'' (yes/no): yes|prompt=[agent]|color=red}}

* Trust the device.
{{Cmd|trust ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* Connect to the device.
{{Cmd|connect ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* Display information about the device.
{{Cmd|info ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* The device is now paired.
{{Cmd|quit|prompt=[bluetooth]#|color=blue}}

== See also ==

* [[Bluetooth Headset]]
* [[Bluetooth Input devices]]
* [[Bluetooth Network Aggregation Point]]

== External resources ==

* [http://www.elstel.org/MobilePhone.html Bluetooth for Your Mobile Phone]

[[Category:Interfaces]]
