{{InfoBox stack
|{{InfoBox wikipedia}}
}}

This article describes the configuration and usage of Bluetooth controllers and devices.

== Prerequisites ==
This article assumes that [[udev]], [[USB]] and/or [[PC-Card]] have been previously configured.

== Installation ==

=== Kernel ===
Use the table below to determine which Bluetooth subsystem you need to enable. In most cases enabling RFCOMM, HIDP, HCI USB and/or HCI UART should be sufficient. 
{{Kernel||<pre>
[*] Networking support --->
      <*>   Bluetooth subsystem support --->
              <*>   RFCOMM protocol support
              [ ]     RFCOMM TTY support
              < >   BNEP protocol support
              [ ]     Multicast filter support
              [ ]     Protocol filter support
              <*>   HIDP protocol support
                    Bluetooth device drivers --->
                      <*> HCI USB driver
                      <*> HCI UART driver
                      [ ]   UART (H4) protocol support
                      [ ]   BCSP protocol support
                      [ ]   Atheros AR300x serial support
                      [ ]   HCILL protocol support
                      [ ]   Three-wire UART (H5) protocol support
      <*>   RF switch subsystem support --->
</pre>}}
{| class="wikitable"
|+ Bluetooth subsystem support
|-
! Option
! Driver
! Description
|-
| RFCOMM protocol support || rfcomm || Enables [[Wikipedia:RFCOMM|RFCOMM]] support which is required for [[Wikipedia:OBEX|OBEX]] file transfers, dial-up networking and other Bluetooth applications.
|-
| RFCOMM TTY support || - || Enables [[terminal emulator]] connections over RFCOMM.
|-
| BNEP protocol support || bnep || Enables network support, e.g. the [[Wikipedia:Personal Area Network|PAN]] profile.
|-
| Multicast filter support || - || Enables multicast filter support.
|-
| Protocol filter support || - || Enables protocol filter support.
|-
| HIDP protocol support || hidp || Enables [[Bluetooth Input devices|input device]] support.
|-
| HCI USB driver || btusb || Enables USB device support.
|-
| HCI UART driver || hci_uart || Enables UART based PCMCIA and CF device support.
|}

=== Software ===
Bluetooth user space support is provided by {{Package|net-wireless/bluez}}. Portage has ebuilds for BlueZ 4 (deprecated) and BlueZ 5.

You can enable Bluetooth support system-wide by adding ''bluetooth'' to the USE variable.
{{File|/etc/portage/make.conf||<pre>
USE="bluetooth"
</pre>}}

If you require BlueZ 4 you can mask BlueZ 5 to prevent it from being installed.
{{File|/etc/portage/package.mask||<pre>
>=net-wireless/bluez-5
</pre>}}

If you enabled the ''bluetooth'' USE flag system-wide you will need to update your system. This action might install BlueZ, depending on the [[profile]] you are using and the packages you have installed.
{{Emerge
|@world
|params+=--changed-use --deep}}

Install BlueZ.
{{Emerge
|net-wireless/bluez
|params+=--noreplace}}

== Configuration ==

=== Permissions ===
If you have the ''acl'' USE flag enabled system-wide and are using [[ConsoleKit]] or [[systemd]], permissions for Bluetooth devices will be handled automatically.

An alternative is to add the user you want to be able to access Bluetooth devices to the ''plugdev'' group.
{{RootCmd|gpasswd -a ''user'' plugdev}}

== Starting ==
To start Bluetooth.
{{RootCmd|/etc/init.d/bluetooth start}}
To start Bluetooth at boot.
{{RootCmd|rc-update add bluetooth default}}

== Usage ==

=== Controller setup ===
* Display Bluetooth controller information.
{{RootCmd|hciconfig -a|output=<pre>
hci0:   Type: BR/EDR  Bus: USB
        BD Address: 00:02:72:2F:A9:33  ACL MTU: 1021:8  SCO MTU: 64:1
        UP RUNNING PSCAN 
        RX bytes:1166 acl:0 sco:0 events:43 errors:0
        TX bytes:960 acl:0 sco:0 commands:43 errors:0
        Features: 0xbf 0xfe 0xcf 0xfe 0xdb 0xff 0x7b 0x87
        Packet type: DM1 DM3 DM5 DH1 DH3 DH5 HV1 HV2 HV3 
        Link policy: RSWITCH SNIFF 
        Link mode: SLAVE ACCEPT 
        Name: 'BlueZ 5.21'
        Class: 0x000104
        Service Classes: Unspecified
        Device Class: Computer, Desktop workstation
        HCI Version: 4.0 (0x6)  Revision: 0x1000
        LMP Version: 4.0 (0x6)  Subversion: 0x220e
        Manufacturer: Broadcom Corporation (15)
</pre>}}
Where ''hci0'' is the name of the first controller and ''UP'' indicates that the controller is enabled.

* If <code>hciconfig</code> indicates that the controller is disabled  with ''DOWN'', you will need to enable the controller.
{{RootCmd|hciconfig hci0 up}}

* You may receive the following message when attempting to enable the controller.
{{RootCmd|hciconfig hci0 up|output=<pre>
Can't init device hci0: Operation not possible due to RF-kill
</pre>}}
In this case you will need to query the controllers [http://wireless.kernel.org/en/users/Documentation/rfkill rfkill] state with {{Package|net-wireless/rfkill}}.
{{RootCmd|rfkill list bluetooth|output=<pre>
0: hci0: Bluetooth
        Soft blocked: no
        Hard blocked: no
</pre>}}

* If <code>rfkill</code> indicates that the controller is blocked with ''Soft blocked: yes'', you will need to unblock the controller.
{{RootCmd|rfkill unblock bluetooth}}

* If <code>rfkill</code> indicates that the controller is blocked with ''Hard blocked: yes'', you will need to unblock the controller by physical switch or keyboard function key.

* If you need to use trusted Bluetooth devices before a graphical environment is up and running, you can use the following udev rule.
{{File|/etc/udev/rules.d/90-bluetooth.rules||<pre>
# enable the bluetooth controller
ACTION=="add", KERNEL=="hci0", RUN+="hciconfig hci0 up"
</pre>}}

=== Device pairing ===
Bluetooth devices need to be paired with a Bluetooth controller before they can be used. This is done by entering a PIN (or other code) on both devices via an interaction agent. Certain devices such as [[Bluetooth_Headset|headsets]] do not allow entering an arbitrary PIN. These devices use a static PIN, which is usually 0000, 9999 or 1234.

This article only covers device pairing with a command-line interaction agent. If you have a graphical desktop environment you can perform device paring with a graphical interaction agent. You can use {{Package|net-wireless/bluedevil}} for [[KDE]], {{Package|net-wireless/gnome-bluetooth}} for [[GNOME]] and {{Package|net-wireless/blueman}} for GTK+.

==== BlueZ 4 ====
Device paring is done with <code>simple-agent</code>, which requires that you enable the ''test-programs'' USE flag for {{Package|net-wireless/bluez}}.

* Put the device into pairing mode. This generally involves pressing a button or a combinations of buttons, usually for several seconds.

* Discover the device MAC address.
{{Cmd|hcitool scan|output=<pre>
Scanning ...
        00:1F:20:1D:1B:4B       Bluetooth Device
</pre>}}
Where ''00:1F:20:1D:1B:4B'' is the MAC address of your device.

* Pair with the device.
{{Cmd|simple-agent hci0 00:1F:20:1D:1B:4B|output=<pre>
RequestPinCode (/org/bluez/1664/hci0/dev_00_1F_20_1D_1B_4B)
Enter PIN Code: 0000
Release
New device (/org/bluez/1664/hci0/dev_00_1F_20_1D_1B_4B)
</pre>}}
Enter a PIN and press {{Key|Enter}}. Now enter the same PIN on your device.

* If you have a graphical interaction agent installed (BlueDevil, GNOME Bluetooth etc.), you may receive the following message when attempting to pair with the device.
{{Cmd|simple-agent hci0 00:1F:20:1D:1B:4B|output=<pre>
dbus.exceptions.DBusException: org.bluez.Error.AlreadyExists: Already Exists
</pre>}}
In this case you will need to stop or disable the graphical interaction agent and attempt to pair with the device again.

* Check the trust status of your device.
{{Cmd|bluez-test-device trusted 00:1F:20:1D:1B:4B|output=<pre>
0
</pre>}}
Where ''0'' is not trusted and ''1'' is trusted.

* Trust the device so it can connect automatically.
{{Cmd|bluez-test-device trusted 00:1F:20:1D:1B:4B yes}}

* Connect to the device. If the device is trusted you only need to do this once.
{{Cmd|bluez-test-input connect 00:1F:20:1D:1B:4B}}

* Your device is now paired.

==== BlueZ 5 ====
{{Note|If you have upgraded from BlueZ 4 you will need to pair any previously paired devices again.}}
Device paring is done with <code>bluetoothctl</code>, which is available with all {{Package|net-wireless/bluez}} installations.

* Start bluetoothctl.
{{Cmd|bluetoothctl}}

* List the available controllers.
{{Cmd|list|prompt=[bluetooth]#|color=blue}}

* Display information about a controller.
{{Cmd|show ''controller_mac_address''|prompt=[bluetooth]#|color=blue}}

* Set the default controller.
{{Cmd|select ''controller_mac_address''|prompt=[bluetooth]#|color=blue}}

* Power on the controller.
{{Cmd|power on|prompt=[bluetooth]#|color=blue}}

* Enable the agent and set it as default.
{{Cmd
|agent on
|default-agent
|prompt=[bluetooth]#|color=blue}}

* Set the controller as discoverable (temporarily for 3 minutes) and pairable.
{{Cmd
|discoverable on
|pairable on
|prompt=[bluetooth]#|color=blue}}

* Scan for devices.
{{Cmd|scan on|prompt=[bluetooth]#|color=blue}}

* Put the device into pairing mode.

* Discover the device MAC address.
{{Cmd|devices|prompt=[bluetooth]#|color=blue}}

* Pair with the device.
{{Cmd|pair ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* If requested enter the PIN code.
{{Cmd|PIN code: ####|prompt=[agent]|color=red}}

* Trust the device.
{{Cmd|trust ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* Connect to the device.
{{Cmd|connect ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* Display information about the device.
{{Cmd|info ''device_mac_address''|prompt=[bluetooth]#|color=blue}}

* Your device is now paired.
{{Cmd|quit|prompt=[bluetooth]#|color=blue}}

== See also ==
* [[Bluetooth Headset]]
* [[Bluetooth Input devices]]
* [[Bluetooth Network Aggregation Point]]
* [http://www.elstel.org/MobilePhone.html Bluetooth for Your Mobile Phone]

[[Category:Interfaces]]
