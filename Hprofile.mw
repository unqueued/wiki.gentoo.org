{{Package|sys-apps/hprofile}} is a little application that can be used to manage multiple profiles be it hardware or software. The following subsection are just examples on what could be done with hprofile.

To be able to to go further, one should, of course, merge the package.

{{Emerge|sys-apps/hprofile}}

== Switching VGA profile ==

Ii use {{Package|sys-apps/hprofile}} to manage VGA profile to my laptop and my desktop. On my desktop, I use hprofile to switch between nVidia ({{Package|x11-drivers/nvidia-drivers}}), nouveau ({{Package|x11-drivers/xf86-video-nouveau}}) and nv ({{Package|x11-drivers/xf86-video-nv}}) when the previous profiles do no work; and to switch ati ({{Package|x11-drivers/xf86-video-ati}}) and intel ({{Package|x11-drivers/xf86-video-intel}}) on my laptop which has switchable graphics via VGASwitcheroo. 

Just be sure to built kernel modules about everything — at least nouveau, ttm, drm, and optionally(?) ac, button, video, i2c-algo-bit — to avoid useless hassles.  

{{GenericCmd|<pre>--- /etc/init.d/hprofile	2011-07-26 15:26:56.000000000 +0000
+++ /etc/init.d/hprofile	2012-03-03 17:42:34.686258567 +0000
@@ -7,15 +7,19 @@
 }
 
 start() {
+	vgap=$(/usr/sbin/hpdet vga)
 	powerp=$(/usr/sbin/hpdet power)
 	ebegin "Selecting hardware profile vga.$vgap and power.$powerp"
+	/usr/sbin/hprofile vga 
 	/usr/sbin/hprofile power
 	eend $?
 }
 
 stop() {
+	vgap=$(/usr/sbin/hprofile -c vga)
 	powerp=$(/usr/sbin/hprofile -c power)
 	ebegin "Stopping hardware profile vga.$vgap and power.$powerp"
+	/usr/sbin/hprofile -s vga
 	/usr/sbin/hprofile -s power
 	eend $?
 }</pre>}}

Create the necessaries folder /etc/hprofile/profiles/vga/{scripts,files/etc/X11/xorg.conf.d} and add the following files.

{{Note|Of course, the necessary files should be added for the following profiles, only nouveau and nvidia files will be posted in this contribution.}}
{{File|/etc/hprofile/profiles/vga/profiles||<pre>
intel
radeon
nvidia
nv
nouveau
fglrx</pre>}}

{{Note|This is necessary because the console font will be bigger when a new driver or rofile is set/used.}}
{{File|/etc/hprofile/profiles/vga/post-start||<pre>
#!/bin/sh
echo "Finished starting profile ${1}"
/etc/init.d/consolefont restart
exit 0</pre>}}

{{File|/etc/hprofile/profiles/vga/stop||<pre>
#!/bin/sh
[ "${1}" == "intel" ] || [ "${1}" == "radeon" ] && \
    echo ON > /sys/kernel/debug/vgaswitcheroo/switch
echo "Finished Stopping profile ${1} and moving back xorg.conf"</pre>}}

{{Note|If a specific kernel module is loaded with an initramfs or modules init services, the appropriate profile will be selected with the following script.}}
{{File|/etc/hprofile/profiles/vga/ptest||<pre>
if [  ! -e /sys/kernel/debug/vgaswitcheroo/switch ]; then
    [ -z "$(lsmod | grep -i radeon)" ] && modprobe radeon && sleep 3
    [ -z "$(lsmod | grep -i i915)" ] && modprobe i915 && sleep 3
fi
[ $(grep DIS:+ /sys/kernel/debug/vgaswitcheroo/switch) ] && echo "radeon" && exit 0
[ $(grep IGD:+ /sys/kernel/debug/vgaswitcheroo/switch) ] && echo "intel" && exit 0
for drv in nouveau nvidia radeon i9{1,6}5 fglrx; do
[ -n "$(lspci -k | grep "Kernel driver in use: $drv")" ] && echo "$drv" && exit 0 
done
echo "invalid" && exit 1</pre>}}

{{File|/etc/hprofile/profiles/vga/scripts/nouveau.start||<pre>
#!/bin/sh
echo "Starting nouveau profile."
modprobe nouveau || echo "failed to load nouveau module."
[ "$(eselect opengl show)" != "xorg-x11" ] && eselect opengl set xorg-x11
exit 0</pre>}}
{{File|/etc/hprofile/profiles/vga/scripts/nouveau.stop||<pre>
#!/bin/sh
echo "Stopping nouveau profile."
echo 0 > /sys/class/vtconsole/vtcon1/bind
rmmod nouveau || echo "failed to remove nouveau module." && exit 1
/etc/init.d/consolefont restart
rmmod ttm
rmmod drm_kms_helper
rmmod dri</pre>}}

{{File|/etc/hprofile/profiles/vga/scripts/nvidia.start||<pre>
#!/bin/sh
echo "Starting nvidia profile."
modprobe nvidia || echo "failed to load nvidia module." && exit 1
[ "$(eselect opengl show)" != "nvidia" ] && eselect opengl set nvidia</pre>}}
{{File|/etc/hprofile/profiles/vga/scripts/nvidia.stop||<pre>
#!/bin/sh
echo "Stopping nvidia profile."
rmmod nvidia || echo "failed to remove nvidia module." && exit 1</pre>}}

{{File|/etc/hprofile/profiles/vga/files/etc/X11/xorg.conf.d/40-monitor.conf.nouveau||<pre>
Section "Monitor"
    Identifier  "DFP-0"
    VendorName  "DELL"
    ModelName   "2000WFP"
    Option      "PreferredMode" "1680x1050"
EndSection

Section "Device"
    Option      "EXAVsync"  "True"
    Option      "GLXVBlank" "True"
    Identifier  "8800GT"
    Driver      "nouveau"
    BusID       "PCI:1:0:0"
EndSection

Section "Screen"
    Identifier "NOUVEAU"
    Device     "8800GT"
    Monitor    "DFP-0"
    SubSection "Display"
        Viewport  0 0
        Depth     24
    EndSubSection
EndSection</pre>}}
{{File|/etc/hprofile/profiles/vga/files/etc/X11/xorg.conf.d/40-monitor.conf.nvidia||<pre>
Section "Monitor"
    Identifier "DFP-0"
    VendorName "DELL"
    ModelName  "2000WFP"
    Option     "PreferredMode" "1680x1050"
EndSection

Section "Device"
    Option     "AddARGBGLXVisuals"  "on"
    Option     "NoLogo"
    Identifier "8800GT"
    Driver     "nvidia"
    BusID      "PCI:1:0:0"
EndSection

Section "Screen"
    Identifier "NVIDIA"
    Device     "8800GT"
    Monitor    "DFP-0"
    SubSection "Display"
        Viewport  0 0
        Depth     24
    EndSubSection
EndSection</pre>}}

And with that, you should be able to switch vga profile as you like without needing an extra kernel and setup.

The ptest script will just look if VGASwitcheroo is available and hich driver is loaded and thenn start the appropriate profile. One can use of black listing a module and leave the other un-black listed to be able to chose ...a default VGA profile. Or else, use of `/etc/hprofile/profiles/vga/default'.

{{File|/etc/hprofile/profiles/vga/default||intel}}

== Switching disk profile ==

A disk profile is even forward because there fewer issue to keep in mind. So this section will be short and straightforward. Additional, one need {{Package|sys-apps/hdparm}}.

{{File|/etc/hprofile/profiles/disk/default||adp}}
{{File|/etc/hprofile/profiles/disk/post-start||<pre>
#!/bin/sh
for dev in $(ls -d /sys/devices/pci*/*/ata*/host*/target*/*/block/sd[a-z] 2>/dev/null); do
    echo cfq > /sys/block/${dev##*/}/queue/scheduler
    echo 0 > /sys/block/${dev##*/}/queue/iosched/slice_idle
    echo 64 > /sys/block/${dev##*/}/queue/iosched/quantum
    # more opitmizations with ncq
    echo 1024 > /sys/block/${dev##*/}/queue/nr_requests
    echo 2 > /sys/block/${dev##*/}/device/queue_depth
done
for dev in $(ls -d /sys/devices/pci*/*/usb*/*/*/host*/target*/*/block/sd[a-z] 2>/dev/null)
do echo noop > /sys/block/${dev##*/}/queue/scheduler; done</pre>}}
{{File|/etc/hprofile/profiles/disk/ptest||<pre>
#!/bin/sh
[ -e /etc/runlevels/battery ] &&
    [ "$(rc-status --nocolor|sed -ne 's/^Runlevel://p')" = "battery" ] &&
    echo "bat" || echo "adp"
exit</pre>}}
{{File|/etc/hprofil/profiles/disk/profiles||<pre>
bat
adp
fast
quiet</pre>}}
{{File|/etc/hprofile/profiles/disk/stop||<pre>#!/bin/sh
# put extra action here if need be</pre>}}

{{File|/etc/hprofile/profiles/disk/scripts/adp.start||<pre>#!/bin/sh
hdparm -q -S120 -B230 -M254 /dev/sd[a-z]</pre>}}
{{File|/etc/hprofile/profiles/disk/scripts/bat.start||<pre>#!/bin/sh
hdparm -q -S120 -B210 -M230 /dev/sd[a-z]</pre>}}
{{File|/etc/hprofile/profiles/disk/scripts/fast.start||<pre>#!/bin/sh
hdparm -q -S180 -B254 -M254 /dev/sd[a-z]</pre>}}
{{File|/etc/hprofile/profiles/disk/scripts/quiet.start||<pre>#!/bin/sh
hdparm -q -S120 -B200 -M200 /dev/sd[a-z]</pre>}}

[[category:Desktop]]
