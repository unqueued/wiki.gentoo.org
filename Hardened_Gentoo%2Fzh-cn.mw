<languages />
"Gentoo Hardened" 是一个 Gentoo 项目，它在现有 Gentoo Linux 安装上提供了多种额外的安全服务。虽然这些服务可以分别单独使用，但是 "Gentoo Hardened"  打开了工具链 (Toolchain) 中几个可以降低被攻击风险的选项，支持 PaX, grSecurity, SELinux, TPE 等等功能。

无论你是运行一台面向互联网的服务器还是一台灵活的工作站，当你面对多种威胁的时候你会更愿意加固你的系统，而不是仅仅自动升级最新的安全补丁。 ''加固(Hardening)'' 系统意味着你会采取额外的措施来应对攻击和其他风险，这些措施通常是在系统上执行的一系列活动的组合。

"Gentoo Hardened" 中的几个项目都很活跃，这些项目可以帮助你进一步加固你的 Gentoo 系统，通过：
* 启用工具链（编译器，连接器 ...）中的特定选项，如：“强制生成位置无关的可执行文件（PIE, position-independent executables）”、“堆栈溢出保护”和“编译时缓冲区检查”。
* 启用 Linux 内核的 PaX 扩展，它提供了象“地址空间布局随机化”和“非执行内存”这样的额外保护措施。
* 启用 Linux 内核的 grSecurity 扩展，包括“额外的 chroot 限制”、“额外的审计”、“进程限制”等等...
* 启用 Linux 内核的 [[Hardened Gentoo/SELinux|SELinux]] 扩展，它提供了一个强制性访问控制系统来增强标准 Linux 的权限限制。
* 启用系统完整性（[[Integrity]]）保障相关的技术，如“完整性检测体系（IMA, Integrity Measurement Architecture）”，可以让系统在防篡改方面更灵活。

当然，这还包括了必要的用户工具来管理这些扩展。

== 切换到“Hardened Profile" ==

选择一个“hardened [[profile]]”, 这样包管理将会以“加固模式”来运行。

{{RootCmd|eselect profile list}}
{{RootCmd|eselect profile set ["hardened profile"的编号]}}
{{RootCmd|source /etc/profile}}

By choosing the hardened profile, certain package management settings (masks, USE flags, etc) become default for your system.  This applies to many packages, including the toolchain.  The toolchain is used for building/compiling your programs, and includes: the GNU Compiler Collection (GCC), binutils (linker, etc.), and the GNU C library (glibc).  By re-emerging the toolchain, these new default settings will apply to the toolchain, which will allow all future ''package compiling'' to be  done in a hardened way.

{{emerge|params=--oneshot|gcc}}
{{emerge|params=--oneshot|binutils virtual/libc}}

The above commands rebuilt GCC, which can now be used to compile hardened software.  Make sure that the hardened option is selected for GCC.

{{RootCmd|gcc-config -l
|output=<pre>
[1] i686-pc-linux-gnu-4.5.3 *
[2] i686-pc-linux-gnu-4.5.3-hardenednopie
[3] i686-pc-linux-gnu-4.5.3-hardenednopiessp
[4] i686-pc-linux-gnu-4.5.3-hardenednossp
[5] i686-pc-linux-gnu-4.5.3-vanilla
</pre>}}

In the example output above, the hardened GCC profile is the one without a suffix. If you want to disable PIE or SSP, choose the relevant '''hardenedno'''('''pie'''|'''ssp''') or both, '''hardenednopiessp'''. The '''vanilla''' profile is of course the one with hardening disabled. Finally source your new profile settings:

{{RootCmd|source /etc/profile}}

If you use the "prelink" package, remove it, since it isn't compatible with the hardened profile:

{{emerge|params=--depclean|prelink}}

Now you can reinstall all packages with your new hardened toolchain:

{{emerge|params=--emptytree --verbose|@world}}

Install hardened kernel sources, so that the kernel will *manage your running system* in a hardened way (especially using PaX):

{{emerge|hardened-sources}}

Now configure/compile the sources and add the new kernel to your boot manager (ie., GRUB).

== Tips & Tricks ==

=== Hardened Gentoo/Grsecurity chroot ===

If you want to chroot to a copied environment where the CONFIG_GRKERNSEC_CHROOT is enabled you must use the cd grub and change the root(cd) kernel(cd) initrd(cd) setting to from (cd) to (hdx,y).

Now you can install the grub environment.

=== Per Package Hardening Settings ===

{{Warning|This method is not supported by Gentoo.}}

Changing the GCC profile to deal with specific packages can be a pain. A way to avoid this is to set per-package C(XX)FLAGS using [[:/etc/portage/env|package.env]]. Create the file {{Path|/etc/portage/env/nossp}} and add to that:

{{FileBox|filename=/etc/portage/env/nossp|title=Disable SSP|lang=bash|1=
CFLAGS="${CFLAGS} -fno-stack-protector"
CXXFLAGS="${CXXFLAGS} -fno-stack-protector"
}}

To allow for disabling PIE, create and add to {{Path|/etc/portage/env/nopie}}:

{{FileBox|filename=/etc/portage/env/nopie|title=Disable PIE|lang=bash|1=
CFLAGS="${CFLAGS} -nopie"
CXXFLAGS="${CXXFLAGS} -nopie"
LDFLAGS="${LDFLAGS} -nopie"
}}

Finally add the package you want to disable either PIE or SSP for to {{Path|/etc/portage/package.env}} and the relevant {{Path|/etc/portage/env/<filename>}}, for this example {{Package|sys-libs/zlib}} is used here:

{{FileBox|filename=/etc/portage/package.env|title=Disable PIE for sys-libs/zlib|1=
sys-libs/zlib nopie
}}

== See also ==

For more information, check out the following resources:
* [[Project:Hardened|Gentoo Hardened Project]]
* [[Project:SELinux|Gentoo Hardened SELinux Project]]
* [[Project:Hardened/Grsecurity2_Quickstart]]
* [[Project:Hardened/PaX_Quickstart]]

== External resources ==

* http://www.rockfloat.com/howto/gentoo-hardened.html#kernel


[[Category:Security]]
