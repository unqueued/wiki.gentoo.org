<languages />


{{Metadata|abstract=O objetivo deste guia é fornecer aos leitores uma migração suave do GRUB Legacy para o GRUB2.}}

O objetivo deste guia é fornecer aos leitores uma migração suave do GRUB Legacy para o GRUB2.

== Background ==

=== O que é GRUB? ===

GRUB é um dos inicializadores em uso mais comumente encontrados em máquinas Linux não embarcadas. O papel do GRUB é facilitar o kernel Linux a ser carregado do disco para a memória e iniciar a execução do kernel Linux. 

=== Por que migrar? ===

Em primeiro lugar, o GRUB Legacy não é mais mantido e, como tal, não recebe mais atualizações. O GRUB Legacy foi criado num momento em que os desenvolvedores se sentiam seguros em fazer diversas suposições que já não são mais verdade hoje. Por exemplo, o GRUB Legacy é incapaz de inicializar a partir de discos maiores que 2 TB e assume que os novos sistemas de arquivos não viriam para substituir o {{Path|/boot}}. 

O GRUB2 pretende ser mais robusto, mais portável, mais poderoso e é mantido com uma base de código mais limpa. GRUB2 suporta mais configurações de hardware, mais sistemas de arquivos e mais layouts de unidades do que seu predecessor. 

== Migração para o GRUB2 ==

A migração para o GRUB2 é bastante simples: ele será puxado como parte do processo de atualização periódica pelo gerenciador de pacotes. Se ele não for puxado automaticamente, ele sempre poderá ser instalado via pacote atom <code>sys-boot/grub:2</code>:

{{Emerge|sys-boot/grub:2}}

=== Drive de boot ===

A primeira parte importante é entender qual drive é inicializável. Para aqueles que seguiram o Manual do Gentoo ele deve ser o {{Path|/dev/sda}}. Para aqueles que são incertos, a maneira mais fácil de descobrir é olhar a configuração existente do GRUB Legacy. O arquivo {{Path|/boot/grub/grub.conf}} é o principal lugar para verificar. 

{{Note|Certifique-se que a partição {{Path|/boot}} está montada para ser capaz de ver estes arquivos. Deve ser tão simples como
{{RootCmd|mount /boot}}
}}

O arquivo {{Path|grub.conf}} será algo parecido com isto:

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

Com base no arquivo acima é possível saber que <code>(hd0)</code> é o drive de boot mas precisamos mapeá-lo para um dispositivo real. Para saber isto, veja no arquivo {{Path|/boot/grub/device.map}}. Um exemplo é fornecido um abaixo: 

{{FileBox|filename=/boot/grub/device.map|1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note|Quando suspeitar que o {{Path|/boot/grub/device.map}} não é exato, rode {{c|grub-install --recheck /dev/sda}} para recriar o arquivo.}}

Com base no arquivo acima sabemos que {{Path|/dev/sda}} é o drive de boot.

=== Instalando e configurando o GRUB2 ===

O próximo passo é instalar e configurar o GRUB2 para a partição {{Path|/boot}} sem remover o GRUB Legacy do drive de MBR. O exemplo abaixo usa o {{Path|/dev/sda}} - substitua-o com o drive de boot correto. O primeiro passo instala os arquivos do GRUB2 necessários para {{Path|/boot/grub}}, enquanto que o segundo passo examina os kernels disponíveis e gera um arquivo de configuração adequado para {{Path|/boot/grub/grub.cfg}}. Ignore a segunda etapa quando usar uma [[GRUB2_Quick_Start#Manual_configuration|Configuração manual]].

{{Warning|GRUB 2 usa o arquivo de configuração {{Path|/boot/grub/grub.'''cfg'''}} enquanto que o GRUB Legacy usa {{Path|/boot/grub/grub.'''conf'''}} assim, por favor, certifique-se de não usar o arquivo antigo por engano, por exemplo, usando tab-completion se o arquivo antigo ainda estiver lá.}}

{{RootCmd|grub2-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Note|<code>grub2-mkconfig</code> tem requisitos estritos de nomenclatura para kernels e imagens de initramfs. Um kernel deve ser nomeado como <code>kernel-${version}</code> ou <code>vmlinuz-${version}</code> enquanto que um initramfs deve ser nomeado como <code>initramfs-${version}.img</code>, <code>initramfs-genkernel-${version}</code>, <code>initramfs-genkernel-${arch}-${version}</code>, <code>initrd-${version}.img</code>, <code>initrd.img-${version}</code>, <code>initrd-${version}.gz</code>, ou <code>initrd-${version}</code>. Junto com ${version}, o nome do arquivo deve combinar com um correspondente ao kernel que está disponível em {{Path|/boot}}.}}

{{Note|The file {{Path|/etc/default/grub}} controla a operação de <code>grub2-mkconfig</code>. Se parâmetros precisam ser passados para o Kernel (por exemplo, quando usar o genkernel e inicializar a partir de LVM ou software RAID), edite o arquivo antes de gerar o {{Path|/boot/grub/grub.cfg}} assim:
{{RootCmd|nano /etc/default/grub}}
Dê uma olhada em [[GRUB2#Configuration|Configuração do GRUB2]] na Wiki do Gentoo ou em [http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html grub2 manual] para decidir como modificar o arquivo. A maioria dos usuários terá de modificar o parâmetro <code>GRUB_CMDLINE_LINUX</code>.}}

=== Chainloading GRUB2 from GRUB Legacy to test the setup ===

Because a broken GRUB configuration could mean an unbootable system, we want to test our GRUB2 configuration before making it permanent. To do this we will chainload GRUB2 from GRUB Legacy. This is done by adding a new section into {{Path|/boot/grub/grub.conf}}. An example is shown below. 

{{Note|Be aware that the root partition may be different from <code>(hd0,0)</code> used in the example, and make sure to reuse the same root value from the {{Path|/boot/grub/grub.conf}} configuration file.}}

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

At this point the machine should be rebooted, and <code>GRUB2 Chainload</code> selected from the GRUB menu when the machine begins to boot. Another GRUB menu will be presented which should advertise itself as GRUB 2.0.0 or higher at the top and show the available kernel(s) to boot. Should this not work, simply reboot the system and pick the normal boot option instead of <code>GRUB2 Chainload</code>. 

=== Replacing and removing GRUB Legacy ===

At this point, if everything worked successfully, replace GRUB Legacy and remove it from the system. 

{{Warning|Since the system has been rebooted, it might be necessary to mount {{Path|/boot}} again. Make sure to use the right boot drive path instead of {{Path|/dev/sda}} as this is merely an example. If {{Path|/boot}} is not mounted before running {{c|grub2-install}}, the system will become unbootable}}

{{RootCmd|grub2-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

At this point use the package manager to remove <code>sys-boot/grub:0</code>. 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

The migration is now complete.

== Maintaining GRUB2 ==

Whenever a new kernel is installed, perform the next step so that the GRUB2 configuration recognizes the new kernel (except when using a [[GRUB2_Quick_Start#Manual_configuration|manual configuration]]). 

{{Note|Make sure the {{Path|/boot}} partition is mounted for this step.}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
