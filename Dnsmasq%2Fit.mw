<languages />

{{Metadata|abstract=Dnsmasq è un server DHCP/DNS leggero per reti di piccole e medie dimensioni.}}

{{InfoBox stack
|{{InfoBox homepage|http://www.thekelleys.org.uk/dnsmasq/doc.html|header=true}}
|{{InfoBox wikipedia|Dnsmasq|header=true}}
}}

[http://thekelleys.org.uk/dnsmasq/doc.html Dnsmasq] è un semplice server DHCP/DNS che può essere utilizzato per reti locali fino a 1000 client. Le sue features chiave sono facilità di configurazione ed un basso impiego di risorse. Supporta anche IPv6.

== Installazione ==

L'installazione di dnsmasq è pienamente supportata dal gestore di pacchetti e dall'albero dei portage. Come prima cosa, selezionare le flag USE appropriate.

{{USEflag|package=net-dns/dnsmasq
|dbus
|dhcp
|ipv6
|auth-dns
|conntrack
|dhcp-tools
|idn
|lua
|script
|tftp
}}

Poi, installare {{Package|net-dns/dnsmasq}} ed aggiungerlo al runlevel default nel caso sia necessario avviarlo automaticamente.

{{Emerge|net-dns/dnsmasq}}

{{RootCmd|/etc/init.d/dnsmasq start
|rc-update add dnsmasq default}}

== Configurazione ==

Ci sono molteplici risorse che possono essere modificare il comportamento di dnsmasq. Queste includono
* le opzioni a riga di comando passate attraverso {{Path|/etc/conf.d/dnsmasq}}
* il file di configurazione principale ({{Path|/etc/dnsmasq.conf}})

=== Configurazione del servizio ===

In {{Path|/etc/conf.d/dnsmasq}} possono essere configurate le opzioni a riga di comando passate al demone dnsmasq in fase di avvio.

{{File|/etc/conf.d/dnsmasq|Example dnsmasq service configuration|<pre>
DNSMASQ_OPTS="--user=dnsmasq --group=dnsmasq -H /srv/virt/gentoo/hosts --max-cache-ttl=10"
</pre>}}

=== File di configurazione principale ===

La configurazione di dnsmasq viene effettuata principalmente attraverso il suo file di configurazione, {{Path|/etc/dnsmasq.conf}}. Il file ha una sintassi <code>chiave[=valore]</code>, quello fornito dal pacchetto è ben documentato ed è raccomandata la sua lettura. E'possibile referenziare risorse aggiuntive (come un hosts file DHCP) nel file o attraverso le opzioni a riga di comando.

Di seguito un esempio di configurazione:

{{File|/etc/dnsmasq.conf||<pre>
# Listen only to this interface
interface=eth1
  
# Assign names based on mac adress
dhcp-host=00:1e:68:c2:ff:ee,endor,192.168.0.54,24h
  
# Any other DHCP request gets an ip from this range
dhcp-range=eth1,192.168.0.100,192.168.0.120,12h
  
# Enable the TFTP server and set the root directory for files available via TFTP.
enable-tftp
tftp-root=/var/lib/tftpboot
dhcp-boot=/pxelinux.0
</pre>}}

Dopo ogni modifica al fiole di configurazione, il servizio deve essere riavviato. Il reloading è supportato, ma per altre risorse.

{{RootCmd|/etc/init.d/dnsmasq restart}}

=== Hosts file ===

Dnsmasq utilizza il file {{Path|/etc/hosts}} come una delle sorgenti per fornire il servizio DNS, a meno che non sia avviato con l'opzione <code>-h</code> (<code>--no-hosts</code>)

Se il file {{Path|/etc/hosts}} viene modificato, il servizio dnsmasq deve ricevere un SIGHUP per ricaricare le impostazioni. Questo è fattibile anche utilizzando lo script di init con il comando ''reload'':

{{RootCmd|/etc/init.d/dnsmasq reload}}

Questo comportamento può essere disabilitato anche introducendo il parametro <code>no-hosts</code> nel file di configurazione.

=== File hosts aggiuntivo ===

E'possibile far riferimento ad un file hosts (aggiuntivo) come sorgente per le query DNS. Per fare ciò, aggiungere l'opzione <code>-H /path/al/filehosts</code> (<code>--addn-hosts=/path/al/filehosts</code>) ai parametri a riga di comando. Indicando una directory, tutti i file al suo interno saranno trattati come file hosts aggiuntivi.

Come per il file hosts standard, un segnale SIGHUP ricarica il file.

Questo comportamento può essere impostato con il parametro <code>addn-hosts</code> nel file di configurazione

=== Server DNS upstream ===

Per default, dnsmasq utilizza i server indicati in {{Path|/etc/resolv.conf}} come server DNS upstream.

Un file differente può essere indicato con l'opzione <code>-r</code> (<code>--resolv-file</code>)

Questo comportamento può essere impostato con il parametro <code>resolv-file</code> nel file di configurazione

== Features ==

Dnsmasq supporta i servizi DNS, TFTP, PXE, router advertisements e DHCP services. Per questo, è uno strumento di gestione versatile per reti di piccole e medie dimensioni.

=== Servizi DNS ===

In order to (only) provide DNS services, first identify the ''upstream nameserver'' to use. If this is the same nameserver as specified in {{Path|/etc/resolv.conf}} then no additional steps need to be taken. Otherwise, point dnsmasq to the proper {{Path|resolv.conf}} file through the <code>-r</code> (<code>--resolv-file</code>) command line. Its syntax is the one used by the {{Path|/etc/resolv.conf}} file, although dnsmasq only looks at the ''nameserver'' definitions.

For instance:

{{RootCmd|echo "nameserver 8.8.8.8" >> /etc/dnsmasq.conf.resolv}}

Next point dnsmasq to this file through the configuration file:

{{File|/etc/dnsmasq.conf|Configuring a custom resolv file|<pre>
resolv-file=/etc/dnsmasq.conf.resolv
</pre>}}

To verify that the service is running (after restarting as the configuration file has just been changed), use the <code>dig</code> command (provided through {{Package|net-dns/bind-tools}}), asking the DNS server (running on localhost in the following example) to resolve a local or remote address:

{{Cmd|dig @localhost +short www.gentoo.org|output=<pre>
www-bytemark-v4v6.gentoo.org.
89.16.167.134
</pre>}}

=== DHCP services ===

In order to enable the DHCP services of dnsmasq, use the <code>dhcp-range</code> configuration setting.

For instance, to enable IPv6 address configuration through RA with infinite lease time, and IPv4 address configuration also with infinite lease time:

{{File|/etc/dnsmasq.conf|Enabling IPv6 and IPv4 leases|<pre>
dhcp-range=2001:db8:81:e2::,ra-only,infinite
dhcp-range=192.168.100.100,192.168.100.149,infinite
</pre>}}

It is possible to use static definitions for known hosts, either through the main configuration file (<code>dhcp-host=</code> settings) or through a separate file. If a separate file is used, point dnsmasq to it through the <code>--dhcp-hostsfile</code> command line option. The advantage of the latter approach is that it is sufficient to send a SIGHUP signal (or reload the service) in order to reread the entries, whereas definitions in the configuration file require a full service restart.

For more information about the syntax of the <code>dhcp-host</code> parameter please refer to the manual page or configuration file as its syntax is very extensive.

== Usage ==

This section covers various usage scenarios (maintenance and operational tasks) for the dnsmasq service.

=== Resetting leases ===

Clients that had a network interface update which results in a different MAC address might not get the intended IP address immediately. This is because the dnsmasq service has provided this IP address to the old MAC address, and will wait until the lease of this address has expired before re-assigning it.

The dnsmasq service stores its leases in {{Path|/var/lib/misc/dnsmasq.leases}}. If the lease needs to be removed faster, shut down the dnsmasq service, remove the lease from the {{Path|dnsmasq.leases}} file and start the service again.

{{RootCmd|/etc/init.d/dnsmasq stop
|nano -w /var/lib/misc/dnsmasq.leases
|/etc/init.d/dnsmasq start}}

=== Reloading non-main configuration settings ===

Next to the {{Path|dnsmasq.conf}} file, the dnsmasq service can use external definitions for the following services:
* DHCP host configuration entries (through <code>--dhcp-hostsfile</code> command line option)
* DHCP options (through <code>--dhcp-optsfile</code> command line option)

When these files are modified, a SIGHUP signal has dnsmasq reload these configuration files.

{{Note|The {{Path|resolv.conf}} files are by default polled by dnsmasq; changes on these files are automatically picked up unless the <code>-n</code> (<code>--no-poll</code>) command line option is set or the <code>no-poll</code> configuration parameter is used.}}


[[Category:Software]]
