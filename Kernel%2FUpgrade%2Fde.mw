<languages />

{{Metadata|abstract=Dieser Artikel beschreibt die Schritte, auf einen neuen Kernel zu aktualisieren.}}

Dieser Artikel beschreibt die Schritte, um auf einen neuen [[Special:MyLanguage/Kernel|Kernel]] zu aktualisieren.

== Installation und Nutzung eines neuen Kernel ==

A kernel upgrade may be a good idea when new kernel sources are installed. New kernel sources are sometimes installed while updating the system by running {{c|emerge -a --update --deep --with-bdeps{{=}}y --newuse @world}}, or of course when installed directly.

Die bloße Installation neuer Kernel Sourcen liefert dem Nutzer keinen neuen Kernel. Es ist darüber hinaus erforderlich einen neuen Kernel auf Grundlage der neuen Sourcen zu bauen (make), zu installieren (install) und anschließend das System neu zu starten, um wirklich den neuen Kernel zu verwenden.

Making a new kernel from the new sources is basically the same process as making a kernel when installing the system. The difference is that one can use the configuration of the old kernel to create a configuration for the new kernel. Using the old configuration saves the user from going through all the kernel options (like {{c|make menuconfig}}) again.

Die Konfiguration des Kernel wird in einer Datei mit dem Namen {{Path|.config}} im Verzeichnis zusammen mit den Kernel Sourcen gespeichert. Ein neuer Kernel kann Optionen oder Eigenschaften besitzen die der alte Kernel noch nicht hat, oder er kann eine Eigenschaft oder Option nicht mehr haben die der alte Kernel immer noch hat. Die Kernel-Konfiguration gibt an, ob die Eigenschaften und Optionen eines Kernel zu aktiviert sind oder nicht. Vielleicht integriert im Kernel oder als Module gebaut, die auf Verlangen in den laufenden Kernel geladen werden können. Daher kann die Konfigurationsdatei des neuen Kernel neue Einträge besitzen, die die alte nicht hatte und sie könnte andere Einträge nicht mehr haben, die in der Konfiguration des alten Kernel vorhanden sind.

Um mit solchen Änderungen der Konfigurationsdatei umzugehen, muss die Konfigurationsdatei des alten Kernel in eine Konfiguration umgewandelt werden, die mit dem neuen Kernel verwendet werden kann. Dieser Artikel zeigt, wie man mit der Umwandlung der Konfigurationsdatei des alten Kernel aus neuen Kernel Sourcen einen neuen Kernel erzeugt.

== Backup der aktuellen Kernel-Konfiguration ==

Es ist klug eine Sicherung der Kernel-Konfiguration zu erstellen, so dass die vorigen Konfiguration nicht verloren sind. Immerhin verwenden viele Nutzer beträchtlich Zeit um die beste Konfiguration für ein System herauszufinden. Diese Information zu verlieren ist sicherlich nicht erwünscht.

Es ist leicht eine Sicherung der aktuellen Kernel-Konfiguration zu erstellen:

{{RootCmd|cd /usr/src/linux
|cp .config ~/kernel-config-`uname -r`|}}

Vorausgesetzt dass der Symlink zu den Kernelquellen korrekt gesetzt ist, kopiert dies die Konfiguration des aktuell verwendeten Kernel in das Heimatverzeichnis von Root. Außerdem benennt es die Konfiguration in {{Path|kernel-config-}} gefolgt von der Version des aktuell laufenden Linux Kernel um.

== Einen Symlink auf die neuen Kernelquellen setzen ==

Der Symlink {{Path|/usr/src/linux}} sollte immer auf das Verzeichnis zeigen das die Kernelquellen des aktuell laufenden Kernel enthält. Dies kann auf eine von drei Arten erfolgen:

# Installation der Kernelquellen mit <code>USE="symlink"</code>
# Setzen des Links mit eselect
# Manuell den symbolischen Link aktualisieren

=== Installation der Kernelquellen mit dem symlink USE-Flag ===

Dies führt dazu, dass {{Path|/usr/src/linux}} auf die neu installierten Kernelquellen zeigt.

Falls nötig, kann dies später immer noch mit einer der beiden anderen Methoden geändert werden.

=== Den Link mit eselect setzten ===

To set the symlink with {{c|eselect}}:

{{RootCmd|eselect kernel list|output=<pre>
Available kernel symlink targets:
 [1] linux-3.14.14-gentoo *
 [2] linux-3.16.3-gentoo
</pre>}}

Dies gibt die verfügbaren Kernelquellen aus. Der Stern kennzeichnet die ausgewählten Quellen.

Um die Kernelquellen beispielsweise auf den zweiten Eintrag zu ändern, führen Sie folgendes aus:

{{RootCmd|eselect kernel set 2}}

=== Manuell den symbolischen Link aktualisieren ===

Um den symbolischen Link manuell zu setzten:

{{RootCmd|ln -sf /usr/src/linux-3.16.3 /usr/src/linux
|ls -l /usr/src/linux|output=<pre>
lrwxrwxrwx 1 root root 19 Oct  4 10:21 /usr/src/linux -> linux-3.16.3-gentoo
</pre>}}

== Kopieren der vorigen Kernel-Konfiguration ==

Die Konfiguration des alten Kernel muss zum neuen kopiert werden. Sie kann an mehreren Orten gefunden werden:

* Im [[Special:MyLanguage/procfs|procfs]] Dateisystem, falls die Kernel Option ''Enable access to .config through /proc/config.gz'' im aktuellen Kernel aktiviert worden ist:
: {{RootCmd|zcat /proc/config.gz > /usr/src/linux/.config}}

* In the {{Path|/boot}} directory, if the configuration was installed there:
: {{RootCmd|cp /boot/config-3.14.14-gentoo /usr/src/linux/.config}}

* Im Kernelverzeichnis des aktuell laufenden Kernels:
: {{RootCmd|cp /usr/src/linux-3.14.14-gentoo/.config /usr/src/linux/}}

* In the {{Path|/etc/kernels/}} directory, if <code>SAVE_CONFIG="yes"</code> is set in {{Path|/etc/genkernel.conf}} and {{c|[[genkernel]]}} was previously used:
: {{RootCmd|cp /etc/kernels/kernel-config-x86_64-3.14.14-gentoo /usr/src/linux/.config}}

== Konfigurieren des neuen Kernel ==

To use the configuration of the old kernel with the new kernel, it needs to be converted.  The conversion can be done by running either {{c|make silentoldconfig}} or {{c|make olddefconfig}}. Use either, not both.

=== make silentoldconfig ===

The following configuration is like the text based configuration with {{c|make config}}.  For new configuration options, the user is asked for a decision. For example:

{{RootCmd|cd /usr/src/linux
|make silentoldconfig|output=<pre>
Anticipatory I/O scheduler (IOSCHED_AS) [Y/n/m/?] (NEW)
</pre>}}

The string ''(NEW)'' at the end of the line marks this option as new. Left to the string in square brackets are the possible answers: ''Y''es, ''n''o, ''m''odule or ''?'' to show the help. The recommend (i.e. default) answer is capitalized (here ''Y''). The help explains the option or driver.

Unfortunately {{c|make silentoldconfig}} doesn't show - next to the help - a lot more information for each option, like the context, so that it is sometimes difficult to give the right answer. In this case the best way to go is to remember the option name and revise it afterwards through one of the [[Kernel/Configuration#Configuration tools|graphical kernel configuration tools]].

=== make olddefconfig ===

If all new configuration options should be set to their recommended (i.e. default) values use {{c|make olddefconfig}}:

{{RootCmd|cd /usr/src/linux
|make olddefconfig}}

=== make help ===

Use {{c|make help}} to see other conversion methods available:

{{RootCmd|make help}}

== Kompilieren ==

{{Important|When external kernel modules are installed (like nvidia or zfs), it may be necessary to run {{c|make modules_prepare}} as described [[Kernel/Upgrade#Reinstall external kernel modules|below]] before building the kernel. Some modules cannot be installed or prepared before the kernel has been built.}}

{{Important|Vergessen Sie nicht den [[Special:MyLanguage/Bootloader|Bootloader]] für die neuen Kernel-Dateinamen zu konfigurieren und ebenfalls die initramfs neu zu bauen, falls eine verwendet wird.}}

Für diesen Schritt folgen Sie wieder den Erläuterungen im Artikel zur [[Special:MyLanguage/Kernel/Configuration#Kompilieren|manuellen Einrichtung des Kernel]].

== Externe Kernelmodule erneut installieren ==

Alle externen Kernelmodule, wie die [[:Category:Binary kernel modules|binäre Kernel Module]], müssen für jeden neuen Kernel erneut installiert werden. Falls der neue Kernel bisher noch nicht kompiliert wurde, so muss der Kernel für die Installation von externen Kernelmodule vorbereitet werden:

{{RootCmd|make modules_prepare}}

Packages containing kernel modules can be rebuilt using the <code>@module-rebuild</code> set:

{{Emerge|@module-rebuild}}

== Kompilierprobleme lösen ==

When experiencing build problems while rebuilding the current kernel, it might help to sanitize the kernel sources. Make sure to backup the {{Path|.config}} file first, as the operation will remove it. Make sure not to use a {{Path|.bak}} or {{Path|~}} suffix as backup as {{c|make distclean}} will clean those up as well.

{{RootCmd|cp .config /usr/src/kernel_config_bk
|make distclean
|mv /usr/src/kernel_config_bk .config}}

== Alte Kernel entfernen ==

Siehe Artikel zur [[Special:MyLanguage/Kernel/Removal|Kernel Deinstallation]]. 

== Externe Ressourcen ==

* [http://kernelnewbies.org/LinuxChanges Kernel Changelog mit einigen Beschreibungen neuer Funktionen (in Englisch)]

[[Category:Kernel]]
