<languages />

{{Metadata|abstract=Dieser Artikel beschreibt die Schritte, auf einen neuen Kernel zu aktualisieren.}}

Dieser Artikel beschreibt die Schritte, auf einen neuen [[Special:MyLanguage/Kernel|Kernel]] zu aktualisieren.

== Installation ==

Ein Kernel Upgrade wird notwendig, wenn aktuelle Kernelquellen bei der Aktualisierung des Systems installiert werden oder wenn man selber neue Kernelquellen installiert.

Installing new kernel sources doesn't provide the user with a new kernel. It is necessary to make and install a new kernel from the new sources and then reboot the system to actually run the new kernel.

Making a new kernel from the new sources is basically the same process as making a kernel when installing the system. The difference is that one can use the configuration of the old kernel to create a configuration for the new kernel. Using the old configuration saves the user from going through all the kernel options (like <tt>make menuconfig</tt>) again.

The configuration of the kernel is saved in a file named {{Path|.config}} in the directory that holds the kernel sources. A new kernel may have options or features the old kernel does not have, or it might not have a feature or option anymore which the old kernel still has.  The kernel configuration specifies whether the features and options of a kernel are to be enabled or not, perhaps built into the kernel, or perhaps built as modules which can be loaded into the running kernel on demand. Hence the configuration file of the new kernel may have new entries the configuration file of the old kernel doesn't have, and it might not have entries anymore which are present in the configuration file of the old kernel.

To deal with such changes of the configuration file, the configuration file of the old kernel needs to be converted to a configuration that can be used with the new kernel. This article shows how to make a new kernel from new kernel sources with converting the configuration file of the old kernel.

== Make a backup of the current kernel configuration ==

It is wise to make a backup of the kernel configuration so that the previous configurations are not lost. After all, many users devote considerable time to figure out the best configuration for the system, and losing that information is definitely not wanted.

It is easy to make a backup of the current kernel configuration:

{{RootCmd|cd /usr/src/linux
|cp .config ~/kernel-config-`uname -r`|}}

Provided that the symlink to the kernel sources has been set correctly, this copies the configuration of the currently used kernel to the home directory of root, renaming the configuration to {{Path|kernel-config-}} followed by the version of the current running Linux kernel.

== Set symlink to new kernel sources ==

Der Symlink {{Path|/usr/src/linux}} sollte immer auf die Kernelquellen zeigen, die derzeit verwendet werden. Dies kann mit einer der folgenden drei Methoden erledigt werden:

# Installing the kernel sources with <code>USE="symlink"</code>
# Setting the link with eselect
# Manually updating the symbolic link

=== Installing the kernel sources with the symlink USE flag ===

This will make the {{Path|/usr/src/linux}} point to the newly installed kernel sources.

If necessary, it can still be modified later with one of the other two methods.

=== Setting the link with eselect ===

To set the symlink with <tt>eselect</tt>:

{{RootCmd|eselect kernel list|output=<pre>
Available kernel symlink targets:
 [1] linux-3.14.14-gentoo *
 [2] linux-3.16.3-gentoo
</pre>}}

This outputs the available kernel sources. The asterisk indicates the chosen sources.

To change the kernel sources, e.g. to the second entry, do:

{{RootCmd|eselect kernel set 2}}

=== Manually updating the symbolic link ===

To set the symbolic link manually:

{{RootCmd|ln -sf /usr/src/linux-3.16.3 /usr/src/linux
|ls -l /usr/src/linux|output=<pre>
lrwxrwxrwx 1 root root 19 Oct  4 10:21 /usr/src/linux -> linux-3.16.3-gentoo
</pre>}}

== Copy previous kernel configuration ==

The configuration of the old kernel needs to be copied to the new one. It can be found in several places:

* Im [[Special:MyLanguage/procfs|procfs]] Dateisystem, falls die Kernel Option ''Enable access to .config through /proc/config.gz'' im bisherigen Kernel aktiviert worden ist:

 Im {{Path|/boot}} Verzeichnis, falls die Konfiguration dort installiert worden ist:

* Im Kernelverzeichnis des aktuell laufenden Kernels:

== Configure the new kernel ==

To use the configuration of the old kernel with the new kernel, it needs to be converted.  The conversion can be done by running either <tt>make oldconfig</tt> or <tt>make silentoldconfig</tt>.

<tt>make oldconfig</tt> gives many choices, <tt>make silentoldconfig</tt> does not.  Use either, not both.

=== make oldconfig ===

The following configuration is like the text based configuration with <tt>make config</tt>.  For new configuration options, it gives a choice. For example:

{{RootCmd|make oldconfig
|output=Anticipatory I/O scheduler (IOSCHED_AS) [Y/n/m/?] (NEW)
}}

The string ''(NEW)'' at the end of the line marks this option as new. Left to the string in square brackets are the possible answers: ''Y''es, ''n''o, ''m''odule or ''?'' to show the help. The recommend answer is capitalized (here ''Y''). The help explains the option or driver.

Unfortunately <tt>make oldconfig</tt> doesn't show - next to the help - a lot more information for each option, like the context, so that it is sometimes difficult to give the right answer. In this case the best way to go is to remember the option name and revise it afterwards through one of the [[Kernel/Configuration#Configuration tools|graphical kernel configuration tools]].

=== make silentoldconfig ===

If interactivity is not wanted (no questions should be asked), then use <tt>make silentoldconfig</tt>:

{{RootCmd|cd /usr/src/linux
|make silentoldconfig}}

== Kompilieren ==

{{Important|When external kernel modules are installed (like nvidia or zfs), it may be necessary to run <tt>make modules_prepare</tt> as described [[Kernel/Upgrade#Reinstall external kernel modules|below]] before bulding the kernel. Some modules cannot be installed or prepared before the kernel has been built.}}

{{Important|Do not forget to reconfigure the [[Bootloader|bootloader]] to account for the new kernel filenames, and rebuild the initramfs if one is used as well.}}

Für diesen Schritt folge wieder den den Schritten im [[Special:MyLanguage/Kernel/Configuration#Kompilieren|manuelle Konfiguration]] Artikel.

== Externe Kernelmodule erneut installieren ==

Alle externen Kernelmodule, wie die [[:Category:Binary kernel modules|binäre Kernel Module]],  müssen für jeden neuen Kernel erneut installiert werden. Falls der neue Kernel bisher noch nicht kompiliert wurde, so muss der Kernel für die Installation von externen Kernelmodule vorbereitet werden:

{{RootCmd|make modules_prepare}}

Man installiert die Pakete mittels des ''@module-rebuild'' Satz erneut:

{{Emerge|@module-rebuild}}

== Solving build problems ==

Falls Probleme beim Neukomplieren des aktuellen Kernels auftreten, kann es helfen, die Kernelquellen zu bereinigen. Stellen Sie zunächst sicher, dass die {{Path|.config}}-Datei zu sichern, da diese dabei gelöscht wird. Beachten Sie, dass Sie hierzu diese nicht mit einem <code>.bak</code> oder <code>~<code> Suffix versehen, da <code>make distclean</code> diese ebenfalls entfernen wird.

{{RootCmd|cp .config /usr/src/kernel_config_bk
|make distclean
|mv /usr/src/kernel_config_bk .config}}

== Alte Kernel entfernen ==

Siehe den [[Special:MyLanguage/Kernel/Removal|Kernel Deinstallation]] Artikel. 

== Externe Ressourcen ==

* [http://kernelnewbies.org/LinuxChanges Kernel Changelog mit einigen Beschreibungen neuer Funktionen (in Englisch)]

[[Category:Kernel]]
