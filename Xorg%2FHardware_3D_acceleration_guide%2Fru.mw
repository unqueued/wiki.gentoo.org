<languages />


{{Metadata|abstract=Этот документ является руководством по настройке аппаратного 3D-ускорения с помощью DRM и Xorg в Gentoo Linux.}}

Этот документ является руководством по настройке аппаратного 3D-ускорения с помощью DRM и Xorg в Gentoo Linux.

== Введение ==

=== Что такое аппаратное 3D-ускорение и зачем оно нужно? ===

При наличии аппаратного 3D-ускорения для создания трёхмерных изображений используется графический процессор на видеокарте заместо использования ценных ресурсов процессора. Обработка 3D на процессоре также называется "аппаратным ускорением", а не "программным ускорением", поскольку без аппаратного 3D ускорителя ЦП вынужден отрисовывать всё самостоятельно, используя библиотеки Mesa, которые потребляют совсем немного вычислительной мощности. Xorg поддерживает аппаратное 2D-ускорение, но ему часто недостаёт аппаратного 3D-ускорения. Трёхмерное аппаратное ускорение полезно в случаях, требующих прорисовки 3D-графики, например, в играх, 3D CAD и моделировании. 

=== Как я могу получить аппаратное 3D-ускорение? ===

Во многих случаях существуют как проприетарные драйвера, так и драйвера с открытым исходным кодом. Последние являются предпочтительными для Linux, поскольку открытость – это один из его основных принципов. Иногда проприетарные драйвера являются единственным выбором, особенно, если ваша видеокарта настолько новая, что для неё ещё не написано драйверов с открытым исходным кодом. Проприетарные драйвера включают в себя {{Package|x11-drivers/nvidia-drivers}} для видеокарт nVidia и {{Package|x11-drivers/ati-drivers}} для видеокарт AMD/ATI. 

=== Что такое DRI? ===

[http://dri.freedesktop.org/wiki/ Direct Rendering Infrastructure], также известный как DRI, – это платформа, позволяющая получать прямой доступ к видеокарте безопасным и эффективным способом. Платформа включает в себя исправления для X сервера, некоторых клиентских библиотек и для ядра. Первое важнейшее применение DRI – создание быстрых дополнений OpenGL. 

=== Что такое DRM и как он связан с Xorg? ===

DRM (Direct Rendering Manager) – это дополнение к Xorg, осуществляющее 3D ускорение путём добавления модулей ядра, необходимых для прямого доступа к видеокарте. 

=== Purpose ===

Это руководство предназначено для тех, кто не может получить прямой доступ к видеокарте, работая только с Xorg. DRM работает со следующими драйверами: 

* 3dfx
* intel
* matrox
* nouveau
* rage128
* radeon
* mach64
* sis300
* via

См. [http://dri.freedesktop.org/ DRI homepage] для более подробной информации и документации. 

== Установка Xorg и настройка ядра ==

=== Установка Xorg ===

Пожалуйста, прочитайте [https://wiki.gentoo.org/wiki/Xorg/Guide/ru Руководство по настройке Xorg], чтобы установить и запустить Xorg. 

=== Настройка ядра ===

Узнайте, какая у вас видеокарта, и включите только её. 

{{Emerge|pciutils}}

{{RootCmd|lspci {{!}} grep AGP|output=<pre>
# 00:01.0 PCI bridge: Intel Corp. 440BX/ZX/DX - 82443BX/ZX/DX AGP bridge (rev 03)
</pre>
}}

Вывод может отличаться из-за разности в аппаратном обеспечении.

Если ваша видеокарта не поддерживается ядром, можно достичь некоторого успеха установив параметр ядра <code>agp=try_unsupported</code>. Для поддержки видеокарты будут использоваться стандартные настройки для Intel. Для добавления этого параметра, отредактируйте файл конфигурации загрузчика! 

Большинство ядер должно иметь эти опции. Это было настроено с использованием стандартного ядра {{Package|sys-kernel/gentoo-sources}}.

{{RootCmd|ls -l /usr/src/linux |output=<pre>
lrwxrwxrwx 1 root root 22 2007-02-14 20:12 /usr/src/linux -> linux-2.6.18-gentoo-r4
</pre>}}

Убедитесь, что {{Path|/usr/src/linux}} является символической ссылкой на ваше текущее ядро.

{{RootCmd|cd /usr/src/linux
|make menuconfig}}

{{KernelBox|title=Hardware 3D acceleration options|
<pre>
Processor type and features --->
<*> MTRR (Memory Type Range Register) support
Device drivers --->
   Graphics support --->
   <M> /dev/agpgart (AGP Support) --->
      (The agpgart option is not present on 64-bit kernels;
      just choose your chipset support.)
      <M> Intel 440LX/BX/GX, I8xx and E7x05 support
      (Enable your chipset instead of the above.)
   <M> Direct Rendering Manager (XFree86 4.1.0 and higher DRI support) --->
      <M> (Select your graphics card from the list)
</pre>
}}

=== Компиляция и установка ядра ===

{{RootCmd|make && make modules_install}}

Не забудьте перенастроить {{Path|grub.conf}} или {{Path|lilo.conf}} и выполнить <code>/sbin/lilo</code> если вы используете LILO. 

=== Добавление пользователя в группу video ===

Далее, добавьте нужных пользователей в группу video. 

{{RootCmd|gpasswd -a username video}}

== Настройка прямого воспроизведения ==

=== Настройка Xorg ===

Надо надеяться, что добавления пользователя в группу <code>video</code> достаточно, чтобы активировать прямое воспроизведение. Однако, вам может также понадобиться создать файл в {{Path|/etc/X11/xorg.conf.d/}}. Имя файла может быть любым, но оно должно оканчиваться на {{Path|.conf}}. Откройте свой любимый текстовый редактор и создайте файл с таким содержанием: 

{{FileBox|filename=/etc/X11/xorg.conf.d/10-dri.conf||1=
Section "Device"
  Driver "radeon"
EndSection
Section "dri"
  Mode 0666
EndSection
}}

Замените radeon на название нужного драйвера.

=== Изменения в /etc/conf.d/modules ===

Вы должны добавить название модуля, используемого вашей видеокартой, в {{Path|/etc/conf.d/modules}}, чтобы гарантировать, что он автоматически загружается при запуске системы. 

{{FileBox|filename=/etc/conf.d/modules||1=
modules="intel-agp" # Замените своим драйвером
}}

{{Note|Если <code>agpgart</code> был скомпилирован как модуль, вам также придётся добавить его в {{Path|/etc/conf.d/modules}}.}}

== Тестирование 3D ускорения ==

=== Перезагрузка с новым ядром ===

Перезагрузите компьютер с новым ядром и войдите в систему под именем обычного пользователя. Настало время посмотреть насколько хорошо работает прямое воспроизведение. <code>glxinfo</code> и <code>glxgears</code> являются частями пакета {{Package|x11-apps/mesa-progs}}, поэтому перед тем, как запускать их, убедитесь, что этот пакет установлен.

{{Cmd|startx}}

Нет необходимости загружать модули вашего драйвера или agpgart, даже если они были скомпилированы как модули. Они будут загружены автоматически.

{{Cmd|glxinfo {{!}} grep rendering|output=<pre>
direct rendering: Yes
</pre>}}

Если будет выведено "No", значит 3D ускорение не работает.

{{Cmd|glxgears}}

Проверьте частоту обновления (FPS) при обычном разрешении экрана. Это число должно быть значительно больше, чем до настройки DRM. Сделайте это пока ЦП настолько свободен, насколько это возможно.

{{Note|FPS может быть ограничен частотой обновления вашего дисплея, поэтому примите это во внимание, если <code>glxgears</code> выдаёт только 70-100 FPS. {{Package|games-fps/ut2004-demo}} или другие 3D-игры являются более лучшими средствами сравнения эффективности.}}

=== Получение от прямого воспроизведения всего, что можно ===

Если вы хотите настроить дополнительные функции, для производительности или по другим причинам, смотрите [http://dri.freedesktop.org/wiki/FeatureMatrix таблицу характеристик] на сайте DRI или [http://dri.sourceforge.net/doc/dri_driver_features.phtml список характеристик] на Sourceforge. 

== Устранение проблем ==

=== It doesn't work. I don't have rendering, and I can't tell why. ===

Попробуйте выполнить <code>modprobe radeon</code> перед тем, как запускать X сервер (замените <code>radeon</code> на название вашего драйвера). Также попробуйте скомпилировать agpgart как часть ядра, а не как модуль. 

=== When I startx, I get this error: "[drm] failed to load kernel module agpgart" ===

That's because you compiled agpgart into the kernel instead of as a module. Ignore it unless you're having problems. 

=== I have a Radeon, and I want TV-Out. ===

The drivers originally developed by the [http://gatos.sf.net GATOS] project have been merged into Xorg's codebase. You don't need anything special for TV-Out; {{Package|x11-drivers/xf86-video-ati}} will work just fine.

=== It doesn't work. My card is so incredibly new and cool that it isn't supported at all. ===

Try out the binary drivers. For AMD cards, use <code>ati-drivers</code>; a listing is at [http://support.amd.com/us/gpudownload/Pages/index.aspx http://support.amd.com/us/gpudownload/Pages/index.aspx]. If those don't support it, use fbdev. It's slow, but it works.

=== I have a PCI card and it doesn't work. Help! ===

Create a config file in {{Path|/etc/X11/xorg.conf.d/}}; name it anything you want as long as it ends in {{Path|.conf}}. Add the following to it: 

{{FileBox|filename=/etc/X11/xorg.conf.x/10-pcimode.conf|title=Adding ForcePCI Mode|1=
Section "Device"
  Option "ForcePCIMode" "True"
EndSection
}}

== Ссылки ==

* [https://forums.gentoo.org/viewtopic.php?t=46681 Direct rendering (DRI) using X11-DRM HOWTO] on the Gentoo forums
* [https://forums.gentoo.org/viewtopic.php?t=29264 Radeon 7000-9700 DRI CVS Install Guide] on the Gentoo forums
* [http://dri.freedesktop.org/ http://dri.freedesktop.org/]

[[Category:X.Org]] {{Migrated|originalauthors=dberkholz, peesh, nightmorph}}
