== Introduction ==
Even though postfix provides logs, having them graphically displayed and analyzed can give much more insight. {{Package|www-misc/awstats}} is a popular log analyzer that can parse logs and setup proper results.


== Installation ==
AWStats is a web-application but no longer relies on webapp-config. If it hasn't emerged already, it needs to be emerged.
{{Emerge|www-misc/awstats}}

Once installed, a config file needs to be created, either per domain, or one that handles all domains.

{{RootCmd|cp /etc/awstats/awstats.model.conf /etc/awstats/awstats.example.com.conf}}

== Configuration ==
=== AWStats ===
AWStats comes with reasonable defaults, but some need to be changed nevertheless.

For one, awstats assumes that vhosts aren't used. When using apache's default combined vhost logs for example, awstats will fail to run.

Assuming apache's combined LogFormat is setup as follows.
{{Code|Apache's LogFormat|<pre>LogFormat "%v %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" VLOG=%{VLOG}e" vhost</pre>}}

The following changes needs to be made.
{{File|/etc/awstats/awstats.example.com.conf|Match Logformat to apache's.|<pre>
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
</pre>}}

Next awstats needs to know about the domains and aliases to filter from the log file.
{{File|/etc/awstats/awstats.example.com.conf|Make awstats listen to the domains|<pre>
SiteDomain="example.com"

HostAliases="localhost 127.0.0.1 REGEX[example\.com)$] REGEX[example\.(org|net)$]
</pre>}}

Also, awstats needs to store its database somewhere. Gentoo has created ''/var/lib/awstats'' for this use, but can be stored anywhere.
{{File|/etc/awstats/awstats.example.com.conf|AWStats database storage|<pre>
DirData="/var/lib/awstats"
</pre>}}

Any other changes to the configuration file are optional, but interesting to look into.
{{Note|When using the graphapplet plugin, the java applet may not display, see {{Bug|400589}} for more information.}}

=== Logging ===
awstats needs to process the apache logfile to build its database. Once confirmed that it is working manually it can be automated.
==== Manually ====
First, awstats should be run from the console, to spot any initial errors.
{{Cmd|awstats.pl -config=stats.example.com -update -showdropped}}

This should list any issues and missing domain names from the config.
==== Cron ====
If everything is working perfectly, it can then be added to cron.hourly.
{{File|/etc/cron.hourly/awstats|AWstats cronjob|<pre>
#!/bin/sh
awstats.pl -config=stats.example.com -update > /dev/null 2>&1
</pre>}}
Remember to make the script executeable if needed.

==== Logrotate ====
Awstats will process the log file every hour, but when logrotate rotates apache's log, some entries may be missing. This is easily solved however.
{{File|/etc/logrotate.d/apache2|Diff of pre-init script|<pre>
# Apache2 logrotate snipet for Gentoo Linux
# Contributes by Chuck Short
#
/var/log/apache2/*log {
  missingok
  notifempty
  sharedscripts
+  prerotate
+  /etc/cron.hourly/awstats > /dev/null 2>&1
+  endscript
  postrotate
  /etc/init.d/apache2 reload > /dev/null 2>&1 || true
  endscript
}
</pre>}}

=== Apache ===
For awstats to be used from apache, the webhost needs to properly setup. In the alias section, the following needs to be added.
{{File|/etc/apache2/vhosts.d/stats.example.com|Aliases for awstats|<pre>
        Alias /awstats/classes "/usr/share/awstats/wwwroot/classes"
        Alias /awstats/css "/usr/share/awstats/wwwroot/css"
        Alias /awstats/icon "/usr/share/awstats/wwwroot/icon"
        ScriptAlias /awstats/ "/usr/share/awstats/wwwroot/cgi-bin/"
        ScriptAlias /awstats "/usr/share/awstats/wwwroot/cgi-bin/awstats.pl"
</pre>

Finally, awstats needs the correct permissions to be accessable.
{{File|/etc/apache2/vhosts.d/stats.example.com|Aliases for awstats|<pre>
<Directory "/usr/share/awstats/wwwroot">
        AllowOverride None
        Options None
        Order allow,deny
        Allow from all
</Directory>
</pre>}}

After a restart of apache, awstats should be available via ''http://stats.example.com/awstats/awstats.pl?config=stats.example.com''. If no config option is passed to awstats, it uses the current hostname, which means in this case could have been omitted.

== Awstats for mail log ==
AWStats is known for being an apache log parser. However it can also be used to parse mail logs.
=== Configuration ===
After copying ''awstats.stats.example.com.conf'' to ''awstats.mail.example.com.conf'' quite a few changes are required to turn awstats into a mail log parser.
{{File|/etc/awstats.mail.example.com.conf|Log mail.log instead of access.log|<pre>

</pre>}}

{{Note|The ''/var/log/mail.log'' file does not have to be on the same server. AWStats will have to have access to it. This could be via nfs, or having syslog do remote logging.}}
