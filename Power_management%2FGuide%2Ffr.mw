<languages />


{{Metadata|abstract=In recent years, power management has become one of the differentiating features in the quest for finding the perfect laptop. Yet, the operating system must support the various power saving functionalities too. In this guide, we cover how to setup a Gentoo installation so it manages power-hungry resources in a flexible yet automated manner.}}

In recent years, power management has become one of the differentiating features in the quest for finding the perfect laptop. Yet, the operating system must support the various power saving functionalities too. In this guide, we cover how to setup a Gentoo installation so it manages power-hungry resources in a flexible yet automated manner.

== Introduction ==

=== À propos de ce document... ===

Ce document décrit la configuration de la gestion d'énergie sur votre ordinateur portable. Bien que quelques unes des informations fournies dans ce guide s'appliquent aussi aux serveurs, ce n'est pas l'objectif de ce document que de couvrir ce cas. Soyez donc prudent lorsque vous appliquerez ce guide à autre chose qu'un ordinateur portable. 

Within this document, the primary focus will be on laptop mode tools since it offers a complete set of functionalities. However, we will also refer to other tools that might offer a more detailed approach on individual settings. In such cases, the feature from the laptop mode tools must be disabled so that both tools do not fight over the same resource control. 

=== À propos du laptop_mode (mode ordinateur portable) ===

Le paramètre  <code>laptop_mode</code> du noyau permet l'optimisation des entrées/sorties, en autorisant les disques à se mettre au ralenti proprement (et à ne pas être réveillés aussitôt lors d'opération en files). 

=== À propos des outils du laptop-mode===

The ''Laptop Mode Tools'' is a software package ({{Package|app-laptop/laptop-mode-tools}}) which allows the user to optimize power saving functions. It allows managing the laptop_mode setting in the Linux kernel, but has additional features that allow the tweaking of other power-related settings on the system.

== Linux kernel configuration ==

=== Configuration minimale du noyau ===

There are different kernel sources in Portage. We recommend using {{Package|sys-kernel/gentoo-sources}}, but if advanced hibernation support is desired, {{Package|sys-kernel/tuxonice-sources}} might be needed. To enable proper power management features in the Linux kernel, enable the following settings: 

{{KernelBox|title=Minimum kernel setup for Power Management|1=<pre>
Power management and ACPI options --->
  -*- Device power management core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
  
  [*] CPU Frequency scaling --->
        Default CPUFreq governor (ondemand)  --->
    -*- 'performance' governor
    <*> 'powersave' governor
    <*> 'userspace' governor for userspace frequency scaling
    -*- 'ondemand' cpufreq policy governor
    <*> 'conservative' cpufreq governor
    <*> ACPI Processor P-States driver
</pre>}}

Do not forget to enable the CPU frequency scaling driver for the CPU. For the SandyBridge and higher Intel core series of processors, ''userspace'', ''ondemand'', and ''conservative'' governors are unnecessary; ''performance'' should be selected as the default, and ''Intel P state control'' should be selected instead of ''ACPI Processor P-States driver''. <ref>Dominik Brodowski. [https://www.kernel.org/doc/Documentation/cpu-freq/intel-pstate.txt Intel P-State driver], [https://www.kernel.org/doc/Documentation/cpu-freq/index.txt CPU frequency and voltage scaling code in the Linux(TM) kernel]. Retrieved 12 June 2016.</ref>

For a more detailed description see the [[Power management/Processor#Kernel]] article.

[[Kernel/Rebuild|Build and install]] the new kernel (if necessary) and reboot.

== Utiliser les outils du laptop_mode ==

=== Installation ===

It comes to no surprise that installation of the ''Laptop mode tools'' software is easily done via:

{{Emerge|app-laptop/laptop-mode-tools}}

However, this package takes on additional, optional settings through USE flag configuration. So let's first take a look at the supported USE flags and what they mean to the package. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! USE flag
! Description
! Suggested when...
|- 
| <code>acpi</code>
| Depend on {{Package|sys-power/acpid}} so that changes in the system are captured and power saving features are automatically enabled/disabled.
| the laptop is not too old (around year 2003 and later).
|- 
| <code>apm</code>
| Depend on {{Package|sys-apps/apmd}} so that changes in the system are captured and power saving features are automatically enabled/disabled.
| the laptop is very old.
|- 
| <code>bluetooth</code>
| Depend on {{Package|net-wireless/bluez}} , enabling laptop-mode-tools to manage bluetooth settings (enabling/disabling the service based on battery availability)
| the laptop (and kernel) support bluetooth.
|- 
| <code>scsi</code>
| Depend on {{Package|sys-apps/sdparm}} , enabling laptop-mode-tools to manage SCSI (''and not'' SATA) disk parameters.
| the laptop uses SCSI disks.
|-
|}

Observe there are two USE flags that seem to collide: <code>acpi</code> and <code>apm</code>. So what is the deal? 

* L'option <code>apm</code> de la variable USE active la prise en charge de  ''Advanced Power Management (Gestion avancée de l'énergie)'' , un ancien standard (avant 2000) pour les fonctionnalités de gestion de l'énergie dans un système.
* L'option <code>acpi</code> de la variable USE active la prise en charge de l'''Advanced Configuration and Power Interface (Configuration avancée et Interface énergie)'' , le successeur  d'APM. Tous les portables modernes prennent en charge l'ACPI.

Depending on the system, either <code>acpi</code> or <code>apm</code> will need to be set. In the remainder of this guide, it is assumed the laptop is recent enough to use ACPI. 

Une fois les options de la variable USE définies, installons le paquet <code>laptop-mode-tools</code> .

{{Emerge|laptop-mode-tools}}

=== Configuration ===

Le fait d'avoir  <code>laptop-mode-tools</code> installé sur votre système n'active pas automatiquement les fonctionnalités dont vous pourriez avoir besoin. Pour configurer ce paquet, commencez par regarder le fichier de configuration principal {{Path|/etc/laptop-mode/laptop-mode.conf}} . Il est très bien documenté. 

Mais ce n'est pas le seul fichier de configuration disponible. Le paquet''Laptop Mode Tools'' prend en charge des greffons (ou modules) qui possèdent leur(s) propre(s) fichier(s) de configuration. Ces fichiers sont situés dans {{Path|/etc/laptop-mode/conf.d}} et prennent le nom du module qu'ils représentent (comme {{Path|intel-sata-powermgmt.conf}} ). 

Now, one of the important settings in each configuration file is if the laptop-mode-tools package should govern a particular setting or not. This is important when combining laptop-mode-tools with other power management services such as {{c|cpufreqd}}. In this example case, <code>CONTROL_CPU_FREQUENCY=0</code> must be set: 

{{FileBox|filename=/etc/laptop-mode/conf.d/cpufreq.conf|1=
CONTROL_CPU_FREQUENCY=0
}}

Les quelques sections suivantes vous aideront à configurer <code>laptop-mode-tools</code> pour qu'il réponde à vos besoins. Après avoir terminé, démarrez le service <code>laptop_mode</code> et assurez-vous qu'il est lancé à chaque démarrage du système. 

{{RootCmd
|rc-service laptop_mode start
|rc-update add laptop_mode default
}}

=== Comment fonctionnent les outils laptop-mode-tools ? ===

Lorsque vous lancez le service <code>laptop_mode</code> le logiciel va regarder dans quel état se trouve votre système. Les différents états possibles sont : 

*  ''Battery'' , qui est actif lorsque le système prend son énergie sur la batterie ; les fichiers de configuration utilisent le préfixe  <code>BATT_</code> pour les réglages correspondant  à cet état
*  ''AC'' , qui est actif lorsque le système prend son énergie sur le secteur ; les fichiers de configuration utilisent le préfixe  <code>AC_</code> pour les réglages correspondant  à cet état
*  ''Laptop Mode'' , qui est actif lorsque le  ''Laptop Mode'' est activé; les fichiers de configuration utilisent le préfixe  <code>LM_</code> pour les réglages correspondant  à cet état
*  ''No Laptop Mode'' , qui est actif lorsque le  ''Laptop Mode'' est désactivé ; les fichiers de configuration utilisent le préfixe  <code>NOLM_</code> pour les réglages correspondant  à cet état

The <var>AC/BATT_</var> and <var>LM/NOLM_</var> prefixes can be combined to have a <var>AC_LM_</var> prefix. 

Après que le service  <code>laptop_mode</code> a démarré,  il change de mode en se basant sur des événements qui se produisent ( et bien sûr sur la configuration). Par exemple, le réglage  <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code>  s'assurera que les outils du mode laptop commutent vers ''laptopmode'' quand la batterie est vide. Si c'est le cas, alors les réglages commençant par  <code>LM_</code> , <code>LM_BATT_</code> , <code>BATT_LM_</code> et <code>BATT_</code> seront utilisés. 

Pour s'assurez que les réglages n'entrent pas en conflit, il n'est pas autorisé d'avoir des réglages qui se recouvrent. Dans l'exemple qui suit, le premier réglage  (pour <code>CPU_MAXFREQ</code> ) est valide, mais le deuxième (pour  <code>CPU_GOVERNOR</code> ) ne l'est pas. 

{{CodeBox|title=Colliding settings|1=
## Valid set
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Invalid set
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# The following includes AC and BATT, but BATT is already defined
NOLM_CPU_MINFREQ=fastest
}}

=== Configurer la gestion de fréquence du  processeur ===

La prise en charge de la gestion de la fréquence du processeur (CPU) dans les outils du mode portable autorise la commutation des fréquences. Elle prend en charge le réglage du gouverneur de fréquence du processeur, fréquence maximale et minimale. Le fichier de configuration utilisé ici est  {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}} .

Le ''gouverneur de fréquence du processeur'' est une politique de niveau noyau qui définit comment le noyau choisira la fréquence du processeur. Nous avons déjà sélectionné le gouverneur que nous voulons utiliser dans la configuration du noyau précédemment. Récapitulons : 

*  <code>performance</code> sélectionne toujours la fréquence la plus haute
*  <code>powersave</code> sélectionne toujours la fréquence la plus basse
*  <code>userspace</code> ne sélectionne rien, mais laisse l'utilisateur décider ( ou tout processus que l'utilisateur exécute qui décidera pour lui)
*  <code>ondemand</code> adapte la fréquence du processeur jusqu'à la valeur la plus haute quand la charge est disponible.
*  <code>conservative</code> adapte graduellement la fréquence du processeur vers le haut lorsque la charge est disponible.

En commutant entre AC et batterie, ou (pas) de mode portable, le gouverneur approprié (aussi bien que ses fréquence maximale et minimale) est choisi. 

=== Configurer la luminosité de l'écran  ===

Via le fichier  {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}} , vous pouvez faire en sorte que les outils du mode portable gouvernent la luminosité de l'écran. 

Le fichier utilise actuellement  le fichier  {{Path|/proc/acpi/video/VID/LCD/brightness}} ([https://bugs.gentoo.org/show_bug.cgi?id=499544 bug 499544]) pour définir les valeurs de  luminosité. Les noyaux récents ne fournissent plus cette fonctionnalité — vous devrez ajuster cela vous-même dans {{Path|/sys/class/backlight/acpi_video0/brightness}}. 

Les valeurs que vous pouvez utiliser sont comprises entre 0 et la valeur contenue dans {{Path|/sys/class/backlight/acpi_video0/max_brightness}}; 0 étant la valeur correspondant à la luminosité la plus faible.

=== Configurer les autres services  ===

Une fonctionnalité intéressante des outils du mode portable (<code>laptop-mode-tools</code>) est de prendre en charge le rechargement de services particuliers ( comme la journalisation du système) après changement de fichier de configuration. Ceci est pris en charge via le fichier {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}} . 

Si elle est activée, l'application de ''mode portable''  (<code>laptop_mode</code>) commutera les fichiers de configuration des services mentionnés vers un fichier de même nom, mais suffixé par   {{Path|-nolm-ac}} , {{Path|-lm-ac}} ou {{Path|-batt}} . Elle le signalera alors aux services appropriés, ou les rechargera, de manière à ce qu'ils utilisent les nouveaux fichiers de configuration. 

== Utiliser cpufreqd ==

{{Warning|Package {{Package|sys-power/cpufreqd}} is deprecated and has been removed from the Portage tree. {{Package|sys-power/ncpufreqd}} can still be used for [https://bitbucket.org/nelchael/ncpufreqd 2.6.x kernels].
}}

=== Installation ===

The {{c|cpufreqd}} application allows the user to manage CPU frequencies in a more granular approach than what laptop-mode-tools supports. But before we dive into the installation of {{c|cpufreqd}}, let us first look at the USE flags it supports. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! USE flag
! Description
! Suggested when...
|- 
| <code>acpi</code>
| Enable support for ACPI, allowing {{c|cpufreqd}} to be notified about specific events as well as govern power through the ACPI interface
| the laptop is not very old (around year 2003 and later)
|- 
| <code>apm</code>
| Enable support for APM, allowing {{c|cpufreqd}} to be notified about specific events as well as govern power through the APM interface
| the laptop is very old
|- 
| <code>lm_sensors</code>
| Enable support for the Linux hardware sensors (through {{Package|sys-apps/lm_sensors}}), allowing to switch profiles based on hardware sensor results
| using advanced events through lm_sensors
|- 
| <code>nforce2</code>
| Enable support for NForce, allowing {{c|cpufreqd}} to change the NForce FSB clock and video card frequency
| an NVidia graphics card based on the NForce chipset is present
|- 
| <code>nvidia</code>
| Enable support for NVidia graphical card configuration (through the NVidia ''nvclock'' interface), allowing {{c|cpufreqd}} to change the video card frequency of NVidia graphical cards
| an NVidia graphics card is present
|- 
| <code>pmu</code>
| Enable the Power Management Unit plug-in of {{c|cpufreqd}}. This allows the software to poll the Linux kernel Power Supply interface, getting more detailed information on battery charge
| the laptop does not support ACPI or APM
|-
|}

Les options  <code>acpi</code>, <code>apm</code> et <code>pmu</code> de la variable USE empiètent l'une sur l'autre, c'est pourquoi vous ne devriez en avoir qu'une seule activée. Si votre portable est assez récent,  <code>acpi</code> est votre meilleur pari. Si ce n'est pas le cas, <code>apm</code> vous offre tout ce qui est nécessaire. Quand, même APM n'est pas pris en charge, vous pouvez essayer  <code>pmu</code> . 

With the USE flags configured, it is time to install {{c|cpufreqd}}. 

{{Emerge|cpufreqd}}

=== Configuration ===

The {{c|cpufreqd}} application monitors the status of the system through several plugins. Based on the feedback it receives from those plugins, it will adjust the policy used to govern the CPU frequency. 

{{c|cpufreqd}} can be configured by editing {{Path|/etc/cpufreqd.conf}}. It contains three different sections: 

# The <code>[General]...[/General]</code> section contains general configuration information.
# The <code>[Profile]...[/Profile]</code> section defines the policies that the cpufreqd daemon can switch to. The section is very similar to the information used when manually setting the CPU frequency policy using cpufreq-set.
# The <code>[Rule]...[/Rule]</code> section is the work-horse of the cpufreqd daemon, defining when the daemon decides to switch to a different profile.

Jetons un rapide coup d'œil à un exemple de règle. 

{{File|/etc/cpufreqd.conf|Échantillon de règle cpufreqd |<pre>
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
</pre>
}}

In the above example, {{c|cpufreqd}} will switch the system to the ''On Demand High'' profile (also shown in the above excerpt). This profile by itself uses the ondemand governor with a minimum frequency of 40% (iow, a CPU of 2 GHz will have by this policy a minimum frequency of 800 MHz). 

The {{c|cpufreqd}} application can offer a more granular approach on CPU frequency scaling. But not only that, but the CPU frequency scaling can be tweaked based on various other metrics available. The default configuration offers a sample rule: when a movie is watched, maximum performance is desired (unless the CPU temperature is getting too high). 

When {{c|cpufreqd}} has been configured, it is time to start it (and make sure the service is loaded automatically). Make sure that CPU frequency handling by other tools (like laptop-mode-tools) is disabled! 

{{RootCmd
|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start
}}

== See also ==

* [[USB Power Saving]]

== External resources ==

*  [http://samwel.tk/laptop_mode/ Laptop Mode Tools Homepage], includes [http://samwel.tk/laptop_mode/laptop_mode About laptop mode].
*  [https://01.org/powertop PowerTOP], an interactive application helping users to find out which processes are forcing wakeups on the CPU most often.
* A ThinkWiki article on [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption How to reduce power consumption] (on Linux). This article offers an exhaustive list of measures one can take. However, it should be noted that the laptop mode tools implements the majority of these (if properly configured).

== References ==

{{reflist}}


[[Category:Power management]]
