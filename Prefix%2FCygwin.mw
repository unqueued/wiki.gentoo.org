{{InfoBox stack
|{{InfoBox irc|gentoo-prefix|header=true}}
}}

This article provides [[Article description::instructions for any poor soul attempting to bootstrap Gentoo Prefix on Cygwin.]]

== Preface: Prefix on Cygwin ==

How to bootstrap Gentoo Prefix on Cygwin?

=== Overview ===

At the beginning some general advice is given on how to setup Cygwin. There are a few restrictions for the Cygwin setup that users need to bear in mind to have success with Gentoo Prefix on Cygwin.

=== What is this? ===

There was also a project "Gentoo on Cygwin" which is unmaintained as of 2008. Note the difference to "Gentoo Prefix on Cygwin". "Gentoo Prefix on Cygwin" is not a project itself but simply a try to run the well maintained "Gentoo Prefix" sources on Cygwin.

=== Why do this? ===

Running Prefix on Cygwin provides the same runtime environment on Windows as possible on Linux or Mac. It brings much more options than a Java runtime environment and it requires less resources than a virtual machine. Additionally, any program can be compiled by using Gentoo's package manager. Finally, all this happens in the userspace which provides independence from the administrator account. Nothing compares to this.

== Restrictions ==

Unix/Linux based package managers usually do require the <code>fork()</code> system call, which is not available in Windows in general. Nevertheless, Cygwin implements the <code>fork()</code> system call using the <code>CreateProcess()</code> and <code>LoadLibrary()</code> Windows calls, combined with sophisticated duplication of process memory, loaded libraries and open handles into the child process.

But this requires <code>CreateProcess()</code> and <code>LoadLibrary()</code> to locate the very same binaries (executable and DLLs) as loaded in the parent process.

Imagine what happens when the package manager has replaced these binaries, while existing processes (including the package manager itself) still want to fork.

Unfortunately, other than promised, Cygwin 3.0 does not provide an improved implementation of the <code>fork()</code> system call, able to deal with removed or updated binaries. In lack of more recent information, the promised implementation imposes some additional requirements to the Cygwin setup to actually work. Please find more details in [[#Additional setup|section Additional setup]].

* An '''NTFS''' file system for the Cygwin installation to install into.
* Use this very '''same''' NTFS file system for Gentoo Prefix to install into.

The reason here is that the original executables are ''hardlinked'' into the {{Path|/var/run/cygfork/}} directory.

Note that Cygwin has discontinued support for Windows XP and Server 2003.

== Installing Cygwin ==

Cygwin comes with a full featured installer that explains itself:

* 64 bit: http://www.cygwin.org/setup-x86_64.exe
* 32 bit: http://www.cygwin.org/setup-x86.exe (not officially supported by Gentoo Prefix yet)

=== Space and paths ===

Before installing Cygwin consider the pathname. Use a windows user account without whitespace in the username. Not all scripts can handle whitespace in pathes. Have enough free space, minimum 4 GB, take 10 GB if available.

Let's assume "prefix" has been chosen as the username and Cygwin is installed at {{Path|P:\cygwin}} (mnemo for Prefix Cygwin).

Windows perspective: {{Path|P:\cygwin\home\prefix}}
Cygwin perspective:  {{Path|/home/prefix}}

Remember to choose an '''NTFS''' partition as the Cygwin installation directory.

=== User and permissions ===

Install Cygwin from the same windows account that will be using it. This way some trouble can be avoided with user permissions and administration.

=== Additional packages ===

The Gentoo Prefix bootstrap aims to require as less as possible packages installed on the underlying operating system. However, a minimal set of compilation environment plus some download tool is required. In addition to the default selection done by the Cygwin setup please install these additional packages:

* {{c|gcc-core}}
* {{c|gcc-g++}}
* {{c|wget}}

=== Additional setup ===

The fork feature mentioned above is disabled by default, it will need to be enabled manually:

* Use Cygwin 3.0 (or higher - not available yet), or a [http://dev.gentoo.org/~haubi/cygwin-gentoo/ cygwin1.dll with the "forkables" patches applied]. These patches are maintained in the [https://cygwin.com/git/gitweb.cgi?p=newlib-cygwin.git;a=shortlog;h=refs/heads/topic/forkables upstream "topic/forkables" branch] already.

* Don't forget to set the executable permission for when you downloaded a precompiled cygwin1.dll!

* Create the {{c|/var/run/cygfork/}} Cygwin directory; the Cygwin setup does not create it. To do so start the {{c|mintty}} console and run:

: {{Cmd|mkdir --mode{{=}}a{{=}}rwxt /var/run/cygfork}}

* Finally, '''reboot''' Windows, to make sure the initial Cygwin process started already finds the {{c|/var/run/cygfork/}} directory in place, to actually activate the fork handler for removed or replaced binaries for this Cygwin instance.

== Install Gentoo Prefix ==

Simply follow the [[Project:Prefix/Bootstrap|general bootstrap process]].

== External resources ==

* [[wikipedia:Interix|Interix]] - A now deprecated, optional, POSIX-conformant Unix subsystem for Windows NT operating systems.

[[Category:Compilation]]
