==PostgreSQL==
PostgreSQL is a powerful, open source object-relational database system with a strong reputation for reliability, data integrity, and correctness.


===Installation===
{{Emerge|dev-db/postgresql-base|dev-db/postgresql-server}}


===Changing the default encoding of new databases to UTF-8===
When creating a new database (e.g. with <code>createdb mydb</code>) PostgreSQL actually copies a template database. There are two predefined templates: template0 is vanilla, while template1 is meant as an on-site template changeable by the administrator and is used by default. In order to change the default encoding of new databases, one of the options is to change on-site template1. To do this, log into PostgresSQL shell (<code>psql</code>) and execute the following:

1. First we need to drop template1. As templates cannot be dropped, we first need to change it to an ordinary database:
 UPDATE pg_database SET datistemplate = FALSE WHERE datname = 'template1';
2. After that, it is possible to drop it:
 DROP DATABASE template1;
3. The next step is to create a new database from template0 with a new default encoding:
 CREATE DATABASE template1 WITH TEMPLATE = template0 ENCODING = 'UNICODE';
4. Now we need to change template1 back to the template:
 UPDATE pg_database SET datistemplate = TRUE WHERE datname = 'template1';
5. (OPTIONAL) If you do not want anyone connecting to this template, set datallowconn to FALSE:
 UPDATE pg_database SET datallowconn = FALSE WHERE datname = 'template1';

Now you can create a new database by running from regular shell:
{{Cmd|su -|su - postgres|createdb mydb}}

If you log in back to psql and check the databases, you should see the proper encoding of your new database:
 \l
returns
                               List of databases
   Name    |  Owner   | Encoding  | Collation | Ctype |   Access privileges
 -----------+----------+-----------+-----------+-------+----------------------
 mydb      | postgres | UTF8      | C         | C     |
 postgres  | postgres | SQL_ASCII | C         | C     |
 template0 | postgres | SQL_ASCII | C         | C     | =c/postgres
                                                      : postgres=CTc/postgres
 template1 | postgres | UTF8      | C         | C     |


===Upgrading PostgreSQL 9.0 to 9.1===

This will handle PostgreSQL Upgrade from 9.0 to 9.1
After emerging 9.1  copy configurationfiles from your old version to the new one:
{{Cmd|cp -R /etc/postgresql-9.0/* /etc/postgresql-9.1/*}}

Create initdb with user 'postgres'
{{Cmd|su - postgres|initdb91 /var/lib/postgresql/9.1/data|exit}}

Check starting postgres-9.1 if everything works, shut down postgres-9.1. There must be no postgres instance running while migration of databases!
Create symlinks for configfiles. PostgreSQL's pg_upgrade needs configs in the Posgres data directory:
{{Cmd|ln -s /etc/postgresql-9.0/*.conf /var/lib/postgresql/9.0/data/|ln -s /etc/postgresql-9.1/*.conf /var/lib/postgresql/9.1/data/}}

Upgrade process:
{{Cmd|su - postgres|cd /var/lib/postgres|pg_upgrade91 -v --old-datadir=/var/lib/postgresql/9.0/data/ --new-datadir=/var/lib/postgresql/9.1/data --old-bindir=/usr/lib/postgresql-9.0/bin/ --new-bindir=/usr/lib/postgresql-9.1/bin/|exit}}

Check startup of the new postgres database and check daemons depending on postgres like postfix or openfire.
If everything is working, unmerge old postgres-9.0 clean datadirectory:

{{Cmd|emerge -av --prune dev-db/postgresql-server dev-db/postgresql-base|su - postgres|vacuumdb --all --analyze-only|rm -rf /var/lib/postgresql/9.0|exit}}

[[Category:Software]]
[[Category:Server and Security]]
