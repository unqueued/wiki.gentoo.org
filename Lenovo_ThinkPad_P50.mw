== Hardware ==

=== Overview ===

{{RootCmd|lscpu|output=<pre>
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                8
On-line CPU(s) list:   0-7
Thread(s) per core:    2
Core(s) per socket:    4
Socket(s):             1
NUMA node(s):          1
Vendor ID:             GenuineIntel
CPU family:            6
Model:                 94
Model name:            Intel(R) Xeon(R) CPU E3-1505M v5 @ 2.80GHz
Stepping:              3
CPU MHz:               1750.000
CPU max MHz:           3700.0000
CPU min MHz:           800.0000
BogoMIPS:              5619.86
Virtualization:        VT-x
L1d cache:             32K
L1i cache:             32K
L2 cache:              256K
L3 cache:              8192K
NUMA node0 CPU(s):     0-7
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc art arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch epb intel_pt tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm mpx rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 dtherm ida arat pln pts hwp hwp_notify hwp_act_window hwp_epp
</pre>}}

{{RootCmd|lspci -nnk|output=<pre>
00:00.0 Host bridge [0600]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor DRAM Controller [8086:0c04] (rev 06)
        Subsystem: Lenovo Xeon E3-1200 v3/4th Gen Core Processor DRAM Controller [17aa:2210]
00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller [8086:0c01] (rev 06)
        Kernel driver in use: pcieport
00:02.0 VGA compatible controller [0300]: Intel Corporation 4th Gen Core Processor Integrated Graphics Controller [8086:0416] (rev 06)
        Subsystem: Lenovo 4th Gen Core Processor Integrated Graphics Controller [17aa:221e]
        Kernel driver in use: i915
        Kernel modules: i915
00:03.0 Audio device [0403]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller [8086:0c0c] (rev 06)
        Subsystem: Lenovo Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller [17aa:2210]
        Kernel driver in use: snd_hda_intel
        Kernel modules: snd_hda_intel
00:14.0 USB controller [0c03]: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI [8086:8c31] (rev 04)
        Subsystem: Lenovo 8 Series/C220 Series Chipset Family USB xHCI [17aa:2210]
        Kernel driver in use: xhci_hcd
        Kernel modules: xhci_pci
00:16.0 Communication controller [0780]: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 [8086:8c3a] (rev 04)
        Subsystem: Lenovo 8 Series/C220 Series Chipset Family MEI Controller [17aa:2210]
        Kernel driver in use: mei_me
        Kernel modules: mei_me
00:19.0 Ethernet controller [0200]: Intel Corporation Ethernet Connection I217-LM [8086:153a] (rev 04)
        Subsystem: Lenovo Ethernet Connection I217-LM [17aa:2210]
        Kernel driver in use: e1000e
        Kernel modules: e1000e
00:1b.0 Audio device [0403]: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller [8086:8c20] (rev 04)
        Subsystem: Lenovo 8 Series/C220 Series Chipset High Definition Audio Controller [17aa:2210]
        Kernel driver in use: snd_hda_intel
        Kernel modules: snd_hda_intel
00:1c.0 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 [8086:8c10] (rev d4)
        Kernel driver in use: pcieport
00:1c.1 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #2 [8086:8c12] (rev d4)
        Kernel driver in use: pcieport
00:1c.2 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 [8086:8c14] (rev d4)
        Kernel driver in use: pcieport
00:1d.0 USB controller [0c03]: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 [8086:8c26] (rev 04)
        Subsystem: Lenovo 8 Series/C220 Series Chipset Family USB EHCI [17aa:2210]
        Kernel driver in use: ehci-pci
        Kernel modules: ehci_pci
00:1f.0 ISA bridge [0601]: Intel Corporation QM87 Express LPC Controller [8086:8c4f] (rev 04)
        Subsystem: Lenovo QM87 Express LPC Controller [17aa:2210]
        Kernel driver in use: lpc_ich
        Kernel modules: lpc_ich
00:1f.2 SATA controller [0106]: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] [8086:8c03] (rev 04)
        Subsystem: Lenovo 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] [17aa:2210]
        Kernel driver in use: ahci
        Kernel modules: ahci
00:1f.3 SMBus [0c05]: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller [8086:8c22] (rev 04)
        Subsystem: Lenovo 8 Series/C220 Series Chipset Family SMBus Controller [17aa:2210]
        Kernel driver in use: i801_smbus
        Kernel modules: i2c_i801
01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK208M [GeForce GT 730M] [10de:1290] (rev a1)
        Subsystem: Lenovo GK208M [GeForce GT 730M] [17aa:221e]
        Kernel driver in use: nvidia
        Kernel modules: nouveau, nvidia_drm, nvidia
03:00.0 Unassigned class [ff00]: Realtek Semiconductor Co., Ltd. RTS5227 PCI Express Card Reader [10ec:5227] (rev 01)
        Subsystem: Lenovo RTS5227 PCI Express Card Reader [17aa:2210]
        Kernel driver in use: rtsx_pci
        Kernel modules: rtsx_pci
04:00.0 Network controller [0280]: Intel Corporation Wireless 7260 [8086:08b2] (rev 83)
        Subsystem: Intel Corporation Dual Band Wireless-AC 7260 [8086:c270]
        Kernel driver in use: iwlwifi
        Kernel modules: iwlwifi
</pre>}}

{{RootCmd|lsusb|output=<pre>
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 003: ID 138a:0090 Validity Sensors, Inc. 
Bus 001 Device 002: ID 04f2:b52c Chicony Electronics Co., Ltd 
Bus 001 Device 004: ID 0765:5010 X-Rite, Inc. 
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</pre>}}

=== Power management ===

Make sure you have "Hybrid Graphics" enabled in the BIOS, and are using the proprietary NVIDIA driver (<tt>emerge nvidia-drivers</tt>). Make sure all of these packages are installed:

{{RootCmd| emerge bbswitch nvidia-drivers intel-ocl-sdk}}

First add a udev rule for putting devices to sleep when not in use:

{{FileBox|filename=/etc/udev/rules.d/90-power.rules|1=
ACTION=="add", SUBSYSTEM=="net", KERNEL=="eth*", RUN+="/usr/sbin/ethtool -s %k wol d"
ACTION=="add", SUBSYSTEM=="net", KERNEL=="wlan*", RUN+="/usr/sbin/iw dev %k set power_save on"
ACTION=="add", SUBSYSTEM=="pci", ATTR{power/control}="auto"
ACTION=="add", SUBSYSTEM=="scsi_host", KERNEL=="host*", ATTR{link_power_management_policy}="min_power"
ACTION=="add", SUBSYSTEM=="usb", ATTRS{removable}=="fixed", TEST=="../power/control", ATTR{../power/control}="auto"
}}

You'll also want the sound card to sleep when unused, to have direct fan control (just for fun), and to not automatically load the nvidia driver:

{{FileBox|filename=/etc/udev/rules.d/90-power.rules|1=
options thinkpad_acpi fan_control=1
options snd_hda_intel power_save=1
blacklist nvidia
blacklist nvidia_drm
blacklist nvidia_modeset
}}

Emerge bbswitch and make it load at boot time:

{{RootCmd| emerge bbswitch | echo bbswitch > /etc/modules-load.d/10-bbswitch.conf | modprobe bbswitch}}

Read onward with the NVIDIA Optimus configuration below to complete the power savings.

=== NVIDIA Optimus ===

Assuming you've enabled "Hybrid Graphics" in the BIOS, emerged the NVIDIA proprietary driver, and emerged and configured bbswitch as in the power management section above, continue here to get hybrid graphics working well.

When in hybrid graphics mode, the laptop's panel is connected to the Intel card. So, using the Intel card works as usual, but the NVIDIA card requires some tricks.

Assuming you're using SDDM as your display manager, put the following in your Xsetup, which turns off the NVIDIA card to save power, when not in use, and otherwise instructs the NVIDIA card to use the screen attached to the Intel card when in use:

{{CodeBox|filename=/usr/share/sddm/scripts/Xsetup|lang=bash|1=
#!/bin/sh
PATH="/sbin:/usr/sbin:/bin:/usr/bin"
if xrandr --listproviders {{!}} grep -q NVIDIA; then 
        xrandr --setprovideroutputsource modesetting NVIDIA-0
        xrandr --auto
else
        rmmod nvidia_drm
        rmmod nvidia_modeset
        rmmod nvidia
        echo OFF > /proc/acpi/bbswitch
fi
}}

Now install these various configuration files:

{{FileBox|filename=/etc/X11/xorg.conf.intel|1=
Section "Device"
	Identifier "Intel Graphics"
	Driver "intel"
EndSection
}}

{{FileBox|filename=/etc/X11/xorg.conf.nvidia|1=
Section "Device"
	Identifier "NVIDIA Graphics"
	Driver "nvidia"
	BusID "PCI:1:0:0"
	Option "AllowEmptyInitialConfiguration"
	Option "Coolbits" "28"
	Option "NoLogo" "1"
EndSection

Section "Module"
	Load "modesetting"
EndSection
}}

If you're using <tt>mpv</tt>:

{{FileBox|filename=/etc/mpv/mpv.conf.intel|1=
vo=vaapi
}}
{{FileBox|filename=/etc/mpv/mpv.conf.nvidia|1=
vo=vdpau
}}

Finally, add this script, and remember to <tt>chmod +x</tt>:

{{CodeBox|filename=/usr/local/bin/nvidia|lang=bash|1=
#!/bin/bash

[[ $UID != 0 ]] && exec sudo "$0" "$@"

on() {
        eselect opengl set nvidia
        eselect opencl set nvidia
        ln -svfn xorg.conf.nvidia /etc/X11/xorg.conf
        ln -svnf mpv.conf.nvidia /etc/mpv/mpv.conf
        echo ON > /proc/acpi/bbswitch
}

off() {
        eselect opengl set xorg-x11
        eselect opencl set intel
        ln -svfn xorg.conf.intel /etc/X11/xorg.conf
        ln -svnf mpv.conf.intel /etc/mpv/mpv.conf
}

case "$1" in
        on) on ;;
        off) off ;;
        *) echo "Usage: $0 on{{!}}off" >&2 ;;
esac
}}

Mark this executable and enable the Intel card to start:

{{RootCmd| chmod +x /usr/local/bin/nvidia | nvidia off}}

When you want to use the NVIDIA card, simply run this command with <tt>on</tt> and restart sddm:

{{RootCmd| nvidia on | systemctl restart sddm}}

When you want to use the Intel card, simply run this command with <tt>off</tt> and restart sddm:

{{RootCmd| nvidia off | systemctl restart sddm}}

Note that you'll need to use the NVIDIA card in order to drive external displays.

=== Remapping useless FN keys ===

The keys {{key|FN}}-{{key|F9}} to {{key|FN}}-{{key|F12}} aren't particularly useful out of the box. A nice application is to (low level) remap the keys to media buttons. This can be done via udev:

{{FileBox|filename=/etc/udev/hwdb.d/99-keyboard.hwdb|1=
# thinkpad_acpi driver
evdev:name:ThinkPad Extra Buttons:dmi:bvn*:bvr*:bd*:svnLENOVO*:pn*
 KEYBOARD_KEY_1c=playpause
 KEYBOARD_KEY_1d=stopcd
 KEYBOARD_KEY_1e=previoussong
 KEYBOARD_KEY_1f=nextsong
}}
and reload the hwdb database:
{{RootCmd| udevadm hwdb --update | udevadm trigger | udevadm control --reload}}
If this doesn't work, reboot.

==== Toggle touchpad with FN+F4 ====

To toggle the touchpad with {{key|FN}}+{{key|F4}} add an additional line:

{{FileBox|filename=/etc/udev/hwdb.d/99-keyboard.hwdb|1=
evdev:name:ThinkPad Extra Buttons:dmi:bvn*:bvr*:bd*:svnLENOVO*:pn*
 KEYBOARD_KEY_1a=f21
}}

=== Thunderbolt connector ===

=== TPM (and suspend/resume) ===
A common problem can be encountered if the TPM chip has been activated in UEFI/BIOS. If the kernel lacks the necessary drivers the system freezes when attempting to resume from a suspend. Simply configuring the kernel with TPM supports resolves the problem:

{{KernelBox|title=TPM|1=<pre>
Device Drivers  --->
    Character Devices  --->
        [*] TPM Hardware Support --->
            [*] TPM Interface Specification 1.2 Interface / TPM 2.0 FIFO Interface
</pre>}}

[[Category:Laptops]]
