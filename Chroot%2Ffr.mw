<languages />

{{InfoBox stack
|{{InfoBox wikipedia|header=true}}
}}

Chroot ('''Ch'''ange '''root''') est un utilitaire système Unix utiliser pour changer le répertoire racine (root) apparent en vue de créer un nouvel environnement logiquement séparé du répertoire racine principal du système. Ce nouvel environnement est aussi connu sous le nom de  « prison Chroot » (Chroot jail). Un utilisateur opérant dans la prison ne peut ni voir, ni accéder aux fichiers placés en dehors de l'environnement dans lequel il a été enfermé.

Une des utilisations principales du changement de racine est de créer un système Linux séparé au dessus du système courant dans un but de test ou de compatibilité logicielle. Chroot est souvent considéré comme une alternative légère à la virtualisation car le système peut fonctionner sans la surcharge d'un hyperviseur.

== Prérequis ==

=== Mettre l'environnement en place ===

Lorsque l'on crée une nouvelle configuration chroot la première nécessité est de disposer d'un répertoire où le nouvel environnement résidera, par exemple dans {{Path|/mnt/mychroot}} :

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

Pour monter une installation existante à partir d'une partition, la commande suivante peut être utilisée.Assurez-vous de remplacer <code><DEVICE></code> dans l’exemple ci-dessous par le "disque" et la partition de l’installation utiliser.

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/<DEVIC>  /mnt/mychroot
}}

Si une installation a été crée antérieurement dans un sous-répertoire de la racine actuelle du fichier système, les étapes citées précédemment peuvent être omises.

===Dépaqueter les fichiers système et l'arbre de Portage  (nouvelles installations) ===

Lors de la construction d'une nouvelle installation, l'étape suivante est de télécharger l'archive d'étape 3 et l'archive Portage et de les installer dans l'emplacement de la nouvelle racine.
Pour une information plus complète sur ce processus, consulter 
[[Handbook:AMD64/Installation/Stage#Downloading_the_stage_tarball|Downloading the stage tarball]] and [[Handbook:AMD64/Installation/Stage#Unpacking_the_stage_tarball|Unpacking the stage tarball]] dans le manuel Gentoo [[Handbook:Main_Page|Handbook]].

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/current-stage3/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

== Configuration ==

Avant d'entrer dans le nouvel environnement, un certain nombre de répertoires doivent être montés.

{{RootCmd
|mount --rbind /dev /mnt/mychroot/dev
|mount --make-rslave /mnt/mychroot/dev
|mount -t proc /proc /mnt/mychroot/proc
|mount --rbind /sys /mnt/mychroot/sys
|mount --make-rslave /mnt/mychroot/sys
|mount --rbind /tmp /mnt/mychroot/tmp
}}

Des fichiers de configuration basiques doivent être recopiés de l'hôte, ne recopiez pas {{Path|make.conf}} quand vous utilisez une installation existante.

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # If you use an existing installation, skip this command.
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

== Usage ==

Une fois ces opérations terminées, entrez dans le nouvel environnement chroot en exécutant ces commandes:

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

Lors de la création d'une nouvelle installation, Portage doit être synchronisé pour être sûr que tout est à jour.

{{RootCmd
|emerge --sync
}}

The system is now ready; feel free to install software, mess with settings, test experimental packages and configurations without having any effect on the main system. To leave the chroot simply type {{c|exit}} or press {{Key|Ctrl}}+{{Key|d}}. Doing so will return the console back to the normal environment. Do not forget to {{c|umount}} the directories that have been mounted.

=== Scripts d'initialisation ===

If setting up chroots is a task that is needed to be performed often, it is possible to speed up the mounting of the directories by using an init script. The script could be added to the default runlevel and therefore set up automatically on system boot:

{{FileBox|filename=/etc/init.d/mychroot|lang=bash|1=
#!/sbin/openrc-run
 
depend() {
   need localmount
   need bootmisc
}
 
start() {
     ebegin "Mounting chroot directories"
     mount -o rbind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}
 
stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
}
}}

When using a different directory or partition, add the necessary mounting commands in the <code>start()</code> function and change {{Path|/mnt/chroot}} to the appropriate name.

== Voir aussi ==

* [[Project:X86/Chroot Guide|Chroot Guide]]
* [[Chrooting_proxy_services|Chrooting proxy services]]


[[Category:Core system]]
