<languages />
{{Metadata|abstract=Portage ofrece soporte para la construcción e instalación de paquetes binarios. Esta guía detalla cómo crear servidores de paquetes binarios y cómo utilizar estos paquetes.}}

Aparte del soporte usual para ebuilds, Portage ofrece soporte para construir e instalar paquetes binarios.
Esta guía explica cómo crearlos, cómo instalarlos y cómo poner en marcha un servidor de paquetes binarios.

== Introducción ==

Hay muchas razones por la que a los administradores de sistemas les gusta utilizar instalaciones de paquetes binarios en Gentoo.

# En primer lugar, permite a los administradores '' mantener los sistemas similares actualizados''. Compilar todo desde el código fuente puede llevar mucho tiempo. El mantenimiento de varios sistemas similares, probablemente algunos de ellos con hardware antiguo, puede ser mucho más fácil si sólo un sistema tiene que compilar todo desde el código fuente y el resto de sistemas reutilizan los paquetes binarios.
# Una segunda razón es para ''hacer actualizaciones seguras''. Para los sistemas de misión crítica, es importante mantenerse ''utilizable'' la mayor parte del tiempo posible. Esto se puede hacerse por un servidor de ensayo que realiza todas las actualizaciones en sí mismo en primer lugar. Una vez que el servidor de ensayo se encuentra en un buen estado, las actualizaciones se pueden aplicar a los sistemas críticos. Una variante de este enfoque es hacer los cambios en un entorno chroot en el mismo sistema y utilizar los binarios creados allí en el sistema real.
# Una tercera razón es ''a modo de copia de seguridad''. A menudo, los paquetes binarios son la única forma de recuperar un sistema que no funciona (por ejemplo, el compilador no funciona). Tener los binarios pre-compilados a mano ya sea en un servidor de paquetes binarios o localmente puede ser de gran ayuda en caso de que se rompa que cadena de herramientas.
# Por último, también permite ''la actualización de los sistemas muy antiguos ''. La tarea de actualizar sistemas muy antiguos se puede aliviar en gran medida el uso de paquetes binarios. Por lo general es útil para instalar paquetes binarios en los sistemas antiguos, ya que no requieren de dependencias en tiempo de compilación para instalarse o actualizarse. Los paquetes binarios también evitan fallos de los procesos de construcción, ya que están precompilados.

Este guía se centra en las siguientes cuestiones:
* Cómo crear paquetes binarios
* Cómo distribuir estos paquetes a los clientes
* Cómo utilizar los paquetes binarios
* Cómo mantener los paquetes binarios

Casi al final se tratan algunos temas avanzados sobre cómo tratar con los paquetes binarios.

{{Note|Todas las herramientas utilizadas en esta guía forma parte de {{Package|sys-apps/portage}} a menos que se diga lo contrario.}}

== Crear paquetes binarios ==

Hay tres formas principales para la creación de paquetes binarios:
# Después de una instalación normal, utilizando la aplicación <tt>quickpkg</tt>
# Explícitamente durante una operación emerge utilizando la opción <code>--buildpkg (-b)</code>
# Automáticamente mediante el uso de <code>buildpkg</code> como una característica de Portage.

Los tres métodos crearán un paquete binario en el directorio al que apunta la variable <code>PKGDIR</code> (cuyo valor por defecto es {{Path|/usr/portage/packages}}).

=== Utilizar quickpkg ===

La aplicación <tt>quickpkg</tt> toma como argumentos uno o más átomos de dependencia (o conjuntos de paquetes) y crea paquetes binarios para todos los paquetes ''instalados'' que concuerdan con ese átomo.

Por ejemplo, para crear paquetes binarios de todas las versiones de GCC ''instaladas'':

{{RootCmd|quickpkg sys-devel/gcc}}

Para crear paquetes binarios de todos los paquetes instalados en el sistema, utilice la expresión <code>*</code>:

{{RootCmd|quickpkg "*/*"}}

Una advertencia sobre el uso de este método: Se basa en los archivos instalados, lo cual puede ser un problema en el caso de archivos de configuración. Los administradores suelen cambiar los archivos de configuración después de instalar el software. Debido a que esto podrían filtrarse datos importantes (incluso confidenciales) en los paquetes. Por defecto, <tt>quickpkg</tt>  ''no'' incluye archivos de configuración que están protegidos mediante el método <code>CONFIG_PROTECT</code>. Para forzar la inclusión de archivos de configuración, utilice las opciones <code>--include-config</code> o <code>--include-unmodified-config</code>.

=== Utilizar --buildpkg como opción de emerge ===

Cuando se instala software mediante <tt>emerge</tt>, se puede solicitar a Portage que cree paquetes binarios utilizando la opción <code>--buildpkg (-b)</code>:

{{Emerge|params+=--buildpkg|sys-devel/gcc}}

También es posible pedirle a Portage que ''únicamente'' cree los paquetes binarios pero que ''no'' instale el software en el sistema vivo. Para hacer esto se puede utilizar la opción  <code>--buildpkgonly (-B)</code>:

{{Emerge|params+=--buildpkgonly|sys-devel/gcc}}

El último enfoque requiere sin embargo que estén instaladas previamente todas las dependencias necesarias en el momento de la construcción.

=== Implementar buildpkg como una característica de Portage ===

La forma más común para crear automáticamente paquetes binarios cuando Portage instala un paquete es utilizar la característica <code>buildpkg</code>, que se puede configurar en {{Path|/etc/portage/make.conf}} de esta forma:

{{FileBox|filename=/etc/portage/make.conf|title=Habilitar la característica buildpkg de Portage's|lang=bash|1=
FEATURES="${FEATURES} buildpkg"
}}

Cuando se activa esta característica, cada vez que Portage instala software se creará también un paquete binario.

=== Evitar la creación de algunos paquetes ===

Es posible indicarle a Portage que no cree paquetes binarios para un grupo de paquetes o categorías seleccionados. Esto se hace pasando la opción <code>--buildpkg-exclude</code> a emerge:

{{RootCmd|emerge -uDN @world --buildpkg --buildpkg-exclude "virtual/* sys-kernel/*-sources"}}

Esto se podría utilizar para paquetes en los que se obtiene poco o ningún beneficio teniendo instalado el paquete binario disponible. Ejemplos de ello serían los paquetes fuentes del núcleo Linux o paquetes binarios de los desarrolladores del propio paquete (los que terminan en ''-bin'' como {{Package|www-client/firefox-bin}}).

== Poner en marcha un servidor de paquetes binarios ==

Portage ofrece el soporte de varios protocolos para la descarga de paquetes binarios: FTP, FTPS, HTTP, HTTPS y SSH. Esto deja espacio suficiente  para muchas formas de implementación del servidor.

No hay sin embargo un método "listo para funcionar" que ofrezca Portage para la distribución de paquetes binarios. Dependiendo de la configuración deseada, será necesario instalar software adicional.

=== Servidor de paquetes binarios basado en Web ===

Un forma común de distribución de paquetes binarios es la creación de un servidor de paquetes basado en web.

Utilice un servidor web como [[lighttpd]] ({{Package|www-servers/lighttpd}}) y configúrelo para ofrecer acceso de lectura a la localización definida en <code>PKGDIR</code> dentro del fichero {{Path|/etc/portage/make.conf}}.

{{FileBox|filename=/etc/lighttpd/lighttpd.conf|title=Ejemplo de configuración lighttpd|lang=bash|1=
# Añada esto al final de la configuración estándar
server.modules += ( "mod_alias" )
alias.url = ( "/packages" => "/usr/portage/packages/" )
}}

A continuación, en los equipos cliente, configure la variable <code>PORTAGE_BINHOST</code> apropiadamente:

{{FileBox|filename=/etc/portage/make.conf|title=Usar un servidor de paquetes binarios basado en web|lang=bash|1=
PORTAGE_BINHOST="http://binhost.genfic.com/Packages"
}}

=== Equipo de paquetes binarios con SSH ===

Para ofrecer un enfoque con mayor autenticación para los paquetes binarios, se puede considerar el uso de SSH.

Cuando se utiliza SSH es posible utilizar la clave SSH del usuario Linux de Portage (sin frase contraseña ya que se necesita realizar la instalación en segundo plano) para conectar a un equipo remoto con los paquetes binarios.

Para conseguir esto, asegúrese de que se permite usar la clave SSH del usuario Portage en el servidor:

{{RootCmd|cat portage.id_rsa.pub >> /home/binpkguser/.ssh/authorized_keys}}

El <code>PORTAGE_BINHOST</code> debería entonces tener el siguiente aspecto:

{{FileBox|filename=/etc/portage/make.conf|title=Ajustar PORTAGE_BINHOST para acceso SSH|lang=bash|1=
PORTAGE_BINHOST="ssh://usuariopqtbing@servidorbin/usr/portage/packages"
}}

=== Exportar mediante NFS ===

Cuando se utilizan paquetes binarios dentro de una red internt, puede que se más sencillo exportar los paquetes mediante NFS y montarlo en los clientes.

El fichero {{Path|/etc/exports}} debería tener el siguiente aspecto:

{{FileBox|filename=/etc/exports|title=Exportar el directorio de paquetes|1=
/usr/portage/packages                            2001:db8:81:e2::/48(ro,no_subtree_check,root_squash) 192.168.100.1/24(ro,no_subtree_check,root_squash)
}}

En los clientes, se puede ahora montar la localización. Un ejemplo de entrada {{Path|/etc/fstab}} podría ser este:

{{FileBox|filename=/etc/fstab|title=Entrada para montar la carpeta que contiene los paquetes|1=
binhost:/usr/portage/packages      /usr/portage/packages    nfs    defaults    0 0
}}


== Utilizar paquetes binarios ==

Para que los paquetes binarios se puedan utilizar en otros sistemas, deben cumplir algunos requisitos.
* La arquitectura del cliente y del servidor y su  [[CHOST]] deben coincidir.
* El ajuste <code>CFLAGS</code> y el <code>CXXFLAGS</code> que se utilzaron para construir los paquetes binarios deben ser compatibles con todos los clientes.
* Los ajustes USE de características específicas del procesador (como MMX, SSE,...) deben seleccionarse con cuidado ya que todos los clientes deben ofrecer soporte para ellos.

{{Important|Portage no puede validar si se cumplen estos requisitos, esto es responsabilidad del administrador del sistema.}}

Aparte de esto, Portage comprobará si el paquete binario se construye utilizando los mismos ajustes USE que se esperan en el cliente. Si se construye un paquete con una combinación distinta de ajustes USE, Portage, bien ignorará el paquete binario (y utilizará un ebuild basado en fuentes), bien fallará, dependiendo de las opciones que se pasen a la orden emerge cuando se invoque (leer [[#Instalar_paquetes_binarios|Instalar paquetes binarios]]).

En los cliente se requieren algunos cambios en la configuración para poder utilizar paquetes binarios.

=== Instalar paquetes binarios ===

Se necesitan algunas opciones para pasar a la orden <tt>emerge</tt> que informará a Portage sobre el uso de paquetes binarios:

{| class="wikitable"
|-
! Opción !! Descripción
|-
| <code>---usepkg (-k)</code> || Intenta utilizar el o los paquetes binarios en el directorio local {{Path|packages}}. Es útil cuando se utilizan servidores de paquetes binarios que permitan montar [[NFS]] o [[SSHFS]]. Si no se encuentran los paquetes binarios solicitados, se realizará una instalación regular (basada en fuentes) .
|-
| <code>--usepkgonly (-K)</code> || Es similar a <code>--usepkg (-k)</code> pero fallará si no se encuentra el paquete binario solicitado. Esta opción es útil únicamente si se van a utilizar paquetes binarios ''preconstruidos''.
|-
| <code>--getbinpkg (-g)</code> || Descarga el o los paquetes binarios desde un servidor remote. Si no se encuentran los paquetes binarios solicitados, se realizará una instalación regular (basada en fuentes).
|-
| <code>--getbinpkgonly (-G)</code> || Es similar a <code>--getbinpkg (-g)</code> pero fallará si no se pueden descargar el o los paquetes binarios. Esta opción es útil solo si se van a utilizar paquetes binarios ''preconstruidos''.
|}

Para utilizar instalaciones basadas en paquetes binarios de forma automática, se puede añadir la opción elegida a la variable <code>EMERGE_DEFAULT_OPTS</code>:

{{FileBox|filename=/etc/portage/make.conf|title=Obtener los paquetes binarios de forma automática y fallar si no están disponibles|lang=bash|1=
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --getbinpkgonly"
}}

Hay una característica (FEATURE) de Portage que implementa automáticamente el equivalente a <code>--getbinpkg (-g)</code> sin tener que actualizar la variable <code>EMERGE_DEFAULT_OPTS</code>: ''getbinpkg''.

{{FileBox|filename=/etc/portage/make.conf|title=Habilitar getbinpkg como una característica de Portage|lang=bash|1=
FEATURES="${FEATURES} getbinpkg"
}}

=== Obtener paquetes desde un servidor de paquetes binarios ===

Cuando se utiliza una gran cantidad de servidores de paquetes binarios, los clientes necesitan tener definida la variable <code>PORTAGE_BINHOST</code>. De otro modo el cliente no sabrá dónde se almacenan los paquetes binarios lo que resultará en que Portage no podrá recuperarlos.

{{FileBox|filename=/etc/portage/make.conf|title=Ajustar PORTAGE_BINHOST|lang=bash|1=
PORTAGE_BINHOST="http://binhost.genfic.com/packages"
}}

La variable <code>PORTAGE_BINHOST</code> utiliza una lista de URIs separada por espacios. Esto permite a los administradores utilizar varios servidores de paquetes binarios de forma simultánea. El URI siempre debe apuntar al directorio en el que el reside el fichero {{Path|Packages}}.

{{Note|El soporte para múltiples servidores de paquetes binarios está algo incompleto. Si varios servidores ofrecen un paquete binario para la misma versión del mismo, entonces se considerará sólo el primero. Esto puede ser un problema cuando estos paquetes binarios difieren en su configuración <code>USE</code> y la configuración <code>USE</code> de un paquete binario más reciente coincidiera con la configuración de los sistemas.}}

=== Reinstalar paquetes binarios modificados ===

Si se pasa la opción <code>--rebuilt-binaries</code> a emerge se reinstalarán todos los paquetes que se han reconstruido desde que se instaló el paquete. Esto es útil en caso de que se utilicen herramientas de reconstrucción como <tt>revdep-rebuild</tt> o <tt>python-updater</ tt> en el servidor paquete binario.

Una opción relacionada es <code>--rebuilt-binaries-timestamp</code>. Hace que emerge no considere los paquetes binarios para una reinstalar si esos paquetes binarios se han reconstruido antes de la marca de tiempo dada. Esto es útil para evitar la reinstalación de todos los paquetes, si el servidor de paquetes binarios se tuvo que reconstruir desde cero, de lo contrario utilice <code>--rebuilt-binaries</code>.

=== Ajustes adicionales en el cliente ===

Next to the ''getbinpkg'' feature, Portage also listens to the ''binpkg-logs'' feature. This one controls if log files for successful binary package installations should be kept. It is only relevant if <code>PORT_LOGDIR</code> is set and is enabled by default.

Similar to excluding binary packages for a certain set of packages or categories, clients can be configured to exclude binary package installations for a certain set of packages or categories.

To accomplish this, use the <code>--usepkg-exclude</code> option:

{{RootCmd|emerge -uDNg @world --usepkg-exclude "sys-kernel/gentoo-sources virtual/*"}}


== Maintaining binary packages ==

Exporting and distributing the binary packages will lead to useless storage consumption if the binary package list is not actively maintained.

=== Removing outdated binary packages ===

In the {{Package|app-portage/gentoolkit}} package an application called <tt>eclean</tt> is provided. It allows for maintaining Portage-related variable files, such as downloaded source code files, but also binary packages.

The following command will remove all binary packages that have no corresponding ebuild:

{{RootCmd|eclean packages}}

For more details please read the [[Eclean]] article.

Another tool that can be used is the <tt>qpkg</tt> tool from the {{Package|app-portage/portage-utils}}. However, this tool is a bit less configurable.

To clean up ''unused'' binary packages (in the sense of used by the server on which the binary packages are stored):

{{RootCmd|qpkg -c}}

=== Maintaining the Packages file ===

Inside the packages directory, a file called {{Path|Packages}} exists. This file acts as a cache for the metadata of all binary packages in the packages directory. The file is updated whenever Portage adds a binary package to the directory. Similarly, <tt>eclean</tt> updates it when it removes binary packages.

If for some reason binary packages are simply deleted or copied into the packages directory, or the {{Path|Packages}} file gets corrupted or deleted, then it must be recreated. This is done using <tt>emaint</tt> command:

{{RootCmd|emaint binhost --fix}}

== Advanced topics==

=== Creating snapshots of the packages directory ===

When deploying binary packages for a large number of client systems it might become worthwhile to create snapshots of the packages directory. The client systems then do not use the packages directory directly but use binary packages from the snapshot.

Snapshots can be created using the {{Path|/usr/lib64/portage/python2.7/binhost-snapshot}} or {{Path|/usr/lib64/portage/python3.3/binhost-snapshot}} tool. It takes four arguments, 
# A source directory (the path to the packages directory); 
# A target directory (that must not exist);
# A URI;
# A binary package server directory.

The files from the package directory are copied to the target directory. A {{Path|Packages}} file is then created inside the binary package server directory (fourth argument) with the provided URI.

Client systems need to use an URI that points to the binary package server directory. From there they will be redirected to the URI that was given to <tt>binhost-snapshot</tt>. This URI has to refer to the target directory.

=== Understanding the binary package format ===

Binary packages created by Portage have the file name ending with "tbz2". These files consist of two parts:
# A .tar.bz2 archive containing the files that will be installed on the system;
# A xpak archive containing package metadata, the ebuild and the environment file.

La descripción del formato se puede leer en <kbd>man xpak</kbd>.

Hay algunas herramientas en {{Package|app-portage/portage-utils}} que sirven para trocear o crear ficheros tbz2 y xpak.

The following command will split the tbz2 into a {{Path|.tar.bz2}} and an {{Path|.xpak}} file:

{{Cmd|qtbz2 -s <paquete>.tbz2}}

The xpak file can be examined using the <tt>qxpak</tt> utility.

Para listar los contenidos:

{{Cmd|qxpak -l <paquete>.xpak}}

The next command will extract a file called {{Path|USE}} which contains the enabled USE flags for this package:

{{Cmd|qxpak -x package-manager-0.xpak USE}}

=== The PKGDIR layout ===

The currently used format version 2 has the following layout:

{{CodeBox|title=Plantilla de directorio de paquetes (version 2)|1=
PKGDIR
`+- Packages
 +- app-accessibility/
 {{!}}  +- pkg1-version.tbz2
 {{!}}  `- pkgN-version.tbz2
 +- app-admin/
 {{!}}  `- ...
 `- ...
}}

The {{Path|Packages}} is the major improvement (and also the trigger for Portage to know that the binary package directory uses version 2) over the first binary package directory layout (version 1). In version 1, all binary packages were also hosted inside a single directory (called {{Path|All/}}) and the category directories only had symbolic links to the binary packages inside the {{Path|All/}} directory.

=== Unpacking with quickunpkg ===

Zoobab wrote a simple shell tool named [https://github.com/zoobab/quickunpkg quickunpkg] to quickly unpack tbz2 files.


[[Category:Portage]]
