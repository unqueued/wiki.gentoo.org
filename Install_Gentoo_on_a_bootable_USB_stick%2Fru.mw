<languages />
На самом деле, загрузить Gentoo с USB-флешки довольно просто. Основная сложность состоит в том, чтобы настроить исходный диск и включить драйверы для всех машин, на которых она собирается загружаться. В этой статье описывается как установить Gentoo на флешку, способную загрузиться на любом компьютере, что будет похоже на обычную настольную установку, где система ещё долго не будет изменяться.

=== Приготовления ===

{{Note|Руководство предполагает, что текущей платформой является Gentoo Linux. Большинство шагов, однако же, могут быть выполнены для любого дистрибутива, просто переведите присущие приёмы работы с Gentoo (например, установка программного обеспечения) на приёмы другого дистрибутива.}}

Начнём с установки пары необходимых пакетов. Наиболее важные - ядро и {{package|sys-kernel/genkernel}}:

{{emerge|sys-kernel/gentoo-sources sys-kernel/genkernel}}

Чтобы добавить специфичные для пакета USE-флаги, создайте новый файл в {{path|/etc/portage/package.use/}}:

{{FileBox|filename=/etc/portage/package.use/sys-apps|1=
sys-apps/busybox static
}}

Далее установите {{Package|sys-apps/busybox}}:

{{emerge|sys-apps/busybox}}

== Сборка ядра ==

Сделайте необходимые изменения в ядре и соберите его. Смотрите статьи [[Handbook:AMD64/Installation/Kernel/ru|настройку ядра Linux]] и [[Kernel/Configuration/ru|конфиурацию ядра]], чтобы узнать больше подробностей об этом шаге. Важно помнить, что здесь лучше всего подходит обобщённое ядро, потому что чем оно более общее, тем больше машин будет загружаться с ним.

В ходе настройки, возможно скомпилировать модули и включить их в [[initramfs]]. Они будут загружаться при загрузке.

{{RootCmd|mkdir /tmp/boot
|genkernel --firmware --busybox --disklabel --bootdir{{=}}/tmp/boot --no-symlink --all-ramdisk-modules --install all
}}

Команда выше займёт некоторое время на установку стандартного ядра, создание диска и копирования файлов в {{path|/tmp/boot}}.

{{RootCmd|ls /tmp/boot/
|output=<pre>
initramfs-genkernel-x86_64-3.5.2-gentoo
kernel-genkernel-x86_64-3.5.2-gentoo
System.map-genkernel-x86_64-3.5.2-gentoo
</pre>}}

== Приготовление USB-флэшки ==

Create 2 partitions on the drive (assuming the installation will have a {{path|/boot}} and a {{path|/}} (root) partition). We assume that the USB stick is at {{path|/dev/sdb}} (run {{c|dmesg}} immediately after plugging in the USB stick to see which device is being used).

{{RootCmd|fdisk /dev/sdb|output=<pre>
Command (m for help): d
Selected partition 1
 
Command (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
Partition number (1-4, default 1): 1
First sector (2048-4001759, default 2048): 
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-4001759, default 4001759): +100M
 
Command (m for help): n
Partition type:
   p   primary (1 primary, 0 extended, 3 free)
   e   extended
Select (default p): p
Partition number (1-4, default 2):  
Using default value 2
First sector (206848-4001759, default 206848): 
Using default value 206848
Last sector, +sectors or +size{K,M,G} (206848-4001759, default 4001759): 
Using default value 4001759
 
Command (m for help): a
Partition number (1-4): 1
 
Command (m for help): p
 
Disk /dev/sdb: 2048 MB, 2048901120 bytes
255 heads, 63 sectors/track, 249 cylinders, total 4001760 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x001663df
 
   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1   *        2048      206847      102400   83  Linux
/dev/sdb2          206848     4001759     1897456   83  Linux
 
Command (m for help): w
The partition table has been altered!
 
Calling ioctl() to re-read partition table.
Syncing disks.
</pre>}}

Убедитесь, что первый раздел - загрузочный (загрузочный флаг включается командой).

Now format the new partitions. In the example we use the ext2 file system but another file system for the {{Path|/}} partition can be used if it is supported in the kernel. Notice that during the formatting operation, a label is assigned to the partitions. This is important because it will be how the root file system is detected later as the USB stick can be booted on systems where the drive letter allocation is completely different. This is related to the <code>--disklabel</code> option of the {{c|genkernel}} command line earlier.

{{RootCmd|mkfs.ext2 -L GENTOO_USB_BOOT /dev/sdb1
|mkfs.ext2 -L GENTOO_USB_ROOT /dev/sdb2}}

== Установка Gentoo stage 3 ==

С готовыми ядром, диском и файловыми системами, нам осталось выполнить минимальную установку. В том числе свежие stage3 и снимок дерева Portage.

* [http://distfiles.gentoo.org/releases/amd64/autobuilds/current-stage3-amd64/ current-stage3-amd64]
* [http://distfiles.gentoo.org/releases/snapshots/current/portage-latest.tar.xz portage-latest]

Для примера используется {{Path|stage3-amd64-20120621.tar.bz2}} и {{Path|portage-latest.tar.xz}}. Далее немного из руководства по установке Gentoo.

{{RootCmd|mount /dev/sdb2 /mnt/gentoo
|cd /mnt/gentoo
|tar -xpf ~/Download/stage3-amd64-20120621.tar.bz2
|cd usr
|tar -xpf ~/Download/portage-latest.tar.xz
|mount /dev/sdb1 /mnt/gentoo/boot
|cp /tmp/boot/* /mnt/gentoo/boot}}

В нижеследующих разделах охватываются частности Gentoo Linux, специфичные для установки на USB-флешку. Советуем использовать [[Handbook:Main_Page|Gentoo handbook]], при чтении этой статьи.

=== Загрузчик ===

Для того, чтобы загрузить новую систему, установите загрузчик на USB-флешку.

The below sections give example configurations for [[LILO|lilo]] and [[syslinux]].

==== lilo ====

Emerge [[LILO|lilo]] (from within the chroot):

{{RootCmd|prompt=(chroot) #|emerge sys-boot/lilo}}

Исправьте {{path|etc/lilo.conf}} таким образом, чтобы он содержал правильную информацию.

{{Warning|Эти настройки очень важны и будут рассматриваться построчно.}}

{{FileBox|filename=/etc/lilo.conf|title=Configure lilo.conf|1=
boot=/dev/sdb              # The location of the USB Stick (currently)
lba32                      # use lba32 addressing (ignore)
compact                    # boot quickly by loading lots of blocks
                           # remove when there are problems with booting
prompt                     # Prompt for user input
timeout=20                 # Time to wait before default selection
default="Gentoo-352"       # Default selection after timeout
  
image=/boot/kernel-genkernel-x86_64-3.5.2-gentoo
	label="Gentoo-352"
	read-only
	root=/dev/ram0
	append="real_root=LABEL=GENTOO_USB_ROOT scandelay=5"
	initrd=/boot/initramfs-genkernel-x86_64-3.5.2-gentoo
}}

Строки после image - просты, но дополнительная строка содержит некоторые интересные опции.

* <code>real_root=LABEL=GENTOO_USB_ROOT</code> will use the label of the disk instead of {{path|/dev/sdb2}} which is important because these device numbers move around depending on the number of hard disks in the computer or number of USB disk drives.
* Also important for USB booting is the <code>scandelay</code> option, as USB devices need a little time to be detected by the kernel; that is what this option is for. When there are lots of modules booting takes a long time so it probably does not matter, but if there are only a few modules loaded then it is important, because the system could have booted before the kernel detects the USB device. Also, on newer machines with USB3 controllers it is necessary to add the <code>xhci_hcd</code> driver (built into the kernel or as a module).

Теперь установим LILO (с настройками) на USB-флешку:

{{RootCmd|prompt=(chroot) #|lilo|output=<pre>
Warning: /dev/sdb is not on the first disk
Warning: The initial RAM disk is too big to fit between the kernel and
   the 15M-16M memory hole.  It will be loaded in the highest memory as
   though the configuration file specified "large-memory" and it will
   be assumed that the BIOS supports memory moves above 16M.
Added Gentoo-352 ? *
2 warnings were issued.</pre>}}

Первое предупреждение, как и ожидалось, из-за того, что мы устанавливаем загрузчик не на жесткий диск. Второе предупреждение говорит о возможных проблемах на старых машинах, если же это важно, то попробуйте сократить ядро посредством удаления модулей.

==== syslinux ====

{{Warning|На данный момент syslinux работает только с файловыми системами ext{2,3,4}, btrfs, ntfs и fat.}}

{{RootCmd|prompt=(chroot) #|emerge syslinux}}

Запишите загрузочный сектор на USB-флешку.

{{RootCmd|prompt=(chroot) #|dd bs{{=}}440 count{{=}}1 conv{{=}}notrunc if{{=}}/usr/share/syslinux/mbr.bin of{{=}}/dev/sdb}}

Теперь настроим загрузчик.

{{RootCmd|prompt=(chroot) #|mkdir /boot/syslinux|nano -w /boot/syslinux/syslinux.cfg}}

{{FileBox|filename=/boot/syslinux/syslinux.cfg|1=
PROMPT 1
TIMEOUT 50
DEFAULT gentoo
 
LABEL gentoo
        LINUX ../kernel-genkernel-x86_64-3.5.2-gentoo
        APPEND root=LABEL=GENTOO_USB_ROOT scandelay=3 ro
        INITRD ../initramfs-genkernel-x86_64-3.5.2-gentoo
}}

{{Note|<code>ro</code>, что находится в приведенной выше строке <code>APPEND</code>, будет устанавливать корневой раздел только для чтения (что обычно предпочтительнее для USB-флешки). Замена <code>ro</code> на <code>rw</code> позволяет системе изменяться после загрузки (вместо того, чтобы пользователь монтировал файловую систему на чтение и запись позже).}}

Далее установим syslinux на USB-флешку. Однако опция <code>--device /dev/sdb1</code> не обязательна.

{{RootCmd|prompt=(chroot) #|extlinux --device /dev/sdb1 --install /boot/syslinux }}

=== fstab ===

{{FileBox|filename=/etc/fstab|title=Настроим fstab для работы с метками|1=
LABEL=GENTOO_USB_BOOT   /boot           ext2            noauto,noatime  1 2
LABEL=GENTOO_USB_ROOT   /               ext2            noatime         0 1
/dev/SWAP               none            swap            sw              0 0
/dev/cdrom              /mnt/cdrom      auto            noauto,ro       0 0
/dev/fd0                /mnt/floppy     auto            noauto          0 0
}}

== Советы и хитрости ==

Несмотря на то, что уже можно использовать только что сделанную систему в качестве стандартной Gentoo, было бы целесообразнее собрать бинарные пакеты непосредственно на хосте, а затем установить их на USB-флешку. Или, если система имеет достаточно памяти, просто примонтировать {{Path|/var/tmp}} к TMPFS - компиляция, так или иначе, будет идти намного быстрей!


[[Category:Core system]]
