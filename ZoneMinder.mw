{{InfoBox stack
|{{InfoBox homepage|https://www.zoneminder.com|header="true"}}
|{{InfoBox wikipedia}}
}}

'''ZoneMinder''' Capture, analyse, record and monitor any cameras attached to your system.

== Installation ==

=== Dependencies ===

{{Important|The following required packages must be configured properly for ZoneMinder to work.}}

* Apache 2: [[Apache2|www-servers/apache]]
* MySQL: [[MySQL|dev-db/mariadb]]
* PHP: [[PHP|dev-lang/php]]

=== USE flags ===

Enable the following USE flags for {{Package|dev-lang/php}}, {{Package|app-eselect/eselect-php}} and {{Package|www-misc/zoneminder}}:

{{FileBox|filename=/etc/portage/package.use|1=
dev-lang/php apache2 cgi fpm inifile pdo mysql mysqli sockets
app-eselect/eselect-php apache2 fpm
www-misc/zoneminder curl ffmpeg ssl
}}

=== Emerge ===

All ZoneMinder builds are currently masked and need to be unmasked:

{{FileBox|filename=/etc/portage/package.accept_keywords|1=
www-misc/zoneminder ~amd64
}}


Install ZoneMinder:

{{Emerge|www-misc/zoneminder}}

== Configuration ==

=== Apache ===

* Select correct version of PHP:

{{RootCmd|eselect php list apache2|output=<pre>
  [1]   php7.0 *
</pre>}}

* Edit {{Path|/etc/php/apache2-php7.0/php.ini}} to reflect the following:

{{FileBox|filename=/etc/php/apache2-php7.0/php.ini|lang=ini|1=
short_open_tag = On
date.timezone = <Country/City>
}}

* Edit {{Path|/etc/conf.d/apache2}} and add <code>-D PHP -D PROXY</code> to <var>APACHE2_OPTS</var>:

{{FileBox|filename=/etc/conf.d/apache2|lang=bash|1=
APACHE2_OPTS="-D DEFAULT_VHOST -D INFO -D SSL -D SSL_DEFAULT_VHOST -D LANGUAGE -D PHP -D PROXY"
}}

* Create an Apache vhost in {{Path|/etc/apache2/vhosts.d/10_zoneminder.conf}}

{{FileBox|filename=/etc/apache2/vhosts.d/10_zoneminder.conf|1=
ScriptAlias /zm/cgi-bin/ "/usr/libexec/zoneminder/cgi-bin/"

<Directory "/usr/libexec/zoneminder/cgi-bin">
  AllowOverride All
  Options +ExecCGI
  Require all granted
</Directory>

Alias /zm "/usr/share/zoneminder/www"

<Directory "/usr/share/zoneminder/www">
  Options -Indexes +MultiViews +FollowSymLinks
  AllowOverride All
  Require all granted
</Directory>

}}

=== MySQL ===

* Create ZoneMinder's database, <code>zm</code>, and setup a new user <code>zmuser</code>.

{{RootCmd|mysql -p|output=<pre>
mysql> create database zm;

mysql> grant select,insert,update,alter,lock tables,delete on zm.* to 'zmuser'@localhost identified by 'zmpass';
Query OK, 0 rows affected (0.00 sec)

mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)

mysql> exit;
</pre>}}

* Import the database schema and base data, the {{Path|.sql}} script is created by the configure phase above, so make sure you do that first.

{{RootCmd|mysql -p zm < /usr/share/zoneminder/db/zm_create.sql}}

=== ZoneMinder ===

* Edit {{Path|/etc/zm.conf}} and add the above MySQL database username and password:

{{FileBox|filename=/etc/zm.conf|lang=bash|1=
# ZoneMinder database user
ZM_DB_USER=zmuser

# ZoneMinder database password
ZM_DB_PASS=zmpass
}}

* By default {{Package|www-misc/zoneminder}} installs as a virtual host under {{Path|http://cctvhost.domain/zm/}} - this requires <var>PATH_ZMS</var> to be updated in the webui:
  Options -> Paths -> PATH_ZMS = /zm/cgi-bin/zms

== Init ==

=== OpenRC ===

Add Apache to the default runlevel and start:

{{RootCmd
|rc-update add apache2 default
|/etc/init.d/apache2 start
}}

Add PHP to the default runlevel and start:

{{RootCmd
|rc-update add php-fpm default
|/etc/init.d/php-fpm start
}}

Add MySQL to the default runlevel and start:

{{RootCmd
|rc-update add mysql default
|/etc/init.d/mysql start
}}

Add ZoneMinder to the default runlevel and start:

{{RootCmd
|rc-update add zoneminder default
|/etc/init.d/zoneminder start
}}

=== systemd ===

Add Apache to startup and start:

{{RootCmd
|systemctl start apache2
|systemctl enable apache2
}}

Add PHP to startup and start:

{{RootCmd
|systemctl start php-fpm
|systemctl enable php-fpm
}}

Add MySQL to startup and start:

{{RootCmd
|systemctl start mysql
|systemctl enable mysql
}}

Add ZoneMinder to startup and start:

{{RootCmd
|systemctl start zoneminder
|systemctl enable zoneminder
}}

== SELinux ==

When using [[SELinux]], first create a SELinux policy for the application:

{{FileBox|filename=local_zoneminder.te|title=Type enforcement rules for ZoneMinder|1=
module local_zoneminder 1.0; 

require { 
               type httpd_t;
               type initrc_var_run_t;
               type initrc_t;
               type v4l_device_t;
               type file_t;
              class unix_stream_socket { read connectto };
              class file { read lock };
              class shm { unix_read unix_write associate read write getattr };
              class chr_file getattr;
}

#============= httpd_t ============== 
allow httpd_t initrc_t:unix_stream_socket connectto;
allow httpd_t initrc_t:shm { unix_read unix_write associate read write getattr };
allow httpd_t initrc_var_run_t:file { read lock };
allow httpd_t v4l_device_t:chr_file getattr;
}}

Now build the modules:

{{RootCmd
|checkmodule -M -m -o local_zoneminder.mod local_zoneminder.te 
|semodule_package -o local_zoneminder.pp -m local_zoneminder.mod
|semodule -i local_zoneminder.pp
}}

== Other ==

Shared memory:

{{RootCmd|sysctl kernel.shmmax{{=}}536870912}}

=== Upgrading ===

ZoneMinder includes a utility <code>zmupdate.pl</code> to update the database schema as needed.

Specify your previous version and database credentials for the <code>zm</code> database:
{{RootCmd
|/usr/bin/zmupdate.pl --version{{=}}1.30.2 --user{{=}}zmuser --pass{{=}}zmpass
|output=<pre>
Initiating database upgrade to version 1.30.4 from version 1.30.2

Please ensure that ZoneMinder is stopped on your system prior to upgrading the database.
Press enter to continue or ctrl-C to stop :

Do you wish to take a backup of your database prior to upgrading?
This may result in a large file in /var/tmp/zm if you have a lot of events.
Press 'y' for a backup or 'n' to continue : y
Creating backup to /var/tmp/zm/zm-1.30.2.dump. This may take several minutes.
Database successfully backed up to /var/tmp/zm/zm-1.30.2.dump, proceeding to upgrade.

Upgrading database to version 1.30.4
Loading config from DB
Saving config to DB
Upgrading DB to 1.30.3 from 1.30.2

Database successfully upgraded to version 1.30.3.
Upgrading DB to 1.30.4 from 1.30.2

Database successfully upgraded to version 1.30.4.

Database upgrade to version 1.30.4 successful.
</pre>}}
