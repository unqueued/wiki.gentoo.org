{{Stub}}
ZoneMinder is a system to provide monitoring, logging and a browser based interface to security cameras. As of this writing, there is no ebuild (there used to be one). It can support multiple V4L and network connected devices with a clear uncluttered interface in any browser.

{{Warning|It can be tricky to get working to your satisfaction. This is a blow by blow summary of an install from source on my system, you will probably need to get some more sources of information.}}

{{Note|See the talk page for some additional hints. I'll transfer them in when I get time. [[User:Gerdesj|Gerdesj]] 08:00, 9 May 2012 (UTC)}}

{{Note|Check out the '''zugaina''' [[overlay]] for package <nowiki>www-misc/zoneminder</nowiki> - this may simplify your compilation.}}

== Get the source ==
{{RootCmd|cd /usr/src
|wget http://www2.zoneminder.com/downloads/ZoneMinder-1.25.0.tar.gz
|tar xzvf ZoneMinder-1.25.0.tar.gz
}}

{{Note|A patched version that compiles without problems may be obtained through subversion.}}

{{RootCmd|svn co https://svn.unixmedia.net/public/zum/trunk/zum}}

== Configure ==
{{RootCmd|./configure --with-webdir{{=}}/var/www/localhost/htdocs/zm --with-cgidir{{=}}/var/www/localhost/cgi-bin CPPFLAGS{{=}}-D__STDC_CONSTANT_MACROS --enable-mmap{{=}}no
|make
|make install
}}

{{Note|''--prefix{{=}}/usr/local'' by default - probably best to leave as is to avoid conflicting with Portage controlled stuff.}}
{{Note|No Sys::Mmap in Portage hence ''--use-mmap{{=}}no}}
{{Note|CPPFLAGS needed to compile ffmpeg modules}}

== MySQL ==
* Create a database
{{Cmd|mysql -p|output=<pre>
mysql> create database zm;
mysql> exit;
</pre>}}

* Import the database schema and base data, the .sql script is created by the configure phase above, so make sure you do that first.
{{Cmd|mysql -p zm < /usr/src/Zoneminder-<version>/db/zm_create.sql}}

* Create a MySQL user for ZM to use. If you change the user and/or password from the defaults here, then make sure you set those in the source configure phase.
{{Cmd|mysql -p|output=<pre>
mysql> use zm;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> grant select,insert,update,delete on zm.* to 'zmuser'@localhost identified by 'zmpass';Query OK, 0 rows affected (0.00 sec)

mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)
</pre>}}

== Dependencies ==
This is the Perl module checking from configure.  You'll have to add any missing ones yourself.
<pre>
checking for perl... perl
checking for perl version greater than or equal to 5.6.0... ok
checking for perl module Sys::Syslog... ok
checking for perl module DBI... ok
checking for perl module DBD::mysql... ok
checking for perl module Getopt::Long... ok
checking for perl module Time::HiRes... ok
checking for perl module Date::Manip... ok
checking for perl module LWP::UserAgent... ok
checking for perl module ExtUtils::MakeMaker... ok
checking for perl module Module::Load... ok
checking for perl module Device::SerialPort... ok
checking for perl module Net::FTP... ok
checking for perl module Net::SFTP::Foreign... no
configure: WARNING: Net::SFTP::Foreign is required for automatic event uploading using sftp
checking for perl module Expect... ok
checking for perl module Archive::Tar... ok
checking for perl module Archive::Zip... ok
checking for perl module Net::SMTP... ok
checking for perl module MIME::Lite... ok
checking for perl module MIME::Entity... ok
checking for perl module X10::ActiveHome... no
configure: WARNING: X10::ActiveHome is required for X.10 support
</pre>

{{Note|dev-perl/net-sftp has quite a few deps and does not seem to include Net::SFTP::Foreign.}}
{{Note|There are no X10 modules in Portage.}}

== Apache ==
* Enable PHP short tags if you get the following errors in Apache's error log and in the browser output
<pre>
PHP Parse error:  syntax error, unexpected $end in /var/www/localhost/htdocs/zm/includes/functions.php on line 2437
</pre>

* Set date.timezone in {{Path|php.ini}} if the output is full of timezone errors to e.g. "Europe\London"

{{RootCmd|eselect php list apache2|output=<pre>
  [1]   php5.3 *
  [2]   php5.4
</pre>}}

{{File|/etc/php/apache2-php5.3/php.ini|Snippet from php.ini for Apache|<pre>
short_open_tag = On
date.timezone = "Europe/London"
</pre>}}

== Selinux ==
If you are using selinux you must create a policy. Hopefully later when the ebuild comes back this will be done automatically.

Make local_zoneminder.te
<pre> 
module local_zoneminder 1.0; 

require { 
               type httpd_t;
               type initrc_var_run_t;
               type initrc_t;
               type v4l_device_t;
               type file_t;
              class unix_stream_socket { read connectto };
              class file { read lock };
              class shm { unix_read unix_write associate read write getattr };
              class chr_file getattr;
}

#============= httpd_t ============== 
allow httpd_t initrc_t:unix_stream_socket connectto;
allow httpd_t initrc_t:shm { unix_read unix_write associate read write getattr };
allow httpd_t initrc_var_run_t:file { read lock };
allow httpd_t v4l_device_t:chr_file getattr;
</pre>
Now it's time to build the modules.
{{RootCmd|checkmodule -M -m -o local_zoneminder.mod local_zoneminder.te 
|semodule_package -o local_zoneminder.pp -m local_zoneminder.mod
|semodule -i local_zoneminder.pp}}
== Other ==
Shared memory:
 sysctl kernel.shmmax=536870912

[[Category:Web application]]
[[Category:Monitoring]]
