
{{WIP|author=Vdupras}}
'''WORK IN PROGRESS'''

The [https://gitweb.gentoo.org/repo/gentoo.git gentoo repo] is the main element that is used to build the portage tree that is delivered through rsync, but this repo doesn't contain everything it needs to be fully functional. It needs to be augmented with [https://gitweb.gentoo.org/data data repos] and a portage cache needs to be regenerated at each update.

This page describes how to assemble your own portage tree from first-hand data.

== Why? ==

Why would you want to do this? It's true that building an maintaining a Portage tree from scratch is a bit more of a hassle than using a pre-assembled one. You have to maintain your PGP trust whenever there's changes in the Gentoo developers PGP keys pool, it's a bit of work.

The most likely reason for doing this is to participate in strengthening Gentoo's web of trust. By making you trusting developers directly, you make Gentoo portage tree security less dependant on a single point of failure that is its infrastructure.
 
If you're a Gentoo developer, you might think it convenient to edit your active portage tree directly. 

== Step 1: Trust gentoo developers ==

Every commit of the gentoo repo is signed by the Gentoo developer who wrote or reviewed it. To be able every Gentoo developer.

TODO: write section about importing gentoo devs keys.

== Step 2: Clone and verify ==

The next thing to do is to clone https://gitweb.gentoo.org/repo/gentoo.git somewhere and verify it's latest couple of hundred commits, or as many commit as you need to feel confident in your initial integrity.

Why not the whole repo? Because to do that, you would need more than just current Gentoo developers in your PGP trust DB, but all past ones as well. It becomes needlessly complicated.

You can use {{c|git log --show-signature}} to augment logs with signature verification, but it's a bit tiresome to review manually. You can inspire yourself from https://github.com/hsoft/devscripts/blob/master/verif-sign-until.sh and run something like:

{{Cmd
|verif-sign-until.sh HEAD~500}}

No error? Well it looks like you have a Gentoo repo you can trust!

== Step 3: Augment with metadata ==

You need a few extra metadata repos checkout out for the tree to work properly:

{{Cmd
|cd metadata
|for x in dtd glsa xml-schema; do
|    git clone "https://anongit.gentoo.org/git/data/${x}.git"
|done
|git clone "https://anongit.gentoo.org/git/data/gentoo-news.git" news}}

These are very low volume repositories and are easily verified with {{c|git log --show-signature}}. You will also notice that the signature requirement in those repositories aren't as strict as with the main gentoo repo, but since this is purely informational data, malicious injection can't have much of an impact there.

== Step 4: repos.conf ==

You can now change the location of your gentoo [[/etc/portage/repos.conf]] file to the path of your git clone. Don't forget to disable auto-syncing: you'll take care of this manually.

== Step 4: Generate portage cache ==

The "metadata/md5-cache" directory contains metadata about ebuilds that greatly improves the speed of portage's dependencies calculations. Without it, portage will be dead slow on your machine:

{{Cmd|egencache --jobs{{=}}4 --repo gentoo --update}}

The initial run of this command can take a long time (many minutes), but subsequent runs will be much faster.

== Keeping it up to date ==

Your sync method is now "hands on", so you'll have to set something up for yourself. You can inspire yourself from https://github.com/hsoft/devscripts/blob/master/gen-pull-gencache.sh
[[Category:Portage]]
