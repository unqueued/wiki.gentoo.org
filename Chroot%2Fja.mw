<languages />

Chroot ('''Ch'''ange '''root''') はメインシステムのrootディレクトリから論理的に分離された環境を作るために、見掛け上のrootディレクトリを変更する目的で使われるUnixシステムのユーティリティです。この新しい環境は"chroot jail(訳注:監獄)"として知られています。jailの中にいるユーザーからは閉じこめられている環境の外側にあるファイルを見ることもアクセスすることもできません。

chrootの主な使い方の一つとして、ソフトウェアの互換性やテストの為に、現在のシステムの上に、分離されたLinuxシステムを作るものがあります。ハイパーバイザーのオーバーヘッドが無いので、これはしばしば軽量な仮想化の代替としてみられます。

== 環境構築 ==

新しくchroot環境を作る時にはまず、chrootして住むためのディレクトリを作る必要があります。例えば{{Path|/mnt/mychroot}}にchrootすることを考えましょう:

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

既にインストールされたシステムをマウントしたい場合は、次のコマンドが使えるでしょう。例に書かれた<code><DEVICE></code>は実際のドライブやパーティションに合わせて書き換えてください。

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/DEVICE /mnt/mychroot
}}

もしあなたが今居るルートファイルシステムのサブディレクトリに既にシステムをインストールしてあれば、上のステップはスキップして構いません。

== Unpacking system files and the Portage tree (new installations) ==

When building a new install, the next step is to download the stage3 and Portage tarballs and set them up in the chroot location. For more information on this process please see sections 5a and 5b in the [http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&chap=5 Gentoo Handbook].

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/current-stage3/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

== Configuration ==

Before entering the chroot a number of directories need to be mounted:

{{RootCmd
|mount -o bind /dev /mnt/mychroot/dev
|mount -t proc none /mnt/mychroot/proc
|mount -o bind /sys /mnt/mychroot/sys
|mount -o bind /tmp /mnt/mychroot/tmp
}}

Some basic configuration files will need to be copied from the host, do not copy over {{Path|make.conf}} when using an existing installation:

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # 既存のシステムを使う場合、このコマンドは省いてください。
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

Once done enter the chroot environment by executing the following commands:

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

When creating a new installation Portage should be synced to make sure everything is up to date.

{{RootCmd
|emerge --sync
}}

The system is now ready; feel free to install software, mess with settings, test experimental packages and configurations without having any effect on the main system. To leave the chroot simply type <kbd>exit</kbd> or press {{Key|Ctrl}}+{{Key|D}}. Doing so will return the console back to the normal environment. Do not forget to umount the directories that have been mounted.

== Init scripts ==

If setting up chroots is a task that is needed to be performed often, it is possible to speed up the mounting of the directories by using an init script:

{{FileBox|filename=/etc/init.d/mychroot|lang=bash|1=
#!/sbin/runscript
 
depend() {
   need localmount
   need bootmisc
}
 
start() {
     ebegin "Mounting chroot directories"
     mount -o rbind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}
 
stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
}
}}

When using a different directory or partition, add the necessary mounting commands in the <code>start()</code> function and change {{Path|/mnt/chroot}} to the appropriate name.

== See also ==

* [http://www.gentoo.org/proj/en/base/x86/chroot.xml Gentoo x86 Chroot Setup Guide]


[[Category:Core system]]
