<languages />

{{InfoBox stack
|{{InfoBox wikipedia|header=true}}
}}

Chroot ('''Ch'''ange '''root''') はメインシステムのrootディレクトリから論理的に分離された環境を作るために、見掛け上のrootディレクトリを変更する目的で使われるUnixシステムのユーティリティです。この新しい環境は"chroot jail(訳注:監獄)"として知られています。jailの中にいるユーザーからは閉じこめられている環境の外側にあるファイルを見ることもアクセスすることもできません。

chrootの主な使い方の一つとして、ソフトウェアの互換性やテストの為に、現在のシステムの上に、分離されたLinuxシステムを作るものがあります。ハイパーバイザーのオーバーヘッドが無いので、これはしばしば軽量な仮想化の代替としてみられます。

== 前提条件 ==

=== 環境構築 ===

新しくchroot環境を作る時にはまず、chrootして住むためのディレクトリを作る必要があります。例えば{{Path|/mnt/mychroot}}にchrootすることを考えましょう:

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

既にインストールされたシステムをマウントしたい場合は、次のコマンドが使えるでしょう。例に書かれた<code><DEVICE></code>は実際のドライブやパーティションに合わせて書き換えてください。

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/DEVICE /mnt/mychroot
}}

もしあなたが今居るルートファイルシステムのサブディレクトリに既にシステムをインストールしてあれば、上のステップはスキップして構いません。

=== システムファイルとPortageツリーの展開 (新規インストール) ===

新しいシステムをインストール中であれば、次のステップはstage3とPortage tarballをダウンロードして正しいchrootの場所に設置することです。この手続についてのより詳しい情報は、Gentoo [[Handbook:Main_Page/ja|ハンドブック]]の[[Handbook:AMD64/Installation/Stage/ja#stage_tarball_.E3.82.92.E3.83.80.E3.82.A6.E3.83.B3.E3.83.AD.E3.83.BC.E3.83.89.E3.81.99.E3.82.8B|stage tarball をダウンロードする]] と [[Handbook:AMD64/Installation/Stage/ja#stage_tarball_.E3.82.92.E5.B1.95.E9.96.8B.E3.81.99.E3.82.8B|stage tarball を展開する]] をご覧ください。

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/autobuilds/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

== 設定 ==

chrootに入る前にいくつかのディレクトリをマウントしておかなければなりません。

{{RootCmd
|mount --rbind /dev /mnt/mychroot/dev
|mount --make-rslave /mnt/mychroot/dev
|mount -t proc /proc /mnt/mychroot/proc
|mount --rbind /sys /mnt/mychroot/sys
|mount --make-rslave /mnt/mychroot/sys
|mount --rbind /tmp /mnt/mychroot/tmp
}}

そして基本的な設定ファイルもホストからコピーしておく必要がありますが、既存のシステムを使っている場合は{{Path|make.conf}}をコピーしてはいけません:

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # 既存のシステムを使う場合、このコマンドは省いてください。
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

== 使い方 ==

以上の作業が完了すれば、以下のコマンドで新しいchroot環境に入ることができます:

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

新規インストールの場合は、全てを確実に最新にするためにportageを同期してください。

{{RootCmd
|emerge --sync
}}

これでシステムは使用可能になりました。メインのシステムに何一つ影響を与えることなく、ソフトウェアをインストールしたり、メチャクチャな設定をしたり、実験的なパッケージや設定を試したりできます。chrootから離れるには単に {{c|exit}} もしくは{{Key|Ctrl}}+{{Key|d}}と入力してください。これで操作中のコンソールはいつもの環境に戻って来ます。マウントしたディレクトリをアンマウントするのを忘れないでください。

=== Init スクリプト ===

頻繁にchrootの構築を行なうのであれば、次の init script を使うことでchrootの為のマウントを速くできます。
スクリプトはデフォルトのランレベルに追加することができ、システム起動時に自動的にセットアップされます。

{{FileBox|filename=/etc/init.d/mychroot|lang=bash|1=
#!/sbin/openrc-run
 
depend() {
   need localmount
   need bootmisc
}
 
start() {
     ebegin "Mounting chroot directories"
     mount -o rbind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}
 
stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
}
}}

異なったディレクトリやパーティションを使う場合は、必要なマウントコマンドを<code>start()</code>に追加して、異なる名前を使う場合は{{Path|/mnt/chroot}}を適切な名前に変更してください。

== こちらもご覧ください ==

* [[Project:X86/Chroot Guide|Chroot ガイド]]
* [[Chrooting_proxy_services|Chrooting proxy services]]


[[Category:Core system]]
