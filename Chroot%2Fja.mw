<languages />

{{InfoBox stack
|{{InfoBox wikipedia|header=true}}
}}

Chroot ('''Ch'''ange '''root''') is a Unix system utility used to change the apparent root directory to create a new environment logically separate from the main system's root directory. This new environment is known as a "chroot jail." A user operating inside the jail cannot see or access files outside of the environment they have been locked into.

chrootの主な使い方の一つとして、ソフトウェアの互換性やテストの為に、現在のシステムの上に、分離されたLinuxシステムを作るものがあります。ハイパーバイザーのオーバーヘッドが無いので、これはしばしば軽量な仮想化の代替としてみられます。

== Prerequisites ==

=== 環境構築 ===

新しくchroot環境を作る時にはまず、chrootして住むためのディレクトリを作る必要があります。例えば{{Path|/mnt/mychroot}}にchrootすることを考えましょう:

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

既にインストールされたシステムをマウントしたい場合は、次のコマンドが使えるでしょう。例に書かれた<code><DEVICE></code>は実際のドライブやパーティションに合わせて書き換えてください。

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/DEVICE /mnt/mychroot
}}

もしあなたが今居るルートファイルシステムのサブディレクトリに既にシステムをインストールしてあれば、上のステップはスキップして構いません。

=== システムファイルとPortageツリーの展開 (新規インストール) ===

新しいシステムをインストール中であれば、次のステップはstage3とPortage tarballをダウンロードして正しいchrootの場所に設置することです。この手続についてのより詳しい情報は、Gentoo [[Handbook:Main_Page/ja|ハンドブック]]の[[Handbook:AMD64/Installation/Stage/ja#stage_tarball_.E3.82.92.E3.83.80.E3.82.A6.E3.83.B3.E3.83.AD.E3.83.BC.E3.83.89.E3.81.99.E3.82.8B|stage tarball をダウンロードする]] と [[Handbook:AMD64/Installation/Stage/ja#stage_tarball_.E3.82.92.E5.B1.95.E9.96.8B.E3.81.99.E3.82.8B|stage tarball を展開する]] をご覧ください。

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/current-stage3/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

== 設定 ==

chrootに入る前にいくつかのディレクトリをマウントしておかなければなりません。

{{RootCmd
|mount --rbind /dev /mnt/mychroot/dev
|mount --make-rslave /mnt/mychroot/dev
|mount -t proc /proc /mnt/mychroot/proc
|mount --rbind /sys /mnt/mychroot/sys
|mount --make-rslave /mnt/mychroot/sys
|mount --rbind /tmp /mnt/mychroot/tmp
}}

そして基本的な設定ファイルもホストからコピーしておく必要がありますが、既存のシステムを使っている場合は{{Path|make.conf}}をコピーしてはいけません:

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # 既存のシステムを使う場合、このコマンドは省いてください。
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

== Usage ==

以上の作業が完了すれば、以下のコマンドで新しいchroot環境に入ることができます:

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

新規インストールの場合は、全てを確実に最新にするためにportageを同期してください。

{{RootCmd
|emerge --sync
}}

The system is now ready; feel free to install software, mess with settings, test experimental packages and configurations without having any effect on the main system. To leave the chroot simply type {{c|exit}} or press {{Key|Ctrl}}+{{Key|d}}. Doing so will return the console back to the normal environment. Do not forget to {{c|umount}} the directories that have been mounted.

=== Init scripts ===

If setting up chroots is a task that is needed to be performed often, it is possible to speed up the mounting of the directories by using an init script. The script could be added to the default runlevel and therefore set up automatically on system boot:

{{FileBox|filename=/etc/init.d/mychroot|lang=bash|1=
#!/sbin/openrc-run
 
depend() {
   need localmount
   need bootmisc
}
 
start() {
     ebegin "Mounting chroot directories"
     mount -o rbind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}
 
stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
}
}}

異なったディレクトリやパーティションを使う場合は、必要なマウントコマンドを<code>start()</code>に追加して、異なる名前を使う場合は{{Path|/mnt/chroot}}を適切な名前に変更してください。

== こちらもご覧ください ==

* [[Project:X86/Chroot Guide|Chroot ガイド]]
* [[Chrooting_proxy_services|Chrooting proxy services]]


[[Category:Core system]]
