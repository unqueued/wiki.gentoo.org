== Ensuring the security of your portage tree ==

'''WIP''': this is a work in progress.

This page aims to answer the question "How can I dispel doubts regarding the security of the portage tree on my system?", that is, to ensure that the portage tree is a direct result of the [https://gitweb.gentoo.org canonical git repos], without outside interference.

This question is answered differently whether you use webrsync, rsync, git-mirror or canonical git repos directly.

=== webrsync ===

Whenever you run {{c|emerge-webrsync}}, the downloaded tarball is always checked against gentoo release keys which are provided by [https://packages.gentoo.org/packages/app-crypt/gentoo-keys app-crypt/gentoo-keys].

The only caveat is that this method doesn't do further checking after having unpacked the tarball so if your portage tree was compromised before the webrsync, it's possible that it's still compromised. If you're not sure about the state of your portage tree, wipe it out before doing {{c|emerge-webrsync}}.

==== What do I need to do? ====

You need to enable the {{c|webrsync-gpg}} feature as [https://wiki.gentoo.org/wiki/Handbook:Parts/Working/Features#Validated_Gentoo_repository_snapshots explained in the handbook]

==== How can I dispel doubt? ====

Seeing "Checking signature..." should be enough to dispel your doubts. You can also read the contents of `/usr/bin/emerge-webrsync` which is small enough to be easily audited.

If you're in hardcore mode, you'll have to set yourself a man-in-the-middle attack and check that verification fails.

==== What do I need to trust? ====

# that the Gentoo's release keys haven't been compromised.
# that the content on the file that {{c|SRC_URI}} point to in app-crypt/gentoo-keys is actually the Gentoo release keys

=== rsync ===

Since portage 2.3.21, portage supports recursive signed manifests checking.

==== What do I need to do? ====

# Ensure that portage has the {{c|rsync-verify}} flag
# Make sure that you see stuff like "Using keys from ..." and "Valid OpenPGP signature found" when you do "emerge --sync"
# '''Never miss errors during --sync'''. portage will not prevent you from running on a repo that has failed verification. This is an issue that is being worked on, but the work isn't completed yet.

==== How can I dispel doubt? ====

Simulate malicious injection:

# Change an ebuild
# Run gemato verify -K /usr/share/openpgp-keys/gentoo-release.asc /usr/portage
# You should get a manifest mismatch error
# Go a step further and update the manifest with "ebuild foobar-1.2.3.ebuild manifest"
# Run gemato verify -K /usr/share/openpgp-keys/gentoo-release.asc /usr/portage
# You will get a mismatch error
# You can confirm that gemato saved you from doom by running "ebuild foobar-1.2.3.ebuild unpack". With the corrupted manifest being consistent with the corrupted ebuild, unpack will proceed unhindered. gemato saved you!
