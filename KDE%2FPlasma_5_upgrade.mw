Plasma 5 is the next generation of KDE's desktop environment, based on Qt 5 and KDE Frameworks 5. Upgrading is fairly simple, although it cannot be coinstalled with Plasma 4 due to upstream design decisions.

Note that while Plasma 5 is in a good state, it is still under heavy upstream development and is missing some features present in KDE 4.

== Preparations ==

=== Profile ===

It is highly recommended to use the Plasma desktop profile as it sets a number of important options to ensure things run smoothly.

In order to choose the most suitable profile, first list what's available:

{{RootCmd|eselect profile list|output=<pre>
  [1]   default/linux/amd64/13.0
  [2]   default/linux/amd64/13.0/selinux
  [3]   default/linux/amd64/13.0/desktop
  [4]   default/linux/amd64/13.0/desktop/gnome
  [5]   default/linux/amd64/13.0/desktop/gnome/systemd
  [6]   default/linux/amd64/13.0/desktop/kde
  [7]   default/linux/amd64/13.0/desktop/kde/systemd
  [8]   default/linux/amd64/13.0/desktop/plasma
  [9]   default/linux/amd64/13.0/desktop/plasma/systemd
  ...
</pre>}}

Then, select the right profile, substituting the appropriate profile number (which may vary between configurations):

{{RootCmd|eselect profile set 8}}

=== make.conf ===

The plasma profile now takes care of the right settings for a full-blown KDE Plasma/Applications installation. In the foreseeable future, this entails both Qt&nbsp;4 as well as Qt&nbsp;5 based packages. It also handles possible USE flag conflicts on a per-package basis. If there are any existing definitions of <code>qt4</code>, <code>kde</code> or <code>plasma</code> in {{Path|/etc/portage/make.conf}}, make sure to remove them before proceeding, else conflicts may arise. In case of USE <code>handbook</code>, the recommendation is to either remove it as well, or disable it if the KDE documentation is not needed.

Check for these flags and if necessary alter the file using your favourite editor:

{{RootCmd|grep -e "qt&#91;&#91;:digit:&#93;&#93;" -e "handbook" -e "kde" -e "plasma" /etc/portage/make.conf}}

{{Note|Older setups might still use the depreciated {{Path|/etc/make.conf}} instead.}}

You should now also revise your entries in {{Path|/etc/portage/package.use}}:

{{RootCmd
|grep -e "qt&#91;&#91;:digit:&#93;&#93;$" -e "qt&#91;&#91;:digit:&#93;&#93; " -e "handbook$" -e "handbook " -R /etc/portage/package.use
|grep -e "kde$" -e "kde " -e "plasma$" -e "plasma " -R /etc/portage/package.use
}}

Of course you can adjust these flags afterwards again.

{{Note|If you run into a new conflict related to those flags, please report that to the Gentoo KDE team.}}

=== Clean up @world ===

Now is a good time to clean up @world. If it contains packages either directly from or depending on KDE Workspaces 4, it will lead to emerge conflicts later on. The following command will probably take some time, but is not going to remove anything yet - examine the output. If you are sure to proceed, run it without <code>--pretend</code> again. Only the @world file is going to be changed - while the packages stay installed, they will not block a subsequent installation of Plasma 5.
{{RootCmd|for x in freespacenotifier kcheckpass kcminit kdebase-cursors kdebase-startkde kdm kephal khotkeys kinfocenter klipper kmenuedit krunner kscreensaver ksmserver ksplash kstartupconfig kstyles ksysguard ksystraycmd kwin kwrited libkgreeter libkworkspace liboxygenstyle libplasmaclock libplasmagenericshell libtaskmanager plasma-workspace powerdevil qguiplatformplugin_kde solid-actions-kcm systemsettings; do equery -q d ${x} &#124; sed -e "s/-[0-9].*//"; done &#124; sed -e "/kdebase-meta/g" -e "/kde-meta/g" &#124; xargs emerge --deselect --pretend}}
{{Note|This requires {{Package|app-portage/gentoolkit}} to be installed. See also: [[Gentoolkit]]}}

=== Apply the changes ===

Any packages affected by the profile change need to be rebuilt:

{{RootCmd|emerge --ask --changed-use --newrepo --deep world}}

=== Overlay (optional) ===

Be warned that you are entering development grounds. The [[KDE/Overlay|KDE Overlay]] provides a means to access more recent versions of KDE Plasma, Applications and Frameworks and can be accessed using [[layman]]:

{{RootCmd
|echo "app-portage/layman sync-plugin-portage" >> /etc/portage/package.use
|emerge --ask app-portage/layman
|layman --fetch --add kde
}}

==== Unmasking and keywording for stable users ====

For stable users, it also provides package.keywords lists to unmask not-yet-stabilised versions. Please note that this can often require unmasking additional dependencies that are out of scope of these lists.

{{Note|The following examples use {{Path|/var/lib/layman}} as the overlay path.}}

{{RootCmd
|cd /etc/portage/package.accept_keywords
|ln -s /var/lib/layman/kde/Documentation/package.accept_keywords/kde-frameworks-5.17.keywords
|ln -s /var/lib/layman/kde/Documentation/package.accept_keywords/kde-plasma-5.5.keywords
}}

{{Note|KDE Plasma is in constant change and weekly there's new package version available and new frameworks version and kde-plasma. Please ensure you're using the latest "stable" version (if we can talk of stable version), paying attention to the files available in the directory {{Path|/var/lib/layman/kde/Documentation/package.accept_keywords}} and use it in the above command, replacing by the desired version available.}}

== Installation ==

The {{Package|kde-plasma/plasma-meta}} package provides the full Plasma 5 suite:

{{RootCmd|emerge --ask kde-plasma/plasma-meta}}

Alternatively, {{Package|kde-plasma/plasma-desktop}} provides the basic desktop, leaving you free to install only the extra packages you require:

{{RootCmd|emerge --ask kde-plasma/plasma-desktop}}

{{Note|Please note that you will be missing important packages such as {{Package|kde-plasma/powerdevil}} (power management, suspend and hibernate options) and {{Package|kde-plasma/systemsettings}} if you go that way.}}

== Display manager ==

[[SDDM]] (Simple Desktop Display Manager) is the recommended login manager and is pulled in automatically via {{package|kde-plasma/plasma-meta}} by default. This is the preferred option. Alternatively, [[LightDM]] can be used and pulled in by setting <code>USE</code> flag <code>-sddm</code> for {{package|kde-plasma/plasma-meta}}. Change the setting accordingly in {{Path| /etc/conf.d/xdm}}. Also, be sure to read through the [[SDDM]] page if further issues appear.

== Migration ==

=== KWallet ===

KWallet 5 will have to open your wallet from KWallet 4 and import all the data into a new wallet. For that purpose, {{Package|kde-apps/kwalletd}} needs to be present at least once in a session after upgrade, but can be removed after migration and when you are sure no legacy package is using it anymore:

{{RootCmd
|echo "kde-apps/kdebase-runtime-meta -oldwallet" >> /etc/portage/package.use
|emerge --ask --oneshot kde-apps/kdebase-runtime-meta
}}

=== SSH/GPG Agent startup/shutdown scripts ===

Configuration moved to {{Path|/etc/plasma/{startup,shutdown}}} for Plasma 5, you will need to copy your scripts from the old location.

{{Note|For KDE SC 4 the scripts are located in {{Path|/etc/kde/{startup,shutdown}}}.}}

== Troubleshooting ==

The most common issue with upgrading is running into blockers. Unfortunately, some packages just can't be co-installed so they'll need to be removed. Feel free to drop by [irc://chat.freenode.net/#gentoo #gentoo] or [irc://chat.freenode.net/#gentoo-kde #gentoo-kde] for assistance with resolving any blockers.

=== Missing systray icons ===

Plasma <= 5.4 does not support xembed-based systray icons anymore, but uses the StatusNotifier specification for that <ref>http://blog.martin-graesslin.com/blog/2014/03/system-tray-in-plasma-next/</ref>.
As not all applications have been ported to the new system, some workaround exist <ref>http://blog.martin-graesslin.com/blog/2014/06/where-are-my-systray-icons/</ref>.

The workaround can be enabled by activating the <code>legacy-systray</code> and GUI-specific (<code>gtk2</code>, <code>gtk3</code>, <code>qt4</code>) USE flags for {{package|kde-plasma/plasma-desktop}}.

{{RootCmd|echo "kde-plasma/plasma-desktop legacy-systray gtk2 gtk3 qt4" >> /etc/portage/package.use}}

Alternatively, the required packages can be installed manually:

For Qt 4 applications:

{{Emerge|dev-libs/sni-qt}}

For GTK+ 2 applications

{{Emerge|dev-libs/libappindicator:2}}

For GTK+ 3 applications:

{{Emerge|dev-libs/libappindicator:3}}

==== Pidgin ====

{{Package|net-im/pidgin}} requires {{Package|x11-plugins/pidgin-indicator}}. After install, find the ''Ubuntu Indicator'' plugin under ''Tools | Plugins''.

==== Skype ====

{{Package|net-im/skype}} is a 32-bit binary, you need to enable <code>abi_x86_32</code> on {{Package|dev-libs/sni-qt}}.

Update: there is an application that allows to convert old xembed-based system tray icons to StatusNotifier icons, compatible with Plasma 5: <code>xembed-sni-proxy</code> <ref>http://blog.davidedmundson.co.uk/blog/xembed_back</ref>. To install it, you have to setup [[KDE/Overlay]].

{{Emerge|dev-libs/xembed-sni-proxy}}

This program is included in >=plasma-workspace-5.5, so you don't have to install it separately if you're using Plasma >= 5.5. Otherwise, you'll have to unmask/unkeyword it (add <code>=dev-libs/xembed-sni-proxy-9999 **</code> to {{Path|package.accept-keywords}} and {{Path|package.unmask}} files.

=== ck-list-sessions has wrong session information ===

Start plasma without {{c|exec}} or {{c|ck-launch-session}}.  Using {{c|dbus-launch --sh-syntax --exit-with-session "/usr/bin/startkde"}} was what I ended up using.

=== Missing shutdown, reboot, suspend and hibernate buttons when using OpenRC ===

Please ensure that {{package|kde-plasma/powerdevil}} and {{package|sys-power/upower-pm-utils}} ('''not''' {{package|sys-power/upower}}) are installed. Also ensure that your user belongs to the {{c|users}} group.

If you use {{package|x11-misc/sddm}}, try {{package|x11-misc/lightdm}} instead.

=== SDDM display issues ===

Check that your user (and {{c|sddm}} user) are in the {{c|video}} group.

=== SDDM: KCM unable to change themes ===

SDDM needs a configuration file so that the KCM module can change themes. This file is not created during the SDDM installation, so it needs to be created manually afterwards:

{{RootCmd|sddm --example-config > /etc/sddm.conf}}

== References ==

<references />

[[Category:KDE]]
