Plasma 5 is the next generation of KDE's desktop environment, based on Qt 5 and KDE Frameworks 5. Upgrading is fairly simple, although it cannot be coinstalled with Plasma 4 due to upstream design decisions.

Note that while Plasma 5 is in a good state, it is still under heavy upstream development and is missing some features present in KDE 4.

== Preparations ==

=== Profile ===

It is highly recommended to use the Plasma desktop profile as it sets a number of important options to ensure things run smoothly.

In order to choose the most suitable profile, first list what's available:

{{RootCmd|eselect profile list|output=<pre>
  [1]   default/linux/amd64/13.0
  [2]   default/linux/amd64/13.0/selinux
  [3]   default/linux/amd64/13.0/desktop
  [4]   default/linux/amd64/13.0/desktop/gnome
  [5]   default/linux/amd64/13.0/desktop/gnome/systemd
  [6]   default/linux/amd64/13.0/desktop/kde
  [7]   default/linux/amd64/13.0/desktop/kde/systemd
  [8]   default/linux/amd64/13.0/desktop/plasma
  [9]   default/linux/amd64/13.0/desktop/plasma/systemd
  ...
</pre>}}

Then, select the right profile, substituting the appropriate profile number (which may vary between configurations):

{{RootCmd|eselect profile set 8}}

=== make.conf ===

The plasma profile now takes care of the right settings for a full-blown KDE Plasma/Applications installation. In the foreseeable future, this entails both Qt&nbsp;4 as well as Qt&nbsp;5 based packages. It also handles possible USE flag conflicts on a per-package basis. If there are any existing definitions of <code>qt4</code>, <code>kde</code> or <code>plasma</code> in {{Path|/etc/portage/make.conf}}, make sure to remove them before proceeding, else conflicts may arise. Also, <b>never set</b> <code>-minimal</code> in  {{Path|/etc/portage/make.conf}}. In case of USE <code>handbook</code>, the recommendation is to either remove it as well, or disable it if the KDE documentation is not needed.

Check for these flags and if necessary alter the file using your favourite editor:

{{RootCmd|grep -e "qt&#91;&#91;:digit:&#93;&#93;" -e "handbook" -e "kde" -e "plasma" /etc/portage/make.conf}}

{{Note|Older setups might still use the deprecated {{Path|/etc/make.conf}} instead.}}

You should now also revise your entries in {{Path|/etc/portage/package.use}}:

{{RootCmd
|grep -e "qt&#91;&#91;:digit:&#93;&#93;$" -e "qt&#91;&#91;:digit:&#93;&#93; " -e "handbook$" -e "handbook " -R /etc/portage/package.use
|grep -e "kde$" -e "kde " -e "plasma$" -e "plasma " -R /etc/portage/package.use
}}

Of course you can adjust these flags afterwards again.

{{Note|If you run into a new conflict related to those flags, please report that to the Gentoo KDE team.}}

=== Clean up @world ===

Now is a good time to clean up [[World_set_(Portage)|@world]]. If it contains packages either directly from or depending on KDE Workspaces 4, it will lead to emerge conflicts later on. The following command will probably take some time, but is not going to remove anything yet - examine the output.
{{RootCmd|for x in x11-libs/libkscreen kde-misc/kde-gtk-config net-misc/ksshaskpass freespacenotifier kcheckpass kcminit kdebase-cursors kdebase-startkde kdm kephal khotkeys kinfocenter klipper kmenuedit krunner kscreensaver ksmserver ksplash kstartupconfig kstyles ksysguard ksystraycmd kwin kwrited libkgreeter libkworkspace liboxygenstyle libplasmaclock libplasmagenericshell libtaskmanager plasma-workspace powerdevil qguiplatformplugin_kde solid-actions-kcm systemsettings; do equery -q d ${x} &#124; sed -e "s/-[0-9].*//"; done &#124; sed -e "/kdebase-meta/g" -e "/kde-meta/g" &#124; xargs emerge --deselect --pretend}}
{{Note|This requires {{Package|app-portage/gentoolkit}} to be installed. See also: [[Gentoolkit]]}}
If you are sure to proceed, run the above command without <code>--pretend</code> again. Only the @world file is going to be changed - while the packages stay installed, they will not block a subsequent installation of Plasma 5.

=== Apply the changes ===

Any packages affected by the profile change need to be rebuilt:

{{RootCmd|emerge --ask --changed-use --newrepo --deep world}}

== Installation ==

The {{Package|kde-plasma/plasma-meta}} package provides the full Plasma 5 suite:

{{RootCmd|emerge --ask kde-plasma/plasma-meta}}

Alternatively, {{Package|kde-plasma/plasma-desktop}} provides the basic desktop, leaving you free to install only the extra packages you require:

{{RootCmd|emerge --ask kde-plasma/plasma-desktop}}

{{Note|Please note that you will be missing important packages such as {{Package|kde-plasma/powerdevil}} (power management, suspend and hibernate options) and {{Package|kde-plasma/systemsettings}} if you go that way.}}

=== Display manager ===

Up to this point, KDM will have served as [[display manager]] on most KDE 4 systems. As development on it has stopped, [[SDDM]] (Simple Desktop Display Manager) is now the recommended login manager and already got installed via {{package|kde-plasma/plasma-meta}}. Alternatively, [[LightDM]] can be used and pulled in by setting USE flag <code>-sddm</code> for {{package|kde-plasma/plasma-meta}}. Change the setting accordingly in {{Path| /etc/conf.d/xdm}}. Also, be sure to read through the [[SDDM]] page if further issues appear.

=== Applications ===

The previous steps have taken care of removing Plasma 4 and reverse dependencies from <code>@world</code> in order to be able to install Plasma 5. Consequentially, at this point there might be many dangling applications installed that would be removed by <code>emerge --depclean</code>. Check back with the list of applications that had been deselected in [[KDE/Plasma_5_upgrade#Clean_up_@world]], there might be newer versions available, compatible with Plasma-5 (with or without adjusting USE flags). Also, installing KDE Applications will bring many of those dependencies back, so precious CPU time can be saved by promptly proceeding with [[KDE#Applications]].
{{Note|Stable users need to skip this step as no Applications release has been stabilised at this point. {{package|kde-apps/kde-meta}} and {{package|kde-apps/kdebase-meta}} continue to work as expected in plasma profile.}}

== Migration ==

=== KWallet ===

KWallet 5 will have to open your wallet from KWallet 4 and import all the data into a new wallet. For that purpose, {{Package|kde-apps/kwalletd}} needs to be present at least once in a session after upgrade, but is still required for any KDE4-based application that might be using it. Run {{Package|kde-apps/kwalletmanager}} to check which applications have been accessing it in the past. If it is clear that no legacy package is using it anymore, it can be removed after migration.

{{RootCmd
|echo "kde-apps/kdebase-runtime-meta -oldwallet" >> /etc/portage/package.use
|emerge --ask --oneshot kde-apps/kdebase-runtime-meta && emerge -C kde-apps/kwalletd
}}

If you haven't ever used KWallet in KDE4, you also installed alternative {{Package|kde-plasma/plasma-desktop}} package and do not want to see KWallet popups at all then you should add the following strings into ~/.config/kwalletrc to disable the KWallet subsystem:
{{FileBox|filename=~/.config/kwalletrc|1=
[Wallet]
Enabled=false
}}
Relogin, and all KWallet popups will disappear.

=== SSH/GPG Agent startup/shutdown scripts ===

Configuration moved to {{Path|/etc/plasma/{startup,shutdown}}} for Plasma 5, you will need to copy your scripts from the old location.

{{Note|For KDE SC 4 the scripts are located in {{Path|/etc/kde/{startup,shutdown}}}.}}

== Troubleshooting ==

The most common issue with upgrading is running into blockers. Unfortunately, some packages just can't be co-installed so they'll need to be removed. Feel free to drop by [irc://chat.freenode.net/#gentoo #gentoo] or [irc://chat.freenode.net/#gentoo-kde #gentoo-kde] for assistance with resolving any blockers.


=== Missing systray icons ===

Plasma 5 uses the StatusNotifier specification for systray icons <ref>http://blog.martin-graesslin.com/blog/2014/03/system-tray-in-plasma-next/</ref>. As not all applications have been ported to the new system, some workarounds exist <ref>http://blog.martin-graesslin.com/blog/2014/06/where-are-my-systray-icons/</ref>, and Plasma 5.5 has a means to convert old xembed-based system tray icons to StatusNotifier icons.

The workaround can be enabled by activating the <code>legacy-systray</code> and GUI-specific (<code>gtk2</code>, <code>gtk3</code>, <code>qt4</code>) USE flags for {{package|kde-plasma/plasma-desktop}}.

{{RootCmd|echo "kde-plasma/plasma-desktop legacy-systray gtk2 gtk3 qt4" >> /etc/portage/package.use}}

Alternatively, the required packages can be installed manually:

For Qt 4 applications:

{{Emerge|dev-libs/sni-qt}}

For GTK+ 2 applications

{{Emerge|dev-libs/libappindicator:2}}

For GTK+ 3 applications:

{{Emerge|dev-libs/libappindicator:3}}

==== Pidgin ====

{{Package|net-im/pidgin}} requires {{Package|x11-plugins/pidgin-indicator}}. After install, find the ''Ubuntu Indicator'' plugin under ''Tools | Plugins''.

==== Skype ====

{{Package|net-im/skype}} is a 32-bit binary, you need to enable <code>abi_x86_32</code> on {{Package|dev-libs/sni-qt}}.

=== ck-list-sessions has wrong session information ===

Start plasma without {{c|exec}} or {{c|ck-launch-session}}.  Using {{c|dbus-launch --sh-syntax --exit-with-session "/usr/bin/startkde"}} was what I ended up using.

=== Missing shutdown/reboot/suspend/hibernate buttons (using OpenRC) ===

Please ensure that {{package|kde-plasma/powerdevil}} and {{package|sys-power/upower-pm-utils}} or {{package|sys-power/upower}} are installed. Also ensure that the user is in the {{c|users}} group.

If {{package|x11-misc/sddm}} is used, make sure it is version 0.12.0-r1 or later. Please run the following command and make sure it matches the output including <code>nox11</code>:

{{Cmd
|grep pam_ck_connector /etc/pam.d/system-login|output=<pre>
session         optional        pam_ck_connector.so nox11
</pre>}}

Another option is to create the following [[polkit]] rule for suspend<ref>https://bugs.kde.org/show_bug.cgi?id=344456#c38</ref>:

{{FileBox|filename=/etc/polkit-1/rules.d/10-suspend.rules|lang=javascript|1=
polkit.addRule(function(action, subject) {
    if (action.id == "org.freedesktop.upower.suspend") {
        return polkit.Result.YES;
    }
});
}}

If all else fails, try {{package|x11-misc/lightdm}} instead.

=== SDDM display issues ===

Check that your user (and {{c|sddm}} user) are in the {{c|video}} and {{c|audio}} groups.

SDDM does not yet support multi seat - lightdm does.

=== SDDM: KCM unable to change themes ===

SDDM needs a configuration file so that the KCM module can change themes. This file is not created during the SDDM installation, so it needs to be created manually afterwards:

{{RootCmd|sddm --example-config > /etc/sddm.conf}}

=== Missing application menus (users of x11-misc/appmenu-qt) ===

If previously {{Package|x11-misc/appmenu-qt}} was installed, application menus (file, edit, view, help, etc) in kdelibs4-based packages might be missing. There is no way to fix this via a GUI, kde rc files will need to be edited to restore the application menu in Plasma 5. Find out which files were modified using the following command:

{{Cmd|grep -iR menubar ~/.kde4}}

Change any lines containing <code><var>MenuBar</var>=Disabled</code> to <code><var>MenuBar</var>=true</code>, and the next time related applications are started, the menus should re-appear. Make sure all instances of <var>MenuBar</var> in the rc files are changed - some have more than one, like kmail2.

{{Package|x11-misc/appmenu-qt}} is not ready for prime time yet. It was tried with an initial ebuild and even with access violations, it does not work (despite it being available on some other distros).

=== Screen Tearing/Flicker when using Radeon graphics drivers ===
If you experience severe flickering or "tearing", when using Radeon based graphics cards, it may be necessary to change the Compositor sync settings found in: 

System Settings --> Display Monitor --> Compositor --> VSync

to something other than the default "Automatic".

== References ==

<references />

[[Category:KDE]]
