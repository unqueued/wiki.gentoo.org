When emerging packages it is possible to build them in tmpfs (RAM) space instead of having build files pushed and pulled to Hard Disk Drive (HDD) or Solid State Drive (SSD) space. Building in tmpfs both speeds up emerge times and reduces HDD/SSD wearing. For system's containing SSDs, it is generally a good idea to have Portage compile using tmpfs (RAM) instead burning up precious SSD write cycles (especially on something like compiling software).

== fstab Configuration ==

Mount Portage's <code>TMPDIR</code> to tmpfs by adding the following to the system's {{Path|/etc/fstab}} config file:
{{FileBox|filename=/etc/fstab|title=tmpfs fstab example|1=
tmpfs		/var/tmp/portage		tmpfs	uid=portage,gid=portage,mode=775,size=2048M,noatime	0 0
}}

Adjust the <code>size</code> parameter {{Path|/etc/fstab}} to the desired amount of RAM. Systems with large amounts of RAM can increase the number quite significantly.

After {{Path|/etc/fstab}} has been modified, mount Portage's TMPDIR to RAM by running the <kbd>mount</kbd> command followed by the directory location outline in {{Path|fstab}}:
{{RootCmd|mount /var/tmp/portage}}

== Considering tmpfs' Size ==
The system's tmpfs space should be large enough to handle the largest packages to be compiled on the system. If the tmpfs space were to ever become completely full then the emerge will fail. Most packages do not need more than 1 GB of tmpfs space their compiles, but there are few ''very'' large packages. If you have a lot of RAM, setting be careful to include enough tmpfs space when installing the following packages:

{{package|app-office/openoffice}}: 10GBs or so.

{{package|www-client/chromium}}: More than 2GBs.

{{package|sys-devel/gcc}}: More than 4 GiB.

== Per-Package Choices at Compile Time ==
Portage can be configured to build large packages outside of the tmpfs space on a per-package basis.

Create a file to tell Portage where to place the temporary files directory:
{{FileBox|filename=/etc/portage/env/notmpfs.conf|1=
PORTAGE_TMPDIR="/var/tmp/notmpfs"
}}

Create a separate temporary file directory outside of the tmpfs mount location:
{{RootCmd
|mkdir /var/tmp/notmpfs
|chown portage:portage /var/tmp/notmpfs
|chmod 775 /var/tmp/notmpfs
}}

Create a special Portage file called [[!/etc/portage/package.env|{{Path|package.env}}]] in {{Path|/etc/portage}} and list all the packages that are too large to be compiled using tmpfs:
{{FileBox|filename=/etc/portage/package.env|1=
app-office/libreoffice notmpfs.conf
mail-client/thunderbird notmpfs.conf
www-client/chromium notmpfs.conf
www-client/firefox notmpfs.conf
}}

== Pro Tips ==

=== Temporarily Increase TmpFs Size ===

First, a warning on tmpfs size from Linux kernel's Documentation/filesystems/tmpfs.txt

<pre>
size: The limit of allocated bytes for this tmpfs instance. The default is half of your physical RAM without swap. If you oversize your tmpfs instances the machine will deadlock since the OOM handler will not be able to free that memory.
</pre>

There is a rule of thumb: always leave-out at least 1G space.

You can resize your tmpfs by doing. 
{{RootCmd
|mount -o remount,size{{=}}7G /var/tmp/portage
}}
This will not persist into the next boot.

It *should* be safe to enlarge the tmpfs during an emerge, though it's doubtful that you'll ever have to do that. If anything, emerge will tell you the tmpfs is too small, you can enlarge it or add the exception to /etc/portage/package.env, and then emerge again.

=== Save an emerge and Resume Later ===

{{Note|This is experimental. ebuild experts should be queried about how reliable this command is; when to use it and when not to.}}
'''Example''': emerging webkit-gtk can take a long time. I want to reboot into another OS and resume this ebuild later.

* ''Optional'': I use ''app-portage/genlop'' to inspect my current emerge. I like using it to remind me of the ebuild version number or hopefully to get an ETA.
{{Cmd|genlop -c|output=<pre>

Currently merging 1 out of 2

 * net-libs/webkit-gtk-2.4.8 

       current merge time: 4 hours, 27 minutes and 35 seconds.
       ETA: unknown.

</pre>
}}
* I ctrl-C out of the current emerge
* since I am rebooting, I'll have to use cp -a or tar -cpf to save /var/tmp/portage/* while preserving permissions. Otherwise the tmpfs contents will be lost; You may want to inspect the memory size of /var/tmp/portage by using du:
{{RootCmd|du -sh /var/tmp/portage/|output=<pre>251M	/var/tmp/portage/</pre>}}
* reboot, do other stuff, come back
* restore /var/tmp/portage/*
* resume the ebuild -- DO NOT use the ebuild found in /var/tmp/portage/*path-to-package*/build-info/*packagename-ver*.ebuild. It seems to cause immediate failure. Use the ebuild in /usr/portage/*path-to-package*/*packagename-ver*.ebuild.
{{RootCmd
|ebuild /usr/portage/net-libs/webkit-gtk/webkit-gtk-2.6.5.ebuild merge
|output=<pre>

>>> Existing ${T}/environment for 'webkit-gtk-2.6.5' will be sourced. Run
>>> 'clean' to start with a fresh environment.
>>> Checking webkitgtk-2.6.5.tar.xz's mtime...
>>> WORKDIR is up-to-date, keeping...
 * checking ebuild checksums ;-) ...                                                                                                                   [ ok ]
 * checking auxfile checksums ;-) ...                                                                                                                  [ ok ]
 * checking miscfile checksums ;-) ...                                                                                                                 [ ok ]
>>> It appears that 'setup' has already executed for 'webkit-gtk-2.6.5'; skipping.
>>> Remove '/var/tmp/portage/net-libs/webkit-gtk-2.6.5/.setuped' to force setup.
>>> It appears that 'unpack' has already executed for 'webkit-gtk-2.6.5'; skipping.
>>> Remove '/var/tmp/portage/net-libs/webkit-gtk-2.6.5/.unpacked' to force unpack.
>>> It appears that 'prepare' has already executed for 'webkit-gtk-2.6.5'; skipping.
>>> Remove '/var/tmp/portage/net-libs/webkit-gtk-2.6.5/.prepared' to force prepare.
>>> Configuring source in /var/tmp/portage/net-libs/webkit-gtk-2.6.5/work/webkitgtk-2.6.5 ...
>>> Working in BUILD_DIR: "/var/tmp/portage/net-libs/webkit-gtk-2.6.5/work/webkit-gtk-2.6.5_build"
..
..
.</pre>
}}

Happy hacking :)

[[Category:Portage]]
