== Introduction ==
Basically this is post is an extension to [[Btrfs/Native System Root Guide]] which adds [[Dm-crypt]] and uses [[Dracut]] to create the initramfs rather then dealing with the [[Early Userspace Mounting]] approach. As the root, which also includes /boot, partition will end up encrypted, we'll store the keyfile to unlock the btrfs raid partitions within the initramfs. This may be a bit unsafer on runtime as the keyfile ends up in memory but we gain a faster boot process without the need to input the password 4 times (2 x grub and 2 x  btrfs raid1). I also have an btrs raid6 with 6 full encrypted disks and this would lead me to enter my password 10 times to have a fully working system. so i'm happy with embedding the keyfile within the initramfs.

We'll migrate an existing MD software raid1 to an btrfs raid1 without adding extra disks. So better make backups of your data!
I assume the raid members to be <code>/dev/sda</code> and <code>/dev/sdb</code> of <code>/dev/md1</code>.

The whole procedure is straight forward but you have to double check a few things i'll mention later. Please carefully read the whole post and pay extra attention to grub2 and dracut.

== Required packages ==
First add the required use flags for the packages.
As i'm a lazy person :) i'll use genkernel-next to do the work even if i'll replace the initramfs with the dracut one.

{{RootCmd|echo "sys-apps/systemd cryptsetup" >> /etc/portage/package.use}}
{{RootCmd|echo "sys-boot/grub device-mapper" >> /etc/portage/package.use}}
{{RootCmd|echo "sys-fs/cryptsetup static kernel -gcrypt" >> /etc/portage/package.use}}
{{RootCmd|echo "sys-kernel/genkernel-next cryptsetup" >> /etc/portage/package.use}}
{{RootCmd|echo "sys-kernel/dracut systemd device-mapper" >> /etc/portage/package.use}}


Next unmask the packages (Please change the keyword as needed for your system).
We'll use the latest available versions.

{{RootCmd|echo "sys-fs/btrfs-progs ~amd64" >> /etc/portage/package.keywords}}
{{RootCmd|echo "sys-boot/grub:2 ~amd64" >> /etc/portage/package.keywords}}
{{RootCmd|echo "sys-fs/cryptsetup ~amd64" >> /etc/portage/package.keywords}}
{{RootCmd|echo "sys-kernel/genkernel-next ~amd64" >> /etc/portage/package.keywords}}
{{RootCmd|echo "sys-kernel/gentoo-sources ~amd64" >> /etc/portage/package.keywords}}

install the required packages

{{RootCmd|emerge -av systemd grub:2 cryptsetup genkernel-next btrfs-progs dracut gentoo-sources}}


If this installs newer kernel sources, please change the symlink either using <code>eselect kernel</code> or do it manually.

== Preparing the first disk ==

=== Dealing with the software raid ===

Remove <code>/dev/sda</code> drive from md array

{{RootCmd|mdadm --manage /dev/md1 --fail /dev/sda}}
{{RootCmd|mdadm --manage /dev/md1 --remove /dev/sda}}
{{RootCmd|mdadm --zero-superblock /dev/sda}}


=== Partition the drive ===

We create a bios boot partition and use the remaining space for the root partition.

{{RootCmd|gdisk /dev/sda|output=<pre>

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048            8191   3.0 MiB     EF02  BIOS boot partition
   2            8192       250069679   119.2 GiB   8300  Linux filesystem</pre>}}
