<languages />
{{Metadata|abstract=포티지는 바이너리 꾸러미 빌드 및 설치를 지원합니다. 이 안내서는 바이너리 꾸러미 호스트를 만들고 바이너리 꾸러미를 활용하는 방법을 설명합니다.}}

Next to the usual support for ebuilds, Portage supports building and installing binary packages.
This guide explains how to create them, how to install them and how to setup a binary package server.

== 도입부 ==

There are many reasons why some system administrators like using binary package installations in Gentoo.

# First of all, it allows administrators to ''keep similar systems updated''. Having to compile everything from source can become time consuming. Maintaining several similar systems, possibly some of them with older hardware, can be much easier if only one system has to compile everything from source and the other systems reuse the binary packages.
# A second reason is to ''do safe updates''. For mission critical systems it is important to stay ''usable'' as much as possible. This can be done by a staging server that performs all updates first to itself. Once the staging server is in a good state the updates can then be applied to the critical systems. A variant of this approach is to do the updates in a chroot on the same system and use the binaries created there on the real system.
# A third reason is ''as a backup''. Often binary packages are the only way of recovering a broken system (i.e. broken compiler). Having pre-compiled binaries around either on a binary package server or locally can be of great help in case of a broken toolchain.
# Finally, it also supports ''updating very old systems''. The task of updating very old systems can be greatly eased using binary packages. It is usually helpful to install binary packages on old systems because they do not require build time dependencies to be installed/updated. Binaries packages also avoid failures in build processes since they are pre-compiled.

This guide will focus on the following topics: 
* How to create binary packages;
* How to distribute the packages to clients;
* How to use binary packages;
* How to maintain the binary packages.

Near the end a few more advanced topics on dealing with binary packages will be covered.

{{Note/ko|이 안내서에서 다루는 모든 도구는 별도로 명시하지 않는 한, {{Package|sys-apps/portage}}의 일부입니다.}}

== 바이너리 꾸러미 만들기 ==

There are three main methods for creating binary packages:
# After a regular installation, using the <tt>quickpkg</tt> application;
# Explicitly during an emerge operation by using the <code>--buildpkg (-b)</code> option;
# Automatically through the use of the <code>buildpkg</code> as a Portage feature.

이 모든 세가지 방식은 <code>PKGDIR</code> 변수에서 가리치는 디렉터리에 바이너리 꾸러미를 만듭니다(기본값은 {{Path|/usr/portage/packages}}).

=== quickpkg 사용하기 ===

The <tt>quickpkg</tt> application takes one or more dependency atoms (or package sets) and creates binary packages for all ''installed'' packages that match that atom.

For instance, to create binary packages of all ''installed'' GCC versions:

{{RootCmd|quickpkg sys-devel/gcc}}

To create binary packages of all installed packages on the system, use the <code>*</code> glob:

{{RootCmd|quickpkg "*/*"}}

There is a caveat with this method: it relies on the installed files, which can be a problem in case of configuration files. Administrators often change configuration files after installing software. Because this could leak out important (perhaps even confidential) data into the packages, <tt>quickpkg</tt> by default does ''not'' include configuration files that are protected through the <code>CONFIG_PROTECT</code> method. To force inclusion of configuration files, use the <code>--include-config</code> or <code>--include-unmodified-config</code> options.

=== Using --buildpkg as an emerge option ===

When installing software using <tt>emerge</tt>, Portage can be asked to create binary packages by using <code>--buildpkg (-b)</code> option:

{{Emerge|params+=--buildpkg|sys-devel/gcc}}

It is also possible to ask Portage to ''only'' create a binary package but ''not'' to install the software on the live system. For this, the <code>--buildpkgonly (-B)</code> option can be used:

{{Emerge|params+=--buildpkgonly|sys-devel/gcc}}

The latter approach however requires all build time dependencies to be previously installed.

=== Implementing buildpkg as a Portage feature ===

The most common way to automatically create binary packages whenever a package is installed by Portage is to use the <code>buildpkg</code> feature, which can be set in {{Path|/etc/portage/make.conf}} like so:

{{FileBox|filename=/etc/portage/make.conf|title=Enabling Portage's buildpkg feature|lang=bash|1=
FEATURES="${FEATURES} buildpkg"
}}

With this feature enabled, every time Portage installs software it will create a binary package as well.

=== 일부 꾸러미 생성 제외 ===

It is possible to tell Portage not to create binary packages for a select few packages or categories. This is done by passing the <code>--buildpkg-exclude</code> option to emerge:

{{RootCmd|emerge -uDN @world --buildpkg --buildpkg-exclude "virtual/* sys-kernel/*-sources"}}

이 방법은 존재하는 바이너리 패키지를 취하는데 조금 또는 어떠한 이득조차도 없이 꾸러미를 취득하는데 활용할 수 있습니다. 리눅스 커널 소스 꾸러미 또는 업스트림 바이너리 꾸러미가 예가 될 수 있습니다({{Package|www-client/firefox-bin}}과 같이 ''-bin''으로 끝나는 꾸러미).

== 바이너리 꾸러미 호스트 설정==

포티지는 바이너리 꾸러미를 다운로드할 다양한 프로토콜, FTP, FTPS, HTTP, HTTPS, SSH를 지원합니다. 이 특징은 바이너리 꾸러미 호스트 구현에 대한 다양한 가능성의 여지를 남겨놓았습니다.

There is, however, no "out-of-the-box" method provided by Portage for distributing binary packages. Depending on the desired setup additional software will need to be installed.

=== 웹기반 바이너리 꾸러미 호스트 ===

A common approach for distributing binary packages is to create a web-based binary package host.

Use a web server such as [[lighttpd]] ({{Package|www-servers/lighttpd}}) and configure it to provide read access to {{Path|/etc/portage/make.conf}}'s <code>PKGDIR</code> location.

{{FileBox|filename=/etc/lighttpd/lighttpd.conf|title=lighttpd configuration example|lang=bash|1=
# add this to the end of the standard configuration
server.modules += ( "mod_alias" )
alias.url = ( "/packages" => "/usr/portage/packages/" )
}}

Then, on the client systems, configure the <code>PORTAGE_BINHOST</code> variable accordingly:

{{FileBox|filename=/etc/portage/make.conf|title=Using a web-based binary package host|lang=bash|1=
PORTAGE_BINHOST="http://binhost.genfic.com/Packages"
}}

=== SSH 바이너리 꾸러미 호스트 ===

바이너리 꾸러미를 인증 방식으로 제공하려면 SSH 사용을 고려할 수 있습니다.

When using SSH, it is possible to use the Portage Linux user's SSH key (without passphraze as the installations need to happen in the background) to connect to a remote binary package host.

To accomplish this, make sure that the Portage user's SSH key is allowed on the server:

{{RootCmd|cat portage.id_rsa.pub >> /home/binpkguser/.ssh/authorized_keys}}

<code>PORTAGE_BINHOST</code> 변수 값은 다음과 같이 바뀔 수 있습니다:

{{FileBox|filename=/etc/portage/make.conf|title=Setting up PORTAGE_BINHOST for SSH access|lang=bash|1=
PORTAGE_BINHOST="ssh://binpkguser@binhostserver/usr/portage/packages"
}}

{{Note|1=Don't use ssh's config in {{Path|~/.ssh/config}} for setting ports or username as it'll be ignored when portage tries to rsync the packages back onto the client. Instead set all the options correctly in the <code>PORTAGE_BINHOST=</code> variable.}}

=== NFS 내보내기 ===

When using binary packages on an internal network, it might be easier to export the packages through NFS and mount it on the clients.

{{Path|/etc/exports}} 파일은 다음과 같이 바꿀 수 있습니다:

{{FileBox|filename=/etc/exports|title=꾸러미 디렉터리 내보내기|1=
/usr/portage/packages                            2001:db8:81:e2::/48(ro,no_subtree_check,root_squash) 192.168.100.1/24(ro,no_subtree_check,root_squash)
}}

이 과정이 끝나면 클라이언트에서는 해당 위치를 마운트할 수 있습니다. {{Path|/etc/fstab}} 예제 항목은 다음과 같습니다:

{{FileBox|filename=/etc/fstab|title=꾸러미 폴더 마운트 항목|1=
binhost:/usr/portage/packages      /usr/portage/packages    nfs    defaults    0 0
}}


== 바이너리 꾸러미 사용하기 ==

다른 시스템에서 바이너리 꾸러미를 쓸만하게 하려면 몇가지 요구조건을 만족해야 합니다.
* 클라이언트와 서버 아키텍처 및 [[CHOST]] 설정이 일치해야 합니다.
* 바이너리 꾸러미를 빌드하는데 사용했던 <code>CFLAGS</code>와 <code>CXXFLAGS</code>값이 다른 클라이언트와 호환되어야합니다.
* 프로세서별 기능에 해당하는 USE 플래그(MMX, SSE 같은 경우)는 조심스럽게 선택해야 합니다. 모든 클라이언트에서 해당 USE 플래그를 지원해야합니다.

{{Important|Portage can not validate if these requirements match. It is the responsibility of the system administrator to guard these settings.}}

Next to these, Portage will check if the binary package is built using the same USE flags as expected on the client. If a package is built with a different USE flag combination, Portage will either ignore the binary package (and use source-based build) or fail, depending on the options passed to the emerge command upon invocation (see [[#Installing binary packages|Installing binary packages]]).

클라이언트쪽에서는, 사용할 바이너리 꾸러미에 대한 약간의 설정을 바꾸기만 하면 됩니다.

=== 바이너리 꾸러미 설치 ===

There are a few options that can be passed on to the <tt>emerge</tt> command that inform Portage about using binary packages:

{| class="wikitable"
|-
! Option !! Description
|-
| <code>--usepkg (-k)</code> || Tries to use the binary package(s) in the locally available {{Path|packages}} directory. Useful when using [[NFS]] or [[SSHFS]] mounted binary package hosts. If the binary packages are not found, a regular (source-based) installation will be performed.
|-
| <code>--usepkgonly (-K)</code> || Similar to <code>--usepkg (-k)</code> but fail if the binary package cannot be found. This option is useful if only ''pre-built'' binary packages are to be used.
|-
| <code>--getbinpkg (-g)</code> || Download the binary package(s) from a remote binary package host. If the binary packages are not found, a regular (source-based) installation will be performed.
|-
| <code>--getbinpkgonly (-G)</code> || Similar to <code>--getbinpkg (-g)</code> but will fail if the binary package(s) cannot be downloaded. This option is useful if only ''pre-built'' binary packages are to be used.
|}

바이너리 꾸러미 설치를 자동으로 활용한다면, <code>EMERGE_DEFAULT_OPTS</code> 변수에 적당한 옵션 값을 추가할 수 있습니다:

{{FileBox|filename=/etc/portage/make.conf|title=Automatically fetching binary packages and fail if not available|lang=bash|1=
EMERGE_DEFAULT_OPTS="${EMERGE_DEFAULT_OPTS} --getbinpkgonly"
}}

There is a Portage feature that automatically implements the equivalent of <code>--getbinpkg (-g)</code> without the need for updating the <code>EMERGE_DEFAULT_OPTS</code> variable: ''getbinpkg''.

{{FileBox|filename=/etc/portage/make.conf|title=Enabling getbinpkg as Portage feature|lang=bash|1=
FEATURES="${FEATURES} getbinpkg"
}}

=== 바이너리 꾸러미 호스트에서 꾸러미 가져오기 ===

When using a binary package host, clients need to have the <code>PORTAGE_BINHOST</code> variable set. Otherwise the client will not know where the binary packages are stored which results in Portage being unable to retrieve them.

{{FileBox|filename=/etc/portage/make.conf|title=PORTAGE_BINHOST 설정|lang=bash|1=
PORTAGE_BINHOST="http://binhost.genfic.com/packages"
}}

<code>PORTAGE_BINHOST</code> 변수는 공백 구분 URI 값을 사용합니다. 이를 통해 관리자가 다양한 바이너리 꾸러미 서버를 동시에 활용할 수 있습니다. URI는 항상 반드시 {{Path|Packages}} 파일이 위치한 디렉터리를 가리켜야합니다.

{{Note|The support for multiple binary package servers is somewhat incomplete. If several servers serve a binary package for the same package version, then only the first one will be considered. This can be problematic when these binary packages differ in their <code>USE</code> configuration and the <code>USE</code> configuration of a later binary package would match the systems configuration.}}

=== 수정한 바이너리 꾸러미 재설치 ===

Passing the <code>--rebuilt-binaries</code> option to emerge will reinstall every binary that has been rebuilt since the package was installed. This is useful in case rebuilding tools like <tt>revdep-rebuild</tt> or <tt>python-updater</tt> are run on the binary package server.

관련 옵션은 <code>--rebuilt-binaries-timestamp</code>입니다. 이 옵션은 바이너리 꾸러미를 타임스탬프를 부여받기 이전에 빌드했을 경우 이머지가 바이너리 꾸러미를 재설치를 고려하지 않도록 합니다. 이 옵션은 바이너리 꾸러미 서버를 처음부터 다시 빌드했지만 <code>--rebuilt-binaries</code> 옵션을 다른 경우에 활용했을 경우 유용합니다.

=== 추가 클라이언트 설정 ===

Next to the ''getbinpkg'' feature, Portage also listens to the ''binpkg-logs'' feature. This one controls if log files for successful binary package installations should be kept. It is only relevant if <code>PORT_LOGDIR</code> is set and is enabled by default.

몇가지 꾸러미 모음 또는 항목 분류에서 바이너리 꾸러미를 제외하는 유사한 방법으로, 클라이언트에서 꾸러미 모음 또는 항목 분류와 같은 바이너리 꾸러미 설치를 제외하도록 설정할 수 있습니다.

설정을 완료하려면, <code>--usepkg-exclude</code> 옵션을 사용하십시오:

{{RootCmd|emerge -uDNg @world --usepkg-exclude "sys-kernel/gentoo-sources virtual/*"}}


== 바이너리 꾸러미 관리 ==

바이너리 꾸러미를 내보내고 배포하는 작업은 실제로 바이너리 꾸러미 목록을 유지하지 않을 경우 불필요한 저장소 낭비를 초래할 수 있습니다.

=== 오래된 바이너리 꾸러미 제거 ===

In the {{Package|app-portage/gentoolkit}} package an application called <tt>eclean</tt> is provided. It allows for maintaining Portage-related variable files, such as downloaded source code files, but also binary packages.

다음 명령은 ebuild에 관계없는 모든 각각의 바이너리 꾸러미를 제거합니다:

{{RootCmd|eclean packages}}

자세한 내용은 [[Eclean]] 게시물을 읽어보십시오.

Another tool that can be used is the <tt>qpkg</tt> tool from the {{Package|app-portage/portage-utils}} package. However, this tool is a bit less configurable.

(바이너리 꾸러미를 저장한 서버에서 사용하는 개념 차원에서)''사용하지 않는'' 바이너리 꾸러미를 지우려면:

{{RootCmd|qpkg -c}}

=== 꾸러미 파일 관리 ===

Inside the packages directory, a file called {{Path|Packages}} exists. This file acts as a cache for the metadata of all binary packages in the packages directory. The file is updated whenever Portage adds a binary package to the directory. Similarly, <tt>eclean</tt> updates it when it removes binary packages.

If for some reason binary packages are simply deleted or copied into the packages directory, or the {{Path|Packages}} file gets corrupted or deleted, then it must be recreated. This is done using <tt>emaint</tt> command:

{{RootCmd|emaint binhost --fix}}

== 고급 주제 ==

=== 꾸러미 디렉터리 스냅샷 만들기 ===

When deploying binary packages for a large number of client systems it might become worthwhile to create snapshots of the packages directory. The client systems then do not use the packages directory directly but use binary packages from the snapshot.

Snapshots can be created using the {{Path|/usr/lib64/portage/python2.7/binhost-snapshot}} or {{Path|/usr/lib64/portage/python3.3/binhost-snapshot}} tool. It takes four arguments, 
# A source directory (the path to the packages directory); 
# A target directory (that must not exist);
# A URI;
# A binary package server directory.

꾸러미 디렉터리의 파일은 대상 디렉터리로 복사합니다. 그 다음 주어진 URI의 바이너리 꾸러미 서버 디렉터리(네번째 매개변수)에 {{Path|Packages}} 파일을 만듭니다.

Client systems need to use an URI that points to the binary package server directory. From there they will be redirected to the URI that was given to <tt>binhost-snapshot</tt>. This URI has to refer to the target directory.

=== 바이너리 꾸러미 형식 이해 ===

Binary packages created by Portage have the file name ending with "tbz2". These files consist of two parts:
# A .tar.bz2 archive containing the files that will be installed on the system;
# A xpak archive containing package metadata, the ebuild and the environment file.

See <kbd>man xpak</kbd> for a description of the format.

{{Package|app-portage/portage-utils}} 에 tbz2와 xpak 형식의 파일을 나누거나 만들 수 있는 몇가지 도구가 있습니다.

다음 명령은 tbz2를 {{Path|.tar.bz2}} 파일과 {{Path|.xpak}} 파일로 나눕니다:

{{Cmd|qtbz2 -s <package>.tbz2}}

The xpak file can be examined using the <tt>qxpak</tt> utility.

내용을 조회하려면:

{{Cmd|qxpak -l <package>.xpak}}

The next command will extract a file called {{Path|USE}} which contains the enabled USE flags for this package:

{{Cmd|qxpak -x package-manager-0.xpak USE}}

=== PKGDIR 배치 ===

현재 사용하는 버전 2 형식은 다음 배치를 따릅니다:

{{CodeBox|title=Packages directory layout (version 2)|1=
PKGDIR
`+- Packages
 +- app-accessibility/
 {{!}}  +- pkg1-version.tbz2
 {{!}}  `- pkgN-version.tbz2
 +- app-admin/
 {{!}}  `- ...
 `- ...
}}

The {{Path|Packages}} file is the major improvement (and also the trigger for Portage to know that the binary package directory uses version 2) over the first binary package directory layout (version 1). In version 1, all binary packages were also hosted inside a single directory (called {{Path|All/}}) and the category directories only had symbolic links to the binary packages inside the {{Path|All/}} directory.

=== quickunpkg로 꾸러미 해제하기 ===

Zoobab이 tbz2 파일을 빨리 풀어내기 위해 [https://github.com/zoobab/quickunpkg quickunpkg]라고 하는 간단한 명령줄 도구를 작성했습니다.


[[Category:Portage]]
