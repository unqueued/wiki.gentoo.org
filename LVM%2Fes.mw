<languages />

{{Metadata|abstract=LVM permite a los administradores crear metadispositivos que ofrecen una capa de abstracción entre un sistema de ficheros y el almacenamiento físico que se utiliza por debajo.}}

{{InfoBox stack
|{{InfoBox wikipedia|LVM|header=true}}
}}

'''LVM''' ('''L'''ogical '''V'''olume '''M'''anager) permite a los administradores crear metadispositivos que ofrecen una capa de abstracción entre un sistema de ficheros y el almacenamiento físico que se utiliza por debajo. Los metadispositivos (en los cuales se alojan los sistemas de ficheros) son ''volúmenes lógicos'' que utilizan almacenamiento que se obtiene de espacios de almacenamiento  llamados ''grupos de volumen''. Un grupo de volumen se abastece con uno o más ''volúmenes físicos'' que son los auténticos dispositivos en los que se almacenan los datos.

Los volúmenes físicos pueden ser particiones, discos SATA completos agrupados como JBOD ('''J'''ust a '''B'''unch '''O'''f '''D'''isks o '''Simplemente un puñado de discos'''), sistemas RAID, iSCSI, Fibre Channel, eSATA etc.

== Instalación ==

LVM se gestiona por los controladores al nivel de núcleo y por aplicaciones en el espacio de usuario que permiten gestionar la configuración de LVM.

=== Núcleo ===

Activar las siguientes opciones del núcleo:

{{KernelBox|<pre>
Device Drivers --->
 Multiple devices driver support (RAID and LVM) --->
  <*> Device mapper support
    <*> Crypt target support
    <*> Snapshot target
    <*> Mirror target
  <*> Multipath target
    <*> I/O Path Selector based on the number of in-flight I/Os
    <*> I/O Path Selector based on the service time </pre>}}

{{Note|Not everything needs to be enabled; some of the options are only needed for [[LVM#LVM2_snapshots_and_thin_snapshots|LVM2 Snapshots and LVM2 Thin Snapshots]], [[LVM#Mirrored_volumes|LVM2 Mirrors]], [[LVM#Striping_.28RAID0.29|LVM2 RAID 0/Stripeset]] and encryption.}}

=== Software ===

Instalar {{Package|sys-fs/lvm2}}:

{{USEflag|package=sys-fs/lvm2
|clvm
|cman
|lvm1+yes
|readline+yes
|selinux++no
|static
|static-libs
|thin+yes
|udev+yes
}}

{{Emerge|lvm2}}

== Configuración ==

Configuring LVM is done on several levels:
# LV, PV and VG management through the management utilities;
# LVM subsystem fine-tuning through the configuration file;
# Service management at the distribution level;
# Setup through an initial ram file system (initramfs).

La gestión de los volúmenes físicos y lógicos así como de los grupos de volumen se gestiona en el capítulo [[#Utilización|Utilización]].

=== Fichero de configuración de LVM ===

LVM posee un fichero de configuración muy extenso en {{Path|/etc/lvm/lvm.conf}}. La mayoría de usuarios no necesitan modificar ningún aspecto de este fichero para comenzar a usar LVM.

=== Gestión de servicios ===

Gentoo ofrece el servicio LVM para detectar automáticamente los grupos de volumen y los volúmenes lógicos.

Se puede gestionar este servicio a través del sistema de inico.

==== openrc ====

Para iniciar LVM manualmente:

{{RootCmd|/etc/init.d/lvm start}}

Para iniciar LVM cuando arranque el sistema:

{{RootCmd|rc-update add lvm boot}}

==== systemd ====

Para iniciar LVM manualmente:

{{RootCmd|systemctl start lvm2-monitor.service}}

Para iniciar LVM cuando arranque el sistema:

{{RootCmd|systemctl enable lvm2-monitor.service}}

=== Usar LVM en un initramfs ===

La mayoría de los cargadores de arranque no pueden iniciar directamente desde LVM. Ni GRUB Legacy ni LILO pueden hacerlo. Grub 2 PUEDE iniciar desde un volumen lógico LVM lineal, desde un volumen lógico en espejo y probablemente desde algunos tipos de volúmenes lógicos RAID. Ningún cargador de arranque ofrece soporte actualmente para volúmenes lógicos delgados (thin). 

Debido a esto, se recomienda utilizar una partición de arranque que no sea LVM y montar la partición raíz LVM desde un initramfs. Se puede generar este initramfs de forma automática mediante [[Genkernel/es|genkernel]], {{Package|sys-kernel/genkernel-next}} y [[dracut]]:

* <tt>genkernel</tt> can boot from all types except thin volumes (as it neither builds nor copies the {{Package|thin-provisioning-tools}} binaries from the build host) and maybe RAID10 (RAID10 support requires LVM2 2.02.98, but genkernel builds 2.02.89, however if static binaries are available it can copy those);
* <tt>genkernel-next</tt> can boot from all types volumes, but needs a new enough {{Package|app-misc/pax-utils}} or the resulting thin binaries will be broken (See {{Bug|482504}});
* <tt>dracut</tt> should boot all types, but only includes thin support in the initramfs if the host being run on has a thin root.

==== Genkernel/Genkernel-next ====

Haga emerge de {{Package|sys-kernel/genkernel}} o de {{Package|sys-kernel/genkernel-next}}. El ajuste USE static también se puede activar en el paquete {{Package|sys-fs/lvm2}} de modo que genkernel utilice los binarios del sistema (de lo contrario construirá su propia copia privada). El siguiente ejemplo construirá únicamente un initramfs (no el núcleo completo) y habilitará el soporte para LVM.

{{RootCmd|genkernel --lvm initramfs}}

La página del manual de genkernel describe otras opciones que dependen de los requisitos del sistema.

El initrd requerirá parámetros para indicarle cómo iniciar LVM. Éstos se pasan igual que el resto de parámetros del núcleo. Por ejemplo:

{{FileBox|filename=/etc/default/grub|title=Añadir dolvm como parámetro de inicio del núcleo|lang=bash|1=
GRUB_CMDLINE_LINUX="dolvm"
}}

==== Dracut ====

El paquete {{Package|sys-kernel/dracut}} se portó desde el proyecto RedHat y es una herramienta similar para generar un initramfs. Ya que actualmente  Since it is currently se encuentra en pruebas (~arch), los usuarios necesitarán [[Knowledge_Base:Accepting_a_keyword_for_a_single_package|aceptar este hecho]] (a través de {{Path|/etc/portage/package.accept_keywords}}) para poder hacer emerge. Antes de hacerlo, se debería añadir la variable <code>DRACUT_MODULES="lvm"</code> a {{Path|/etc/portage/make.conf}}. Puede que se quieran instalar otros módulos, por favor, eche un vistazo a [[Dracut]]. Normalmente la siguiente orden genera un initramfs funcional por defecto.

{{RootCmd|dracut -a lvm}}

El initrd requerirá parámetros para indicarle cómo iniciar lvm. Éstos se pasan igual que el resto de parámetros del núcleo. Por ejemplo:

{{FileBox|filename=/etc/default/grub|title=Añadir soporte para LVM a los parámetros de inicio del núcleo|lang=bash|1=
GRUB_CMDLINE_LINUX="rd.lvm.vg=vol00"
}}

For a comprehensive list of LVM options within <tt>dracut</tt> please see the section in the [https://www.kernel.org/pub/linux/utils/boot/dracut/dracut.html#_lvm Dracut Manual].

== Utilización ==

LVM organiza el almacenamiento en tres niveles diferentes como se muestra a continuación:
* Los discos duros, particiones, sistemas RAID y otros modos de almacenamiento se inicializan como volúmenes físicos (PVs)
* Los Volúmenes Físicos (PV) se agrupan en Grupos de Volumen (VG)
* Los Volúmenes Lógicos (LV) se gestionan en los Grupos de Volumen (VG)

=== PV (Volumen Físico) ===
Los Volúmenes Físicos son el hardware o el sistema de almacenamiento sobre el que se construye LVM.

==== Particionamiento ====

{{Note/es|Solo se necesita usar particiones separadas para proveer de almacenamiento a los grupos de volumen en el caso de que no se quiera utilizar todo el disco para un solo grupo de volúmenes LVM. Si se puede utilizar todo el disco, entonces ignore esto e inicialice el disco duro completo como un volumen físico.}}

El tipo de partición para ''LVM'' es ''8e'' (Linux LVM).

For instance, to set the type through <tt>fdisk</tt> for a partition on {{Path|/dev/sda}}:

{{RootCmd|fdisk /dev/sda}}

In <tt>fdisk</tt>, create partitions using the {{Key|n}} key and then change the partition type with the {{Key|t}} key to ''8e''.

==== Crear PV ====

Physical volumes can be created / initialized with the <tt>pvcreate</tt> command.

Por ejemplo, la siguiente orden crea un volumen físico en la primera partición primar de los discos {{Path|/dev/sda}} y {{Path|/dev/sdb}}:

{{RootCmd|pvcreate /dev/sd[ab]1}}

==== Listar PV ====

With the <tt>pvdisplay</tt> command, an overview of all active physical volumes on the system can be obtained.

{{RootCmd|pvdisplay|output=<pre>
--- Physical volume ---
PV Name /dev/sda1
VG Name volgrp
PV Size 160.01 GiB / not usable 2.31 MiB
Allocatable yes
PE Size 4.00 MiB
Total PE 40962
Free PE 4098
Allocated PE 36864
PV UUID 3WHAz3-dh4r-RJ0E-5o6T-9Dbs-4xLe-inVwcV

--- Physical volume ---
PV Name /dev/sdb1
VG Name volgrp
PV Size 160.01 GiB / not usable 2.31 MiB
Allocatable yes
PE Size 4.00 MiB
Total PE 40962
Free PE 40962
Allocated PE 0
PV UUID b031x0-6rej-BcBu-bE2C-eCXG-jObu-0Boo0x
</pre>}}

If more physical volumes should be displayed, then <tt>pvscan</tt> can detect inactive physical volumes and activate those.

{{RootCmd|pvscan|output=<pre>
PV /dev/sda1 VG volgrp lvm2 [160.01 GiB / 16.01 GiB free]
PV /dev/sdb1 VG volgrp lvm2 [160.01 GiB / 160.01 GiB free]
Total: 2 [320.02 GB] / in use: 2 [320.02 GiB] / in no VG: 0 [0]
</pre>}}

==== Eliminar PV ====

LVM distribuye los datos automáticamente entre todos los volúmenes físicos disponibles (a menos que se le indique lo contrario) usando un enfoque lineal. Si un volumen lógico (dentro de un grupo de volumen) es menor que la cantidad total de espacio libre en un volumen físico, entonces todo el espacio se reclama de ese (único) volumen físico de una forma continua. Esto se hace así por cuestiones de rendimiento.

If a physical volume needs to be removed from a volume group, the data first needs to be moved away from the physical volume. With the <tt>pvmove</tt> command, all data on a physical volume is moved to other physical volumes within the same volume group.

{{RootCmd|pvmove -v /dev/sda1}}

Such an operation can take a while depending on the amount of data that needs to be moved. Once finished, there should be no data left on the device. Verify with pvdisplay that the physical volume is no longer used by any logical volume.

The next step is to remove the physical volume from the volume group using <tt>vgreduce</tt> after which the device can be "deselected" as a physical volume using pvremove:

{{RootCmd|vgreduce vg0 /dev/sda1 && pvremove /dev/sda1}}

=== VG (Grupo de Volumen) ===

Un grupo de volumen (VG) agrupa varios volúmenes físicos y se muestra como {{Path|/dev/NOMBRE_DEL_VG}} el el sistema de ficheros de los dispositivos. El administrador es el que elige el nombre del grupo de volumen.

==== Crear VG ====

La siguiente orden crea un grupo de volumen llamado ''vg0'' con dos volúmenes físicos asignados: {{Path|/dev/sda1}} y {{Path|/dev/sdb1}}.

{{RootCmd|vgcreate vg0 /dev/sd[ab]1}}

==== Listar VG ====

To list all active volume groups, use the <tt>vgdisplay</tt> command:

{{RootCmd|vgdisplay|output=<pre>
--- Volume group ---
VG Name vg0
System ID
Format lvm2
Metadata Areas 1
Metadata Sequence No 8
VG Access read/write
VG Status resizable
MAX LV 0
Cur LV 6
Open LV 6
Max PV 0
Cur PV 1
Act PV 1
VG Size 320.02 GiB
PE Size 4.00 MiB
Total PE 81924
Alloc PE / Size 36864 / 144.00 GiB
Free PE / Size 45056 /176.01 GiB
VG UUID mFPXj3-DdPi-7YJ5-9WKy-KA5Y-Vd4S-Lycxq3
</pre>}}

If volume groups are missing, use the <tt>vgscan</tt> command to locate volume groups:

{{RootCmd|vgscan|output=<pre>
 Reading all physical volumes. This may take a while...
 Found volume group "vg0" using metadata type lvm2
</pre>}}

==== Extender VG ====

Los grupos de volumen agrupan volúmenes físicos, permitiendo a los administradores utilizar una reserva de recursos de almacenamiento para crear sistemas de ficheros. Cuando un grupo de volumen no tiene los suficientes recursos de almacenamiento, es necesario extenderlo con volúmenes físicos adicionales.

El siguiente ejemplo extiende el grupo de volumen ''vg0'' con un volumen físico en {{Path|/dev/sdc1}}:

{{RootCmd|vgextend vg0 /dev/sdc1}}

¡Recuerde antes necesita inicializar el volumen físico!

==== Reducir VG ====

If physical volumes need to be removed from the volume group, all data still in use on the physical volume needs to be moved to other physical volumes in the volume group. As seen before, this is handled through the <tt>pvmove</tt> command, after which the physical volume can be removed from the volume group using vgreduce:

{{RootCmd|pvmove -v /dev/sdc1 |vgreduce vg0 /dev/sdc1}}

==== Eliminar VG ====

If a volume group is no longer necessary (or, in other words, the storage pool that it represents is no longer used and the physical volumes in it need to be freed for other purposes) then the volume group can be removed with vgremove. This only works if no logical volume is defined for the volume group, and all but one physical volume have already been removed from the pool.

{{RootCmd|vgremove vg0}}

=== LV (Volumen Lógico) ===

Los volúmenes lógicos son los metadispositivos finales que se ofrecen al sistema normalmente para crear sistemas de ficheros en ellos. Se crean y se gestionan dentro de grupos de volumen y se muestran como {{Path|/dev/NOMBRE_DEL_VG/NOMBRE_DEL_LV}}. Al igual que con los grupos de volumen el nombre lo decide el administrador.

==== Crear LV ====

To create a logical volume, the <tt>lvcreate</tt> command is used. The parameters to the command consist out of the requested size for the logical volume (which cannot be larger than the amount of free space in the volume group), the volume group from which the space is to be claimed and the name of the logical volume to be created.

En el ejemplo de abajo, se crea un volumen lógico llamado ''lvol1'' en el grupo de volumen llamado ''vg0'' con un tamaño de 150MB:

{{RootCmd|lvcreate -L 150M -n lvol1 vg0}}

It is possible to tell <tt>lvcreate</tt> to use all free space inside a volume group. This is done through the <code>-l</code> option which selects the amount of ''extents'' rather than a (human readable) size. Logical volumes are split into ''logical extents'' which are data chunks inside a volume group. All extents in a volume group have the same size. With the <code>-l</code> option <tt>lvcreate</tt> can be asked to allocate all free extents:

{{RootCmd|lvcreate -l 100%FREE -n lvol1 vg0}}

A continuación de ''FREE'' se puede utilizar la clave ''VG'' para indicar el tamaño total de un grupo de volumen.

==== Listar LV ====

To list all logical volumes, use the <tt>lvdisplay</tt> command:

{{RootCmd|lvdisplay}}

If logical volumes are missing, then the <tt>lvscan</tt> command can be used to scan for logical volumes on all available volume groups.

{{RootCmd|lvscan}}

==== Extender LV ====

When a logical volume needs to be expanded, then the <tt>lvextend</tt> command can be used to grow the allocated space for the logical volume.

Por ejemplo, para extender el volumen lógico ''lvol1'' a un total de 500 MB:

{{RootCmd|lvextend -L500M /dev/vg0/lvol1}}

También es posible utilizar el tamaño que se necesita añadir en lugar del tamaño total:

{{RootCmd|lvextend -L+350MB /dev/vg0/lvol1}}

Un grupo de volumen extendido no ofrece de forma inmediata el espacio de almacenamiento adicional a los usuarios finales. Para ello, se necesita igualmente incrementar el sistema de ficheros creado en el grupo de volumen. No todos los sistemas de ficheros admiten el cambio de tamaño cuando se están utilizando, por tanto compruebe la documentación del sistema de ficheros en cuestión para obtener más información.

Por ejemplo, para cambiar el tamaño de un sistema de ficheros ext4 a 500MB:

{{RootCmd|resize2fs /mnt/data 500M}}

==== Reducir LV ====

Si se necesita reducir el tamaño de un volumen lógico, en primer lugar se debe reducir el propio sistema de ficheros. No todos los sistemas de ficheros lo permiten cuando se están utilizando.

Por ejemplo, ext4 no permite reducir el tamaño cuando se está utilizando por lo que se debe desmontar en primer lugar. También se recomienda realizar una comprobación del sistema de ficheros para asegurarse de que no hay inconsistencias:

{{RootCmd|umount /mnt/data
|e2fsck -f /dev/vg0/lvol1
|resize2fs /dev/vg0/lvol1 150M}}

Con un sistema de ficheros reducido ya es posible reducir también el volumen lógico:

{{RootCmd|lvreduce -L150M /dev/vg0/lvol1}}

==== Permisos LV ====

LVM ofrece soporte para estados de permisos en los volúmenes lógicos.

For instance, a logical volume can be set to ''read only'' using the <tt>lvchange</tt> command:

{{RootCmd|lvchange -p r /dev/vg0/lvol1
|mount -o remount /dev/vg0/lvol1}}

La opción para remontar el sistema de fichero se necesita ya que el cambio no se fuerza de forma inmediata.

Para marcar el volumen lógico como escribible, utilice el bit de permisos ''rw'':

{{RootCmd|lvchange -p rw /dev/vg0/lvol1 && mount -o remount /dev/vg0/lvol1}}

==== Eliminar LV ====

Antes de eliminar un volumen lógico, asegúrese de que no está montado:

{{RootCmd|umount /dev/vg0/lvol1}}

Desactive el volumen lógico de modo que no se pueda realizar ninguna actividad de escritura:

{{RootCmd|lvchange -a n /dev/vg0/lvol1}}

Una vez que el volumen está desmontado y desactivado, se puede eliminar, liberando las extensiones asignadas a éste para que otros volúmenes lógicos del grupo de volumen las puedan utilizar:

{{RootCmd|lvremove /dev/vg0/lvol1}}

== Características ==

LVM ofrece algunas características interesantes para los administradores del almacenamiento, incluyendo (pero no limitadas a):
* Provisión delgada (almacenamiento "over-commiting")
* Soporte a instantáneas
* Tipos de volumen con distintos métodos de asignación de espacio de almacenamiento

=== Provisión delgada ===

Las versiones recientes de LVM2  (2.02.89) ofrecen soporte a volúmenes "delgados" (thin). Los volúmenes delgados son a los dispositivos de bloque lo que los ficheros desperdigados son a los sistemas de ficheros. Así, un volumen lógico delgado dentro de una reserva se puede sobreasignar (over-committed): el tamaño que muestra puede ser mayor que el presente en al propia reserva. Al igual que un fichero, las extensiones se asignan mientras el dispositivo se va llenando. Si el sistema de ficheros tiene soporte para ''descartes'', las extensiones se liberan de nuevo cuando los ficheros se eliminan, reduciendo el uso del espacio en la reserva.

Dentro de LVM, esta reserva delgada es un tipo especial de volumen lógico que puede contener a su vez otros volúmenes lógicos.

==== Crear una reserva delgada ====

{{Warning/es|Si ocurre un desbordamiento (overflow) dentro de los metadatos de la reserva delgada, entonces la reserva se corromperá. '''LVM no puede recuperarse de esto'''.}} 

{{Note/es|Si se acaba el espacio de almacenamiento de la reserva delgada, cualquier proceso que pudiera causar que esta reserva intentará asignar más extensiones (que no están disponibles) pasaría al estado "dormido y terminable" ("killable sleep") hasta que se extienda la reserva delgada o el proceso reciba la señal SIGKILL.}}

Cada reserva delgada tiene unos metadatos asociados que se añaden al tamaño de la reserva. LVM calculará el tamaño de los metadatos basándose en el tamaño de la reserva y como mínimo asignará <tt>pool_chunks * 64 bytes</tt> o 2MiB, el que sea mayor. El administrador puede seleccionar también un tamaño diferente para los metadatos.

To create a thin pool, add the <code>--type thin-pool --thinpool thin_pool</code> options to <tt>lvcreate</tt>:

{{RootCmd|lvcreate -L 150M --type thin-pool --thinpool thin_pool vg0}}

El ejemplo de arriba crea una reserva delgada llamado ''thin_pool'' con un tamaño total de 150 MB. Este es el tamaño real asignado a la reserva delgada (y de este modo la cantidad total de espacio de almacenamiento se puede utilizar).

To explicitly ask for a certain metadata size, use the <code>--metadatasize</code> option:

{{RootCmd|lvcreate -L 150M --metadatasize 2M --type thin-pool --thinpool thin_pool vg0}}

Debido a los metadatos añadidos a la reserva delgada, la forma intuitiva de utilizar todo el espacio disponible en un grupo de volumen para un volumen lógico no funciona (vea la incidencia sobre LVM [https://bugzilla.redhat.com/show_bug.cgi?id=812726|812726]):

{{RootCmd|lvcreate -l 100%FREE --type thin-pool --thinpool thin_pool vg0|output=<pre>
Insufficient suitable allocatable extents for logical volume thin_pool: 549 more required
</pre>}}

Observe que la reserva delgada no tiene un nodo de dispositivo asociado como otros volúmenes lógicos.

==== Crear un volumen lógico delgado ====

A ''thin logical volume'' is a logical volume inside the thin pool (which itself is a logical volume). As thin logical volumes are ''sparse'', a virtual size instead of a physical size is specified using the <code>-V</code> option:

{{RootCmd|lvcreate -T vg0/thin_pool -V 300M -n lvol1}}

En este ejemplo, el volumen lógico (delgado) ''lvol1'' se muestra como un dispositivo de 300MB de tamaño aunque la reserva que lo sustenta solo dispone de 150MB de espacio de almacenamiento real.

También es posible crear la reserva delgada y el volumen lógico dentro de la reserva en una sola orden:

{{RootCmd|lvcreate -T vg0/thin_pool -V 300M -L150M -n lvol1}}

==== Listar las reservas delgadas y los volúmenes lógicos delgados ====

Thin pools and thin logical volumes are special types of logical volumes, and as such as displayed through the <tt>lvdisplay</tt> command. The <tt>lvscan</tt> command will also detect these logical volumes.

==== Extender una reserva delgada ====

{{Warning/es|A partir de la versión  2.02.89 de LVM2, el tamaño de los metadatos de la reserva delgada no se puede ampliar, se fija en el momento de su creación.}}

The thin pool is expanded like a non-thin logical volume using <tt>lvextend</tt>. For instance:

{{RootCmd|lvextend -L500M vg0/thin_pool}}

==== Extender un volumen lógico delgado ====

Los volúmenes lógicos delgados se expanden igual que los normales:

{{RootCmd|lvextend -L1G vg0/lvol1}}

Note that the <tt>lvextend</tt> command uses the <code>-L</code> option (or <code>-l</code> if extent counts are used) and not a "virtual size" option as was used during the creation. 

==== Reducir una reserva delgada ====

Actualmente LVM no puede reducir el tamaño de la reserva delgada. Mire la incidencia LVM [https://bugzilla.redhat.com/show_bug.cgi?id=812731|812731].

==== Reducir un volumen lógico delgado ====

Los volúmenes lógicos delgados se reducen de forma similar a los volúmenes lógicos normales:

Por ejemplo:
{{RootCmd|lvreduce -L300M vg0/lvol1l}}

Note that the <tt>lvreduce</tt> command uses the <code>-L</code> option (or <code>-l</code> if extent counts are used) and not a "virtual size" option as was used during the creation.

==== Eliminar reservas delgadas ====

Las reservas delgadas no se pueden eliminar hasta que todos los volúmenes lógicos delgados contenidos en ellas se eliminen.

When a thin pool no longer services any thin logical volume, it can be removed through the <tt>lvremove</tt> command:

{{RootCmd|lvremove vg0/thin_pool}}

=== Instantáneas LVM2 e instantáneas delgadas ===

Una instantánea es un volumen lógico que actúa como una copia de otro volumen lógico. Muestra el estado del volumen lógico original en el momento de creación de la instantánea.

{{Warning|Since the logical snapshot volume also gets the same filesystem ''LABEL'' and ''UUID'', be sure the {{Path|/etc/fstab}} file or initramfs '''does not''' contain entries for these filesystems using the <code>LABEL{{=}}</code> or <code>UUID{{=}}</code> syntax. Otherwise you might end up with the snapshot being mounted instead of the (intended) original logical volume.}}

==== Crear un volumen lógico tipo instantánea ====

A snapshot logical volume is created using the <code>-s</code> option to <tt>lvcreate</tt>. Snapshot logical volumes are still given allocated storage as LVM "registers" all changes made to the original logical volume and stores these changes in the allocated storage for the snapshot. When querying the snapshot state, LVM will start from the original logical volume and then check all changes registered, "undoing" the changes before showing the result to the user.

Por lo tanto un volumen lógico tipo instantánea "crece" al mismo ritmo que se realizan cambios en el volumen lógico original. Cuando se utiliza completamente el espacio de almacenamiento reservado a la instantánea, entonces ésta se elimina automáticamente del sistema.

{{RootCmd|lvcreate -l 10%VG -s -n 20140412_lvol1 /dev/vg0/lvol1}}

El ejemplo de arriba crea un volumen lógico tipo instantánea llamado ''20140412_lvol1'' y basado en el volumen lógico ''lvol1'' en el grupo de volumen ''vg0''. Utiliza un 10% del espacio (de hecho son extensiones) asignado al grupo de volumen.

==== Acceder un volumen lógico tipo instantánea ====

Los volúmenes lógicos tipo instantánea se pueden montar de forma similar a los volúmenes lógicos normales. Incluso no están restringidos a operaciones de solo lectura. Es posible modificar instantáneas y de este modo usarlas para probar cambios antes de hacerlos en sistemas de ficheros de "producción".

Mientras existan volúmenes lógicos tipo instantánea, los volúmenes lógicos originales y normales no se pueden reducir en tamaño ni eliminar.

==== Instantáneas delgadas LVM ====

{{Note/es|Una instantánea delgada solo se puede tomar de una reserva delgada y para un volumen lógico delgado. El destino del mapeador de dispositivos delgado ofrece soporte para instantáneas delgadas de volúmenes lógicos solo lectura y que no sean delgados. Sin embargo, las herramientas de LVM2 no ofrecen soporte para esto. Es posible crear un volumen lógico tipo instantánea normal (no delgado) de un volumen lógico delgado.}}

To create a thin snapshot, the <tt>lvcreate</tt> command is used with the <code>-s</code> option. No size declaration needs to be passed on:

{{RootCmd|lvcreate -s -n 20140413_lvol1 /dev/vg0/lvol1}}

Las instantáneas de volúmenes lógicos delgados tienen el mismo tamaño que sus volúmenes lógicos originales y utilizan una asignación física de cero al igual que otros volúmenes lógicos delgados. 

{{Important/es|Se se especifica ''-l'' o ''-L'' se creará igualmente una instantánea pero el resultado será una instantánea normal no una instantánea delgada.}}

También es posible tomar instantáneas de instantáneas:

{{RootCmd|lvcreate -s -n 1_20140413_lvol1 /dev/vg0/20140413_lvol1}}

Las instantáneas delgadas tiene varias ventajas sobre las instantáneas normales. En primer lugar, las instantáneas delgadas son independientes de su volumen lógico original una vez se han creado. Se puede eliminar o reducir el tamaño del volumen lógico original sin que esto afecte a la instantánea. En segundo lugar, se pueden crear instantáneas delgadas de forma recursiva eficientemente (instantáneas de instantáneas) sin "encadenar" sobrecarga de instantáneas normales recursivas de LVM.

==== Deshacer cambios a un estado de instantánea ====

Para deshacer los cambios de un volumen lógico a la versión de la instantánea, lance la siguiente orden:

{{RootCmd|lvconvert --merge /dev/vg0/20140413_lvol1}}

This might take a couple of minutes, depending on the size of the volume. Please note that the rollback will only happen once the parent logical volume is offline. Hence a reboot might be required.

{{Important/es|La instantánea desaparecerá y este cambio no es reversible}}

==== Deshacer cambios en instantáneas delgadas ====

For thin volumes, <tt>lvconvert --merge</tt> does not work. Instead, delete the original logical volume and rename the snapshot:

{{RootCmd|umount /dev/vg0/lvol1
|lvremove /dev/vg0/lvol1
|lvrename vg0/20140413_lvol1 lvol1}}

=== Diferentes métodos de asignación de espacio de almacenamiento ===

LVM supports different allocation methods for storage:
* Linear volumes (which is the default);
* Mirrored volumes (in a more-or-less active/standby setup);
* Striping (RAID0);
* Mirrored volumes (RAID1 - which is more an active/active setup);
* Striping with parity (RAID4 and RAID5);
* Striping with double parity (RAID6);
* Striping and mirroring (RAID10).

==== Volúmenes lineales ====

Los volúmenes lineales son los más comunes de los volúmenes LVM. LVM intentará asignar el espacio para el volumen lógico para que físicamente sea lo más contiguo posible. Si hay un volumen lógico lo suficientemente grande para contener todo el volumen físico, entonces LVM lo asignará a ese espacio, de lo contrario lo troceará en el menor número de partes posible.

Las órdenes descritas anteriormente para crear grupos de volúmenes y volúmenes lógicos crean volúmenes lineales.

Debido a que los volúmenes lineales no precisan requisitos espaciales, son los más fáciles de manipular y se les puede cambiar el tamaño y relocalizarlos según se desee. SI un volumen lógico se asigna en varios volúmenes físicos y alguno de estos volúmenes físicos falla y no está disponible, entonces el volumen lógico no se podrá arrancar y no será utilizable.

==== Volúmenes en espejo ====

LVM ofrece soporte para volúmenes  ''en espejo'', los cuales ofrecen tolerancia ante fallos en caso de que un disco deje de funcionar. Al contrario que RAID1, no se obtiene ningún beneficio en el rendimiento. Todas las lecturas y escrituras se envían a un solo lado del espejo.

Para supervisar el estado del espejo, LVM necesita guardar un ''registro''. Se recomienda (y en algunos casos es obligatorio) colocar este registro en un volumen físico que no contenga a ninguno de los volúmenes lógicos en espejo. Hay tres tipos de registros que se pueden utilizar para los espejos:

# '''Disk''' es el tipo de registro por defecto. Todos los cambios se registran en unas extensiones de metadatos extra que gestiona LVM. Si falla un dispositivo entondes los cambios se guardan en el registro hasta que se pueda restaurar el espejo.
# '''Mirror''' son registro '''disk''' que se mantienen en espejo.
# '''Core''' espejo registra el estado del espejo únicamente en memoria. LVM tendrá que reconstruir el espejo cada vez que se active. Este tipo es muy útil para espejos temporales.

To create a logical volume with a single mirror, pass the ''-m 1'' argument (to select standard mirroring) with optionally <code>--mirrorlog</code> to select a particular log type:

{{RootCmd|lvcreate -m 1 --mirrorlog mirror -l 40%VG --nosync -n lvol1 vg0}}

The ''-m 1'' tells LVM to create one (additional) mirror, so requiring 2 physical volumes. The <code>--nosync</code> option is an optimization - without it LVM will try synchronize the mirror by copying empty sectors from one logical volume to another.

Es posible crear un espejo de un volumen lógico ya existente:

{{RootCmd|lvconvert -m 1 -b vg0/lvol1}}

The <code>-b</code> option does the conversion in the background as this can take quite a while.

Para eliminar un espejo, defina el número de espejos (de nuevo) a cero:

{{RootCmd|lvconvert -m0 vg0/lvol1}}

Si alguna parte del espejo no está disponible (normalmente debido a que ha fallado el disco que contiene el volumen físico), el grupo de volumen tendrá que ser activado en modo degradado:

{{RootCmd|vgchange -ay --partial vg0}}

En la primera escritura, LVM detectará que el espejo está roto. La directriz por defecto ("eliminar") es reducir o romper automáticamente el espejo en el número de partes disponibles. Un espejo de tres vías con un volumen físico no disponible se reducirá a un volumen lineal normal. Si el fallo es transitorio y el volumen físico vuelve a estar disponible después de que LVM haya roto el espejo, el volumen lógico en espejo tendrá que ser creado de nuevo sobre éste. 

To recover the mirror, the failed physical volume needs to be removed from the volume group, and a replacement physical volume needs to be added (or if the volume group has a free physical volume, it can be created on that one). Then the mirror can be recreated with <tt>lvconvert</tt> at which point the old physical volume can be removed from the volume group:

{{RootCmd|vgextend vg0 /dev/sdc1
|lvconvert -b -m 1 --mirrorlog disk vg0/lvol1
|vgreduce --removemissing vg0}}

Es posible hacer que LVM recree el espejo con extensiones disponibles en un volumen físico diferente si un lado falla. Para hacer esto, defina <code>mirror_image_fault_policy</code> a ''allocate'' en {{Path|lvm.conf}}.

==== Espejos delgados ====

It is not (yet) possible to create a mirrored thin pool or thin volume. It is possible to create a mirrored thin pool by creating a normal mirrored logical volume and then converting the logical volume to a thin pool with <tt>lvconvert</tt>. 2 logical volumes are required: one for the thin pool and one for the thin metadata; the conversion process will merge them into a single logical volume.

{{Warning/es|Se necesita la versión de LVM 2.02.98 o posterior para que esto funcione correctamente. Las versiones anteriores no pueden hacerlo o causarán un fallo de segmente y corromperán el grupo de volumen. Además, la conversión de un espejo en una reserva delgada ¡'''Destruye''' todos los datos existentes en el espejo!}}

{{RootCmd|lvcreate -m 1 --mirrorlog mirrored -l40%VG -n thin_pool vg0
|lvcreate -m 1 --mirrorlog mirrored -L4MB -n thin_meta vg0
|lvconvert --thinpool vg0/thin_pool --poolmetadata vg0/thin_meta}}

==== Seccionado (RAID0) ====

En lugar de un volumen lineal en el que múltiples volúmenes físicos contiguos se añaden, es posible crear un volumen ''seccionado'' o ''RAID0'' para mejorar el rendimiento. Esto causará que las asignaciones de espacio de almacenamiento se alternen entre los volúmenes físicos disponibles.

Para crear un volumen seccionado sobre tres volúmenes físicos:

{{RootCmd|lvcreate -i 3 -l 20%VG -n lvol1_stripe vg0|output=<pre>
Using default stripesize 64.00 KiB
</pre>}}

The <code>-i</code> option indicates over how many physical volumes the striping should be done.

It is possible to mirror a stripe set. The <code>-i</code> and <code>-m</code> options can be combined to create a striped mirror:

{{RootCmd|lvcreate -i 2 -m 1 -l 10%VG vg0}}

This creates a 2 physical volume stripe set and mirrors it on 2 different physical volumes, for a total of 4 physical volumes. An existing stripe set can be mirrored with <tt>lvconvert</tt>.

Una reserva delgada se puede seccionar como cualquier otro volumen lógico. Todos los volúmenes lógicos creados en la reserva heredan esos ajustes. No los especifique manualmente cuando cree un volumen delgado.

No es posible seccionar un volumen ya existente ni redimensionar las secciones entre más o menos volúmenes físico ni convertirlo a un volumen lineal o de otro nivel RAID. Un conjunto seccionado se puede reflejar. Es posible extender un conjunto seccionado sobre volúmenes físicos adicionales pero se deben añadir en múltiplos del tamaño original del conjunto seccionado (el cual añadirá de forma efectiva y lineal un nuevo conjunto seccionado).

==== Espejos (RAID1) ====

Al contrario que RAID0 que consiste en volúmenes seccionados, RAID1 los refleja, sin embargo se implementa de forma diferente a los espejos LVM originales. Bajo RAID1 las lecturas se reparten a través de los volúmenes físicos mejorando el rendimiento. Los fallos en los espejos RAID1 no causan bloqueo de E/S ya que LVM no necesita romperlo a la hora de la escritura.

Cualquier lugar en el que se pueda utilizar un espejo LVM, se puede utilizar un espejo RAID1 en su lugar. Es posible hacer que LVM cree espejos RAID1 en lugar de espejos normales definiendo ''mirror_segtype_default'' a ''raid1'' en {{Path|lvm.conf}}.

Para crear un volumen lógico con un solo espejo:

{{RootCmd|lvcreate -m 1 --type raid1 -l 40%VG --nosync -n lvm_raid1 vg0}}

Observe la diferencia a la hora de crear un espejo: No se especifica ''mirrorlog'' debido a que los volúmenes lógicos RAID1 no tienen un registro espejo explícito, se incluyen en el volumen lógico.

Es posible convertir un volumen lógico existente a RAID1:

{{RootCmd|lvconvert -m 1 --type raid1 -b vg0/lvol1}}

Para eliminar un espejo RAID 1, defina el número de espejos a cero:

{{RootCmd|lvconvert -m0 vg0/lvm_raid1}}

Si alguna parte del RAID1 no está disponible (normalmente debido a que ha fallado el disco que contiene el volumen físico), el grupo de volumen tendrá que ser activado en modo degradado:

{{RootCmd|vgchange -ay --partial vg0}}

Unlike an LVM mirror, writing does NOT break the mirroring. If the failure is only transient, and the missing physical volume returns, LVM will resync the mirror by copying cover the out-of-date segments instead of the entire logical volume. If the failure is permanent, then the failed physical volume needs to be removed from the volume group, and a replacement physical volume needs to be added (or if the volume group has a free physical volume, it can be created on a different PV). The mirror can then be repaired with <tt>lvconvert</tt>, and the old physical volume can be removed from the volume group:

{{RootCmd|vgextend vg0 /dev/sdc1
|lvconvert --repair -b vg0/lvm_raid1
|vgreduce --removemissing vg0}}

==== RAID1 delgado ====

It is not (yet) possible to create a RAID1 thin pool or thin volume. It is possible to create a RAID1 thin pool by creating a normal mirrored logical volume and then converting the logical volume to a thin pool with <tt>lvconvert</tt>. 2 logical volumes are required: one for the thin pool and one for the thin metadata; the conversion process will then merge them into a single logical volume.

{{Warning/es|Se necesita una versión de LVM igual o posterior a la 2.02.98 para que esto funcione. Las versiones anteriores no podrán funcionar o causarán un fallo de segmento y corromperán el grupo de volumen. Además, la conversión de RAID1 a una reserva delgada ¡'''Destruirá'' todos los datos del espejo!}}

{{RootCmd|lvcreate -m 1 --type raid1 -l40%VG -n thin_pool vg0
|lvcreate -m 1 --type raid1 -L4MB -n thin_meta vg0
|lvconvert --thinpool vg0/thin_pool --poolmetadata vg00/thin_meta}}

==== Seccionado con paridad (RAID4 y RAID5) ====

{{Note/es|El seccionado con paridad requiere al menos tres volúmenes físicos.}}

RAID0 no es tolerante a fallos. Si cualquiera de los volúmenes físicos falla, entonces el volumen lógico es inutilizable. Al añadir una sección de paridad a RAID0 el volumen lógico puede seguir funcionando si algún volumen físico falta. Se puede añadir un nuevo volumen físico para restaurar la tolerancia a fallos.

Los conjuntos seccionados con paridad se pueden implementar de dos formas: RAID4 y RAID5. En RAID4, todas las secciones que contienen la información de paridad se almacenan en lel mismo volumen físico. Esto puede dar lugar a un cuello de botella ya que todas las escrituras afectan también a ese volumen físico. Con RAID5 los datos de paridad se distribuyen homogéneamente por todos los volúmenes físicos de modo que ninguno de ellos es un cuello de botella. Debido a esto, RAID4 no es una implementación común y se considera obsoleta y anticuada. En la práctica todos los conjuntos seccionados con paridad son RAID5.

{{RootCmd|lvcreate --type raid5 -l 20%VG -i 2 -n lvm_raid5 vg0}}

Únicamente los volúmenes físicos de datos se especifican con la opción -i, LVM añade uno de forma automática para la paridad. Por lo tanto para un volumen RAID5 de tres volúmenes físicos, se pasa ''-i 2'' y no ''-i 3''.

Cuando un volumen físico falla, entonces se necesita levantar el grupo de volumen en modo degradado:

{{RootCmd|vgchange -ay --partial vg0}}

El volumen funcionará correctamente en este momento. Sin embargo esto degrada el array a RAID0 hasta que se añada un volumen físico de reemplazo. Normalmente el rendimiento no se ve afectado mientras el array está degradado aunque se necesita recalcular los datos perdidos partiendo de la paridad. Esto requiere únicamente simples operaciones XOR entre los bloques de paridad y los datos restantes. La sobrecarga no es representativa comparada con la E/S del disco.

Para reparar el RAID5:

{{RootCmd|lvconvert --repair vg0/lvm_raid5 |vgreduce --removemissing vg0}}

En RAID5 también es posible reemplazar un volumen físico en funcionamiento:

{{RootCmd|lvconvert --replace /dev/sdb1 vg0/lvm_raid5
|vgreduce vg0 /dev/sdb1}}

Las mismas restricciones de los conjuntos seccionados se aplican a los conjuntos seccionados con paridad. No es posible habilitar seccionado con paridad en un volumen ya existente ni redimensionar las secciones con paridad a lo largo de más (o menos) volúmenes físicos, tampoco convertirlo a otro nivel RAID o volumen lineal. Se puede crear un espejo de un conjunto seccionado con paridad. Es posible extender un conjunto seccionado con paridad a lo largo de volúmenes físicos adicionales pero se deben añadir en múltiplos del conjunto seccionado con paridad original (lo cual añadirá de forma efectiva una nueva sección lineal con paridad).

==== Volúmenes lógicos RAID5 delgados ====

It is not (yet) possible to create stripe set with parity (RAID5) thin pools or thin logical volumes. It is possible to create a RAID5 thin pool by creating a normal RAID5 logical volume and then converting the logical volume into a thin pool with <tt>lvconvert</tt>. 2 logical volumes are required: one for the thin pool and one for the thin metadata; the conversion process will merge them into a single logical volume.

{{Warning/es|Se necesita una versión de LVM igual o posterior a la 2.02.98 para que esto funcione. Las versiones anteriores no podrán funcionar o causarán un fallo de segmento y corromperán el grupo de volumen. Además, la conversión de RAID5 a una reserva delgada ¡'''Destruirá'' todos los datos del volumen lógico!}}

{{RootCmd|lvcreate --type raid5 -i 2 -l20%VG -n thin_pool vg0
|lvcreate --type raid5 -i 2 -L4MB -n thin_meta vg0
|lvconvert --thinpool vg0/thin_pool --poolmetadata vg00/thin_meta}}

==== Seccionado con doble paridad (RAID6) ====

{{Note/es|RAID6 requiere al menos cinco volúmenes físicos.}}

RAID6 es similar a RAID5, sin embargo RAID6 puede sobrevivir '''dos''' fallos en volúmenes físicos ofreciendo así mayor tolerancia a los fallos que RAID5 a costa de volúmenes físicos extra. 

{{RootCmd|lvcreate --type raid6 -l 20%VG -i 3 -n lvm_raid6 vg00}}

Like RAID5, the <code>-i</code> option is used to specify the number of physical volumes to stripe, excluding the 2 physical volumes for parity. So for a 5 physical volume RAID6, pass on <code>-i 3</code> and not <code>-i 5</code>.

La recuperación en RAID6 es la misma que en RAID5.

{{Note/es|Al contrario que en RAID5 en el que el recálculo del bloque de paridad es bajo comparado con la E/S del disco, en RAID6 esto no es del todo cierto. RAID6 utiliza dos secciones para la paridad: Una sección se calcula de la misma forma que en RAID5 (un simple XOR). La segunda sección de paridad es más difícil de calcular, lea [https://www.kernel.org/pub/linux/kernel/people/hpa/raid6.pdf|raid6 (pdf)] para obtener más información.}}

==== Volúmenes lógicos RAID6 delgados ====

It is not (yet) possible to create a RAID6 thin pool or thin volumes. It is possible to create a RAID6 thin pool by creating a normal RAID6 logical volume and then converting the logical volume into a thin pool with <tt>lvconvert</tt>. 2 logical volumes are required: one for the thin pool and one for the thin metadata; the conversion process will merge them into a single logical volume.

{{Warning/es|Se necesita una versión de LVM igual o posterior a la 2.02.98 para que esto funcione. Las versiones anteriores no podrán funcionar o causarán un fallo de segmento y corromperán el grupo de volumen. Además, la conversión de RAID6 a una reserva delgada ¡'''Destruirá'' todos los datos del volumen lógico!}}

{{RootCmd|lvcreate --type raid6 -i 2 -l20%VG -n thin_pool vg0
|lvcreate --type raid6 -i 2 -L4MB -n thin_meta vg0
|lvconvert --thinpool vg0/thin_pool --poolmetadata vg0/thin_meta}}

==== RAID10 LVM ====

{{Note/es|RAID10 necesita al menos cuatro volúmenes físicos. También, la sintaxis LVM necesita que el número de volúmenes físicos sea múltiplo del número de secciones y espejos, incluso aunque el formato de RAID10 no lo necesite}}

RAID10 es una combinación de RAID0 y RAID1. Es más potente que RAID0+RAID1 ya que el reflejo se realiza al nivel de las secciones en lugar de al nivel del volumen lógico y por tanto la disposición no necesita ser simétrica. Un volumen RAID10 puede tolerar al menos un volumen físico no disponible y posiblemente más.

{{Note/es|LVM limita actualmente RAID10 a un solo espejo.}}

{{RootCmd|lvcreate --type raid10 -l 1020 -i 2 -m 1 --nosync -n lvm_raid10 vg0}}

Both the <code>-i</code> and <code>-m</code> options are specified: <code>-i</code> is the number of stripes and <code>-m</code> is the number of mirrors. Two stripes and 1 mirror requires 4 physical volumes.

==== RAID10 delgado ====

It is not (yet) possible to create a RAID10 thin pool or thin volumes. It is possible to create a RAID10 thin pool by creating a normal RAID10 logical volume and then converting the logical volume into a thin pool with <tt>lvconvert</tt>. 2 logical volumes are required: one for the thin pool and one for the thin metadata; the conversion process will merge them into a single logical volume.
 
{{Warning|Conversion of a RAID10 logical volume into a thin pool '''destroys''' all existing data in the logical volume!}}

{{RootCmd|lvcreate -i 2 -m 1 --type raid10 -l 1012 -n thin_pool vg0
|lvcreate -i 2 -m 1 --type raid10 -l 6 -n thin_meta vg0
|lvconvert --thinpool vg0/thin_pool --poolmetadata vg0/thin_meta}}

== Experimentar con LVM ==

Es posible experimentar con LVM sin tener que utilizar dispositivos de almacenamiento reales. Para conseguir esto, se deben crear los dispositivos de bucle.

En primer lugar, asegúrese de que tiene el módulo de bucle cargado. 

{{RootCmd|modprobe -r loop && modprobe loop max_part{{=}}63}}

{{Note/es|Si el soporte de bucle local está construido en el núcleo, entonces utilice <code>loop.max_part{{=}}63</code> como opción de arranque.}}

A continuación configure LVM para que no utilice [[udev/es|udev]] para escanear dispositivos:

{{FileBox|filename=/etc/lvm/lvm.conf|title=Deshabilitar udev en la configuración de LVM|lang=bash|1=
obtain_device_list_from_udev = 0
}}

{{Important/es|Esto es únicamente para pruebas, asegúrese de que vuelve a cambiar las definiciones cuando trabaje con dispositivos reales ya que ¡Es más rápido utilizar udev!}}

Cree algunos ficheros imagen que serán los dispositivos de almacenamiento. El siguiente ejemplo utiliza cinco ficheros para un total de unos 10GB de espacio real en el disco duro:

{{RootCmd|mkdir /var/lib/lvm_img
|dd if{{=}}/dev/null of{{=}}/var/lib/lvm_img/lvm0.img bs{{=}}1024 seek{{=}}2097152
|dd if{{=}}/dev/null of{{=}}/var/lib/lvm_img/lvm1.img bs{{=}}1024 seek{{=}}2097152
|dd if{{=}}/dev/null of{{=}}/var/lib/lvm_img/lvm2.img bs{{=}}1024 seek{{=}}2097152
|dd if{{=}}/dev/null of{{=}}/var/lib/lvm_img/lvm3.img bs{{=}}1024 seek{{=}}2097152
|dd if{{=}}/dev/null of{{=}}/var/lib/lvm_img/lvm4.img bs{{=}}1024 seek{{=}}2097152}}

Compruebe qué dispositivos de bucle están disponibles:

{{RootCmd|losetup -a}}

Asumiendo que todos los dispositivos de bucle están disponibles, cree a continuación los dispositivos:

{{RootCmd|losetup /dev/loop0 /var/lib/lvm_img/lvm0.img
|losetup /dev/loop1 /var/lib/lvm_img/lvm1.img
|losetup /dev/loop2 /var/lib/lvm_img/lvm2.img
|losetup /dev/loop3 /var/lib/lvm_img/lvm3.img
|losetup /dev/loop4 /var/lib/lvm_img/lvm4.img}}

Los dispositivos {{Path|/dev/loop[0-4]}} están disponibles ahora para su uso como cualquier otro disco duro del sistema (y así es perfecto para volúmenes físicos).

{{Note/es|En el siguiente reinicio, todos los dispositivos de bucle se liberarán y se puede eliminar el directorio {{Path|/var/lib/lvm_img}}.}}

== Resolución de problemas ==

LVM tiene algunas características que ya ofrecen algún nivel de redundancia. Sin embargo, hay situaciones en las que es posible restaurar volúmenes lógicos o físicos perdidos.

=== Utilidad vgcfgrestore ===

Por defecto, ante cualquier cambio en un volumen físico, grupo de volumen o volumen lógico, LVM2 crea un fichero de copia de seguiridad de los metadatos en {{Path|/etc/lvm/archive}}. Estos ficheros se pueden utilizar para la recuperación ante un cambio accidental (como el borrado de un volumen lógico por equivocación). LVM también mantiene una copia de seguridad de los metadatos más recientes en {{Path|/etc/lvm/backup}}. Éstos se pueden utilizar para restaurar los metadatos en un disco de reemplazo o reparar metadatos corruptos.

Para ver qué estados de un grupo de volumen están disponibles para restauración (la salida es parcial para mejorar la legibilidad):

{{RootCmd|vgcfgrestore --list vg00|output=<pre>
 File:         /etc/lvm/archive/vg0_00042-302371184.vg
 VG name:      vg0
 Description:  Created *before* executing 'lvremove vg0/lvm_raid1'
 Backup Time:  Sat Jul 13 01:41:32 201
</pre>}}

==== Recuperar un volumen lógico eliminado por accidente ====

Asumiendo que el volumen lógico ''lvm_raid1'' se eliminó accidentalmente del grupo de volumen ''vg0'', es posible recuperarlo del siguiente modo:

{{RootCmd|vgcfgrestore -f /etc/lvm/archive/vg0_00042-302371184.vg vg0}}

{{Important|vgcfgrestore only restores LVM metadata, ''not'' the data inside the logical volume. However pvremove, vgremove, and lvremove only wipe metadata, leaving any data intact. If <code>issue_discards</code> is set in {{Path|/etc/lvm/lvm.conf}} though, then these command ''are'' destructive to data.}}

==== Reemplazar un volumen físico que ha fallado ====

Es posible realizar un "reemplazo" real y recrear los metadatos en el nuevo volumen físico para que sea el mismo que el volumen físico antiguo.

{{RootCmd|vgdisplay --partial --verbose|output=<pre>
 --- Physical volumes ---
 PV Name               /dev/loop0
 PV UUID               iLdp2U-GX3X-W2PY-aSlX-AVE9-7zVC-Cjr5VU
 PV Status             allocatable
 Total PE / Free PE    511 / 102

 PV Name               unknown device
 PV UUID               T7bUjc-PYoO-bMqI-53vh-uxOV-xHYv-0VejBY
 PV Status             allocatable
 Total PE / Free PE    511 / 102
</pre>}}

La línea importante aquí es el UUID "unknown device" (dispositivo desconocido). 

{{RootCmd|pvcreate --uuid T7bUjc-PYoO-bMqI-53vh-uxOV-xHYv-0VejBY --restorefile /etc/lvm/backup/vg0 /dev/loop1|output=<pre>
 Couldn't find device with uuid T7bUjc-PYoO-bMqI-53vh-uxOV-xHYv-0VejBY.
 Physical volume "/dev/loop1" successfully created</pre>}}

Esto recrea los metadatos de volumen físico pero no los datos del volumen lógico o grupo de volumen que falta en el volumen físico.

{{RootCmd|vgcfgrestore -f /etc/lvm/backup/vg0 vg0|output=<pre>
 Restored volume group vg0
</pre>}}

Esto reconstruye todos los metadatos que faltan en el volumen físico, incluyendo el volumen lógico y los datos del grupo de volumen. Sin embargo, no restaura los datos por lo que el espejo está fuera de sincronismo.

{{RootCmd|vgchange -ay vg0|output=<pre>
 device-mapper: reload ioctl on failed: Invalid argument
 1 logical volume(s) in volume group "vg0" now active
</pre>}}

{{RootCmd|lvchange --resync vg0/lvm_raid1|output=<pre>
Do you really want to deactivate logical volume lvm_raid1 to resync it? [y/n]: y
</pre>}}

Esto sincronizará de nuevo el espejo. Esto funciona también para RAID 4, 5 y 6.

=== Desactivar un volumen lógico ===

Es posible desactivar un volumen lógico con la siguiente orden:

{{RootCmd|umount /dev/vg0/lvol1 |lvchange -a n /dev/vg0/lvol1}}

No es posible montar el volumen lógico en cualquier lugar antes de reactivarlo:

{{RootCmd|lvchange -a y /dev/vg0/lvol1}}

== Recursos externos ==

* [http://sourceware.org/lvm2/ LVM2 sourceware.org]
* [http://tldp.org/HOWTO/LVM-HOWTO/ LVM tldp.org]
* [http://sources.redhat.com/lvm2/wiki/ LVM2 Wiki redhat.com]


[[Category:Core system]]
