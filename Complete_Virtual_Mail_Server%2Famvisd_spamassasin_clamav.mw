== Introduction ==
Spam is becoming more and more of an issue on the internet and a robust and solid solution is required. There are payed services for even more spam protection but should not be required and will not be discussed in this article.

== Postfix ==
The first line of defense, is postfix itself. Postfix offers a few basic means to block spam, or rather spammers. Using ''smtpd_client_restrictions'' it is possible to use public DNS blacklists. There are 3 popular DNS blacklists of which one is incorporated into the other. These two lists are also the [http://www.intra2net.com/en/support/antispam/ most accurate] ones. The most important one is [http://zen.spamhaus.org zen.spamhaus.org] and as a backup [http://bl.spamcop.net bl.spamcop.net] can be used. Using them with postfix is very simple. Add these domains as ''reject_rbl_client'' in main.cf.
{{File|/etc/postfix/main.cf|Use DNS blacklists|<pre>
# Block spam using DNS blacklists
smtpd_client_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_rbl_client zen.spamhaus.org, reject_rbl_client bl.spamcop.net
</pre>}}
{{Note|''permit_mynetworks'' and ''permit_sasl_authenticated'' are added for good measure. If other restrictions are required or already in use, keep them in place.}}

== Amavis ==
=== Introduction ===
Spam-assasin and ClamAV are the tools to block spam and virusses, however amavis is required to tie this all together. Amavis will actually behave as a mailserver in itself, accept mail, filter it, and send it onwards again. For this to work, postfix will need to actually listen for mail twice. The default port 25 is where mail initially is received on. From there on it is sent to amavis, which will be listening on port 10024. When amavis is done with the message, it will be sent to postfix on a different port, 10025. The reason for this should be obvious. If mail would be offered again on port 25, it would be passed to amavis again and thus in an endless loop. Obviously, postfix on port 10025 would only be listening to known hosts, like ''localhost'' and not check for spam anymore.
{{Note|Because of this setup, it is quite easily possible, to have these 3 mail 'handlers' on 3 different hosts. It could be possible to have the primary mailserver, that listens on port 25 on the firewall, have it forward to a safe isolated server running only amavis and have amavis sent mail to an internal postfix server where it delivers mail to the mail storage.}}

=== Installatoin ===
Amavis should have been installed already, if not, emerge it. This should pull in spam-assasin and clamav as its dependancies.
{{Emerge|amavisd-new}}

=== Configuration ===
Amavisd offers an enormous amount of options and going over all them will take some time. The configuration file /etc/amavisd.conf however is well documented and divided into clear sections. Each section will be examined as needed. Only options that will be changed will be mentioned to cut down the text for readability.
{{Note|The configuration file is actually perl code and proper precautions should be taken when editing this file.}}

For this example amavisd will be running on host foo but this could be any other host as well, amavisd does not require to run on the same host as postfix. Also the domain used is only used to identify the server itself with, not the domains amavisd will be scanning.
{{Note|With amavis being quite complex, troubleshooting can be difficult enough as it is. By un-commenting all/each of the following settings certain components can be disabled.
<pre>
# @bypass_virus_checks_maps = (1);  # controls running of anti-virus code
# @bypass_spam_checks_maps  = (1);  # controls running of anti-spam code
# $bypass_decode_parts = 1;         # controls running of decoders&dearchivers
</pre>
Also the log_level can be increased to find issues.
<pre>
$log_level = 0;              # verbosity 0..5, -d
</pre>}}
{{File|/etc/amavisd.conf|diff of gentoo default config and changes|<pre>

</pre>}}
{{Note|''virusalert@example.com'' and ''spam.police@example'' can be renamed to ''undef'' if not wanting to receive any information on breaches. If not, these e-mail addresses should exist.}}
