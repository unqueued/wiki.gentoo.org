This guide details running X server under user account.

This has been successfully tested using Nouveau and Intel drivers

== Additional prerequisites ==
{{Dated|section|date=Nov. 6, 2018}}
Some of this support is relatively recent, and it may be necessary to install unstable packages. If it fails to work with stable, keywording certain packages may be necessary.

{{FileBox|filename=/etc/portage/package.keywords|1=
x11-base/xorg-server
x11-base/xorg-drivers
x11-drivers/xf86-input-keyboard
x11-drivers/xf86-input-mouse
x11-drivers/xf86-input-evdev
# Select from the following based on your video hardware, both may be needed for multi-GPU systems.
x11-drivers/xf86-video-nouveau
x11-drivers/xf86-video-intel
}}

== Rebuilding Xorg ==

Disable <code>suid</code> USE flag:

{{FileBox|filename=/etc/portage/package.use|1=
x11-base/xorg-server -suid
}}

Rebuild Xorg:

{{Emerge
|x11-base/xorg-server
|params=--update --deep --newuse --verbose --ask
}}

== Making necessary changes to system ==

Now you can run X as user, however because none of login managers are currently capable of doing necessary permission handling it needs some workarounds. In particular, X run by user needs to be able to access {{Path|/dev/input}} files and it needs to be started directly as the user. Additionally, as with using direct rendering, the unprivileged user also needs access to the video hardware, typically achieved by adding them to the {{C|video}} group (though certain login managers, such as ConsoleKit or systemd-logind may handle this for you).

To access {{Path|/dev/input}} files it's easiest to add them to group and allow user to access them.

{{Note|The {{C|input}} group and udev rules may already exist on many Gentoo systems. If they exist for you, you may skip the steps before adding your user to the necessary groups.}}

{{RootCmd|groupadd input}}

Create udev rule to change {{Path|/dev/input}} group on boot:

{{FileBox|filename=/etc/udev/rules.d/99-dev-input-group.rules|1=
SUBSYSTEM=="input", ACTION=="add", GROUP="input"
}}

Reload udev rules to get the new permissions

{{Note|This may interfere with your input devices on the current <code>vty</code>}}

{{RootCmd|/etc/init.d/udev reload}}

And finally, add your user to the necessary groups:

{{RootCmd|usermod -a -G input,video user}}

Log out and log back in (for the permissions changes to take effect), and then start X by running:

{{Cmd|startx -- vt1}}

If logged on <code>tty1</code> use <code>vt1</code>, on <code>tty2</code> use <code>vt2</code>, and so on.

X should now be running as an unprivileged user.

== Security concerns ==

Running X as a normal user is generally a positive step for security, with the exception of multiuser or, especially, multiseat systems. With the direct access to input devices by the user, it becomes trivially possible to snoop on the input of another active user or run a background job to snoop on the input of a future user of the system. For such systems, it's likely better to choose a solution other than running X as the logged-in user (such as using setuid with a dedicated, unprivileged user or using setgid for the {{C|input}} group).

== Alternative method ==

In this section we will detail "setgid" mentioned above.

The objective is to run X as an unprivileged user without adding a user to the {{C|input}} group. This can prevent user from accidentally or intentionally snooping on the input.

To achieve this goal we make use of setgid so that when a user starts X, the X server will be automatically granted permission to access input devices.

Change the ownership of {{Path|/usr/bin/Xorg}}:

{{RootCmd|chown -v :input /usr/bin/Xorg}}

Change the file permission of {{Path|/usr/bin/Xorg}}:

{{RootCmd|chmod -v g+s /usr/bin/Xorg}}

Now your user is not required to be in the {{C|input}} group to run X server. To remove your user from {{C|input}} group:

{{RootCmd|gpasswd -d user input}}

But your user still needs to be in the {{C|video}} group:

{{RootCmd|usermod -a -G video user}}

Now start X as a regular user (see above) and X server should function well.

[[Category:X.Org]]
