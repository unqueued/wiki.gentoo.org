{{Important|This is WIP while I am consolidating my notes and logs. I will remove this note once everything is placed here that I am consolidating/reconstructing. [[User:Yamakuzure|Yamakuzure]] ([[User talk:Yamakuzure|talk]]) 10:07, 8 February 2018 (UTC)}}

This article describes how to [[Article description::get Portage to build usable Qt/Gtk-apps on Cygwin]].

== Preface ==
Before reading this, you should be familiar with "[[Prefix|Gentoo Prefix]]" and "[[Prefix/Cygwin|Prefix on Cygwin]]".

It would be useful, if you already set up a Cygwin/X system and bootstrapped a Gentoo Prefix on it. However, reading about the theory might be enough, as you'd have to throw it away later anyway. ;-)

== Cygwin/X ==

Before thinking about bootstrapping, a working Cygwin/X system should be at hand. This is not as trivial as one might think. For best results some things should run as daemons, like they do on any GNU/Linux system.
But as you are on Windows, this means you have to set up some of the Daemons as Windows Services.

Don't panic, that one is easier than you think.

=== Basic installation ===

I am using the cygwin setup.exe directly using a windows command prompt. That is quicker than searching&clicking every package together.

The following commands can be used to install a Cygwin/X system, that already enables Audio, adds a tray icon, dbus support, Kerberos ticketing, private key management, postfix setup, ssh access, system message logging and an xdg-menu-icon.

I bet you didn't know half of that was possible, right? Me neither until a couple of weeks ago...

Important: The *-devel packages are chosen so the later Gentoo prefix does not need concurrent packages to what is running anyway, or what is almost impossible to build on cygwin using portage. We'll tell portage via package.provided what's what.

You can combine the package lists, of course, and install everything at once.

==== Basic system ====
Install a rudimentary system that let's you start an X-Server and bootstrap Gentoo:
{{Cmd|setup-x86_64.exe -P gcc-g++,git-svn,libdconf-devel,libfam-devel,libgcr-base3-devel,libgcr-ui3-devel,libicu-devel,libusb-devel,nano,wget,xinit,xorg-server-devel,xwin-xdg-menu|prompt=C:\cygwin>}}

==== Avahi Support ====
{{Cmd|setup-x86_64.exe -P avahi,libavahi-client-devel,libavahi-common-devel,libavahi-core-devel,libavahi-glib-devel|prompt=C:\cygwin>}}

==== dbus Daemon ====
{{Cmd|setup-x86_64.exe -P dbus,libdbus-glib_1-devel,libdbus1-devel,libdbusmenu-glib-devel,libdbusmenu-gtk-devel,libdbusmenu-gtk3-devel|prompt=C:\cygwin>}}

==== Tray Indicator ====
{{Cmd|setup-x86_64.exe -P libindicator-devel,libnotify-devel,notification-daemon,trayer|prompt=C:\cygwin>}}

==== Pulse Audio ====
{{Cmd|setup-x86_64.exe -P libpulse-devel,pasystray,pulseaudio-module-x11|prompt=C:\cygwin>}}

====  Kerberos ====
{{Cmd|setup-x86_64.exe -P krb5-auth-dialog,krb5-workstation|prompt=C:\cygwin>}}

==== Extras ====
{{Cmd|setup-x86_64.exe -P gnome-keyring,openssh,postfix,syslog-ng|prompt=C:\cygwin>}}

=== Switching the user context without password ===
Daemons must be able to switch user context. Either to gain special privileges or to drop unneeded privileges.

For the full details please see the corresponding [https://www.cygwin.com/cygwin-ug-net/ntsec.html#ntsec-nopasswd1 part in the cygwin ntsec guide].

For the daemons you see above, we need two methods. The first is to configure cyglsa, the second is to add some dummy users to Windows.

==== Enabling LSA authentication ====
Start a Cygwin64 Terminal with Administrator privileges and issue the following command:
{{Cmd |/usr/bin/cyglsa-config |collapse-output=true |output=Warning: Registering the Cygwin LSA authentication package requires<br />administrator privileges!  You also have to reboot the machine to<br />activate the change.<br /><br />Are you sure you want to continue? (yes/no) yes<br /><br />Cygwin LSA authentication package registered.<br /><br />Activating Cygwin's LSA authentication package requires to reboot. </pre> }}
But before rebooting the machine, you can add the dummy users mentioned above.

==== Adding dummy users ====
Actually this is only one group and two users.

If you want to use postfix, do the following:

# Right click on the Windows start button.
# Select "''Computer Management''"
# Expand "''Local Users and Groups''" 
# Select "''Users''"
# Add a new user named "''postfix''", any password, with "''User cannot change password''" and "''Password never expires''" checked. Make it a member of your general "''Users''" group.
# Select "''Groups''"
# Add a new group named "''postdrop''"
# Add "''postfix''" and your local user to the group.

At least you need the "''nobody''" user:

# Repeat Steps 1-4 above
# Add a new user named "''nobody''" , any password, with "''User cannot change password''" and "''Password never expires''" checked. Make it a member of your general "''Users''" group.

That's it. The installation of openssh daemon will add a sshd user, and cygserver will add a cyg_server user. Everything else will use the SYSTEM account.

== newlib-cygwin - compiling yourself ==
In the [[Prefix/Cygwin|Prefix on Cygwin guide]] you have read that you need a [http://dev.gentoo.org/~haubi/cygwin-gentoo/ cygwin1.dll with the "forkables" patches applied].

It should be sufficient to use the pre-compiled one, at least as far as I know.
However, if you want to compile your own cygwin1.dll, the this is the section for you.

=== Needed packages ===
To be able to successfully configure and compile the project, you will need a few extra packages:
{{Cmd|setup-x86_64.exe -P autoconf2.5,automake1.9,bison,cocom,dejagnu,docbook2X,docbook-xml45,expect,flex,gcc-ada,gcc-fortran,gcc-g++,git-svn,libiconv-devel,libisl-devel,libmpc-devel,libmpfr-devel,make,mingw64-x86_64-gcc-g++,mingw64-x86_64-zlib,nano,tcl-devel,tcl-tk-devel,texinfo,wget,xmlto,zlib-devel|prompt=C:\cygwin>}}

=== Clone the tree ===
Which tree you use is up to you and your discretion

* https://github.com/haubi/newlib-cygwin.git (Branch: Gentoo)
These are what the pre-compiled cygwin1.dll mentioned above is made off.
* https://github.com/Yamakuzure/newlib-cygwin.git (Branch: master)
These are the same Forkables and Gentoo patches, but rebased on the official master repository, thus including all official fixes.

If you need advice, go with the first. I can not guarantee, that my sources do more than compile cleanly, as I do not have the time to check whether all rebased patches are still in whole, and whether the automatic resolving of any conflicts hasn't caused any damage.

=== Configure and build ===
As you now have all the packages you need, you can configure and build the whole tree.
{{Cmd|./configure --prefix{{=}}/usr --build{{=}}x86_64-pc-cygwin CFLAGS{{=}}"$CFLAGS -march{{=}}native -O2 -pipe" CXXFLAGS{{=}}"$CXXFLAGS -march{{=}}native -O2 -pipe" LDFLAGS{{=}}"$LDFLAGS -L/usr/lib -L/usr/bin"|prompt=newlib-cygwin $ }}
Whether you put in these FLAGS or not is up to you. it should ''just work'' without them. But --prefix and --build are important.

When the configure stage is finished, you can build everything. It is best not to push too hard against the windows kernel. The following is well tested on Windows 10 with an 8-core-CPU:
{{Cmd|make -j5 -l4|prompt=newlib-cygwin $ }}

=== Install ===
Yes, you read right. Install this. But not in the root folder, that wouldn't work, because cygwin1.dll is in use. Install it in an image path like this:
{{Cmd|make install DESTDIR{{=}}$(pwd -P)/image|prompt=newlib-cygwin $ }}

The true installation can only happen if absolutely no cygwin process is running. So quit the xdg-menu, close all consoles/windows, and stop all Cygwin services. On Windows 10 you can do the latter using the Task Manager, it has a ''Services'' tab. Under ''Processes'' you might want to check whether there is no dangling dbus process left behind.

Once everything is stopped, you can use the Windows Explorer or any other file manager to copy the contents of your image directory to your cygwin root directory.

{{Important|This is a complete install of the Base/cygwin package. If anything bad happens, you can re-install that package to undo your hand install.}}

== Bootstrapping the Prefix ==
Just do the bootstrap like described on the [[Prefix]] page, unless you do want to start of with some pre-configuration. I prefer the EPREFIX to be "/gentoo", and will refer to it in this way.

=== Possible Preparations ===
There are a few things you can do before bootstrapping your gentoo prefix. Not much, really, and everything here is purely optional.

==== Build in RAM ====
If you have enough RAM, you can have portage do the builds there.
Windows does not know tmpfs, but there is a nice freeware tool you can use to setup RAM disks.
[https://sourceforge.net/projects/imdisk-toolkit/ ImDisk Virtual Disk Driver for Windows] can be used to set up a RAM DISK and mount it in /build, or wherever you want.
Just do not forget to tell portage about it by adding
    export PORTAGE_TMPDIR=/build
(or wherever you mount your RAM Disk) to your ~/.bashrc.
Alternatively you can set up a make.conf to start with, and add the PORTAGE_TMPDIR entry there.

==== Pre-Setup a make.conf ====
This is for the curious, and you can produce more problems than you solve by prematurely setting up a make.conf.

I'll post here mine, please feel free to copy, adapt, throw away, and so on. It works for me, it can horribly break things for you. You have been warned. ;-)

If you '''''really''''' want to use this, put it in /gentoo/etc/portage and be '''damn''' sure to check CPU_FLAGS_X86 against your CPU!
{{CodeBox|lang=bash|1=
ARCH="x64-cygwin"
CHOST="x86_64-pc-cygwin"
ACCEPT_KEYWORDS="x64-cygwin ~x64-cygwin"

CFLAGS="-march=native -O2 -pipe"
CXXFLAGS="${CFLAGS}"

# Fix -R warnings
LDFLAGS="-L${EPREFIX}/usr/bin -L${EPREFIX}/usr/lib"

# Windows 10 shouldn't be pushed too much
MAKEOPTS="-j5 -l4"

# === FEATURES ===
FEATURES="distlocks parallel-fetch protect-owned \
 sfperms strict unmerge-orphans userfetch        \
 split-log userpriv case-insensitive-fs          \
 fixlafiles unknown-features-warn news           \
 config-protect-if-modified"

# Prefixes can not handle sandboxes...
FEATURES="${FEATURES} -sandbox -usersandbox"

# Oh, yeah. It's a prefix...
FEATURES="${FEATURES} force-prefix"

# Do not collision-protect everything. protect-owned above is enough!
FEATURES="${FEATURES} -collision-protect"

# === EMERGE OPTS ===
EMERGE_DEFAULT_OPTS="--alphabetical --verbose --verbose-conflicts --keep-going \
 --jobs=4 --load-average=3.0 \
 --quiet-build=y \
 --binpkg-respect-use=y \
 --with-bdeps=y \
 --color=y \
 --ask-enter-invalid \
 --nospinner \
 --autounmask=y --autounmask-write"

# CPU capabilities (Intel(R) Core(TM) i7-6700 CPU Family 6, Model 94, Stepping 3)
CPU_FLAGS_X86="aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3"

# Extend PATH to find libraries on Windows
DEFAULT_PATH="${DEFAULT_PATH}:/gentoo/usr/bin:/gentoo/usr/lib"

# We don't have lib64 in prefix so, remove it here.
SYMLINK_LIB=""
LIBDIR_amd64="lib"

PYTHON_SINGLE_TARGET="python2_7"
PYTHON_TARGETS="python2_7"

# === Logging ===
# ===============
EMERGE_LOG_DIR=/gentoo/var/log
PORT_LOGDIR=$EMERGE_LOG_DIR/portage

# === Hardware (provided by cygwin) ===
# =====================================
VIDEO_CARDS="dummy"

# === ADDITIONAL CONFIGURATON ===
# ===============================
CONFIG_SHELL="/gentoo/bin/bash"

# This disables /usr-split, removing this will break
PREFIX_DISABLE_GEN_USR_LDSCRIPT=yes

# multilib build stuff, single ABI (no multilib)
MULTILIB_ABIS="amd64"
DEFAULT_ABI="amd64"
ABI="amd64"
IUSE_IMPLICIT="abi_x86_64"

# Portage environment
PORTAGE_TMPDIR=/build
PKGDIR=/packages
DISTDIR=/distfiles
OVERLAY=/overlay
PORTDIR_OVERLAY="${OVERLAY}"

AUTOCLEAN="yes"
}}

=== Problems, Breaks, Failures ===
There are some things that might fail. Here are the common ones for me.

==== libffi: Bootstrap dies ====
Not a real problem. It is just python having a problem with cygffi-6.dll being replaced. Fortunately death comes after the merge is completed, so it is sufficient to restart the bootstrap script. It will continue where it left off.

==== gcc: Never ending merge ====
On some rare occasions the merge of sys-devel/gcc will halt after the compilation stage is over.

Luckily this is easy to fix:
# Send Ctrl+C to break the script.
# In stage 2 just issue {{Cmd|/gentoo/tmp/usr/bin/ebuild /gentoo/usr/portage/sys-devel/gcc/gcc-6.4.0.ebuild merge}} to finish the merge.
# In stage 3, no matter whether you pre-configured something in /gentoo/etc/portage/make.conf or not, the default temp dir is used, so issue {{Cmd|EPREFIX{{=}}/gentoo PORTAGE_TMPDIR{{=}}/gentoo/var/tmp /gentoo/tmp/usr/bin/ebuild /gentoo/usr/portage/sys-devel/gcc/gcc-6.4.0.ebuild merge}} and it will (hopefully) be finished

This always did the trick for me. This halt happened for me in stage2 '''and''' stage3. Well, at least it did not occur in any other situation for me.

After that you can just restart the bootstrap script. It will continue where it left off.
