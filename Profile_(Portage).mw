{{InfoBox stack
|{{InfoBox homepage|https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Base#Choosing_the_right_profile|header=true}}
|{{InfoBox gitweb|https://gitweb.gentoo.org/repo/gentoo.git/tree/profiles/profiles.desc|raw=true}}
}}

A ''Portage profile'' [[Article description::specifies default state (set or unset) of global and per-package [[USE flag]]s, default values for most variables found in {{Path|[[:/etc/portage/make.conf|/etc/portage/make.conf]]}}, and defines a [[System_set_(Portage)|set of system packages]].]] It can also force USE flags to be unconditionally set or unset, either globally, for the architecture's stable branch or per package, and mask packages or specific versions of them. Profile structure and function is specified by the [[#See_also|Package Manager Specification (PMS)]].

Profiles are defined on an [[ebuild repository]] basis; the ones from [[:/usr/portage/profiles|the main repository]] are maintained by the Gentoo developers, but users can [[#custom|define their own]].

The <code>profile</code> module of [[eselect|the eselect tool]] allows users to switch profiles, and during Gentoo's installation process, a profile must be selected as described in section "''Choosing the right profile''" of [[Handbook:Main_Page|the Gentoo handbook]].

== Structure ==

Profiles are defined in directories contained in the {{Path|profiles}} subdirectory of an ebuild repository, which also contains the mandatory {{Path|repo_name}} file that specifies the name of the repository. These are some of the files that can be present in a directory that defines a profile:

* {{Path|eapi}}, which specifies the [[EAPI]] to use when handling the directory in question.
* {{Path|packages}}, which specifies packages that are members of [[System_set_(Portage)|the system set]].
* {{Path|package.mask}}, which specifies masked packages. The administrator can unmask a profile-masked package using {{Path|[[:/etc/portage/package.mask|/etc/portage/package.mask]]}}.
* {{Path|make.defaults}}, with {{Path|[[:/etc/portage/make.conf|make.conf]]}}-like variable assignments, including USE flag global default state (set or unset) and profile variables with special meaning (like <var>ARCH</var>, <var>USE_EXPAND</var>, <var>CONFIG_PROTECT</var>, <var>IUSE_IMPLICIT</var>, etc.).
* {{Path|package.use}}, which defines default USE flag state on a per package basis. Administrator settings in {{Path|/etc/portage/make.conf}} and {{Path|[[:/etc/portage/package.use|/etc/portage/package.use]]}} override profile settings.
* {{Path|use.force}} and {{Path|use.mask}}, which unconditionally set or unset USE flags, overriding administrator settings in {{Path|/etc/portage/make.conf}} and {{Path|/etc/portage/package.use}}. If a flag is both masked and forced, the mask takes precedence.
* {{Path|package.use.force}} and {{Path|package.use.mask}}, which unconditionally set or unset USE flags on a per package basis, overriding administrator settings in {{Path|/etc/portage/make.conf}} and {{Path|/etc/portage/package.use}}, and profile settings in {{Path|use.force}} and {{Path|use.mask}}.
* {{Path|use.stable.force}}, {{Path|use.stable.mask}}, {{Path|package.use.stable.force}} and {{Path|package.use.stable.mask}}, which work like {{Path|use.force}}, {{Path|use.mask}}, {{Path|package.use.force}} and {{Path|package.use.mask}}, but override them for packages in the stable branch of the current architecture.

USE flag settings in profile {{Path|use.*}} and {{Path|package.use.*}} files can be overridden by the administrator with files of the same name in directory {{Path|/etc/portage/profile}}. For complete information about profile directory structure please consult [[Package Manager Specification|the PMS]]. A summary is also contained in [https://devmanual.gentoo.org the Devmanual] and {{c|man portage}}.

== Combining profiles ==

Profile settings can be combined in a cascading/stacking fashion, by including a file named {{Path|parent}} in the directory that defines the profile. This makes the profile inherit the settings in other profiles, which can be partially overriden. For example, by unsetting a USE flag by default that is set by default in a parent profile and vice-versa, inverting its forced state, unmasking packages masked in a parent profile, adding or removing additional packages to/from the system set, etc. {{Path|parent}} must contain a list of profile pathnames, relative to the directory that contains the file. As an extension, [[Portage]] also allows prepending an installed repository name (as specified in {{Path|[[:/etc/portage/repos.conf|/etc/portage/repos.conf]]}}) followed by a colon (':') to a profile pathname, which is then interpreted relative to the {{Path|profiles}} subdirectory of the named repository.

Because parent profiles can also contain a {{Path|parent}} file, an ''inheritance tree'' is produced as a result. The Package Manager Specification specifies how settings in each file of a profile directory (i.e. {{Path|packages}}, {{Path|make.defaults}}, {{Path|package.use.force}} and {{Path|package.use.mask}}, etc.) combine. In particular, it defines an ordering of parent profiles to determine the final settings: the inheritance tree is traversed [[wikipedia:Tree_traversal#Depth-first_search|depth-first, left-to-right]], with multiple occurrences of the same profile processed repeatedly. The left-to-right order is defined by line order in {{Path|parent}} files.

The PMS uniformly calls 'profile' all directories with suitable structure that are contained in an ebuild repository's {{Path|profiles}} subdirectory. A subset designated as 'available for use' must be listed in file {{Path|profiles/profiles.desc}}, a text file that must contain lines with three fields separated by whitespace characters (space and TAB):

* The first one is an architecture, in the format valid as the value of <var>ARCH</var> (and for setting <var>KEYWORDS</var> in ebuilds) as defined in the repository's {{Path|profiles/arch.list}} file (e.g. {{Keyword|amd64}}, {{Keyword|arm}}, {{Keyword|ppc64}}, etc.).
* The second one is a profile path name, relative to the {{Path|profiles}} directory.
* The third and last one is a 'stability indicator'. Gentoo's main repository, for instance, uses ''stable'', ''dev'' and ''exp'' (experimental) for that field.

The {{c|eselect profile list}} command only shows profiles in {{Path|profiles.desc}} files of all repositories configured in {{Path|/etc/portage/repos.conf}}, with an architecture field that matches the machine's architecture. These are the ones that in most contexts are referred to as 'profiles' with no further qualification. Profiles not named in {{Path|profiles.desc}} might be named in other profiles' {{Path|parent}} files, and can be thought of as 'subprofiles' or 'profile building blocks'.

Following is an example that shows parent profiles and the inheritance tree for profile {{Path|default/linux/amd64/13.0/desktop/kde}} in the main Gentoo repository:
{{CodeBox|title=Stacked profiles example|1=
/usr/portage/profiles/
{{!}}-- arch
{{!}}   {{!}}-- amd64 <--------------.
{{!}}   {{!}}   `-- parent >-------- {{!}} ----------------------.
{{!}}   -- base <--------------- {{!}} ----------------------{{!}}
{{!}}-- base <-------------------{{!}}                       {{!}}
{{!}}-- default                  {{!}}                       {{!}}
{{!}}   `-- linux <--------------{{!}}                       {{!}}
{{!}}       `-- amd64 <--------- {{!}} ------------------.   {{!}}
{{!}}           {{!}}-- parent >-----'                   {{!}}   {{!}}
{{!}}           `-- 13.0 <-----------------------.   {{!}}   {{!}}
{{!}}               {{!}}-- parent >---------------- {{!}} --{{!}}   {{!}}
{{!}}               `-- desktop <------------.   {{!}}   {{!}}   {{!}}
{{!}}                   {{!}}-- parent >-------- {{!}} --{{!}}   {{!}}   {{!}}
{{!}}                   `-- kde              {{!}}   {{!}}   {{!}}   {{!}}
{{!}}                       `-- parent >-----{{!}}   {{!}}   {{!}}   {{!}}
{{!}}-- features                             {{!}}   {{!}}   {{!}}   {{!}}
{{!}}   `-- multilib <-----------.           {{!}}   {{!}}   {{!}}   {{!}}
{{!}}       `-- lib32 <--------- {{!}} --------- {{!}} - {{!}} - {{!}} --'
{{!}}           `-- parent >-----'           {{!}}   {{!}}   {{!}}
{{!}}-- releases <-----------.               {{!}}   {{!}}   {{!}}
{{!}}   `-- 13.0 <---------- {{!}} ------------- {{!}} - {{!}} --'
{{!}}       `-- parent >-----'               {{!}}   {{!}}
`-- targets                              {{!}}   {{!}}
    `-- desktop <----------------------- {{!}} --'
        `--kde <----------- {{!}} -----------'
           `-- parent >-----'
}}

The following table gives a quick overview of files contained in each profile directory:

{| class="table table-striped table-condensed" style="vertical-align: top; white-space: nowrap;"
! &nbsp;
! root<br />folder
! arch<br />-amd64
! arch<br />-base
! base
! default<br/>-linux
! default<br/>-linux<br />-amd64
! default<br/>-linux<br />-amd64<br />-13.0
! default<br/>-linux<br />-amd64<br />-13.0<br />-desktop
! default<br/>-linux<br />-amd64<br />-13.0<br />-desktop<br />-kde
! features<br />-multilib
! features<br />-multilib<br />-lib32
! releases
! releases<br />-13.0
! targets<br />-desktop
! targets<br />-desktop<br />-kde
|-
| {{Path|eapi}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{Yes}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{No}} || {{No}}
|-
| {{Path|make.defaults}} || {{No}} || {{Yes}} || {{No}} || {{Yes}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{Yes}} || {{Yes}} || {{Yes}} || {{Yes}} || {{Yes}}
|-
| {{Path|packages}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}}
|-
| {{Path|package.build}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}}
|-
| {{Path|package.mask}} || {{Yes}} || {{No}} || {{No}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{No}} || {{No}}
|-
| {{Path|package.use}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{Yes}}
|-
| {{Path|package.use.force}} || {{No}} || {{Yes}} || {{No}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}}
|-
| {{Path|package.use.mask}} || {{No}} || {{Yes}} || {{No}} || {{Yes}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}}
|-
| {{Path|profile.bashrc}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}}
|-
| {{Path|use.force}} || {{No}} || {{Yes}} || {{No}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}}
|-
| {{Path|use.mask}} || {{No}} || {{Yes}} || {{Yes}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}} || {{Yes}} || {{No}} || {{No}} || {{No}} || {{No}} || {{No}}
|}

For information about the exact way in which settings in the different profile files combine please consult [[Package Manager Specification|the PMS]].
{{anchor|custom}}

== Creating custom profiles ==

Users can create specialized profiles not available in the main Gentoo repository as part of [[Custom_repository|creating a custom repository]]. They can refer to profiles from the main repository in their {{Path|parent}} file using the 'gentoo:' prefix, to avoid recreating all profile definitions. The custom repository should be a slave of the main Gentoo repository (i.e. <code>masters = gentoo</code>) to avoid having to provide required files (like {{Path|arch.list}} and others).

As example, a custom profile named {{Path|plasma-hardened}} that combines {{Path|default/linux/amd64/17.0/hardened}} (hardened Linux profile for architecture {{Keyword|amd64}}, release 17.0) and {{Path|default/linux/amd64/17.0/desktop/plasma/systemd}} (Linux desktop profile for architecture {{Keyword|amd64}}, release 17.0, with [[systemd]]) from the main repository can be created in a local ebuild repository named 'local' as follows. The repository is assumed to be in {{Path|/var/db/repos/local}} (i.e. [[Eselect/Repository#Files|the default location]] for {{c|eselect repository}}), world-readable and owned by a non-root user.

{{FileBox|lang=ini|filename=/etc/portage/repos.conf/local.conf|1=
[local]
# 'eselect repository' default location
location = /var/db/repos/local
}}

{{FileBox|filename=/var/db/repos/local/profiles/repo_name|1=
local
}}

{{FileBox|lang=ini|filename=/var/db/repos/local/metadata/layout.conf|1=
# Slave repository rather than stand-alone
masters = gentoo
profile-formats = portage-2
}}

{{Cmd|ls -ld /var/db/repos/local|output=
<pre>drwxr-xr-x 4 user user 4096 Dec 15 11:50 /var/db/repos/local</pre>
}}

{{Important|Since the profile inheritance tree is traversed depth-first, left-to-right, the order in which profile pathnames are listed in {{Path|parent}} files can dramatically affect the resulting settings, as left-to-right ordering is defined by it. If {{C|emerge}} yields resolution problems after switching to the custom profile, try changing the order of the lines. It may be impossible to get some combinations to work correctly; make sure you have read and understood the algorithm specified in [[Package Manager Specification|the PMS]]!}}

First, create a {{Path|plasma-hardened}} directory in the repository's {{Path|profiles}} subdirectory:

{{Cmd
|profile_name{{=}}plasma-hardened
|cd /var/db/repos/local/profiles && mkdir $profile_name && cat <<EOF >$profile_name/parent
|output=<pre>
> gentoo:default/linux/amd64/17.0/desktop/plasma/systemd
> gentoo:default/linux/amd64/17.0/hardened
> EOF
</pre>}}

Then, insert the newly created profile in the repository's {{Path|profiles.desc}} file, giving it a <code>dev</code> 'stability indicator' for example:

{{Cmd|echo `portageq envvar ARCH` $profile_name dev >profiles.desc}}

Verify that {{c|eselect profile list}} lists the new profile:

{{Cmd|eselect profile list|output=<pre>
...
 [38] local:plasma-hardened
</pre>}}

Now it is possible to actually switch to the new profile using {{c|eselect profile set}}:

{{RootCmd|eselect profile set 38}}

Let's check:

{{Cmd|eselect profile show|output=<pre>
Current /etc/portage/make.profile symlink:
  local:plasma-hardene
</pre>}}

{{Cmd|ls -l /etc/portage/make.profile|output=<pre>
lrwxrwxrwx 1 root root 49 Dec 15 12:00 /etc/portage/make.profile -> ../../var/db/repos/local/profiles/plasma-hardened
</pre>}}

This shows that {{c|eselect profile set}} updated the {{Path|/etc/portage/make.profile}} symbolic link. Now it's possible to run a world rebuild to apply the new settings to all packages, but first check to make sure that the desired changes are going into effect with <code>--ask</code>:

{{Emerge|@world|params=--ask --update --newuse --deep --complete-graph}}

== See also ==

* {{See also|Package Manager Specification}}
* [[Project:AMD64/Multilib_layout|Multilib layout]] for {{Keyword|amd64}} architecture.

== External resources ==

* News item, [https://www.gentoo.org/support/news-items/2017-12-26-experimental-amd64-17-1-profiles.html "Experimental amd64 17.1 profiles up for testing"], December 26th, 2017. Retrieved on December 16th, 2018.
* gentoo-dev mailing list thread [https://archives.gentoo.org/gentoo-dev/message/15fb5b1879c86231e27057ac42134bf0 "Developers, please start switching to 17.1 amd64 profiles"], May 22nd, 2018.
* {{bug|506276|text=Bug 506276}} — (no-symlink-lib) - kill <var>SYMLINK_LIB</var>=<code>yes</code> support.
* Gentoo Forums thread [https://forums.gentoo.org/viewtopic-t-1074166.html "New profiles 17.1"].

[[Category:Portage]]
