<languages />


{{Metadata|abstract=This document covers the installation and maintenance of printers using CUPS and Samba. It covers local installation and networked installations and you'll also find instructions on using shared printers from other operating systems.}}

This document covers the installation and maintenance of printers using CUPS and Samba. It covers local installation and networked installations and you'll also find instructions on using shared printers from other operating systems.

== Printing and Gentoo Linux ==

=== Use the Right Tools ===

Linux has great support for printers; the right tool for the job is called CUPS ( [http://www.cups.org Common Unix Printing System] ). Since the beginning of the project, back in 1999, the installation and maintenance of CUPS has improved dramatically. 

In this document we will cover how to use CUPS to setup a local or networked printer. We will not go in too much detail since the project has [http://www.cups.org/documentation.php great documentation] available for advanced usage. 

== Configure your Kernel ==

=== Introduction ===

When you want to install a printer on your system you need to know how your printer will be attached to your system. Is it through a local port like LPT or USB, or is it networked? And if it is, does it use the Internet Printing Protocol (IPP) or is it through the Microsoft Windows CIFS protocol (Microsoft Windows Sharing)? 

The next few sections explain what minimal kernel configuration you need. Of course, this depends on how your printer is going to be attached to your system, so for your convenience we have separated the instructions.

So navigate to {{Path|/usr/src/linux}} and run <code>make menuconfig</code> to enter the kernel configuration. If you used <code>genkernel</code> to configure your kernel, you should still perform these steps just to make sure nothing was missed. You cannot rely on <code>genkernel</code> alone to configure everything in your system; printing is an area whose configuration settings are hard to automatically set right, if they are configured at all.

In the next configuration examples, we will add the necessary support ''into'' the kernel, not as modules. Building the kernel this way is not mandatory; if you want you can easily use modular support, just be sure to remember to load the appropriate modules afterward! 

Now go to the appropriate section to configure (or check) your kernel.

=== Locally Attached Printer (LPT) ===

The LPT port is generally used to identify the parallel printer port. You need to enable parallel port support first, then PC-style parallel port support (unless you are a SPARC user) after which you enable parallel printer support. 

{{Kernel|Parallel Port Printer Configuration|<pre>
Device Drivers -->
  <*> Parallel port support
  <*> PC-style hardware
  [*] IEEE 1284 transfer modes
  Character Devices -->
    <*> Parallel printer support
</pre>
}}

{{Note|Some users might need to enable other options in the <code>Parallel port support</code> section. Check the kernel configuration <code>Help</code> function for more information.}}

That's it; quit the kernel configuration and rebuild your kernel:

{{RootCmd|make && make modules_install}}

Don't forget to copy the new kernel image to the {{Path|/boot}} location (and don't forget to mount {{Path|/boot}} if needed) and update the boot loader configuration prior to rebooting the system. For instance, when using Grub2, these steps can be done by running the following commands:

{{RootCmd|make install}}
{{RootCmd|grub2-mkconfig -o /boot/grub.grub.cfg}}

Now continue with CUPS.

=== Locally Attached Printer (USB) ===

To enable USB printing, you just need USB support in your kernel: 

{{Kernel|USB Port Printer Configuration|<pre>
Device Drivers -->
  USB Support -->
    <*> Support for Host-side USB
    (...)
    --- USB Host Controller Drivers
    (Select the HCD that your system uses. If you do not know which one
     to select, run "lspci -v | grep HCI" from another terminal)
    <*> EHCI HCD (USB 2.0) support ( or )
    <*> OHCI HCD support           ( or )
    <*> UHCI HCD (most Intel and VIA) support
</pre>
}}

That's it; quit the kernel configuration and rebuild your kernel. Don't forget to copy the new kernel image to the {{Path|/boot}} location (and don't forget to mount {{Path|/boot}} if needed) and update your boot loader configuration prior to rebooting your system. Note the root commands in the '''LPT Printer Configuration''' step above if you're unsure how to perform these two steps.

Now continue with CUPS.

=== Remotely Attached Printer (IPP) ===

To be able to connect to a remotely attached printer through the Internet Printing Protocol your kernel just needs to have networking support. Assuming your kernel has that already, continue with CUPS. 

=== Remotely Attached Printer (CIFS) ===

Your kernel must support CIFS: 

{{Kernel|CIFS Printer Configuration|<pre>
File systems -->
  Network File Systems -->
    <*> CIFS support (advanced network filesystem, SMBFS successor) 
</pre>
}}

That's it; quit the kernel configuration and rebuild your kernel. Don't forget to copy the new kernel image to the {{Path|/boot}} location (and don't forget to mount {{Path|/boot}} if needed) and update your boot loader configuration prior to rebooting your system. Note the root commands in the '''LPT Printer Configuration''' step above if you're unsure how to perform these two steps.

Now continue with CUPS.

== Installing and Configuring CUPS ==

=== Installation ===

Installing CUPS with Gentoo is a breeze. CUPS has a few optional features that might interest you. To enable or disable those features, use the USE flags associated with them. 

{{USEflag|package=net-print/cups
|X+++Allows you to use your desktop menu to load the CUPS configuration webpage into your preferred browser.
|dbus+++Adds support for the <code>dbus</code> system message bus.
|pam+++If you need print job authentication through the Pluggable Authentication Modules, this will activate PAM support for CUPS.
|ssl+++If you want remote authentication and/or privacy, you need support for the Secure Socket Layer, allowing for encrypted printing sessions. Support for SSL must be available on all participating systems in your network.
|usb+++Support for working with printers connected via USB.
}}

Check the current USE settings. If you want to deviate from your current USE settings for CUPS alone, add the appropriate USE flags to {{Path|/etc/portage/package.use}}. 

{{RootCmd|emerge -pv cups|output=<pre>
[ebuild N     ] net-print/cups-1.7.3  USE="X acl dbus pam ssl threads usb -debug -gnutls -java -kerberos -lprng-compat -python (-selinux) -static-libs -systemd -xinetd -zeroconf" ABI_X86="(64) (-32) (-x32)" LINGUAS="ca es fr it ja pt_BR ru" PYTHON_SINGLE_TARGET="python2_7" PYTHON_TARGETS="python2_7" 0 kB
</pre>}}

If you are happy with the result, have Portage install CUPS. 

{{Emerge|cups}}

To enable SAMBA support, {{Package|net-fs/samba}} needs to be installed with CUPS support. Update the {{Path|/etc/portage/package.use}} file or directory to enable the <code>cups</code> USE flag:

{{File|/etc/portage/package.use|Enabling cups USE flag for samba|
<pre>net-fs/samba cups</pre>
}}

Then (re)install Samba:

{{Emerge|net-fs/samba}}

{{Important|Any user that needs to print should be added to the <code>lp</code> group:
{{RootCmd|gpasswd -a username lp}}
  
In order to be able to add printers and edit them via CUPS's web interface, any system user that is allowed to edit these settings should be in the <code>lpadmin</code> group:
  
{{RootCmd|gpasswd -a username lpadmin}}
}}

If the printer is attached to your system locally, and you want your printer to be available each time you boot you will need to load the CUPS daemon automatically on start-up. Make sure your printer is attached and powered on before you start the CUPS daemon. 

{{RootCmd|/etc/init.d/cupsd start
|rc-update add cupsd default}}

=== Configuration ===

The default CUPS server configuration in {{Path|/etc/cups/cupsd.conf}} is sufficient for most users. However, some users might need to make changes to the CUPS configuration.

In the next section we cover a few changes that are often needed: 

* Allow other systems to use the printer attached to this Linux workstation.
* Grant access to the CUPS administration from remote systems
* Configure CUPS to support Windows PCL drivers. This is advised if you want Windows systems to be able to use a SAMBA-shared printer as most Windows drivers are PCL drivers.
* Configure this system to use a printer attached to another system (not Windows share).

=== Remote Printer Access ===

If you want other systems to use your printer through IPP you need to explicitly grant access to the printer in {{Path|/etc/cups/cupsd.conf}}. If you want to share your printer using SAMBA, this change is not needed. 

Open up {{Path|/etc/cups/cupsd.conf}} in your favorite editor and add in an <code>Allow</code> line for the system(s) that should be able to reach to your printer. In the next example, you can grant access to the printer from localhost and from any system whose IP address starts with <code>192.168.0</code> . 

{{File|/etc/cups/cupsd.conf|Allowing remote access to the printer|<pre>
<Location />
  Order allow,deny
  Allow localhost
  Allow from 192.168.0.*
</Location>
</pre>}}

This broadcasts browsing information to the clients on the network; it will let network users know when the printer is available:

{{File|/etc/cups/cupsd.conf|Broadcast info|<pre>
BrowseAddress 192.168.0.*:631
</pre>
}}

Also, you will need to specify which port CUPS listens to, so that it will respond to printing requests from other machines on your network:

{{File|/etc/cups/cupsd.conf|Port configuration|<pre>
Listen *:631
#Listen localhost:631
</pre>
}}

{{Note|If you are still using CUPS 1.1 (which is now deprecated), then you will need to use a different syntax for remote printing requests:
{{Code|Deprecated CUPS 1.1 configuration|<pre>
Port 631
(Make sure the next two lines are commented out)
#Listen 127.0.0.1:631
#Listen localhost:631
</pre>
}}
}}

=== CUPS Remote Administration ===

If you are interested in remote administration, you need to grant access from other systems than just localhost to the CUPS administration. Edit {{Path|/etc/cups/cupsd.conf}} and have it explicitly grant access to the systems you want. For instance, to grant access to the system with IP address of 192.168.0.3: 

{{File|/etc/cups/cupsd.conf|Allowing remote access|<pre>
<Location /admin>
(...)
  Encryption Required
  Order allow,deny
  Allow localhost
  Allow 192.168.0.3
</Location>
</pre>
}}

Do not forget to restart the CUPS daemon after making changes to {{Path|/etc/cups/cupsd.conf}} by running <code>/etc/init.d/cupsd restart</code> . 

=== Enable Support for Windows PCL Drivers ===

PCL drivers send raw data to the print server. To enable raw printing on CUPS, you need to edit {{Path|/usr/share/cups/mime/mime.types}} and uncomment the line <code>application/octet-stream</code> if it is not already uncommented. Then you need to edit {{Path|/usr/share/cups/mime/mime.convs}} and do the same, if it is not already uncommented. 

{{File|/usr/share/cups/mime/mime.types|Enable support for raw printing|<pre>
application/octet-stream
</pre>}}

{{File|/usr/share/cups/mime/mime.convs||<pre>
application/octet-stream     application/vnd.cups-raw    0    -
</pre>
}}

Do not forget to restart the CUPS daemon after making these changes by running <code>/etc/init.d/cupsd restart</code> . 

=== Setting Up a Remote Printer ===

If the printers are attached to a remote CUPS-powered server you can easily set up your system to use the remote printer by changing the {{Path|/etc/cups/client.conf}} file. 

Assuming the printer is attached to a system called <code>printserver.mydomain</code>, open up {{Path|/etc/cups/client.conf}} with your favorite editor and set the <code>ServerName</code> directive: 

{{File|/etc/cups/client.conf||<pre>
# (Substitute printserver.mydomain with your print server name)
ServerName printserver.mydomain
</pre>
}}

The remote system will have a default printer setting which you will be using. If you want to change the default printer, use <code>lpoptions</code>: 

First list the available printers:

{{RootCmd|lpstat -a|output=<pre>
hpljet5p accepting requests since Jan 01 00:00
hpdjet510 accepting requests since Jan 01 00:00
</pre>}}

Set the HP LaserJet 5P as the default printer:

{{RootCmd|lpoptions -d hpljet5p}}

== Configuring a Printer ==

=== Introduction ===

If the printer you want to configure is remotely available through a different print server (running CUPS) you do not need to follow these instructions. Instead, read [[#Setting_Up_a_Remote_Printer|Setting Up a Remote Printer]]. 

=== Detecting the Printer ===

If you have a USB printer or your parallel port printer was powered on when you booted your Linux system, you might be able to retrieve information from the kernel stating that it has successfully detected your printer. However this is merely an indication and not a requirement. 

{{Cmd|dmesg {{!}} grep -i print|output=<pre>
parport0: Printer, Hewlett-Packard HP LaserJet 2100 Series
</pre>}}

For a USB printer:

{{Cmd|lsusb|output=<pre>
(...)
Bus 001 Device 007: ID 03f0:1004 Hewlett-Packard DeskJet 970c/970cse
</pre>
}}

=== Installing the Printer ===

To have the printer installed on your system, fire up your browser and have it point to [http://localhost:631 http://localhost:631] . You will be greeted by the CUPS web interface from which you can perform all administrative tasks. 


{{Note|If you use an HTTPS connection to CUPS, the first time you access the interface it ''may'' take a very long time before the site comes up. This is because the first request triggers the generation of the CUPS SSL certificates which can be a very time-consuming job.}}

Go to ''Administration'' and enter your root login and password information at the box. Then, when you have reached the administrative interface, click on ''Add Printer'' . You will be greeted by a new screen allowing you to enter the following information: 

* The ''spooler name'' , a short but descriptive name used on your system to identify the printer. This name should not contain spaces or any special characters. For instance, for the HP LaserJet 5P you could say <code>hpljet5p</code> .
* The ''location'' , a description where the printer is physically located (for instance in your room, or in the kitchen right next to your dish washer, ...). This is to help maintaining several printers.
* The ''description'' in which you should place a full description of the printer. A common use is the full printer name (like "HP LaserJet 5P").

The next screen asks you for the device where the printer listens to. You will have the choice of several devices. The next table covers a few possible devices, but the list is not exhaustive. 

{| class="wikitable" style="text-align: left;" 
|- 
! Device
! Description
|- 
| AppSocket/HP JetDirect
| This special device allows for network printers to be accessible through a HP JetDirect socket. Only specific printers support this.
|- 
| Internet Printing Protocol (IPP or HTTP)
| Use this to reach your remote printer through the IPP protocol either directly (IPP) or through HTTP.
|- 
| LPD/LPR Host or Printer
| Select this if the printer is remote and attached to a LPD/LPR server.
|- 
| Parallel Port #1
| Select this when the printer is locally attached to your parallel port (LPT). When the printer is automatically detected its name will be appended to the device as well.
|- 
| USB Printer #1
| Select this when the printer is locally attached to a USB port. The printer name should automatically be appended to the device name.
|-
|}

If you are installing a remote printer, you will be asked for the URI to the printer: 

* An LPD printer server requires a <code>lpd://hostname/queue</code> syntax
* An HP JetDirect printer requires a <code>socket://hostname</code> syntax
* An IPP printer requires a <code>ipp://hostname/printers/printername</code> or <code>http://hostname:631/printers/printername</code> syntax.

Next, select the printer manufacturer in the adjoining screen and the model type and number in the subsequent one. For many printers you will find multiple drivers. You can either select one now or search on [http://www.openprinting.org/printer_list.cgi OpenPrinting Printer List] for a good driver. You can change drivers easily later on. 

Once the driver is selected, CUPS will inform you that the printer has been added successfully to the system. You can now go to the printer management page on the administration interface and select <code>Configure Printer</code> to change the printer settings (resolution, page format, ...).

=== Testing and Reconfiguring the Printer ===

To verify if the printer is working correctly, go to the printer administration page, select your printer and click on <code>Print Test Page</code> . 

If the printer does not seem to work correctly, click on <code>Modify Printer</code> to reconfigure the printer. You will be greeted with the same screens as during the first installation but the defaults will now be your current configuration. 

If you have no idea why your printer does not function, you might get a clue by looking at {{Path|/var/log/cups/error_log}} . In the next example we find out that there is a permission error, probably due to a wrong <code>Allow</code> setting in {{Path|/etc/cups/cupsd.conf}} . 

{{RootCmd|tail /var/log/cups/error_log|output=<pre>
(...)
E [11/Jun/2005:10:23:28 +0200] [Job 102] Unable to get printer status (client-error-forbidden)!
</pre>
}}

=== Installing the Best Driver ===

Many printer drivers exist; to find out which one has the best performance for your printer, visit the [http://www.openprinting.org/printer_list.cgi OpenPrinting Printer List]. Select your brand and type to find out what driver the site recommends. For instance, for the HP LaserJet 5P, the site recommends the <code>ljet4</code> driver. 

Download the PPD file from the site and place it in {{Path|/usr/share/cups/model}} , then run <code>/etc/init.d/cupsd restart</code> as root. This will make the driver available through the CUPS web interface. Now reconfigure your printer as described above.

== Using Special Printer Drivers ==

=== Introduction ===

Some printers require specific drivers or provide additional features that are not enabled through the regular configuration process as described above. This chapter will discuss a selection of printers and how they are made to work with Gentoo Linux. 

=== Gutenprint Driver ===

The [http://gutenprint.sourceforge.net gutenprint] drivers are high-quality, open source printer drivers for various Canon, Epson, HP, Lexmark, Sony, Olympus and PCL printers supporting CUPS, ghostscript, The Gimp and other applications. 

Gentoo's Portage Tree contains an ebuild for the gutenprint drivers. Just use <code>emerge gutenprint</code> to install them. Note that the ebuild listens to quite a few USE flags (such as <code>cups</code> and <code>ppds</code> ). You must have enabled at least these two flags! 

{{Emerge|gutenprint}}

When the emerge process has finished, the gutenprint drivers will be available through the CUPS web interface.

=== HPLIP Driver ===

See [[HPLIP|HPLIP Driver]].

=== PNM2PPA Driver ===

PPA is an HP technology that focuses on sending low-level processing to the system instead of to the printer which makes the printer cheaper but more resource consuming. 

If the [http://www.openprinting.org/printer_list.cgi OpenPrinting] site informs you that the [http://pnm2ppa.sourceforge.net/ pnm2ppa] driver is your best option, you need to install the <code>pnm2ppa</code> filter on your system: 

{{Emerge|pnm2ppa}}

Once installed, download the PPD file for your printer from the [http://www.openprinting.org/printer_list.cgi OpenPrinting] site and put it in {{Path|/usr/share/cups/model}} . Next, configure your printer using the steps explained above.

== Printing From and To Microsoft Windows ==

{{Note|You should read our [[Samba/HOWTO|Samba/CUPS Guide]] for more detailed information on setting up CUPS with Samba.}}

=== Configuring a Windows Client for IPP ===

Microsoft Windows supports IPP (Windows 9x and ME users need to [http://support.microsoft.com/default.aspx?scid=kb;en-us;294439 install] it separately). To install a printer that is attached to your Linux box on Windows, fire up the <code>Add Printer</code> wizard and select <code>Network Printer</code> . When you are asked for the URI, use the <code>http://hostname:631/printers/queue</code> syntax. 

=== Configuring a Windows Client for a Samba Shared Printer ===

To share the printer on the CIFS network, you must have SAMBA installed and configured correctly. How to do this is beyond the scope of this document, but we will quickly deal with the configuration of SAMBA for shared printers. 

Open {{Path|/etc/samba/smb.conf}} with your favorite editor and add a <code>[printers]</code> section to it: 

{{Code|Adding a [printers] section|<pre>
[printers]
  comment      = All printers
  path         = /var/spool/samba
  browseable   = no
  guest ok     = no
  writable     = no
  printable    = yes
  public       = yes
  printer name = hpljet5p
</pre>
}}

Now navigate to the top of the {{Path|smb.conf}} file until you are inside the <code>[global]</code> section. Then locate the <code>printcap name</code> and <code>printing</code> settings and set each of them to <code>cups</code> : 

{{Code|Changing the [global] section|<pre>
[global]
  (...)
  printcap name = cups
  printing      = cups
</pre>
}}

Make sure you enabled the [[#Enable_Support_for_Windows_PCL_Drivers|windows pcl]] support in CUPS. Then, restart the <code>smb</code> service to have the changes take effect.

=== Configuring a Linux Client for a Windows Print Server ===

First of all, make sure that the printer is shared on your Windows system and that you have emerged <code>samba</code> with the <code>cups</code> USE-flag enabled as instructed above.

To find the desired printer's URI, run the following command, substituting "server" with the computer that you want to probe for samba-shared printers:

{{Cmd|smbclient -N '\\server\'}}

Next, in the CUPS web interface, configure your printer as described previously. You will notice that CUPS has added another driver called <code>Windows Printer via SAMBA</code> . Select it and use the <code>smb://username:password@workgroup/server/printername</code> or <code>smb://server/printername</code> syntax for the URI.

{{Important|Any special characters in the above URI need to be appropriately quoted. For example:
<code>smb://BEN-DESKTOP/HP Color LaserJet CP1510 series PCL6</code>
  
becomes:
  
<code>smb://BEN-DESKTOP/HP%20Color%20LaserJet%20CP1510%20series%20PCL6</code>
  
  
You can get this result string by running the following command:
{{Cmd|python2 -c 'import urllib; print "smb://" + urllib.quote("BEN-DESKTOP/HP Color LaserJet CP1510 series PCL6")'}}
}}

== Printing-related Applications ==

=== Introduction ===

Many tools exist that help you configure a printer, use additional printing filters, add features to your printing capabilities, etc. This chapter lists a few of them. The list is not exhaustive and not meant to discuss each tool in great detail. 

=== Gtk-LP - A Gtk-powered Printer Configuration Tool ===

With [http://gtklp.sourceforge.net/index.shtml Gtk-LP] you can install, modify and configure your printer from a stand-alone Gtk application. It uses CUPS and provides all standard CUPS capabilities as well. Definitely worth checking out if you dislike the CUPS Web interface or want a stand-alone application for your day-to-day printing routines. 

To install it, emerge <code>gtklp</code> : 

{{Emerge|gtklp}}

== Troubleshooting ==

=== Error: Unable to convert file 0 to printable format ===

If you are having printing troubles and {{Path|/var/log/cups/error_log}} shows this message: 

{{Code|Error log|<pre>
Unable to convert file 0 to printable format
</pre>
}}

You need to re-emerge <code>ghostscript-gpl</code> with the <code>cups</code> USE flag. You can either add <code>cups</code> to your USE flags in {{Path|/etc/portage/make.conf}} , or you can enable it only for <code>ghostscript-gpl</code> as shown: 

{{RootCmd|echo "app-text/ghostscript-gpl cups" >> /etc/portage/package.use}}

Then emerge <code>ghostscript-gpl</code>. When it has finished compiling, be sure to restart <code>cupsd</code> afterward: 

{{RootCmd|/etc/init.d/cupsd restart}}

== Acknowledgements ==

We would like to thank the following authors and editors for their contributions to this guide:


* swift
* nightmorph
