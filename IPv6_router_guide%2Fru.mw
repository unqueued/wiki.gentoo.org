<languages />


{{Metadata|abstract=В этом руководстве объясняется как настроить маршрутизацию IPv6 в системе Gentoo Linux.}}
{{Dirty|date=February 3, 2016}}

== Предварительные настройки ==

=== Основные Настройки Ядра ===

Любое из доступных в Gentoo ядер версии 2.6 без проблем поддерживает соединения IPv6. Новый стек IPv6 (USAGI) интегрирован в ядро начиная с версии Linux 2.6.0. 

{{Emerge|sys-kernel/gentoo-sources}}

Теперь мы готовы перейти в каталог с исходным кодом ядра и начать его конфигурацию. 

{{RootCmd
|cd /usr/src/linux
|make menuconfig
}}

{{Note|Предполагается, что символьная ссылка {{Path|/usr/src/linux}} ссылается на исходный код ядра, который будет использоваться как часть этого гайда.}}

{{KernelBox|title=Параметры для 'make menuconfig'|<pre>
Networking support --->
  Networking options --->
    <*> The IPv6 protocol --->
## (Параметы IPv6 ниже этого элемента меню могут пригодиться для многих других приложений,
## но не требуются для базовой установки)
 
## (Этот параметр требуется только когда для преобразования 6to4 используется ptrtd)
Device Drivers --->
  Network device support --->
    <*> Universal TUN/TAP device driver support
</pre>
}}

=== Проверка поддержки IPv6 ===

После включения рекомендуемых параметров, перекомпилируйте ядро с поддержкой IPv6 и перезагрузитесь. 

Если программа {{c|iproute2}} все еще не установлена, сделать это настоятельно рекомендуется. iproute2 — это набор инструментов для конфигурации сети, содержащий {{c|ip}} — замечательную замену для {{c|ifconfig}}, {{c|route}}, {{c|iptunnel}} и других программ… 

{{Emerge|sys-apps/iproute2}}

{{Warning|Использование {{c|ifconfig}} может вызвать серьезные неприятности при наличии нескольких туннельных устройств. Туннели нужно убирать в обратном порядке, что означает, что самый последний из созданных должен быть убран первым.}}

Если IPv6 работает, loopback-устройство должно показывать IPv6-адрес: 

{{RootCmd|ip -6 addr show lo|output=<pre>
1: lo: <LOOPBACK,UP> mtu 16436
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
    ## (Строки выше показывают, что все работает)
</pre>
}}

Перед тем, как продолжить, убедитесь, что <var>ipv6</var> находится в списке переменных USE в файле {{Path|make.conf}}, чтобы пакеты, которые будут установлены позже, включали поддержку IPv6.

== Настройка туннеля ==

=== Основная конфигурация ===

Большинство провайдеров все еще не предоставляют нативные соединения IPv6. Для обхода этого ограничения есть разбросанные по всему миру провайдеры туннелей (tunnel brokers), предлагающие свободные IPv6-туннели. Благодаря им можно туннелировать IPv6-соединения через IPv4. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! Сервис
! Местоположение
|- 
|  [http://tunnelbroker.net/ Hurricane Electric] 
| Северная Америка, Европа, Азия
|- 
|  [http://gogonet.gogo6.com/ Freenet6] 
| США
|- 
|  [http://www.sixxs.net/ Sixxs] 
| Европа
|- 
|  [http://tunnel-broker.singnet.com.sg/ Singnet] 
| Сингапур
|- 
|  [http://broker.aarnet.net.au/ Aarnet] 
| Австралия и Океания
|-
|}

Ниже приведены два примера настройки туннеля с двумя популярными североамериканскими туннелями: Hurricane Electric (также применимо к non-heartbeat туннелям sixxs.net) и Freenet6. 

=== Hurricane Electric ===

Hurricane Electric (сокращенно — HE) предлагает свободные IPv6-туннели и выделяет для клиента адреса блоками /64. Также позволяет настроить обратную DNS-зону. Получение туннеля от HE — простая процедура, сводится к переходу по ссылке [https://www.tunnelbroker.net/ https://www.tunnelbroker.net/] и заполнению одностраничной формы. 

{{Note|Регистрация включает разную информацию, например домашний адрес и номер телефона.}}

После выделения туннеля и блока /64, пришло время настроить систему. HE предоставляет образцы настроек, основанные на утилитах {{c|ifconfig}} и {{c|iproute}}. В двух примерах предполагается следующая конфигурация: 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
| Local IPv4 Address (eth0)
| 68.36.91.195
|- 
| HE IPv4 Address
| 64.71.128.82
|- 
| Local IPv6 tunnel Address
| 2001:470:1F00:FFFF::2
|-
| Remote IPv6 tunnel Address
| 2001:470:1F00:FFFF::1
|- 
| IPv6 Block
| 2001:470:1F00:296::/64
|-
|}

Используя команду {{c|ip}} из пакета {{Package|sys-apps/iproute2}}, выполните следующее.

Создайте туннель между локальным адресом IPv4 (eth0) и удаленным IPv4-адресом Hurricane Electric:

{{RootCmd|ip tunnel add he6 mode sit remote 64.71.128.82 local 68.36.91.195 ttl 64 dev eth0}}

Выведите издержки туннелирования (tunneling overhead) из MTU:

{{RootCmd|ip link set he6 mtu 1280}}

Поднимите туннель:

{{RootCmd|ip link set he6 up}}

Назначьте ему IPv6-адрес:

{{RootCmd|ip addr add 2001:470:1F00:FFFF::2 dev he6}}

Направьте все глобальные unicast-IPv6-адреса через туннельное устройство 'he6':

{{RootCmd|ip route add 2000::/3 dev he6}}

В следующем примере показано, как создать это во время загрузки:

{{CodeBox|title=Пример netifrc|lang=bash|1=
iptunnel_he6="mode sit remote 64.71.128.82 local 68.36.91.195 ttl 64 dev eth0"
depend_he6="net.eth0"
config_he6="2001:470:1F00:FFFF::2/64"
routes_he6="default via 2001:470:1F00:FFFF::1 dev he6"
mtu_he6="1280"
}}

Сделайте это, чтобы устройство загружалось во время загрузки:

{{RootCmd|cd /etc/init.d
|ln -s net.lo net.he6
|rc-update add net.he6 default
}}

{{Note|Если нет политики по умолчанию ACCEPT для IPv4 iptables, то необходимо добавить: {{RootCmd|iptables -A INPUT -i eth0 -p ipv6 -j ACCEPT}}}}

Если туннель IPv6 поверх IPv4, то пакеты сперва попадают в цепочку IPv4, а затем переходят в цепочку IPv6.

=== Freenet6 ===

[http://gogonet.gogo6.com/ Freenet6] — это еще один свободный сервис туннелей. Необязательная регистрация требует только имени пользователя и действующий email-адреса. Управление туннелем сведено к системе клиент-сервер и созданию клиента <code>gogoCLIENT</code>. Данный клиент доступен в системе Portage. Для его установки выполните: 

{{Emerge|net-misc/gogoc}}

Теперь при выборе соединения с аутентификацией потребуется настроить <code>gogoCLIENT</code>, отредактировав файл {{Path|/etc/gogoc/gogoc.conf}}. Нужно только изменить поля <var>userid</var> и <var>passwd</var> для соответствия полям, назначенным Freenet6, и изменить сетевой шлюз. Ниже приведен пример файла конфигурации. 

{{CodeBox|title=Пример gogoc.conf|lang=bash|1=
auth_method=any
userid=anonymous
passwd=foobar
template=linux
server=broker.freenet6.net
}}

=== Проверка соединения ===

Теперь, когда туннель настроен, необходимо протестировать соединение. Самым легким способом это сделать является использование утилиты <code>ping6</code> для проверки связи с хостом IPv6. 

{{Emerge|iputils}}

{{Cmd|ping6 www.kame.net|output=<pre>
PING www.kame.net(orange.kame.net) 56 data bytes
64 bytes from orange.kame.net: icmp_seq=1 ttl=52 time=290 ms
64 bytes from orange.kame.net: icmp_seq=2 ttl=52 time=277 ms
64 bytes from orange.kame.net: icmp_seq=3 ttl=52 time=280 ms
64 bytes from orange.kame.net: icmp_seq=4 ttl=52 time=279 ms
64 bytes from orange.kame.net: icmp_seq=5 ttl=52 time=277 ms
 
--- www.kame.net ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4038ms
rtt min/avg/max/mdev = 277.040/281.041/290.046/4.699 ms
</pre>
}}

Ведется дальнейшая работа по добавлению лучшей поддержки IPv6 в сценарии инициализации сети. Чтобы узнать статус разработки или помочь, пожалуйста, отправьте сообщение на {{Mail|latexer@gentoo.org}}.

== Поддержка IPv6 в приложениях ==

=== Переустановка пакетов ===

Если <code>USE="ipv6"</code> в файле {{Path|/etc/portage/make.conf}} уже установлен, возможно, необходимо переустановить группу пакетов для их компиляции с поддержкой IPv6. Для получения списка всех установленных пакетов, затронутых изменениями USE-флага, используйте параметр Portage <code>--newuse</code> (<code>-N</code>): 

{{Emerge|@world|params=-uDNav}}

При изменении большого количества USE-флагов, этот список будет довольно большим. Предполагается, что система обновляется регулярно, поэтому повторная компиляция всех задействованных пакетов не принесет вреда. 

{{Note|Некоторые пакеты (ошибочно) обнаруживают поддержку IPv6 автоматически и, следовательно, не имеют USE-флага ipv6. Таким образом, не все пакеты, которые должны поддерживать IPv6, будут поддерживать его, если они не скомпилированы на ядре с поддержкой IPv6.}}

=== Пакеты для работы с IPv6 ===

Существует несколько пакетов для работы с IPv6. Большинство из них находятся в каталоге {{Path|/usr/portage/net-misc}}. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! Пакет
! Описание
|- 
| {{Package|net-misc/ipv6calc}}
| Преобразует IPv6-адрес в сжатый формат
|- 
| {{Package|net-misc/netcat6}}
| Версия netcat с поддержкой IPv6 и IPv4
|- 
| {{Package|dev-perl/Socket6}}
| Связанная с IPv6 часть директив define и манипуляторов из файла socket.h языка C 
|-
|}

== Настройка DNS ==

=== IPv6 и DNS ===

Также как DNS использует для IPv4 записи A, аналогично используются AAAA записи для IPv6. (это потому что IPv4 имеет адресное пространство 2^32, в то время как IPv6 имеет адресное пространство 2^128). Для обратных запросов DNS, стандарт INT устарел, но все еще широко поддерживается. ARPA является самым новым стандартом. Поддержка формата ARPA описывается далее в этом руководстве. 

=== Настройка BIND ===

Последние версии BIND включают поддержку IPv6. Для прочтения этого раздела требуется минимальное знание о конфигурации и использовании BIND. Предполагается, что BIND не запущен в chroot. Если это предположение ошибочно, просто добавьте префикс chroot к большинству частей следующего раздела. 

Сначала добавьте записи для файлов "прямой" (forward) и "обратной" (reverse) зоны DNS в {{Path|/etc/bind/named.conf}}. 

{{FileBox|filename=/etc/bind/named.conf|title=Записи named.conf|1=
## (Мы разрешаем bind слушать IPv6-адреса.
## Использование 'any' является единственным способом это выполнить для версий bind ранее 9.3)
options {
    [...]
    listen-on-v6 { any; }
    [...]
};
## (Этот раздел предусматривает прямой DNS для домена 'ipv6-rules.com':)
zone "ipv6-rules.com" IN {
    type master;
    file "pri/ipv6-rules.com";
};
## (Данный формат обратного DNS является "побитовым." Это выполняется взятием префикса IPv6,
## переставлением чисел в обратном порядке и размещением точки между каждым числом)
zone "6.9.2.0.0.0.f.1.0.7.4.0.1.0.0.2.ip6.arpa" {
        type master;
        file "pri/rev-ipv6-rules.com.arpa";
};
}}

Теперь требуется создать эти файлы зоны и добавить записи для каждого из хостов. 

{{FileBox|filename=/etc/bind/pri/ipv6-rules.com|1=
$TTL    2h
@       IN      SOA     ipv6-rules.com. webmaster.ipv6-rules.com.  (
                                2003052501 ; Serial
                                28800      ; Refresh
                                14400      ; Retry
                                3600000    ; Expire
                                86400 )    ; Minimum
                NS      ns1.ipv6-rules.com
 
IN      AAAA    2001:470:1f00:296::1 ; address for ipv6-rules.com
host1   IN      AAAA    2001:470:1f00:296::2 ; address for host1.ipv6-rules.com
host2   IN      AAAA    2001:470:1f00:296::3:3 ; address for host2.ipv6-rules.com
}}

{{FileBox|filename=/etc/bind/pri/ipv6-rules.com.arpa|1=
$TTL 3d ; Default TTL (bind 8 needs this, bind 9 ignores it)
@       IN SOA ipv6-rules.com. webmaster.ipv6-rules.com. (
                        2003052501      ; Serial number (YYYYMMdd)
                        24h             ; Refresh time
                        30m             ; Retry time
                        2d              ; Expire time
                        3d )            ; Default TTL
        IN      NS     ns1.ipv6-rules.com.
; IPv6 PTR entries
$ORIGIN 6.9.2.0.0.0.f.1.0.7.4.0.1.0.0.2.ip6.arpa.
 
1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0 IN      PTR     ipv6-rules.com.
2.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0 IN      PTR     host1.ipv6-rules.com.
3.0.0.0.3.0.0.0.0.0.0.0.0.0.0.0 IN      PTR     host2.ipv6-rules.com.
}}

=== Настройка DJBDNS ===

Для DJBDNS существует несколько патчей от сторонних разработчиков, доступных по адресу [http://www.gentoo.org/ http://www.fefe.de/dns/] , которые позволяют выполнение запросов DNS для IPv6. DJBDNS может быть установлен с этими патчами, если в список USE-флагов добавлен <code>ipv6</code>. 

{{Warning|Не все типы записей поддерживаются этими патчами. В частности, записи NS и MX не поддерживаются.}}

{{Emerge|djbdns}}

После установки djbdns, его нужно настроить, запустив команду {{c|tinydns-setup}} и ответив на несколько вопросов о том, к каким адресам нужно осуществлять привязку, куда устанавливать tinydns, и т. д. 

{{RootCmd|tinydns-setup}}

Предположим, мы установили {{c|tinydns}} в {{Path|/var/tinydns}}. Теперь мы можем отредактировать {{Path|/var/tinydns/root/data}}. Этот файл содержит все данные, необходимые tinydns для обработки DNS для делегирования IPv6. 

{{CodeBox|title=Образец файла данных|1=
## (*.ipv6-rules.com авторитативно обрабатываются 192.168.0.1)
.ipv6-rules.com:192.168.0.1:a:259200
## (Авторитативный обратный DNS для 2001:470:1f00:296::/64)
.6.9.2.0.0.0.f.1.0.7.4.0.1.0.0.2.ip6.arpa:192.168.0.1:a
## (Укажите IP-адреса для хостов host1 и host2)
6host1.ipv6-rules.com:200104701f0002960000000000000001:86400
6host2.ipv6-rules.com:200104701f0002960000000000000002:86400
## (Направьте www на host1)
3www.ipv6-rules.com:200104701f0002960000000000000002:86400
}}

Для строк с префиксом <code>6</code> будут созданы обе записи: AAAA и PTR. Для строк с префиксом <code>3</code> будет создана только запись AAAA. Помимо редактирования файла {{Path|data}} вручную, можно использовать сценарии {{c|add-host6}} и {{c|add-alias6}} для добавления новых записей. После внесения изменений в файл {{Path|data}}, необходимо запустить <code>make</code> из {{Path|/var/tinydns/root}}. В результате будет создан файл {{Path|/var/tinydns/root/data.cfb}}, который будет использоваться tinydns в качестве источника информации для DNS-запросов.

== IPv6-маршрутизатор ==

=== Настройка маршрутизации ===

Для использования системы в качестве маршрутизатора для других клиентов, которым требуется соединение через IPv6, необходима дальнейшая настройка. Нам потребуется включить переадресацию пакетов IPv6. Это можно сделать двумя способами. 

Либо мы установим значение 1 в псевдо-файле переадресации:

: {{RootCmd|echo 1 > /proc/sys/net/ipv6/conf/all/forwarding}}

Или необходимо использовать команду {{c|sysctl}}:

: {{RootCmd|sysctl -w net.ipv6.conf.all.forwarding{{=}}1}}

{{Warning|Сценарий инициализации {{c|radvd}}, объясняемый в следующем разделе, включает (и отключает) переадресацию, делая следующий шаг ненужным.}}

Чтобы включить переадресацию при загрузке, нужно отредактировать файл {{Path|/etc/sysctl.conf}} и добавить в него следующую строчку. 

{{CodeBox|title=Редактирование sysctl.conf|1=
## (Когда используется radvd, эта настройка не требуется)
net.ipv6.conf.default.forwarding=1
}}

Теперь трафик с этого компьютера должен быть переадресован через туннель, который был установлен ранее с выбранным нами сервисом. 

Чтобы назначить клиентам адреса IPv6, в спецификации IPv6 разрешается stateless и stateful назначение IP. Stateless назначение использует процесс с названием Router Advertisement и позволяет клиентам получить IP-адрес и маршрут по умолчанию простым поднятием интерфейса. Этот способ называется "stateless" потому что не имеет записи о назначенных IP-адресах и хосте, которому они назначены. Stateful назначение обрабатывается DHCPv6. Оно называется "stateful" потому что сервер хранит состояние клиентов, запросивших и получивших IP-адреса.

=== Stateless-конфигурация ===

Stateless-конфигурация легко выполняется использованием программы Router Advertisement Daemon, или {{c|radvd}}: 

{{Emerge|radvd}}

После установки {{c|radvd}}, необходимо создать файл {{Path|/etc/radvd/radvd.conf}}, хранящий информацию о том из какой подсети нужно назначать IP. Здесь приведен пример файла {{Path|radvd.conf}}, использующий префикс, назначенный нашим сервисом туннелей. 

{{CodeBox|title=Пример radvd.conf|1=
interface eth1
{
        ## (Отправка advertisement-сообщений другим хостам)
        AdvSendAdvert on;
        ## (Фрагментация нежелательна (tm))
        AdvLinkMTU 1280;
        MaxRtrAdvInterval 300;
        ## (Префикс подсети IPv6 назначенный нашим PoP)
        prefix 2001:470:1F00:296::/64
        {
                AdvOnLink on;
                AdvAutonomous on;
        };
};
}}

{{Warning|Проверьте, что интерфейс в первой строчке указан правильно, чтобы отправлять advertisement маршрутизатора в интранет, а не интернет-провайдеру!}}

Further information is available in {{c|man radvd.conf}}. We can now start {{c|radvd}} and set it to start at boot. 

{{RootCmd
|/etc/init.d/radvd start
|rc-update add radvd default
}}

=== Stateful configuration ===

To have a stateful configuration, install and configure {{Package|net-misc/dibbler}}. 

{{Emerge|dibbler}}

Теперь нужно настроить dibbler-клиент, отредактировав {{Path|/etc/dibbler/client.conf}}. 

{{CodeBox|title=Пример конфигурации клиента dibbler|1=
iface ppp0 {
	rapid-commit yes
	pd
	option dns-server
}
</pre>
}}

Теперь можно запустить клиент dibbler и настроить его на запуск при загрузке. 

{{RootCmd
|/etc/init.d/dibbler-client start
|rc-update add dibbler-client default
}}

== IPv6 clients ==

=== Использование radvd ===

Clients behind this router should now be able to connect to the rest of the net via IPv6. If using radvd, configuring hosts should be as easy as bringing the interface up. (This is probably already done by the net.ethX init scripts). 

{{RootCmd|ip link set eth0 up
|ip addr show eth0|output=<pre>
1: eth0: <BROADCAST,MULTICAST,UP> mtu 1400 qdisc pfifo_fast qlen 1000
    link/ether 00:01:03:2f:27:89 brd ff:ff:ff:ff:ff:ff
    inet6 2001:470:1f00:296:209:6bff:fe06:b7b4/128 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::209:6bff:fe06:b7b4/64 scope link
       valid_lft forever preferred_lft forever
    inet6 ff02::1/128 scope global
       valid_lft forever preferred_lft forever
</pre>
}}

Should this not work ensure that the IPv6 firewall is allowing ICMPv6 packets through:

{{RootCmd|ip6tables -A INPUT -p icmpv6 -j ACCEPT}}

== External resources ==

There are many excellent resources online pertaining to IPv6. 

* [http://www.ipv6.org/ www.ipv6.org] - General IPv6 information
* [http://www.linux-ipv6.org/ www.linux-ipv6.org/] - USAGI project
* [http://www.deepspace6.net/ www.deepspace6.net] - Linux/IPv6 site
* [http://www.kame.net/ www.kame.net] - *BSD implementation

On IRC, try the {{IRC|ipv6}} channel on [http://www.freenode.net/ Freenode]. Connect to the Freenode servers using an IPv6 enabled client by connecting to irc.ipv6.freenode.net. 

{{Migrated|originalauthors=Peter Johanson, Jorge Paulo, Sven Vermeulen, Camille Huot, Pasi Valminen, nightmorph, hwoarang}}

[[Category:Network management]]
