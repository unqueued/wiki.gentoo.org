<languages />

{{Metadata|abstract=Эта статья описывает ручную конфигурацию и настройку ядра Linux. Автоматический метод описан в статье genkernel.}}

Эта статья описывает ручную конфигурацию и настройку [[Kernel/ru|ядра Linux]]. Автоматический метод описан в статье [[genkernel]].

==Установка символьной ссылки==

Символьная ссылка {{Path|/usr/src/linux}} всегда должна указывать на исходные коды используемого в настоящий момент ядра. Это может быть сделано одним из трех способов:

;1. Установка исходных кодов ядра с активным [[USE flag|USE-флагом]] "symlink"
:Это заставит {{Path|/usr/src/linux}} указывать на исходный код заново устанавливаемого ядра. Если необходимо, символьная ссылка может быть изменена позже двумя следующими методами:

;2. Настройка символьной ссылки с помощью '''eselect''':

{{RootCmd|eselect kernel list|output=<pre>
Available kernel symlink targets:
[1] linux-3.3.8-gentoo
[2] linux-3.4.9-gentoo
</pre>}}

:Эта команда выводит доступные исходные коды ядра. Звездочкой отмечены выбранные исходные коды. Для того чтобы изменить исходные коды ядра, например выбрать второй пункт, сделайте следующее:

{{RootCmd|eselect kernel set 2}}

;3. Установка символьной ссылки вручную:

{{RootCmd|ln -sf /usr/src/linux-3.4.9-gentoo /usr/src/linux |
|ls -l /usr/src/linux |
|output=lrwxrwxrwx 1 root root 11 Aug 29 22:10 /usr/src/linux -> /usr/src/linux-3.4.9-gentoo
}}

<!-- The output is the same as the target file in the ln command. -->

==Инструменты конфигурации==

Ядро предлагает несколько инструментов для собственной конфигурации:

{| class="table"
|-
! Command
! Description
|-
| <tt>make config</tt>
| Text based configuration. The options are prompted one after another. All options need to be answered, and out-of-order access to former options is not possible.
|-
| <tt>make menuconfig</tt>
| An ncurses-based graphical menu (only text input). Navigate through the menu to modify the desired options.
|-
| <tt>make defconfig</tt>
| Generates a new config with default from the ARCH supplied defconfig file. Use this option to get back the default configuration file that came with the sources.
|-
| <tt>make nconfig</tt>
| Graphical menu based on ncurses. Requires {{Package|sys-libs/ncurses}} to be installed.
|-
| <tt>make xconfig</tt>
| Graphical menu using Qt4. Requires {{Package|dev-qt/qtgui}} to be installed.
|-
| <tt>make gconfig</tt>
| Graphical menu using GTK+. Requires {{Package|x11-libs/gtk+}}, {{Package|dev-libs/glib}}, and {{Package|gnome-base/libglade}} to be installed.
|-
| <tt>make oldconfig</tt>
| Review changes between kernel versions and update to create a new {{Path|.config}} for the kernel.
|-
| <tt>make allyesconfig</tt>
| Enables all configuration options in the kernel. target will set ''all'' kernel options to <code>*</code>. Make sure a backup of the current kernel configuration is acquired before experimentally using it!
|}

Существует несколько сценариев создания смешанных конфигураций по умолчанию. Смотри:

{{RootCmd|make help}}

== Конфигурация ==

Эта статья описывает конфигурацию с использованием '''make menuconfig''', но процедура аналогична подобным для других меню.

{{RootCmd|cd /usr/src/linux
|make menuconfig}}

=== Использование меню ===

In the shown menu the blue bar indicates the position of the cursor. With the {{Key|↑}} and {{Key|↓}} arrow keys change the position of the cursor. The {{Key|←}} and {{Key|→}}  arrow keys traverse the menu bar in the bottom and define what happens when the {{Key|Enter}} key is pressed. For the menu bar below, '''Select''' switches to a sub menu for the menu entries ending with <tt>---></tt> while '''Exit''' exits a sub menu. As an alternative the {{Key|Esc}} key can be pressed twice to exit the application.

Pressing an associated letter key {{Key|A}}-{{Key|Z}} will move the position of the cursor lines that have characters in bold. The {{Key|Y}}, {{Key|M}}, {{Key|N}} keys are excluded from navigation in this way; they are sanctified for other purposes. If a line begins with a Y, M, or N, the next character will be bold and capable of being jumped to. For example, relative to the cursor's current position, if the next line reads "N'''e'''twork Device Support --->" pressing the {{Key|E}} key will move the cursor to that line.

Пункты меню, начинающиеся со скобок, являются драйверами или частями системы, которые могут быть активированы.

Кроме того, некоторые пункты меню имеют метки в конце:

{| class="table"
|-
! Tag
! Description
|-
| <code>(NEW)</code>
| This driver is new in the kernel and is maybe not stable enough.
|-
| <code>(EXPERIMENTAL)</code>
| This driver is experimental and most likely not stable enough.
|-
| <code>(DEPRECATED)</code>
| This driver is deprecated and not needed for most systems.
|-
| <code>(OBSOLETE)</code>
| This driver is obsolete and should not be activated.
|}

Большинство параметров имеют описание, которое можно посмотреть нажимая клавишу {{Key|H}} или выбирая в строке меню '''Help'''.

=== Выбор драйверов ===

Смотри статью [[hardware detection]] и статьи в категории [[:Category:Hardware|Hardware]].

=== Поиск модулей ===
Внутри "menuconfig" можно использовать {{Key|/}} для поиска модулей по имени.

Within <tt>menuconfig</tt>, use the {{Key|/}} key to search modules by name.

As shown below, the search result will show numbers in front of the matches. Pressing {{Key|1}} in the example below would make <tt>menuconfig</tt> jump straight to the option ''Bluetooth device drivers'' in the menu structure.

{{KernelBox|title=Example output after searching for HCIBTUSB|1=
Symbol: BT_HCIBTUSB [{{=}}m]                       
Type  : tristate                               
Prompt: HCI USB driver                         
  Location:                                    
    -> Networking support (NET [{{=}}y])           
      -> Bluetooth subsystem support (BT [{{=}}y]) 
(1)     -> Bluetooth device drivers            
  Defined at drivers/bluetooth/Kconfig:5       
  Depends on: NET [{{=}}y] && BT [{{=}}y] && USB [{{=}}m]
}}

=== Включение общих настроек Gentoo Linux ===

Существует опция конфигурации ядра, называемая <code>CONFIG_GENTOO_LINUX</code>, которая находится только в {{Package|sys-kernel/gentoo-sources}} и других ядрах, поддерживаемых [[Project:Kernel|проектом ядра]]. Она ничего не делает сама по себе, но устанавливает различные необходимые опции конфигурации, которые чаще всего нужны для установок.

Пока данная настройка автоматически выбирает поддержку tmpfs и devtmpfs, которые нужны для работы с {{Path|/dev}} в Gentoo Linux, но в будущем эта настройка может включать и другие обязательные опции для системы на Gentoo Linux. Для более детальной информации, прочитайте информацию, которую можно получить через систему конфигурации ядра (как было описано выше в данной статье).

== Компиляция ==

После конфигурации ядра Вам необходимо его скомпилировать:

{{RootCmd|make}}

Если у Вас многоядерный процессор, Вы можете распределить работу по всем ядрам. Для этого добавьте параметр '''-j(NUMBER_CORES +1)'''. Для двухъядерного процессора:

{{RootCmd|make -j3}}

== Установка ==

Если Вы включили драйверы в виде модулей, Вам необходимо их установить:

{{RootCmd|make modules_install}}

Модули будут скопированы в подкаталог {{Path|/lib/modules}}.

Для того, чтобы установить само ядро:

{{RootCmd|make install}}

Эта команда запускает скрипт '''/sbin/installkernel''', который является частью пакета {{Package|sys-apps/debianutils}}. ''Новое ядро устанавливается в {{Path|/boot//vmlinuz-{version}}}. Если символьная ссылка {{Path|/boot/vmlinuz}} уже существует, она обновляется путем создания ссылки из {{Path|/boot/vmlinuz}} на новое ядро, а ядро, установленное ранее, доступно как {{Path|/boot/vmlinuz.old}}.'' (''installkernel'' [[man page]]). То же самое происходит и для файлов {{Path|config}} и {{Path|System.map}}. Эти символьные ссылки удобны, потому что они всегда указывают на новейшее ядро без изменения файлового пути (например, Вы можете использовать их в конфигурации загрузчика).

== Загрузчик ==

Измените конфигурацию [[bootloader|загрузчика]] для выбора нового ядра при загрузке.

И наконец, перезагрузите Вашу систему с новым ядром.

== Comparing current kernel configuration with default configuration ==

Use the following procedure to get an overview over the kernel configurations that deviate from the default. Keep in mind that the modification of configuration setting may entail additional configuration settings.

{{RootCmd
|cd /usr/src/linux
|cp .config ../.config.working
|make defconfig
|mv .config ../.config.default
|cp ../.config.working .config
|cd ..
|diff .config.working .config.default {{!}} sed --quiet '/^\([<{{!}}>] CONFIG\)/ p' > .config.diff
}}

The search function in <tt>make menuconfig</tt> can be used to look up the flags and their interpretation.
When you're done, clean up:

{{RootCmd
|cd /usr/src/
|rm .config.working .config.default .config.diff
}}

== See also ==
* [[Genkernel]]
* [[Kernel/Configuration/Kernel_Seeds|Kernel Seeds]]

== External resources ==

[[Category:Kernel]]
