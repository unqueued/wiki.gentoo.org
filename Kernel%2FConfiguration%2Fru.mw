<languages />

{{Metadata|abstract=Эта статья описывает ручную конфигурацию и настройку ядра Linux. Автоматический метод описан в статье genkernel.}}

Эта статья описывает ручную конфигурацию и настройку [[Kernel/ru|ядра Linux]]. Автоматический метод описан в статье [[genkernel]].

==Установка символьной ссылки==

Символьная ссылка {{Path|/usr/src/linux}} всегда должна указывать на исходные коды используемого в настоящий момент ядра. Это может быть сделано одним из трех способов:

1. Установите исходный код ядра с включенным <code>symlink</code> [[USE flag|USE-флагом]]. Это заставит {{Path|/usr/src/linux}} указывать на исходный код свежеустановленного ядра. Если необходимо, символьная ссылка может быть изменена позже двумя следующими методами:

2. Настройка символьной ссылки с помощью <tt>eselect</tt> утилиты:

{{RootCmd|eselect kernel list|output=<pre>
Available kernel symlink targets:
[1] linux-3.3.8-gentoo
[2] linux-3.4.9-gentoo
</pre>}}

Эта команда выводит доступные исходные коды ядра. Звездочкой отмечены выбранные исходные коды. Для того чтобы изменить исходные коды ядра, например выбрать второй пункт, сделайте следующее:

{{RootCmd|eselect kernel set 2}}

3. Установка символьной ссылки вручную:

{{RootCmd|ln -sf /usr/src/linux-3.4.9-gentoo /usr/src/linux |
|ls -l /usr/src/linux |
|output=lrwxrwxrwx 1 root root 11 Aug 29 22:10 /usr/src/linux -> /usr/src/linux-3.4.9-gentoo
}}

<!-- The output is the same as the target file in the ln command. -->

==Инструменты конфигурации==

Ядро предлагает несколько инструментов для собственной конфигурации.

{| class="table"
|-
! Команда
! Описание
|-
| <tt>make config</tt>
| Конфигуратор с текстовым интерфейсом. Вопросы следуют один за другим. На все вопросы должен быть дан ответ по порядку. Доступ к предыдущим вопросам невозможен.
|-
| <tt>make menuconfig</tt>
| Конфигуратор основанный на ncurses с псевдографическим интерфейсом (возможен только ввод текста).  Для изменения параметров есть навигация с помощью меню.
|-
| <tt>make defconfig</tt>
| Создает новый конфигурационный файл с настройками по умолчанию, которые берутся из архитектурно-зависимых defconfig файлов. Используйте эту опцию, чтобы снова создать конфигурационный файл с настройками по умолчанию, так же как в архиве с исходным кодом.
|-
| <tt>make nconfig</tt>
| Еще один конфигуратор с псевдографическим меню основанный на ncurses. Требуется, чтобы библиотека {{Package|sys-libs/ncurses}} была установлена.
|-
| <tt>make xconfig</tt>
| Конфигуратор с графическим интерфейсом основанный на Qt4. Должен быть установлен {{Package|dev-qt/qtgui}} пакет.
|-
| <tt>make gconfig</tt>
| Конфигуратор с графическим интерфейсом основанный на GTK+. Должны быть установлены пакеты {{Package|x11-libs/gtk+}}, {{Package|dev-libs/glib}} и {{Package|gnome-base/libglade}}.
|-
| <tt>make oldconfig</tt>
| Обзор изменений между версиями ядра, а так же обновление их для создания нового {{Path|.config}} для ядра.
|-
| <tt>make allyesconfig</tt>
| Включает все возможные опции ядра. Эта утилита устанавливает ''все'' опции ядра в <code>*</code>. Убедитесь, что сохранена резервная копия конфигурации ядра, прежде чем будете экспериментировать с этой  опцией!!!
|}

Существует несколько сценариев создания смешанных конфигураций по умолчанию. 
Они могут помочь сделать более тонкую и в то же время более эффективную настройку. Выполните следующую команду для получения полного списка сценариев make targets:

{{RootCmd|make help}}

== Конфигурация ==

Эта статья описывает конфигурацию с использованием утилиты <tt>make menuconfig</tt>, но процедура аналогична и для других конфигураторов.

{{RootCmd|cd /usr/src/linux
|make menuconfig}}

=== Использование меню ===

In the shown menu the blue bar indicates the position of the cursor. With the {{Key|↑}} and {{Key|↓}} arrow keys change the position of the cursor. The {{Key|←}} and {{Key|→}}  arrow keys traverse the menu bar in the bottom and define what happens when the {{Key|Enter}} key is pressed. For the menu bar below, '''Select''' switches to a sub menu for the menu entries ending with <tt>---></tt> while '''Exit''' exits a sub menu. As an alternative the {{Key|Esc}} key can be pressed twice to exit the application.

Pressing an associated letter key {{Key|A}}-{{Key|Z}} will move the position of the cursor lines that have characters in bold. The {{Key|Y}}, {{Key|M}}, {{Key|N}} keys are excluded from navigation in this way; they are sanctified for other purposes. If a line begins with a Y, M, or N, the next character will be bold and capable of being jumped to. For example, relative to the cursor's current position, if the next line reads "N'''e'''twork Device Support --->" pressing the {{Key|E}} key will move the cursor to that line.

The following symbols can appear in front of the lines in the menus:
{| class="table"
|-
! Symbol(s)
! Description
|-
| <code>[ ], [*]</code>
| Options in square brackets can be activated or deactivated. The asterisk marks the menu entry as activated. The value can be changed with the {{Key|space}} key. It is also possible to press {{Key|Y}} key ('''Y'''es) to activate or {{Key|N}} key ('''N'''o) to deactivate the selected entry.
<br/>
If the option is activated, the selected feature/driver will be built into the kernel and will always be available at boot time.
|-
| <code>< >, <M>, <*></code>
| Options in angle brackets can be activated or deactivated, but also activated as module (indicated by a ''M''). The values can be modified by pressing {{Key|Y}}/{{Key|N}} keys as before or by pressing the {{Key|M}} key to activate the feature/driver as a module.
<br/>
See the [[Kernel Modules]] article for differentiation.
|-
| <code>{M}, {*}</code>
| Options in curly brackets can be activated or activated as module but not be deactivated. This happens because another feature/driver is dependent on this feature.
|-
| <code>-M-, -*-</code>
| Options between hyphens are activated in the shown way by another feature/driver. There is no choice.
|}

Кроме того, некоторые пункты меню имеют метки в конце:

{| class="table"
|-
! Tag
! Description
|-
| <code>(NEW)</code>
| This driver is new in the kernel and is maybe not stable enough.
|-
| <code>(EXPERIMENTAL)</code>
| This driver is experimental and most likely not stable enough.
|-
| <code>(DEPRECATED)</code>
| This driver is deprecated and not needed for most systems.
|-
| <code>(OBSOLETE)</code>
| This driver is obsolete and should not be activated.
|}

Most options have a description, which see by pressing the {{Key|H}} key or choosing '''Help''' in the menu bar.

=== Выбор драйверов ===

Смотри статью [[hardware detection]] и статьи в категории [[:Category:Hardware|Hardware]].

=== Search modules ===

Within <tt>menuconfig</tt>, use the {{Key|/}} key to search modules by name.

As shown below, the search result will show numbers in front of the matches. Pressing {{Key|1}} in the example below would make <tt>menuconfig</tt> jump straight to the option ''Bluetooth device drivers'' in the menu structure.

{{KernelBox|title=Example output after searching for HCIBTUSB|1=
Symbol: BT_HCIBTUSB [{{=}}m]                       
Type  : tristate                               
Prompt: HCI USB driver                         
  Location:                                    
    -> Networking support (NET [{{=}}y])           
      -> Bluetooth subsystem support (BT [{{=}}y]) 
(1)     -> Bluetooth device drivers            
  Defined at drivers/bluetooth/Kconfig:5       
  Depends on: NET [{{=}}y] && BT [{{=}}y] && USB [{{=}}m]
}}

=== Включение общих настроек Gentoo Linux ===

Существует опция конфигурации ядра, называемая <var>CONFIG_GENTOO_LINUX</var>, которая находится только в {{Package|sys-kernel/gentoo-sources}} и других ядрах, поддерживаемых [[Project:Kernel|проектом ядра]]. Она ничего не делает сама по себе, но устанавливает различные необходимые опции конфигурации, которые чаще всего нужны для установок.

Пока данная настройка автоматически выбирает поддержку <code>tmpfs</code> и <code>devtmpfs</code>, которые нужны для работы с {{Path|/dev}} в Gentoo Linux, но в будущем эта настройка может включать и другие обязательные опции для системы на Gentoo Linux. Для более детальной информации, прочитайте информацию, которую можно получить через систему конфигурации ядра (как было описано выше в данной статье).

== Компиляция ==

After configuration has been accomplished successfully, compile the kernel:

{{RootCmd|make}}

For processors with multiple cores, make all the cores do the work. Add the option <code>-j(<NUMBER_OF_CORES> + 1)</code>. For example, a dual core processor contains two logical cores plus one (2 + 1):

{{RootCmd|make -j3}}

A quad core system contains four logical cores plus one (4 + 1):

{{RootCmd|make -j5}}

== Установка ==

If drivers are activated as modules, they must be installed:

{{RootCmd|make modules_install}}

Модули будут скопированы в подкаталог {{Path|/lib/modules}}.

Для того, чтобы установить само ядро:

{{RootCmd|make install}}

This command executes {{Path|/sbin/installkernel}}, which is part of the {{Package|sys-apps/debianutils}} package. ''The new kernel is installed into {{Path|/boot/vmlinuz-{version}}}. If a symbolic link {{Path|/boot/vmlinuz}} already exists, it is refreshed by making a link from {{Path|/boot/vmlinuz}} to the new kernel, and the previously installed kernel is available as {{Path|/boot/vmlinuz.old}}.'' (''installkernel'' [[man page]]). The same for {{Path|config}} and {{Path|System.map}} files. These symlinks are handy, because they always point to the newest kernel without changing the file path (e.g. they can be used in the bootloader configuration).

== Загрузчик ==

Change the system's [[bootloader]] configuration to pick up at boot the new kernel.

И наконец, перезагрузите систему с новым ядром.

== Comparing current kernel configuration with default configuration ==

Use the following procedure to get an overview over the kernel configurations that deviate from the default. Keep in mind that the modification of configuration setting may entail additional configuration settings.

{{RootCmd
|cd /usr/src/linux
|cp .config ../.config.working
|make defconfig
|mv .config ../.config.default
|cp ../.config.working .config
|cd ..
|/usr/src/linux/scripts/diffconfig .config.working .config.default > .config.diff
}}

The search function in <tt>make menuconfig</tt> can be used to look up the flags and their interpretation.
When you're done, clean up:

{{RootCmd
|cd /usr/src/
|rm .config.working .config.default .config.diff
}}

== See also ==
* [[Genkernel]]
* [[Kernel/Configuration/Kernel_Seeds|Kernel Seeds]]

== External resources ==

[[Category:Kernel]]
