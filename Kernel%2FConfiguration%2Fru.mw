<languages />

{{Metadata|abstract=Эта статья описывает ручную конфигурацию и настройку ядра Linux. Автоматический метод описан в статье genkernel.}}

Эта статья описывает ручную конфигурацию и настройку [[Kernel/ru|ядра Linux]]. Автоматический метод описан в статье [[Genkernel/ru|genkernel]].

==Установка символьной ссылки==

Символьная ссылка {{Path|/usr/src/linux}} всегда должна указывать на исходный код используемого в настоящий момент ядра. Это может быть сделано одним из трех способов:

1. Установите исходный код ядра с включенным <code>symlink</code> [[USE flag|USE-флагом]]. Это заставит {{Path|/usr/src/linux}} указывать на исходный код свежеустановленного ядра. Если необходимо, символьная ссылка может быть изменена позже двумя следующими методами:

2. Настройка символьной ссылки с помощью {{c|eselect}} утилиты:

{{RootCmd|eselect kernel list|output=<pre>
Available kernel symlink targets:
[1] linux-3.3.8-gentoo
[2] linux-3.4.9-gentoo
</pre>}}

Эта команда выводит доступные исходные коды ядра. Звездочкой отмечен выбранный исходный код. Для того чтобы изменить исходный код ядра, например выбрать второй пункт, сделайте следующее:

{{RootCmd|eselect kernel set 2}}

3. Установка символьной ссылки вручную:

{{RootCmd|ln -sf /usr/src/linux-3.4.9-gentoo /usr/src/linux |
|ls -l /usr/src/linux |
|output=lrwxrwxrwx 1 root root 11 Aug 29 22:10 /usr/src/linux -> /usr/src/linux-3.4.9-gentoo
}}

<!-- The output is the same as the target file in the ln command. -->

==Инструменты конфигурации==

Ядро предлагает несколько инструментов для собственной конфигурации.

{| class="table table-striped table-condensed"
|-
! scope="col" width="15%" | Command
! Description
|-
| {{c|make config}}
| Text based configuration. The options are prompted one after another. All options need to be answered, and out-of-order access to former options is not possible.
|-
| {{c|make menuconfig}}
| An ncurses-based pseudo-graphical menu (only text input). Navigate through the menu to modify the desired options.
|-
| {{c|make defconfig}}
| Generates a new config with default from the ARCH supplied defconfig file. Use this option to get back the default configuration file that came with the sources.
|-
| {{c|make nconfig}}
| Pseudo-graphical menu based on ncurses. Requires {{Package|sys-libs/ncurses}} to be installed.
|-
| {{c|make xconfig}}
| Graphical menu using Qt4. Requires {{Package|dev-qt/qtgui}} to be installed.
|-
| {{c|make gconfig}}
| Graphical menu using GTK+. Requires {{Package|x11-libs/gtk+}}, {{Package|dev-libs/glib}}, and {{Package|gnome-base/libglade}} to be installed.
|-
| {{c|make oldconfig}}
| Review changes between kernel versions and update to create a new {{Path|.config}} for the kernel.
|-
| {{c|make allyesconfig}}
| Enables all configuration options in the kernel. It will set ''all'' kernel options to <code>*</code>. Make sure a backup of the current kernel configuration is acquired before experimentally using it!
|}

Существует несколько сценариев создания смешанных конфигураций по умолчанию. 
Они могут помочь сделать более тонкую и в то же время более эффективную настройку. Выполните следующую команду для получения полного списка сценариев make targets:

{{RootCmd|make help}}

== Конфигурация ==

Эта статья описывает конфигурацию с использованием утилиты {{c|make menuconfig}}, но процедура аналогична и для других конфигураторов.

{{RootCmd|cd /usr/src/linux
|make menuconfig}}

=== Использование меню ===

В отображенном меню позиция курсора отмечена синей строкой. С помощью клавиш {{Key|↑}} и {{Key|↓}} можно изменять позицию курсора. Клавиши {{Key|←}} и {{Key|→}} проходят по меню внизу и определяют, что произойдет при нажатии клавиши {{Key|Enter}}. В меню внизу '''Select''' выбирает подменю — пункты меню оканчивающиеся с '''--->''', в то время как '''Exit''' выходит из подменю. В качестве альтернативы, можно выйти из подменю двойным нажатием клавиши {{Key|Esc}}.

Нажатие клавиш {{Key|A}}-{{Key|Z}} переместит курсор к пункту меню у которого эта буква выделена жирным шрифтом. Буквы {{Key|Y}}, {{Key|M}}, {{Key|N}} не используются для такой навигации; они нужны для других целей. Если пункт меню начинается с букв Y, M, или N, обычно используется следующая буква для выделения. Например для такого пункта меню "N'''e'''twork Device Support --->" нужно нажать клавишу {{Key|E}}.

Могут быть следующие символы перед пунктом меню:

{| class="table table-striped table-condensed"
|-
! scope="col" width="15%" | Symbol(s)
! Description
|-
| <code>[ ], [*]</code>
| Options in square brackets can be activated or deactivated. The asterisk marks the menu entry as activated. The value can be changed with the {{Key|space}} key. It is also possible to press {{Key|Y}} key ('''Y'''es) to activate or {{Key|N}} key ('''N'''o) to deactivate the selected entry.
<br />
If the option is activated, the selected feature/driver will be built into the kernel and will always be available at boot time.
|-
| <code>< >, <M>, <*></code>
| Options in angle brackets can be activated or deactivated, but also activated as module (indicated by a ''M''). The values can be modified by pressing {{Key|Y}}/{{Key|N}} keys as before or by pressing the {{Key|M}} key to activate the feature/driver as a module.
<br />
See the [[Kernel Modules]] article for differentiation.
|-
| <code>{M}, {*}</code>
| Options in curly brackets can be activated or activated as module but not be deactivated. This happens because another feature/driver is dependent on this feature.
|-
| <code>-M-, -*-</code>
| Options between hyphens are activated in the shown way by another feature/driver. There is no choice.
|}

Кроме того, некоторые пункты меню имеют метки в конце:

{| class="table table-striped table-condensed"
|-
! scope="col" width="15%" | Метка
! Описание
|-
| <code>(NEW)</code>
| Этот драйвер является новым в ядре и, может быть, не достаточно стабилен.
|-
| <code>(EXPERIMENTAL)</code>
| Этот драйвер является экспериментальным и, скорее всего, он достаточно не стабилен.
|-
| <code>(DEPRECATED)</code>
| Этот драйвер является устаревшим и не требуется для большинства систем.
|-
| <code>(OBSOLETE)</code>
| Этот драйвер является устаревшим и его не нужно включать.
|}

Большинство параметров имеют описание, которое можно посмотреть нажимая клавишу {{Key|H}} или набрав '''Help''' в строке меню.

=== Выбор драйверов ===

Смотрите статью [[hardware detection]], а также статьи в категории [[:Category:Hardware|Hardware]].

=== Поиск модулей ===

Внутри <code>menuconfig</code> можно использовать {{Key|/}} для поиска модулей по имени.

As shown below, the search result will show numbers in front of the matches. Pressing {{Key|1}} in the example below would {{c|make menuconfig}} jump straight to the option ''Bluetooth device drivers'' in the menu structure.

{{KernelBox|title=Пример вывода после поиска HCIBTUSB|1=
Symbol: BT_HCIBTUSB [{{=}}m]                       
Type  : tristate                               
Prompt: HCI USB driver                         
  Location:                                    
    -> Networking support (NET [{{=}}y])           
      -> Bluetooth subsystem support (BT [{{=}}y]) 
(1)     -> Bluetooth device drivers            
  Defined at drivers/bluetooth/Kconfig:5       
  Depends on: NET [{{=}}y] && BT [{{=}}y] && USB [{{=}}m]
}}

=== Включение общих настроек Gentoo Linux ===

Существует опция конфигурации ядра, называемая <var>CONFIG_GENTOO_LINUX</var>, которая находится только в {{Package|sys-kernel/gentoo-sources}} и других ядрах, поддерживаемых [[Project:Kernel|проектом ядра]]. Она ничего не делает сама по себе, но устанавливает различные необходимые опции конфигурации, которые чаще всего нужны для установок.

Пока данная настройка автоматически выбирает поддержку <code>tmpfs</code> и <code>devtmpfs</code>, которые нужны для работы с {{Path|/dev}} в Gentoo Linux, но в будущем эта настройка может включать и другие обязательные опции для системы на Gentoo Linux. Для более детальной информации, прочитайте информацию, которую можно получить через систему конфигурации ядра (как было описано выше в данной статье).

== Компиляция ==

После успешной конфигурации ядра скомпилируйте его:

{{RootCmd|make}}

Для многоядерных процессоров можно распределить работу по всем ядрам. Добавьте параметр <code>-j(<NUMBER_OF_CORES> + 1)</code>. Например, двухядерный процессора содержит два логических ядра плюс один (2+1):

{{RootCmd|make -j3}}

Четырехъядерная система содержит четыре логических ядер плюс один (4+1):

{{RootCmd|make -j5}}

== Установка ==

Если драйверы включены в виде модулей, необходимо их установить:

{{RootCmd|make modules_install}}

Модули будут скопированы в подкаталог {{Path|/lib/modules}}.

Для того, чтобы установить само ядро:

{{RootCmd|make install}}

Эта команда запускает скрипт {{Path|/sbin/installkernel}}, который является частью пакета {{Package|sys-apps/debianutils}}. ''Новое ядро устанавливается в {{Path|/boot//vmlinuz-{version}}}. Если символьная ссылка {{Path|/boot/vmlinuz}} уже существует, она обновляется путем создания ссылки из {{Path|/boot/vmlinuz}} на новое ядро, а ядро, установленное ранее, доступно как {{Path|/boot/vmlinuz.old}}.'' (''installkernel'' [[man page]]). То же самое происходит и для файлов {{Path|config}} и {{Path|System.map}}. Эти символьные ссылки удобны, потому что они указывают на новейшее ядро без изменения файлового пути (например, они могут быть использованы в конфигурации загрузчика).

== Загрузчик ==

Обновите конфигурацию [[bootloader|загрузчика]] системы, чтобы иметь возможность выбора нового ядра при загрузке.

И наконец, перезагрузите систему с новым ядром.

== Сравнение текущую конфигурацию ядра с конфигурацией по умолчанию ==

Используйте следующую процедуру, чтобы получить список конфигураций ядра, которые отличаются от значений по умолчанию. Имейте ввиду, что модификация параметров настроек может повлечь за собой изменение других параметров настроек.

{{RootCmd
|cd /usr/src/linux
|cp .config ../.config.working
|make defconfig
|mv .config ../.config.default
|cp ../.config.working .config
|cd ..
|/usr/src/linux/scripts/diffconfig .config.working .config.default > .config.diff
}}

The search function in {{c|make menuconfig}} can be used to look up the symbols and their interpretation.
When you're done, clean up:

{{RootCmd
|cd /usr/src/
|rm .config.working .config.default .config.diff
}}

== See also ==
* [[Genkernel]]
* [[Kernel/Configuration/Kernel_Seeds|Kernel Seeds]]
* [[Kernel/Gentoo Kernel Configuration Guide]]

== Ссылки ==

[[Category:Kernel]]
