This guide introduces the migration of Samba3 to Samba4 with LDAP on Gentoo boxes.

== Pre-requisite ==
* A working samba 3 NT PDC (Must be PDC as it will be '''Promote''' to AD)
* Samba AD DNS Planing
* LDAP Auth Backend Database (Optional)


{{Warning|
Don't not test migration in your production environment, Once a Windows client finds and connects to the new server, it is not possible to go back! the windows client will never talk to your samba 3 server even if you remove/downgrade the samba 4 Server.
So make sure you thoroughly test your migration on a virtual environment and how your clients react before you activate your new server in your production environment! 
}}


== Samba DNS Planing ==
* Moving from samba3 to samba AD is not easy due to the fact that the idea wasn't the same.
* Samba AD required you to have a resolvable DNS.
* MS suggest to use a FQDN as an AD Server as it is easily scalable in future.
* There are some suggestion to use suffixes of .local, .lan .corp but these are bad idea, very bad idea indeed. As we have no understanding what suffixes ICANN will use  in future. And having a DNS with that suffix will conflict with the external DNS.

Thus we would hope that you use the following suggestion.

=== FQDN subdomain DNS setup ===
Example you own "company.com" and it is hosting by your web hosting company.

{| class="wikitable"
|-
! FQDN !! Description
|-
| company.com. || main internet address point to your web server.
|-
| www.company.com. || points to webserver ( Public IP Address, by your web hosting company)
|-
| mail01.company.com.|| points to mail server 1 ( Public IP Address, by your web hosting company )
|-
| mail02.company.com. ||  points to mail Server 2 ( Public IP Address, by your web hosting company )
|-
| smtp1.company.com.|| points to smtp server 1 ( Public IP Address, by your web hosting company )
|-
| smtp2.company.com. || points to smtp server 2 ( Public IP Address, by your web hosting company )
|-
| smtp3.company.com. || points to smtp server 3 ( Public IP Address, by your web hosting company )
|}

Samba AD and internal subdomain DNS setup  

{| class="wikitable"
|-
! FQDN !! Description
|-
| headoffice.location1.company.com. || head office subdomain
|-
| samba4-1.headoffice.location1.company.com. || Samba AD FQDN
|}
in the above example, NETBIOS NAME: HEADOFFICE

'''''So the most important setup.'''''

hostname = samba4-1.headoffice.company.com<br />
AD = headoffice.company.com<br />
REALM = HEADOFFICE.COMPANY.COM<br />
DOMAINNAME ( NT Style )  COMPANY<br />

'''Benefit'''
# A clear cut on internal and external DNS.
# There will not be any conflict between internal and also external DNS.
# In case if there are Branch Site, the Branch AD FQDN can be another subdomain: ''samba4-2.branch_CA.company.com.''
# We can also make the subdomain public if need and that make this design future proof.

== Getting Started with Samba4 ==

=== Getting Samba4 ===
Samba4 is already in portage, however it is still mask and there are some bugs related to it. <br />
A few of them are affecting us. Make the patch in and run your ebuild.
# {{Bug|490872}} Mit-krb5 conflict with hemical issue, resolve using internal hemical library.
# {{Bug|491002}} LDAP Schema Missing after Samba4 install.

The 1st bugs are very important if you cannot remove the dependency of having mit-Krb5 (in most eveny)<br />
Please apply the patch and make your own ebuild.<br />

2nd patch is optional as you can still copy the samba.schema somewhere over the internet.<br />

For more on samba4 bugs please have a look on the bugs tracker below.<br />
{{Bug|489762}} Samba4 unmask bugs tracker.
