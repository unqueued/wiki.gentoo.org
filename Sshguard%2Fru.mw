<languages />

{{InfoBox stack
|{{InfoBox homepage|http://www.sshguard.net/|header=true}}
|{{InfoBox ohloh}}
}}

{{Metadata|abstract=sshguard — это система предотвращения вторжений, которая разбирает логи сервера, определяет подозрительную активность и затем использует системный межсетевой экран, чтобы блокировать IP-адреса злонамеренных подключений.}}

sshguard — это система предотвращения вторжений, которая разбирает логи сервера, определяет подозрительную активность и затем использует системный межсетевой экран, чтобы блокировать IP-адреса злонамеренных подключений. sshguard написан на C, поэтому он не нагружает систему.

== Как это работает ==

sshguard является простой службой, которая постоянно отслеживает изменения в одном или нескольких файлах логов. Она разбирает события, которые демоны посылают в случае неудавшихся попыток входа в систему, а затем с помощью обновлений правил межсетевого экрана блокирует любые дальнейшие попытки от данных подключений.

Несмотря на название, sshguard разбирает не только логи SSH. Он также поддерживает многие почтовые системы, а также некоторые системы FTP. Полный список поддерживаемых устройств можно найти на [http://www.sshguard.net сайте программы].

== Установка ==

=== Emerge ===

Установите {{Package|app-admin/sshguard}}:

{{Emerge|app-admin/sshguard}}

Также удостоверьтесь, что пакет {{Package|net-firewall/iptables}} установлен и используется в качестве системного межсетевого экрана. Во время написания данной статьи, sshguard еще не поддерживал {{Package|net-firewall/nftables}}.

{{Emerge|net-firewall/iptables}}

Более детальная информация по использованию и настройке IPtable может быть найдена в соответствующей [[Iptables|статье]].

== Конфигурация ==

=== Подготовка межсетевого экрана ===

Когда sshguard блокирует какого-либо злонамеренного пользователя (блокируя его IP-адрес), он будет использовать цепочку <tt>sshguard</tt>.

Подготовьте цепочку и удостоверьтесь, что она вызывается при обнаружении новых входящих соединений:

{{RootCmd|iptables -N sshguard
|iptables -A INPUT -j sshguard}}

=== Просмотр лог-файлов ===

Основной идеей sshguard является то, что администратор указывает приложению отслеживаемые файлы логов через параметры командной строки. Как такового файла конфигурации для sshguard не существует.

В Gentoo параметры лучше всего определять в файле {{Path|/etc/conf.d/sshguard}}:

{{FileBox|filename=/etc/conf.d/sshguard|title=Настраиваем sshguard на чтение /var/log/messages|lang=bash|1=
PARDONTIME="3600" # Блокировать на 1 час (3600 секунд)
WATCHTIME="360"   # Отслеживать IP-адрес в течение 5 минут (360 секунд)
THRESHOLD="10"    # Сколько нужно неудачных попыток для срабатывания блокировки
  
LOGFILES="-l /var/log/messages"                      # Следить за этим файлом...
LOGFILES="${LOGFILES} -l /var/log/auth.log"          # И за этим тоже
  
SSHGUARD_OPTS="-p ${PARDONTIME} -s ${WATCHTIME} -a ${THRESHOLD} ${LOGFILES}"
}}

Убедитесь в том, что файлы логов доступны пользователю, от имени которого работает sshguard.

=== Служба ===

Чтобы sshguard запускался при старте системы, добавьте его в уровень запуска default, после чего запустите его:

{{RootCmd|rc-update add sshguard default
|rc-service sshguard start}}


== Устранение проблем ==

=== File '/var/log/auth.log' vanished while adding! ===

При запуске, sshguard показывает следующую ошибку:

{{CodeBox|title=Сообщение об ошибке при попытке добавить монитор для /var/log/auth.log|1=
Sep 23 03:39:11 foo.bar.com sshguard[64933]: File '/var/log/auth.log' vanished while adding!
}}

Такая ошибка (путь до файл может быть различным) происходит, когда целевой файл не доступен в системе. Убедитесь, что он создан, или измените конфигурацию sshguard так, чтобы не следить за этим файлом.

On a syslog-ng system with OpenRC, the following addition to {{Path|syslog-ng.conf}} can suffice:

{{FileBox|filename=/etc/syslog-ng/syslog-ng.conf|title=создание файла auth.log|lang=bash|1=
log { source(src); destination(messages); };
log { source(src); destination(console_all); };
 
destination authlog {file("/var/log/auth.log"); };
filter f_auth { facility(auth); };
filter f_authpriv { facility(auth, authpriv); };
log { source(src);  filter(f_authpriv);  destination(authlog);  };
}}

Перезагрузите, чтобы изменения вступили в силу:

{{RootCmd|rc-service syslog-ng reload}}

== Смотрите также ==

* [[Iptables]], информация по установке и настройке <tt>iptables</tt> в Gentoo

== Ссылки ==

[http://www.sshguard.net/docs/ Документация по sshguard] дает всю необходимую информацию для дальнейшей настройки приложения.


[[Category:Security]]
[[Category:Server]]
