This article [[Article description::describes updating the [[microcode]] for [[AMD]] processors.]]

{{Note|For AMD GPU firmware see the corresponding GPU driver article instead.}}

== Installation ==

=== Firmware ===

Install {{Package|sys-kernel/linux-firmware}}:

{{Emerge|sys-kernel/linux-firmware}}

=== Kernel ===

The following kernel options should be enabled:

{{KernelBox|1=
Processor type and features  --->
    [*] /dev/cpu/microcode - microcode support
    [ ]   Intel microcode patch loading support
    [*]   AMD microcode patch loading support
Device Drivers  --->
    Generic Driver Options 
        (amd-ucode/microcode_amd.bin amd-ucode/microcode_amd_fam15h.bin amd-ucode/microcode_amd_fam16h.bin amd-ucode/microcode_amd_fam17h.bin) External firmware blobs to build into the kernel binary
        (/lib/firmware) Firmware blobs root directory
}}

Now reboot the computer with the new kernel.

You may want to only include the firmware suitable to your CPU family. To find it you can look at <code>/proc/cpuinfo</code>, which gives the decimal number:
<pre>grep -F -m 1 "cpu family" /proc/cpuinfo
cpu family      : 23
</pre>

Now include only the one firmware blob for the given cpu family number:

{| class="table table-condensed table-striped" style="width: auto;"
! scope="col" | Firmware
! scope="col" | Decimal
! scope="col" | Hexadecimal
! scope="col" | Family
! scope="col" | Year
! scope="col" | Examples
|-
| rowspan="4" style="vertical-align:middle;" | {{Path|amd-ucode/microcode_amd.bin}}
| 16
| <code>10h</code>
| K10
| 2007
| Phenom, Phenom&nbsp;II, Athlon&nbsp;II
|-
| 17
| <code>11h</code>
| K11
| 2008
| Athlon&nbsp;X2, Sempron&nbsp;X2, Turion&nbsp;X2
|-
| 18
| <code>12h</code>
| K12, Fusion
| 2009
| A- and E2-Series APU with Radeon&nbsp;HD graphics, Athlon&nbsp;II, Sempron&nbsp;X2
|-
| 20
| <code>14h</code>
| Bobcat
|
|
|-
| {{Path|amd-ucode/microcode_amd_fam15h.bin}}
| 21
| <code>15h</code>
| Bulldozer, Piledriver, Steamroller, Excavator
|
|
|-
| {{Path|amd-ucode/microcode_amd_fam16h.bin}}
| 22
| <code>16h</code>
| Jaguar, Puma
|
|
|-
| style="white-space: nowrap;" | {{Path|amd-ucode/microcode_amd_fam17h.bin}}
| 23
| <code>17h</code>
| Zen
| 2017
| Ryzen <nowiki>3|5|7</nowiki>, Threadripper
|}

=== Verification ===

{{Cmd|dmesg {{!}} grep microcode|output=<pre>
[    0.584603] microcode: microcode: updated early to new patch_level=0x06000832
[    0.868036] microcode: CPU0: patch_level=0x06000832
[    0.868116] microcode: CPU1: patch_level=0x06000832
[    0.868196] microcode: CPU2: patch_level=0x06000832
[    0.868277] microcode: CPU3: patch_level=0x06000832
[    0.868360] microcode: CPU4: patch_level=0x06000832
[    0.868451] microcode: CPU5: patch_level=0x06000832
[    0.868538] microcode: CPU6: patch_level=0x06000832
[    0.868619] microcode: CPU7: patch_level=0x06000832
[    0.868718] microcode: Microcode Update Driver: v2.01 <tigran@aivazian.fsnet.co.uk>, Peter Oruba
</pre>}}
=== Initrd ===
You can load the microcode with the initrd. To do this you need {{Package|sys-kernel/linux-firmware}}.
First create the specified directory and cd into it. It doesn't have to be in {{Path|/tmp}} but the {{Path|kernel/x86/microcode}} part
is neccesary.
{{Cmd|mkdir -p /tmp/amd-ucode/kernel/x86/microcode|cd /tmp/amd-ucode}}
Then we concatenate the AMD microcode files into a single file. As before the path and filename of the output file must
not be altered.
{{Cmd|cat /lib64/firmware/amd-ucode/microcode_amd*.bin > kernel/x86/microcode/AuthenticAMD.bin}}
Then we will create a cpio archive in {{Path|/boot/amd-uc.img}}
{{RootCmd|echo kernel/x86/microcode/AuthenticAMD.bin &#x7C; bsdcpio -o -H newc -R 0:0 > /boot/amd-uc.img}}

You then need to regenerate your grub config.

{{RootCmd|1=grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Found linux image: /boot/vmlinuz-4.18.12
Found initrd image: /boot/amd-uc.img /boot/initramfs-4.18.12.img</pre>}}

It should show that it found {{Path|/boot/amd-uc.img}}.
[[Category:Processors]]
