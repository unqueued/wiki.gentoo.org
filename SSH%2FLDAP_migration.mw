{{Warning|'''Work still in progress.'''}}

== Why migrate? ==

Originally, Gentoo used [https://code.google.com/archive/p/openssh-lpk/ OpenSSH LDAP public key patch (OpenSSH-LPK patch set)] from Eric Auge. However, this patch is dead and doesn't work anymore with OpenSSH 7.7 or newer because ''auth_parse_options()'' function was removed in OpenSSH via [https://github.com/openssh/openssh-portable/commit/7c856857607112a3dfe6414696bf4c7ab7fb0cb3 commit 7c856857607112a3dfe6414696bf4c7ab7fb0cb3].

Since the creation of the OpenSSH-LPK patch set, OpenSSH has changed a lot. With the release of [https://www.openssh.com/txt/release-6.2 OpenSSH 6.2_p1] in 2013-03-22, a new sshd option called "''AuthorizedKeysCommand''" was implemented which supports fetching ''authorized_keys'' from a command in addition to (or instead of) from the filesystem. Thanks to this feature, we no longer need to patch OpenSSH itself. Instead we can move LDAP lookup into an own package which is developed and maintained independently of OpenSSH.

In Gentoo we added {{Package|sys-auth/ssh-ldap-pubkey}} package which will provides a wrapper which can be used by "''AuthorizedKeysCommand''" option and also provides tools to manage keys in LDAP.

== How to migrate ==

=== Step 1: Install wrapper of your choice ===

{{Note|As of today (2018-08-03) we only have one suitable wrapper in the official Gentoo repository available.}}

{{Emerge|sys-auth/ssh-ldap-pubkey}}

=== Step 2: Update ldap.conf ===

Compare the existing {{path|ldap.conf}} file against {{Path|ldap.conf}} provided by the wrapper and update the configuration in case something is missing or needs updated:

{{Cmd|diff -u  diff -u /etc/openldap/ldap.conf /usr/share/ssh-ldap-pubkey/examples/ldap.conf}}

=== Step 3: Verify that your configuration is working ===

If the current user has keys stored in LDAP, run:

{{Cmd|ssh-ldap-pubkey list}}

Or, to verify that the current user or Larry's keys are available like expected, run:

{{Cmd|ssh-ldap-pubkey list -u larry}}

{{Warning|'''If these commands don't retrieve any keys, you need to check the LDAP configuration before proceeding!'''}}

=== Step 4: Update OpenSSH configuration ===

Now you need to update your sshd's configuration so that it will use the new wrapper to fetch ''authorized_keys'' from LDAP.

{{rootCmd|nano /etc/ssh/sshd_config}}

Add the following line somewhere:

{{FileBox|filename=/etc/ssh/sshd_config|1=
    AuthorizedKeysCommand /usr/bin/ssh-ldap-pubkey-wrapper
}}

=== Step 5: Restart sshd ===

As last step don't forget to restart the ssh daemon so that the updated configuration will be used.

With OpenRC:

{{rootCmd|/etc/init.d/sshd restart}}

With systemd:

{{rootCmd|systemctl restart sshd.service}}
