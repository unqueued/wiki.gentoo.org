<languages />

<div class="mw-translate-fuzzy">
{{Metadata|abstract=Cet article explique comment passer à une nouvelle version du noyau.}}
</div>

<div class="mw-translate-fuzzy">
Cet article décrit les différentes étapes de la mise à jour vers un nouveau [[kernel/fr|noyau]].
</div>

<div class="mw-translate-fuzzy">
== Installation ==
</div>

<div class="mw-translate-fuzzy">
Une mise à jour du noyau peut être nécessaire lorsque les nouvelles sources du noyau sont installées suite à une mise à jour du système où lorsque vous installez vous-même les nouvelles sources.
</div>

{{RootCmd|emerge --ask --update --deep --with-bdeps{{=}}y --newuse @world}}

Of course, they can be installed directly using the next command (replace ''gentoo-sources'' with whatever version of the kernel that is in-use):

{{RootCmd|emerge --ask --update --deep --with-bdeps{{=}}y --newuse sys-kernel/gentoo-sources}}

Installing new kernel sources doesn't provide the user with a new kernel. It is necessary to make and install a new kernel from the new sources and then reboot the system to actually run the new kernel.

Making a new kernel from the new sources is basically the same process as making a kernel when installing the system. The difference is that one can use the configuration of the old kernel to create a configuration for the new kernel. Using the old configuration saves the user from going through all the kernel options (like {{c|make menuconfig}}) again.

The kernel configuration is saved in a file named {{Path|.config}} in the directory that holds the kernel sources. A new kernel may have had options or features added or removed since the old kernel. The kernel configuration specifies whether a kernel's features and options will be enabled or not, perhaps built into the kernel, or perhaps built as modules which can be loaded into the running kernel on demand. Hence the configuration file of the new kernel may have new entries the configuration file of the old kernel doesn't have, and it might not have entries anymore which are present in the configuration file of the old kernel.

To deal with such changes of the configuration file, the configuration file of the old kernel needs to be converted to a configuration that can be used with the new kernel. This article shows how to make a new kernel from new kernel sources with converting the configuration file of the old kernel.

=== Backup the current kernel configuration ===

It is wise to make a backup of the kernel configuration so that the previous configurations are not lost. After all, many users devote considerable time to figure out the best configuration for the system, and losing that information is definitely not wanted.

It is easy to make a backup of the current kernel configuration:

<div class="mw-translate-fuzzy">
{{RootCmd|cd /usr/src/linux
|cp .config ~/kernel-config-`uname -r`|}}
</div>

Provided that the symlink to the kernel sources has been set correctly, this copies the configuration of the currently used kernel to the home directory of root, renaming the configuration to {{Path|kernel-config-}} followed by the version of the current running Linux kernel.

== Configuration ==

=== Set symlink to new kernel sources ===

<div class="mw-translate-fuzzy">
Le lien symbolique {{Path|/usr/src/linux}} devrait toujours pointer sur les sources du noyau en cours d'utilisation. Il y a trois manières d'arriver à ce résultat :
</div>

# Installing the kernel sources with <code>USE="symlink"</code>
# Setting the link with eselect
# Manually updating the symbolic link

==== Installing the kernel sources with the symlink USE flag ====

This will make the {{Path|/usr/src/linux}} point to the newly installed kernel sources.

If necessary, it can still be modified later with one of the other two methods.

==== Setting the link with eselect ====

To set the symlink with {{c|eselect}}:

{{RootCmd|eselect kernel list|output=<pre>
Available kernel symlink targets:
 [1] linux-3.14.14-gentoo *
 [2] linux-3.16.3-gentoo
</pre>}}

This outputs the available kernel sources. The asterisk indicates the chosen sources.

To change the kernel sources, e.g. to the second entry, do:

{{RootCmd|eselect kernel set 2}}

==== Manually updating the symbolic link ====

To set the symbolic link manually:

{{RootCmd|ln -sf /usr/src/linux-3.16.3-gentoo /usr/src/linux
|ls -l /usr/src/linux|output=<pre>
lrwxrwxrwx 1 root root 19 Oct  4 10:21 /usr/src/linux -> linux-3.16.3-gentoo
</pre>}}

==== Moving to the new folder ====

Now that the symbolic link has been modified, change the working directory to the new kernel folder.

{{RootCmd|cd /usr/src/linux}}

{{Note|This command is still necessary even if the working directory was already {{Path|/usr/src/linux}} when the symlink was modified. Until the new symlink is actually followed, the console will still be in the ''old'' kernel's directory.}}

=== Copy previous kernel configuration ===

The configuration of the old kernel needs to be copied to the new one. In addition to the backup copy that was saved to {{Path|/root}} in an earlier step, the old configuration can be found in several places:

<div class="mw-translate-fuzzy">
* Dans le système de fichier [[procfs]], si l'option''Enable access to .config through /proc/config.gz'' du noyau était activée pour le noyau en service :
</div>

* From the old kernel. This will only work when the old kernel was compiled with CONFIG_IKCONFIG:
: {{RootCmd|/usr/src/linux/scripts/extract-ikconfig /path/to/old/kernel >/usr/src/linux/.config}}

<div class="mw-translate-fuzzy">
* Dans le répertoire {{Path|/boot}}, si c'est là que vous avez installé le fichier de configuration :
</div>

<div class="mw-translate-fuzzy">
* Dans le répertoire  kernel du noyau actuellement en service :
</div>

* In the {{Path|/etc/kernels/}} directory, if <code>SAVE_CONFIG="yes"</code> is set in {{Path|/etc/genkernel.conf}} and {{c|[[genkernel]]}} was previously used:
: {{RootCmd|cp /etc/kernels/kernel-config-x86_64-3.14.14-gentoo /usr/src/linux/.config}}

=== .config file ===

To use the configuration of the old kernel with the new kernel, it needs to be converted.  The conversion can be done by running either {{c|make silentoldconfig}} or {{c|make olddefconfig}}. Use either, not both.

==== make silentoldconfig ====

{{Important|{{c|make silentoldconfig}} is being removed as of linux version 4.19, it will be replaced by {{c|make syncconfig}}.}}

The following configuration is like the text based configuration with {{c|make config}}.  For new configuration options, the user is asked for a decision. For example:

{{RootCmd|cd /usr/src/linux
|make silentoldconfig|output=<pre>
Anticipatory I/O scheduler (IOSCHED_AS) [Y/n/m/?] (NEW)
</pre>}}

The string ''(NEW)'' at the end of the line marks this option as new. Left to the string in square brackets are the possible answers: ''Y''es, ''n''o, ''m''odule or ''?'' to show the help. The recommend (i.e. default) answer is capitalized (here ''Y''). The help explains the option or driver.

Unfortunately {{c|make silentoldconfig}} doesn't show a lot more information for each option, such as the context, so it is sometimes difficult to give the right answer. In this case the best way to go is to remember the option name and revise it afterwards through one of the [[Kernel/Configuration#Configuration tools|graphical kernel configuration tools]].

==== make olddefconfig ====

If all new configuration options should be set to their recommended (i.e. default) values use {{c|make olddefconfig}}:

{{RootCmd|cd /usr/src/linux
|make olddefconfig}}

==== make help ====

Use {{c|make help}} to see other conversion methods available:

{{RootCmd|make help}}

== Compilation/construction ==

{{Important|When external kernel modules are installed (like nvidia or zfs), it may be necessary to run {{c|make modules_prepare}} as described [[Kernel/Upgrade#Reinstalling external kernel modules|below]] before building the kernel. Some modules cannot be installed or prepared before the kernel has been built.}}

{{Important|Do not forget to reconfigure the [[Bootloader|bootloader]] to account for the new kernel filenames, and rebuild the initramfs if one is used as well.}}

Pour cette étape, suivez les étapes de l'article [[Kernel/Configuration/fr#Compilation/construction|configuration manuelle]]

=== Automated build and installation ===

It is possible to automatically build and install the newly emerged kernel using Portage hooks. While other approaches are also possible, the following is based on genkernel and gentoo-sources package. It requires the following prerequisites:

# {{c|genkernel all}} is able to build and install the kernel to which the {{Path|/usr/src/linux}} symlink points into <code>$BOOTDIR</code> and the bootloader.
# The <code>symlink</code> use flag is set for the kernel ebuild.

If those are fulfilled, simply install a <code>post_pkg_postinst</code> Portage hook as shown below.

{{FileBox|title=Automated kernel build and installation portage hook|filename=/etc/portage/env/sys-kernel/gentoo-sources|lang=bash|1=post_pkg_postinst() {
	CURRENT_KV=$(uname -r)
	# Check to see if genkernel has been run previously for the running kernel and use that config
	if [[ -f "${EROOT}/etc/kernels/kernel-config-${CURRENT_KV}" ]] ; then
		genkernel --kernel-config="${EROOT}/etc/kernels/kernel-config-${CURRENT_KV}" all
	elif [[ -f "${EROOT}/usr/src/linux-${CURRENT_KV}/.config" ]] ; then # Use latest kernel config from current kernel
		genkernel --kernel-config="${EROOT}/usr/src/linux-${CURRENT_KV}/.config" all
	elif [[ -f /proc/config.gz ]] ; then # Use known running good kernel
		zcat /proc/config.gz >> "${EROOT}/tmp/genkernel.config"
		genkernel --kernel-config="${EROOT}/tmp/genkernel.config" all
		rm "${EROOT}/tmp/genkernel.config"
	else # No valid configs known
		genkernel all
	fi
}
}}

<div class="mw-translate-fuzzy">
== Réinstaller les modules externes du noyau ==
</div>

{{Note|The modules_prepare step is not required if building an entire kernel as this function is done as part of the standard process.}}

Tout module externe du noyau tel que [[:Category:Binary kernel modules| modules binaires du noyau]], doit être recompilé pour chacun des nouveaux noyau. Si le noyau n'a pas encore été recompilé, il doit d'abord être préparé pour la compilation des modules externes :

{{RootCmd|make modules_prepare}}

<div class="mw-translate-fuzzy">
Vous pouvez recompiler les paquets en utilisant le jeu ''@module-rebuild'' :
</div>

{{Emerge|@module-rebuild}}

=== Solving build problems ===

<div class="mw-translate-fuzzy">
Si vous rencontrez des problèmes de compilation en recompilant le noyau courant, il peut être utile d'assainir les sources du noyau. Faites une sauvegarde préalable du fichier {{Path|.config}} car il sera retiré lors de l'opération.
</div>

<div class="mw-translate-fuzzy">
{{RootCmd|cp .config .config~
|make distclean
|mv .config~ .config}}
</div>

<div class="mw-translate-fuzzy">
== Suppression des anciens noyaux ==
</div>

Reportez-vous à l'article  [[Kernel/Removal/fr|Noyau/Suppression]] 

== See also ==

* {{See also|Genkernel}}

== Ressources externes ==

<div class="mw-translate-fuzzy">
* [http://kernelnewbies.org/LinuxChanges kernel changelog with some explanations of new features](en anglais)
</div>

[[Category:Kernel]]
