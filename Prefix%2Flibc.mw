This is a project to support libc inside a [[Project:Prefix|Prefix]], so called "RAP" (Rap Ain't Prefix). See also [[Project:Android]]. A general use case is for Prefix on RHEL 5 (CentOS 5 ans SL 5), where the host glibc-2.5 is too old to support modern features as fortify ({{Bug|289757}}).

Classical Prefix is based on rpath. The differences are summerized in this table.

{| class="wikitable" style="text-align: center"
!
! Prefix-rpath
! Prefix/libc (sysroot method, official)
! Prefix/libc (native paths method, experimental)
|-
| feature name || prefix-rpath || prefix-standalone || ||
|-
| linux profile || prefix/linux || prefix/linux-standalone || ||
|-
| linux keyword || ~ARCH-linux || ARCH ~ARCH || ||
|-
| portage tree || [https://gitweb.gentoo.org/repo/proj/prefix.git prefix.git] || [https://gitweb.gentoo.org/repo/gentoo.git/ gentoo.git] overlaied with [https://gitweb.gentoo.org/proj/android.git/ android.git] || ||
|-
| {{Package|sys-devel/gcc}} || || EXTRA_ECONF+=(--with-sysroot=$EPREFIX) but donot pass --sysroot to ld, prefix dynamic loader || change NATIVE_SYSTEM_HEADER_DIR, STANDARD_STARTFILE_PREFIX, prefix dynamic loader
|-
| {{Package|sys-devel/binutils}} || || Prefix NATIVE_LIB_DIRS || --with-lib-path=${EPREFIX}/usr/lib:${EPREFIX}/lib
|-
| {{Package|sys-devel/binutils-config}} || inject -rpath and -R ||  ||
|-
| {{Package|sys-libs/glibc}} || {{No}} || {{Yes}} Prefix hardcoded /etc,/usr,/var,/bin || {{Yes}}
|}

{{Note|nss is part of glibc, which resolves uid/gid. If your user is in LDAP, be sure to set up nss_ldap against glibc in new Prefix. Host nss_ldap library may be too old to be loaded by new glibc. Failure of interpreting uid/gid may result in disfunctional portage.}}

== Bootstrap Script ==

Download the Gentoo RAP [http://dev.gentoo.org/~heroxbd/bootstrap-rap.sh bootstrap-rap.sh]. You can use various ways to obtain the script and get it to a place where you can execute it. Once in position, preform the following commands:
{{Cmd| chmod 755 bootstrap-rap.sh | ./bootstrap-rap.sh | output=<pre>
(follow the instructions)</pre>
}}

That's all! The script will guide you through the full process, and tells you how to start your freshly bootstrapped Gentoo RAP system if it successfully runs up till the end. In normal cases, you don't need any more than just this.

== Tested Distributions ==
Although having further possibilities, RAP supports Linux distributions only.  The following tables tracks the tested distributions with the script.

{| class="wikitable" style="text-align: center"
! Distribution 
! Version
! linux
! ARCH
! glibc
! gcc
! binutils
! Tester
! Works?
! ARCH of RAP
|-
| Debian || sid || amd64 || 4.3.0 || 2.22 || 5.3.1 || 2.26 || [[User:heroxbd|heroxbd]] || {{Yes}} || amd64
|-
| RHEL || 6.4 || amd64 || 2.6.32 || 2.12 || 4.4.7 || 2.20.51 || [[User:heroxbd|heroxbd]] || {{Yes}} || amd64 
|-
| CentOS || 6.8 || amd64 || 2.6.32 || 2.12 || 4.4.7 || 2.20.51 || [[User:heroxbd|heroxbd]] || {{Yes}} || amd64
|-
| Ubuntu || 14.04 || amd64 || 3.13 || 2.19 || 4.8.4 || 2.24 || [[User:heroxbd|heroxbd]] || {{Yes}} || amd64
|-
| RHEL || 5.10 || amd64 || 2.6.18 || 2.5 || 4.1.2 || 2.17.50 || [[User:heroxbd|heroxbd]] || {{Yes}} || amd64
|}

== Tips ==
=== Compile Inside Memory ===
On a cluster node with large memory and shared network filesystem, compiling in a memory tmpfs can be significantly faster.  /dev/shm is mounted as tmpfs by many distributions. For example:
{{FileBox|filename=EPREFIX/etc/portage/make.conf|1=
PORTAGE_TMPDIR=/dev/shm
}}
Before calling bootstrap-rap.sh, it can be done with
{{Cmd|export PORTAGE_TMPDIR{{=}}/dev/shm}}

== FAQ ==
=== In stage3, why should binutils be installed before glibc? ===
glibc has strict version dependence on binutils. Otherwise we get this error:
{{FileBox|filename=config.log|1=
configure:4896: checking for nm
configure:4912: found /usr/bin/nm
configure:4923: result: nm
configure:5016: error: 
*** These critical programs are missing or too old: as ld
*** Check the INSTALL file for required versions.
}}

=== Why is there no binutils installed in stage2? ===
Debian multiarch gcc require binutils to support sysroot.  By default, binutils of gentoo is not built with sysroot.

== Trouble Shooting ==
RAP is expected to run on a wild variety of environments.  Let's document here the problems met during the bootstrap and the solutions made.
It is very funny to see how many host systems are badly crewed.
=== /bin/tar exists but does not work. The working one is in /usr/local/bin ===
{{Cmd|/bin/tar|strace /bin/tar|output=<pre>
bash: /bin/tar: Permission denied
execve("/bin/tar", ["/bin/tar"], [/* 142 vars */]) = -1 EACCES (Permission denied)</pre>}}

Solution: edit the script to prepend /usr/local/bin to PATH.

{{FileBox|filename=bootstrap-rap.sh|1=
        # the standard path we want to start with, override anything from
        # the user on purpose
-       PATH="/usr/bin:/bin"
+       PATH="/usr/local/bin:/usr/bin:bin"
}}

=== Kernel Version Too Low ===
>=glibc-2.20 requires >=linux-2.6.32.  Bootstrapping on old kernels results in
{{Cmd|./bootstrap-rap.sh|output=<pre>
...
 * You need a kernel of at least 2.6.32 for NPTL support!
 * ERROR: sys-libs/glibc-2.23-r2::rap failed (unpack phase):
 *   Kernel version too low!
...</pre>}}
Versions of glibc should be masked:
{{FileBox|filename=EPREFIX/etc/portage/package.mask|1=
# glibc-2.20 requires linux >=2.6.32
>=sys-libs/glibc-2.20
}}

In addition, for RHEL 5 having linux-2.6.18, linux-headers should also be masked:
{{FileBox|filename=EPREFIX/etc/portage/package.mask|1=
# correspond to RHEL 5.10 having linux-2.6.18
# but glibc-2.19 needs >=linux-headers-2.6.19  in configure
# sys-libs/glibc-2.19 needs IFLA_RTA in linux/rtnetlink.h, line 450
# utimensat was first introduced in linux-2.6.22.
>sys-kernel/linux-headers-2.6.20

>=app-misc/pax-utils-1.1
}}
where {{Package|app-misc/pax-utils}} requires the linux/securebits.h header, not available until linux-headers-3.9.

Plus, seccomp requires linux-headers>=4.3:
{{FileBox|filename=EPREFIX/etc/portage/package.use|1=
app-misc/pax-utils -seccomp
}}

== See Also ==
A similar project, [http://sourceforge.net/projects/gentooandroid/ Gentoo On Unrooted Android]
