This guide will show you how to upgrade Gentoo/FreeBSD 10.3 from previous version.

{{Note|This guide is targeted to version 9.0 or higher.}}

If you want to upgrade to 11.0, please see [[Gentoo FreeBSD/Upgrade Guide/11.0]].
{{Important|You can not upgrade directly to 11.0 from 9.x. After upgrading to 10.3, you will be able to upgrade to 11.0.}}

__TOC__

== Preparation ==

=== Changing to the latest profile ===

It is necessary to change the [[profile]] to emerge packages related to FreeBSD 11.1.

Get a list of available profiles:

{{RootCmd|eselect profile list|output=
<pre>
Available profile symlink targets:
  [1]   default/bsd/fbsd/amd64/9.1 *
  [2]   default/bsd/fbsd/amd64/11.1
  [3]   default/bsd/fbsd/amd64/9.1/clang
  [4]   default/bsd/fbsd/amd64/11.1/clang
</pre>}}

Set the profile to 11.1:

{{RootCmd|eselect profile set 2}}

=== Updating sys-apps/portage with a manual method. ===
{{Important|Don't forget to add --exclude sys-freebsd/* option until you update sys-freebsd packages. It will avoid the issue that sys-freebsd packages are masked by profile.}}

If you are using the too old version of portage, {{Package|sys-apps/portage}} should be updated. Let's check:

{{RootCmd|emerge -pu sys-apps/portage --exclude sys-freebsd/*|output=
<pre>
<snip>
The current version of portage supports EAPI '5'. You must upgrade to a
newer version of portage before EAPI masked packages can be installed.
<snip>
</pre>}}

If you got the above messages, please update it with a manual method:

{{RootCmd
|cd /tmp
|wget https://dev.gentoo.org/~dolsen/releases/portage/portage-2.3.6.tar.bz2
|tar xjf portage-2.3.6.tar.bz2
|PYTHON_TARGETS{{=}}"python2_7" portage-2.3.6/bin/emerge --nodeps dev-lang/python-exec
|eselect python set python2.7
|PYTHON_TARGETS{{=}}"python2_7" portage-2.3.6/bin/emerge --nodeps sys-apps/portage
}}

=== Moving {{Path|/etc/make.conf}} ===

Currently, {{Path|/etc/make.conf}} has been moved to {{Path|/etc/portage/make.conf}}. If it exists in {{Path|/etc}}, please move it to the {{Path|/etc/portage/}} location.

In addition, don't forget to remove LDFLAGS from {{Path|make.conf}}. If it is set, the upgrade may fail.

{{RootCmd
|mkdir -p /etc/portage
|if [ -e /etc/make.conf ] && [ ! -e /etc/portage/make.conf ] ; then
|mv /etc/make.conf /etc/portage/make.conf
|fi
|gsed -i '/LDFLAGS{{=}}/d' /etc/portage/make.conf}}

=== Updating some of the packages to continue the upgrade ===
You need to update some of the packages to continue the upgrade:

{{RootCmd
|emerge -u sys-apps/findutils --exclude sys-freebsd/*
|emerge sys-devel/libtool --exclude sys-freebsd/*
|USE{{=}}"-acl" emerge -u app-arch/libarchive --exclude sys-freebsd/*
|emerge -u sys-devel/flex sys-devel/patch sys-devel/m4 net-libs/libpcap sys-devel/gettext dev-util/dialog sys-libs/zlib --exclude sys-freebsd/*
}}

== Updating toolchain ==
{{Important|binutils-2.28 or later version and gcc-5.0 or later version doesn't work correctly on Gentoo/FreeBSD 9.x. Don't forget to specify the version.}}

A newer version of binutils and gcc are required:

{{RootCmd
|<nowiki>[[ ! -e /etc/portage/package.unmask ]]</nowiki> && mkdir -p /etc/portage/package.unmask
|echo "sys-devel/binutils" > /etc/portage/package.unmask/toolchain-oldversion
|echo "sys-devel/gcc" >> /etc/portage/package.unmask/toolchain-oldversion
|emerge -u '<sys-devel/binutils-2.28' --exclude sys-freebsd/*
|emerge -u sys-devel/gcc-config --exclude sys-freebsd/*
|emerge -u '<sys-devel/gcc-5.0' --exclude sys-freebsd/*
}}

Set the newer version of gcc:

{{RootCmd|gcc-config -l
|output=
<pre>
 [1] x86_64-gentoo-freebsd9.1-4.6.4 *
 [2] x86_64-gentoo-freebsd9.1-4.9.4
</pre>}}

{{RootCmd
|gcc-config 2
|. /etc/profile
}}

== Updating config and make ==
Latest version of config and make are required to continue upgrading:

{{RootCmd
|cd /usr/portage/sys-freebsd/freebsd-ubin && ebuild freebsd-ubin-11.1.ebuild prepare
|cd /var/tmp/portage/sys-freebsd/freebsd-ubin-11.1/work/usr.bin/bmake
|make
|cp -a make /usr/local/bin/
|cd /usr/portage/sys-freebsd/freebsd-ubin && ebuild freebsd-ubin-11.1.ebuild clean
|env-update
|source /etc/profile
}}

{{RootCmd
|emerge -u sys-freebsd/freebsd-mk-defs
|cd /usr/portage/sys-freebsd/freebsd-usbin && ebuild freebsd-usbin-11.1.ebuild prepare
|cd /var/tmp/portage/sys-freebsd/freebsd-usbin-11.1/work/usr.sbin/config
|make -m /usr/share/mk/system
|cp -a config /usr/local/sbin/
|cd /usr/portage/sys-freebsd/freebsd-usbin && ebuild freebsd-usbin-11.1.ebuild clean
}}

== Updating kernel ==

First of all, you need to update your kernel. That is because some userland packages may require functions of the new kernel.

Please be sure to update the kernel first:

{{RootCmd
|emerge -C sys-freebsd/freebsd-sources
|emerge -u sys-freebsd/freebsd-sources
}}

=== Failed to compile the kernel ===

If it fails to compile, please get the GENERIC kernel of FreeBSD instead. If you are using x86-fbsd, please replace the amd64 to i386 in URL.

{{Important|Don't forget to rebuild the kernel after updating FreeBSD userland!}}

{{RootCmd
|wget -P /tmp http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/11.1-RELEASE/base.txz
|wget -P /tmp http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/11.1-RELEASE/kernel.txz
|mv /boot /boot.orig
|cd /
|tar xvJf /tmp/base.txz ./boot
|tar xvJf /tmp/kernel.txz
}}

=== Reboot ===

Don't have any problem? Let's restart to actually use the new kernel:

{{RootCmd|shutdown -r now}}

After rebooting your machine, please check if the upgrade was successful. 

{{RootCmd|uname -a|output=
<pre>FreeBSD daemon 11.1_p2-Gentoo FreeBSD Gentoo 11.1_p2 #0: Sat Dec 30 15:00:01 Local time zone must be set--see zic manual page 2017     root@daemon:/var/tmp/portage/sys-freebsd/freebsd-sources-11.1_p2/work/sys/amd64/compile/GENTOO  amd64</pre>}}

== Updating FreeBSD userland ==

First emerge the core library:

{{RootCmd
|emerge -C dev-libs/libelf dev-libs/libexecinfo dev-libs/libiconv
|emerge binutils
|emerge --nodeps sys-freebsd/freebsd-libexec
|CC{{=}}gcc CXX{{=}}g++ CXXFLAGS{{=}}"-O2 -pipe" USE{{=}}build MAKEOPTS{{=}}"-j1" emerge --nodeps sys-freebsd/freebsd-lib sys-freebsd/freebsd-share
|<nowiki>[[ -e /etc/portage/profile/package.use.mask ]] && gsed -i '/sys-freebsd\/freebsd-libexec abi_x86_32/d' /etc/portage/profile/package.use.mask</nowiki>}}

Update the userland of FreeBSD:

{{RootCmd
|emerge -C sys-process/fuser-bsd
|CC{{=}}gcc CXX{{=}}g++ CXXFLAGS{{=}}"-O2 -pipe" emerge -auN boot0 freebsd-bin freebsd-lib freebsd-libexec freebsd-mk-defs freebsd-pam-modules freebsd-sbin freebsd-share freebsd-ubin freebsd-usbin
}}

Please emerge the sys-freebsd packages again. Some of the packages are in need of include files of 10.3, which they couldn't use during the previous upgrade. 

{{RootCmd|emerge boot0 freebsd-bin freebsd-lib freebsd-libexec freebsd-mk-defs freebsd-pam-modules freebsd-sbin freebsd-share freebsd-ubin freebsd-usbin}}

Clean, utmp related files:

{{RootCmd|rm /var/run/utmp /var/log/lastlog /var/log/wtmp*}}

== Changing the CHOST variable and rebuilding the toolchain ==

{{Note|You can skip this step if you are performing a minor upgrade (e.g. upgrading 10.2 to 10.3 once it's released)}}

Change the CHOST variable, and emerge binutils&gcc. (FYI, [[Changing the CHOST variable|Changing the CHOST variable]])

x86-fbsd users should issue:

{{RootCmd|<nowiki>gsed -i 's:CHOST=.*:CHOST="i686-gentoo-freebsd10.3":g' /etc/portage/make.conf</nowiki>}}

amd64-fbsd users should issue:

{{RootCmd|<nowiki>gsed -i 's:CHOST=.*:CHOST="x86_64-gentoo-freebsd10.3":g' /etc/portage/make.conf</nowiki>}}

Emerge binutils and gcc:

{{Emerge|sys-devel/binutils sys-devel/gcc|params=--oneshot}}

Check gcc's 9.x stuff:

{{RootCmd|gcc-config -l|output=
<pre>  [1] i686-gentoo-freebsd10.3-4.8.4 *
 * broken config file: /etc/env.d/gcc/i686-gentoo-freebsd9.0-4.5.3
 [2] i686-gentoo-freebsd9.0-4.5.3
</pre>}}

Remove 9.x stuff:

{{RootCmd|emerge -C '&lt;gcc-4.6'}}

{{RootCmd|gcc-config -c|output=
i686-gentoo-freebsd10.3-4.8.4}}

Also check binutils:

{{RootCmd|binutils-config -l|output=
<pre>  [1] i686-gentoo-freebsd10.3-2.25 *
</pre>}}

{{RootCmd|binutils-config -c|output=
i686-gentoo-freebsd10.3-2.25}}

Remove FreeBSD 9.x env data:

{{RootCmd
|cd /etc/env.d/
|grep gentoo-freebsd9. *|output=
<pre>
04gcc-i686-gentoo-freebsd9.0:PATH="/usr/i686-gentoo-freebsd9.0/gcc-bin/4.8.4"
04gcc-i686-gentoo-freebsd9.0:ROOTPATH="/usr/i686-gentoo-freebsd9.0/gcc-bin/4.8.4"
04gcc-i686-gentoo-freebsd9.0:MANPATH="/usr/share/gcc-data/i686-gentoo-freebsd9.0/4.8.4/man"
04gcc-i686-gentoo-freebsd9.0:INFOPATH="/usr/share/gcc-data/i686-gentoo-freebsd9.0/4.8.4/info"
04gcc-i686-gentoo-freebsd9.0:LDPATH="/usr/lib/gcc/i686-gentoo-freebsd9.0/4.8.4
04gcc-i686-gentoo-freebsd9.0:/usr/lib/gcc/i686-gentoo-freebsd9.0/4.5.3"
</pre>}}

The target file name is {{Path|04gcc-i686-gentoo-freebsd9.0}} in this case.

{{RootCmd
|rm 04gcc-i686-gentoo-freebsd9.0
|env-update &amp;&amp; source /etc/profile
}}

Rebuild all packages.

{{RootCmd
|emerge --oneshot sys-devel/libtool
|emerge -ae @world --exclude sys-apps/portage
|emerge sys-apps/portage
}}

If one of the packages fails to compile you can issue 'emerge --resume --skipfirst' to continue emerging the remaining packages. Also, consider filing a bug report of the problem.

== Cleaning ==

Let's remove the backup files when you have finished all the steps:

{{Important|Do not forget to run <tt>dispatch-conf</tt>!}}

{{RootCmd
|emerge sys-devel/libtool app-admin/eselect
|emerge @preserved-rebuild
|dispatch-conf
}}

== Re-select profile ==

Please re-select the profile if {{Path|make.profile}} exists in {{Path|/etc}}.

{{RootCmd|ls -l /etc/make.profile|output=
<pre>
lrwxr-xr-x  1 root  portage  48 Dec  1 00:00 /etc/make.profile -> ../usr/portage/profiles/default/bsd/fbsd/x86/9.1
</pre>}}

{{RootCmd
|rm /etc/make.profile
|eselect profile list
|output=<pre>
Available profile symlink targets:
  [1]   default/bsd/fbsd/x86/9.0
  [2]   default/bsd/fbsd/x86/9.1
</pre>}}

{{RootCmd|eselect profile set 2}}

== Sample script to update automatically ==

You can get the sample script for easy updates.

https://gitweb.gentoo.org/proj/gentoo-bsd.git/plain/scripts/automatic_updater.sh

{| class="table"
|-
| Argument 1 || TARGETVER, support 10.3.
|-
| Argument 2 || kernel, freebsd_userland, world
|}

=== How to use script ===

{{RootCmd
|bash automatic_updater.sh 10.3 kernel
|shutdown -r now
|bash automatic_updater.sh 10.3 freebsd_userland
|bash automatic_updater.sh 10.3 world
}}

== See also ==

* [[Gentoo FreeBSD/Upgrade Guide/11.0]]
* [[Gentoo FreeBSD]]
