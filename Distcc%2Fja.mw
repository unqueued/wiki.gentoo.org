<languages />

{{Metadata|abstract=Distcc は、ネットワーク越しの複数のホストにコンパイル作業を分散させられるようにするためのプログラムです。一つのサーバ（distccd）と一つのクライアントプログラム（distcc）からなっています。また、ちょっとした設定をすれば distcc は ccache, Portage, Automake などとうまく連携することができます。}}

{{InfoBox stack
|{{InfoBox homepage|https://code.google.com/p/distcc/|header=true}}
|{{InfoBox wikipedia}}
|{{InfoBox github|distcc/distcc}}
}}

[https://code.google.com/p/distcc/ Distcc]はネットワーク上のホストで分散コンパイルを行うためのプログラムで、サーバー側である{{c|distccd}}とクライアント側である{{c|distcc}}で構成されています。また[http://ccache.samba.org ccache]、[[Portage]]、Automakeとの連携もちょっとしたセットアップで可能となります。 

Gentooのインストールに{{c|distcc}}を使いたい場合は、[[#Using_distcc_to_bootstrap|Using distcc to bootstrap]]を参照してください。 

== インストール ==

{{c|distcc}}を構築する前に、まずは使用するすべてのホストに{{Package|sys-devel/distcc}} パッケージが導入されているかどうか確認しましょう。

=== 全てのホストで必要なこと ===

{{c|distcc}}を使用するには、ネットワークのすべてのコンピュータのGCCが同じバージョンでなければいけません。例を挙げますと、3.3.x(xは任意の数字)を混在させるのは問題ありませんが、3.3.xと3.2.xを混在させた場合はコンパイルエラーや実行時エラーが起きるかもしれません。 

=== ソフトウェアのインストール ===

Distccには分散コンパイルしているタスクを監視するグラフィカルモニタが付属しています。<code>gtk</code> USEフラグをセットすると、このユーティリティーを使えるようにできます。

USEフラグの設定が終わったら{{Package|sys-devel/distcc}}パッケージをインストールします。

{{Emerge|sys-devel/distcc}}

{{Important|{{Package|sys-devel/distcc}}は分散コンパイルに使う全てのホストにインストールしてください。}}

=== distcc デーモンの自動起動 ===

{{c|distccd}}を自動的に起動するためには、次の方法に従ってください。ただし、ご使用のinitシステムによって、やり方が違います。

==== OpenRC をご使用中の場合 ====

{{Path|/etc/conf.d/distccd}} を編集して <code>--allow</code> ディレクティブに信頼できるクライアントがセットされいるかどうかを確認してください。例えば multi-homded　システムを採用しているなどのように、さらにセキュリティを高めるには <code>--listen</code> ディレクティブで {{c|distccd}} デーモンにどのIPを受け付けるのかを知らせください。{{c|distcc}} のセキュリティについてもっと詳しく知りたいならば、[http://distcc.googlecode.com/svn/trunk/doc/web/security.html Distcc security notes] を参照してください。

次の設定例では、<code>192.168.0.4</code>と<code>192.168.0.5</code>で実行されている distcc クライアントは、ローカルで実行されている {{c|distccd}} サーバへの接続が許されます:

{{FileBox|filename=/etc/conf.d/distccd|title=ある特定のクライアントがdistccに接続できるようにする|lang=bash|1=
DISTCCD_OPTS="--port 3632 --log-level notice --log-file /var/log/distccd.log -N 15 --allow 192.168.0.4 --allow 192.168.0.5"
}}

{{Important|重要なことは、 <code>--allow</code> と <code>--listen</code> を使用することです。{{c|distccd}} man ページか、もっと詳しくは上記のセキュリティ・ドキュメントをご覧ください。}}

それでは、分散コンパイルに参加する全てのコンピュータで {{c|distccd}} デーモンを起動しましょう: 

{{RootCmd|rc-update add distccd default
|rc-service distccd start}}

==== systemd をご使用中の場合 ====

{{Path|/etc/systemd/system/distccd.service.d/00gentoo.conf}} を編集して、CIDRフォーマットにて許可するクライアントを追加してください。例をあげますと:

{{FileBox|filename=/etc/systemd/system/distccd.service.d/00gentoo.conf|title=ALLOWED_SERVERS の設定|lang=bash|1=
Environment="ALLOWED_SERVERS=192.168.1.0/24"
}}

{{Note| ここで使われている "ALLOWED_SERVERS" という名前はいささか混乱を招きます。なぜなら、それはローカルの distccd サーバに接続を許されているクライアント（複数）を指し示しているからです。この変数は、 distccd サービスで使用される --allow オプションに引き渡されます。– 参照 {{Path|/usr/lib/systemd/system/distccd.service.}}}}

このような変更した後は、ユニット・ファイルをリロードしましょう。

{{RootCmd|systemctl daemon-reload}}

{{c|distccd}}の自動起動を有効にして、サービスを開始します:

{{RootCmd|systemctl enable distccd
|systemctl start distccd}}

== 設定 ==

それでは、{{c|distcc}}の設定をしていきましょう。

=== 参加するホストを記述する ===

{{c|distcc-config}}コマンドを使用すれば、ホストのリストを設定することができます。 

ホストのリストの書き方の一例を下に記します。ほとんどのケースでは、１行目と２行目の書き方で十分でしょう。
２行目の書き方のように<code>/limit</code>シンタックスを使えば、{{c|distcc}}にこのノードで最大いくつのジョブを起動できるかを知らせることができます。[http://distcc.googlecode.com/svn/trunk/doc/web/man/distcc_1.html distcc マニュアルページ] では、3行目や4行目のような書き方の詳しい説明が載っています。

{{CodeBox|title=ホスト定義の例|1=
192.168.0.1          192.168.0.2                       192.168.0.3
192.168.0.1/2        192.168.0.2                       192.168.0.3/10
192.168.0.1:4000/2   192.168.0.2/1                     192.168.0.3:3632/4
@192.168.0.1         @192.168.0.2:/usr/bin/distccd     192.168.0.3
}}

ホストをセッティングする方法にはここで挙げたほかにもいくつかやり方ありますので、詳細については、{{c|distcc}} man ページをご覧ください。

ローカルマシンでもコンパイル作業をさせたいのなら、ホストのリストに <code>localhost</code> と記入しましょう。逆に、ローカルマシンにコンパイル作業をさせたくない場合には、リストから外しましょう。遅いマシンでlocalhostを設定してると、実際すべてのことが遅くなってしまうでしょう。また、設定したものをテストするのも忘れないでください。

例の中の最初の一行目で書かれたホストを使用して、 {{c|distcc}} の環境を設定してみましょう。

{{RootCmd|/usr/bin/distcc-config --set-hosts "192.168.0.1 192.168.0.2 192.168.0.3"}}

=== Portageでdistccを使用する ===

[[Portage]] が {{c|distcc}} を利用できるように設定するのは簡単です。 {{c|distcc}} feature を有効にして、同時にビルドに参加するジョブ数を設定する変数があるのですがこれに適当な数をいれてやるだけです (この数に従って {{c|distcc}} はビルドするリソースの量を増やします)。

下に示したように、<var>MAKEOPTS</var>変数と<var>FEATURES</var>変数を設定してください。

一般的な戦略としては、
* <code>N</code>の値を「トータルの」(ローカルとリモートの)CPUコアの個数の2倍 + 1に設定し、
* <code>M</code>の値を「ローカルの」CPUコアの個数に設定します。

<var>MAKEOPTS</var>変数で<code>-lM</code>を使用すると過剰なタスクが起動されてしまうのを防ぐことができます。例えば、{{c|distcc}}クラスタホストのいくつかが利用できなくなった時(他のシステムでの並列ジョブの量が増加した場合)や、ebuild でリモートビルドを禁止している時(gccなど)です。この仕組みは、システム負荷が <code>M</code>値以上になった時に、それ以上のジョブの追加を拒否することによって行われます。

{{FileBox|filename=/etc/portage/make.conf|title=MAKEOPTSとFEATURESの設定|lang=bash|1=
# NとMを計算した正しい値に置き換えてください
MAKEOPTS="-jN -lM"
FEATURES="distcc distcc-pump"
}}

例えば、４コアＰＣのホスト２台と２コアＰＣのローカルがあったと仮定しましょう。すると <var>MAKEOPTS</var> 変数は次のようになります。

{{FileBox|filename=/etc/portage/make.conf|title=4コア２台(リモート)と2コア1台(ローカル)での MAKEOPTS の設定例example for 2 quad-core (remote) and one dual core (local) PC|lang=bash|1=
# 4コアのリモートホスト2台 = 8 コアのリモート
# 2コアのローカルホスト１台 = 2 コアのローカル
# コアの総数は、10　なので、 N = 2*10+1 と M=2
MAKEOPTS="-j21 -l2"
}}

{{Path|make.conf}}ファイルを編集するとき、<var>CFLAGS</var>や<var>CXXFLAGS</var>で<code>march=native</code>を設定してはいけません。これはよく確認してください。<code>march</code>が<code>native</code>に設定されていると、{{c|distccd}}は作業を他のマシンにうまく分散しなくなるでしょう。そのかわり、次のコマンドを実行すれば適切な<code>-march=</code>の値がわかります。

{{Cmd|gcc -v -E -x c -march{{=}}native -mtune{{=}}native - < /dev/null 2>&1 {{!}} grep cc1 {{!}} perl -pe 's/ -mno-\S+//g; s/^.* - //g;'}}

詳しくは、 [http://blogs.gentoo.org/mgorny/2014/06/23/inlining-marchnative-for-distcc/ Inlining <code>-march=native</code> for distcc] をご覧ください。

=== automake で distcc を使用する ===

This is, in some cases, easier than the Portage setup. All that is needed is to update the <var>PATH</var> variable to include {{Path|/usr/lib/distcc/bin/}} in front of the directory that contains {{c|gcc}} ({{Path|/usr/bin/}}). However, there is a caveat. If {{c|ccache}} is used, then put the {{c|distcc}} location after the {{c|ccache}} one: 

{{RootCmd|export PATH{{=}}"/usr/lib/ccache/bin:/usr/lib/distcc/bin:${PATH}"}}

Put this in the user's {{Path|~/.bashrc}} or equivalent file to have the <var>PATH</var> set every time the user logs in, or set it globally through an {{Path|/etc/env.d/}} file.

Instead of calling {{c|make}} alone, add in <code>-jN</code> (where <code>N</code> is an integer). The value of <code>N</code> depends on the network and the types of computers that are used to compile. A heuristic approach to the right value is given earlier in this article.

== ブートストラップにdistccを使う ==

Using {{c|distcc}} to bootstrap (i.e. build a working toolchain before installing the remainder of the system) requires some additional steps to take.

=== Step 1: Portage の設定 ===

Boot the new box with a Gentoo Linux LiveCD and follow the [[Handbook:AMD64|installation instructions]], while keeping track of the instructions in the [[FAQ|Gentoo FAQ]] for information about bootstrapping. Then configure Portage to use {{c|distcc}}: 

{{FileBox|filename=/etc/portage/make.conf|title=Configure Portage to use distcc|lang=bash|1=
FEATURES="distcc"
MAKEOPTS="-jN"
}}

Update the <code>PATH</code> variable in the installation session as well:

{{RootCmd|export PATH{{=}}"/usr/lib/ccache/bin:/usr/lib/distcc/bin:${PATH}"}}

=== Step 2: distcc をゲット ===

Install {{Package|sys-devel/distcc}}: 

{{RootCmd|USE{{=}}'-*' emerge --nodeps sys-devel/distcc}}

=== Step 3: distcc のセッティング ===

Run {{c|distcc-config --install}} to setup distcc; substitute the <code>host#</code> in the example with the IP addresses or hostnames of the participating nodes.

{{RootCmd|/usr/bin/distcc-config --set-hosts "localhost host1 host2 host3 ..."}}

Distcc is now set up to bootstrap! Continue with the proper installation instructions and do ''not'' forget to run {{c|emerge distcc}} after running {{c|emerge @system}}. This is to make sure that all of the necessary dependencies are installed. 

{{Note|During bootstrap and {{c|emerge @system}} {{c|distcc}} may not appear to be used. This is expected as some ebuilds do not work well with distcc, so they intentionally disable it.}}

== Distcc に付属するツール群 ==

The {{c|distcc}} application has additional features and applications to support working in a {{c|distcc}} environment.

=== Distcc の監視 === 

Distccには2つの監視ユーティリティが付属しています。テキストベースの監視ユーティリティは {{c|distccmon-text}} で、必ずビルドされます。最初に実行するときは少々混乱するかもしれませんが、実際とても簡単に使うことができます。パラメータなしで実行したときは、プログラムは1回だけ実行されますが、引数に<code>N</code>を渡すと、<tt>N</tt>秒ごとに更新が行われます。

{{Cmd|distccmon-text 10}}

もうひとつの監視ユーティリティは <code>gtk</code> USE フラグがセットされた時のみ有効になります。これはGTK+ベースで、X環境で動作し、なかなか良い外見をしています。
Gentooでは、このGUIモニタは混乱を避けるため {{c|distccmon-gui}} にリネームされています(もともとの名前は{{c|distccmon-gnome}} です)。

{{Cmd|distccmon-gui}}

Portageでの{{c|distcc}}の使用をモニタするには:

{{RootCmd|DISTCC_DIR{{=}}"/var/tmp/portage/.distcc/" distccmon-text 10
|DISTCC_DIR{{=}}"/var/tmp/portage/.distcc/" distccmon-gui}}

{{Important|もしdistccディレクトリが別の場所にあるなら、それに合わせて<var>DISTCC_DIR</var>変数を変えてください。}}

A trick is to set <var>DISTCC_DIR</var> in environment variables:

{{RootCmd|echo 'DISTCC_DIR{{=}}"/var/tmp/portage/.distcc/"' >> /etc/env.d/02distcc}}

ここで、環境を更新します:

{{RootCmd|env-update
|source /etc/profile}}

ようやく、GUIアプリケーションを開始することができます:

{{RootCmd|distccmon-gui}}

=== distccの通信に SSH を使いたい時 ===

Setting up distcc via SSH includes some pitfalls. First, generate an SSH key pair without password setup. Be aware that portage compiles programs as the Portage user (or as root if <code>FEATURES="userpriv"</code> is not set). The home folder of the Portage user is {{Path|/var/tmp/portage/}}, which means the keys need to be stored in {{Path|/var/tmp/portage/.ssh/}}

{{RootCmd|ssh-keygen -b 2048 -t rsa -f /var/tmp/portage/.ssh/id_rsa}}

Second, create a section for each host in the SSH configuration file:

{{FileBox|filename=/var/tmp/portage/.ssh/config|title=Add per-host sections|1=
Host test1
    HostName 123.456.789.1
    Port 1234
    User UserName
 
Host test2
    HostName 123.456.789.2
    Port 1234
    User UserName
}}

Send the public key to each compilation node:

{{RootCmd|ssh-copy-id -i /var/tmp/portage/.ssh/id_rsa.pub UserName@CompilationNode}}

Also make sure that each host is available in the {{Path|known_hosts}} file:

{{RootCmd|ssh-keyscan -t rsa <compilation-node-1> <compilation-node-2> [...] > /var/tmp/portage/.ssh/known_hosts}}

Fix the file ownership as follows:

{{RootCmd|chown -R portage:portage /var/tmp/portage/.ssh/}}

To set up the hosts <code>test1</code> and <code>test2</code>, run:

{{RootCmd|/usr/bin/distcc-config --set-hosts "@test1 @test2"}}

Please note the <code>@</code> (@ sign), which specifies ssh hosts for distcc.

Finally, tell {{c|distcc}} which SSH binary to use:

{{FileBox|filename=/etc/portage/make.conf|lang=bash|1=
DISTCC_SSH="ssh"
}}

It is not necessary to run the {{Path|distccd}} initscript on the hosts when {{c|distcc}} communicates via SSH.

== トラブルシューティング ==

<!-- このセクションがもっと大きくなるようでしたらサブページに分割するようにしてください。 -->

{{c|distcc}} をご使用中に問題が発生したときには、このセクションをお読みになれば問題解決の糸口となるかもしれません。

=== ERROR: failed to open {{Path|/var/log/distccd.log}} ===

<!-- To be removed when the bug is resolved and the fixed package is stable -->

2015年1月22日以降、emergeすると {{Path|/var/log/}} に適切な {{Path|distccd.log}} ファイルを作るのに失敗します。これは、 distcc ver.3.1-r8 のみに起こることが明らかにされています。このバグは現在修正中ですが(参照:{{Bug|477630}})、手作業でそのログファイルを作成し、適切な所有者を設定し、distccデーモンを再起動することで何とかうまく動くようにできます。

{{RootCmd
|mkdir -p /var/log/distcc
|touch /var/log/distcc/distccd.log
|chown distcc:daemon /var/log/distcc/distccd.log
}}

次に、{{Path|/etc/conf.d/distccd}}にある{{c|distccd}}コンフィグレーションファイルの{{Path|/var/log}}の値を先ほど作成した{{Path|distcc}}ディレクトリに更新してください：

{{FileBox|filename=/etc/conf.d/distccd|title=Updating log path|lang=bash|1=
DISTCCD_OPTS="--port 3632 --log-level notice --log-file /var/log/distcc/distccd.log -N 15 
}}

最後に distccd サービスを再起動します。

{{RootCmd|/etc/init.d/distccd restart}}

=== distccをつかえないパッケージもあります ===

As various packages are installed, users will notice that some of them aren't being distributed (and aren't being built in parallel). This may happen because the package' {{Path|Makefile}} doesn't support parallel operations, or the maintainer of the ebuild has explicitly disabled parallel operations due to a known problem. 

Sometimes {{c|distcc}} might cause a package to fail to compile. If this happens, please [https://bugs.gentoo.org/ report] it.

=== GCC のバージョンが混在する場合 ===

If the environment hosts different GCC versions, there will likely be very weird problems. The solution is to make certain all hosts have the same GCC version. 

Recent Portage updates have made Portage use <code>${CHOST}-gcc</code> (minus gcc) instead of <code>gcc</code>. This means that if i686 machines are mixed with other types (i386, i586) then the builds will run into troubles. A workaround for this may be to run:

{{RootCmd|export CC{{=}}'gcc' CXX{{=}}'c++'}}

It is also possible to set the <var>CC</var> and <var>CXX</var> variables in {{Path|/etc/portage/make.conf}} to the values list in the command above.

{{Important|Doing this explicitly redefines some behavior of Portage and may have some weird results in the future. Only do this if mixing CHOSTs is unavoidable.}}

=== -march=native ===

Starting with GCC 4.3.0, the compiler supports the <code>-march=native</code> option which turns on CPU auto-detection and optimizations that are worth being enabled on the processor on which GCC is running. This creates a problem when using {{c|distcc}} because it allows the mixing of code optimized for different processors. For example, running {{c|distcc}} with <code>-march=native</code> on a system that has an AMD Athlon processor and doing the same on ''another'' system that has an Intel Pentium processor will mix code compiled on both processors together.

Heed the following warning:

{{Warning|{{c|distcc}} でコンパイルするときには、{{Path|make.conf}} の <var>CFLAGS</var> 変数または <var>CXXFLAGS</var> 変数で <code>-march{{=}}native</code> や <code>-mtune{{=}}native</code>を '''使用しないでください'''。}}

<code>-march=native</code> を指定したとき、GCCがどのようなフラグを有効にしているのかを知りたいときには、次のコマンドを実行してください:

{{Cmd|gcc -march{{=}}native -E -v - &lt;/dev/null 2&gt;&amp;1 {{!}} grep cc1|output=<pre>
/usr/libexec/gcc/x86_64-pc-linux-gnu/4.7.3/cc1 -E -quiet -v - -march=corei7-avx \
  -mcx16 -msahf -mno-movbe -mno-aes -mpclmul -mpopcnt -mno-abm -mno-lwp -mno-fma \
  -mno-fma4 -mno-xop -mno-bmi -mno-bmi2 -mno-tbm -mavx -mno-avx2 -msse4.2 -msse4.1 \
  -mno-lzcnt -mno-rdrnd -mno-f16c -mno-fsgsbase --param l1-cache-size=32 \
  --param l1-cache-line-size=64 --param l2-cache-size=6144 -mtune=corei7-avx
</pre>}}

== 参考 ==

* The [[Distcc/Cross-Compiling|DistCC Cross-compiling guide]] explains how using one architecture to build programs for another architecture is done through {{c|distcc}}. This can be as simple as using an Athlon (i686) to build a program for a K6-2 (i586), or using a SPARC to build a program for a PowerPC.

== 外部の情報 ==

* [http://blogs.gentoo.org/mgorny/2014/06/23/inlining-marchnative-for-distcc/ Inlining <code>-march=native</code> for distcc]
* [https://github.com/distcc/distcc Distcc homepage]

{{Migrated|originalauthors=Lisa Seelye, Mike Frysinger, Erwin, Sven Vermeulen, Lars Weiler, Tiemo Kieft and nightmorph}}
