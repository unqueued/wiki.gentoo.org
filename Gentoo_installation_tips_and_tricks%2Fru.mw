<languages />


{{Metadata|abstract=Процесс установки Gentoo позволяет использовать очень гибкие подходы к различным методам установки. Поскольку в инструкцию по установке практически невозможно вставить каждый совет или трюк, этот документ пытается иметь дело с распространенными полезными советами и трюками для справочных целей.}}

Процесс установки Gentoo позволяет использовать очень гибкие подходы к различным методам установки. Поскольку в инструкцию по установке практически невозможно вставить каждый совет или трюк, этот документ пытается иметь дело с распространенными полезными советами и трюками для справочных целей.


== Введение ==

== Предварительно ==

В этом документе содержатся различные советы и трюки для установки Gentoo/x86. Многие из них обсуждаются достаточно серьезно - их нужно воспринимать как полезные советы для установки, а не как её замена. 

== Расширенная установка ==

=== Программный RAID ===

{{Note|Если вы не знакомы с понятием программный RAID, пожалуйста, прочтите [https://raid.wiki.kernel.org/index.php/Linux_Raid Software-RAID-HOWTO].}}

{{Note|Более подробное описание можно найти по ссылке [https://gentoo-handbook.lugons.org/doc/en/gentoo-x86+raid+lvm2-quickinstall.xml Software Raid and LVM2 x86 Quick Install Guide].}}

После загрузки с установочного диска загрузите подходящий модуль RAID. Например, если вы планируете использовать RAID-1: 

{{RootCmd|modprobe raid1}}

При разметке диска, убедитесь, что разделы используют <code>fd</code> (Linux raid autodetect) как тип раздела вместо <code>83</code> (Linux native). Тип раздела можно изменить с помощью команды <code>t</code> в программе <code>fdisk</code>. 

Теперь, прежде чем мы начнем создавать RAID-массивы, нам нужно создать ноды мета-устройств: 

{{RootCmd|mknod /dev/md1 b 9 1
|mknod /dev/md2 b 9 2
|mknod /dev/md3 b 9 3}}

После разметки диска создайте файл {{Path|/etc/mdadm.conf}} (да, прямо в окружении установочного диска)  с помощью <code>mdadm</code>, продвинутая утилита для [http://www.linuxdevcenter.com/pub/a/linux/2002/12/05/RAID.html администрирования RAID ]. Например, чтобы зеркалировать boot, swap и root разделы (RAID-1) на {{Path|/dev/sda}} и {{Path|/dev/sdb}}, можно воспользоваться: 

{{RootCmd|mdadm --create --verbose /dev/md1 --level{{=}}1 --raid-devices{{=}}2 --metadata{{=}}0.90 /dev/sda1 /dev/sdb1
|mdadm --create --verbose /dev/md2 --level{{=}}1 --raid-devices{{=}}2 --metadata{{=}}0.90 /dev/sda2 /dev/sdb2
|mdadm --create --verbose /dev/md3 --level{{=}}1 --raid-devices{{=}}2 --metadata{{=}}0.90 /dev/sda3 /dev/sdb3}}

{{Important|Вы не должны использовать любую форму чередования, такую как RAID-0 или RAID-5, на загружаемом вами разделе. Кроме того, для этих критических файловых систем требуется только <code>--metadata{{=}}0.90</code>. Другие файловые системы могут использовать более свежие форматы метаданных.}}

Программный Linux драйвер RAID начнет создавать мета-устройства. Вы можете наблюдать этот процесс в {{Path|/proc/mdstat}}. Прежде чем продолжить, подождите, пока процесс создания мета-устройств полностью закончится. 

{{RootCmd|mdadm --detail --scan > /etc/mdadm.conf}}

С этого момента используйте {{Path|/dev/md1}} как раздел boot, {{Path|/dev/md2}} как раздел swap и {{Path|/dev/md3}} как раздел root. 

Прямо перед chroot, не забудьте скопировать файл {{Path|/etc/mdadm.conf}} в {{Path|/mnt/gentoo/etc}}. 

Во время конфигурации ядра, убедитесь, что поддержка соответсвующего RAID включено ''в ядре'', а не как модуль. 

Во время установки дополнительных (системных) утилит, также установите <code>mdadm</code>. Обратите внимание, что он может быть не доступен на всех установочных дисках. Поэтому установка на программный RAID может быть неосуществима, если установка производиться без сети! 

Во время установки загрузчика, убедитесь, что установили загрузчик в MBR на ''обоих'' дисках, которые используются в зеркале.

=== ATA RAID с использованием ядер 2.4 ===

Убедитесь, что вы загружаетесь с вашего установочного компакт-диска используя опцию <code>doataraid</code>. После загрузки проверьте содержимое {{Path|/dev/ataraid}}. Он должен содержать различные директории {{Path|disc*}} для каждого жесткого диска, доступного в ATA RAID. Весь диск отображается как {{Path|disc}}, в то время как разделы - {{Path|part*}}. 

Write down the various {{Path|/dev/ataraid/disc*/*}} device files that you use to install Gentoo on. You will need to substitute the {{Path|/dev/sda}} examples in the installation with this path. 

Перед chroot, bind-mount {{Path|/dev}} структуру в новое окружение: 

{{RootCmd|mount --rbind /dev /mnt/gentoo/dev}}

Во время настройки ядра убедитесь, что включена поддержка вашего чипсета ATA RAID и его параметры. Например, популярная система RAID ATA представляет собой «встроенный RAID-модуль Promise FastTrack», и в этом случае вам определенно нужен <code>Promise FastTrack Options</code>, встроенный в ваше ядро. 

При настройке GRUB сначала необходимо создать загрузочный диск GRUB. Это не так сложно, как вы думаете. Сначала установите GRUB так как обычно, но когда вы перейдете к той части, где GRUB будет установлен в MBR, выполните следующие инструкции: 

{{RootCmd|cd /boot/grub
|dd if{{=}}stage1 of{{=}}/dev/fd0 bs{{=}}512 count{{=}}1
|dd if{{=}}stage2 of{{=}}/dev/fd0 bs{{=}}512 seek{{=}}1}}

Вам все равно нужно написать файл {{Path|grub.conf}}. Это ничем не отличается от инструкций по установке, просто убедитесь, что ваш <code>root=</code> указывает на устройство RAID ATA. 

После завершения установки загрузитесь с помощью загрузочного диска GRUB. Вас встретит приглашение GRUB. Теперь настройте GRUB для загрузки с устройства RAID ATA: 

{{Cmd|root (hd0,x)|prompt=grub> 
|setup (hd0)
|quit}}

Теперь перезагрузитесь (с извлеченной загрузочной дискетой GRUB). 

Пользователи LILO могут безопасно использовать инструкции, указанные в инструкциях по установке. 

=== Использование ядра из установочного диска ===

Если вы не хотите компилировать ядро самостоятельно, вы можете использовать ядро из установочного диска, скопировав его на устанавливаемую систему. Когда вы дойдете до компиляции ядра, перейдите на другой терминал (нажмите {{Key|Alt}} + {{Key|F2}}) и войдите в систему, введя пароль root, который вы указали в начале установки. 

Скопируйте ядро и модули на новую установку Gentoo: 

{{Note|${KN} наименование ядра. Обычно что-то вроде 'gentoo' или 'smp'.}}

{{RootCmd|cp /mnt/cdrom/isolinux/${KN} /mnt/cdrom/isolinux/${KN}.igz /mnt/gentoo/boot
|mkdir -p /mnt/gentoo/lib/modules
|cp -Rp /lib/modules/`uname -r` /mnt/gentoo/lib/modules}}

Чтобы все модули, которые в настоящее время загружены в память (с установочного диска), загружались во время загрузки новой системы Gentoo, выполните следующую команду в окружении chroot: 

{{RootCmd|printf "modules\"" >> /etc/conf.d/modules
|cat /proc/modules {{!}} cut -d ' ' -f 1 >> /etc/conf.d/modules
|printf "\"\n" >> /etc/conf.d/modules}}

Проверьте содержимое файла {{Path|/etc/conf.d/modules}} и обновите его по необходимости.

== Упрощение установки ==

=== Оставляя свой терминал ===

Многие люди хотят оставить свою систему во время компиляции. В некоторых случаях это довольно сложно, поскольку установка выполняется в публичном окружении, где вы не можете доверять всем. Если это так, то вы, возможно, хотели бы иметь возможность выполнить компиляцию в фоновом режиме и выйти из всех терминалов. 

Для этого существует несколько возможных решений. Первый - использовать <code>screen</code>. После загрузки с установочного компакт-диска установите пароль root и запустите сеанс screen: 

{{Note|Не все установочные компакт-диски предоставляют screen. Если это так, вам придется воспользоваться одним из других методов, описанных в этом разделе.}}

{{RootCmd|screen -S gentoo}}

Внутри сеанса screen вы можете выполнить всю установку. Когда вы хотите покинуть свой терминал, нажмите {{Key|Ctrl}} + {{Key|a}}, {{Key|d}} (то есть {{Key|Ctrl}} и {{Key|a}} одновременно, а затем {{Key|d}}), чтобы «отсоединить» ваш сеанс screen. Теперь вы можете безопасно выйти из своей системы. 

Чтобы восстановить доступ к вашему терминалу, войдите в систему с правами root и «присоединитесь» к работающему сеансу screen: 

{{RootCmd|screen -x gentoo}}

Если вы не можете использовать screen, вы все еще можете оставить свой терминал. Следуйте инструкциям по установке, но когда вы дойдете до точки, где будет запущена долгосрочная компиляция (например, шаг <code>./scripts/bootstrap.sh</code>), используйте <code>nohup</code> который позволяет продолжить процесс, даже когда вы выходите из системы. Не забывайте добавить в конце «&», иначе процесс не будет помещен в фоновый режим! Запомните где вы находитесь (команда <code>pwd</code> покажет вам это), так как вам нужно будет знать об этом позднее. 

{{RootCmd|pwd|output=<pre>
/usr/portage
</pre>}}

{{RootCmd|nohup ./scripts/bootstrap.sh &}}

Теперь выйдите из окружения chroot (<code>exit</code>) и сессии установочного компакт-диска. Ваша компиляция будет продолжена в фоновом режиме. 

Если вы хотите проверить компиляцию, войдите в систему с правами root (на установочном компакт-диске), chroot обратно в свою среду и перейдите в каталог, в котором вы остановились: 

{{RootCmd|chroot /mnt/gentoo /bin/bash
|env-update && source /etc/profile
|cd /usr/portage}}

Теперь примените команду <code>less</code> к файлу {{Path|nohup.out}}, который находится внутри этого каталога. Компиляция добавит свой вывод в этот файл, поэтому, если вы хотите следить за ходом компиляции, запустите <code>less nohup.out </code> и нажмите <code>F</code>, чтобы следить за изменениями. Когда компиляция завершится, вы можете продолжить со следующего шага инструкций по установке. 

Если вам надоест следить за этими изменениями, нажмите {{Key|Ctrl}} + {{Key|C}}, а затем {{Key|q}}. Это не остановит процесс компиляции, остановится только процесс <code>less</code>. 

== Исправление ошибок/проблем ==

=== Обширное тестирование ваших дисков ===

Если вы считаете, что ваш диск нуждается в тщательной проверке на согласованность (плохие сектора и т. д.), Вы можете использовать опцию <code>-c</code> (c в нижнем регистре) при размещении на нем файловой системы ext2 или ext3 (используя <code>mke2fs</code>). Это отформатирует, выполнит тест чтения и пометит все плохие блоки как таковые. Если вы настоящий параноик, используйте <code>-c -c</code> для форматирования вашего диска и выполнения обширного теста чтения/записи. 

{{RootCmd|mke2fs -j -c /dev/sda3}}

=== Восстановление из неисправной установки ===

Если по какой-либо причине ваша установка Gentoo не удалась, вам не нужно повторно выполнять установку заново. Вместо этого вы можете безопасно «перейти» к точке, где, по вашему мнению, вы допустили ошибку (или если вы считаете, что эти инструкции ошибочны) и попробуйте другой подход. 

Прежде всего, вам нужно сделать chroot для того, чтобы вернуться в среду Gentoo Linux. Следуйте инструкциям еще раз, но игнорируйте шаги созданя разделов, поскольку ваши разделы уже созданы и даже заполнены. Поэтому вы можете немедленно смонтировать эти разделы в {{Path|/mnt/gentoo}}. Вам также следует проигнорировать шаги по извлечению файлов из архива stage и модификации {{Path|make.conf}} - вы же не хотите перезаписывать свои файлы, не так ли? 

После того, как вы сделали chroot внутрь вашей среды Gentoo Linux, немедленно переходите к шагу, на котором вы думаете, что вам следует попробовать другой подход. Не переделывайте все шаги, такие как настройка загрузчика и т. д., если это не то место, где вы считаете, что все пошло не так. 

Например, если вы считаете, что у вас неправильно настроенный {{Path|grub.conf}}, вы можете немедленно запустить ваш редактор для обновления {{Path|/boot/grub/grub.conf}}. 

После того, как вы попробовали другой подход к своей ситуации, вы должны подумать о том, сколько последующих шагов вам нужно выполнить снова. Если последующие шаги зависят от вашего изменения, вам нужно будет их переделать. 

Например: 

* Если вы изменили переменную внутри {{Path|make.conf}}, вам нужно будет выполнить все последующие компиляции, поскольку они зависят от настроек внутри {{Path|make.conf}}
* Если вы изменили {{Path|/boot/grub/grub.conf}}, вы можете немедленно выйти из chroot среды и перезагрузиться, так как никакие последующие шаги не зависят от {{Path|grub.conf}}
* Если вы перекомпилировали ваше ядро, вам нужно только убедиться, что ваша конфигурация загрузчика указывает на правильный образ ядра (дважды проверьте, что вы смонтировали свой {{Path|/boot}}!), затем вы можете выйти из chroot среды и перезагрузиться
* Если вы изменили {{Path|/etc/fstab}}, вы можете выйти из chroot среды и перезагрузиться

Как видите, для большинства операций восстановления вы можете сразу перезагрузиться. Только в некоторых случаях вам потребуется повторить последующие шаги установки.

[[Category:Server and Security]] {{Migrated|originalauthors=Xavier Neys, nightmorph}}
