<languages />

{{Metadata|abstract=Distcc — это программа, предназначенная для распределения по сети задач компиляции в рамках набора хостов. Она состоит из серверной части — distccd и клиентской — distcc. После небольшой настройки distcc может прозрачно работать с ccache, Portage и Automake.}}

[http://distcc.samba.org Distcc] — это программа, предназначенная для распределения по сети задач компиляции в рамках набора хостов. Она состоит из серверной части — <code>distccd</code> и клиентской — <code>distcc</code>. После небольшой настройки distcc может прозрачно работать с [http://ccache.samba.org ccache], Portage и Automake. 

Если вы планируете использовать distcc при начальной сборке (bootstrap) своей установки Gentoo, обратите внимание на раздел [[#Использование_Distcc_для_начальной_сборки_(bootstrap)_Gentoo|Использование Distcc для начальной сборки (bootstrap) Gentoo]]. 

== Установка ==

=== Зависимости ===

Для работы с Distcc все компьютеры в сети должны иметь GCC одной версии. К примеру, можно использовать на разных машинах 3.3.x (где x — разные), а смешивание 3.3.x с 3.2.x '''может''' привести к ошибкам при компиляции или выполнении. 

=== Установка Distcc ===

Есть пара возможностей, о которых вам должно быть известно до начала установки distcc. 

Distcc поставляется с графическим просмотрщиком для отслеживания заданий, отправляемых компьютером на компиляцию. Он включается с помощью USE-флага <code>gtk</code>.

{{Emerge|distcc}}

{{Important/ru|Убедитесь, что distcc установлен на все машины, которые вы планируете использовать для распределённой компиляции.}}

=== Настройка Portage для работы с Distcc ===

Настроить Portage для работы с distcc легко. Выполните следующие шаги на каждой системе, которая должна участвовать в распределенной компиляции: 

{{Emerge|distcc}}

Теперь установите переменные <code>MAKEOPTS</code> и <code>FEATURES</code> как показано ниже. Общепринятая стратегия — выбор в качестве N удвоенного числа CPU (локальных + удалённых) + 1, а в качестве M — числа локальных CPU. Флаг <code>-lM</code> предотвращает запуск чрезмерно большого количества заданий в случаях, когда некоторые хосты distcc недоступны, или файл ebuild требует локальной компиляции пакета (например, gcc).

{{File|/etc/portage/make.conf|Установка переменных MAKEOPTS и FEATURES|<pre>
MAKEOPTS="-jN -lM"
FEATURES="distcc"
</pre>
}}

Например, если ваш локальный двухядерный компьютер связан с помощью distcc с двумя четырёхядерными, то переменная <code>MAKEOPTS</code> может выглядеть так:

{{File|/etc/portage/make.conf|Пример MAKEOPTS для двухядерного и двух четырёхядерных компьютеров|<pre>
MAKEOPTS="-j17 -l2"
</pre>
}}

=== Указание участвующих хостов ===

Для задания списка хостов используйте команду <code>distcc-config</code>. Здесь приведены примеры хостов, которые могли бы находиться в этом списке: 

{{Code|Примеры определения хоста|<pre>
192.168.0.1          192.168.0.2                       192.168.0.3
192.168.0.1/2        192.168.0.2                       192.168.0.3/10
192.168.0.1:4000/2   192.168.0.2/1                     192.168.0.3:3632/4
@192.168.0.1         @192.168.0.2:/usr/bin/distccd     192.168.0.3
</pre>
}}

Также имеется несколько других методов для настройки хостов. За подробностями обратитесь к man-странице distcc.

Если Вы хотите компилировать на локальной машине, Вы должны поместить 'localhost' в список хостов. Наоборот, если Вы не хотите использовать локальную машину для компиляции (что является частым случаем), не включайте ее в список хостов. Использование localhost на медленной машине может фактически замедлить процесс. Убедитесь что Вы проверили настройки на производительность.

Это может выглядеть сложно, но в большинстве случаев вариант строки 1 или 2 будет работать. 

Так как большинство людей не будут использовать строки 3 или 4, я [http://distcc.samba.org/man/distcc_1.html обращаюсь к] документации distcc (man distcc) за подробностями, которые включают возможность запуска distcc через SSH-соединение. 

Например, чтобы установить первую строку из предыдущего примера: 

{{RootCmd|/usr/bin/distcc-config --set-hosts "192.168.0.1 192.168.0.2 192.168.0.3"}}

Отредактируйте {{Path|/etc/conf.d/distccd}} в соответствии с Вашими нуждами и установите директиву <code>--allow</code> чтобы разрешить только те хосты, которым Вы доверяете. Для дополнительной безопасности Вам также следует использовать директиву <code>--listen</code>, чтобы сообщить демону distcc на каком IP необходимо слушать (для систем со множественной адресацией). Больше подробностей по безопасности distcc может быть найдено в [http://distcc.samba.org/security.html Distcc Security Design] . 

{{Important/ru|Важно использовать --allow и --listen. Пожалуйста, прочитайте man-страницу distccd или документ по безопасности выше для получения дополнительных подробностей.}}

Теперь запустите демон distcc на всех участвующих компьютерах: 

{{RootCmd|rc-update add distccd default
|/etc/init.d/distccd start}}

=== Настройка Distcc на работу с Automake ===

Это, в некоторых случаях, легче, чем настройка Portage. Что Вам необходимо сделать, это обновить переменную <code>PATH</code> для включения {{Path|/usr/lib/distcc/bin}} впереди каталога, который содержит <code>gcc</code> ({{Path|/usr/bin}}). Однако, есть предостережение. Если Вы используете ccache, Вам нужно поместить distcc после части ccache: 

{{RootCmd|export PATH{{=}}"/usr/lib/ccache/bin:/usr/lib/distcc/bin:${PATH}"}}

Вы можете поместить это в Ваш {{Path|~/.bashrc}} или эквивалентный файл, чтобы PATH был установлен каждый раз когда Вы входите в систему.

Затем, в то время когда Вы обычно набираете <code>make</code>, наберите <code>make -jN</code> (где N - целое число). Значение N зависит от Вашей сети и типов компьютеров, которые Вы используете для компиляции. Протестируйте Ваши настройки для того, чтобы найти число, которое приводит к лучшей производительности. 

=== Настройка Distcc на работу с ssh ===

При настройке distcc через ssh можно натолкнуться на некоторые подводные камни. Сначала сгенерируйте ключевую пару ssh без настройки пароля. Учтите, что портеж компилирует программы в качестве пользователя portage. Домашний каталог пользователя portage - {{Path|/var/tmp/portage}}, что означает что ключи должны храниться в {{Path|/var/tmp/portage/.ssh}}.

{{RootCmd|ssh-keygen -b 2048 -t rsa -f /var/tmp/portage/.ssh/id_rsa}}

Во-вторых, сгенерируйте раздел для каждого хоста в файле конфигурации ssh:

{{RootCmd|nano -w /var/tmp/portage/.ssh/config|output=<pre>
Host test1
    HostName 123.456.789.1
    Port 1234
    User UserName

Host test2
    HostName 123.456.789.2
    Port 1234
    User UserName
</pre>
}}

&nbsp;

Также, убедитесь что каждый из хостов доступен в файле {{Path|known_hosts}} и добавьте Ваш открытый ключ к файлу {{Path|authorized_keys}} на обоих хостах. Для настройки хостов test1 и test2 запустите

{{RootCmd|/usr/bin/distcc-config --set-hosts "@test1 @test2"}}

Пожалуйста, обратите внимание на знак '@', который указывает ssh-хосты для <code>distcc</code>.

== Кросс-компиляция ==

Кросс-компиляция - это использование одной архитектуры для сборки программ для другой архитектуры. Это может быть так же просто как использование Athlon (i686) для сборки программы для K6-2 (i586) или использование Sparc для сборки программы для ppc. Это продокументировано в нашем [[Distcc/Cross-Compiling|Руководстве по кросс-компиляции Distcc]] .

== Использование Distcc для начальной сборки (bootstrap) Gentoo ==

=== Шаг 1: Настройка Portage ===

Загрузите Вашу новую машину с Gentoo Linux LiveCD и следуйте [http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1 инструкциям по установке] до раздела с bootstrap. (См. [[FAQ|Gentoo FAQ]] для получения подробностей о сборке системы методом bootstrap.) Затем сконфигурируйте Portage для использования distcc: 

{{RootCmd|nano -w /etc/portage/make.conf|output=<pre>
FEATURES="distcc"
MAKEOPTS="-jN"
</pre>
}}

{{RootCmd|export PATH{{=}}"/usr/lib/ccache/bin:/usr/lib/distcc/bin:${PATH}"}}

=== Шаг 2: Установка Distcc ===

Установите distcc: 

{{RootCmd|USE{{=}}'-*' emerge --nodeps sys-devel/distcc}}

=== Шаг 3: Настройка Distcc ===

Запустите <code>distcc-config --install</code> для установки distcc; замените <code>host*</code> на IP-адреса или имена хостов принимающих участие в компиляции узлов DistCC.

{{RootCmd|/usr/bin/distcc-config --set-hosts "localhost host1 host2 host3 ..."}}

Distcc теперь настроена на bootstrap! Продолжайте следовать инструкциям официальной установки и ''не забудьте'' заново собрать distcc после <code>emerge system</code>. Это нужно для того, чтобы убедиться, что все зависимости, которые Вам требуются, также установлены. 

{{Note/ru|В течение bootstrap и <code>emerge system</code> distcc может быть не использована. Это ожидаемое поведение, так как некоторые ebuild-файл не работают с distcc нормальным образом, поэтому они преднамеренно ее отключили.}}

== Устранение проблем ==

=== Некоторые пакеты не используют Distcc ===

Во время установки различных пакетов, Вы можете заметить что некоторые из них не являются распределяемыми (и не собираются параллельно). Это может произойти потому что Makefile пакета не поддерживает параллельные операции или мейнтейнер ebuild-файла явно отключил параллельные операции вследствие известной проблемы. 

Иногда distcc может вызвать сбой компиляции пакета. Если это происходит у Вас, пожалуйста, [https://bugs.gentoo.org/ сообщите] нам об этом.

=== Смешанные версии GCC ===

Если Вы имеете разные версии GCC на Ваших хостах, могут возникнуть очень странные проблемы. Решением является проверка того, что все хосты имеют одну и ту же версию GCC. 

Недавние обновления Portage настроили Portage на использование <code>${CHOST}-gcc</code> вместо <code>gcc</code> . Это означает, что если Вы смешиваете машины i686 с другими типами (i386, i586), у Вас могут появиться проблемы. Временным решением может быть запуск команды <code>export CC='gcc' CXX='c++'</code> или поместить это в {{Path|/etc/portage/make.conf}} . 

{{Important/ru|Явное выполнение этого переопределяет в чем-то поведение Portage и может привести к странным результатам в дальнейшем. Делайте это только если Вы смешиваете переменные CHOST.}}

=== -march=native ===

Начиная с GCC 4.3.0, компилятор поддерживает <code>-march=native</code> переключатель, который включает автоматическое обнаружение CPU и оптимизации, которые стоит включить на процессоре, на котором запущен GCC. Это является проблемой для <code>distcc</code>, так как это позволяет смешивать код, оптимизированный для разных процессоров (например, AMD Athlon и Intel Pentium). ''Не'' используйте <code>-march=native</code> или <code>-mtune=native</code> в <code>CFLAGS</code> или <code>CXXFLAGS</code> при компиляции с <code>distcc</code>.

Чтобы узнать какие флаги могут быть включены GCC при запуске с <code>-march=native</code>, выполните следующее:

{{Cmd|gcc -march{{=}}native -E -v - &lt;/dev/null 2&gt;&amp;1 {{!}} grep cc1|output=<pre>
/usr/libexec/gcc/x86_64-pc-linux-gnu/4.7.3/cc1 -E -quiet -v - -march=corei7-avx \
  -mcx16 -msahf -mno-movbe -mno-aes -mpclmul -mpopcnt -mno-abm -mno-lwp -mno-fma \
  -mno-fma4 -mno-xop -mno-bmi -mno-bmi2 -mno-tbm -mavx -mno-avx2 -msse4.2 -msse4.1 \
  -mno-lzcnt -mno-rdrnd -mno-f16c -mno-fsgsbase --param l1-cache-size=32 \
  --param l1-cache-line-size=64 --param l2-cache-size=6144 -mtune=corei7-avx
</pre>}}

== Дополнения Distcc ==

=== Мониторы Distcc === 

Distcc поставляется с двумя мониторами. Текстовый монитор собирается всегда и называется <code>distccmon-text</code> . Запуск его в течение первого времени может слегка запутать, но на самом деле его достаточно просто использовать. Если Вы запускаете программу без параметра, она запустится один раз. Однако, если Вы передаете ей число, она будет обновляться каждые N секунд, где N - это переданный аргумент. 

Другой монитор включается только при включении USE-флага <code>gtk</code>. Этот монитор основан на GTK+, запускается в окружении X и достаточно приятен в использовании. В Gentoo GUI-монитор называется <code>distccmon-gui</code>, чтобы устранить путаницу. В других местах он может называться <code>distccmon-gnome</code>.

{{RootCmd|distccmon-text N}}

или запустите <code>distccmon-gui</code>:

{{RootCmd|distccmon-gui}}

Чтобы наблюдать за использованием портежем distcc, Вы можете использовать
{{RootCmd|DISTCC_DIR{{=}}"/var/tmp/portage/.distcc/" distccmon-text N
|DISTCC_DIR{{=}}"/var/tmp/portage/.distcc/" distccmon-gui}}

{{Important/ru|Если Ваш каталог distcc находится где-нибудь в другом месте, измените переменную DISTCC_DIR соответствующим образом.}}

== Благодарности ==

Мы хотели бы поблагодарить следующих авторов и редакторов за их вклад в это руководство:

* Lisa Seelye
* Mike Frysinger
* Erwin
* Sven Vermeulen
* Lars Weiler
* Tiemo Kieft
* nightmorph
