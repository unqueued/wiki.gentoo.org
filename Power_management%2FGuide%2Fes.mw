<languages />


{{Metadata|abstract=En los últimos años, la gestión de la energía ha sido una de las características diferenciadoras en la búsqueda del equipo portátil perfecto. El sistema operativo ofrece soporte a varias funcionalidades. En esta guía, cubrimos cómo configurar su instalación Gentoo de modo que gestione los recursos que tengan un alto consumo de forma flexible y automática.}}

En los últimos años, la gestión de la energía ha sido una de las características diferenciadoras en la búsqueda del equipo portátil perfecto. El sistema operativo ofrece soporte a varias funcionalidades. En esta guía, cubrimos cómo configurar su instalación Gentoo de modo que gestione los recursos que tengan un alto consumo de forma flexible y automática.

== Introducción ==

=== Acerca de este documento ===

Este documento describe cómo configurar las características de gestión de la energía en equipos portátiles. Aunque alguna de la información contenida en esta guía se puede aplicar a la gestión de la energía en equipos servidor, este documento no está orientado a este tipo de equipos. Por favor, sea cuidadoso cuando aplique esto a un sistema que no sea portátil. 

Dentro de este documento, lo primero será centrarse en las herramientas para el modo portátil ya que ofrece un conjunto completo de funcionalidades. Sin embargo, también haremos referencia a otras herramientas que podrían ofrecer un enfoque más detallado en los ajustes individuales. En estos casos, necesitará deshabilitar la característica de las herramientas para el modo portátil de modo que ambas herramientas no rivalizan por el control de los mismos recursos. 

=== Acerca de laptop_mode ===

El ajuste laptop_mode es un ajuste de configuración dentro del núcleo que optimiza la E/S permitiendo que los discos giren más despacio (y no se arranquen de nuevo justo después de operaciones que están en cola). 

=== Acerca de laptop-mode-tools ===

Las herramientas del modo portátil (''Laptop Mode Tools'') se incluyen en un paquete de software ({{Package|app-laptop/laptop-mode-tools}}) que permite al usuario optimizar las funciones de ahorro de energía. Permite la gestión del ajuste laptop_mode setting en el núcleo Linux y dispone de características adicionales que permiten ajustar otras características relacionadas con la energía dentro del sistema. 

== Configuración del nucleo Linux ==

=== Configuración mínima del núcleo ===

Existen diferentes fuentes del núcleo en Portage. Recomendamos utilizar {{Package|sys-kernel/gentoo-sources}}, sin embargo, si desea soporte avanzado para hibernación, se podría necesitar {{Package|sys-kernel/tuxonice-sources}}. Para habilitar la características propias de la gestión de la energía en el núcleo Linux, se deben habilitar los siguientes ajustes: 

{{KernelBox|title=Configuración mínima para la gestión de la energía|1=<pre>
Power management and ACPI options --->
  [*] Run-time PM core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
    [*] Power Management Timer Support
  
  [*] CPU Frequency scaling --->
    [*] CPU Frequency scaling
    <*>   'performance' governor
    <*>   'powersave' governor
    <*>   'userspace' governor
    <*>   'ondemand' governor
    <*>   'conservative' governor
    <*> ACPI Processor P-States driver
</pre>}}

No olvide habilitar el controlador de escalado de frecuencia para la CPU, el cual está localizado justo después de la opción ''ACPI Processor P-States driver'' mencionada arriba. 

Construya e instale el nuevo núcleo (si ello es necesario) y reinicie el sistema. 

== Usar las herramientas para modo portátil (Laptop Mode Tools) ==

=== Instalación ===

No sorprende saber que la instalación del software  ''Laptop Mode Tools'' se realiza de forma fácil mediante <kbd>emerge app-laptop/laptop-mode-tools</kbd>. Sin embargo, este paquete ofrece ajustes adicionales a través de la configuración de USE. Por ello, en primer lugar echaremos un vistazo a los ajustes USE soportados y qué hacen en el paquete. 

{| class="wikitable" style="text-align: left;" 
|- 
! Ajuste USE
! Descripción
! Se sugiere su uso cuando...
|- 
| acpi
| Depender de {{Package|sys-power/acpid}}, de modo que los cambios en el sistema se capturan y las características de ahorro de energía se habilitan o deshabilitan de forma automática.
| El portátil no es tan antiguo (del año 2003 y más tarde).
|- 
| apm
| Depender de {{Package|sys-apps/apmd}} de modo que los cambios en el sistema se capturan y las características de ahorro de energía se habilitan o deshabilitan de forma automática.
| El portátil es muy antiguo.
|- 
| bluetooth
| Depender de {{Package|net-wireless/bluez}}, se habilita laptop-mode-tools para gestionar los ajustes de bluetooth (se habilita o deshabilita el servicio basándose en la disponibilidad de la batería)
| El portátil (y el núcleo) ofrece soporte para bluetooth.
|- 
| scsi
| Depender de {{Package|sys-apps/sdparm}}, se habilita laptop-mode-tools para gestionar los parámetros de disco SCSI (''no'' SATA).
| El portátil utiliza discos SCSI.
|-
|}

Como se puede ver, hay dos ajustes USE que parecen ser incompatibles: <code>acpi</code> y <code>apm</code>. ¿Qué ocurre aquí? 

* El ajuste USE <code>apm</code> habilita el soporte de la ''Gestión Avanzada de Energía'', y los anteriores (al año 2000) estándares de las características para la gestión de la energía dentro del sistema.
* El ajuste USE <code>acpi</code> habilita el soporte para la ''Configuración e Interfaz de Energía Avanzadas'' , el sucesor de APM. Todos los portátiles modernos ofrecen soporte para ACPI.

Dependiendo del sistema, se necesitará <code>acpi</code> o <code>apm</code>. En el resto de esta guía asumiremos que el portátil es lo suficientemente reciente para poder utilizar ACPI. 

Así, con el conjunto de ajustes USE, instalar laptop-mode-tools:

{{Emerge|laptop-mode-tools}}

=== Configuración ===

El hecho de tener laptop-mode-tools instalado en el sistema no habilita de forma automática las características de ahorro de energía que se pueden necesitar. Para configurar el paquete, en primer lugar se debe echar un vistazo a {{Path|/etc/laptop-mode/laptop-mode.conf}}. Este el el fichero de configuración principal del paquete y está muy bien descrito (mediante comentarios). 

Sin embargo, este no es el único fichero de configuración con el que se trabaja. El paquete laptop-mode-tools soporta añadidos (plugins o módulos) que tienen su propio fichero o ficheros de configuración. Estos ficheros se localizan en {{Path|/etc/laptop-mode/conf.d}} y se nombran del mismo modo que el módulo que representas (por ejemplo {{Path|intel-sata-powermgmt.conf}}). 

Uno de los ajustes más importantes en todos los ficheros de configuración consiste en indicar si el paquete laptop-mode-tools debería gobernar un ajuste en particular o no. Esto es importante si se quiere combinar laptop-mode-tools con otros servicios como cpufreqd. En este caso se necesitará definir <code>CONTROL_CPU_FREQUENCY=0</code>: 

{{FileBox|filename=/etc/laptop-mode/conf.d/cpufreq.conf|1=
CONTROL_CPU_FREQUENCY=0
}}

Las siguientes secciones ayudan al usuario a configurar laptop-mode-tools para que se ajuste a sus necesidades específicas. Cuando se termine, arrancar el servicio laptop_mode y asegurarse de que se arranque en cada inicio del sistema. 

{{RootCmd|/etc/init.d/laptop_mode start
|rc-update add laptop_mode default}}

=== Cómo funciona laptop-mode-tools ===

Cuando se corre el servicio laptop_mode, el software comprobará en qué estado se encuentra el sistema. Los estados se definen como: 

*  ''Battery'', se activa cuando el sistema está funcionando con energía procedente de la batería. Los ficheros de configuración utilizan el prefijo <code>BATT_</code> para los ajustes relacionados con este estado
*  ''AC'', se activa cuando el sistema está funcionando con energía procedente de la red. Los ficheros de configuración utilizan el prefijo <code>AC_</code> para los ajustes relacionados con este estado
*  ''Laptop Mode'', se activa cuando se habilita el ''modo portátil''. Los ficheros de configuración utilizan el prefijo <code>LM_</code> para los ajustes relacionados con este estado
*  ''No Laptop Mode'', se activa cuando se deshabilita el ''modo portátil''. Los ficheros de configuración utilizan el prefijo <code>NOLM_</code> para los ajustes relacionados con este estado

Los prefijos <code>AC/BATT_</code> y <code>LM/NOLM_</code> se pueden combinar (de modo que se puede tener un prefijo <code>AC_LM_</code>). 

Cuando se arranca el servicio laptop_mode, conmutará los modos basados en los eventos que sucedan (y, por supuesto, se basará en los ajustes de la configuración). Por ejemplo, el ajuste <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code> asegurará que la herramientas del modo portátil cambian a ''laptop mode'' cuando se utilice la batería. En este caso, se utlizarán los ajustes que comienzan por <code>LM_</code>, <code>LM_BATT_</code>, <code>BATT_LM_</code> y <code>BATT_</code>. 

Para asegurarse de que los ajustes no interfieren, no se permitirán que se solapen. En el siguiente ejemplo, el primer conjunto (para <code>CPU_MAXFREQ</code>) es valido, sin embargo, el segundo (para <code>CPU_GOVERNOR</code>) no lo es. 

{{CodeBox|title=Ajustes incompatibles|1=
## Conjunto válido
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Conjunto inválido
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# Lo siguiente incluye AC y BATT, sin embargo BATT ya está definido
NOLM_CPU_MINFREQ=fastest
}}

=== Configurar la gestión de la frecuencia de la CPU ===

El soporte para la gestión de la gestión de la frecuencia de la CPU en las herramientas del modo portátil permiten el cambio de frecuencias. Soporta el ajuste del gobernador de la frecuencia de la CPU y las frecuencias máxima y mínima. El fichero de configuración que se utiliza en este caso es {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}}

El ''Gobernador de frecuencia de la CPU'' es una directriz del nivel del núcleo que define cómo éste seleccionará la frecuencia de la CPU. Ya se seleccionaron los gobernadores que se utilizaron en la configuración del núcleo anteriormente. Recapitularemos: 

*  <code>performance</code> siempre selecciona la máxima frecuencia
*  <code>powersave</code> siempre selecciona la mínima frecuencia
*  <code>userspace</code> no selecciona nada en particular, por el contrario, deja que decida el usuario (o cualquier proces que el usuario esté corriendo el cual decidirá en nombre del usuario)
*  <code>ondemand</code> escalará la frecuencia de la CPU hasta la máxima cuando haya carga
*  <code>conservative</code> escalará la frecuencia de la CPU de forma gradual cuando haya carga

Cuando se conmuta entre red eléctrica y batería o modo portátil (o no), se selecciona el gobernador apropiado (así como su mínima y máxima frecuencia). 

=== Configurar el brillo de la pantalla ===

Con {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}}, las herramientas del modo portátil pueden gestionar el brillo de la pantalla LCD. 

El fichero utiliza actualmente {{Path|/proc/acpi/video/VID/LCD/brightness}} ([https://bugs.gentoo.org/show_bug.cgi?id=499544 incidencia 499544]) para ajustar los valores para el brillo de la pantalla. Los núcleos actuales ya no ofrecen esto, en su lugar se necesitará ajustar esto en {{Path|/sys/class/backlight/acpi_video0/brightness}}. 

Los valores posibles que se pueden utlizar están entre cero y el valor de {{Path|/sys/class/backlight/acpi_video0/max_brightness}}, siendo cero el valor más bajo para el brillo.

=== Configurar otros servicios ===

Una característica interesante de laptop-mode-tools es el soporte que ofrece a la recarga de algunos servicios en particular (por ejemplo la bitácora del sistema) después de conmutar su fichero de configuración. Esto se gestiona a través de {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}} 

Si se habilita, la aplicación laptop_mode conmutará el o los ficheros de configuración de los servicios mencionados con el mismo fichero, pero con un sufijo {{Path|-nolm-ac}} , {{Path|-lm-ac}} o {{Path|-batt}}. Entonces enviará una señal o recargará los servicios apropiados de modo que puedan utilizar el nuevo fichero de configuración. 

== Usar cpufreqd ==

{{Warning|El paquete {{Package|sys-power/cpufreqd}} es obsoleto y se ha eliminado del árbol de Portage}}

=== Instalación ===

La aplicación <tt>cpufreqd</tt> permite al usuario gestionar la frecuencia de la CPU con un enfoque más granular que el que ofrece laptop-mode-tools. Sin embargo, antes de entrar en detalles sobre la instalación de cpufreqd, echemos un vistazo a los ajustes USE que soporta. 

{| class="wikitable" style="text-align: left;" 
|- 
! Ajuste USE
! Descripción
! Se sugiere su uso cuando...
|- 
| <code>acpi</code>
| Habilita el soporte para ACPI, permitiendo que se notifique a cpufreqd acerca de eventos específicos así como la gestión de la energía a través del interfaz ACPI.
| El portátil no es tan antiguo (del año 2003 y más tarde).
|- 
| <code>apm</code>
| Habilita el soporte para APM, permitiendo que se notifique a cpufreqd acerca de eventos específicos así como la gesión de la energía a través del interfaz APM.
| El portátil es muy antiguo
|- 
| <code>lm_sensors</code>
| Habilita el soporte para los sensores hardware de Linux (a través del paquete {{Package|sys-apps/lm_sensors}}), permitiendo conmutar entre perfiles basándose en los resultados que ofrecen los sensores hardware.
| Se utilicen eventos avanzados a través de lm_sensors.
|- 
| <code>nforce2</code>
| Habilita soporte para NForce, permitiendo a cpufreqd cambiar el reloj FSB de NForce FSB y la frecuencia de la tarjeta de vídeo.
| Se dispone de una tarjeta gráfica NVidia con chipset NForce.
|- 
| <code>nvidia</code>
| Habilita soporte para la configuración de la tarjeta gráfica NVidia (a través del interfaz ''nvclock'' de  NVidia), permitiendo a <code>cpufreqd</code>cambiar la frecuencia de la tarjeta de vídeo de las tarjetas gráficas NVidia.
| Se dispone de una tarjeta gráfica NVidia.
|- 
| <code>pmu</code>
| Habilita el complemento Power Management Unit de cpufreqd. Esto permite que el software pueda sondear la interfaz de administración de la energía del núcleo Linux, obteniendo información más detallada sobre la carga de la batería.
| El portátil no ofrece soporte para ACPI ni para APM.
|-
|}

Los ajustes USE <code>acpi</code>, <code>apm</code> y <code>pmu</code> se solapan, de modo que solo uno de ellos puede estar activo. Si el portátil es lo suficientemente reciente, la mejor apuesta es <code>acpi</code>. Si no, <code>apm</code> ofrece todo lo que se necesita. Si no se puede utilizar APM, pruebe con <code>pmu</code>. 

Cuando se hayan configurado los ajustes USE, es el momento de instalar <tt>cpufreqd</tt>. 

{{Emerge|cpufreqd}}

=== Configuración ===

La aplicación cpufreqd monitoriza el estado del sistema mediante varios complementos. Basándose en las sugerencias que se reciben sobre estos complementos, se ajusta la directriz para gobernar la frecuencia de la CPU. 

cpufreqd se puede configurar a través del fichero {{Path|/etc/cpufreqd.conf}}. Contiene tres secciones diferenciadas: 

# The <code>[General]...[/General]</code> section contains general configuration information
# The <code>[Profile]...[/Profile]</code> section defines the policies that the cpufreqd daemon can switch to. The section is very similar to the information you use when manually setting the CPU frequency policy using cpufreq-set.
# The <code>[Rule]...[/Rule]</code> section is the work-horse of the cpufreqd daemon, defining when the daemon decides to switch to a different profile.

Take a quick look at an example rule. 

{{FileBox|filename=/etc/cpufreqd.conf|title=Regla ejemplo de cpufreqd|1=
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
}}

In the above example, cpufreqd will switch the system to the ''On Demand High'' profile (also shown in the above excerpt). This profile by itself uses the ondemand governor with a minimum frequency of 40% (iow, a CPU of 2 GHz will have by this policy a minimum frequency of 800 MHz). 

As you can see, the cpufreqd application can offer a more granular approach on CPU frequency scaling. But not only that, you can tweak the CPU frequency scaling based on various other metrics available. The default configuration offers a sample rule for when you watch a movie, where you want maximum performance, unless the CPU temperature is getting too high. 

When you have configured cpufreqd, it is time to start it (and make sure the service is loaded automatically). Make sure that CPU frequency handling by other tools (like laptop-mode-tools) is disabled! 

{{RootCmd|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start}}

== Resources ==

=== Tools ===

*  [http://samwel.tk/laptop_mode/ Página oficial de Laptop Mode Tools], incluye el [http://samwel.tk/laptop_mode/laptop_mode acerca del modo portátil].
*  [https://01.org/powertop PowerTOP], una aplicación interactiva que ayuda a los usuarios a detectar los procesos que despiertan a la CPU más frecuentemente.

=== Artículos y guías ===

* Un artículo ThinkWiki acerca de  [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption Cómo reducir el gasto de energía] (en Linux). Este artículo ofrece una lista exhaustiva de medidas que se pueden tomar. Sin embargo, se debe tener en cuenta que las herramientas del modo portátil implementa la mayoría de ellas (si se ha configurado de forma correcta).

[[Category:Power management]]
