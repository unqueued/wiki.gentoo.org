<languages />


{{Metadata|abstract=En los últimos años, la gestión de la energía ha sido una de las características diferenciadoras en la búsqueda del equipo portátil perfecto. El sistema operativo ofrece soporte a varias funcionalidades. En esta guía, cubrimos cómo configurar su instalación Gentoo de modo que gestione los recursos que tengan un alto consumo de forma flexible y automática.}}

En los últimos años, la gestión de la energía ha sido una de las características diferenciadoras en la búsqueda del equipo portátil perfecto. El sistema operativo ofrece soporte a varias funcionalidades. En esta guía, cubrimos cómo configurar su instalación Gentoo de modo que gestione los recursos que tengan un alto consumo de forma flexible y automática.

== Introducción ==

=== Acerca de este documento ===

Este documento describe cómo configurar las características de gestión de la energía en equipos portátiles. Aunque alguna de la información contenida en esta guía se puede aplicar a la gestión de la energía en equipos servidor, este documento no está orientado a este tipo de equipos. Por favor, sea cuidadoso cuando aplique esto a un sistema que no sea portátil. 

Dentro de este documento, lo primero será centrarse en las herramientas para el modo portátil ya que ofrece un conjunto completo de funcionalidades. Sin embargo, también haremos referencia a otras herramientas que podrían ofrecer un enfoque más detallado en los ajustes individuales. En estos casos, necesitará deshabilitar la característica de las herramientas para el modo portátil de modo que ambas herramientas no rivalizan por el control de los mismos recursos. 

=== Acerca de laptop_mode ===

El ajuste laptop_mode es un ajuste de configuración dentro del núcleo que optimiza la E/S permitiendo que los discos giren más despacio (y no se arranquen de nuevo justo después de operaciones que están en cola). 

=== Acerca de laptop-mode-tools ===

Las herramientas del modo portátil (''Laptop Mode Tools'') se incluyen en un paquete de software ({{Package|app-laptop/laptop-mode-tools}}) que permite al usuario optimizar las funciones de ahorro de energía. Permite la gestión del ajuste laptop_mode setting en el núcleo Linux y dispone de características adicionales que permiten ajustar otras características relacionadas con la energía dentro del sistema. 

== Configuración del nucleo Linux ==

=== Configuración mínima del núcleo ===

Existen diferentes fuentes del núcleo en Portage. Recomendamos utilizar {{Package|sys-kernel/gentoo-sources}}, sin embargo, si desea soporte avanzado para hibernación, se podría necesitar {{Package|sys-kernel/tuxonice-sources}}. Para habilitar la características propias de la gestión de la energía en el núcleo Linux, se deben habilitar los siguientes ajustes: 

{{KernelBox|title=Configuración mínima para la gestión de la energía|1=<pre>
Power management and ACPI options --->
  [*] Run-time PM core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
    [*] Power Management Timer Support
  
  [*] CPU Frequency scaling --->
    [*] CPU Frequency scaling
    <*>   'performance' governor
    <*>   'powersave' governor
    <*>   'userspace' governor
    <*>   'ondemand' governor
    <*>   'conservative' governor
    <*> ACPI Processor P-States driver
</pre>}}

No olvide habilitar el controlador de escalado de frecuencia para la CPU, el cual está localizado justo después de la opción ''ACPI Processor P-States driver'' mencionada arriba. 

Construya e instale el nuevo núcleo (si ello es necesario) y reinicie el sistema. 

== Usar las herramientas para modo portátil (Laptop Mode Tools) ==

=== Instalación ===

No sorprende saber que la instalación del software  ''Laptop Mode Tools'' se realiza de forma fácil mediante <kbd>emerge app-laptop/laptop-mode-tools</kbd>. Sin embargo, este paquete ofrece ajustes adicionales a través de la configuración de USE. Por ello, en primer lugar echaremos un vistazo a los ajustes USE soportados y qué hacen en el paquete. 

{| class="wikitable" style="text-align: left;" 
|- 
! Ajuste USE
! Descripción
! Se sugiere cuando...
|- 
| acpi
| Depender de {{Package|sys-power/acpid}}, de modo que los cambios en el sistema se capturan y las características de ahorro de energía se habilitan o deshabilitan de forma automática.
| El portátil no es tan antiguo (del año 2003 y posteriores).
|- 
| apm
| Depender de {{Package|sys-apps/apmd}} de modo que los cambios en el sistema se capturan y las características de ahorro de energía se habilitan o deshabilitan de forma automática.
| El portátil es muy antiguo.
|- 
| bluetooth
| Depender de {{Package|net-wireless/bluez}}, se habilita laptop-mode-tools para gestionar los ajustes de bluetooth (se habilita o deshabilita el servicio basándose en la disponibilidad de la batería)
| El portátil (y el núcleo) ofrece soporte para bluetooth.
|- 
| scsi
| Depender de {{Package|sys-apps/sdparm}}, se habilita laptop-mode-tools para gestionar los parámetros de disco SCSI (''no'' SATA).
| El portátil utiliza discos SCSI.
|-
|}

Como se puede ver, hay dos ajustes USE que parecen ser incompatibles: <code>acpi</code> y <code>apm</code>. ¿Qué ocurre aquí? 

* El ajuste USE <code>apm</code> habilita el soporte de la ''Gestión Avanzada de Energía'', y los anteriores (al año 2000) estándares de las características para la gestión de la energía dentro del sistema.
* El ajuste USE <code>acpi</code> habilita el soporte para la ''Configuración e Interfaz de Energía Avanzadas'' , el sucesor de APM. Todos los portátiles modernos ofrecen soporte para ACPI.

Dependiendo del sistema, se necesitará <code>acpi</code> o <code>apm</code>. En el resto de esta guía asumiremos que el portátil es lo suficientemente reciente para poder utilizar ACPI. 

Así, con el conjunto de ajustes USE, instalar laptop-mode-tools:

{{Emerge|laptop-mode-tools}}

=== Configuración ===

El hecho de tener laptop-mode-tools instalado en el sistema no habilita de forma automática las características de ahorro de energía que se pueden necesitar. Para configurar el paquete, en primer lugar se debe echar un vistazo a {{Path|/etc/laptop-mode/laptop-mode.conf}}. Este el el fichero de configuración principal del paquete y está muy bien descrito (mediante comentarios). 

Sin embargo, este no es el único fichero de configuración con el que se trabaja. El paquete laptop-mode-tools soporta añadidos (plugins o módulos) que tienen su propio fichero o ficheros de configuración. Estos ficheros se localizan en {{Path|/etc/laptop-mode/conf.d}} y se nombran del mismo modo que el módulo que representas (por ejemplo {{Path|intel-sata-powermgmt.conf}}). 

Uno de los ajustes más importantes en todos los ficheros de configuración consiste en indicar si el paquete laptop-mode-tools debería gobernar un ajuste en particular o no. Esto es importante si se quiere combinar laptop-mode-tools con otros servicios como cpufreqd. En este caso se necesitará definir <code>CONTROL_CPU_FREQUENCY=0</code>: 

{{FileBox|filename=/etc/laptop-mode/conf.d/cpufreq.conf|1=
CONTROL_CPU_FREQUENCY=0
}}

Las siguientes secciones ayudan al usuario a configurar laptop-mode-tools para que se ajuste a sus necesidades específicas. Cuando se termine, arrancar el servicio laptop_mode y asegurarse de que se arranque en cada inicio del sistema. 

{{RootCmd|/etc/init.d/laptop_mode start
|rc-update add laptop_mode default}}

=== Cómo funciona laptop-mode-tools ===

Cuando se corre el servicio laptop_mode, el software comprobará en qué estado se encuentra el sistema. Los estados se definen como: 

*  ''Battery'', se activa cuando el sistema está funcionando con energía procedente de la batería. Los ficheros de configuración utilizan el prefijo <code>BATT_</code> para los ajustes relacionados con este estado
*  ''AC'', se activa cuando el sistema está funcionando con energía procedente de la red. Los ficheros de configuración utilizan el prefijo <code>AC_</code> para los ajustes relacionados con este estado
*  ''Laptop Mode'', se activa cuando se habilita el ''modo portátil''. Los ficheros de configuración utilizan el prefijo <code>LM_</code> para los ajustes relacionados con este estado
*  ''No Laptop Mode'', se activa cuando se deshabilita el ''modo portátil''. Los ficheros de configuración utilizan el prefijo <code>NOLM_</code> para los ajustes relacionados con este estado

Los prefijos <code>AC/BATT_</code> y <code>LM/NOLM_</code> se pueden combinar (de modo que se puede tener un prefijo <code>AC_LM_</code>). 

When the laptop_mode service is started, it will switch modes based on events that occur (and of course based on the configuration settings). For instance, the setting <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code> will make sure that the laptop mode tools switch to ''laptop mode'' when battery power is used. If that is the case, then the settings starting with <code>LM_</code>, <code>LM_BATT_</code>, <code>BATT_LM_</code>, and <code>BATT_</code> will be used. 

To make sure settings to not collide, it is not allowed to have overlapping settings. In the next example, the first set (for <code>CPU_MAXFREQ</code>) is valid, but the second one (for <code>CPU_GOVERNOR</code>) is not. 

{{CodeBox|title=Ajustes incompatibles|1=
## Conjunto válido
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Conjunto inválido
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# Lo siguiente incluye AC y BATT, sin embargo BATT ya está definido
NOLM_CPU_MINFREQ=fastest
}}

=== Configuring CPU frequency management ===

The support for CPU frequency management in the laptop mode tools allows switching frequencies. It supports setting the CPU frequency governor, minimum frequency and maximum frequency. The configuration file used here is {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}}

The ''CPU frequency governor'' is a kernel-level policy that defines how the kernel will select the CPU frequency. We already selected the governors we want to use in the kernel configuration earlier. Let's recap: 

*  <code>performance</code> always picks the highest frequency;
*  <code>powersave</code> always picks the lowest frequency;
*  <code>userspace</code> does not pick anything, but lets the user decide (or any process that the user is running that will decide for the user);
*  <code>ondemand</code> will scale the CPU frequency up to the highest frequency when load is available;
*  <code>conservative</code> will scale the CPU frequency up gradually when load is available.

When switching between AC or battery, or (no) laptop mode, the appropriate governor (as well as its minimum and maximum frequency) is selected. 

=== Configuring display brightness ===

With {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}}, the laptop mode tools can govern the brightness of the LCD screen. 

The file currently uses the {{Path|/proc/acpi/video/VID/LCD/brightness}} file ([https://bugs.gentoo.org/show_bug.cgi?id=499544 bug 499544]) to set brightness values. Recent kernels do not provide this anymore; it will need to adjust this to {{Path|/sys/class/backlight/acpi_video0/brightness}} instead. 

The possible values that can be used are between 0 and the value in {{Path|/sys/class/backlight/acpi_video0/max_brightness}}, with 0 being the lowest brightness value.

=== Configuring other services ===

An interesting feature of laptop-mode-tools is to support reloading particular services (like the system logger) after switching its configuration file. This is handled through {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}} 

If enabled, the laptop_mode application will switch the configuration file(s) of the mentioned services with the same file, but suffixed with {{Path|-nolm-ac}} , {{Path|-lm-ac}} or {{Path|-batt}}. It will then signal or reload the appropriate services so they can use the new configuration file. 

== Using cpufreqd ==

{{Warning|El paquete {{Package|sys-power/cpufreqd}} es obsoleto y se ha eliminado del árbol de Portage}}

=== Installation ===

The <tt>cpufreqd</tt> application allows the user to manage CPU frequencies in a more granular approach than what laptop-mode-tools supports. But before we dive into the installation of cpufreqd, let us first look at the USE flags it supports. 

{| class="wikitable" style="text-align: left;" 
|- 
! USE flag
! Description
! Suggested when...
|- 
| <code>acpi</code>
| Enable support for ACPI, allowing cpufreqd to be notified about specific events as well as govern power through the ACPI interface
| the laptop is not very old (around year 2003 and later)
|- 
| <code>apm</code>
| Enable support for APM, allowing cpufreqd to be notified about specific events as well as govern power through the APM interface
| the laptop is very old
|- 
| <code>lm_sensors</code>
| Enable support for the Linux hardware sensors (through {{Package|sys-apps/lm_sensors}}), allowing to switch profiles based on hardware sensor results
| using advanced events through lm_sensors
|- 
| <code>nforce2</code>
| Enable support for NForce, allowing cpufreqd to change the NForce FSB clock and video card frequency
| an NVidia graphics card based on the NForce chipset is present
|- 
| <code>nvidia</code>
| Enable support for NVidia graphical card configuration (through the NVidia ''nvclock'' interface), allowing <code>cpufreqd</code> to change the video card frequency of NVidia graphical cards
| an NVidia graphics card is present
|- 
| <code>pmu</code>
| Enable the Power Management Unit plug-in of cpufreqd. This allows the software to poll the Linux kernel Power Supply interface, getting more detailed information on battery charge.
| the laptop does not support ACPI or APM
|-
|}

The <code>acpi</code>, <code>apm</code>, and <code>pmu</code> USE overlap, so only one should be active. If the laptop is sufficiently recent, <code>acpi</code> is the best bet. If not, <code>apm</code> offers all that is needed. When even APM isn't supported, try using <code>pmu</code>. 

With the USE flags configured, it is time to install <tt>cpufreqd</tt>. 

{{Emerge|cpufreqd}}

=== Configuration ===

The cpufreqd application monitors the status of the system through several plugins. Based on the feedback it receives from those plugins, it will adjust the policy used to govern the CPU frequency. 

cpufreqd can be configured by editing {{Path|/etc/cpufreqd.conf}} It contains three different sections: 

# The <code>[General]...[/General]</code> section contains general configuration information
# The <code>[Profile]...[/Profile]</code> section defines the policies that the cpufreqd daemon can switch to. The section is very similar to the information you use when manually setting the CPU frequency policy using cpufreq-set.
# The <code>[Rule]...[/Rule]</code> section is the work-horse of the cpufreqd daemon, defining when the daemon decides to switch to a different profile.

Take a quick look at an example rule. 

{{FileBox|filename=/etc/cpufreqd.conf|title=Regla ejemplo de cpufreqd|1=
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
}}

In the above example, cpufreqd will switch the system to the ''On Demand High'' profile (also shown in the above excerpt). This profile by itself uses the ondemand governor with a minimum frequency of 40% (iow, a CPU of 2 GHz will have by this policy a minimum frequency of 800 MHz). 

As you can see, the cpufreqd application can offer a more granular approach on CPU frequency scaling. But not only that, you can tweak the CPU frequency scaling based on various other metrics available. The default configuration offers a sample rule for when you watch a movie, where you want maximum performance, unless the CPU temperature is getting too high. 

When you have configured cpufreqd, it is time to start it (and make sure the service is loaded automatically). Make sure that CPU frequency handling by other tools (like laptop-mode-tools) is disabled! 

{{RootCmd|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start}}

== Resources ==

=== Tools ===

*  [http://samwel.tk/laptop_mode/ Página oficial de Laptop Mode Tools], incluye el [http://samwel.tk/laptop_mode/laptop_mode acerca del modo portátil].
*  [https://01.org/powertop PowerTOP], una aplicación interactiva que ayuda a los usuarios a detectar los procesos que despiertan a la CPU más frecuentemente.

=== Artículos y guías ===

* Un artículo ThinkWiki acerca de  [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption Cómo reducir el gasto de energía] (en Linux). Este artículo ofrece una lista exhaustiva de medidas que se pueden tomar. Sin embargo, se debe tener en cuenta que las herramientas del modo portátil implementa la mayoría de ellas (si se ha configurado de forma correcta).

[[Category:Power management]]
