<languages />


{{Metadata|abstract=En los últimos años, la gestión de la energía ha sido una de las características diferenciadoras en la búsqueda del equipo portátil perfecto. El sistema operativo ofrece soporte a varias funcionalidades. En esta guía, cubrimos cómo configurar una instalación Gentoo de modo que gestione los recursos que tengan un alto consumo de forma flexible y automática.}}

En los últimos años, la gestión de la energía ha sido una de las características diferenciadoras en la búsqueda del equipo portátil perfecto. El sistema operativo ofrece soporte a varias funcionalidades. En esta guía, cubrimos cómo configurar una instalación Gentoo de modo que gestione los recursos que tengan un alto consumo de forma flexible y automática.

== Introducción ==

=== Acerca de este documento ===

Este documento describe cómo configurar las características de gestión de la energía en equipos portátiles. Aunque alguna de la información contenida en esta guía se puede aplicar a la gestión de la energía en equipos servidor, este documento no está orientado a este tipo de equipos. Por favor, sea cuidadoso cuando aplique esto a un sistema que no sea portátil. 

Within this document, the primary focus will be on laptop mode tools since it offers a complete set of functionalities. However, we will also refer to other tools that might offer a more detailed approach on individual settings. In such cases, the feature from the laptop mode tools must be disabled so that both tools do not fight over the same resource control. 

=== Acerca de laptop_mode ===

El ajuste laptop_mode es un ajuste de configuración dentro del núcleo que optimiza la E/S permitiendo que los discos giren más despacio (y no se arranquen de nuevo justo después de operaciones que están en cola). 

=== Acerca de laptop-mode-tools ===

The ''Laptop Mode Tools'' is a software package ({{Package|app-laptop/laptop-mode-tools}}) which allows the user to optimize power saving functions. It allows managing the laptop_mode setting in the Linux kernel, but has additional features that allow the tweaking of other power-related settings on the system.

== Linux kernel configuration ==

=== Configuración mínima del núcleo ===

There are different kernel sources in Portage. We recommend using {{Package|sys-kernel/gentoo-sources}}, but if advanced hibernation support is desired, {{Package|sys-kernel/tuxonice-sources}} might be needed. To enable proper power management features in the Linux kernel, enable the following settings: 

{{KernelBox|title=Configuración mínima para la gestión de la energía|1=<pre>
Power management and ACPI options --->
  [*] Run-time PM core functionality
  [*] ACPI (Advanced Configuration and Power Interface) Support --->
    <*> AC Adapter
    <*> Battery
    -*- Button
    -*- Video
    <*> Fan
    <*> Processor
    <*> Thermal Zone
    [*] Power Management Timer Support
  
  [*] CPU Frequency scaling --->
    [*] CPU Frequency scaling
    <*>   'performance' governor
    <*>   'powersave' governor
    <*>   'userspace' governor
    <*>   'ondemand' governor
    <*>   'conservative' governor
    <*> ACPI Processor P-States driver
</pre>}}

No olvide habilitar el controlador de escalado de frecuencia para la CPU, el cual está localizado justo después de la opción ''ACPI Processor P-States driver'' mencionada arriba. 

Para una descripción más detallada consultar el artículo sobre [[Power_management/Processor/es#N.C3.BAcleo|el núcleo y la gestión de energía]].

[[Kernel/Rebuild|Construir e instalar]] el nuevo núcleo (si es necesario) y reiniciar.

== Usar las herramientas para modo portátil (Laptop Mode Tools) ==

=== Instalación ===

It comes to no surprise that installation of the ''Laptop Mode Tools'' software is easily done via:

{{Emerge|app-laptop/laptop-mode-tools}}.

However, this package takes on additional, optional settings through USE flag configuration. So let's first take a look at the supported USE flags and what they mean to the package. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! USE flag
! Description
! Suggested when...
|- 
| <code>acpi</code>
| Depend on {{Package|sys-power/acpid}} so that changes in the system are captured and power saving features are automatically enabled/disabled.
| the laptop is not too old (around year 2003 and later).
|- 
| <code>apm</code>
| Depend on {{Package|sys-apps/apmd}} so that changes in the system are captured and power saving features are automatically enabled/disabled.
| the laptop is very old.
|- 
| <code>bluetooth</code>
| Depend on {{Package|net-wireless/bluez}} , enabling laptop-mode-tools to manage bluetooth settings (enabling/disabling the service based on battery availability)
| the laptop (and kernel) support bluetooth.
|- 
| <code>scsi</code>
| Depend on {{Package|sys-apps/sdparm}} , enabling laptop-mode-tools to manage SCSI (''and not'' SATA) disk parameters.
| the laptop uses SCSI disks.
|-
|}

Observe there are two USE flags that seem to collide: <code>acpi</code> and <code>apm</code>. So what is the deal? 

* El ajuste USE <code>apm</code> habilita el soporte de la ''Gestión Avanzada de Energía'', y los anteriores (al año 2000) estándares de las características para la gestión de la energía dentro del sistema.
* El ajuste USE <code>acpi</code> habilita el soporte para la ''Configuración e Interfaz de Energía Avanzadas'' , el sucesor de APM. Todos los portátiles modernos ofrecen soporte para ACPI.

Depending on the system, either <code>acpi</code> or <code>apm</code> will need to be set. In the remainder of this guide, it is assumed the laptop is recent enough to use ACPI. 

Así, con el conjunto de ajustes USE, instalar laptop-mode-tools:

{{Emerge|laptop-mode-tools}}

=== Configuración ===

El hecho de tener laptop-mode-tools instalado en el sistema no habilita de forma automática las características de ahorro de energía que se pueden necesitar. Para configurar el paquete, en primer lugar se debe echar un vistazo a {{Path|/etc/laptop-mode/laptop-mode.conf}}. Este el el fichero de configuración principal del paquete y está muy bien descrito (mediante comentarios). 

Sin embargo, este no es el único fichero de configuración con el que se trabaja. El paquete laptop-mode-tools soporta añadidos (plugins o módulos) que tienen su propio fichero o ficheros de configuración. Estos ficheros se localizan en {{Path|/etc/laptop-mode/conf.d}} y se nombran del mismo modo que el módulo que representas (por ejemplo {{Path|intel-sata-powermgmt.conf}}). 

Now, one of the important settings in each configuration file is if the laptop-mode-tools package should govern a particular setting or not. This is important when combining laptop-mode-tools with other power management services such as {{c|cpufreqd}}. In this example case, <code>CONTROL_CPU_FREQUENCY=0</code> must be set: 

{{FileBox|filename=/etc/laptop-mode/conf.d/cpufreq.conf|1=
CONTROL_CPU_FREQUENCY=0
}}

Las siguientes secciones ayudan al usuario a configurar laptop-mode-tools para que se ajuste a sus necesidades específicas. Cuando se termine, arrancar el servicio laptop_mode y asegurarse de que se arranque en cada inicio del sistema. 

{{RootCmd
|rc-service laptop_mode start
|rc-update add laptop_mode default
}}

=== Cómo funciona laptop-mode-tools ===

Cuando se corre el servicio laptop_mode, el software comprobará en qué estado se encuentra el sistema. Los estados se definen como: 

*  ''Battery'', se activa cuando el sistema está funcionando con energía procedente de la batería. Los ficheros de configuración utilizan el prefijo <code>BATT_</code> para los ajustes relacionados con este estado
*  ''AC'', se activa cuando el sistema está funcionando con energía procedente de la red. Los ficheros de configuración utilizan el prefijo <code>AC_</code> para los ajustes relacionados con este estado
*  ''Laptop Mode'', se activa cuando se habilita el ''modo portátil''. Los ficheros de configuración utilizan el prefijo <code>LM_</code> para los ajustes relacionados con este estado
*  ''No Laptop Mode'', se activa cuando se deshabilita el ''modo portátil''. Los ficheros de configuración utilizan el prefijo <code>NOLM_</code> para los ajustes relacionados con este estado

The <var>AC/BATT_</var> and <var>LM/NOLM_</var> prefixes can be combined to have a <var>AC_LM_</var> prefix. 

Cuando se arranca el servicio laptop_mode, conmutará los modos basados en los eventos que sucedan (y, por supuesto, se basará en los ajustes de la configuración). Por ejemplo, el ajuste <code>ENABLE_LAPTOP_MODE_ON_BATTERY=1</code> asegurará que la herramientas del modo portátil cambian a ''laptop mode'' cuando se utilice la batería. En este caso, se utlizarán los ajustes que comienzan por <code>LM_</code>, <code>LM_BATT_</code>, <code>BATT_LM_</code> y <code>BATT_</code>. 

Para asegurarse de que los ajustes no interfieren, no se permitirán que se solapen. En el siguiente ejemplo, el primer conjunto (para <code>CPU_MAXFREQ</code>) es valido, sin embargo, el segundo (para <code>CPU_GOVERNOR</code>) no lo es. 

{{CodeBox|title=Ajustes incompatibles|1=
## Conjunto válido
BATT_CPU_MAXFREQ=fastest
LM_AC_CPU_MAXFREQ=fastest
NOLM_AC_CPU_MAXFREQ=fastest
  
## Conjunto inválido
BATT_CPU_MINFREQ=fastest
LM_AC_CPU_MINFREQ=fastest
# Lo siguiente incluye AC y BATT, sin embargo BATT ya está definido
NOLM_CPU_MINFREQ=fastest
}}

=== Configurar la gestión de la frecuencia de la CPU ===

El soporte para la gestión de la gestión de la frecuencia de la CPU en las herramientas del modo portátil permiten el cambio de frecuencias. Soporta el ajuste del gobernador de la frecuencia de la CPU y las frecuencias máxima y mínima. El fichero de configuración que se utiliza en este caso es {{Path|/etc/laptop-mode/conf.d/cpufreq.conf}}

El ''Gobernador de frecuencia de la CPU'' es una directriz del nivel del núcleo que define cómo éste seleccionará la frecuencia de la CPU. Ya se seleccionaron los gobernadores que se utilizaron en la configuración del núcleo anteriormente. Recapitularemos: 

*  <code>performance</code> siempre selecciona la máxima frecuencia
*  <code>powersave</code> siempre selecciona la mínima frecuencia
*  <code>userspace</code> no selecciona nada en particular, por el contrario, deja que decida el usuario (o cualquier proces que el usuario esté corriendo el cual decidirá en nombre del usuario)
*  <code>ondemand</code> escalará la frecuencia de la CPU hasta la máxima cuando haya carga
*  <code>conservative</code> escalará la frecuencia de la CPU de forma gradual cuando haya carga

Cuando se conmuta entre red eléctrica y batería o modo portátil (o no), se selecciona el gobernador apropiado (así como su mínima y máxima frecuencia). 

=== Configurar el brillo de la pantalla ===

Con {{Path|/etc/laptop-mode/conf.d/lcd-brightness.conf}}, las herramientas del modo portátil pueden gestionar el brillo de la pantalla LCD. 

El fichero utiliza actualmente {{Path|/proc/acpi/video/VID/LCD/brightness}} ([https://bugs.gentoo.org/show_bug.cgi?id=499544 incidencia 499544]) para ajustar los valores para el brillo de la pantalla. Los núcleos actuales ya no ofrecen esto, en su lugar se necesitará ajustar esto en {{Path|/sys/class/backlight/acpi_video0/brightness}}. 

Los valores posibles que se pueden utlizar están entre cero y el valor de {{Path|/sys/class/backlight/acpi_video0/max_brightness}}, siendo cero el valor más bajo para el brillo.

=== Configurar otros servicios ===

Una característica interesante de laptop-mode-tools es el soporte que ofrece a la recarga de algunos servicios en particular (por ejemplo la bitácora del sistema) después de conmutar su fichero de configuración. Esto se gestiona a través de {{Path|/etc/laptop-mode/conf.d/configuration-file-control.conf}} 

Si se habilita, la aplicación laptop_mode conmutará el o los ficheros de configuración de los servicios mencionados con el mismo fichero, pero con un sufijo {{Path|-nolm-ac}} , {{Path|-lm-ac}} o {{Path|-batt}}. Entonces enviará una señal o recargará los servicios apropiados de modo que puedan utilizar el nuevo fichero de configuración. 

== Usar cpufreqd ==

{{Warning|Package {{Package|sys-power/cpufreqd}} is deprecated and has been removed from the Portage tree. {{Package|sys-power/ncpufreqd}} can still be used for [https://bitbucket.org/nelchael/ncpufreqd 2.6.x kernels].
}}

=== Instalación ===

La aplicación {{c|cpufreqd}} permite al usuario gestionar la frecuencia de la CPU con un enfoque más granular que el que ofrece laptop-mode-tools. Sin embargo, antes de entrar en detalles sobre la instalación de {{c|cpufreqd}}, echemos un vistazo a los ajustes USE que soporta. 

{| class="table table-striped table-condensed" style="text-align: left;" 
|- 
! USE flag
! Description
! Suggested when...
|- 
| <code>acpi</code>
| Enable support for ACPI, allowing {{c|cpufreqd}} to be notified about specific events as well as govern power through the ACPI interface
| the laptop is not very old (around year 2003 and later)
|- 
| <code>apm</code>
| Enable support for APM, allowing {{c|cpufreqd}} to be notified about specific events as well as govern power through the APM interface
| the laptop is very old
|- 
| <code>lm_sensors</code>
| Enable support for the Linux hardware sensors (through {{Package|sys-apps/lm_sensors}}), allowing to switch profiles based on hardware sensor results
| using advanced events through lm_sensors
|- 
| <code>nforce2</code>
| Enable support for NForce, allowing {{c|cpufreqd}} to change the NForce FSB clock and video card frequency
| an NVidia graphics card based on the NForce chipset is present
|- 
| <code>nvidia</code>
| Enable support for NVidia graphical card configuration (through the NVidia ''nvclock'' interface), allowing {{c|cpufreqd}} to change the video card frequency of NVidia graphical cards
| an NVidia graphics card is present
|- 
| <code>pmu</code>
| Enable the Power Management Unit plug-in of {{c|cpufreqd}}. This allows the software to poll the Linux kernel Power Supply interface, getting more detailed information on battery charge
| the laptop does not support ACPI or APM
|-
|}

Los ajustes USE <code>acpi</code>, <code>apm</code> y <code>pmu</code> se solapan, de modo que solo uno de ellos puede estar activo. Si el portátil es lo suficientemente reciente, la mejor apuesta es <code>acpi</code>. Si no, <code>apm</code> ofrece todo lo que se necesita. Si no se puede utilizar APM, pruebe con <code>pmu</code>. 

Cuando se hayan configurado los ajustes USE, es el momento de instalar {{c|cpufreqd}}. 

{{Emerge|cpufreqd}}

=== Configuración ===

La aplicación {{c|cpufreqd}} monitoriza el estado del sistema mediante varios complementos. Basándose en las sugerencias que se reciben sobre estos complementos, se ajusta la directriz para gobernar la frecuencia de la CPU. 

{{c|cpufreqd}} se puede configurar a través del fichero {{Path|/etc/cpufreqd.conf}}. Contiene tres secciones diferenciadas: 

# The <code>[General]...[/General]</code> section contains general configuration information.
# The <code>[Profile]...[/Profile]</code> section defines the policies that the cpufreqd daemon can switch to. The section is very similar to the information used when manually setting the CPU frequency policy using cpufreq-set.
# The <code>[Rule]...[/Rule]</code> section is the work-horse of the cpufreqd daemon, defining when the daemon decides to switch to a different profile.

Echar un vistazo a la regla ejemplo. 

{{FileBox|filename=/etc/cpufreqd.conf|title=Regla ejemplo de cpufreqd|1=
[...]
  
[Profile]
name=On Demand High
minfreq=40%
maxfreq=100%
policy=ondemand
[/Profile]
  
[Rule]
name=AC Off - High Power
ac=off
battery_interval=70-100
profile=On Demand High
[/Rule]
  
[...]
}}

En el ejemplo de arriba, {{c|cpufreqd}} cambiará el perfil del sistema a ''On Demand High'' (también se muestra en el extracto de arriba). Este perfil por si mismo utiliza el gobernador bajo demanda con una frecuencia mínim del 40% (en otras palabras, una CPU de 2 GHz tendrá bajo esta directriz una frecuencia mínima de 800 MHz). 

The {{c|cpufreqd}} application can offer a more granular approach on CPU frequency scaling. But not only that, but the CPU frequency scaling can be tweaked based on various other metrics available. The default configuration offers a sample rule: when a movie is watched, maximum performance is desired (unless the CPU temperature is getting too high). 

When {{c|cpufreqd}} has been configured, it is time to start it (and make sure the service is loaded automatically). Make sure that CPU frequency handling by other tools (like laptop-mode-tools) is disabled! 

{{RootCmd
|rc-update add cpufreqd default
|/etc/init.d/cpufreqd start
}}

== Ver también ==

* [[USB Power Saving]]

== External resources ==

*  [http://samwel.tk/laptop_mode/ Laptop Mode Tools Homepage], includes [http://samwel.tk/laptop_mode/laptop_mode About laptop mode].
*  [https://01.org/powertop PowerTOP], an interactive application helping users to find out which processes are forcing wakeups on the CPU most often.
* A ThinkWiki article on [http://www.thinkwiki.org/wiki/How_to_reduce_power_consumption How to reduce power consumption] (on Linux). This article offers an exhaustive list of measures one can take. However, it should be noted that the laptop mode tools implements the majority of these (if properly configured).

[[Category:Power management]]
