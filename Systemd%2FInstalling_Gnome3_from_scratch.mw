<languages />
<translate>
{{Lowercase title}}
{{InfoBox stack
|{{InfoBox todo|Instructions for configuring a static IP|header=true}}
}}

{{Dated|date=2019-06-19}}

To install a desktop environment such as GNOME 3 requires the use of systemd but the present [[Handbook:Main Page|Gentoo Handbook]] is based on the use of OpenRC. It just indicates that changes have to be made when using systemd but never tells the user where the changes occur. 

As for the systemd page, it mainly concentrate on an update starting from an existing system. Thus, it can be a kind of challenge, especially for a new comer to Gentoo, to install a GNOME 3 desktop from scratch. The purpose of this page is to indicate where changes have to be made to the current [[Handbook:Main Page|Gentoo Handbook]] to do so.

The indications given refer mainly to an {{Keyword|amd64}} install.

== Base system installation ==

Hereafter are the modifications to bring to the [[Handbook:Main Page|Gentoo Handbook]] for an {{Keyword|amd64}} platform.

=== Part 1 to 5 of the handbook ===

No changes here.

===Installing the Gentoo base system ===

==== Choosing the right stage3 tarball ====

A stage3 tarball already configured for systemd is available for most architectures. You will find it along with the other stage3 tarballs in the autobuilds directory of your preferred mirror. To save time and effort, use this tarball when installing the base system.

==== Choosing the right profile ====

{{RootCmd|eselect profile list|output=<pre>
Available profile symlink targets:
  [16]  default/linux/amd64/17.1
  [17]  default/linux/amd64/17.1/selinux
  [18]  default/linux/amd64/17.1/hardened
  [19]  default/linux/amd64/17.1/hardened/selinux
  [20]  default/linux/amd64/17.1/desktop
  [21]  default/linux/amd64/17.1/desktop/gnome
  [22]  default/linux/amd64/17.1/desktop/gnome/systemd
  [23]  default/linux/amd64/17.1/desktop/plasma
  [24]  default/linux/amd64/17.1/desktop/plasma/systemd
  [25]  default/linux/amd64/17.1/developer
  [26]  default/linux/amd64/17.1/no-multilib
  [27]  default/linux/amd64/17.1/no-multilib/hardened
  [28]  default/linux/amd64/17.1/no-multilib/hardened/selinux
  [29]  default/linux/amd64/17.1/systemd
  [30]  default/linux/amd64/17.0/musl
  [31]  default/linux/amd64/17.0/musl/hardened
  [32]  default/linux/amd64/17.0/musl/hardened/selinux
</pre>}}

Select the profile ending in {{Path|gnome/systemd}}:

{{RootCmd|eselect profile set default/linux/amd64/17.1/desktop/gnome/systemd}}

On the {{Keyword|amd64}} platform there is also a profile ending in {{Path|systemd}}. Select this option if a desktop environment is not required for the system (servers, etc). 

An asterisk indicates the currently selected profile. Verify the correct profile has been selected:

{{RootCmd|eselect profile list|output=<pre>
Available profile symlink targets:
  [16]  default/linux/amd64/17.1 (stable)
  [17]  default/linux/amd64/17.1/selinux (stable)
  [18]  default/linux/amd64/17.1/hardened (stable)
  [19]  default/linux/amd64/17.1/hardened/selinux (stable)
  [20]  default/linux/amd64/17.1/desktop (stable)
  [21]  default/linux/amd64/17.1/desktop/gnome (stable)
  [22]  default/linux/amd64/17.1/desktop/gnome/systemd *
  [23]  default/linux/amd64/17.1/desktop/plasma
  [24]  default/linux/amd64/17.1/desktop/plasma/systemd 
  [25]  default/linux/amd64/17.1/developer
  [26]  default/linux/amd64/17.1/no-multilib
  [27]  default/linux/amd64/17.1/no-multilib/hardened
  [28]  default/linux/amd64/17.1/no-multilib/hardened/selinux
  [29]  default/linux/amd64/17.1/systemd 
  [30]  default/linux/amd64/17.0/musl
  [31]  default/linux/amd64/17.0/musl/hardened
  [32]  default/linux/amd64/17.0/musl/hardened/selinux
</pre>}}

==== Updating the system ====

The choice of the {{Path|desktop/gnome/systemd}} profile implies a lot of changes in the packages to be installed, it is advised to perform a full system update before going on:

{{Emerge| --update --deep --newuse @world}}

=== Configuring the kernel ===

Do not install {{Package|sys-kernel/genkernel}} when using systemd, use {{Package|sys-kernel/genkernel-next}} instead:

{{Emerge|sys-kernel/genkernel-next}}

{{Note|If your are using raid for your partitions, don't forget to add the <code>dmraid</code> USE flag while emerging {{Package|sys-kernel/genkernel-next}}.}}

When planning to include support for a graphic card that requires proprietary binary blobs be sure to emerge the {{Package|sys-kernel/linux-firmware}} package. Otherwise kernel will not compile.

{{Emerge|sys-kernel/linux-firmware}}

May not be necessary at this stage but does not hurt to add the <var>VIDEO_CARDS</var> variable set with an appropriate video card value to {{Path|/etc/portage/make.conf}}.

Use option ''menuconfig'' with genkernel and optionally ''lvm'' and ''mdadm'' when using lvm and RAID. Do not forget to install {{Package|sys-fs/lvm2}} and {{Package|sys-fs/mdadm}} if this is the case. Please see [[LVM#Software]] for details about lvm.

{{Emerge|sys-fs/lvm2}}

{{RootCmd|genkernel [--lvm] [--mdadm] --menuconfig all}}

Select the systemd init system without disabling Openrc

{{KernelBox|title=Quick setup using gentoo-sources|1=
Gentoo Linux --->
        Support for init systems, system and service managers --->
                [*]Openrc 
                [*] systemd
}}
 
When using lvm activate the following kernel options:

{{KernelBox|1=
Device Drivers  --->
   Multiple devices driver support (RAID and LVM)  --->
       <*> Device mapper support
           <*> Crypt target support
           <*> Snapshot target
           <*> Mirror target
       <*> Multipath target
           <*> I/O Path Selector based on the number of in-flight I/Os
           <*> I/O Path Selector based on the service time
}}

{{Note|Not everything needs to be enabled; some of the options are only needed for [[#LVM2_Snapshots_and_LVM2_Thin_Snapshots|LVM2 Snapshots and LVM2 Thin Snapshots]], [[#LVM2_Mirrors|LVM2 Mirrors]], [[#LVM2_RAID_0.2FStripeset|LVM2 RAID 0/Stripeset]] and encryption.}}
Include settings for your graphic card referring to the ad hoc page on this wiki, most currently [[radeon]] and [[NVIDIA/nvidia-drivers|nvidia-drivers]].

Create the symlink for {{Path|/etc/mtab}} (see [[Systemd#/etc/mtab|this]] for details)
{{RootCmd|ln -sf /proc/self/mounts /etc/mtab}}

=== Configuring the system ===

==== Defining the keyboard ====

With systemd, setting <code>keyboard=fr</code> into {{Path|/etc/conf.d/keymaps}} will be effectless. Instead, you should set this into {{Path|/etc/vconsole.conf}}.

The various keymaps are  stored into subdirectories of {{Path|/usr/share/keymaps/}} and can be listed with the following command
{{RootCmd|localectl list-keymaps}}

{{Note|When intending to use a very specific keymap (such as the French bepo typematrix keymap) that is not listed here, get it by any way at your disposal in the form of a .gz file, store it on a drive accessible to the system, mount this drive and copy it into one of the subdirectories of {{Path|/usr/share/keymaps/}}. Then run the previous command again to make sure it is available.}}

Once you have you keymap listed, select it with the following command, replacing <code>fr-dvorak-bepo</code> with your own keymap:

{{RootCmd|localectl set-keymap --no-convert fr-dvorak-bepo}}

Double check by running:

{{RootCmd|cat /etc/vconsole.conf}}

=== Installing necessary system tools ===

==== System logger ====

{{Note|syslog-ng or sysloggd are no longer necessary since [[Systemd]] comes with its own journaling functionality. It is possible to skip this section completely. Please, have also a look at the man page of '''journalctl''' or at this [https://wiki.archlinux.org/index.php/systemd#Journal more readable page] on the Arch Linux wiki (and its subsequents links) to know more about the {{c|journalctl}} command that allows you to read the entries of this journal. Nevertheless, the previous loggers can still be used in conjunction with systemd.}}
 
syslog-ng conflicts with systemd [https://wiki.gentoo.org/wiki/Systemd#syslog-ng_conflicts_with_systemd] systemd creates {{Path|/dev/log}} as datagram socket [https://bugzilla.redhat.com/show_bug.cgi?id=770810#c10] [https://fedoraproject.org/wiki/Common_F16_bugs#systemd-syslog-ng-problems] so you will need to tell syslog-ng to read from a ''unix-dgram'' instead of a ''unix-stream'' if you are hitting problems and are using "wrong" stream:

{{FileBox|filename=/etc/syslog-ng/syslog-ng.conf|1=
unix-stream('/dev/log');
}}

Should be replaced with:

{{FileBox|filename=/etc/syslog-ng/syslog-ng.conf|1=
unix-dgram('/dev/log');
}}

In order to use the syslog-ng service in systemd.

To enable syslog-ng use the following command:

{{RootCmd|systemctl enable syslog-ng}}

To disable it, use:

{{RootCmd|systemctl disable syslog-ng}}

==== Networking tools ====

dhcpcd will not be started at boot unless you enable dhcpcd.service with systemd.

Refer to the [[Systemd| systemd]] page to know how to do it before rebooting. Otherwise you will be able to do so after boot with:

{{RootCmd|systemctl enable dhcpcd.service}}

{{RootCmd|systemctl start dhcpcd.service}}

==== Installing systemd itself ====

{{Note|If you did the full update as advised before systemd should already be installed.}}

{{Emerge|sys-apps/systemd}}

{{Note|You don't have to add systemd flag to {{Path|/etc/portage/make.conf}} as it is already set into the chosen profile.}}

=== Configuring the bootloader ===

If you are using lvm, add the <code>device-mapper</code> USE flag before emerging grub.

After emerging {{Package|sys-boot/grub}}, edit the '''{{Path|/etc/default/grub}}''' configuration file and add the following line (if using ext4 for root partition):

{{FileBox|filename=/etc/default/grub|title=Example grub2-mkconfig config for systemd|lang=bash|1=
# Append parameters to the linux kernel command line
GRUB_CMDLINE_LINUX="rootfstype=ext4 real_init=/usr/lib/systemd/systemd dolvm domdadm"
}}

{{Note| ''dolvm'' and ''domdadm'' are required only if you are using lvm and raid.}}

Then run:

{{RootCmd
|mkdir /boot/grub
|grub2-mkconfig -o /boot/grub/grub.cfg
}}

=== Finalizing the installation ===

It may be necessary to enable and start dcpcd.service and to use systemd to define keyboard layout (see the [[systemd]] page).

== X server installation ==

=== Install xorg ===

==== /etc/portage/make.conf ====

Don't forget to add the following lines to the {{Path|/etc/portage/make.conf}} file:

{{FileBox|filename=/etc/portage/make.conf|lang= bash|1=
VIDEO_CARDS="radeon"
}}

{{Note|Replace radeon according to the card brand}}

Then emerge the drivers:

{{Emerge|x11-base/xorg-server}}

==== Kernel settings ====

Follow the page X server to set the kernel parameters for evdev and  the kernel parameters for your graphic card if not already done. Recompile the kernel

=== Check startx ===

In order to check the x server install {{Package|x11-terms/xterm}} and {{Package|x11-terms/twm}}:

{{Emerge|x11-terms/xterm x11-wm/twm}}

Then use the following command:

{{RootCmd|startx}}

If everything is correct, a graphic page with some terminals inside will appear. Quit by pressing {{Key|Ctrl}}+{{Key|Alt}}+{{Key|Del}} and remove {{Package|x11-terms/xterm}} and {{Package|x11-terms/twm}}:

{{Unmerge|x11-terms/xterm x11-wm/twm}}

== GNOME 3 installation ==

You are now ready to install GNOME 3:

{{emerge|gnome}}

{{Note|In my case, to solve a conflict between two versions of openssl one using the ''bindist'' USE flag and the other using the ''-bindist'' use flag, I had to add the ''-bindist'' USE flag to Openssh in {{Path|/etc/portage/package.use}} and re-emerge it with --newuse flag before installing GNOME.}}

In order to have the GNOME Display Manager after boot, enable it:

{{RootCmd|systemctl enable gdm.service}}

Reboot and enjoy GNOME 3 !

[[Category:Init systems]]

</translate>
