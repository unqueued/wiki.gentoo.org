<languages />
<translate>
== Requirements ==

=== Software ===

The following software can be used for in-kernel default suspend/hibernate implementation, namely, ''swsusp''.

{{Emerge
|sys-power/suspend
}}

Also [https://packages.gentoo.org/packages/sys-power/upower-pm-utils sys-power/upower-pm-utils] must be unmerged, merge [https://packages.gentoo.org/packages/sys-power/upower sys-power/upower], and merge [https://packages.gentoo.org/packages/sys-auth/consolekit sys-auth/consolekit] with USE="pm-utils" <ref>https://bugs.gentoo.org/show_bug.cgi?id=596988</ref>. Otherwise there might not be a "Suspend" and "Hibernate" button in the menu of the desktop environment.

{{Emerge
|sys-power/upower-pm-utils
|params=--unmerge
}}

{{Emerge
|sys-power/upower
}}

{{RootCmd
|echo "sys-auth/consolekit pm-utils" >> /etc/portage/package.use
|emerge --ask --oneshot sys-auth/consolekit
}}

Another alternative is {{Package|sys-power/hibernate-script}} which can be used with swsusp and TuxOnIce patched kernels.

=== Kernel ===
Make sure the following variables are set to 'yes':

{{KernelBox|
Power management and ACPI options --->
    [*] Suspend to RAM and standby
    [*] Hibernation (aka 'suspend to disk')
}}

== Available suspend modes ==
To see available suspend modes use
{{RootCmd|cat /sys/power/state}}
for swsusp, default implementation.

Or else, probe <code>/sys/power/tuxonice/powerdown_method</code> sysfs file for ToI.

Those two file will list at least [[ACPI]] S2/4 power down methods on modern hardware.
New hardware would also support S5 method which is a rough S4 method.
ACPI S2 correspond to suspend to ram (''ram'' method is swsusp terms and ''3'' in ToI terms);
S4 hibernation to disk (''disk'' in swsusp temrs and ''4'' in ToI terms; S5 hibernation to disk (''5'' in ToI terms).

Swsusp users can choose between ''platfom'', meaning ACPI, or *shutdown* methods which can be echo-ed to `/sys/power/disk' sysfs file.

{{Note|TuxOnIce can be configured to take over swsusp syspend/hibernation methods. So any command echo-ed to either file will triger the same result.}}

== Suspend to RAM ==

Preferred commands to suspend are:

{{RootCmd|pm-suspend}}
or
{{RootCmd|s2ram}}
or
{{RootCmd|hibernate-ram}}

For suspend (to ram) for hibernate-script users;
or
{{RootCmd|hibernate}}
to hibernate (to disk.)

A more raw method is to 
{{RootCmd|echo mem > /sys/power/state}}
or
{{RootCmd|echo 3 > /sys/power/tuxonice/powerdown_method}}
for TuxOnIce users. An then
{{RootCmd|echo > /sys/power/tuxonice/do_hibernate}}
is necessary to trigger a suspend/hibernation.

== Suspend to disk ==

For suspend to disk to operate a swap partition or swap file must exist.

The swap file should be active beforehand and should be echoed on the appropriate file before any attempt to suspend/hibernate.

{{RootCmd|echo /dev/sda1 > /sys/power/resume}}

or

{{RootCmd|echo /dev/sda1 > /sys/power/tuxonice/swap/swapfile}}

for ToI users.

A more raw method is to:

{{RootCmd|echo disk > /sys/power/state}}

Do not forget to probe:

{{RootCmd|cat /sys/power/tuxonice/swap/headerlocations}}

before issuing an actual command and append the result to kernel command line argument prepended with `resume='.
This will suffice to resume from a block device or swap file for ToI.
However, it's more complicated for a swapfile with swsusp. 

=== Suspend to disk with sys-power/pm-utils ===

Yet another way to achieve disk hibernation is to use hibernate to swap partition and pm-utils.

First, make sure a swap partition has been set:

{{RootCmd|swapon -s}}

For this example, we will assume it's <code>/dev/sdc2</code>

Edit <code>/etc/default/grub</code> and append the resume kernel option to <code>GRUB_CMDLINE_LINUX_DEFAULT</code> pointing to the swap partition.

{{FileBox|title=GRUB Config|filename=/etc/default/grub
|1=GRUB_CMDLINE_LINUX_DEFAULT="resume=/dev/sdc2"
}} 

Rebuild the GRUB config: 

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg}}

Update initramfs:

{{RootCmd|genkernel --install initramfs}}

Add the following to /etc/pm/config.d/gentoo (see [https://bugs.gentoo.org/show_bug.cgi?id=338239 bug 338239]):
{{FileBox|title=|filename=/etc/pm/config.d/gentoo
|1=SLEEP_MODULE="kernel"
}} 

Reboot the system:

{{RootCmd|reboot}}

Next, try 

{{RootCmd|pm-hibernate}}

=== Suspend to disk with swapfile ===

You can use suspend to disk with a swapfile. When you have a functional swapfile you need to configure kernel parameters (via GRUB, etc.).

First find UUID of device where your swapfile resides. For example: {{Path|/dev/sda1}}.

{{Note|If swapfile resides in a LVM volume, GRUB must be compiled with LVM support. Otherwise, the system will not wake up and will be cold started.}}

{{RootCmd|blkid /dev/sda1}}

Find offset of swapfile on given partition using <code>swap-offset</code> utility from {{Package|sys-power/suspend}}:

{{RootCmd|swap-offset /path/to/swapfile}}

After that edit GRUB config and add required parameters to boot string:

{{FileBox|title=GRUB defaults|filename=/etc/defaults/grub
|1=GRUB_CMDLINE_LINUX_DEFAULT="resume=UUID=<UUID_of_partition> resume_offset=<offset_of_swapfile>"
}}

Rebuild GRUB config:

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg}}

Reboot the system and check used kernel parameters:

{{Cmd|cat /proc/cmdline}}

It should now be possible to hibernate the system.

{{Note|Remember, swap file must contain all memory used by running processes and memory based filesystems like tmpfs or zram prior to hibernating. However, unless specifically set, the hibernation image is compressed. Setting hibernation image size to half of the amount of installed RAM is a safe value in ''most'' cases. One of the cases where this does '''not''' fully apply is when the system has a high usage of [[zswap]] which means that memory may already be compressed.}}

== Troubleshooting ==

If troubleshooting suspend the powersave log might be useful:

{{RootCmd|less /var/log/pm-powersave.log}}

Also classic kernel buffer comes handy:

{{Cmd|dmesg}}

=== Can not resume after suspend ===

In case resuming from suspend does not work, disable the security chip setting in BIOS/UEFI and try again.

== See also ==

[[Power management/Guide]]

== External resources ==

* [http://tuxonice.nigelcunningham.com.au TuxOnIce]
* [https://www.kernel.org/doc/Documentation/power/swsusp.txt Linux kernel documentation - swsusp.txt], or the usual location of {{Path|/usr/src/linux/Documentation/power/swsusp.txt}}

== References ==

<references />

</translate>
