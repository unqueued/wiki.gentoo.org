<languages />


{{Metadata|abstract=このガイドの目的は、GRUB LegacyからGRUB2へのスムーズな移行を手助けすることです。}}

このガイドの目的は、GRUB LegacyからGRUB2へのスムーズな移行を手助けすることです。

== 背景 ==

=== Grubとは? ===

GRUBは、組み込みシステムでないLinux機において、最も一般的に普及しているブートローダです。GRUBの役割は、ディスクからメモリへLinux Kernelをロードさせ、Linux Kernelを起動することです。 

=== なぜ移行するの? ===

はじめに、GRUB Legacyは既にメンテナンスされておらず、今後更新が配信されることもありません。GRUB Legacyが作られた当時、開発者たちは、もはや今日成り立たないいくつかの仮定を安全だと感じていました。例えば、容量が2TB以上あるディスクからブートすることができませんし、新しいファイルシステムが{{PATH|/boot}}を置き換えることがないだろうと仮定しています。 

GRUB2はより堅牢に、よりポータブルに、よりパワフルになることを目指し、クリーンなコードベースでメンテナンスされています。GRUB2は旧バージョンより多くのハードウェア設定、ファイルシステム、ドライブレイアウトをサポートします。 

== GRUB2 への移行 ==

GRUB2への移行は非常に簡単です: あなたのパッケージマネージャによって、通常のアップグレードプロセスの一部としてインストールされます。もし自動的にアップデートされない場合は、いつでも<code>sys-boot/grub:2</code>をインストールすることができます。 

=== 起動ドライブ ===

最初に重要なことは、あなたの起動可能なドライブが何であるかを理解することです。多くの人にとって、それは {{Path|/dev/sda}} でしょう。これをみつける最も簡単な方法は、{{Path|/boot/grub/grub.conf}}を見て、GRUB Legacyがどのように設定されているか確認することです。 

{{Note|これらのファイルが見えるように、{{Path|/boot}} をマウントしておく必要があります。 {{Path|/boot}}をマウントするためには、単純に<code>mount /boot</code>とすべきです。}}

{{File|/boot/grub/grub.conf||<pre>
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
</pre>
}}

Based on the above file we know that <code>(hd0)</code> is the boot drive but we must map this to a real device. To know this you must view {{Path|/boot/grub/device.map}}. An example one is provided below. 

{{File|/boot/grub/device.map||<pre>
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
</pre>
}}

{{Note|If you suspect that {{Path|/boot/grub/device.map}} is not accurate, you can run <code>grub-install --recheck /dev/sda</code> to recreate the file.}}

Based on the above file we know that {{Path|/dev/sda}} is the boot drive.

=== Installing and Configuring GRUB2 ===

The next step is to install and configure GRUB2 on your {{Path|/boot}} partition without removing GRUB Legacy from your MBR. The example below uses {{Path|/dev/sda}} but you must replace it with your boot drive path. The first step installs the necessary GRUB2 files to {{Path|/boot/grub}}, while the second step scans your available kernels and generates a suitable config file to {{Path|/boot/grub/grub.cfg}}. Skip the second step when using a [[GRUB2_Quick_Start#Manual_Configuration|Manual Configuration]].

{{Warning|GRUB 2 uses the configuration file {{Path|/boot/grub/grub.'''cfg'''}} whereas GRUB Legacy used {{Path|/boot/grub/grub.'''conf'''}} so please make sure you don't use the old file by mistake, e.g. by using tab-completion if the old file is still there.}}

{{RootCmd|grub2-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Note|<code>grub2-mkconfig</code> has strict naming requirements for kernels and initramfs images. A kernel must be named <code>kernel-${version}</code> or <code>vmlinuz-${version}</code> while an initramfs must be named <code>initramfs-${version}.img</code>, <code>initramfs-genkernel-${version}</code>, <code>initramfs-genkernel-${arch}-${version}</code>, <code>initrd-${version}.img</code>, <code>initrd.img-${version}</code>, <code>initrd-${version}.gz</code>, or <code>initrd-${version}</code>. Together with ${version}, the filename must match a corresponding kernel that is available in {{Path|/boot}}.}}

=== Chainloading GRUB2 from GRUB Legacy to test the setup ===

Because a broken GRUB configuration could mean an unbootable system, we want to test our GRUB2 configuration before making it permanent. To do this we will chainload GRUB2 from GRUB Legacy. This is done by adding a new section into {{Path|/boot/grub/grub.conf}}. An example is shown below. 

{{Note|Be aware that your root may be different from <code>(hd0,0)</code> used in the example, and make sure you reuse the same root value from your {{Path|/boot/grub/grub.conf}}.}}

{{File|/boot/grub/grub.conf||<pre>
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
</pre>
}}

At this point you should reboot your machine and select <code>GRUB2 Chainload</code> from the GRUB menu when your machine begins to boot. You will be presented with another GRUB menu which should advertise itself as GRUB 2.0.0 or higher at the top and show your available kernel(s) to boot. Should this not work, simply reboot your system and pick your normal boot option instead of <code>GRUB2 Chainload</code>. 

=== Replacing and removing GRUB Legacy ===

At this point, if everything worked successfully, you can replace GRUB Legacy and remove it from your system. 

{{Note|Since you've rebooted your system, you may need to mount {{Path|/boot}} again. Make sure to use your own boot drive path instead of {{Path|/dev/sda}}.}}

{{RootCmd|grub2-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

At this point you can use your package manager to remove <code>sys-boot/grub:0</code>. 
{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"|}}
The migration is complete.

== Maintaining GRUB2 ==

Whenever you install a new kernel, you must perform the next step so that your GRUB2 configuration recognizes the new kernel (unless you are using a [[GRUB2_Quick_Start#Manual_Configuration|manual configuration]]). 

{{Note|You must have your {{Path|/boot}} partition mounted for this step.}}

{{RootCmd|grub2-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

== 謝辞 ==

We would like to thank the following authors and editors for their contributions to this guide:


* cardoe
