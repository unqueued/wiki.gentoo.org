<languages />


{{Metadata|abstract=このガイドの目的は、読者のGRUB LegacyからGRUB2へのスムーズな移行を手助けすることです。}}

このガイドの目的は、読者のGRUB LegacyからGRUB2へのスムーズな移行を手助けすることです。

== 背景 ==

=== GRUBとは? ===

GRUBは、組み込みシステムでないLinux機において、最も一般的に普及しているブートローダです。GRUBの役割は、ディスクからメモリへLinux Kernelをロードさせ、Linux Kernelを起動することです。 

=== なぜ移行するのか? ===

まず、GRUB レガシーは既にメンテナンスされておらず、今後更新が受け付けられることもありません。GRUB レガシーが作られた当時は、開発者たちは、いくらかの想定をし、疑いもしませんでした。しかしその想定はいまや成り立ちません。例えば、GRUB レガシーでは、容量が2TB以上あるディスクからブートすることが不可能ですし、 {{Path|/boot}} に新たなファイルシステムが用いられることも想定していませんでした。 

GRUB2 は、より堅牢に、より移植可能に、より強力になることを目指し、よりクリーンなコードベースでメンテナンスされています。GRUB2 は、旧バージョンよりも多くの、ハードウェア設定やファイルシステム、ドライブレイアウトをサポートします。 

== GRUB2 への移行 ==

GRUB2 への移行はとても単純です: パッケージマネージャによって、通常のアップグレードプロセスの一部としてインストールされます。自動的にアップデートされなかった場合であっても、いつでも <code>sys-boot/grub:2</code> パッケージアトムでインストール可能です。

{{Emerge|sys-boot/grub:2}}

=== ブートドライブ ===

最初に重要なことは、どのドライブから起動可能かを把握することです。Gentoo ハンドブックに基づいた場合は、{{Path|/dev/sda}} でしょう。判らない場合でも、既存の GRUB レガシーの設定を見れば容易に見つけられます。{{Path|/boot/grub/grub.conf}} が主に見るべきところです。 

{{Note/ja|これらのファイルが見えるように、{{Path|/boot}} パーティションをマウントしておく必要があります。 マウントするためには、ただ次を実行すればよいはずです
{{RootCmd|mount /boot}}
}}

{{Path|grub.conf}} は例えば次のようになっています:

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

上記のファイルから <code>(hd0)</code> がブートドライブだとわかりますが、これを実際のデバイスに紐付けなければなりません。これを知るには、{{Path|/boot/grub/device.map}} ファイルを見る必要があります。ファイルの例を下記に提示します。 

{{FileBox|filename=/boot/grub/device.map|1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note/ja|{{Path|/boot/grub/device.map}}が正しくないと気づいたときは、次のコマンドを実行してファイルを再生成しましょう。
{{RootCmd|grub-install --recheck /dev/sda}}
}}

上記のファイルから、{{Path|/dev/sda}} がブートドライブだとわかります。

=== GRUB2 のインストールと設定 ===

次のステップでは、GRUB レガシーをドライブのマスターブートレコード (MBR) から削除することなく、{{Path|/boot}} パーティションへ GRUB2 のインストールと設定を行います。下記の例では {{Path|/dev/sda}} を使っています — 実際のブートドライブのパスに読み替えてください。

まず、必要な GRUB2 のファイルを {{Path|/boot/grub}} にインストールします。

{{RootCmd|grub-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{Warning|The <code>--grub-setup{{=}}/bin/true</code> option tells {{c|grub-install}} to ''not'' install GRUB2 in the MBR. If this option is omitted, GRUB Legacy will be overwritten and [[#Chainloading GRUB2 from GRUB Legacy to test the setup|chainloading GRUB2 from GRUB Legacy later on]] will not be possible.}}

{{Note/ja|GRUB2 が <code>multislot</code> USE フラグ付きで emerge されているときは、{{c|grub-install}} コマンドはまだ GRUB レガシーの方になっています。この場合は、次のステップでは GRUB2 には代わりに {{c|grub2-install}} コマンドを — {{c|grub-mkconfig}} の代わりには {{c|grub2-mkconfig}} コマンドを、使ってください。}}

これで、利用可能なカーネルを検知して適切な設定を {{Path|/boot/grub/grub.cfg}} に生成することが可能になりました。もしも [[GRUB2_Quick_Start#Manual_configuration|マニュアル設定]]を行うのであれば、次のステップはとばしてください。

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Warning/ja|GRUB2 は設定ファイルとして{{Path|/boot/grub/grub.'''cfg'''}} を使っていますが、GRUB Legacyは {{Path|/boot/grub/grub.'''conf'''}} を使っていますので、間違えて古いファイルを使っていないか確認してください。古いファイルがまだ残っている場合、タブ補完等で使われます。}}

{{Note/ja|{{c|grub-mkconfig}} は、kernelとinitramfsイメージに厳格な名付けが必要となります。カーネルは <code>kernel-${version}</code> か <code>vmlinuz-${version}</code> のファイル名である必要があり、initramfsもまた、<code>initramfs-${version}.img</code>、<code>initramfs-genkernel-${version}</code>、<code>initramfs-genkernel-${arch}-${version}</code>、<code>initrd-${version}.img</code>、<code>initrd.img-${version}</code>、<code>initrd-${version}.gz</code>、<code>initrd-${version}</code>のファイル名である必要があります。これらファイルは、{{Path|/boot}}の中に置かねばなりません。}}

{{Note/ja|{{Path|/etc/default/grub}} ファイルは、{{c|grub-mkconfig}} の動作をコントロールします。もしもカーネルにパラメータを渡す必要があるなら(例えば、genkernel を使っていて LVM やソフトウェア RAID からブートするなど)、{{Path|/boot/grub/grub.cfg}} ファイルを生成する前に先ほどのファイルを編集する必要があります:
{{RootCmd|nano /etc/default/grub}}
どのようにファイルを編集するか決めるため、Gentoo Wikiの[[GRUB2#Configuration|the GRUB2 configuration]]や[http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html 公式の GRUB2 マニュアル]を参照してください。多くのユーザは、<code>GRUB_CMDLINE_LINUX</code>パラメータを設定してカーネルコマンドラインを渡す必要があるでしょう。}}

=== GRUB レガシーから GRUB2 へのチェインローディングによる設定テスト ===

GRUB の設定を間違えると起動不能なシステムになるので、GRUB2 の設定を確定させる前にテストしたいところです。そこで、GRUB レガシーから GRUB2 をチェインロードして実験します。これは {{Path|/boot/grub/grub.conf}} に新しいセクションを追加することで実現します。例を以下に示します。 

{{Note/ja|ルートパーティションは、例で使用している <code>(hd0,0)</code> と異なるかもしれません。必ず、{{Path|/boot/grub/grub.conf}} 設定ファイルの中にあるルートパーティションの値と同じものを設定していることを確かめてください。}}

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

この時点でマシンを再起動し、マシンが起動してきたら GRUB のメニューから <code>GRUB2 Chainload</code> を選択してください。GRUB 2.0.0 以上のバージョンが上部に表示され、ブート可能なカーネルが表示された新たな GRUB メニューが表示されるはずです。うまく動かない場合は、システムを再起動して、<code>GRUB2 Chainload</code> をやめて通常のブート選択肢を実行してください。 

=== GRUB レガシーの置換えと削除 ===

If everything worked successfully, replace GRUB Legacy and remove it from the system. 

{{Warning/ja|システムを再起動してから、再度 {{Path|/boot}} をマウントする必要があるかもしれません。{{Path|/dev/sda}} はあくまでも一例です。もしも {{Path|/boot}} が {{c|grub-install}} の実行前にマウントされいなければ、システムは起動不能になってしまいます}}

{{Note|As previously mentioned, if GRUB2 was emerged with the <code>multislot</code> USE flag then {{c|grub2-install}} must be used instead of {{c|grub-install}}. In this case, after GRUB Legacy is removed from the system in the next step, GRUB2 should be re-emerged without the <code>multislot</code> USE flag so that {{c|grub-install}} and {{c|grub-mkconfig}} can become GRUB2 commands.}}

{{RootCmd|grub-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

この時点で、パッケージマネージャを使って <code>sys-boot/grub:0</code> を削除することが可能です。 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

移行が完了しました。

== GRUB2 のメンテナンス ==

新しいカーネルがインストールされたら毎回、GRUB2 の設定に新しいカーネルを認識させる為、次のステップを実行する必要があります([[GRUB2_Quick_Start#Manual_Configuration|マニュアル設定]] を使っていない場合)。 

{{Note/ja|このステップでは {{Path|/boot}} がマウントされている必要があります。}}

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
