<languages />


{{Metadata|abstract=このガイドの目的は、読者のGRUB LegacyからGRUB2へのスムーズな移行を手助けすることです。}}

このガイドの目的は、読者のGRUB LegacyからGRUB2へのスムーズな移行を手助けすることです。

== 背景 ==

=== GRUBとは? ===

GRUBは、組み込みシステムでないLinux機において、最も一般的に普及しているブートローダです。GRUBの役割は、ディスクからメモリへLinux Kernelをロードさせ、Linux Kernelを起動することです。 

=== なぜ移行するのか? ===

まず、GRUB レガシーは既にメンテナンスされておらず、今後更新が受け付けられることもありません。GRUB レガシーが作られた当時は、開発者たちは、いくらかの想定をし、疑いもしませんでした。しかしその想定はいまや成り立ちません。例えば、GRUB レガシーでは、容量が2TB以上あるディスクからブートすることが不可能ですし、 {{Path|/boot}} に新たなファイルシステムが用いられることも想定していませんでした。 

GRUB2 は、より堅牢に、より移植可能に、より強力になることを目指し、よりクリーンなコードベースでメンテナンスされています。GRUB2 は、旧バージョンよりも多くの、ハードウェア設定やファイルシステム、ドライブレイアウトをサポートします。 

== GRUB2 への移行 ==

GRUB2への移行は非常に簡単です: パッケージマネージャによって、通常のアップグレードプロセスの一部としてインストールされます。もし自動的にアップデートされない場合は、いつでも<code>sys-boot/grub:2</code>パッケージアトムでemergeすることができます。

{{Emerge|sys-boot/grub:2}}

=== ブートドライブ ===

The first important part is to understand which drive is bootable. For those who followed the Gentoo Handbook it should be {{Path|/dev/sda}}. For those who are uncertain, the easiest way to find out is to look at the existing GRUB Legacy configuration. Viewing the {{Path|/boot/grub/grub.conf}} file is the main place to check. 

{{Note|Be sure the {{Path|/boot}} partition is mounted to be able to view these files. It should be as simple as
{{RootCmd|mount /boot}}
}}

{{Path|grub.conf}} は例えば次のようになっています:

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

Based on the above file it is possible to know that <code>(hd0)</code> is the boot drive but we must map this to a real device. To know this, look at the {{Path|/boot/grub/device.map}} file. An example one is provided below. 

{{FileBox|filename=/boot/grub/device.map|1=
(fd0) /dev/fd0
(hd0) /dev/sda
(hd1) /dev/sdb
}}

{{Note/ja|{{Path|/boot/grub/device.map}}が正しくないと気づいたときは、次のコマンドを実行してファイルを再生成しましょう。
{{RootCmd|grub-install --recheck /dev/sda}}
}}

上記のファイルから、{{Path|/dev/sda}} がブートドライブだとわかります。

=== GRUB2 のインストールと設定 ===

次のステップでは、GRUB レガシーをドライブのマスターブートレコード (MBR) から削除することなく、{{Path|/boot}} パーティションへ GRUB2 のインストールと設定を行います。下記の例では {{Path|/dev/sda}} を使っています — 実際のブートドライブのパスに読み替えてください。

まず、必要な GRUB2 のファイルを {{Path|/boot/grub}} にインストールします。

{{RootCmd|grub-install --grub-setup{{=}}/bin/true /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>}}

{{Warning/ja|<code>--grub-setup{{=}}/bin/true</code> オプションによって、{{c|grub-install}} に対して GRUB2 を MBR に''インストールするな''と指示します。もしもこのオプションがなければ、GRUB レガシーが上書きされてしまい、 [[#Chainloading GRUB2 from GRUB Legacy to test the setup|GRUB レガシーから GRUB2 をチェインロードする]] ことが不可能になってしまいます。}}

{{Note/ja|GRUB2 が <code>multislot</code> USE フラグ付きで emerge されているときは、{{c|grub-install}} コマンドはまだ GRUB レガシーの方になっています。この場合は、次のステップでは GRUB2 には代わりに {{c|grub2-install}} コマンドを — {{c|grub-mkconfig}} の代わりには {{c|grub2-mkconfig}} コマンドを、使ってください。}}

Now we can scan the available kernels and generate a suitable config file to {{Path|/boot/grub/grub.cfg}}. Skip this step when using a [[GRUB2_Quick_Start#Manual_configuration|Manual Configuration]].

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}

{{Warning/ja|GRUB2 は設定ファイルとして{{Path|/boot/grub/grub.'''cfg'''}} を使っていますが、GRUB Legacyは {{Path|/boot/grub/grub.'''conf'''}} を使っていますので、間違えて古いファイルを使っていないか確認してください。古いファイルがまだ残っている場合、タブ補完等で使われます。}}

{{Note/ja|{{c|grub-mkconfig}} は、kernelとinitramfsイメージに厳格な名付けが必要となります。カーネルは <code>kernel-${version}</code> か <code>vmlinuz-${version}</code> のファイル名である必要があり、initramfsもまた、<code>initramfs-${version}.img</code>、<code>initramfs-genkernel-${version}</code>、<code>initramfs-genkernel-${arch}-${version}</code>、<code>initrd-${version}.img</code>、<code>initrd.img-${version}</code>、<code>initrd-${version}.gz</code>、<code>initrd-${version}</code>のファイル名である必要があります。これらファイルは、{{Path|/boot}}の中に置かねばなりません。}}

{{Note/ja|{{Path|/etc/default/grub}} ファイルは、{{c|grub-mkconfig}} の動作をコントロールします。もしもカーネルにパラメータを渡す必要があるなら(例えば、genkernel を使っていて LVM やソフトウェア RAID からブートするなど)、{{Path|/boot/grub/grub.cfg}} ファイルを生成する前に先ほどのファイルを編集する必要があります:
{{RootCmd|nano /etc/default/grub}}
どのようにファイルを編集するか決めるため、Gentoo Wikiの[[GRUB2#Configuration|the GRUB2 configuration]]や[http://www.gnu.org/software/grub/manual/html_node/Simple-configuration.html 公式の GRUB2 マニュアル]を参照してください。多くのユーザは、<code>GRUB_CMDLINE_LINUX</code>パラメータを設定してカーネルコマンドラインを渡す必要があるでしょう。}}

=== GRUB レガシーから GRUB2 へのチェインローディングによる設定テスト ===

GRUB の設定を間違えると起動不能なシステムになるので、GRUB2 の設定を確定させる前にテストしたいところです。そこで、GRUB レガシーから GRUB2 をチェインロードして実験します。これは {{Path|/boot/grub/grub.conf}} に新しいセクションを追加することで実現します。例を以下に示します。 

{{Note/ja|ルートパーティションは、例で使用している <code>(hd0,0)</code> と異なるかもしれません。必ず、{{Path|/boot/grub/grub.conf}} 設定ファイルの中にあるルートパーティションの値と同じものを設定していることを確かめてください。}}

{{FileBox|filename=/boot/grub/grub.conf|1=
default 0
timeout 30
splashimage=(hd0,0)/boot/grub/splash.xpm.gz
  
title GRUB2 Chainload
root (hd0,0)
kernel /boot/grub/i386-pc/core.img
boot
  
title Gentoo Linux 3.2.12
root (hd0,0)
kernel /boot/kernel-3.2.12-gentoo root=/dev/sda3 quiet dolvm
initrd /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
}}

この時点でマシンを再起動し、マシンが起動してきたら GRUB のメニューから <code>GRUB2 Chainload</code> を選択してください。GRUB 2.0.0 以上のバージョンが上部に表示され、ブート可能なカーネルが表示された新たな GRUB メニューが表示されるはずです。うまく動かない場合は、システムを再起動して、<code>GRUB2 Chainload</code> をやめて通常のブート選択肢を実行してください。 

=== GRUB レガシーの置換えと削除 ===

この時点で、もしすべてうまく動いているならば、GRUB レガシーを置き換え、システムから削除することができます。 

{{Warning/ja|システムを再起動してから、再度 {{Path|/boot}} をマウントする必要があるかもしれません。{{Path|/dev/sda}} はあくまでも一例です。もしも {{Path|/boot}} が {{c|grub-install}} の実行前にマウントされいなければ、システムは起動不能になってしまいます}}

{{RootCmd|grub-install /dev/sda|output=<pre>
Installation finished. No error reported.
</pre>
}}

この時点で、パッケージマネージャを使って <code>sys-boot/grub:0</code> を削除することが可能です。 

{{RootCmd|emerge -avC "{{=}}sys-boot/grub-0.97*"}}

移行が完了しました。

== GRUB2 のメンテナンス ==

新しいカーネルがインストールされたら毎回、GRUB2 の設定に新しいカーネルを認識させる為、次のステップを実行する必要があります([[GRUB2_Quick_Start#Manual_Configuration|マニュアル設定]] を使っていない場合)。 

{{Note|Make sure the {{Path|/boot}} partition is mounted for this step.}}

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg|output=<pre>
Generating grub.cfg ...
Found linux image: /boot/kernel-3.3.8-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.3.8-gentoo
Found linux image: /boot/kernel-3.2.12-gentoo
Found initrd image: /boot/initramfs-genkernel-x86_64-3.2.12-gentoo
done
</pre>
}}


[[Category:Bootloaders]]

{{Migrated|originalauthors=Cardoe}}
