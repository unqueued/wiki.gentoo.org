{{InfoBox stack
|{{InfoBox wikipedia|header=true}}
}}
'''InfiniBand''' is a switched fabric communications link used in high-performance computing and enterprise data centers.
Its features include high throughput, low latency, quality of service and failover, and it is designed to be scalable. The InfiniBand architecture specification defines a connection between processor nodes and high performance I/O nodes such as storage devices.

== Installation ==

=== Kernel ===

Users of Mellanox hardware MSX6710, MSX8720, MSB7700, MSN2700, MSX1410, MSN2410, MSB7800, MSN2740, and MSN2100 need at least kernel 4.9.<ref>[http://www.phoronix.com/scan.php?page=news_item&px=Mellanox-Linux-4.9 Phoronix - Mellanox Platform Support Coming In Linux 4.9]</ref>

The following kernel options must be activated:

{{KernelBox|title=Enable InfiniBand support (<var>CONFIG_INFINIBAND</var>)|1=
Device Drivers  --->
   <*> InfiniBand support  --->
      <*> InfiniBand userspace MAD support
      <*> InfiniBand userspace access (verbs and CM)
      <M> Mellanox HCA support
      <M> QLogic PCIe HCA support
      <M> Ammasso 1100 HCA support
      <M> Mellanox ConnectX HCA support
      <M> NetEffect RNIC Driver
      <M> Emulex One Connect HCA support
      <M> IP-over-InfiniBand
         [*] IP-over-InfiniBand Connected Mode support
      <M>   InfiniBand SCSI RDMA Protocol
}}

{{Note|In this example everything is selected. Most likely the userspace API (first two options) and the HCA (host channel/control adapter) drivers are needed for system specific hardware. IP-over-InfiniBand or srp modules may also be needed if they are required features.}}

=== USE flags ===

{{USEflag|package=sys-fabric/ofed}}

=== Emerge ===

{{Emerge|sys-fabric/ofed}}

== Usage ==

=== IP over InfiniBand (IPoIB) ===

Users of InfiniBand can also use it to carry IP-networking packets, thus allowing it to replace ethernet in some cases.
From at least kernel version 4.10 onwards users can compile IP-over-IB in-kernel (<var>CONFIG_INFINIBAND_IPOIB</var>). However if that's not the case and the support is compiled as kernel module it may be possible that the module isn't automatically loaded.
The module is named '''ib_ipoib''':

{{RootCmd|modprobe ib_ipoib}}

InfiniBand network interfaces are usually named as <code>ib<number></code>:

{{Cmd|ifconfig ib0|output=<pre>ib0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 2044
Infiniband hardware address can be incorrect! Please read BUGS section in ifconfig(8).
        infiniband 00:00:04:04:FE:80:00:00:00:00:00:00:00:00:00:00:00:00:00:00  txqueuelen 256  (InfiniBand)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</pre>}}

==== Performance tuning ====

===== Automatic =====
When using IP over InfiniBand ther performance is usually low by default. This is because the default mtu of each InfiniBand IP interface is set to a low value.
The most conveivent way is to chance mtu automatically when kernel adds the interface to the system. Before mtu can be changed the mode of the interface must be changed to 'connected' from 'datagram'
Next example uses udev rules to accoplish that.
{{FileBox|filename=/etc/udev/rules.d/2-InfiniBand.rules|title=udev rules for InfiniBand IP networking interfaces|lang=udev|1=<pre># Rules to set InfiniBand device attributes.

# Change mode to connected and change mtu to maximum for best performance.
ACTION=="add", KERNEL=="ib[0-9]*", SUBSYSTEM=="net", ATTR{mode}="connected", ATTR{mtu}="65520"</pre>}}
It has been reported<ref>[https://forums.gentoo.org/viewtopic-p-8060796.html#8060796 Gentoo forums - post 8060796] - Udev rules don't work on ib interface</ref><ref>[[User:Zucca/wip/InfiniBand/resources#Udev_rules|Gentoo wiki - User Zucca]] - InfiniBand resources</ref> that the rule above does not work.
Users with this problem may use the following instead:
{{FileBox|filename=/etc/udev/rules.d/2-InfiniBand.rules|title=udev rules for InfiniBand IP networking interfaces|lang=udev|1=<pre># Rules to set InfiniBand device attributes.

# Change mode to connected and change mtu to maximum for best performance.
ACTION=="add", KERNEL=="ib[0-9]*", SUBSYSTEM=="net", RUN+="/bin/sh -c 'echo connected > /sys/class/net/%k/mode && echo 65520 > /sys/class/net/%k/mtu'"</pre>}}

===== Manual =====
Mode and mtu can also be changed manually in run time.
Next commands assume the interface in question is named '''ib0'''.
{{RootCmd|echo connected > /sys/class/net/ib0/mode|echo 65520 > /sys/class/net/ib0/mtu}}

== References ==
<references />
[[Category:Interfaces]]
