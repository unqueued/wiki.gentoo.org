<big>'''OVERVIEW'''</big>

[http://www.2600hz.org BlueBox]
is a web based php configuration and management GUI for 
[http://www.freeswitch.org/ FreeSWITCH] and 
[http://www.asterisk.org Asterisk]
switching libraries. It supports multi-tenancy, skinning, and is completely open-source. It can be used with database and file replication to scale up to thousands of registered devices and simultaneous phone calls. It can operate in the cloud or on the premise. 
It originally developed from 
[http://www.freepbx.org/freepbx-v3 FreePBXv3].

<big>'''PREREQUISITE'''</big>

Please first install [http://wiki.freeswitch.org/wiki/Installation:Gentoo FreeSWITCH]

Then install a web server such as 
[http://en.gentoo-wiki.com/wiki/Apache2 Apache2],
[http://www.gentoo.org/proj/en/php/php-installing.xml dev-lang/php],
a database backend such as 
[http://www.gentoo.org/doc/en/mysql-howto.xml mysql], 
[http://www.gentoo.org/doc/en/postgres-howto.xml pgsql], or 
[http://www.sqlite.org/ dev-db/sqlite]

I installed:
* www-servers/apache 
* dev-lang/php 
* dev-db/mysql

<big>'''SETUP MySQL'''</big><br />
<code>
mysql -u root -p
mysql> CREATE USER 'bluebox'@'localhost' IDENTIFIED BY 'bluebox';
mysql> GRANT ALL PRIVILEGES ON bluebox.* TO 'bluebox'@'localhost';
mysql> FLUSH PRIVILEGES;
mysql> SELECT user,host,password FROM mysql.user;
mysql> SHOW GRANTS FOR bluebox@localhost;
mysql> \q
</code>

If you make a mistake and need to start over:<br />
<code>
mysql -u root -p
mysql> REVOKE ALL PRIVILEGES, GRANT OPTION ON bluebox.* FROM 'bluebox'@'localhost';
mysql> DROP DATABASE bluebox;
mysql> \q
</code>

<big>'''INSTALLING BLUEBOX'''</big><br />
Adapted from <url>http://www.powerpbx.org/content/centos-freeswitch-bluebox-v1</ur>

Install bluebox git source into top level root of web server:<br />
<code>
cd /var/www/localhost/htdocs
git clone git://source.2600hz.org/bluebox.git
chown -R freeswitch:freeswitch /var/www/localhost/htdocs/bluebox
cd /var/www/localhost/htdocs/bluebox
./preinstall.sh
</code>

<b>NOTE:</b> When the install asks you for the web user name change default (apache) to "freeswitch" (without quotes).  Everything else can remain at default (Just repeatedly press ENTER when it asks)

Increase the memory_limit for php<br />
<code>
sed -i 's/memory_limit = 32M/memory_limit = 128M/g' /etc/php/apache2-php5.3/php.ini<br />
</code>

Restart apache<br />
   /etc/init.d/apache2 restart<br />

Browse to "http://your.web.server/bluebox/"<br />
and run the installer. I went with the defaults but changed the password and email address 
for the administrator. I also unchecked the option for installing sample data.

I got a WARNING about conflicting files:<br />
<code>
Conflicting Files<br />

/opt/freeswitch/conf/directory/default.xml<br />
/opt/freeswitch/conf/autoload_configs/conference.conf.xml<br />
/opt/freeswitch/conf/autoload_configs/ivr.conf.xml<br />
/opt/freeswitch/conf/autoload_configs/acl.conf.xml<br />
/opt/freeswitch/conf/autoload_configs/xml_cdr.conf.xml<br />
/opt/freeswitch/conf/autoload_configs/callcenter.conf.xml<br />
/opt/freeswitch/conf/autoload_configs/distributor.conf.xml<br />
/opt/freeswitch/conf/autoload_configs/directory.conf.xml<br />
/opt/freeswitch/conf/autoload_configs/cdr_csv.conf.xml<br />
/opt/freeswitch/conf/sip_profiles/external.xml<br />
/opt/freeswitch/conf/sip_profiles/internal-ipv6.xml<br />
/opt/freeswitch/conf/sip_profiles/internal.xml<br />

Conflicting configuration files will be permanently erased if you continue!<br />
</code>
I just continued.<br />

After configuring bluebox, my default configuration was<br />
<code>
cat /var/www/localhost/htdocs/bluebox/config/database.php
'type'     => 'mysql',
'user'     => 'bluebox',
'pass'     => 'bluebox',
'host'     => '127.0.0.1',
'port'     => '3306',
'socket'   => FALSE,
'database' => 'bluebox'
</code>

You probably will want to change the password for user bluebox.<br />

Next edit /var/www/localhost/htdocs/bluebox/bluebox/config/config.php<br />
and disable the installer:<br />
<code>config['installer_enabled'] = FALSE;</code>


<big>'''CONFIGURING FreeSWITH with BLUEBOX'''</big><br />
START freeswitch:<br />
<code>/etc/init.d/freeswitch start</code>
crashed for me, but running it manually worked<br />
<code>
/opt/freeswitch/bin/freeswitch [options such as hp,lp.rp ncwait]
/opt/freeswitch/bin/fs_cli
</code>
or
<code>
/opt/freeswitch/bin/freeswitch -nc 
</code>


NOW BROWSE to "http://your.web.server/bluebox/"<br />

INSTALL additional modules:<br />
System->Package Manager<br />
A few modules have pre-requisite modules so if you get an error, install the pre-requisite.<br />
A few pairs of modules conflict, e.g.:
* "Freeswitch" and "Asterisk"
* "Endpoint Manager" and "Provisioner"
* "Media File" and "Media Manager"
I chose "Freeswitch", "Endpoint Manager" and "Media File"<br />
and installed every module except those for a call center.<br />

Bluebox came pre-installed with 3 sip interfaces<br />
"Connectivity" -> "SIP Interface"
<code>
 Authenticated SIP	Auto Detect	5060	Required	Edit|Delete
 Authenticated SIP - NAT	Auto Detect	5070	Required	Edit|Delete
 Unauthenticated SIP	Auto Detect	5080	None	Edit|Delete
</code>

Use the freeswitch cli to see your interfaces:
<code>
freeswitch@myhost> sofia status 

                     Name          Type                                       Data      State
 =================================================================================================
           sipinterface_2       profile            sip:mod_sofia@192.168.1.40:5070      RUNNING (0)
              voicemail_1         alias                             sipinterface_2      ALIASED
           sipinterface_1       profile            sip:mod_sofia@192.168.1.40:5060      RUNNING (0)
           sipinterface_3       profile            sip:mod_sofia@192.168.1.40:5080      RUNNING (0)
             192.168.1.40         alias                             sipinterface_1      ALIASED
 =================================================================================================
 3 profiles 2 aliases
</code>

Next I added users in "Organization" -> "Use Manager"<br /> 
Decide whether you want a multitenant system (default), i.e. your sip registrations will use
"user@domain" instead of just "user"<br />
Note that bluebox adds your users to /etc/freeswitch/directory/default.xml<br />
So check and verify that your users have been added there.

Verify that your sip phones have registered with FreeSWITCH:
<code>
sofia status profile sipinterface_1

=================================================================================================
Name                    sipinterface_1
Domain Name             N/A
Auto-NAT                false
DBName           
Pres Hosts       
Dialplan                XML
Context                 multitenant_routing_context
Challenge Realm         auto_to
RTP-IP                  192.168.1.40
SIP-IP                  192.168.1.40
URL                     sip:mod_sofia@192.168.1.40:5060
BIND-URL                sip:mod_sofia@192.168.1.40:5060
HOLD-MUSIC              N/A
OUTBOUND-PROXY          N/A
CODECS IN               G7221@32000h,G7221@16000h,G722,PCMU,PCMA,GSM
CODECS OUT              G7221@32000h,G7221@16000h,G722,PCMU,PCMA,GSM
TEL-EVENT               101
DTMF-MODE               rfc2833
CNG                     13
SESSION-TO              0
MAX-DIALOG              0
NOMEDIA                 false
LATE-NEG                false
PROXY-MEDIA             false
AGGRESSIVENAT           false
STUN-ENABLED            true
STUN-AUTO-DISABLE       false
CALLS-IN                2
FAILED-CALLS-IN         1
CALLS-OUT               1
FAILED-CALLS-OUT        1
REGISTRATIONS           4
</code>

Show registrations for sipinterface:<br />
<code>
sofia status profile sipinterface_1 reg
<... excerpt ..>
Call-ID:        3c26701f3482-2ou8k0j6yqug
User:           101@192.168.1.40
Contact:        "John Doe" <sip:101@192.168.1.101:2048>
Agent:          snom360/8.4.32
Status:         Registered(UDP)(unknown) EXP(2012-05-18 20:26:09) EXPSECS(2869)
Host:           pbx
IP:             192.168.1.101
Port:           2048
Auth-User:      101
Auth-Realm:     pbx.mydomain.com
MWI-Account:    101@voicemail_1
</code>

Now that Check that you have a dial tone and can dial an internal extension<br />

then voicemail boxes "Applications" -> "Voicemail Boxes"<br />
and sip phones "Applications" -> "Devices"<br />
I also used the "Applications" -> "Endpoints" to add entries for my sip phones<br />
The passwords for the users must be alphanumeric but the passwords for the sip devices and voicemail boxes need not be so.
