<big>'''OVERVIEW'''</big>

[http://www.2600hz.org BlueBox]
is a web based php configuration and management GUI for 
[http://www.freeswitch.org/ FreeSWITCH] (FS) and 
[http://www.asterisk.org Asterisk]
switching libraries. It supports multi-tenancy, skinning, and is completely open-source. It can be used with database and file replication to scale up to thousands of registered devices and simultaneous phone calls. It can operate in the cloud or on the premise. 
It originally developed from 
[http://www.freepbx.org/freepbx-v3 FreePBXv3].

<big>'''PREREQUISITES'''</big>

Please first install FreeSWITCH following
the [http://wiki.freeswitch.org/wiki/Installation:Gentoo Gentoo Wiki]

After installing FreeSWITCH, there is a post-installation message from portage
that a backup of the default configuration files has been saved to:
<code>
 /usr/share/doc/freeswitch-9999/conf
</code>
but a "diff -r /etc/freeswitch /usr/share/doc/freeswitch-9999/conf" shows differences<br />
so I made my own copy:<br />
<code>
 cp -a /etc/freeswitch /etc/freeswitch.orig<br />
 ln -s /etc/freeswitch.orig /opt/freeswitch/conf.orig
</code>

Also, portage seems to install the freeswitch configuration directory twice:
 * once into /etc/freeswitch
 * and a second time into /etc/freeswitch/freeswitch
A "diff" for each file/folder in /etc/freeswitch/* and /etc/freeswitch/freeswitch/*<br />
shows no differences. Is this a mistake?

Then install: 
* a web server such as www-servers/apache (see the [http://en.gentoo-wiki.com/wiki/Apache2 Gentoo Wiki])
* dev-lang/php (see the [http://www.gentoo.org/proj/en/php/php-installing.xml Gentoo Wiki])
* and a database backend such as 
:* dev-db/mysql (see the [http://www.gentoo.org/doc/en/mysql-howto.xml Gentoo Wiki])
:* dev-db/postgresql-server (see the [http://www.gentoo.org/doc/en/postgres-howto.xml Gentoo Wiki])
:* dev-db/sqlite (see the [http://www.sqlite.org/ Gentoo Wiki])

I installed:
* www-servers/apache-2.2.22-r1
* dev-lang/php-5.3.13
* dev-db/mysql-5.1.62-r1

<big>'''SETUP MySQL'''</big><br />

<code>
 mysql -u root -p<br />
 mysql> CREATE USER 'bluebox'@'localhost' IDENTIFIED BY 'bluebox';<br />
 mysql> GRANT ALL PRIVILEGES ON bluebox.* TO 'bluebox'@'localhost';<br />
 mysql> FLUSH PRIVILEGES;<br />
 mysql> SELECT user,host,password FROM mysql.user;<br />
 mysql> SHOW GRANTS FOR bluebox@localhost;<br />
 mysql> \q<br />
</code>

If you make a mistake and need to start over:<br />

<code>
 mysql -u root -p<br />
 mysql> REVOKE ALL PRIVILEGES, GRANT OPTION ON bluebox.* FROM 'bluebox'@'localhost';<br />
 mysql> DROP DATABASE bluebox;<br />
 mysql> \q<br />
</code>

<big>'''INSTALLING BLUEBOX'''</big><br />
Adapted from <url>http://www.powerpbx.org/content/centos-freeswitch-bluebox-v1</ur>

Install bluebox git source into top level root of web server:<br />

<code>
 cd /var/www/localhost/htdocs<br />
 git clone git://source.2600hz.org/bluebox.git<br />
 chown -R freeswitch:freeswitch /var/www/localhost/htdocs/bluebox<br />
 cd /var/www/localhost/htdocs/bluebox<br />
 ./preinstall.sh<br />
</code>

<b>NOTE:</b> When the install asks you for the web user name change default (apache) to "freeswitch" (without quotes).  Everything else can remain at default (Just repeatedly press ENTER when it asks)

Increase the memory_limit for php<br />
<code>
 sed -i 's/memory_limit = 32M/memory_limit = 128M/g' /etc/php/apache2-php5.3/php.ini<br />
</code>

Restart apache<br />
<code>
 /etc/init.d/apache2 restart<br />
</code>

/opt/freeswitch/conf/ is a symlink to /etc/freeswitch <br />
You will need to change the ownership on the configuration files to allow apache to make changes
before you run the bluebox configuration GUI:
<code>
 chown -R apache.freeswitch /etc/freeswitch
<code>


Browse to "http://your.web.server/bluebox/"<br />
and run the installer. I went with the defaults but changed the password and email address 
for the administrator. I also unchecked the option for installing sample data.

I got a WARNING about conflicting files:<br />
<code>
 Conflicting Files<br />
 /opt/freeswitch/conf/directory/default.xml<br />
 /opt/freeswitch/conf/autoload_configs/conference.conf.xml<br />
 /opt/freeswitch/conf/autoload_configs/ivr.conf.xml<br />
 /opt/freeswitch/conf/autoload_configs/acl.conf.xml<br />
 /opt/freeswitch/conf/autoload_configs/xml_cdr.conf.xml<br />
 /opt/freeswitch/conf/autoload_configs/callcenter.conf.xml<br />
 /opt/freeswitch/conf/autoload_configs/distributor.conf.xml<br />
 /opt/freeswitch/conf/autoload_configs/directory.conf.xml<br />
 /opt/freeswitch/conf/autoload_configs/cdr_csv.conf.xml<br />
 /opt/freeswitch/conf/sip_profiles/external.xml<br />
 /opt/freeswitch/conf/sip_profiles/internal-ipv6.xml<br />
 /opt/freeswitch/conf/sip_profiles/internal.xml<br />
 Conflicting configuration files will be permanently erased if you continue!<br />
</code>
I just continued.<br />

After configuring bluebox, my default configuration was<br />
<code>
 cat /var/www/localhost/htdocs/bluebox/config/database.php<br />
 'type'     => 'mysql',<br />
 'user'     => 'bluebox',<br />
 'pass'     => 'bluebox',<br />
 'host'     => '127.0.0.1',<br />
 'port'     => '3306',<br />
 'socket'   => FALSE,<br />
 'database' => 'bluebox'<br />
</code>

You probably will want to change the password for user bluebox.<br />

Next edit /var/www/localhost/htdocs/bluebox/bluebox/config/config.php<br />
and disable the installer:<br />
<code> 
 config['installer_enabled'] = FALSE;
</code>


<big>'''CONFIGURING FreeSWITH with BLUEBOX'''</big><br />
START freeswitch:<br />
<code> 
 /etc/init.d/freeswitch start
</code>
crashed for me, but running it manually worked<br />
<code>
 /opt/freeswitch/bin/freeswitch [options such as hp,lp.rp ncwait]<br />
</code>
or
<code>
 /opt/freeswitch/bin/freeswitch -nc <br />
 /opt/freeswitch/bin/fs_cli<br />
</code>


NOW BROWSE to "http://your.web.server/bluebox/"<br />

INSTALL additional modules:<br />
System->Package Manager<br />
A few modules have pre-requisite modules so if you get an error, install the pre-requisite.<br />
A few pairs of modules conflict, e.g.:
* "Freeswitch" and "Asterisk"
* "Endpoint Manager" and "Provisioner"
* "Media File" and "Media Manager"
I chose "Freeswitch", "Endpoint Manager" and "Media File"<br />
and installed every remaining module except those for a call center.<br />

Bluebox came pre-installed with 3 sip interfaces<br />
"Connectivity" -> "SIP Interface"<br />
<code>
 Authenticated SIP	Auto Detect	5060	Required	Edit|Delete<br />
 Authenticated SIP - NAT	Auto Detect	5070	Required	Edit|Delete<br />
 Unauthenticated SIP	Auto Detect	5080	None	Edit|Delete<br />
</code>

Use the freeswitch cli to see your interfaces:<br />
<code>
freeswitch@myhost> sofia status <br />
                     Name          Type                                       Data      State<br />
 =================================================================================================<br />
           sipinterface_2       profile            sip:mod_sofia@192.168.1.40:5070      RUNNING (0)<br />
              voicemail_1         alias                             sipinterface_2      ALIASED<br />
           sipinterface_1       profile            sip:mod_sofia@192.168.1.40:5060      RUNNING (0)<br />
           sipinterface_3       profile            sip:mod_sofia@192.168.1.40:5080      RUNNING (0)<br />
             192.168.1.40         alias                             sipinterface_1      ALIASED<br />
 =================================================================================================<br />
 3 profiles 2 aliases<br />
</code>


Now configure users, devices, voicemail boxes, endpoints and assign numbers.<br />
It facilitates configuring your sip device if you first configure 
* the Users ("Organization" -> "User Manager")
* their Voicemail Boxes ("Applications" -> "Voicemail Boxes")
* the Endpoints ("Applications" -> "Endpoints")
and then 
* the sip phones ("Applications" -> "Devices")

The passwords for the users must be alphanumeric but the passwords for the sip devices and voicemail boxes need not be so. 
To keep things simple I used the same identifying string for device names, sip accounts, extensions.<br />
For example, Device Name "101" associated with user "John Doe" used sip account "101" and was assigned extension "101" and unanswered calls were transferred to the voicemail box for 101 (extension 201) All used the same password except for the the required alphanumeric password for the 
User Account for John Doe.

If you decide to have a default Multitenant system, 
then your sip registrations will use
"user@domain" instead of just "user" for the User Account<br />
Make sure that your user:password (or user@domain:password) 
for each Device in bluebox matches what you have configured for each sip phone.

First try to get sip registration working before attempting secure sip (sips) registration
or encrypted media (srtp). FreeSWITCH also has support for end-to-end encryption using 
[http://www.zrtp.org/ zrtp] (see the FreeSWITCH [http://wiki.freeswitch.org/wiki/ZRTP Wiki])
but you must use a sip phone which supports zrtp such as
such as the softphone [http://zfoneproject.com/prod_zfone.html Zfone]
Unfortunately, my Snom phones don't support zrtp and have no plans to do so.

Note that bluebox adds your sip devices to /etc/freeswitch/directory/default.xml<br />
So check and verify that your users have been added there.

Verify that your sip phones have registered with FreeSWITCH:<br />
<code>
 sofia status profile sipinterface_1<br />
 =================================================================================================<br />
 Name                    sipinterface_1<br />
 Domain Name             N/A<br />
 Auto-NAT                false<br />
 DBName           <br />
 Pres Hosts       <br />
 Dialplan                XML<br />
 Context                 multitenant_routing_context<br />
 Challenge Realm         auto_to<br />
 RTP-IP                  192.168.1.40<br />
 SIP-IP                  192.168.1.40<br />
 URL                     sip:mod_sofia@192.168.1.40:5060<br />
 BIND-URL                sip:mod_sofia@192.168.1.40:5060<br />
 HOLD-MUSIC              N/A<br />
 OUTBOUND-PROXY          N/A<br />
 CODECS IN               G7221@32000h,G7221@16000h,G722,PCMU,PCMA,GSM<br />
 CODECS OUT              G7221@32000h,G7221@16000h,G722,PCMU,PCMA,GSM<br />
 TEL-EVENT               101<br />
 DTMF-MODE               rfc2833<br />
 CNG                     13<br />
 SESSION-TO              0<br />
 MAX-DIALOG              0<br />
 NOMEDIA                 false<br />
 LATE-NEG                false<br />
 PROXY-MEDIA             false<br />
 AGGRESSIVENAT           false<br />
 STUN-ENABLED            true<br />
 STUN-AUTO-DISABLE       false<br />
 CALLS-IN                2<br />
 FAILED-CALLS-IN         1<br />
 CALLS-OUT               1<br />
 FAILED-CALLS-OUT        1<br />
 REGISTRATIONS           4<br />
</code>

Show registrations for sipinterface:<br />
<code>
 sofia status profile sipinterface_1 reg<br />
 <... excerpt ..><br />
 Call-ID:        3c26701f3482-2ou8k0j6yqug<br />
 User:           101@192.168.1.40<br />
 Contact:        "John Doe" <sip:101@192.168.1.101:2048><br />
 Agent:          snom360/8.4.32<br />
 Status:         Registered(UDP)(unknown) EXP(2012-05-18 20:26:09) EXPSECS(2869)<br />
 Host:           pbx<br />
 IP:             192.168.1.101<br />
 Port:           2048<br />
 Auth-User:      101<br />
 Auth-Realm:     pbx.mydomain.com<br />
 MWI-Account:    101@voicemail_1<br />
</code>

Now that our phones have registered with FreeSWITCH, 
check that you have a dial tone and can dial an internal extension<br />

If you want to test SIP from outside your network, <br />
apply for a free [[en.wikipedia.org/wiki/Direct_inward_dialing|DID]]<br />
from [http://www.ipkall.com/ IPKall] (Washington State)<br />
Just select an area code and choose a "SIP phone number" <br />
which can be any alphanumeric string, eg. "IPKall"<br />
Enter the "SIP Proxy" for your FreeSWITH server, eg. "pbx.mydomain.com:5080"<br />
Make sure you specify a  sip port of 5080 instead of the default 5060.<br />
Bluebox uses different sip ports to listen on for each different sip interface, e.g.:<br />
<code>
 Authenticated SIP	   Auto Detect	5060<br />
 Authenticated SIP - NAT   Auto Detect	5070<br />
 Unauthenticated SIP	   Auto Detect	5080<br />
</code>

Then go to "Routing -> Number Manager" and add your new number:
* Manage -> Number: "IPKall"
* Manage -> Type: Internal
* Device (Pick a destination such as Device "101"
* Contexts -> Inbound Routes
* Number Pools -> Device

Now add a trunk for IPKall "Connectivity -> Trunk Manager":
* Trunk Name: "IPKall"
* Trunk Type: "SIP Interface"
* Server: "voiper.ipkall.com"
* Bind To Interface: "Unauthenticated SIP"
* Made from these Contexts: "Inbound Routes"
* Caller ID Name: "ipkall"
* Caller ID Number: <DID number emailed to you by IPKall>

Now try phoning the IPKall DID phone number emailed to you.<br />
I got a busy signal, so I had to edit "Connectivity -> SIP Interfaces -> Unauthenticated SIP"<br />
and change "Inbound Calls -> Default Incoming Context" from "AUTO(Multitenant)" to "Inbound Routes"
since I opted not to have a multitenant system.

Next caveat is that I use NAT and need to forward the 
following udp ports from my router to my FS server:<br />
* 5060 (standard SIP)
* 5070 
* 5080
as well as the port range for rtp (10000 to 20000) 

In addition I use shorewall for the firewall on my FS server, 
so I need the following in my /etc/shorewall/rules:<br />
<code>
 # ASTERISK and FreeSWITCH
 ACCEPT          loc             $FW     tcp     5038 # AMP -- Asterisk Manager Protocol
 ACCEPT          all             $FW     udp     5036 # iax
 ACCEPT          all             $FW     udp     4569 # iax2
 # SIP
 ACCEPT          all             $FW     udp     5060 # sip
 ACCEPT          all             $FW     tcp     5060 # sip Some SIP servers need tcp as well
 ACCEPT          all             $FW     udp     5061 # sips
 ACCEPT          all             $FW     tcp     5061 # sips
 ACCEPT          all             $FW     udp     5070 # FreeSWITCH sip udp
 ACCEPT          all             $FW     tcp     5070 # FreeSWITCH sip tcp
 ACCEPT          all             $FW     udp     5080 # FreeSWITCH sip udp
 ACCEPT          all             $FW     tcp     5080 # FreeSWITCH sip tcp
 ACCEPT          all             $FW     udp     10000:20000     # rtp
 #ACCEPT         all             $FW     udp     2727 # MGCP media gateway control protocol
 #H323 tcp 522, 1503, 1720, 1731 and 8080
<code>

I also disabled connection tracking for sip in  /etc/shorewall/start
<code>
 modprobe -r nf_nat_sip        &> /dev/null<br />
 modprobe -r nf_conntrack_sip  &> /dev/null<br />
 #<br />
 modprobe -r nf_nat_h323       &> /dev/null<br />
 modprobe -r nf_conntrack_h323 &> /dev/null<br />
<code>

And I also added the above ports to /etc/shorewall/notrack:
<code>
 NOTRACK          loc             192.168.1.0/24     udp     5060 # sip<br />
 NOTRACK          loc             192.168.1.0/24     tcp     5060 # sip<br />
 NOTRACK          $FW             192.168.1.0/24     udp     5060 # sip<br />
 NOTRACK          $FW             192.168.1.0/24     tcp     5060 # sip<br />
 and so on for ports 5061, 5070, 5080, 10000:2000<br />
</code>
