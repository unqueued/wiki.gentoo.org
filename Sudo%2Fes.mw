<languages />

{{Metadata|abstract=La orden sudo ofrece una forma simple y segura de configurar el escalado de privilegios, esto es, permitir a los usuarios lanzar ciertas órdenes (o todas) como el usuario root o cualquier otro, y con la posibilidad de hacerlo sin introducir una contraseña.}}

{{Lowercase title}}
{{InfoBox stack
|{{InfoBox homepage|http://www.sudo.ws/|header=true}}
|{{InfoBox wikipedia|sudo}}
|{{InfoBox gitweb|http://www.sudo.ws/repos/sudo|raw=true}}
}}

La orden <tt>sudo</tt> ofrece una forma sencilla y segura de configurar el escalado de privilegios, esto es, permitir a los usuarios normales correr algunas (o todas) las órdenes que se deseen como root o como otro usuario, posiblemente sin tener que suministrar una contraseña.

Cuando quiera que varias personas realicen ciertas tareas administrativas en su sistema sin que tenga que concederles un acceso total como root, el uso de sudo es la mejor opción. Con sudo puede controlar quién puede hacer según qué. Esta guía le ofrece una pequeña introducción a esta maravillosa herramienta.

__TOC__

This article is meant as a quick introduction. The {{Package|app-admin/sudo}} package is a lot more powerful than what is described in this guide. It has special features for editing files as a different user (<tt>sudoedit</tt>), running from within a script (so it can background, read the password from standard in instead of the keyboard, ...), etc. 

Please read the <tt>sudo</tt> and <tt>sudoers</tt> manual pages for more information.

== Instalación ==

=== Ajustes USE ===

{{USEflag|package=app-admin/sudo
|ldap
|nls+Yes+Yes
|pam+Yes+Yes
|offensive
|skey
|selinux
|sendmail+Yes+Yes
}}

=== Emerge === 

{{Emerge|app-admin/sudo}}

== Configuración == 

=== Logging activity === 

One additional advantage of <tt>sudo</tt> is that it can log any attempt (successful or not) to run an application. This is very useful if you want to track who made that one fatal mistake that took you 10 hours to fix :) 

=== Granting permissions === 

The {{Package|app-admin/sudo}} package allows the system administrator to grant permission to other users to execute one or more applications they would normally have no right to. Unlike using the <code>setuid</code> bit on these applications <tt>sudo</tt> gives a more fine-grained control on ''who'' can execute a certain command and ''when''. 

Con <tt>sudo</tt> puede hacer una lista completa de "quién" puede ejecutar una aplicación determinada. Si estableciera el bit setuid, cualquier usuario podría ejecutar la aplicación (o cualquier usuario de un grupo en concreto, dependiendo de los permisos empleados). Puede (e incluso debería) exigir al usuario que proporcione una contraseña cuando éste quiera ejecutar la aplicación. 

La configuración de <tt>sudo</tt> se gestiona mediante el fichero {{Path|/etc/sudoers}}. Este fichero no se debe editar con <tt>nano /etc/sudoers</tt> o <tt>vim /etc/sudoers</tt> o cualquier otro editor. Cuando quiera modificar este fichero, tendrá que utilizar <tt>visudo</tt>. 

Esta herramienta se asegura que no haya dos administradores del sistema editando el fichero al mismo tiempo, conserva sus permisos y realiza una comprobación de la sintaxis para cerciorarse de que no se cometan errores fatales en el fichero. 

=== Sintaxis básica ===

La parte más difícil de <tt>sudo</tt> es la sintaxis de {{Path|/etc/sudoers}}. La sintaxis básica es la siguiente: 

{{CodeBox|title=Sintaxis básica de /etc/sudoers|1=
usuario nombre_de_equipo = órdenes
}}

Esta sintaxis le indica a <tt>sudo</tt> que el usuario, identificado como <code>usuario</code> y conectado al sistema <code>nombre_de_equipo</code>, puede ejecutar cualquiera de las órdenes listados en <code>órdenes</code> como usuario root. Un ejemplo más real podría ser más clarificador: permitir al usuario ''larry'' ejecutar <tt>emerge</tt> si está conectado al equipo localhost. 

{{CodeBox|title=Ejemplo real del fichero /etc/sudoers|1=
larry localhost = /usr/bin/emerge
}}

{{Note|El nombre del equipo debe coincidir con lo que devuelve la orden <tt>hostname</tt>.}}

{{Warning|No permita que un usuario lance una aplicación que pueda permitir que otros escalen sus privilegios. Por ejemplo, al permitir que los usuarios lancen <tt>emerge</tt> como root puede ofrecerles acceso total como root al sistema ya que se puede manipular <tt>emerge</tt> para cambiar el sistema de ficheros del sistema al antojo del usuario. Si no confía en sus usuarios <tt>sudo</tt>, no les otorgue ningún privilegio.}}

El nombre de usuario también se puede sustituir por un nombre de grupo. En este caso, debería anteponer el signo <code>%</code> al nombre del grupo. Por ejemplo, para permitir que cualquier usuario del grupo <tt>wheel</tt> pueda correr <tt>emerge</tt>: 

{{CodeBox|title=Permitir la ejecución de emerge a los miembros del grupo wheel|1=
%wheel localhost = /usr/bin/emerge
}}

Puede ampliar la línea para permitir varias órdenes (en lugar de escribir una línea para cada orden). Por ejemplo, para permitir al mismo usuario no sol correr <tt>emerge</tt> como root sino también <tt>ebuild</tt> y <tt>emerge-webrsync</tt>: 

{{CodeBox|title=Multiples órdenes|1=
larry localhost = /usr/bin/emerge, /usr/bin/ebuild, /usr/sbin/emerge-webrsync
}}

Puede incluso especificar una orden preciso y no solo la propia herramienta en sí. Esto es útil para restringir el uso de cierta herramienta a un grupo específico de argumentos. La herramienta <tt>sudo</tt> permite el uso de caracteres comodín del estilo del intérprete de órdenes (también conocidos como metacaracteres o caracteres "glob") en los nombres de ruta así como en argumentos de la línea de órdenes dentro del fichero sudoers. Observe que estos "no" son expresiones regulares. 

Pongamos todo esto a prueba: 

{{Cmd|sudo emerge -uDN world|output=<pre>
We trust you have received the usual lecture from the local System Administrator. It usually boils down to these three things:
(Confiamos en que haya recibido las indicaciones normales del Administrador del Sistema Local. Normalmente consisten en estas tres cosas;)

    #1&#41; Respect the privacy of others (Respete la privacidad del resto).
    #2&#41; Think before you type (Piense antes de escribir).
    #3&#41; With great power comes great responsibility (Grandes poderes conllevan grandes responsabilidades).

Contraseña: ## (Introduzca la contraseña del usuario ¡No la de root!)
</pre>
}}

La contraseña solicitada por <tt>sudo</tt> es la del propio usuario. Esto es para asegurarse de que ninguna terminal abierta accidentalmente a otros por error sea utilizada con fines dañinos. 

Debería saber que <tt>sudo</tt> no cambia la variable <code>${PATH}</code>: cualquier orden situada después de <tt>sudo</tt> se trata desde "su" entorno. Si desea que el usuario corra una herramienta ubicada en, por ejemplo, {{Path|/sbin}} éste debería proporcionar a <tt>sudo</tt> la ruta completa, algo como: 

{{Cmd|sudo /usr/sbin/emerge-webrsync}}

=== Sintaxis básica con LDAP === 

Los siguientes ajustes USE son necesarios para ofrecer soporte LDAP. 
{{USEflag|package=app-admin/sudo
|ldap++yes
|pam++Yes
}}

Cuando se utiliza sudo con LDAP, sudo también leerá la configuración del servidor LDAP, por lo que necesitará editar estos dos ficheros.

{{FileBox|filename=/etc/ldap.conf.sudo|title=Por favor, haga chmod 400 cuando haya terminado|1=
# Lea ldap.conf(5) y README.LDAP para más detalles
# Este fichero debería poder leerlo únicamente root

# Directivas ofrecidas: host, port, ssl, ldap_version
# uri, binddn, bindpw, sudoers_base, sudoers_debug
# tls_{checkpeer,cacertfile,cacertdir,randfile,ciphers,cert,key}

host ldap.example.com
port 389

base dc=example,dc=com

uri ldap://ldap.example.com/
#uri ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock 

ldap_version 3
#ssl start_tls

sudoers_base ou=SUDOers,dc=example,dc=com
#sudoers_debug 2

bind_policy soft
}}

{{FileBox|filename=/etc/nsswitch.conf|title=Por favor, añada la línea sudoers|1=
sudoers: ldap files
}}

También necesitará añadir la siguiente entrada LDAP para sudo.

{{Note|Debido al diseño, la rama Sudoers está encima del árblo por razones de seguridad. Puede tener distintos derechos de acceso desde ldap para leer o escribir en esta rama}}

{{CodeBox|title=Ldap Entry for Sudo|lang=ldif|1=
version: 1
DN: ou=SUDOers,dc=example,dc=com
objectClass: organizationalUnit
objectClass: top
objectClass: domainRelatedObject
associatedDomain: example.com
ou: SUDOers

DN: cn=defaults,ou=SUDOers,dc=example,dc=com
objectClass: top
objectClass: sudoRole
cn: defaults
description: Las opciones por defecto de sudo van aquí
sudoOption: env_reset

DN: cn=root,ou=SUDOers,dc=example,dc=com
objectClass: top
objectClass: sudoRole
cn: root
sudoCommand: ALL
sudoHost: ALL
sudoUser: root

DN: cn=%wheel,ou=SUDOers,dc=example,dc=com
objectClass: top
objectClass: sudoRole
cn: %wheel
sudoCommand: ALL
sudoHost: ALL
sudoOption: !authenticate
sudoUser: %wheel
}}

{{CodeBox|title=Ldap Entry for wheel Group|lang=ldif|1=
version: 1
DN: cn=wheel,ou=Group,dc=example,dc=com
objectClass: top
objectClass: posixGroup
cn: wheel
description: Grupo Wheel
gidNumber: 10
memberUid: useradmin1
memberUid: root
}}

Las configuraciones del sudoer en LDAP son similares a los ficheros con algunas diferencias. Por favor, lea más sobre sudo con LDAP en el enlace de abajo [http://www.sudo.ws/sudo/sudoers.ldap.man.html página del manual de Sudoers LDAP]

<references />

=== Utilizar alias ===

En entornos más extensos que tengan que dar acceso a todos los usuarios una y otra vez (o equipos u órdenes) las tareas pueden ser más costosas de realizar. Para facilitar la administración de {{Path|/etc/sudoers}}, puede definir "alias". El formato para declarar los alias es muy fácil: 

{{CodeBox|title=Declararar alias en /etc/sudoers|1=
Host_Alias hostalias = equipo1, equipo2, ...
User_Alias useralias = usario1, usuario2, ...
Cmnd_Alias cmndalias = orden1, orden2, ...
}}

Un alias que siempre funciona, en cualquier posición, es <code>ALL</code> (para distinguir correctamente entre lo que son y no son alias, se recomienda utilizar mayúsculas para los alias). Como indudablemente habrá deducido, el alias <code>ALL</code> sirve para todas los valores posibles. 

Un ejemplo de uso del alias <code>ALL</code> para permitir a "cualquier" usuario lanzar la orden <tt>shutdown</tt> si ha accedido al sistema local es: 

{{CodeBox|title=Permitir que cualquier usuario puede ejecutar shutdown|lang=bash|1=
ALL localhost = /sbin/shutdown
}}

Otro ejemplo es permitir al usuario <tt>larry</tt> lanzar la orden <tt>emerge</tt> como root, independientemente del equipo donde haya iniciado sesión: 

{{CodeBox|title=Permitir al usuario lanzar una aplicación independientemente de su localización|1=
larry ALL = /usr/bin/emerge
}}

Más interesante es definir un conjunto de usuarios que puedan correr aplicaciones de software administrativo (como por ejemplo <tt>emerge</tt> y <tt>ebuild</tt>) en el sistema y un grupo de administradores que puedan cambiar la contraseña de cualquier usuario, excepto la de root: 

{{CodeBox|title=Utilizar un alias para usuarios y órdenes|1=
User_Alias SOFTWAREMAINTAINERS = larry, john, danny
User_Alias PASSWORDMAINTAINERS = larry, sysop
Cmnd_Alias SOFTWARECOMMANDS = /usr/bin/emerge, /usr/bin/ebuild
Cmnd_Alias PASSWORDCOMMANDS = /usr/bin/passwd [a-zA-Z0-9_-]*, !/usr/bin/passwd root

SOFTWAREMAINTAINERS localhost = SOFTWARECOMMANDS
PASSWORDMAINTAINERS localhost = PASSWORDCOMMANDS
}}

=== Non-root execution ===

It is also possible to have a user run an application as a different, non-root user. This can be very interesting if you run applications as a different user (for instance <tt>apache</tt> for the web server) and want to allow certain users to perform administrative steps as that user (like killing zombie processes). 

Inside {{Path|/etc/sudoers}} you list the user(s) in between <code>(</code> and <code>)</code> before the command listing: 

{{CodeBox|title=Sintaxis de ejecución para usuarios no root|1=
usuarios  equipos = (lanzar-cómo) órdenes
}}

For instance, to allow <tt>larry</tt> to run the <tt>kill</tt> tool as the <tt>apache</tt> or <tt>gorg</tt> user: 

{{CodeBox|title=Ejemplo de ejecución como usuario no root|1=
Cmnd_Alias KILL = /bin/kill, /usr/bin/pkill
  
larry   ALL = (apache, gorg) KILL
}}

With this set, the user can run <tt>sudo -u</tt> to select the user he wants to run the application as: 

{{Cmd|sudo -u apache pkill apache}}

You can set an alias for the user to run an application as using the <code>Runas_Alias</code> directive. Its use is identical to the other <code>_Alias</code> directives we have seen before. 

=== Passwords and default settings ===

By default, <tt>sudo</tt> asks the user to identify himself using his own password. Once a password is entered, <tt>sudo</tt> remembers it for 5 minutes, allowing the user to focus on his tasks and not repeatedly re-entering his password. 

Of course, this behavior can be changed: you can set the <code>Defaults:</code> directive in {{Path|/etc/sudoers}} to change the default behavior for a user. 

For instance, to change the default 5 minutes to 0 (never remember): 

{{CodeBox|title=Changing the timeout value|1=
Defaults:larry  timestamp_timeout=0
}}

A setting of <code>-1</code> would remember the password indefinitely (until the system reboots). 

A different setting would be to require the password of the user that the command should be run as and not the users' personal password. This is accomplished using <code>runaspw</code>. In the following example we also set the number of retries (how many times the user can re-enter a password before <tt>sudo</tt> fails) to <code>2</code> instead of the default 3: 

{{CodeBox|title=Requiring the root password instead of the user's password|1=
Defaults:john   runaspw, passwd_tries=2
}}

Another interesting feature is to keep the <code>DISPLAY</code> variable set so that you can execute graphical tools: 

{{CodeBox|title=Keeping the DISPLAY variable alive|1=
Defaults:john env_keep=DISPLAY
}}

You can change dozens of default settings using the <code>Defaults:</code> directive. Fire up the <tt>sudoers</tt> manual page and search for <code>Defaults</code>. 

If you however want to allow a user to run a certain set of commands without providing any password whatsoever, you need to start the commands with <code>NOPASSWD:</code>, like so: 

{{CodeBox|title=Allowing emerge to be ran as root without asking for a password|1=
larry     localhost = NOPASSWD: /usr/bin/emerge
}}

=== Bash completion ===

Users that want bash completion with sudo need to run this once.

{{Cmd|sudo echo "complete -cf sudo" >> $HOME/.bashrc}}

=== Zshell completion ===

Users that want zsh completion for sudo can set the following in {{Path|.zprofile}} and {{Path|.zshrc}} respectively

{{FileBox|filename=.zprofile|title=Adding zshell completion|lang=bash|1=
if [[ $EUID != 0 ]]; then
    typeset -xT SUDO_PATH sudo_path
    typeset -U sudo_path 
    sudo_path=({,/usr/local,/usr}/sbin(N-/))
    alias sudo="sudo env PATH=\"SUDO_PATH:$PATH\""
fi
}}

{{FileBox|filename=.zshrc|title=Adding zshell completion|lang=bash|1=
zstyle ':completion:*:sudo:*' environ PATH="$SUDO_PATH:$PATH"
}}

With the above change, all commands in the {{Path|/sbin}}, {{Path|/usr/sbin}} and {{Path|/usr/local/sbin}} locations will be available to the shell for completion when the command is prefaced with 'sudo'.

== Utilización ==

=== Listar privilegios ===

Ejecute <tt>sudo -l</tt> para informarse de cuáles son sus capacidades: 

{{Cmd|sudo -l|output=<pre>
El usuario larry puede lanzar las siguiente órdenes en este equipo:
  (root) /usr/libexec/xfsm-shutdown-helper
  (root) /usr/bin/emerge
  (root) /usr/bin/passwd [a-zA-Z0-9_-]*
  (root) !/usr/bin/passwd root
  (apache) /usr/bin/pkill
  (apache) /bin/kill
</pre>
}}

Si tiene cualquier orden en {{Path|/etc/sudoers}} que no le pida que introduzca una contraseña, tampoco se le pedirá una contraseña para listar las
entradas. De no ser así, se le podría pedir su contraseña si no se recuerda. 

=== Prolongar la caducidad de la contraseña ===

By default, if a user has entered their password to authenticate their self to <tt>sudo</tt>, it is remembered for 5 minutes. If the user wants to prolong this period, he can run <tt>sudo -v</tt> to reset the time stamp so that it will take another 5 minutes before <tt>sudo</tt> asks for the password again. 

{{Cmd|sudo -v}}

The inverse is to kill the time stamp using <tt>sudo -k</tt>. 


[[Category:Software]]
