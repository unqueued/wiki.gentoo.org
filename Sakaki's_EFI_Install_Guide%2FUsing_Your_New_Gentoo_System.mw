<!-- Page: Using_Your_New_Gentoo_System -->

<span id="using_your_new_system">In this (final) section</span>, we'll consider a number of miscellaneous (but important) topics regarding your new system. Although this final part of the tutorial has no precise analogue in the Gentoo manual, it logically relates to [[Handbook:AMD64/Installation/Finalizing#Where_to_go_from_here|Chapter 11]].

The topics we'll briefly cover are:
* recapping how to boot to Linux from Windows (and vice versa);
* keeping your machine up to date;
* migrating your kernel to the internal hard drive (optional);
** and how to dispense with the USB key entirely (also optional);
* tweaking GNOME; and
* installing a firewall, and other applications.

Let's go!

== <span id="dual_boot_procedure">Booting into Linux or Windows (Recap)</span> ==

With the setup you have just carried out, you can easily boot your target PC into either Gentoo Linux or Windows 8, as desired. Here's a brief recap of how to go about it (with links back to the more detailed explanations in the body of the text, where relevant):
* If you power up the machine ''without'' the boot USB key inserted, '''Windows''' will always load automatically. You can do this safely even if you hibernated your Linux session last time (assuming you had no Windows partitions mounted in Linux!). {{Note|If you migrate your kernel to the internal hard drive, however, this trick won't work, and you'll have to use the <tt>efibootmgr</tt> utility to change your boot order, when you wish to boot to Windows (the use of this software was [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#use_efibootmgr{{!}}described earlier]]).}}
** All your Linux data is ultimately held within an encrypted LUKS partition, and so cannot be 'snooped' by malware running in Windows. Nor can Windows software read your <tt>gpg</tt> keyfile or kernel, as the boot USB key is not physically present when Windows is running.
** Windows updates etc. should leave the LUKS partition entirely unaffected (and cannot access the boot USB key either, assuming you don't insert it mid-session).
** If you <span id="win8_to_linux">are running Windows 8</span>, and wish to reboot into Linux instead, be sure to ''restart'' the machine from Windows (''not'' shut it down - unless you have disabled [http://www.howtohaven.com/system/how-to-shutdown-windows-8.shtml hybrid shutdown] as was recommended at the [[EFI_Gentoo_End_to_End_Install/Preparing_Windows_8_for_Dual-Booting#disable_fast_boot{{!}}start of the tutorial]]).<ref>Windows Secrets: [http://windowssecrets.com/langalist-plus/with-windows-8-off-isnt-really-off/ "With Windows 8, 'off' isn't really ''off''"]</ref> Insert the boot USB key while the system is closing down prior to the reboot. Then, immediately the machine commences restarting, enter the BIOS (the key combination needed to do this varies from machine to machine, it is {{Key|F2}} on the CF-AX3). If you [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#set_bios_pw|set one earlier]], you'll need to enter your BIOS password at this point. Then, choose "<tt>Gentoo Linux (USB Key)</tt>" as the highest priority EFI boot entry, save changes and restart (if the BIOS does not immediately recognize the USB key, you may need to do the 'save changes and restart' cycle twice). A more detailed exposition of how to do this on the CF-AX3 was presented [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#reboot_from_win8_to_linux|earlier in the text]]. The machine should then restart into Linux as usual. {{Note|As mentioned [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#win_restart_use_a_device{{!}}previously]], <span id{{=}}"win8_use_a_device">there is another way</span> to boot to Linux from Windows, without needing to go through the BIOS, as follows. <br>While running Windows 8,  hit {{Key|Ctrl}}{{Key|Alt}}{{Key|Delete}}, then click on the power icon at the bottom right of the screen, and then ''while holding down'' {{Key|Shift}}, click 'Restart' from the pop-up menu. This will pass you into the Windows boot options menu. Once this comes up (and asks you to 'Choose an option'), click on the 'Use a device' tile. This will show another page, on which you will see a tile entitled 'Gentoo Linux (USB Key)' (and possibly some others). Insert the boot USB key, click the tile, and you should find that the system restarts and that Linux is loaded (and you then get the usual <tt>plymouth</tt> passphrase screen, etc.). <br>So far, so good, since this way of working avoids going through the BIOS. However, when you do this, Windows has only really set the (one-time) 'boot next' value in EFI, which means that once you restart ''again'' from Gentoo (even with the boot USB key still inserted), Windows will start up. To get around this, you need to set the boot order using the <tt>efibootmgr</tt> tool in Gentoo, as [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#use_efibootmgr{{!}}described previously]]. This can easily be automated, for convenience.}}
* Now, if you are running '''Linux''', and then power down the machine, then power it back up with the USB key inserted, it should start up Linux again automatically (you'll have to enter your LUKS keyfile <tt>gpg</tt> passphrase (the one you created [[EFI_Gentoo_End_to_End_Install/Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#create_gpg_luks_keyfile|earlier]]) to gain access of course). It is '''entirely safe to remove the boot USB key once you get to the GNOME login screen''' (and indeed, it is recommended that you do so, for security). You can do any work you like under Linux, power the machine down, suspend or hibernate it, ''without'' needing to re-insert the boot USB key. Then:
** If you suspend (sleep) the machine from Linux, you can come back out of suspend without needing to re-insert the key (just slide the power button).
** If you hibernate the machine from Linux, insert the boot USB key immediately before powering up again. Upon restart, you'll have to enter the GPG-encrypted LUKS keyfile passphrase, and should then be presented with a GNOME login prompt (as before, you can remove the boot USB key at this point). Log in, and you'll find your desktop the way you left it on hibernation.
** If you power the machine off from Linux, simply remember to insert the USB key before sliding the power key again (otherwise you'll reboot into Windows, as above).
** Similarly, if you have hibernated from Linux, and power back up ''without'' re-inserting the boot USB key, your machine will come up in Windows 8. This isn't a problem (unless you had any of the Windows partitions deliberately mounted in your Linux session!), because you can use Windows as necessary and then, when done, follow the process [[#win8_to_linux|above]] to restart back into Linux again (it'll remember that you hibernated, and come back into your old session).

The whole process is easier to do in practice than it is to describe! It has the advantage of not requiring multiple EFI system partitions on the machine's main drive (something which Microsoft specifically cautions is unsupported under Windows<ref name="how_many_sys_partitions">SuperUser Forum: [http://superuser.com/questions/688617/how-many-efi-system-partitions-esp-can-a-computer-have#688758 "How many EFI System Partitions (ESP) can a computer have?"]</ref>), nor a separate bootloader. Furthermore, Windows 8 will sometimes overwrite the EFI boot list anyway, even when a bootloader is used, so taking that approach doesn't necessary buy you anything.<ref>ZDNet: [http://www.zdnet.com/seven-ways-to-set-up-multi-booting-with-windows-8-and-linux-7000026392/ "Seven ways to set up multi-booting with Windows 8 and Linux"]</ref>

If you would like to use Windows 8's EFI system partition (the one on the internal drive) to store your kernel (or even dispense with the need for a USB key during boot altogether), instructions for doing so will be provided [[#migrating_off_usb_key|later in this chapter]].

{{Note|If you should forget the <tt>gpg</tt> keyfile passphrase, but have setup a fallback passphrase on the LUKS partition [[EFI_Gentoo_End_to_End_Install/Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#add_fallback_luks_passphrase{{!}}earlier in the tutorial]], you can use this by renaming the file <tt>luks-key.gpg</tt> (at the top level on the boot USB key) to <tt>luks-key.gpg.old</tt>. Then, when prompted for the password on boot (at the 'bunch of keys' prompt), type in your fallback passphrase, and you should be able to gain access. Since the boot key is formatted with <tt>fat32</tt>, you should be able to insert it into pretty much any Windows or Linux box to do the rename.}}

== <span id="updating_software">Keeping Your Machine Up to Date</span> ==

The <tt>genup</tt> tool makes it easy to keep your machine (kernel and packages) up to date. To perform a full update at any time, first open a root terminal in GNOME (if you don't already have one open): press the {{Key|Windows Key}}, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. Become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[EFI_Gentoo_End_to_End_Install/Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

Ensure that your boot USB key is inserted (this will be required if there is a kernel upgrade). Then, in this terminal, issue:
{{RootCmd
|genup --dispatch-conf --deploy-from-staging
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

and the update will proceed automatically (the <tt>--dispatch-conf</tt> option means that, although not running in interactive mode per se, you ''will'' be prompted to resolve clashing changes to configuration files, should any arise, and the <tt>--deploy-from-staging</tt> will copy over any new kernel to the boot USB key, once built). When the process completes (you get the message "<tt>All done</tt>"), remove the boot USB key again, and close out the terminal.

{{Note|Should <span id{{=}}"troubleshooting_genup">errors occur</span> during the process, here are some hints that may be useful.

First, if the problem has occurred when building a new kernel, try working through the process manually. In the root terminal, issue:
{{RootCmd
|cd /usr/src/linux
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
then:
{{RootCmd
|make clean
|make olddefconfig
|make
|prompt=koneko <span style{{=}}"color:royalblue;">linux #</span>
}}
and note what errors are reported. You can then do an internet search etc. to see how to resolve them.

If, instead, problems occur during the main <tt>emerge</tt> phase, review the <tt>genup</tt> output for details. Most often, the issue will be caused by missing USE flags, license permissions or circular dependencies (in all of which cases, <tt>emerge</tt> will have printed a helpful, self-explanatory message about what to do).

If the problem appears more gnarly that that, see the [[EFI_Gentoo_End_to_End_Install/Building_the_Gentoo_Base_System_Minus_Kernel#troubleshooting_failed_build{{!}}"Troubleshooting a Failed Build"]] section earlier for some hints as to how to proceed. Then, when ready, ensure your boot USB key is inserted, and simply issue:
{{RootCmd
|genup --dispatch-conf --deploy-from-staging
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
to try again.
}}

If the output of <tt>genup</tt> informed you that a new kernel has been built, you should reboot your machine at this point to start using it.

{{Note|A more detailed overview of <tt>genup</tt> may be found [[EFI_Gentoo_End_to_End_Install/Configuring_systemd_and_Installing_Necessary_Tools#ensure_system_up_to_date{{!}}earlier in the tutorial]], together with instructions for using [[EFI_Gentoo_End_to_End_Install/Building_the_Gentoo_Base_System_Minus_Kernel#using_dispatch_conf{{!}}<tt>dispatch-conf</tt>]].}}

=== <span id="automating_genup">Automating <tt>genup</tt> (Optional)</span> ===

To ensure you don't forget updates, you can schedule <tt>genup</tt> to run automatically (this is entirely optional, of course). One simple approach is to use {{Path|/etc/cron.daily}} to have it executed every night (at around 3am on most systems; check {{Path|/etc/crontab}} for details<ref>ServerFault Forum: [http://serverfault.com/questions/135906/when-does-cron-daily-run#135940 "When does `cron.daily` run?"]</ref>).

To set this up, first open a root terminal in GNOME (if you don't already have one available): press the {{Key|Windows Key}}, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. Become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[EFI_Gentoo_End_to_End_Install/Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

Then issue:
{{RootCmd
|nano -w /etc/cron.daily/genup
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

Then <span id="genup_cron_file">put the following</span> text in the file:
{{FileBox|filename=/etc/cron.daily/genup|title=Having genup run automatically|lang=bash|1=
#!/bin/bash
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin"
genup >/var/log/latest-genup-run.log 2>&1
}}
Save and exit the <tt>nano</tt> editor, and make the file executable:
{{RootCmd
|chmod -v +x /etc/cron.daily/genup
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
(You can now close out the root terminal if you have no further use for it.)

<span id="overnight_genup">That's it!</span> Your system will now attempt to update each night, without requiring any input from you. Also, because you have ''not'' specified <tt>--deploy-from-staging</tt> here, there's no need to have your boot USB key inserted when the process runs (any new kernel will still be built, but then simply retained in the staging area at {{Path|/boot}}, until you issue <tt>buildkernel --copy-from-staging</tt>, as described [[#deploy_batch_kernel|shortly]]).

Although this is automatic, you ''do'' need to do a bit of checking periodically that this worked OK (each morning, say). To do this, open a root terminal in GNOME (as just described), and issue:
{{RootCmd
|tail --lines{{=}}20 /var/log/latest-genup-run.log
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

If the tail of the log just printed contains text similar to the below:
{{GenericCmd|<pre>
* genup: Warning: There are configuration file changes pending review!
* genup: Warning: Please run dispatch-conf to interactively resolve them.
</pre>
}}
then, as instructed, you need to run <tt>dispatch-conf</tt>; so do so now:
{{RootCmd
|dispatch-conf
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
See the [[EFI_Gentoo_End_to_End_Install/Building_the_Gentoo_Base_System_Minus_Kernel#using_dispatch_conf|explanation earlier in this tutorial]] for how to use <tt>dispatch-conf</tt>.

<span id="deploy_batch_kernel">Next, if the tail of the log contains</span> text similar to the below:
{{GenericCmd|<pre>
* An updated kernel has been successfully built in the staging area!
* You can install it to your EFI system partition by issuing:
*  buildkernel ----copy-from-staging
</pre>
}}
then you need to copy it across (it has already been built in the staging area). Insert your boot USB key, then issue:
{{RootCmd
|buildkernel --copy-from-staging
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
When this completes (it shouldn't take long), remove the boot USB key, and close out the root terminal if you have no further use for it (or, alternatively, leave the key inserted and reboot, to start using your new kernel immediately).

{{Note|If the <tt>genup</tt> process exited with an error (as shown in {{Path|/var/log/latest-genup-run.log}}), refer to the [[#troubleshooting_genup{{!}}troubleshooting notes above]].}}

== <span id="switching_to_webrsync">Switching to <tt>emerge-webrsync</tt> for Security (Optional)</span> ==

This is an entirely optional step, but you may choose to update your local portage tree with only ''signed'' snapshots, as opposed to using <tt>rsync</tt>. This is considerably less efficient in terms of bandwidth, but does provide protection against rogue <tt>rsync</tt> mirrors adding or changing code or packages.

To make use of this feature, follow the instructions under [[Handbook:AMD64/Working/Features#Pulling_validated_portage_tree_snapshots|"Pulling Validated Portage Tree Snapshots"]] in the Gentoo Handbook (summarized again below for convenience).

First, open a root terminal in GNOME (if you don't already have one available): press the {{Key|Windows Key}}, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. Become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[EFI_Gentoo_End_to_End_Install/Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

Then make a directory to hold the necessary <tt>gpg</tt> public keys:
{{RootCmd
|mkdir -pv /etc/portage/gpg
|chmod -v 700 /etc/portage/gpg
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
Next, download and accept the Gentoo release engineering keys, as specified on the [https://www.gentoo.org/proj/en/releng/index.xml Release Engineering] page. You need at least the fingerprint of the key described as "Gentoo Portage Snapshot Signing Key (Automated Signing Key)":
{{RootCmd
|gpg --homedir /etc/portage/gpg --keyserver pool.sks-keyservers.net --recv-key 96D8BF6D
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|Substitute the correct key fingerprint (taken from the Release Engineering home page) for <tt>96D8BF6D</tt> in the above. If in doubt, import all (unexpired) keys on that page, by repeating the above two steps as necessary.}}
{{Note|As before, for this to work you must ensure you have enabled outbound access on your firewall (if you have one installed) for port 11371/tcp to allow [[:Wikipedia:Key_server_(cryptographic)|HKP]] communication, along with the usual state-tracking input rule.}}
{{Note|If the above keyserver is unavailable for some reason, you should be able to use any other one, such as <tt>pgp.mit.edu</tt> for example.}}

You can set the key's trust at this point if you like. However, it isn't necessary (<tt>emerge-webrsync</tt> just looks at the exit value of <tt>gpg --verify</tt>).
Next, edit {{Path|/etc/portage/make.conf}}, and enable support for validating the signed Portage tree snapshots. Issue:
{{RootCmd
|nano -w /etc/portage/make.conf
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

and ''append'':
{{FileBox|filename=/etc/portage/make.conf|title=Append lines to use gpg signature checking with webrsync|lang=bash|1=
FEATURES="webrsync-gpg"
PORTAGE_GPG_DIR="/etc/portage/gpg"
}}
Save and exit the <tt>nano</tt> editor.
{{Note|Obviously, if you already have a <tt>FEATURES</tt> variable defined in {{Path|/etc/portage/make.conf}}, ''append'' the "<tt>webrsync-gpg</tt>" text to its string, rather than setting the variable anew as here.}}

There is no need to disable conventional <tt>rsync</tt> (''pace'' the handbook), as it won't be used unless you explicitly call it (with <tt>emerge --sync</tt>). Note however that you ''must'' take care to use the <tt>-w</tt> option with <tt>eix-sync</tt> (so that it calls <tt>emerge-webrsync</tt>, rather than <tt>emerge --sync</tt>, internally). If you are using <tt>genup</tt> to manage your updates, this is taken care of for you automatically (it will notice that the <tt>webrsync-gpg</tt> feature has been set and act accordingly).

Try it out now, to make sure everything is still working:
{{RootCmd
|genup --no-kernel-upgrade --dispatch-conf
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
Note that this will take quite a bit longer than before, as it has now to pull down the full Portage tree each time. However, if you have automated the process to run overnight, this shouldn't impact you too much.

{{Note|If you have recently performed a conventional <tt>rsync</tt>-based update, you may need to remove the file {{Path|/usr/portage/metadata/timestamp.x}} before running the above command, to ensure that it actually performs a download.}}

When completed, close out the root terminal if you have no further use for it.

== <span id="migrating_off_usb_key">Migrating Off the Boot USB Key (Optional)</span> ==

Up until now, we have been using a boot USB key to hold your (stub EFI) kernel and GPG-encrypted LUKS keyfile. This approach has a number of advantages:
* It let us get around the 'EFI chicken and egg' problem - namely that it is only possible to modify the EFI boot list when ''already'' booted under EFI - by exploiting the exception that most UEFI BIOSes will boot specially named EFI images on removable drives. Of course, now we have an EFI system running, this advantage is moot.
* It provides dual factor security - you need both the keyfile ''and'' its passphrase to access the LUKS partition. This confers a degree of protection against hardware keyloggers etc., which a 'passphrase only' (or, indeed, 'keyfile only') LUKS approach would lack.
** Similarly, if you physically destroy the USB key and all backups, your LUKS data will be gone forever. Even someone with your GPG passphrase would be unable to recover it. Of course, this is a double-edged sword!
* If the system is booted without the key inserted, it will automatically come up in Windows 8.
* When Windows is running, malware is unable to see your kernel image (assuming you leave the USB key unplugged) nor can it copy your GPG-encrypted keyfile.
** Similarly, there is no risk of Windows accidentally (during an upgrade, for example) overwriting your kernel, or experiencing problems because your kernel has consumed too much space in the (internal hard drive) EFI system partition.
* You can use a large-capacity USB key, with plenty of room for snapshot backups etc.

Nevertheless, some users may prefer to use their internal hard drive's EFI system partition to store the kernel (retaining the USB key for GPG-encrypted keyfile only, to preserve dual-factor security). Others may like to go even further, and remove the need for the USB key altogether on boot (relying on a passphrase only, Ubuntu-style<ref>EFF: [https://www.eff.org/deeplinks/2012/11/privacy-ubuntu-1210-full-disk-encryption "Privacy in Ubuntu 12.10: Full Disk Encryption"]</ref>). While there are six logical possibilities here (and all are simple to achieve via <tt>buildkernel --easy-setup</tt>), not all make sense, as the table below demonstrates:

{| class="wikitable"
|-
! rowspan="2" colspan="2" | !! colspan="3" | GPG-Encrypted LUKS Keyfile Location
|-
! USB Key || Internal Drive || None (Fallback Passphrase Only)
|- valign="top"
! rowspan="2" | Kernel Location || USB Key
| bgcolor="PaleGreen" | (Option 1)<br>You have this now:
* maximum security (assuming no fallback passphrase set)
* ample storage capacity (with appropriate USB key)
* but, slightly fiddly, USB key needed for boot
| bgcolor="PeachPuff" | (Option 2)<br>Pointless:
* if machine stolen so is keyfile
| bgcolor="PeachPuff" | (Option 3)<br>Pointless:
* dual-factor security lost
* but, USB key still needed to boot
|- valign="top"
! Internal Drive
| bgcolor="PaleGoldenRod" | (Option 4)<br>Reasonable option:
* dual-factor security retained
* faster boot
* no need to insert USB key to deploy kernel (only to boot)
* but, limited storage capacity may obviate kernel backups
| bgcolor="PeachPuff" | (Option 5)<br>Pointless:
* if machine stolen so is keyfile
| bgcolor="PaleGoldenRod" | (Option 6)<br>Maximum convenience option:
* no USB key required at all
* faster boot
* but, dual-factor security lost
* limited storage capacity may obviate kernel backups
|}

Accordingly, instructions are provided below for migration from option 1 (which you have now) to options 4 and 6, below.

{{Important|These are purely optional, and mutually exclusive, approaches! If the current, USB-based setup (option 1)  works fine for you, by all means retain it for day-to-day use.}}

=== <span id="option_4_migration">Using the Internal Drive EFI System Partition for the Kernel (Option 4)</span> ===

This <span id="option_4_comments">is a somewhat</span> attractive option. By using the (Windows) EFI system partition to store the kernel, boot times are reduced, and you can perform full upgrades (including any kernel deployment) without having to insert the USB key.
{{Note|As [[#overnight_genup{{!}}described earlier]] however, even in an 'option 1' system, you can perform all but the final copy-kernel-from-staging step (using <tt>genup</tt>) ''without'' having to insert the boot USB key, so this is not a major problem.}} However, you may experience issues due to the lack of space in the internal drive EFI system partition, particularly if you have not slimmed down your kernel configuration (as described [[EFI_Gentoo_End_to_End_Install/Final_Configuration_Steps#cleaning_kernel_config|earlier]]).

{{Note|To give some sense of scale about the 'free space' issue:
* the internal drive EFI system partition is 100MB in size (approximately) on the CF-AX3 (and this is common for many Windows 8 installs <ref name="ms_efi_faq">Microsoft: [http://msdn.microsoft.com/en-us/library/windows/hardware/dn640535%28v{{=}}vs.85%29.aspx#gpt_faq_how_big_esp "Windows and GPT FAQ: Answers about Windows GPT required partitions: EFI System Partition"]</ref>);
* a 'default' kernel (with encapsulated initramfs, as per the instructions in this tutorial) will be around 40MB in size (as of Linux 3.12.21);
* the same kernel after the <tt>localmodconfig</tt> treatment (see [[EFI_Gentoo_End_to_End_Install/Final_Configuration_Steps#using_localmodconfig|earlier]]) will be about 30MB;
* a 'slimmed down configuration' version (done manually) of that same kernel will be around 15MB (with all firmware);
* if you keep only the firmware you need, it should fall to <5MB (the easiest way to do this is to define the <tt>user_modify_initramfs</tt> hook function in {{Path|/etc/buildkernel.conf}}, adding code to delete unnecessary files from the <tt>initramfs</tt> filesystem);
* Windows 8.1 takes about 20MB on the EFI system partition for its own files; plus you probably need to allow the same again (for updates, backups, installations etc. that Windows may perform);
* if you choose to store the GPG-encrypted LUKS key on the internal system partition as well (not required for either option 4 or 6), that will consume just over 8MB.}}
{{Note|It is ''not'' recommended to create a second EFI system partition on your internal drive - while this ''is'' allowed under the EFI specifications, according to Microsoft, "such a configuration should not be created and is not supported in Windows".<ref name="ms_efi_faq"/>}}
{{Note|If there is insufficient space on the target EFI system partition, <tt>buildkernel</tt> will automatically delete the old backup (if any), and skip the new backup, to save space; so for most systems the default, 'unslimmed' kernel ''should'' work even in an 'option 4' (or 6) configuration (however, remember that without backups, that you won't have a fallback in place should a configuration problem cause issues at boot time).}}

When using the internal drive EFI system partition, Windows malware can read your kernel (and configuration), although it is protected against tampering by its cryptographic signature (of course, malware with access to the ''Microsoft'' private keys could modify your kernel and resign it...).

A final point to bear in mind is that, whenever you wish to restart from Linux to Windows, you will have to change the EFI boot list ''explicitly'', using the <tt>efibootmgr</tt> tool (the use of which was [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#use_efibootmgr|described previously]]). You can no longer simply restart the machine without the boot key present (as you can with 'option 1').

With all that in mind, if you still wish to migrate to an 'option 4' configuration, proceed as follows.

First, open a root terminal in GNOME (if you don't already have one available): press the {{Key|Windows Key}}, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. Become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[EFI_Gentoo_End_to_End_Install/Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

Next, use the <tt>buildkernel --easy-setup</tt> tool to make the necessary changes to {{Path|/etc/buildkernel.conf}}.
{{Note|You can of course make the necessary changes to {{Path|/etc/buildkernel.conf}} with an editor, but using the menu-driven tool reduces the chances for error.}}

Issue (the following session is an example only; the values output will obviously vary for your machine):

{{RootCmd
|buildkernel --easy-setup
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=
 &nbsp;
 <span style{{=}}"color:green;">*</span> Current configuration (from /etc/buildkernel.conf):

   EFI system partition UUID:  2498f874-ad8f-484e-8aba-81ac1c9665b6
   LUKS root partition UUID:   8111286a-d24e-4ba2-b6af-d0650fab4130
   GPG keyfile partition UUID: DEFAULT (=EFI system partition UUID)
   GPG keyfile (for LUKS):     luks-key.gpg                        
   EFI boot directory:         /EFI/Boot                           
   EFI boot file:              gentoo.efi                         
   Plymouth theme              fade-in                 
   Boot-time keymap            jp                                  

 <span style{{=}}"color:green;">*</span> Please choose an option:
 1) Set EFI system partition  5) Set boot splash options
 2) Set LUKS root partition   6) Set boot-time keymap
 3) Set LUKS key options      7) Exit without saving
 4) Set EFI boot file path    8) Save and exit
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|1}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 
 <span style{{=}}"color:green;">*</span> Please choose which EFI system partition to use (or GO BACK):
 Num Partition UUID                       Path       USB Win Use
 --- ------------------------------------ ---------- --- --- ---
  1) 2498f874-ad8f-484e-8aba-81ac1c9665b6 /dev/sdb1   Y   N  [*]
  2) f236e16c-ca97-4c36-b0d5-4196fa1e9930 /dev/sda2   N   Y  [ ]
  3) GO BACK
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|2}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 <span style{{=}}"color:royalblue;">(we want the Windows EFI system partition, from a non-USB drive)</span>
 <span style{{=}}"color:green;">*</span> EFI system partition selected as follows:
 Num Partition UUID                       Path       USB Win Use
 --- ------------------------------------ ---------- --- --- ---
  1) 2498f874-ad8f-484e-8aba-81ac1c9665b6 /dev/sdb1   Y   N  [ ]
  2) f236e16c-ca97-4c36-b0d5-4196fa1e9930 /dev/sda2   N   Y  [*]
 <span style{{=}}"color:green;">*</span> Previously, KEYFILEPARTUUID was unset, and so implicitly followed
 <span style{{=}}"color:green;">*</span> the value of EFIPARTUUID (the EFI system partition).
 <span style{{=}}"color:green;">*</span> Now you have changed EFIPARTUUID, you must choose what to do
 <span style{{=}}"color:green;">*</span> about the keyfile.
 <span style{{=}}"color:green;">*</span> Please choose your desired option:
 1) Keep keyfile in previous EFI system partition
 2) Move keyfile to new EFI system partition (retain implicit tracking)
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|1}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 <span style{{=}}"color:royalblue;">(we want to leave the GPG-keyfile on the USB key)</span>
 <span style{{=}}"color:green;">*</span> OK, explicitly defining KEYFILEPARTUUID now

 <span style{{=}}"color:green;">*</span> Current configuration (from /etc/buildkernel.conf - MODIFIED):

  EFI system partition UUID:  f236e16c-ca97-4c36-b0d5-4196fa1e9930
  LUKS root partition UUID:   8111286a-d24e-4ba2-b6af-d0650fab4130
  GPG keyfile partition UUID: 2498f874-ad8f-484e-8aba-81ac1c9665b6
  GPG keyfile (for LUKS):     luks-key.gpg                        
  EFI boot directory:         /EFI/Boot                           
  EFI boot file:              gentoo.efi                          
  Plymouth theme              fade-in                             
  Boot-time keymap            jp                                  

 <span style{{=}}"color:green;">*</span> Please choose an option:
 1) Set EFI system partition  5) Set boot splash options
 2) Set LUKS root partition   6) Set boot-time keymap
 3) Set LUKS key options      7) Exit without saving
 4) Set EFI boot file path    8) Save and exit
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|8}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 
 <span style{{=}}"color:green;">*</span> Configuration saved to /etc/buildkernel.conf.
 <span style{{=}}"color:green;">*</span> Be sure to run buildkernel, to rebuild the kernel with the new
 <span style{{=}}"color:green;">*</span> settings, before rebooting.
 &nbsp;
}}

Now rebuild the kernel (it will attempt to save the result to the internal EFI system partition now, not to the boot USB key):

{{RootCmd
|buildkernel
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

{{Important|This process also creates a ''new'' EFI boot entry, entitled "<tt>Gentoo Linux (Internal Drive)</tt>", and places it at the top of the EFI boot list for you. Note that, when e.g. [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#set_boot_order_gentoo{{!}}using the UEFI BIOS GUI]] to reboot into Linux, having previously run Windows, you'll need to select this entry, and ''not'' the "<tt>Gentoo Linux (USB Key)</tt>" one (which is retained too, for convenience). Similarly, if you switch operating systems using the alternative approach of the Window 8 'Use a device' menu (as described [[#win8_use_a_device{{!}}above]]), you'll need to click on the the tile entitled "<tt>Gentoo Linux (Internal Drive)</tt>".}}

Once the build completes (make sure it works successfully, and that you get the prompt "<tt>All done!</tt>" at the end), ensure your USB (boot) key is inserted, and restart your machine (you can do this from within GNOME, by clicking on the 'power' icon (in the top right of the screen), clicking on the 'power' button in the dropdown menu that then appears, and then clicking on the 'Restart' button in the dialog).

The machine should then power cycle (you will be cleanly logged out of GNOME first). When it restarts, as before, you will need to enter your LUKS keyfile <tt>gpg</tt> passphrase (the one you created [[EFI_Gentoo_End_to_End_Install/Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#create_gpg_luks_keyfile|earlier]]), directly at the target machine keyboard to unlock the LUKS partition. You should then be able to log into GNOME as usual.

{{Note|The (boot) USB key is now only needed for the GPG-encrypted keyfile. As before, the USB key can safely be removed once the GNOME login screen appears.

In addition, the previous kernel and backup etc. is still present on the USB key (but unused), and you can delete these manually if you like - as the system now boots using the kernel stored on the internal EFI system partition.}}

{{Note|If you use the internal EFI system partition in this manner, and have ''not'' slimmed down your kernel configuration, you will probably be unable to perform <tt>buildkernel --snapshot-backup</tt> operations, due to lack of space. Consider reducing your kernel image size, as described [[EFI_Gentoo_End_to_End_Install/Final_Configuration_Steps#cleaning_kernel_config{{!}}earlier]].}}

=== <span id="option_6_migration">Completely Removing the Need for a Boot USB Key (Option 6)</span> ===

This is the most convenient option for everyday use, since no USB key is required at all: the backup LUKS passphrase is prompted for at boot time, and the kernel is contained on the internal drive (Windows) EFI system partition. However, dual-factor security is lost with this approach. It is otherwise similar to option 4 above, so please [[#option_4_comments|read through the comments there]] before continuing.

{{Important|You '''must''' have setup a fallback LUKS keyphrase to use an option 6 boot. Refer to the [[EFI_Gentoo_End_to_End_Install/Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#add_fallback_luks_passphrase{{!}}earlier instructions]] as to how to do this, if you haven't already done so.}}

{{Note|To reiterate one point: under 'option 6' (just as for 'option 4'), whenever you wish to restart from Linux to Windows, you will have to change the EFI boot list ''explicitly'', using the <tt>efibootmgr</tt> tool (the use of which was [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#use_efibootmgr{{!}}described previously]]). You can no longer simply restart the machine without the boot key present (as you can with 'option 1').}}

If you still wish to migrate to an 'option 6' configuration, proceed as follows.

First, open a root terminal in GNOME (if you don't already have one available): press the {{Key|Windows Key}}, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. Become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[EFI_Gentoo_End_to_End_Install/Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

Next, use the <tt>buildkernel --easy-setup</tt> tool to make the necessary changes to {{Path|/etc/buildkernel.conf}}.
{{Note|You can of course make the necessary changes to {{Path|/etc/buildkernel.conf}} with an editor, but using the menu-driven tool reduces the chances for error.}}

Issue (the following session is an example only; the values output will obviously vary for your machine):
{{RootCmd
|buildkernel --easy-setup
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=
 &nbsp;
 <span style{{=}}"color:green;">*</span> Current configuration (from /etc/buildkernel.conf):

   EFI system partition UUID:  2498f874-ad8f-484e-8aba-81ac1c9665b6
   LUKS root partition UUID:   8111286a-d24e-4ba2-b6af-d0650fab4130
   GPG keyfile partition UUID: DEFAULT (=EFI system partition UUID)
   GPG keyfile (for LUKS):     luks-key.gpg                        
   EFI boot directory:         /EFI/Boot                           
   EFI boot file:              gentoo.efi                         
   Plymouth theme              fade-in                 
   Boot-time keymap            jp                                  

 <span style{{=}}"color:green;">*</span> Please choose an option:
 1) Set EFI system partition  5) Set boot splash options
 2) Set LUKS root partition   6) Set boot-time keymap
 3) Set LUKS key options      7) Exit without saving
 4) Set EFI boot file path    8) Save and exit
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|3}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 
 <span style{{=}}"color:green;">*</span> Current LUKS key settings:
 <span style{{=}}"color:green;">*</span> Using a GPG-encrypted keyfile for LUKS:
 <span style{{=}}"color:green;">*</span>  KEYFILEPARTUUID unset: assuming GPG keyfile on EFI system partition
 <span style{{=}}"color:green;">*</span> Please choose your desired LUKS key setting (or GO BACK):
 1) Use GPG-encrypted keyfile on EFI system partition
 2) Use GPG-encrypted keyfile on specific USB partition...
 3) Use fallback passphrase (no keyfile)
 4) GO BACK
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|3}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 <span style{{=}}"color:green;">*</span> New LUKS key settings:
 <span style{{=}}"color:green;">*</span> Using no keyfile, but relying on fallback passphrase for LUKS
 
 <span style{{=}}"color:green;">*</span> Current configuration (from /etc/buildkernel.conf - MODIFIED):

  EFI system partition UUID:  2498f874-ad8f-484e-8aba-81ac1c9665b6
  LUKS root partition UUID:   8111286a-d24e-4ba2-b6af-d0650fab4130
  GPG keyfile partition UUID: DEFAULT (=EFI system partition UUID)
  GPG keyfile (for LUKS):     NONE (using fallback passphrase)                        
  EFI boot directory:         /EFI/Boot                           
  EFI boot file:              gentoo.efi                          
  Plymouth theme              fade-in                             
  Boot-time keymap            jp                                  

 <span style{{=}}"color:green;">*</span> Please choose an option:
 1) Set EFI system partition  5) Set boot splash options
 2) Set LUKS root partition   6) Set boot-time keymap
 3) Set LUKS key options      7) Exit without saving
 4) Set EFI boot file path    8) Save and exit
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|1}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 
 <span style{{=}}"color:green;">*</span> Please choose which EFI system partition to use (or GO BACK):
 Num Partition UUID                       Path       USB Win Use
 --- ------------------------------------ ---------- --- --- ---
  1) 2498f874-ad8f-484e-8aba-81ac1c9665b6 /dev/sdb1   Y   N  [*]
  2) f236e16c-ca97-4c36-b0d5-4196fa1e9930 /dev/sda2   N   Y  [ ]
  3) GO BACK
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|2}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 <span style{{=}}"color:royalblue;">(we want the Windows EFI system partition, from a non-USB drive)</span>
 <span style{{=}}"color:green;">*</span> EFI system partition selected as follows:
 Num Partition UUID                       Path       USB Win Use
 --- ------------------------------------ ---------- --- --- ---
  1) 2498f874-ad8f-484e-8aba-81ac1c9665b6 /dev/sdb1   Y   N  [ ]
  2) f236e16c-ca97-4c36-b0d5-4196fa1e9930 /dev/sda2   N   Y  [*]

 <span style{{=}}"color:green;">*</span> Current configuration (from /etc/buildkernel.conf - MODIFIED):

  EFI system partition UUID:  f236e16c-ca97-4c36-b0d5-4196fa1e9930
  LUKS root partition UUID:   8111286a-d24e-4ba2-b6af-d0650fab4130
  GPG keyfile partition UUID: DEFAULT (=EFI system partition UUID)
  GPG keyfile (for LUKS):     NONE (using fallback passphrase)                         
  EFI boot directory:         /EFI/Boot                           
  EFI boot file:              gentoo.efi                          
  Plymouth theme              fade-in                             
  Boot-time keymap            jp                                  

 <span style{{=}}"color:green;">*</span> Please choose an option:
 1) Set EFI system partition  5) Set boot splash options
 2) Set LUKS root partition   6) Set boot-time keymap
 3) Set LUKS key options      7) Exit without saving
 4) Set EFI boot file path    8) Save and exit
 Your choice: <span style{{=}}"color:royalblue;">press</span> {{Key|8}}<span style{{=}}"color:royalblue;"> then</span> {{Key|Enter}}
 
 <span style{{=}}"color:green;">*</span> Configuration saved to /etc/buildkernel.conf.
 <span style{{=}}"color:green;">*</span> Be sure to run buildkernel, to rebuild the kernel with the new
 <span style{{=}}"color:green;">*</span> settings, before rebooting.
 &nbsp;
}}

Now rebuild the kernel (it will attempt to save the result to the internal EFI system partition now, not to the boot USB key):

{{RootCmd
|buildkernel
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

{{Important|As with option 4, this process also creates a ''new'' EFI boot entry, entitled "<tt>Gentoo Linux (Internal Drive)</tt>", and places it at the top of the EFI boot list for you. Note that, when e.g. [[EFI_Gentoo_End_to_End_Install/Configuring_Secure_Boot#set_boot_order_gentoo{{!}}using the UEFI BIOS GUI]] to reboot into Linux, having previously run Windows, you'll need to select this entry, and ''not'' the "<tt>Gentoo Linux (USB Key)</tt>" one (which is retained too, for convenience). Similarly, if you switch operating systems using the alternative approach of the Window 8 'Use a device' menu (as described [[#win8_use_a_device{{!}}above]]), you'll need to click on the the tile entitled "<tt>Gentoo Linux (Internal Drive)</tt>".}}

Once the build completes (make sure it works successfully, and that you get the prompt "<tt>All done!</tt>" at the end), remove your USB (boot) key (you won't need it any more!), and restart your machine (you can do this from within GNOME, by clicking on the 'power' icon (in the top right of the screen), clicking on the 'power' button in the dropdown menu that then appears, and then clicking on the 'Restart' button in the dialog).

The machine should then power cycle (you will be cleanly logged out of GNOME first). When it restarts, as before, you will need to enter your LUKS ''fallback'' passphrase (the one you created [[EFI_Gentoo_End_to_End_Install/Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#add_fallback_luks_passphrase|earlier]]), directly at the target machine keyboard to unlock the LUKS partition. You should then be able to log into GNOME as usual.

{{Note|The boot USB key can now be recycled if you like - the system now boots using a kernel stored on the internal EFI system partition, and the GPG-encrypted keyfile is not used. Any time you are restarting your machine and are prompted for a LUKS passphrase (at the 'bunch of keys' prompt in Plymouth), be sure to use the LUKS fallback passphrase.}}

{{Note|Just as with option 4, if you use the internal EFI system partition in this manner, and have ''not'' slimmed down your kernel configuration, you will probably be unable to perform <tt>buildkernel --snapshot-backup</tt> operations, due to lack of space. Consider reducing your kernel image size, as described [[EFI_Gentoo_End_to_End_Install/Final_Configuration_Steps#cleaning_kernel_config{{!}}earlier]].}}

== <span id="tweaking_gnome">Tweaking GNOME</span> ==

One of the saving graces of the GNOME 3 shell interface (the desktop GUI) is its extensibility. By using [[:Wikipedia:Javascript|JavaScript]]-based plug-ins known as [https://extensions.gnome.org/about/ shell extensions], you can modify the behaviour of your system considerably (changing the way window placement works, adding things like weather and system performance applets, changing app search options etc.).

The simplest way to get plugins is via the <tt>Gnome Tweak Tool</tt> application. From within your GNOME desktop, press {{Key|Windows Key}}, then type <tt>tweak</tt> and press {{Key|Enter}}. The tool that appears allows you to change many of the default GNOME behaviours that you may find annoying (such as attached modal dialogs!), add startup applications, etc., so its well worth browsing through the options.

To install extensions, however, click on the 'Extensions' tab on the left side of the app, and then navigate to the extension you want on the right (simply move the slider to "ON" for any you wish to enable). If you scroll to the bottom of this list, you'll see a link entitled "<tt>Get more extensions</tt>". Click on this, and a web page will open with a list of downloadable plug-ins. You can search the list for topics of interest. Again, if you want to use a plug-in, simply click on it to open its detail page, move its slider to "ON", and it should download and start running automatically:

[[File:Gnome_tweak_extensions.jpg|thumb|none|400px|Adding GNOME Shell Extensions via the Tweak Tool]]

{{Important|Do take care with plug-ins, however, as they are third-party code. Shell extensions on the GNOME website have been reviewed for malware. If you want to write your own extensions, a good place to start is [https://wiki.gnome.org/Projects/GnomeShell/Extensions/StepByStepTutorial#knowingJavascript this tutorial]. See also [https://wiki.gnome.org/Projects/GnomeShell/Extensions this GNOME wiki page].}}

{{Note|It may be worth emerging {{Package|sys-apps/gnome-disk-utility}} if you want to mount the boot USB key (or internal hard drive EFI system partition) from within GNOME, without resorting to the command line. For clarity, GNOME ''will'' by default automount the partitions of removable drives when you insert them, but it will ''not'' automount EFI system partitions. The GNOME disk utility provides you with a nice graphical way to do this.}}

=== <span id="misc_gnome">Miscellaneous GNOME Points</span> ===

The following are a few GNOME setup questions that come up frequently by email (but which don't really fit into the main flow of this guide). For any other GNOME issues, your first point of call should be the [https://www.gnome.org/ gnome.org] website (and failing that, the Gentoo [http://forums.gentoo.org/viewforum-f-13.html Desktop Environments] discussion forum).

==== <span id="use_printer_in_gnome">Using a Printer in GNOME</span> ====

Depending on what version of GNOME you have, and which other applications you have installed, you may find that you are initially unable to print from GNOME, and cannot use the 'Printers' control panel.

To enable printing, you need to install the {{Package|net-print/libgnomecups}} package, and then start the <tt>[[:Wikipedia:CUPS|CUPS]]</tt> service in <tt>systemd</tt>.

To set this up, first open a root terminal in GNOME (if you don't already have one available): press the {{Key|Windows Key}}, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. Become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[EFI_Gentoo_End_to_End_Install/Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

Then issue:
{{RootCmd
|emerge --ask --verbose --noreplace net-print/libgnomecups
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ... assuming no errors you will see ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
{{Note|If you already have the package installed as a dependency of something else, it will not be reinstalled (because of the <tt>--noreplace</tt> option), but you ''will'' be asked whether to add the package to your [[World{{!}}<tt>@world</tt>]] set; you should answer <tt>n</tt> in this case.}}
Next, enter:
{{RootCmd
|systemctl enable cups
|systemctl start cups
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
after which you should be able to go to the 'Printers' control panel, click on the 'plus' icon, and setup your printer.
You can also close out the <tt>root</tt> terminal if you have no further need for it.

==== <span id="use_vpn_in_gnome">Using a VPN in GNOME</span> ====

To be able to use a Virtual Private Network ([[:Wikipedia:Virtual_private_network|VPN]]) with <tt>NetworkManager</tt> in GNOME, you have to install the 
{{Package|net-misc/networkmanager-openvpn}} package.

To do this, open a <tt>root</tt> terminal (per the instructions [[#use_printer_in_gnome|above]]), and then issue:
{{RootCmd
|emerge --ask --verbose net-misc/networkmanager-openvpn
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ... assuming no errors you will see ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
Once this completes, you should now be able to go to the 'Network' control panel, click on the 'plus' icon, and add a new VPN connection.
(As before, close out the <tt>root</tt> terminal now, if you have no further need for it.)

==== <span id="play_mp4_in_gnome">Playing MP4 Videos (using <tt>Totem</tt>) in GNOME</span> ====

If you find that you are unable to play MP4 videos using GNOME's default (<tt>Totem</tt>) media player (and it complains about a missing H264 codec), then you'll need to install the {{Package|media-plugins/gst-plugins-libav}} package.

To do this, open a <tt>root</tt> terminal (per the instructions [[#use_printer_in_gnome|above]]), and then issue:
{{RootCmd
|emerge --ask --verbose media-plugins/gst-plugins-libav
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ... assuming no errors you will see ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
Once this completes, the problem should be fixed.
(As before, close out the <tt>root</tt> terminal now, if you have no further need for it.)

== <span id="install_firewall_etc">Installing Other Applications, Including a Firewall etc.</span> ==

As currently configured, your machine is not running a [[:Wikipedia:Firewall_(computing)|firewall]] - but I'd definitely recommend installing one! Configuring a firewall is beyond the scope of this tutorial, but a good place to start is Chapter 1 of Michael Rash's book ''Linux Firewalls''.<ref>Rash, Michael ''Linux Firewalls: Attack Detection and Response with <tt>iptables</tt>, <tt>psad</tt>, and <tt>fwsnort</tt>'' No Starch Press, 2007</ref> The ArchLinux wiki also has some useful information on using [[Iptables|<tt>iptables</tt>]] (the Linux kernel firewall based on <tt>netfilter</tt>) under <tt>systemd</tt>.<ref>ArchLinux Wiki: [https://wiki.archlinux.org/index.php/iptables "iptables"]</ref>

{{Note|If you do choose to use <tt>iptables</tt>, you'll need to do a <tt>buildkernel --menuconfig</tt> run, and turn on <tt>CONFIG_NETFILTER</tt> and appropriate sub-options. Michael Rash's book gives a good overview (albeit a little dated now) of which options you may need.}}

Other than that, what you install on your machine is now up to you! It's worth reading [[Handbook:AMD64/Working/Portage#Maintaining_software|this introduction]] in the Gentoo handbook regarding searching for and installing software. The basic process, of course, is straightforward. Suppose, for example, that you'd like to install the Firefox web browser...

To do this, first, open a root terminal in GNOME (if you don't already have one available): press the {{Key|Windows Key}}, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. Become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[EFI_Gentoo_End_to_End_Install/Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

Next, search for the application. You can use <tt>eix</tt> to do this: for example:
{{RootCmd
|eix firefox
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

Reviewing <tt>eix</tt>'s output, you can see that the package you want is {{Package|www-client/firefox-bin}}. To install it, use the familiar <tt>emerge</tt> rubric:
{{RootCmd
|emerge --ask --verbose www-client/firefox
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ... assuming no errors you will see ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
If there are any USE flag problems or license issues reported, edit {{Path|/etc/portage/package.use}} or {{Path|/etc/portage/package.license}} accordingly (see [[EFI_Gentoo_End_to_End_Install/Installing_the_Gentoo_Stage_3_Files#about_package_use|text earlier]] for a description of these), then try again.

== <span id="sayonara">Sayonara ^-^</span> ==

Well, that's it! You now have a fully operational Gentoo dual-boot system!

Enjoy!

(Click [[EFI_Gentoo_End_to_End_Install|here]] to go back up to the top-level page.)

{{Note|As mentioned at the beginning, comments, suggestions and feedback about this guide are welcomed! You can use the "Discussion" tab (of whatever is the most relevant page) for this purpose. On most browsers, you can use {{Key|Shift}}{{Key|Alt}}{{Key|t}} as a shortcut to access this.}}

== <span id="notes">Notes</span> ==
{{reflist}}

{| style="margin: 1em auto 1em auto;"
|-
| [[../Final_Configuration_Steps|<]]
| [[../|Home]]
| <span style{{=}}"color:gray;">></span>
|}

[[Category:Bootloaders]]
[[Category:Core system]]
[[Category:GNOME]]
[[Category:Kernel]]
[[Category:Portage]]
[[Category:Power management]]
[[Category:Security]]
