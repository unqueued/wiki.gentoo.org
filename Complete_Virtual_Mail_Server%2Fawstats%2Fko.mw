<languages/>

== 도입부 ==

postfix에서 로그 기능을 제공하긴 하지만, 그래픽 형식으로 표시하고 분석하면 더욱 이해하기 쉬울 수 있습니다. {{Package|www-misc/awstats}} 는 널리 사용하는 로그 분석기이며 로그를 해석하고 적합한 결과 도출을 설정할 수 있습니다.

== 설치 ==

AWStats는 웹 프로그램이지만 webapp-config에 의존하지 않습니다. 이머지하지 않았다면 이머지해야합니다.

{{Emerge|www-misc/awstats}}

설치하고 나면, 설정 파일을 도메인별로 만들거나 처리할 모든 도메인에 대해 만들어야합니다.

{{RootCmd|cp /etc/awstats/awstats.model.conf /etc/awstats/awstats.example.com.conf}}

AWStats는 webapp-config로 설치하지 않지만 대힌 간단한 심볼릭 링크는 사용합니다.

{{RootCmd|ln -s /usr/share/awstats/wwwroot /var/www/mail.example.com/htdocs/awstats}}

== 설정 ==

=== AWStats ===

AWStats comes with reasonable defaults, but some need to be changed nevertheless.

For one, awstats assumes that vhosts aren't used. When using apache's default combined vhost logs for example, awstats will fail to run.

Assume apache's combined LogFormat is setup as follows:

{{CodeBox|title=Apache 로그 형식|1=
LogFormat "%v %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" VLOG=%{VLOG}e" vhost
}}

The following changes then need to be made:

{{FileBox|filename=/etc/awstats/awstats.example.com.conf|title=아파치 로그 형식과 맞추기.|1=
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
}}

Next awstats needs to know about the domains and aliases to filter from the log file:

{{FileBox|filename=/etc/awstats/awstats.example.com.conf|title=awstats 도메인 감청 설정|<nowiki>
SiteDomain="example.com"
 
HostAliases="localhost 127.0.0.1 REGEX[example\.(com)$] REGEX[example\.(org|net)$]
</nowiki>}}

Also, awstats needs to store its database somewhere. Gentoo has created {{Path|/var/lib/awstats}} for this use, but it can be stored anywhere. Make sure the permissions are set so that the apache user can write to it:

{{FileBox|filename=/etc/awstats/awstats.example.com.conf|title=AWStats database storage|1=
DirData="/var/lib/awstats"
}}

Any other changes to the configuration file are optional, but interesting to look into:

{{Note|When using the graphapplet plugin, the java applet may not display, see {{Bug|400589}} for more information.}}

=== 기록 ===

awstats는 데이터베이스를 빌드하려면 아파치 로그 파일을 처리해야 합니다. 동작하는지 한번 직접 확인하고 나면 그 다음 과정은 자동으로 처리할 수 있습니다.

==== 수작업 ====

우선, awstats 를 콘솔에서 실행하여 초기 오류를 잡아내십시오:

{{Cmd|<nowiki>awstats.pl -config=stats.example.com -update -showdropped</nowiki>}}

이 명령의 결과로 어떤 문제든 나와야 하며 설정에서 빠진 도메인 이름도 나와야 합니다.

==== 크론 ====

모두 제대로 동작한다면 {{Path|cron.hourly}}에 추가할 수 있습니다:

{{FileBox|filename=/etc/cron.hourly/awstats|title=AWstats 크론 작업|lang=bash|1=
#!/bin/sh
awstats.pl -config=stats.example.com -update > /dev/null 2>&1
}}

필요한 경우 스크립드를 실행 가능하게 설정하는 것 잊지 마십시오.

==== Logrotate ====

Awstats will process the log file every hour, but when logrotate rotates apache's log, some entries may be missing. This is easily solved however.

{{FileBox|filename=/etc/logrotate.d/apache2|title=Diff of pre-init script|lang=diff|1=
# Apache2 logrotate snipet for Gentoo Linux
# Contributes by Chuck Short
#
/var/log/apache2/*log {
  missingok
  notifempty
  sharedscripts
+  prerotate
+  /etc/cron.hourly/awstats > /dev/null 2>&1
+  endscript
  postrotate
  /etc/init.d/apache2 reload > /dev/null 2>&1 {{!}}{{!}} true
  endscript
}
}}

=== Apache ===

For awstats to be used from apache, the webhost needs to properly setup. In the alias section, the following needs to be added:

{{FileBox|filename=/etc/apache2/vhosts.d/stats.example.com|title=awstats용 별칭|1=
        Alias /awstatsclasses "/usr/share/awstats/wwwroot/classes"
        Alias /awstatscss "/usr/share/awstats/wwwroot/css"
        Alias /awstatsicons "/usr/share/awstats/wwwroot/icon"
        ScriptAlias /awstats/ "/usr/share/awstats/wwwroot/cgi-bin/"
}}

Finally, awstats needs the correct permissions to be accessible:

{{FileBox|filename=/etc/apache2/vhosts.d/stats.example.com|title=awstats 용 별칭|lang=apache|1=
<Directory "/usr/share/awstats/wwwroot">
        AllowOverride None
        Options None
        Order allow,deny
        Allow from all
</Directory>
}}

After a restart of apache, awstats should be available via http://stats.example.com/awstats/awstats.pl?config=stats.example.com. If no config option is passed to awstats, it uses the current hostname, which means in this case could have been omitted.

== 메일 로그용 AWStats ==

AWStats is known for being an apache log parser. However it can also be used to parse mail logs.

=== 설정 ===

After copying {{Path|awstats.stats.example.com.conf}} to {{Path|awstats.mail.example.com.conf}} quite a few changes are required to turn awstats into a mail log parser.

{{FileBox|filename=/etc/awstats.mail.example.com.conf|title=access.log 대신 mail.log 에 기록 (diff -u, 추가 삭제만 표시)|lang=diff|1=
-LogFile="/var/log/apache2/access_log"
+LogFile="perl /usr/bin/awstats_maillogconvert.pl standard < /var/log/mail.log {{!}}"
 
-LogType=W
+LogType=M
 
-LogFormat=1
+LogFormat="%time2 %email %email_r %host %host_r %method %url %code %bytesd"
 
-SiteDomain="localhost"
+SiteDomain="example.com"
 
 
-HostAliases="localhost 127.0.0.1 REGEX[myserver\.com$]"
+HostAliases="localhost 127.0.0.1 REGEX[example\.(net{{!}}org)$]"
 
-DirData="."
+DirData="/var/lib/awstats"
 
-LevelForBrowsersDetection=2         # 0 disables Browsers detection.
+LevelForBrowsersDetection=0         # 0 disables Browsers detection.
                                     # 2 reduces AWStats speed by 2%
                                     # allphones reduces AWStats speed by 5%
-LevelForOSDetection=2               # 0 disables OS detection.
+LevelForOSDetection=0               # 0 disables OS detection.
                                     # 2 reduces AWStats speed by 3%
-LevelForRefererAnalyze=2            # 0 disables Origin detection.
+LevelForRefererAnalyze=0            # 0 disables Origin detection.
                                     # 2 reduces AWStats speed by 14%
-LevelForRobotsDetection=2           # 0 disables Robots detection.
+LevelForRobotsDetection=0           # 0 disables Robots detection.
                                     # 2 reduces AWStats speed by 2.5%
-LevelForSearchEnginesDetection=2    # 0 disables Search engines detection.
+LevelForSearchEnginesDetection=0    # 0 disables Search engines detection.
                                     # 2 reduces AWStats speed by 9%
-LevelForKeywordsDetection=2         # 0 disables Keyphrases/Keywords detection.
+LevelForKeywordsDetection=0         # 0 disables Keyphrases/Keywords detection.
                                     # 2 reduces AWStats speed by 1%
-LevelForFileTypesDetection=2        # 0 disables File types detection.
+LevelForFileTypesDetection=0        # 0 disables File types detection.
                                     # 2 reduces AWStats speed by 1%
 LevelForWormsDetection=0            # 0 disables Worms detection.
                                     # 2 reduces AWStats speed by 15%
 
-ShowRobotsStats=HBL
+ShowRobotsStats=0
 
-ShowEMailSenders=0
+ShowEMailSenders=HBML
 
-ShowEMailReceivers=0
+ShowEMailReceivers=HBML
 
-ShowSessionsStats=1
+ShowSessionsStats=0
 
-ShowPagesStats=PBEX
+ShowPagesStats=0
 
-ShowFileTypesStats=HB
+ShowFileTypesStats=0
 
-ShowFileSizesStats=0
+ShowFileSizesStats=1
 
-ShowDownloadsStats=HB
+ShowDownloadsStats=0
 
-ShowOSStats=1
+ShowOSStats=0
 
-ShowBrowsersStats=1
+ShowBrowsersStats=0
 
-ShowOriginStats=PH
+ShowOriginStats=0
 
-ShowKeyphrasesStats=1
+ShowKeyphrasesStats=0
 
-ShowKeywordsStats=1
+ShowKeywordsStats=0
 
-ShowMiscStats=a
+ShowMiscStats=0
 
-ShowHTTPErrorsStats=1
+ShowHTTPErrorsStats=0
 
-ShowSMTPErrorsStats=0
+ShowSMTPErrorsStats=1
}}

With those changes in place, a manual run should work without any issues:

{{Cmd|awstats.pl -config{{=}}mail.example.com -showcorrupted -showdropped}}

=== 기록 ===

To scan the mail log every hour, the existing awstats script in {{Path|cron.hourly}} can be appended with the following:

{{FileBox|filename=/etc/cron.hourly/awstats|title=메일 기록 해석 추가|lang=bash|1=
awstats.pl -config=mail.example.com -update > /dev/null 2>&1
}}

Also syslog is getting rotated and thus awstats needs to parse the mail log file before the mail log is being rotated:

{{FileBox|filename=/etc/logrotate.d/syslog-ng|title=syslog에서 메일 로그 항목 수정|<nowiki>
# Mail system
/var/log/mail.log /var/log/mail.info /var/log/mail.err /var/log/mail.warn {
    sharedscripts
    missingok
    prerotate
        /etc/cron.hourly/awstats
    endscript
    postrotate
        /etc/init.d/syslog-ng reload > /dev/null 2>&1 || true
    endscript
}
</nowiki>}}

{{Note|The {{Path|/var/log/mail.log}} file does not have to be on the same server. AWStats will have to have access to it. This could be via NFS, or having syslog do remote logging.}}

If logging of apache files is not desired, or webmail resides on a different server, the webserver log parsing can be removed from cron jobs.

[[Category:Mail Servers]]
