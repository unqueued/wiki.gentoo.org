This guide will show you how to upgrade Gentoo/FreeBSD 11.0 from 10.3.

{{Important|11.0 can upgrade only from 10.3.}}

__TOC__

== Preparation ==

=== Updating all packages ===

{{RootCmd|emerge -uDN @world}}

=== Changing to the latest profile ===

It is necessary to change the [[profile]] to emerge packages related to FreeBSD 11.0 .

Get a list of available profiles:

{{RootCmd|eselect profile list|output=
<pre>
Available profile symlink targets:
  [1]   default/bsd/fbsd/amd64/9.1
  [2]   default/bsd/fbsd/amd64/10.3
  [3]   default/bsd/fbsd/amd64/11.0 *
  [4]   default/bsd/fbsd/amd64/9.1/clang
  [5]   default/bsd/fbsd/amd64/10.3/clang
  [6]   default/bsd/fbsd/amd64/11.0/clang
</pre>}}

Set the profile to 11.0:

{{RootCmd|eselect profile set 3}}

== Kernel update ==

First of all, you need to update your kernel. That is because some userland packages may require functions of the new kernel.

Please be sure to update the kernel first!

{{RootCmd
|emerge --nodeps sys-freebsd/freebsd-mk-defs
|emerge --nodeps sys-freebsd/freebsd-sources
}}

=== Reboot ===

Don't have a problem? Let's restart to actually use the new kernel.

{{RootCmd|shutdown -r now}}

After rebooting your machine, please check if the upgrade was successful. 

{{RootCmd|uname -a|output=
<pre>FreeBSD GFBSD 11.0-Gentoo FreeBSD Gentoo 11.0 #0: Thu Oct 16 00:03:34 JST 2016     root@GFBSD:/var/tmp/portage/sys-freebsd/freebsd-sources-11.0/work/sys/amd64/compile/GENTOO  amd64
</pre>}}

== Updating FreeBSD userland ==

First emerge the core library:

{{RootCmd
|CC{{=}}gcc CXX{{=}}g++ CXXFLAGS{{=}}"-O2 -pipe" USE{{=}}build MAKEOPTS{{=}}"-j1" emerge --nodeps sys-freebsd/freebsd-share
|CC{{=}}gcc CXX{{=}}g++ CXXFLAGS{{=}}"-O2 -pipe" USE{{=}}build MAKEOPTS{{=}}"-j1" emerge --nodeps sys-freebsd/freebsd-lib
|CC{{=}}gcc CXX{{=}}g++ CXXFLAGS{{=}}"-O2 -pipe" USE{{=}}build MAKEOPTS{{=}}"-j1" emerge --nodeps sys-freebsd/freebsd-libexec}}

Update the userland of FreeBSD:

{{RootCmd
|CC{{=}}gcc CXX{{=}}g++ CXXFLAGS{{=}}"-O2 -pipe" emerge -auN boot0 freebsd-bin freebsd-lib freebsd-libexec freebsd-mk-defs freebsd-pam-modules freebsd-sbin freebsd-share freebsd-ubin freebsd-usbin
}}

Please emerge the sys-freebsd packages again. Some of the packages are in need of include files of 11.0, which they couldn't use during the previous upgrade. 
{{RootCmd|emerge boot0 freebsd-bin freebsd-lib freebsd-libexec freebsd-mk-defs freebsd-pam-modules freebsd-sbin freebsd-share freebsd-ubin freebsd-usbin}}

Clean utmp related files:

{{RootCmd|rm /var/run/utmp /var/log/lastlog /var/log/wtmp*}}

== Change CHOST and rebuild toolchain ==

{{Note|You can skip this step if you are minor upgrading. Please next Cleaning step.}}

Change CHOST, and emerge binutils gcc. (FYI, [[Changing the CHOST variable|Changing the CHOST variable]])

x86-fbsd users:

{{RootCmd|<nowiki>gsed -i 's:CHOST=.*:CHOST="i686-gentoo-freebsd11.0":g' /etc/portage/make.conf</nowiki>}}

amd64-fbsd users:

{{RootCmd|<nowiki>gsed -i 's:CHOST=.*:CHOST="x86_64-gentoo-freebsd11.0":g' /etc/portage/make.conf</nowiki>}}

Emerge binutils and gcc:

{{Emerge|sys-devel/binutils sys-devel/gcc|params=--oneshot}}

Recreate all packages.

{{RootCmd
|emerge -ae @world --exclude sys-apps/portage
|emerge sys-apps/portage
}}

Failure to compile the package if any, 'emerge --resume --skipfirst' is your friend. Also, please bug report the problem if you like.

== Cleaning ==

Let's remove the backup files when you have finished all the steps:

{{Important|Do not forget to run <tt>etc-update</tt>!}}

{{RootCmd
|emerge @preserved-rebuild
|etc-update
}}

== See also ==

* [[Gentoo FreeBSD/Upgrade Guide]]
* [[Gentoo FreeBSD]]
