<languages />

{{InfoBox stack
|{{InfoBox homepage|http://www.sshguard.net/|header=true}}
|{{InfoBox ohloh}}
}}

{{Metadata|abstract=sshguard is an intrusion prevention system that parses server logs, determines malicious activity, and uses the system firewall to block the IP addresses of malicious connections.}}

'''sshguard''' は侵入防止システムです。サーバーのログを精査して害意ある行動を検出し、危害を加えようとする接続元IPアドレスを拒絶するファイアーウォールを用います。sshguard は、C言語で書かれており、インタプリターは不要です。

== 動作の仕組み ==

sshguard は、一つないし複数のログファイルを継続追跡する簡単なデーモンです。他のデーモンが記録したログイン試行失敗のログを精査して、その接続を拒絶するようにシステムファイアーウォールを更新することで、更なる試行を阻止します。

sshguard は、その名称にも拘わらず、 SSH のログのみを精査するわけではありません。多くのメールシステムやいくらかの FTP システムにも対応しています。対応しているサービスの全リストは、[http://www.sshguard.net sshguard.net ウェブサイト] で公開されています。

== インストール ==

=== Emerge ===

{{Package|app-admin/sshguard}} をインストール:

{{Emerge|app-admin/sshguard}}

また、システムファイアーウォールを展開するために、 {{Package|net-firewall/iptables}} もインストールします。なお本稿作成段階では、 sshguard は {{Package|net-firewall/nftables}} には対応していません。

{{Emerge|net-firewall/iptables}}

iptables の利用と設定に関しての詳細は、 [[Iptables|iptables の記事]] も参照してください。

== 設定 ==

=== ファイアーウォールの準備 ===

<tt>sshguard</tt>チェーンを使用して、sshguardが任意の悪意のあるユーザーをブロック（IPアドレスを遮断することによって）

チェーンを用意し、新しい着信接続が検出された場合、それはまたトリガされるのを確認してください:

{{RootCmd|iptables -N sshguard
|iptables -A INPUT -j sshguard}}

=== ログファイルの監視 ===

ネイティブsshguard構成ファイルが存在しない - sshguardの基本的な考え方は、管理者がアプリケーションのオプションとして見るためにログファイル（複数可）に渡すことです。

On Gentoo, the options can be best configured in the {{Path|/etc/conf.d/sshguard}} file:

{{FileBox|filename=/etc/conf.d/sshguard|title=Configuring sshguard to read /var/log/messages|lang=bash|1=
PARDONTIME="3600" # Blocks last at least 1 hour (3600 seconds)
WATCHTIME="360"   # Track IP addresses for 5 minutes (360 seconds)
THRESHOLD="10"    # How many problematic attempts trigger a block
  
LOGFILES="-l /var/log/messages"                      # Watch this file...
LOGFILES="${LOGFILES} -l /var/log/auth.log"          # And this one
  
SSHGUARD_OPTS="-p ${PARDONTIME} -s ${WATCHTIME} -a ${THRESHOLD} ${LOGFILES}"
}}

sshguardランタイムユーザーが、使用するログファイルにアクセス可能であることを確認してください。

=== Services ===

==== OpenRC ====

sshguardをデフォルトのランレベルに追加することでデフォルトで起動されます:

{{RootCmd
|rc-update add sshguard default
|rc-service sshguard start
}}

=== Blacklisting hosts ===

With the blacklisting option after a number of abuses the IP address of the attacker will be blocked permanently. The blacklist will be loaded at each startup and extended with new entries during operation. {{c|sshguard}} inserts a new address after it exceeded a threshold of abuses.

Blacklisted addresses are never scheduled to be released (allowed) again.

The <code>-b</code> command line option enables blacklisting and requires a filename to use for permanent storage of the blacklist. An optional threshold is configurable within the same option. This threshold is then first, after which the filename is mentioned separated by <code>:</code>.

To enable blacklisting, create an appropriate directory and file:

{{RootCmd
|mkdir -p /var/db/sshguard
|touch /var/db/sshguard/blacklist.db
}}

Add the blacklist file to the configuration and alter the <var>SSHGUARD_OPTS</var> variable:

{{FileBox|filename=/etc/conf.d/sshguard|title=Configuring sshguard to blacklist abusers|lang=bash|1=
PARDONTIME="3600" # Blocks last at least 1 hour (3600 seconds)
WATCHTIME="360"   # Track IP addresses for 5 minutes (360 seconds)
THRESHOLD="10"    # How many problematic attempts trigger a block
  
BLACKLIST="/var/db/sshguard/blacklist.db"            # Blacklisted addresses are in this file
LOGFILES="-l /var/log/messages"                      # Watch this file...
LOGFILES="${LOGFILES} -l /var/log/auth.log"          # And this one
  
SSHGUARD_OPTS="-b 50:${BLACKLIST} -p ${PARDONTIME} -s ${WATCHTIME} -a ${THRESHOLD} ${LOGFILES}"
}}

Restart the {{c|sshguard}} daemon to have the changes take effect:

{{RootCmd
|/etc/init.d/sshguard restart
}}

== トラブルシューティング ==

=== File '/var/log/auth.log' vanished while adding! ===

起動時に、sshguardは、次のエラーを報告します:

{{CodeBox|title=Error message when trying to add a monitor for /var/log/auth.log|1=
Sep 23 03:39:11 foo.bar.com sshguard[64933]: File '/var/log/auth.log' vanished while adding!
}}

ターゲット・ファイルがシステム上で利用できない場合、このようなエラーが（ファイルパス自体が異なる場合があります）が発生します。それが作成されていることを確認し、または監視のためにそれを追加しないようにsshguard構成を更新します。

On a syslog-ng system with OpenRC, the following addition to {{Path|syslog-ng.conf}} can suffice:

{{FileBox|filename=/etc/syslog-ng/syslog-ng.conf|title=creating auth.log file|lang=bash|1=
log { source(src); destination(messages); };
log { source(src); destination(console_all); };
 
destination authlog {file("/var/log/auth.log"); };
filter f_auth { facility(auth); };
filter f_authpriv { facility(auth, authpriv); };
log { source(src);  filter(f_authpriv);  destination(authlog);  };
}}

変更を有効にするために、設定を再ロード:

{{RootCmd|rc-service syslog-ng reload}}

== 参考 ==

* [[Iptables]], for installing and configuring {{c|iptables}} on Gentoo

== 外部の情報 ==

[http://www.sshguard.net/docs/ sshguard documentation]はさらに調整アプリケーションに必要なすべての情報を提供しています。


[[Category:Security]]
[[Category:Server]]
