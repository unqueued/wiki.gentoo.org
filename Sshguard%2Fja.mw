<languages />

{{InfoBox stack
|{{InfoBox homepage|http://www.sshguard.net/|header=true}}
|{{InfoBox ohloh}}
}}

{{Metadata|abstract=sshguard is an intrusion prevention system that parses server logs, determines malicious activity, and uses the system firewall to block the IP addresses of malicious connections.}}

'''sshguard''' は侵入防止システムです。サーバーのログを精査して害意ある行動を検出し、危害を加えようとする接続元IPアドレスを拒絶するファイアーウォールを用います。sshguard は、C言語で書かれており、インタプリターは不要です。

== 動作の仕組み ==

sshguard は、一つないし複数のログファイルを継続追跡する簡単なデーモンです。他のデーモンが記録したログイン試行失敗のログを精査して、その接続を拒絶するようにシステムファイアーウォールを更新することで、更なる試行を阻止します。

sshguard は、その名称にも拘わらず、 SSH のログのみを精査するわけではありません。多くのメールシステムやいくらかの FTP システムにも対応しています。対応しているサービスの全リストは、[http://www.sshguard.net sshguard.net ウェブサイト] で公開されています。

== インストール ==

=== Emerge ===

{{Package|app-admin/sshguard}} をインストール:

{{Emerge|app-admin/sshguard}}

また、システムファイアーウォールを展開するために、 {{Package|net-firewall/iptables}} もインストールします。なお本稿作成段階では、 sshguard は {{Package|net-firewall/nftables}} には対応していません。

{{Emerge|net-firewall/iptables}}

iptables の利用と設定に関しての詳細は、 [[Iptables|iptables の記事]] も参照してください。

== 設定 ==

=== ファイアーウォールの準備 ===

<tt>sshguard</tt>チェーンを使用して、sshguardが任意の悪意のあるユーザーをブロック（IPアドレスを遮断することによって）

チェーンを用意し、新しい着信接続が検出された場合、それはまたトリガされるのを確認してください:

{{RootCmd|iptables -N sshguard
|iptables -A INPUT -j sshguard}}

=== ログファイルの監視 ===

ネイティブsshguard構成ファイルが存在しない - sshguardの基本的な考え方は、管理者がアプリケーションのオプションとして見るためにログファイル（複数可）に渡すことです。

On Gentoo, the options can be best configured in the {{Path|/etc/conf.d/sshguard}} file:

{{FileBox|filename=/etc/conf.d/sshguard|title=Configuring sshguard to read /var/log/messages|lang=bash|1=
PARDONTIME="3600" # Blocks last at least 1 hour (3600 seconds)
WATCHTIME="360"   # Track IP addresses for 5 minutes (360 seconds)
THRESHOLD="10"    # How many problematic attempts trigger a block
  
LOGFILES="-l /var/log/messages"                      # Watch this file...
LOGFILES="${LOGFILES} -l /var/log/auth.log"          # And this one
  
SSHGUARD_OPTS="-p ${PARDONTIME} -s ${WATCHTIME} -a ${THRESHOLD} ${LOGFILES}"
}}

sshguardランタイムユーザーが、使用するログファイルにアクセス可能であることを確認してください。

=== サービス ===

sshguardをデフォルトのランレベルに追加することでデフォルトで起動されます:

{{RootCmd|rc-update add sshguard default
|rc-service sshguard start}}


== Troubleshooting ==

=== File '/var/log/auth.log' vanished while adding! ===

When starting up, sshguard reports the following error:

{{CodeBox|title=Error message when trying to add a monitor for /var/log/auth.log|1=
Sep 23 03:39:11 foo.bar.com sshguard[64933]: File '/var/log/auth.log' vanished while adding!
}}

Such an error (the file path itself can be different) occurs when the target file is not available on the system. Make sure that it is created, or update the sshguard configuration to not add it for monitoring.

On a syslog-ng system with OpenRC, the following addition to {{Path|syslog-ng.conf}} can suffice:

{{FileBox|filename=/etc/syslog-ng/syslog-ng.conf|title=creating auth.log file|lang=bash|1=
log { source(src); destination(messages); };
log { source(src); destination(console_all); };
 
destination authlog {file("/var/log/auth.log"); };
filter f_auth { facility(auth); };
filter f_authpriv { facility(auth, authpriv); };
log { source(src);  filter(f_authpriv);  destination(authlog);  };
}}

Reload the configuration for the changes to take effect:

{{RootCmd|rc-service syslog-ng reload}}

== 参考 ==

* [[Iptables]], for installing and configuring <tt>iptables</tt> on Gentoo

== 外部の情報 ==

The [http://www.sshguard.net/docs/ sshguard documentation] provides all the information needed to further tune the application.


[[Category:Security]]
[[Category:Server]]
