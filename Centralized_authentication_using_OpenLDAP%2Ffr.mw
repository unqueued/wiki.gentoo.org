<languages />


{{Metadata|abstract=Ce guide introduit les bases de  LDAP et montre comment configurer  OpenLDAP pour des besoins d'authentification entre plusieurs systèmes Gentoo.}}


This guide introduces the basics of LDAP and shows you how to setup OpenLDAP for authentication purposes between a group of computers.


== Démarrer avec OpenLDAP ==

=== Qu'est-ce que LDAP ? ===

LDAP signifie ''Lightweight Directory Access Protocol'' (Protocole Allégé pour accès à des annuaires). Basé sur X.500 il couvre la plupart de ses fonctions primaires, mais ne possède pas ses fonctions les plus ésotériques. Maintenant, qu'est-ce que ce X.500 et pourquoi LDAP existe-t-il ? 

X.500 est un modèle pour les services d'annuaires dans de concept OSI. Il comprend des définitions d'espaces de noms et les protocoles pour interroger et mettre à jour l'annuaire. Néanmoins, X.500 s'est avérer être surdimensionné dans maintes situations.  C'est là qu'entre en scène LDAP. Comme X.500 il procure un modèle données/espace de noms pour l'annuaire et un protocole également. Cependant, LDAP est conçu pour tourner directement au-dessus de la pile TCP/IP. Considérez LDAP comme une version allégée de X:500. 

=== Je n'ai pas saisi. Qu'est-ce qu'un annuaire ? ===

Un annuaire est une base de données spécialisée conçue pour des interrogations fréquentes mais avec des mises à jour moins fréquentes. Au contraire des bases de données générales, il ne comprend pas de prise en charge des transactions ou de fonctionnalités de retour en arrière. Les annuaires sont facilement répliqués pour en augmenter la disponibilité et la fiabilité. Lorsque les annuaires sont répliqués, des incohérences temporaires sont autorisées jusqu'à ce qu'elles soient synchronisées à la fin. 

=== Comment l'information est-elle structurée ? ===

Toutes les informations dans un annuaire sont organisées de manière hiérarchisée. Même plus, si vous voulez entrer des données dans un annuaire, cet annuaire doit savoir comment ranger ces informations dans un arbre. Jetons un coup d'œil à une société imaginaire et un arbre similaire à Internet : 

{{Code|Structure de l'organisation de  GenFic, une société Gentoo imaginaire|<pre>
dc:         com
             |
dc:        genfic         ## (Organisation)
          /      \
ou:   People   servers    ## (Unités d'organisation (UO) )
      /    \     ..
uid: ..   John            ## (données spécifiques d'UO )
</pre>
}}

Comme vous n'entrez pas les données dans la base de données de cette façon ascii-artistique, chacun des nœuds d'un tel arbre doit être défini. Pour nommer de tels nœuds, LDAP utilise un schéma de nommage. La plupart des distributions LDAP (y compris OpenLDAP) contiennent déjà un certain nombre de schémas prédéfinis (et largement approuvés), tels que l'inetorgperson, un schéma fréquemment utilisé pour définir des utilisateurs.

Les utilisateurs intéressés sont encouragés à lire le  [http://www.openldap.org/doc/admin24/ guide d'administration de OpenLDAP] .

=== So... What can it be used for? ===

LDAP peut être utilisé pour différentes choses. Ce document est centré sur la gestion centralisée d'utilisateurs, en conservant tous les comptes utilisateur dans un emplacement LDAP unique (ce qui ne veut pas dire qu'il est hébergé sur un serveur unique, LDAP prenant en charge une haute disponibilité et la redondance), bien que d'autres objectifs peuvent être atteints en utilisant LDAP également. 

* Infrastructure de clés publiques

* Calendrier partagé

* Carnet d'adresses partagé

* Espace de stockage pour  DHCP, DNS, ...

* Directives de configuration des classes système  (conserver la trace de la configuration de plusieurs serveurs)

* Centralised Authentication (PosixAccount)

* ...

== OpenLDAP Server Configuration  ==

{{Note|Dans ce document nous utilisons  l'adresse genfic.com comme un  exemple. Vous devrez, bien-sûr, changer cela. Assurez-vous cependant que le nœud sommet  est dans un domaine de niveau supérieur  (net, com, cc, be, ...).}}


Let's first emerge OpenLDAP. Ensure the USE flags ''berkdb, crypt, gnutls, ipv6, sasl, ssl, syslog'' and ''tcpd'' are used.

{{Emerge|openldap}}


OpenLDAP has a main user "rootdn" (Root Distinguished Name) password which is generated with the below command and needs to be placed in the {{Path|slapd.conf}} as noted later on.

{{RootCmd|slappasswd|output=<pre>
New password: my-password
Re-enter new password: my-password
{SSHA}EzP6I82DZRnW+ou6lyiXHGxSpSOw2XO4
</pre>
}}


Now edit the LDAP Server configuration in {{Path|/etc/openldap/slapd.conf}}. The provided {{Path|slapd.conf}} is from the original openLDAP source. Below is a sample configuration file one can use to replace it with to get things started. 

{{Code|/etc/openldap/slapd.conf|<pre>
include	/etc/openldap/schema/core.schema
include /etc/openldap/schema/cosine.schema
include /etc/openldap/schema/inetorgperson.schema
include /etc/openldap/schema/nis.schema
include	/etc/openldap/schema/misc.schema
 
pidfile  /var/run/openldap/slapd.pid
argsfile /var/run/openldap/slapd.args
 
## ## ServerID used in case of replication
serverID 0 
loglevel 0
 
## ## Certificate/SSL Section
TLSCipherSuite normal
TLSCACertificateFile /etc/openldap/ssl/ldap.crt
TLSCertificateFile /etc/openldap/ssl/ldap.pem
TLSCertificateKeyFile /etc/openldap/ssl/ldap.key
TLSVerifyClient never
 
## ## Access Controls
access to dn.base="" by * read
access to dn.base="cn=Subschema" by * read
access to *
  by self write
  by users read
  by anonymous read
 
## ## Database definition
database hdb
suffix "dc=genfic,dc=com"
checkpoint 32 30
rootdn "cn=Manager,dc=genfic,dc=com"
## ## rootpwd generated earlier via slappasswd command
rootpw "{SSHA}EzP6I82DZRnW+ou6lyiXHGxSpSOw2XO4" 
directory "/var/lib/openldap-data"
index objectClass eq
 
## ## Synchronisation (pull from other LDAP server)
syncrepl rid=000
  provider=ldap://ldap2.genfic.com
  type=refreshAndPersist
  retry="5 5 300 +"
  searchbase="dc=genfic,dc=com"
  attrs="*,+"
  bindmethod="simple"
  binddn="cn=ldapreader,dc=genfic,dc=com"
  credentials="ldapsyncpass"
 
index entryCSN eq
index entryUUID eq
 
mirrormode TRUE
 
overlay syncprov
syncprov-checkpoint 100 10
</pre>
}}

For a more detailed analysis of the configuration file, we suggest that you work through the OpenLDAP Administrator's Guide. 

=== Verifying the configuration ===

After customizing the {{Path|slapd.conf}} file you can check it with the following command.

{{Cmd|slaptest -v -d 1 -f /etc/openldap/slapd.conf}}

Vary the debug level (the "-d 1" above) for more info. If all goes well you will see ''config file testing succeeded''.
If there's an error, <code>slaptest</code> will list the line number to which it applies (of the {{Path|slapd.conf}} file).

Note that OpenLDAP can store its configuration in two places. One in the original {{Path|slapd.conf}} and also in {{Path|slapd.d/}}. The second is the new place and designed not be edited with a text editor but generated from the {{Path|slapd.conf}} using <code>slaptest</code> in the following manor in {{Path|/etc/openldap/}}. It is not required to convert the configuration and use {{Path|slapd.d/}} for now, but support for the currently documented approach will be removed in future versions of this document.

{{RootCmd|mkdir /etc/openldap/slapd.d}}
{{RootCmd|slaptest -f /etc/openldap/slapd.conf -F slapd.d}}
{{RootCmd|chown -R ldap slapd.d}}

Running this command will transfer and translate the configuration. Once this has been run successfully the command needs to be run every time the {{Path|slapd.conf}} is updated. The directory and its contents need to be owned by the ldap service account. 

For more instructions read the in-line comments of the generated files.

The below line will enable the {{Path|slapd.d/}} configuration method. 

{{Code|/etc/conf.d/slapd|<pre>
OPTS="-F /etc/openldap/slapd.d -h 'ldaps:// ldap:// ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock'"
</pre>
}}

Pour finir, créez la structure {{Path|/var/lib/openldap-ldbm}} : 

{{RootCmd|mkdir -p /var/lib/openldap-ldbm
|chown ldap:ldap /var/lib/openldap-ldbm
|chmod 700 /var/lib/openldap-ldbm}}


Start slapd: 

{{RootCmd|/etc/init.d/slapd start}}

If it does not start then increase the loglevel variable in {{Path|slapd.conf}} to 4 or more, and look in {{Path|/var/log/messages}} for more information.

== Configuring the OpenLDAP Client tools== 

Edit the LDAP Client configuration file. This file is read by ldapsearch and other ldap command line tools.

{{File|/etc/openldap/ldap.conf|Add the following|<pre>
BASE         dc=genfic, dc=com
URI          ldap://ldap.genfic.com:389/ ldap://ldap1.genfic.com:389/ ldap://ldap2.genfic.com:389/
TLS_REQCERT  allow
TIMELIMIT    2
</pre>
}}

You can test the running server with the following command: 

{{Cmd|ldapsearch -x -D "cn{{=}}Manager,dc{{=}}genfic,dc{{=}}com" -W}}

If you receive an error, try adding <code>-d 255</code> to increase the verbosity and solve the issue you have.

== Client Configuration for Centralised Authentication  ==

There are numerous methods/tools that can be used for remote authentication. Some distributions also have their own easy to use configuration tool. Below there are some in no particular order. It is possible to combine local users and centrally authorized accounts at the same time. This is important because, for instance, if the LDAP server cannot be accessed one can still login as root.

* SSSD  (Single Sign-on Services Daemon). Its primary function is to provide access to identity and authentication remote resource through a common framework that can provide caching and offline support to the system. It provides PAM and NSS modules, and in the future will support D-Bus interfaces for extended user information. It also provides a better database to store local users as well as extended user data.

* Use <code>pam_ldap</code> to login to the LDAP server and authenticate. Passwords are ''not'' sent over the network in clear text.  

* NSLCD (Name Service Look up Daemon). Similar to SSSD, but older.

* NSS (Name Service Switch) using the traditional <code>pam_unix</code> module to fetch password hashes over the network. To permit users to update their password this has to be combined with the <code>pam_ldap</code> method.

The first two are demonstrated below with the minimum necessary configuration options to get working.

=== Client PAM configuration SSSD Method ===

Here is the more direct method. The three files that are required to be edited are mentioned below. 

{{File|/etc/sssd/sssd.conf||<pre>
[sssd]
config_file_version = 2
services = nss, pam
domains = genfic
debug_level = 5
  
[nss]
filter_users = root,ldap,named,avahi,haldaemon,dbus,radiusd,news,nscd
  
[domain/genfic]
id_provider = ldap
auth_provider = ldap
ldap_search_base = dc=genfic,dc=com
ldap_tls_reqcert = never
# primary and backup ldap servers below [first server and],[second server]
ldap_uri = ldap://X.X.X.X,ldap://X.X.X.X
</pre>}}


Add sss to the end as shown below to enable the lookup to be handed to the sssd system service. Once you have finished editing start the sssd daemon.

{{File|/etc/nsswitch.conf|Example nsswitch.conf with SSSD support|<pre>
passwd:     files sss
shadow:     files sss
group:      files sss
  
netgroup:   files sss
automount:  files sss
sudoers:    files sss
</pre>}}

The last file is the most critical. Open an extra root terminal as a fallback before editing this. The lines in bold have been added to enable remote authentication. Note the use of {{Path|pam_mkhomedir.so}} to support creating the user home directories.

{{File|/etc/pam.d/system-auth|Enable pam_sss support|<pre>
#%PAM-1.0
# This file is auto-generated.
# User changes will be destroyed the next time authconfig is run.
auth        required      pam_env.so
auth        sufficient    pam_unix.so nullok try_first_pass
auth        requisite     pam_succeed_if.so uid >= 500 quiet
'''auth        sufficient    pam_sss.so use_first_pass'''
auth        required      pam_deny.so
  
account     required      pam_unix.so
account     sufficient    pam_localuser.so
account     sufficient    pam_succeed_if.so uid < 500 quiet
'''account     [default=bad success=ok user_unknown=ignore] pam_sss.so'''
account     required      pam_permit.so
  
password    requisite     pam_cracklib.so try_first_pass retry=3
password    sufficient    pam_unix.so md5 shadow nullok try_first_pass use_authtok
'''password    sufficient    pam_sss.so use_authtok'''
password    required      pam_deny.so
  
session     required      pam_mkhomedir.so skel=/etc/skel/ umask=0077
session     optional      pam_keyinit.so revoke
session     required      pam_limits.so
session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session     required      pam_unix.so
'''session     optional      pam_sss.so'''
</pre>}}

Now try logging in from another box.

=== Configurer PAM ===

First, we will configure PAM to allow LDAP authorization. Install {{Package|sys-auth/pam_ldap}} so that PAM supports LDAP authorization, and {{Package|sys-auth/nss_ldap}} so that your system can cope with LDAP servers for additional information (used by {{Path|nsswitch.conf}}). 

{{Emerge|pam_ldap nss_ldap}}

Ajoutez maintenant les lignes suivantes aux bons emplacements dans {{Path|/etc/pam.d/system-auth}} :

{{Code|/etc/pam.d/system-auth|<pre>
## # Note: ajoutez les seulement. Ne détruisez rien de ce qui est ici ou votre maichine ne pourra plus se connecter !
auth       sufficient   pam_ldap.so use_first_pass
account    sufficient   pam_ldap.so
password   sufficient   pam_ldap.so use_authtok use_first_pass
session    optional     pam_ldap.so
 
## # Fichier exemple:
#%PAM-1.0
 
auth       required     pam_env.so
auth       sufficient   pam_unix.so try_first_pass likeauth nullok
auth       sufficient   pam_ldap.so use_first_pass
auth       required     pam_deny.so
 
account    sufficient   pam_ldap.so
account    required     pam_unix.so
 
password   required     pam_cracklib.so difok=2 minlen=8 dcredit=2 ocredit=2 try_first_pass retry=3
password   sufficient   pam_unix.so try_first_pass use_authtok nullok md5 shadow
password   sufficient   pam_ldap.so use_authtok use_first_pass
password   required     pam_deny.so
 
session    required     pam_limits.so
session    required     pam_unix.so
session    optional     pam_ldap.so
</pre>
}}

Maintenant changez {{Path|/etc/ldap.conf}} pour lire : 

{{Code|/etc/ldap.conf|<pre>
## #host 127.0.0.1
## #base dc=padl,dc=com
 
base dc=genfic,dc=com
## #rootbinddn uid=root,ou=People,dc=genfic,dc=com
bind_policy soft
bind_timelimit 2
ldap_version 3
nss_base_group ou=Group,dc=genfic,dc=com
nss_base_hosts ou=Hosts,dc=genfic,dc=com
nss_base_passwd ou=People,dc=genfic,dc=com
nss_base_shadow ou=People,dc=genfic,dc=com
pam_filter objectclass=posixAccount
pam_login_attribute uid
pam_member_attribute memberuid
pam_password exop
scope one
timelimit 2
uri ldap://ldap.genfic.com/ ldap://ldap1.genfic.com ldap://ldap2.genfic.com
</pre>
}}

Ensuite copiez le fichier {{Path|ldap.conf}}  (de OpenLDAP)du serveur vers le client afin que le clients soient conscients de l'environnement LDAP : 

{{RootCmd|scp ldap-server:/etc/openldap/ldap.conf /etc/openldap}}

Pour terminer, configurez les clients afin qu'ils interrogent LDAP sur les comptes du système : 

{{Code|/etc/nsswitch.conf|<pre>
passwd:         files ldap
group:          files ldap
shadow:         files ldap
</pre>
}}

Si vous avez observé qu'une des lignes que vous avez collées dans votre fichier  {{Path|/etc/ldap.conf}} était commentée (la ligne <code>rootbinddn</code>): vous n'en avez pas besoin sauf si vous voulez changer le mot de passe d'un utilisateur en mot de passe super-utilisateur. Dans un tel cas, vous devez envoyer en écho le mot de passe root à   {{Path|/etc/ldap.secret}} en texte simple.  Ceci est '''DANGEREUX'''et les droits devraient être mis à 600. Ce que vous pouvez désirer faire et c'est conserver ce fichier vierge et lorsque vous avez besoin de changer le mot de passe de  quelqu'un qui est à la fois dans LDAP et dans  {{Path|/etc/passwd}} , y mettre le mot de passe pendant 10 secondes, le temps de changer le mot de passe de l'utilisateur, puis le retirer une fois la chose faite.

=== Migrer des données existantes vers ldap ===

Configurer OpenLDAP pour une administration centralisée et la gestion d'items Linux/Unix communs n'est pas chose facile, mais grâce à quelques outils et scripts disponibles sur Internet, migrer un système conçu pour être administré en tant que  système unique vers un système à gestion centralisée basé sur LDAP n'est pas difficile. 

Go to [http://www.padl.com/OSS/MigrationTools.html http://www.padl.com/OSS/MigrationTools.html] and fetch the scripts there. You'll need the migration tools and the {{Path|make_master.sh}} script. 

Next, extract the tools and copy the {{Path|make_master.sh}} script inside the extracted location: 

{{RootCmd|mktemp -d|output=<pre>
/tmp/tmp.zchomocO3Q
</pre>}}

{{RootCmd|cd /tmp/tmp.zchomocO3Q
|tar xvzf /path/to/MigrationTools.tgz
|mv /path/to/make_master.sh MigrationTools-47
|cd MigrationTools-47</pre>}}

The next step now is to migrate the information of your system to OpenLDAP. The {{Path|make_master.sh}} script will do this for you, after you have provided it with the information regarding your LDAP structure and environment. 

Au moment de l'écriture, les outils ont besoin des entrées suivantes : 

{| class="wikitable" style="text-align: left;" 
|- 
! Enrée
! Description
! Exemple
|- 
| LDAP BaseDN
| The base location (root) of your tree
| dc=genfic,dc=com
|- 
| Mail domain
| Domain used in e-mail addresses
| genfic.com
|- 
| Mail host
| FQDN of your mail server infrastructure
| smtp.genfic.com
|- 
| LDAP Root DN
| Administrative account information for your LDAP structure
| cn=Manager,dc=genfic,dc=com
|- 
| LDAP Root Password
| Password for the administrative account, cfr earlier <code>slappasswd</code> command
| 
|-
|}

L'outil vous demandera aussi quels comptes et quelles configurations vous voulez migrer. 

{{Warning/fr| Il n'est pas nécessaire de changer  pam.d/system-auth}}

== Réplication ==

=== Si vous avez besoin d'une haute disponibilité ===

Si votre environnement requiert une haute disponibilité, alors vous devez configurer la réplication des changements à travers de multiples systèmes LDAP. Le réplication avec OpenLDAP est, dans ce guide, configurée en uilisant un compte dédié à la réplication  ( <code>ldapreader</code> ) qui a des droits de lecture et écriture sur le serveur LDAP primaire et qui tire les changements du serveur primaire vers le serveur secondaire. 

Cette configuration est ensuite réfléchie, autorisant le serveur LDAP secondaire à fonctionner comme serveur primaire. Grâce à la structure interne d'OpenLDAP, les changements ne sont pas ré-appliqués s'ils sont déjà dans la structure LDAP.

=== Configurer la réplication ===

Pour configurer la réplication, commencez par configurer un deuxième serveur OpenLDAP, de façon similaire à ce qui a été décrit ci-dessus. Néanmoins, assurez-vous que dans le fichier de configuration, 

*  ''sync replication provider''pointe sur  ''other'' system.

* L'identifiant (''serverID'') est différent pour chacun des serveurs OpenLDAP.

Créez ensuite le compte de synchronisation. Créez un fichier LDIF (le format utilisé en tant que données d'entrée pour les serveurs LDAP) et ajoutez le à chaque serveur LDAP. 

{{Cmd|slappasswd -s myreaderpassword|output=<pre>
 {SSHA}XvbdAv6rdskp9HgFaFL9YhGkJH3HSkiM
</pre>}}

{{Cmd|cat ldapreader.ldif|output=<pre>
dn: cn=ldapreader,dc=genfic,dc=com
userPassword: {SSHA}XvbdAv6rdskp9HgFaFL9YhGkJH3HSkiM
objectClass: organizationalRole
objectClass: simpleSecurityObject
cn: ldapreader
description: LDAP reader used for synchronization
</pre>}}

{{Cmd|ldapadd -x -W -D "cn{{=}}Manager,dc{{=}}genfic,dc{{=}}com" -f ldapreader.ldif|output=<pre>
Password: ## entrez le mot de passe d'administration
</pre>}}

== Configuration de sécurité du serveur LDAP  ==

=== Permissions OpenLDAP  ===

Si vous regardez le fichier  {{Path|/etc/openldap/slapd.conf}} vous verrez que vous pouvez spécifier les ACL (permissions si vous préférez) de ce que les utilisateurs peuvent être lire/écrire : 

{{Code|/etc/openldap/slapd.conf|<pre>

 
access to attrs=userPassword,gecos,description,loginShell
  by self write

access to *
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by users read
  by anonymous auth
</pre>


}}

Ceci vous donne accès à tout ce qu'un utilisateur est capable de changer. Si ce sont vos données, alors vous y avez accès en écriture ; si ce sont des données d'un autre utilisateur alors vous pouvez les lire ; des personnes non identifiées peuvent envoyer un mot de passe de connexion pour se connecter. Il y a quatre niveaux qui sont, en les rangeant du plus faible au plus fort :<code>auth search read write</code> 

L'ACL suivante est un peu plus sécurisée parce qu'elle empêche le lire le mot de passe ''shadowed'' des autres utilisateurs : 

{{Code|/etc/openldap/slapd.conf|<pre>
access to attrs="userPassword"
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by dn="uid=John,ou=People,dc=genfic,dc=com" write
  by anonymous auth
  by self write
  by * none
 
access to *
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by dn="uid=John,ou=People,dc=genfic,dc=com" write
  by * search
</pre>
}}

Cet exemple donne à root et à John un accès en lecture/écriture à tout ce qui se trouve dans l'arbre ci-dessous {{Path|dc{{=}}genfic,dc{{=}}com}} . Ceci permet aussi aux utilisateurs de changer leur propre  <code>motDePasseUtilisateur</code>. Quant à l'instruction finale, tout autre personne possède une possibilité de recherche, ce qui signifie qu'elle peut remplir un filtre de recherche. Maintenant, vous pouvez avoir de multiples ACLs mais, en règle générale, elles sont traitées du bas vers le haut, c'est pourquoi le niveau supérieur devrait être le plus restrictif.

== Travailler avec OpenLDAP ==

=== Maintenir l'annuaire ===

Vous pouvez commencer à utiliser l'annuaire pour l'authentification des utilisateurs dans apache/proftpd/qmail/samba. Vous pouvez le gérer avec phpldapadmin, diradm, jxplorer, ou lat, qui procurent des interfaces de gestion  conviviales.

== Remerciements ==

Nous tenons à remercier Matt Heler qui nous a prêté sa machine pour réaliser ce guide. Merci aussi aux gars très compétents de #ldap @ irc.freenode.net. 

==Remerciements ==

Nous tenons à remercier les auteurs et éditeurs suivants pour leur contribution à ce guide :

* Benjamin Coles

* swift

* Brandon Hale

* Benny Chuang

* jokey

* nightmorph


[[Category:Server and Security]]
