<languages />

{{Metadata|abstract=Le serveur HTTP Apache HTTP est un serveur  weeb efficient et extensible  parmi les plus populaires utilisés sur  Internet.}}

{{InfoBox stack
|{{InfoBox homepage|http://httpd.apache.org|header=true}}
|{{InfoBox wikipedia|Apache HTTP Server}}
|
}}

Le '''serveur HTTP Apache''' est un [[:Category:Web Servers|serveur web]] efficient et extensible. C'est l'un des plus populaires utilisés sur l'Internet.

== Installation ==

{{Note|Si vous êtes en train de faire une mise à jour,  consultez le  [http://www.gentoo.org/proj/fr/apache/doc/upgrading.xml guide de mise à jour].}}

{{Emerge|{{Package|www-servers/apache}}}}

=== Options de la variable USE  ===

{{USEflag|package=www-servers/apache
|debug
|doc
|ldap
|ssl+yes
|static
|suexec
|threads
|APACHE2_MODULES+++Voir {{Path|[http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/profiles/desc/apache2_modules.desc /usr/portage/profiles/desc/apache2_modules.desc]}}. Activez dans votre {{Path|make.conf}}.
|APACHE2_MPMS+++Voir {{Path|[http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/profiles/desc/apache2_mpms.desc /usr/portage/profiles/desc/apache2_mpms.desc]}}. Activez dans votre  {{Path|make.conf}}.
}}

=== Prise en charge dans d'autres paquets ===

Il existe une option globale de la variable USE, "apache2", qui active la prise en charge d'Apache dans d'autres paquets. Ceci peut déclencher l'installation d'{{Package|www-servers/apache}} si de tels paquets sont utilisés.
{{File|/etc/portage/make.conf||<pre>
USE="... apache2 ..."
</pre>}}

Après avoir défini cette option, vous devez mettre votre système à jour pour que les changements soient pris en compte.

{{Emerge|params+=--changed-use --deep|@world}}

== Démarrage et redémarrage  ==

Démarrer le serveur Apache :

{{RootCmd|/etc/init.d/apache2 start}}

Ajouter Apache au niveau d'exécution par défaut :

{{RootCmd|rc-update add apache2 default}}

Redémarrer le service Apache :

{{RootCmd|/etc/init.d/apache2 restart}}


== Tester ==

Vérifier les interfaces IP  sur lesquels apache2 tourne et et les ports sur lesquels il écoute :

{{RootCmd|netstat -tulpen {{!}} grep apache|output=<pre>
tcp     0     0 0.0.0.0:80      0.0.0.0:*     LISTEN     0     10932720     4544/apache2        
tcp     0     0 0.0.0.0:443     0.0.0.0:*     LISTEN     0     10932716     4544/apache2        
</pre>}}

Tester si une connexion au serveur Apache est active sur l'hôte local :

{{Cmd|telnet localhost 80|output=<pre>
[Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
</pre>}}

Interrompez le test de connexion avec {{Key|Ctrl}}+{{Key|c}} et {{Key|Enter}}.

== Configuration ==

=== Fichiers de configuration ===

Il y a deux fichiers principaux qui définissent le comportement d'Apache sur le système : 

* Le fichier de configuration apache2 de du script d'initialisation  de Gentoo {{path|/etc/conf.d/apache2 }}

* Le fichier de configuration conventionnel du serveur Apache {{path|/etc/apache2/httpd.conf}}

==== Fichier de configuration du script d'initialisation de Gentoo ====

La seule ligne active est la suivante :

{{File|/etc/conf.d/apache2||<pre>
APACHE2_OPTS="-D DEFAULT_VHOST -D INFO -D SSL -D SSL_DEFAULT_VHOST -D LANGUAGE"
</pre>}}

Cette ligne définit les options qui seront interprétées par les divers fichiers de configuration utilisant l'instruction  <code><IfDefine option-name></code>  pour activer ou désactiver  certaines parties de la configuration globale. Nous reviendrons sur ceci, dans les cas concernés, dans le reste de ce guide.

==== Le fichier de configuration conventionnel du serveur Apache -  httpd.conf ====

En réalité, ce fichier n'est qu'un '''point d'entrée''' car la configuration globale est éclatée en divers fichiers dans le dossier {{Path|/etc/apache2/}}, qui sont réunis via la directive <code>Include</code>. Par exemple, l'instruction <code>Include /etc/apache2/modules.d/*.conf</code>, dans {{Path|httpd.conf}}, a pour objectif d'inclure tous les fichiers de  {{Path|/etc/apache2/modules.d/}}  dont le nom se termine par  {{Path|.conf}}. 

Considérant ce qui a été dit précédemment, et comme les fichiers de configuration des modules  (les fichiers dans /etc/apache2/modules.d) commencent presque toujours par <code><IfDefine module-name></code>, le contenu d'un fichier dans {{Path|/ect/apache2/modules.d}}, ne sera SEULEMENT ajouté au reste de la configuration, que si l'option correspondante de la variable APACHE2_OPTS  (<code>-D module-name</code>) est définie dans le fichier {{Path|/etc/conf.d/apache2 }}. Le fichier de configuration {{Path|00_default_settings.conf}} fait exception à cette règle car il ne commence pas par une instruction <code>IfDefine</code>, et est donc toujours inclus dans la configuration globale résultante.

=== Configuration par défaut ===

Après une nouvelle installation du serveur Apache, la configuration résultant de l'assemblage des différents fichiers de configuration ressemble à ce qui suit. Nous démarrons avec le point d'entrée {{Path|/etc/apache2/httpd.conf}}.

{{Warning/fr| Ceci est ''seulement'' fourni pour une référence rapide et pour vous donner une vue d'ensemble. Vous êtes fortement encouragés à lire les commentaires inclus dans les différents fichiers pour comprendre les tenants et aboutissants de la configuration. Reportez-vous également au manuel d'Apache pour une compréhension approfondie. }}

{{File|http.d ||<pre>
ServerRoot "/usr/lib64/apache2"
  
#Module loaded unconditionally, assuming the USE flag is no unset in
# /etc/portage/make.conf or in /etc/portage/package.use
LoadModule actions_modulemodules/mod_actions.so
...
#other modules loaded that way : alias_module, auth_basic_module, authn_alias_module,
# authn_anon_module, authn_dbm_module, authn_default_module, authn_file_module, 
# authz_dbm_module, authz_default_module, authz_groupfile_module, authz_host_module, 
# authz_owner_module, authz_user_module, autoindex_module,  cgi_module,  cgid_module, 
# deflate_module, dir_module, env_module, expires_module, ext_filter_module, filter_module,
#  headers_module, include_module,  log_config_module, logio_module, mime_module,  
# mime_magic_module, negotiation_module, rewrite_module, setenvif_module, 
# speling_module,ssl_module, status_module, unique_id_module, usertrack_module, host_alias_module
  
  
#Modules loaded conditionally, assuming matching USE flag is not unset in
# /etc/portage/make.conf or in /etc/portage/package.use (flag to be set in )
<IfDefine AUTHNZ_LDAP>
LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
</IfDefine>
#other modules loaded that way : cache_module, dav_module, dav_fs_module,
# dav_lock_module,disk_cache_module,  file_cache_module, info_module, ldap_module,
# mem_cache_module, userdir_module
  
  
User apache
Group apache
  
# Supplemental configuration
#**************************************************************************************vvv
#this part is included via Include /etc/apache2/modules.d/*.conf 
  
#included from /etc/apache2/modules.d/00_default_settings.conf-------------v
#this is always included as there is not option to deactivate it.
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 15
UseCanonicalName Off
AccessFileName .htaccess
ServerTokens Prod
TraceEnable off
ServerSignature On 
HostnameLookups Off
EnableMMAP On
EnableSendfile On
FileEtag INode MTime Size
ContentDigest Off
ErrorLog /var/log/apache2/error_log
LogLevel warn
  
<Directory />
	Options FollowSymLinks
	AllowOverride None
	Order deny,allow
	Deny from all
</Directory>
  
<IfModule dir_module>
	DirectoryIndex index.html index.html.var
</IfModule>
<FilesMatch "^\.ht">
	Order allow,deny
	Deny from all
</FilesMatch>
#--------------------------------------------------------------------------^
  
#included from 00_mod_info.conf--------------------------------------------v
<IfDefine INFO>
<Location /server-info>
	SetHandler server-info
	Order deny,allow
	Deny from all
	Allow from 127.0.0.1
</Location>
</IfDefine>
#--------------------------------------------------------------------------^
  
#--------------------------------------------------------------------------v
#included from 00_languages.conf
# Settings for hosting different languages.
<IfDefine LANGUAGE>
  
	AddLanguage ca .ca
	...
	AddLanguage zh-TW .zh-tw
  
	LanguagePriority en ca cs da de el eo es et fr he hr it ja ko ltz nl nn no pl pt pt-BR ru sv zh-CN zh-TW
  
	ForceLanguagePriority Prefer Fallback
  
	AddCharset us-ascii.ascii	.us-ascii
	AddCharset ISO-8859-1		.iso8859-1 .latin1
	...
	AddCharset shift_jis		.shift_jis .sjis
</IfDefine>
#---------------------------------------------------------------------------^
#**************************************************************************************^^^
  
  
#***************************************************************************************vvv
#this part is included via Include /etc/apache2/vhosts.d/*.conf 
#from 00_default_ssl_vhost.conf-----------------------------------------------------vv
<IfDefine SSL>
	<IfDefine SSL_DEFAULT_VHOST>
		<IfModule ssl_module>
			Listen 443
  
			<VirtualHost _default_:443>
				ServerName localhost
                                #------------------------------------------v
				# this part is included via Include /etc/apache2/vhosts.d/default_vhost.include
				ServerAdmin root@localhost
				DocumentRoot "/var/www/localhost/htdocs"
  
  	
				<Directory "/var/www/localhost/htdocs">
	   				Options Indexes FollowSymLinks
	   				AllowOverride All
	   				Order allow,deny
	   				Allow from all
				</Directory>
  
				<IfModule alias_module>
	   				ScriptAlias /cgi-bin/ "/var/www/localhost/cgi-bin/"
				</IfModule>
  
				<Directory "/var/www/localhost/cgi-bin">
	   				AllowOverride None
	   				Options None
	   				Order allow,deny
	   				Allow from all
				</Directory>
        			#end of Include ---------------------------^
  	
				ErrorLog /var/log/apache2/ssl_error_log
  
				<IfModule log_config_module>
					TransferLog /var/log/apache2/ssl_access_log
				</IfModule>
				SSLEngine on
				SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
				SSLCertificateFile /etc/ssl/apache2/server.crt
				SSLCertificateKeyFile /etc/ssl/apache2/server.key
  
				<FilesMatch "\.(cgi|shtml|phtml|php)$">
					SSLOptions +StdEnvVars
				</FilesMatch>
  
				<Directory "/var/www/localhost/cgi-bin">
					SSLOptions +StdEnvVars
				</Directory>
  
				<IfModule setenvif_module>
					BrowserMatch ".*MSIE.*" \
					nokeepalive ssl-unclean-shutdown \
					downgrade-1.0 force-response-1.0
				</IfModule>
  
  
				<IfModule log_config_module>
					CustomLog /var/log/apache2/ssl_request_log \
					"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
					</IfModule>
			</VirtualHost>
		</IfModule>
	</IfDefine>
</IfDefine>
#---------------------------------------------------------------------------------^^
#from 00_default_vhost.conf-------------------------------------------------------vv
<IfDefine DEFAULT_VHOST>
	Listen 80
	NameVirtualHost *:80
  
	<VirtualHost *:80>
		ServerName localhost
  
		#---------------------------------------------------------------v
		# this part is included via Include /etc/apache2/vhosts.d/default_vhost.include
		ServerAdmin root@localhost
		DocumentRoot "/var/www/localhost/htdocs"
  
  	
		<Directory "/var/www/localhost/htdocs">
	   		Options Indexes FollowSymLinks
	   		AllowOverride All
	   		Order allow,deny
	   		Allow from all
		</Directory>
  
		<IfModule alias_module>
	   		ScriptAlias /cgi-bin/ "/var/www/localhost/cgi-bin/"
		</IfModule>
  
		<Directory "/var/www/localhost/cgi-bin">
	   		AllowOverride None
	   		Options None
	   		Order allow,deny
	   		Allow from all
		</Directory>
        	#end of Include -----------------------------------------------^
  
		<IfModule mpm_peruser_module>
			ServerEnvironment apache apache
		</IfModule>
	</VirtualHost>
</IfDefine>
#-----------------------------------------------------------------------------------^^
# end of include ****************************************************************************************^^^
</pre>}}

=== Premiers signes de vie ===

Comme vous pouvez le constater dans la configuration initiale ci-dessus, le répertoire <code>DocumentRoot</code>  de l'hôte virtuel pré-installé est {{Path|/var/www/localhost/htdocs}}, son nom de serveur est ''localhost''. De plus, un fichier index.html est fourni dans le répertoire <code>DocumentRoot</code>, en conséquence, pour vérifier si tout est correctement installé ou pas, pointez votre navigateur sur [http://www.localhost http://www.localhost].

Vous devriez obtenir l'affichage d'une page contenant le message ''It works !''.

=== Activer le module  Security ===

{{emerge|mod_security}}

{{File|/etc/conf.d/apache2||<pre>
APACHE2_OPTS="... -D SECURITY"
</pre>}}

Configurez ce module en éditant {{Path|/etc/apache2/modules.d/79_modsecurity.conf}} et {{Path|/etc/apache2/modules.d/80_modsecurity-crs.conf}} and restarting apache.

=== Activer la prise en charge de PHP  ===

Installez[[PHP]] avec l'option  ''apache2'' de la variable USE et activez le module:

{{File|/etc/conf.d/apache2||<pre>
APACHE2_OPTS="... -D PHP5"
</pre>}}

Pour vérifier si le module PHP fonctionne, créez une page de test.

{{File|/var/www/localhost/htdocs/index.php||<pre>
<html>
 <body>
  <?php phpinfo(); ?>
 </body>
</html>
</pre>}}

Maintenant pointez le navigateur sur http://localhost/. Vous devriez voir un tableau décrivant les réglages de PHP.

=== Ajouter vos propres hôtes virtuels ===

Pour chacun des hôtes virtuels, fournissez un répertoire <code>DocumentRoot</code> qui est rendu accessible au serveur Apache, et ajoutez un fichier {{Path|myVirtualHost.conf}} dans le dossier {{Path|/etc/apache2/vhosts.d}} et n'oubliez pas d'ajouter une entrée pour votre nom de domaine dans {{Path|/etc/hosts}}.

{{Warning|N'oubliez pas de redémarrer le serveur Apache chaque fois que vous effectuez une modification dans les fichiers de configuration.}}

== Dépannage ==

* [http://www.gentoo.org/proj/en/apache/doc/troubleshooting.xml Troubleshooting guide]
* {{Bug|www-servers/apache|search=package}}

=== Problèmes courants ===
En démarrant Apache, vous pourriez avoir l'erreur suivante :

{{Code||<pre>apache2: apr_sockaddr_info_get() failed for SomeHostname
</pre>}}

Si cela se produit, ajoutez votre nom d'hôte au fichier {{Path|/etc/hosts}}.

{{file|/etc/hosts||127.0.0.1 localhost SomeHostname
}}

== Voir aussi ==

* [[Lighttpd]] - un serveur web léger et rapide.
* [[Nginx]] - un serveur HTTP petit et robuste de haute perforance.

== Ressources externes ==

* [http://articles.slicehost.com/2010/12/2/installing-apache-on-gentoo Slicehost article: Installing Apache on Gentoo]
* [http://articles.slicehost.com/2010/12/3/apache-configuration-files-on-gentoo Slicehost article: Apache configuration files on Gentoo]
* [http://articles.slicehost.com/2010/12/3/configuring-the-apache-mpm-on-gentoo Slicehost article: Configuring the Apache MPM on Gentoo]
* [http://articles.slicehost.com/2010/12/3/apache-configuration-on-gentoo-part-1 Slicehost article: Apache configuration on Gentoo]
* [http://articles.slicehost.com/2010/12/3/apache-virtual-hosts-on-gentoo-part-1 Slicehost article: Apache Virtual Hosts on Gentoo]
* [http://articles.slicehost.com/2010/12/3/enabling-and-using-apache-s-mod_status-on-gentoo Slicehost article: Enabling and using apache's mod_status on Gentoo]
* [http://httpd.apache.org/docs/ apache.org documentation]
* [http://gentoo-en.vfose.ru/wiki/Apache2_mod_pagespeed Apache2 mod_pagespeed]


[[Category:Web Servers]]
