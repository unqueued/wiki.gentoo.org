'''An overlay is an additional repository that Portage takes into account when dealing with software.'''

Within Gentoo Linux, users already have one "main" package repository, called the ''Portage tree''. This main repository contains all the software packages (called [[Ebuild|ebuilds]]) maintained by Gentoo developers. But users can add additional repositories to the tree that are "layed over" the main tree - hence the name, ''overlays''.

Since package repositories are nothing more (or less) than a set of files (ebuilds, metadata files, ChangeLog entries ...) these repositories can be pulled in from public repositories (git, cvs, svn ...) or downloaded as tarballs and extracted manually on the system. It is however well advised to use managed repositories by ''trusted'' third parties as any installed overlay will cause Portage to look into those files as well when deciding which software to install.

== Treatment of overlays ==

Portage uses the <code>PORTDIR_OVERLAY</code> variable to link to the installed overlays on the system. This variable uses a space-delimited list of paths on the system where Portage can find the roots of the additional repositories.

=== Manually setting overlay locations ===

When you want to create an overlay yourself, create a location (say <code>/home/user/overlay</code>) in which you will put the packages you want Portage to look into as well. Then add <code>PORTDIR_OVERLAY="/home/user/overlay"</code> to your /etc/make.conf file:
{{File|/etc/make.conf|Adding an overlay manually|<pre>PORTDIR_OVERLAY="/home/user/overlay"</pre>}}

=== Using layman ===

To make management of multiple overlays simple, a tool called [[Layman|layman]] is developed. This tool knows about popular user- and developer managed overlays and is able to install & synchronize them as well as add them to the <code>PORTDIR_OVERLAY</code> location.

=== Overlay priorities ===

Each overlay has its unique priority. This makes sure that in the case of a specific version being found in several overlays, the resolution is unambiguous. Ebuilds from overlays with higher priorities take precedence over ebuilds from overlays with lower priorities.
{{Note|This "natural" way of priority handling was introduced in January 2011 (see [[#References|References]]), before that the priority resolution order was reversed, so negative numbers used to stand for high priorities}}
The list of overlays with their priorities can be obtained through the output of the following command
{{Cmd|emerge --info --verbose}}
Unless the <code>PORTDIR_OVERLAY</code> variable has been modified as described [[#Setting overlay priorities|below]], the default gentoo portage tree will have a priority of -1000 (see [[#References|References]]). That means that all other overlays take precedence. That is the default behavior, because overlays are designed to "lie over/on top" of the portage tree.

==== Setting overlay priorities ====

The overlay priority is calculated from the order of overlay entries in the <code>PORTDIR_OVERLAY</code> variable. Portage "walks" through the variable from left to right and increments the priority on the way. The leftmost entry starts with a priority of 1, the next entry has a priority of 2 and so on.
{{Note|Some time ago the overlay priority could be set in <code>/etc/portage/repos.conf</code>. This does not work anymore}}
 
Unless the <code>PORTDIR_OVERLAY</code> contains the portage tree entry, the portage tree will always be assigned a priority of -1000.
This can be easily changed by putting <code>PORTDIR</code> in the <code>PORTDIR_OVERLAY</code> variable:

{{File|/etc/make.conf|Manual portage tree priority setting|<pre>PORTDIR_OVERLAY="/home/user/overlay ${PORTDIR}"</pre>}}
In the example above the user overlay will be assigned a priority of 1 and the portage tree will be assigned a priority of 2. 

{{Note|If you also use [[Layman|layman]] to manage your overlays, you may be interested in the article about [[Layman#Setting overlay priorities with layman|setting overlay priorities with layman]].}}
