This article covers the '''[[GRUB2]]''' bootloader installation for <code>--target=powerpc-ieee1275</code>. ''IEEE1275'' is the offical standard for '''OpenFirmware''', abbreviated '''OFW''' or '''OF'''.

== Installing the bootloader ==

=== Apple NewWorld Macs (PowerPC) ===

NewWorld Macs are Macs with OpenFirmware version&nbsp;3 (OF3) or later (OF3+). NewWorld Macs will show a graphical boot selection when holding the {{Key|⌥/Option/Alt}} key right after the chime, until a startup selection is shown on the screen. This will only work well when a CHRP script that includes an <code>os-badge</code> is blessed (attribute :tbxi) on a [[HFS]] volume.

{{Important|The precondition for this example is that {{Path|/boot}} is a separate [[ext2]] partition. Other filesystems are possible when the list of GRUB modules is adapted accordingly. If {{Path|/boot}} is on the root partition, the example has to be adapted accordingly as well.}}

* NewWorld Apple Mac computer (1999—2006)
* /boot is a separate [[ext2]] partition
* Apple Partition Map (APM)
** NewWorld Bootblock as <code>Apple_Boot</code>
** filesystem [[HFS]]
** as any partition number (at the begin is preferred, but not required)
* Apple specific <code>os-badge</code>

==== NewWorld Bootblock partition ====

{{Note|The use of {{Package|sys-fs/mac-fdisk}} is highly recommended. Even though package {{Package|sys-block/parted}} can also create Apple Partition Map (APM) style partitions it is not as verbose about partition types.}}

First, a NewWorld Bootblock has to be created using {{c|mac-fdisk}}:

{{Emerge|sys-fs/mac-fdisk}}

{{RootCmd|mac-fdisk /dev/sda}}

At the interactive command prompt this partition can either be created manually e.g. by using the {{c|C}} command for "create new partition, specifying the partition type", or semi-automatic by using the {{c|b}} command for "create new 800k Apple_Bootstrap partition (used by yaboot)". Either way you should get a bootable HFS partition of either the type <code>Apple_Boot</code> or <code>Apple_Bootstrap</code>. The partition name is optional but helps when listing the partitions. All values are entered by hand without automatism of any kind.

The following example uses the free space (type Apple_Free) right after the partition table. If this wasn't taken care of e.g. when installing Mac&nbsp;OS&nbsp;X, per default only 128&nbsp;MB will be free here, which should barely be enough for this purpose. Older versions of Mac&nbsp;OSnbsp;X don't add free space between partitions, so the NewWorld Bootblock will have to be added behind the already existing partitions.

Normally 800&nbsp;KB is used but any size big enough for a HFS filesystem and the GRUB core files will do. In this example, the whole between the partition table and the first partition (Mac OS&nbsp;X Tiger) is 1.1&nbsp;GB. It starts at block 64 (base column) and is 2359232 blocks long (length column). Since this is enough to add 128&nbsp;MB "wholes" before and after, the partition will add two more Apple_Free wholes. The block numbers to enter have to be calculated first: 128&nbsp;MB Apple_Free "wholes" are 262144 block in size, so the first block will have to be <code>64</code> (base)&nbsp;+ <code>262144</code> (Apple_Free)&nbsp;= <code>262208</code>. Since the original Apple_Free "whole" (/dev/sda2) has 2359232 blocks, another whole is left at the end if the size of the bootstrap partition is <code>2359232&nbsp;- (2&nbsp;* 262144)&nbsp;= 1834944</code>.

To get this done, the key sequence <code>p</code> (print partition table), <code>C</code> (create partition with type also specified), <code>262208</code> (first block), <code>1834944</code> (length), <code>"NewWorld Bootblock"</code> (name of partition) and <code>Apple_Boot</code> (type of partition). To check if this worked, use <code>p</code> to list the partitions again. Note that two more partitions were added and the numbers have changed accordingly (Linux Boot was /dev/sda9 and is then /dev/sda11). All modifications are done in memory and will be safed with <code>w</code> (write the partition table). <code>q</code> for quit.

{{RootCmd|mac-fdisk /dev/sda |output=<pre>/dev/sda
Command (? for help): p        #                    type name                  length   base      ( size )  system
/dev/sda1     Apple_partition_map Apple                     63 @ 1         ( 31.5k)  Partition map
/dev/sda2              Apple_Free Extra                2359232 @ 64        (  1.1G)  Free space
/dev/sda3               Apple_HFS Tiger              209715200 @ 2359296   (100.0G)  HFS
/dev/sda4              Apple_Free Extra                 262144 @ 212074496 (128.0M)  Free space
/dev/sda5               Apple_HFS Leopard            314572800 @ 212336640 (150.0G)  HFS
/dev/sda6              Apple_Free Extra                 262144 @ 526909440 (128.0M)  Free space
/dev/sda7              Apple_Boot Apple Hardware Test   100898 @ 527171584 ( 49.3M)  Unknown
/dev/sda8              Apple_Free Extra                 262144 @ 527272482 (128.0M)  Free space
/dev/sda9         Apple_UNIX_SVR2 Linux Boot           2097152 @ 527534626 (  1.0G)  Linux native
/dev/sda10             Apple_Free Extra                 262144 @ 529631778 (128.0M)  Free space
/dev/sda11        Apple_UNIX_SVR2 Gentoo Linux       134217728 @ 529893922 ( 64.0G)  Linux native
/dev/sda12             Apple_Free Extra                 262144 @ 664111650 (128.0M)  Free space
/dev/sda13        Apple_UNIX_SVR2 Debian Linux       134217728 @ 664373794 ( 64.0G)  Linux native
/dev/sda14             Apple_Free Extra                 262144 @ 798591522 (128.0M)  Free space
/dev/sda15        Apple_UNIX_SVR2 Linux Local         71216270 @ 798853666 ( 34.0G)  Linux native
/dev/sda16             Apple_Free Extra                 262144 @ 870069936 (128.0M)  Free space
/dev/sda17        Apple_UNIX_SVR2 Linux swap          67108864 @ 870332080 ( 32.0G)  Linux native
/dev/sda18             Apple_Free Extra                 262144 @ 937440944 (128.0M)  Free space

Block size=512, Number of Blocks=937703088
DeviceType=0x0, DeviceId=0x0

Command (? for help): C
First block: 262208
Length (in blocks, kB (k), MB (M) or GB (G)): 1834944
Name of partition: "NewWorld Bootblock"
Type of partition: Apple_Boot
Command (? for help):/pre>}}

{{RootCmd|mac-fdisk -l /dev/sda |collapse-output=true |output=<pre>/dev/sda
        #                    type name                  length   base      ( size )  system
/dev/sda1     Apple_partition_map Apple                     63 @ 1         ( 31.5k)  Partition map
/dev/sda2              Apple_Free Extra                 262144 @ 64        (128.0M)  Free space
/dev/sda3              Apple_Boot NewWorld Bootblock   1834944 @ 262208    (896.0M)  Unknown
/dev/sda4              Apple_Free Extra                 262144 @ 2097152   (128.0M)  Free space
/dev/sda5               Apple_HFS Tiger              209715200 @ 2359296   (100.0G)  HFS
/dev/sda6              Apple_Free Extra                 262144 @ 212074496 (128.0M)  Free space
/dev/sda7               Apple_HFS Leopard            314572800 @ 212336640 (150.0G)  HFS
/dev/sda8              Apple_Free Extra                 262144 @ 526909440 (128.0M)  Free space
/dev/sda9              Apple_Boot Apple Hardware Test    100898 @ 527171584 ( 49.3M)  Unknown
/dev/sda10             Apple_Free Extra                 262144 @ 527272482 (128.0M)  Free space
/dev/sda11        Apple_UNIX_SVR2 Linux Boot           2097152 @ 527534626 (  1.0G)  Linux native
/dev/sda12             Apple_Free Extra                 262144 @ 529631778 (128.0M)  Free space
/dev/sda13        Apple_UNIX_SVR2 Gentoo Linux       134217728 @ 529893922 ( 64.0G)  Linux native
/dev/sda14             Apple_Free Extra                 262144 @ 664111650 (128.0M)  Free space
/dev/sda15        Apple_UNIX_SVR2 Debian Linux       134217728 @ 664373794 ( 64.0G)  Linux native
/dev/sda16             Apple_Free Extra                 262144 @ 798591522 (128.0M)  Free space
/dev/sda17        Apple_UNIX_SVR2 Linux Local         71216270 @ 798853666 ( 34.0G)  Linux native
/dev/sda18             Apple_Free Extra                 262144 @ 870069936 (128.0M)  Free space
/dev/sda19        Apple_UNIX_SVR2 Linux swap          67108864 @ 870332080 ( 32.0G)  Linux native
/dev/sda20             Apple_Free Extra                 262144 @ 937440944 (128.0M)  Free space

Block size=512, Number of Blocks=937703088
DeviceType=0x0, DeviceId=0x0}}

{{RootCmd|parted /dev/sda print |collapse-output=true |output=<pre>Model: ATA TOSHIBA-TR200 (scsi)
Disk /dev/sda: 480GB
Sector size (logical/physical): 512B/512B
Partition Table: mac
Disk Flags: 

Number  Start   End     Size    File system     Name                 Flags
 1      512B    32.8kB  32.3kB                  Apple
 3      134MB   1074MB  939MB   hfs             NewWorld Bootblock   boot
 5      1208MB  109GB   107GB   hfs+            Tiger
 7      109GB   270GB   161GB   hfs+            Leopard
 9      270GB   270GB   51.7MB  hfs+            Apple Hardware Test  boot
11      270GB   271GB   1074MB  ext2            Linux Boot
13      271GB   340GB   68.7GB  btrfs           Gentoo Linux
15      340GB   409GB   68.7GB  btrfs           Debian Linux
17      409GB   445GB   36.5GB  ext4            Linux Local
19      446GB   480GB   34.4GB  linux-swap(v1)  Linux swap</pre>}}

==== CHRP boot script ====

Install the required tools:

{{Emerge|sys-boot/grub sys-fs/hfsutils sys-apps/ibm-powerpc-utils}}

In this example, a CHRP boot script will load the GRUB image, which will use an initial grub.cfg to find and load the actual grub.cfg configuration from the {{Path|/boot/grub}} directory on the <code>Linux Boot</code> {{Path|/boot}} partition.

Make sure that {{Path|/boot}} is mounted and create a new directory {{Path|/boot/NWBB}} (for NewWorld BootBlock):

{{RootCmd|mount /boot |mkdir /boot/NWBB}}

Find out the UUID of the {{Path|/boot}} partition:

{{RootCmd|cat /etc/fstab {{!}} grep /boot|output=<pre>UUID=be0188a5-1fd3-46fa-a82a-34cdea8ff194 /boot ext2 noauto,noatime,nodiratime,errors=remount-ro 1 2</pre>}}

Alternative:

{{RootCmd|cat /etc/fstab {{!}} grep /boot|output=<pre>/dev/sda11 /boot ext2 noauto,noatime,nodiratime,errors=remount-ro 1 2</pre>}}
{{RootCmd|blkid /dev/sda11|output=<pre>/dev/sda11: LABEL="Linux Boot" UUID="be0188a5-1fd3-46fa-a82a-34cdea8ff194" TYPE="ext2" PARTLABEL="Linux Boot"</pre>}}

Create file {{Path|/boot/NWBB/grub-initial.cfg}} and use the UUID from above to let GRUB find the correct {{Path|/boot}} partition. Although it would also be possible to specify an absolute path, using the UUID will compensate automatically for small changes, like switching drives or adding/deleting partitions.

{{FileBox|filename=/boot/NWBB/grub-initial.cfg|1=
search --no-floppy --fs-uuid --set=root be0188a5-1fd3-46fa-a82a-34cdea8ff194
set prefix=($root)/grub
configfile /grub/grub.cfg
}}

{{Note|The UUID set via <code><nowiki>--set=root UUID</nowiki></code> is the UUID of the ext2 boot partition, not the root partition of the Linux base system. The real grub.cfg in {{Path|/boot/grub/grub.cfg}} created by {{c|grub-mkconfig}} takes care of supplying the kernel cmdline with the real root UUID for booting Linux correctly.}}

Install GRUB to {{Path|/boot/grub}} (the default path). Option <code>--no-nvram</code> prevents GRUB from setting the OpenFirmware <code>boot-device</code> nvram variable. Since GRUB doesn't know about the CHRP script on the NewWorld Bootblock, it would set the wrong value anyway.

{{RootCmd|<nowiki>grub-install --target=powerpc-ieee1275 --no-nvram</nowiki>}}

With this setup, the initial grub.cfg ({{Path|/boot/NWBB/grub-initial.cfg}}), GRUB will then look for {{Path|/grub/grub.cfg}} on the actual {{Path|/boot}} partition (i.e. {{Path|/boot/grub/grub.cfg}} on the live system, since the boot partition is mounted) found via its UUID. Further updates to grub.cfg therefore go via the real grub.cfg the usual way, without the need to touch the NewWorld Bootblock anymore:

{{RootCmd|grub-mkconfig -o /boot/grub/grub.cfg}}

Now create a list of modules to be included in the GRUB image.

{{FileBox|filename=/boot/NWBB/grub_mod-minimal.list|1=
search_fs_uuid.mod search_fs_file.mod search_label.mod search.mod
part_apple.mod
fshelp.mod ext2.mod
halt.mod reboot.mod echo.mod
}}

The command {{c|grub-mkimage}} will create a minimal grub bootimage that includes these modules and the initial grub.cfg:

{{RootCmd|<nowiki>grub-mkimage --prefix=/boot/grub --format=powerpc-ieee1275 --config=/boot/NWBB/grub-initial.cfg --output=/boot/NWBB/grub.img `cat /boot/NWBB/grub_mod-minimal.list`</nowiki>}}

If <code>--config</code> with grub-initial.cfg is ommited, it will be looked up as grub.cfg in the same directory where the grub.img will later be loaded on the NewWorld Bootblock HFS partition.

Now find the partition number of the NewWorld Bootblock, e.g. {{Path|/dev/sda3}} is partition <code>3</code>. OpenFirmware notation is used in the CHRP script, so the command is <code>boot hd:3,\grub\grub.img</code> when the GRUB image is in <code>/grub/grub.img</code> on the HFS NewWorld Bootblock. <code>hd:</code> is an alias for the first disk drive.

{{FileBox|filename=/boot/NWBB/ofboot.b|title=CHRP boot script|1=
<CHRP-BOOT>
<COMPATIBLE>
MacRISC MacRISC2 MacRISC3 MacRISC4
</COMPATIBLE>
<DESCRIPTION>
GRand Unified Bootloader
</DESCRIPTION>
<BOOT-SCRIPT>
boot hd:3,\grub\grub.img
</BOOT-SCRIPT>
</CHRP-BOOT>
}}

{{Warning|The <code>os-badge</code> is '''work-in-progress''' and will be included in a few days! Without it, no logo will be displayed, which will make it hard to identify the GRUB boot option!}}.

Now copy all files to the NewWorld Bootblock HFS filesystem into {{Path|/grub}} and bless (attribute :tbxi) the CHRP boot script <code>ofboot.b</code> and the {{Path|/grub}} subdirectory:
{{RootCmd|hformat -l "NewWorld Bootblock" /dev/sda3
|hmount /dev/sda3
|hmkdir :grub
|hcopy -r /boot/NWBB/grub-initial.cfg :grub:grub.cfg
|hcopy -r /boot/NWBB/grub.img :grub:grub.img
|hcopy -r /boot/NWBB/ofboot.b :grub:ofboot.b
|hattrib -c UNIX -t tbxi :grub:ofboot.b
|hattrib -b :grub
|humount}}

==== Test and set as default boot-device ====

After a reboot, when holding the {{Key|⌥/Option/Alt}} key right after the chime, a startup selection for the partition with GRUB should now be visible. If everything worked, {{c|nvram}} from the {{Package|sys-apps/ibm-powerpc-utils}} package may be used to set the default startup volume:

{{RootCmd|nvram --print-config {{!}} grep ^boot-device |output=<pre>boot-device=first-boot/@0:5,\\:tbxi</pre>}}

{{RootCmd|<nowiki>nvram --update-config boot-device='first-boot/@0:3,\\:tbxi'</nowiki>}}

In the above commands the default startup volume was {{Path|/dev/sda5}} (in the example APM partition layout from above this is Tiger i.e. Mac&nbsp;OS&nbsp;X Tiger 10.4) and it is then set to {{Path|/dev/sda3}}, the GRUB CHRP boot script in this example.

{{Note|Use the command <code><nowiki>nvram --print-config | grep ^boot-device</nowiki></code> to see how the default was set before. This information should be used to set the startup partition to the NewWorld Bootblock since most of the times only the partition number has to be changed. The above example is from a Power Mac G5, it may be different on other Macs. <code><nowiki>boot-device=hd:3,\\:tbxi</nowiki></code> should also work, as should <code><nowiki>boot-device=hd:3,/grub/ofboot.b</nowiki></code> and <code><nowiki>boot-device=hd:3,/grub/grub.img</nowiki></code>...}}

== External resources ==

* [http://firmworks.com/QuickRef.html Open Firmware Quick Reference] from FirmWorks

[[Category:Bootloaders]]
