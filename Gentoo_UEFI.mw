{{InfoBox stack |{{InfoBox wikify|header=true}} }} 

== Introduction ==

The UEFI is a new extensible firmware which means it is a way to open up the old style [[BIOS]] so that more functionality can be added and used in today's computing going forward into the future.
It can be simply understood in that the old BIOS used to just boot a MBR based bootable device and would just hand off the BIOS function to a specific address on the disk then execute it. With UEFI the MBR has been scrapped and now you have a extension which can hand itself off to just about anything from a shell to [[GRUB2|GRUB]] to multiple boot managers.

{{Warning|You must make sure that your hard disk drives use [[Handbook:AMD64/Installation/Disks#GPT|GPT]] tables only as using the old MBR will render your system un-bootable in UEFI mode. Compatibility mode (CSM) is also a bit hit and miss when using UEFI as boot managers all default to MBR legacy boot if it is available. Microsoft Windows particularly with it's auto-detection during installation will almost always choose a non UEFI install in BIOS Compatibility mode. This results in a Hybrid MBR/GPT layout which is not desirable if you want to use UEFI boot.}}

=== How it works(simply) ===

The UEFI system unlike the old BIOS which handed off to a specific location(address) in the start of the bootable media now executes files in a dedicated '''EFI System Partition (ESP)''' of type <code>0xEE</code>. The UEFI looks for specific files with extension *.EFI in particular directory structure. Once it finds these files it will display them in your mainboards boot order screen. It does not stop there as you can modify this order within your OS as well as within the mainboards firmware or even the UEFI built in shell. 

The most important thing to understand about this new system is that each hard disk drive that will require the firmware to execute a bootloader must have a FAT <code>0xEE</code> ESP. So if you have Gentoo on one hard disk and another OS on a second hard disk then each disk will need a small FAT partition marked of type <code>0xEE</code>. If you multi-boot on a single hard disk then only that disk will need one of these dedicated partitions in FAT to store the *.EFI files that can be executed once the mainboards firmware executes the one of your selection.

=== Common layout in Gentoo ===

We commonly layout this partition schema in Gentoo so that we have the GRUB {{Path|/boot}} partition and then a {{Path|/boot/efi}} mount point which is mounted to a small ESP to hold the *.EFI files that your mainboard UEFI can execute.

{| class="table table-condensed table-striped"
|-
! Device !! Mount Point !! Partition Type !! Description
|-
| {{Path|/dev/sda1}} || {{Path|/boot}} || ext4 || Boot partition where your kernel images will be held and GRUB bootloader
|-
| {{Path|/dev/sda2}} || {{Path|/boot/efi}} || FAT32 || EFI System Partition (ESP) where the EFI files will be held to boot into the bootloader 0xEE
|-
| {{Path|/dev/sda3}} || {{Path|/}} || ext4 || root partition for your system
|-
|}

The ESP can be anywhere on the disk start, middle, or end although it is best to put it at the start especially if your disk is a spinning disk type. The UEFI firmware will first search for the partition type(flag) and once found it will read the directory structure to find the *.EFI files. This is what you will see in your mainboard utility screen under the boot section.

=== Multi-boot ===

As mentioned above multi-boot is not difficult in a UEFI system. All that is required is that the ESP contain the relevant EFI files for that OS to be selected for boot. Microsoft Windows is a problematic OS in that it does not want anything other than it's own EFI files to be populated in this partition and if you want to boot Windows you ''must'' install windows before you install another OS as it will detect your other OS and give you false misleading errors in the installation process. 

As with the old BIOS MBR Windows never played nice and wanted the installation drive it was to be used on to be the master drive and the primary OS set in the BIOS or it would not install, well it is not any different for UEFI just adds more annoyance and complication as you need install Windows first then Gentoo afterwards.
If you have Windows and Gentoo on two different drives and have HotSwap you can just pull your Gentoo Linux installed drive and after you install Windows you can return your Gentoo Linux drive and all is good.

== File structure ==

There is a standard layout for the ESP and the firmware will always look inside it for a directory called {{Path|/EFI}}. 
Assuming the above layout where the (FAT32) ESP is mounted to {{Path|/boot/efi}} then the full path to this directory should be {{Path|/boot/efi/EFI}}.

{| class="table table-condensed table-striped"
|-
! Path !! Sub-Directory !! Description
|-
| {{Path|/boot/efi/EFI}} || - || Directory where firmware looks for the *.EFI files
|-
| {{Path|/boot/efi/EFI}} || {{Path|Microsoft/Boot}} || This is where Microsoft place their {{Path|BOOTMGFW.EFI}} file
|-
| {{Path|/boot/efi/EFI}} || {{Path|GENTOO}} || This is the place for [[EFI stub kernel]]s and where GRUB places the {{Path|GRUBX64.EFI}} or X32 depending on your architecture.
|-
| {{Path|/boot/efi/EFI}} || {{Path|Boot}} || This is the fallback directory, if UEFI can't find any vendor specific directories it will boot from here. Windows 10 places its bootx64.efi here, usually good to replace it by GRUB's {{Path|BOOTX64.EFI}}.
|}

You can add other EFI Executable files in these directories so that they can be detected and selected for boot as you wish. 

== GRUB ==

GRUB can Multi-Boot just the same as before when dealing with different kernels, OS's, drives and so on. You just need to remember if you want to boot an OS on a separate hard disk you must have also placed an ESP on that drive as well so that the GRUB configuration can find it.

=== Windows GRUB UEFI ===

You need to mount the Windows ESP, assuming you have an installed Gentoo using UEFI and your {{Path|/etc/fstab}} is setup correctly.

{{RootCmd
|mount /boot
|mount /boot/efi
|mkdir /boot/winefi
|mount /dev/"Partition sd* of windows FAT EFI" /boot/winefi
}}

To add a section in the GRUB loader to boot windows is simple as before by adding this to the {{Path|/etc/grub.d/40_custom}}

{{FileBox|filename=/etc/grub.d/40_custom|title=GRUB 40 custom windows add|lang=text|1=

if [ "${grub_platform}" == "efi" ]; then
	menuentry "Microsoft Windows UEFI-GPT" {
		insmod part_gpt
		insmod fat
		insmod search_fs_uuid
		insmod chain
		search --fs-uuid --set=root $hints_string $fs_uuid
		chainloader /EFI/Microsoft/Boot/bootmgfw.efi
	}
fi

}}

GRUB does not care what drive this is located on. It just searches for any and all partitions and if found then it will add it to your {{Path|grub.cfg}}.
The FAT filesystem containing the Microsoft *.EFI file must be mounted for GRUB to detect and add this custom menu selection so make sure to mount {{Path|/boot}} and then {{Path|/boot/efi}} and {{Path|/boot/winefi}}

{{RootCmd
|grub-mkconfig -o /boot/grub/grub.cfg
}}

== See also ==

* [[rEFInd]]

== External resources == 

For more information, please see:

* [https://wiki.archlinux.org/index.php/GRUB GRUB on Arch wiki]

[[Category:Bootloaders]]
