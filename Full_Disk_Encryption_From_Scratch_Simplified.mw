This article discusses several aspects of using Dm-crypt for full disk encryption with LVM (with some notes for SSD) for daily usage from scratch.

Most of details you can find on great article here: https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key


= Disk Preparation =
In this HOWTO used GPT disk partition schema and grub boot loader. Disk schema creates with help of gparted

{{Note| For more information about GPT and EFI, see handbook https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks}}

== Create partitions ==
Partition schema are:
 
 --------------------------------------------------------------------------------
 /dev/sdX
 |--> GRUB BIOS                2   MB       no fs       grub loader itself
 |--> /boot          boot      512 Mb       fat32       grub and kernel
 |--> LVM volume encrypted     100%         lvm         
     |--> /          root      24  Gb       ext4        rootfs
     |--> /var       var       40  Gb       ext4        var files
     |--> /home      home      100%         ext4        user files

Create grub BIOS
{{RootCmd
|prompt=root@localhost #
|parted -a optimal /dev/sdX}}

Setup default units to MegaBits
{{RootCmd
|prompt=(parted)
|unit mib}}

Create GPT partition table
{{RootCmd
|prompt=(parted)
|mklabel gpt}}

Create BIOS partition
{{RootCmd
|prompt=(parted)|mkpart primary 1 3
|prompt=(parted)|name 1 grub
|prompt=(parted)|set 1 bios_grub on
|prompt=(parted)
}}

Create Boot partition. This partition will contain grub files, plain (unencrypted) kernel and kernel initrd
{{RootCmd
|prompt=(parted)|mkpart primary fat32 3 515
|prompt=(parted)|name 2 boot
|prompt=(parted)|set 2 BOOT on
}}

{{RootCmd
|prompt=(parted)|mkpart primary 515 -1
|prompt=(parted)|name 3 lvm
|prompt=(parted)|set 3 lvm on
}}

Everything is done, exit from parted
{{RootCmd
|prompt=(parted)|quit
}}

== Create boot filesystem ==
Create filesystem for /dev/sdX2, that will contain grub and kernel files. This partition are read by UEFI bios. Most of motherboards can ready only FAT32 fs

{{RootCmd
|prompt=root@localhost #
| mkfs.vfat -F32 /dev/sdX2
}}


Configure DM-CRYPT for /dev/sdb2
Note, if you use Ubuntu live cd, execute this command:
sudo modprobe dm-crypt

# Crypt the partition we named lvm (in my case that would be /dev/sdb2)
cryptsetup luksFormat -c aes-cbc-essiv:sha256 -s 256 /dev/sdb2 

Next, we will open encrypted device:
cryptsetup luksOpen /dev/sdb2 lvm

And create lvm structure for future partition mapping:
# Setup a LVM physical volume 
lvm pvcreate /dev/mapper/lvm

And create all partitions for lvm
https://wiki.gentoo.org/wiki/LVM

vgcreate vg0 /dev/mapper/lvm

Next, we will create root, var and home lvm LV: Logical Volume
root@ubuntu:~#  lvcreate -L 25G -n root vg0
  Logical volume "root" created.
root@ubuntu:~# lvcreate -L 40G -n var vg0
  Logical volume "var" created.
root@ubuntu:~# lvcreate -l 100%FREE -n home vg0
  Logical volume "home" created.


Next, create ext4 filesystem on all partitions:
mkfs.ext4 /dev/mapper/vg0-root
mkfs.ext4 /dev/mapper/vg0-var
mkfs.ext4 /dev/mapper/vg0-home

Create mountpoint for permanent gentoo:
mkdir /mnt/gentoo

mount /dev/mapper/vg0-root /mnt/gentoo

copy stage3 to /mnt/gentoo
cd to /mnt/gentoo

tar xvjpf stage3-*.tar.bz2 --xattrs --numeric-owner

mount mount /dev/mapper/vg0-root /mnt/gentoo/var
